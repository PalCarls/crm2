'use strict';const a557_0x192d44=a557_0x15c2;(function(_0x524879,_0x3e38d6){const _0x284620=a557_0x15c2,_0x23ad02=_0x524879();while(!![]){try{const _0x3c2258=-parseInt(_0x284620(0x11b))/0x1+parseInt(_0x284620(0x105))/0x2*(-parseInt(_0x284620(0xf0))/0x3)+-parseInt(_0x284620(0x111))/0x4*(-parseInt(_0x284620(0x125))/0x5)+-parseInt(_0x284620(0xf3))/0x6*(-parseInt(_0x284620(0x124))/0x7)+-parseInt(_0x284620(0x103))/0x8*(-parseInt(_0x284620(0xfc))/0x9)+-parseInt(_0x284620(0x107))/0xa*(-parseInt(_0x284620(0xef))/0xb)+-parseInt(_0x284620(0x121))/0xc;if(_0x3c2258===_0x3e38d6)break;else _0x23ad02['push'](_0x23ad02['shift']());}catch(_0x5e859b){_0x23ad02['push'](_0x23ad02['shift']());}}}(a557_0x5ab0,0x3a9f7));var __importDefault=this&&this[a557_0x192d44(0x110)]||function(_0x1a6f8d){const _0x1594bd=a557_0x192d44;return _0x1a6f8d&&_0x1a6f8d[_0x1594bd(0x115)]?_0x1a6f8d:{'default':_0x1a6f8d};};function a557_0x15c2(_0x4f9dfa,_0x129f2d){const _0x5ab07c=a557_0x5ab0();return a557_0x15c2=function(_0x15c2ec,_0x2b3348){_0x15c2ec=_0x15c2ec-0xef;let _0x38de51=_0x5ab07c[_0x15c2ec];return _0x38de51;},a557_0x15c2(_0x4f9dfa,_0x129f2d);}Object[a557_0x192d44(0x112)](exports,a557_0x192d44(0x115),{'value':!![]}),exports[a557_0x192d44(0x104)]=void 0x0;const AppError_1=__importDefault(require(a557_0x192d44(0xf4))),Whatsapp_1=__importDefault(require(a557_0x192d44(0x118))),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(a557_0x192d44(0x102))),sequelize_1=require(a557_0x192d44(0x114)),date_fns_1=require('date-fns'),UpdateTicketService_1=__importDefault(require(a557_0x192d44(0x100))),wbot_1=require(a557_0x192d44(0x109)),wbotMessageListener_1=require(a557_0x192d44(0x10f)),moment_1=__importDefault(require('moment')),addLogs_1=require(a557_0x192d44(0x106)),closeTicketsImported=async _0x3d370a=>{const _0x389678=a557_0x192d44,_0x5228c1=await Ticket_1[_0x389678(0x10a)]['findAll']({'where':{'status':_0x389678(0x122),'whatsappId':_0x3d370a,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x389678(0xf9)])(new Date(),{'hours':+0x5})}}});for(const _0x18714d of _0x5228c1){await new Promise(_0x537c9b=>setTimeout(_0x537c9b,0x14a)),await(0x0,UpdateTicketService_1[_0x389678(0x10a)])({'ticketData':{'status':_0x389678(0x12a)},'ticketId':_0x18714d['id'],'companyId':_0x18714d[_0x389678(0x129)]});}let _0x280be6=await Whatsapp_1[_0x389678(0x10a)]['findByPk'](_0x3d370a);_0x280be6[_0x389678(0x119)]({'statusImportMessages':null});const _0x3418af=(0x0,socket_1[_0x389678(0xf2)])();_0x3418af[_0x389678(0x11e)](_0x389678(0x11a)+_0x280be6[_0x389678(0x129)],{'action':_0x389678(0x11f)});};exports[a557_0x192d44(0x104)]=closeTicketsImported;function sortByMessageTimestamp(_0x20d2b3,_0x419ca5){const _0x4946b2=a557_0x192d44;return _0x419ca5[_0x4946b2(0x120)]-_0x20d2b3[_0x4946b2(0x120)];}function cleaner(_0x3ed1ca){const _0x2cca30=a557_0x192d44,_0x32d8d7=new Map(),_0x21f77f=[];for(const _0x5a9c14 of _0x3ed1ca){const _0x351fc7=_0x5a9c14[_0x2cca30(0x10b)]['id'];!_0x32d8d7['has'](_0x351fc7)&&(_0x32d8d7[_0x2cca30(0x116)](_0x351fc7,!![]),_0x21f77f[_0x2cca30(0x12b)](_0x5a9c14));}return _0x21f77f[_0x2cca30(0x126)](sortByMessageTimestamp);}function a557_0x5ab0(){const _0x4a5eb4=['\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','../../libs/wbot','default','key','closedTicketsPostImported','.txt','dataMessages','../WbotServices/wbotMessageListener','__importDefault','22108pZjJIv','defineProperty','DD/MM/YYYY\x20HH:mm:ss','sequelize','__esModule','set','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../../models/Whatsapp','update','importMessages-','474065YeNGHD','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','getTime','emit','refresh','messageTimestamp','1262364bozyjT','pending','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','1414294yNysNd','100WNEZwG','sort','\x20\x0a\x20\x20\x20\x20','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','companyId','closed','push','DD/MM/YY\x20HH:mm:ss','processImportMessagesWppId','2571503jegDVE','17133erTthy','getWbot','getIO','12eGxtXt','../../errors/AppError','name','addLogs','handleMessage','floor','add','length','findByPk','9xpZTjF','ERR_NOT_MESSAGE_TO_IMPORT','whatsapps','\x20de\x20','../TicketServices/UpdateTicketService','format','../../models/Ticket','659248JEVZsj','closeTicketsImported','4OyLOjB','../../helpers/addLogs','10SJpZtz'];a557_0x5ab0=function(){return _0x4a5eb4;};return a557_0x5ab0();}const ImportWhatsAppMessageService=async _0x577b27=>{const _0x220c2f=a557_0x192d44;let _0x1cc9a7=await Whatsapp_1['default'][_0x220c2f(0xfb)](_0x577b27);const _0x2fc11d=(0x0,wbot_1[_0x220c2f(0xf1)])(_0x1cc9a7['id']);try{const _0x15b9dc=(0x0,socket_1[_0x220c2f(0xf2)])(),_0x366723=cleaner(wbot_1[_0x220c2f(0x10e)][_0x577b27]);let _0x2e7b0d=new Date(_0x1cc9a7['importOldMessages'])[_0x220c2f(0x11d)](),_0x4dd0c4=new Date(_0x1cc9a7['importRecentMessages'])[_0x220c2f(0x11d)]();(0x0,addLogs_1[_0x220c2f(0xf6)])({'fileName':_0x220c2f(0x12d)+_0x577b27+_0x220c2f(0x10d),'forceNewFile':!![],'text':_0x220c2f(0x11c)+_0x1cc9a7[_0x220c2f(0xf5)]+_0x220c2f(0x123)+_0x1cc9a7['id']+'\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20'+(0x0,moment_1[_0x220c2f(0x10a)])()[_0x220c2f(0x101)](_0x220c2f(0x113))+_0x220c2f(0x108)+(0x0,moment_1[_0x220c2f(0x10a)])(_0x2e7b0d)[_0x220c2f(0x101)](_0x220c2f(0x113))+_0x220c2f(0x128)+(0x0,moment_1[_0x220c2f(0x10a)])(_0x4dd0c4)[_0x220c2f(0x101)](_0x220c2f(0x113))+_0x220c2f(0x127)});const _0xb0476c=_0x366723[_0x220c2f(0xfa)];let _0x1b0b2a=0x0;while(_0x1b0b2a<_0xb0476c){try{const _0x55a5f1=_0x366723[_0x1b0b2a];(0x0,addLogs_1[_0x220c2f(0xf6)])({'fileName':_0x220c2f(0x12d)+_0x577b27+'.txt','text':'\x0aMensagem\x20'+(_0x1b0b2a+0x1)+_0x220c2f(0xff)+_0xb0476c+_0x220c2f(0x117)}),await(0x0,wbotMessageListener_1[_0x220c2f(0xf7)])(_0x55a5f1,_0x2fc11d,_0x1cc9a7[_0x220c2f(0x129)],!![]);if(_0x1b0b2a%0x2===0x0){const _0x1b2a18=Math[_0x220c2f(0xf8)](_0x55a5f1[_0x220c2f(0x120)]['low']*0x3e8);_0x15b9dc[_0x220c2f(0x11e)]('importMessages-'+_0x1cc9a7['companyId'],{'action':'update','status':{'this':_0x1b0b2a+0x1,'all':_0xb0476c,'date':(0x0,moment_1[_0x220c2f(0x10a)])(_0x1b2a18)[_0x220c2f(0x101)](_0x220c2f(0x12c))}});}_0x1b0b2a+0x1===_0xb0476c&&(wbot_1[_0x220c2f(0x10e)][_0x577b27]=[],_0x1cc9a7[_0x220c2f(0x10c)]&&await(0x0,exports[_0x220c2f(0x104)])(_0x577b27),await _0x1cc9a7[_0x220c2f(0x119)]({'statusImportMessages':_0x1cc9a7[_0x220c2f(0x10c)]?null:'renderButtonCloseTickets','importOldMessages':null,'importRecentMessages':null}),_0x15b9dc[_0x220c2f(0x11e)](_0x220c2f(0x11a)+_0x1cc9a7[_0x220c2f(0x129)],{'action':_0x220c2f(0x11f)}));}catch(_0x1f4438){}_0x1b0b2a++;}}catch(_0x35c9ef){throw new AppError_1['default'](_0x220c2f(0xfd),0x193);}return _0x220c2f(0xfe);};exports['default']=ImportWhatsAppMessageService;