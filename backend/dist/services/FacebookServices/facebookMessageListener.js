'use strict';const a398_0x271c6d=a398_0x5f5c;function a398_0x5f5c(_0x52111e,_0x2c6d4f){const _0x3aca7c=a398_0x3aca();return a398_0x5f5c=function(_0x5f5cc0,_0x4576d7){_0x5f5cc0=_0x5f5cc0-0x115;let _0x36e8c1=_0x3aca7c[_0x5f5cc0];return _0x36e8c1;},a398_0x5f5c(_0x52111e,_0x2c6d4f);}(function(_0x46227e,_0x5d61d2){const _0x4dc6e0=a398_0x5f5c,_0x52c06a=_0x46227e();while(!![]){try{const _0x11c233=-parseInt(_0x4dc6e0(0x13c))/0x1+-parseInt(_0x4dc6e0(0x136))/0x2*(-parseInt(_0x4dc6e0(0x13e))/0x3)+parseInt(_0x4dc6e0(0x14a))/0x4*(-parseInt(_0x4dc6e0(0x146))/0x5)+-parseInt(_0x4dc6e0(0x125))/0x6+-parseInt(_0x4dc6e0(0x14c))/0x7*(-parseInt(_0x4dc6e0(0x124))/0x8)+parseInt(_0x4dc6e0(0x11c))/0x9+parseInt(_0x4dc6e0(0x14d))/0xa*(parseInt(_0x4dc6e0(0x145))/0xb);if(_0x11c233===_0x5d61d2)break;else _0x52c06a['push'](_0x52c06a['shift']());}catch(_0x50d8c7){_0x52c06a['push'](_0x52c06a['shift']());}}}(a398_0x3aca,0x880f9));var __importDefault=this&&this[a398_0x271c6d(0x126)]||function(_0x494f54){const _0x3b61f8=a398_0x271c6d;return _0x494f54&&_0x494f54[_0x3b61f8(0x118)]?_0x494f54:{'default':_0x494f54};};Object[a398_0x271c6d(0x163)](exports,'__esModule',{'value':!![]}),exports['handleMessage']=exports[a398_0x271c6d(0x12f)]=exports[a398_0x271c6d(0x120)]=void 0x0;const fs_1=require('fs'),fs_2=__importDefault(require('fs')),axios_1=__importDefault(require(a398_0x271c6d(0x132))),path_1=require(a398_0x271c6d(0x15f)),CreateOrUpdateContactService_1=__importDefault(require(a398_0x271c6d(0x152))),CreateMessageService_1=__importDefault(require(a398_0x271c6d(0x129))),FindOrCreateTicketService_1=__importDefault(require(a398_0x271c6d(0x137))),graphAPI_1=require(a398_0x271c6d(0x13b)),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),UpdateTicketService_1=__importDefault(require(a398_0x271c6d(0x139))),Debounce_1=require(a398_0x271c6d(0x14b)),ShowWhatsAppService_1=__importDefault(require(a398_0x271c6d(0x155))),Mustache_1=__importDefault(require(a398_0x271c6d(0x13d))),Queue_1=__importDefault(require(a398_0x271c6d(0x15a))),Chatbot_1=__importDefault(require(a398_0x271c6d(0x164))),Message_1=__importDefault(require(a398_0x271c6d(0x11f))),ChatbotListenerFacebook_1=require(a398_0x271c6d(0x159)),verifyContact=async(_0x11c111,_0x5065b7,_0x174a76)=>{const _0x212c3e=a398_0x271c6d;if(!_0x11c111)return null;const _0x242208={'name':_0x11c111?.['name']||_0x11c111?.[_0x212c3e(0x142)]+'\x20'+_0x11c111?.[_0x212c3e(0x147)],'number':_0x11c111['id'],'profilePicUrl':'','isGroup':![],'companyId':_0x174a76,'channel':_0x5065b7},_0x4725fc=(0x0,CreateOrUpdateContactService_1[_0x212c3e(0x121)])(_0x242208);return _0x4725fc;},verifyMessage=async(_0x4517a4,_0x27e01c,_0x18c195,_0x412642)=>{const _0x207852=a398_0x271c6d,_0x20ac55=await verifyQuotedMessage(_0x4517a4),_0x3e5ba3={'wid':_0x4517a4['mid']||_0x4517a4['message_id'],'ticketId':_0x18c195['id'],'contactId':_0x4517a4['is_echo']?undefined:_0x412642['id'],'body':_0x4517a4[_0x207852(0x157)]||_0x27e01c,'fromMe':_0x4517a4[_0x207852(0x13f)],'read':_0x4517a4?.[_0x207852(0x13f)],'quotedMsgId':_0x20ac55?.['id'],'ack':0x3,'dataJson':JSON[_0x207852(0x12d)](_0x4517a4)};await(0x0,CreateMessageService_1['default'])({'messageData':_0x3e5ba3,'companyId':_0x18c195[_0x207852(0x117)]}),await _0x18c195[_0x207852(0x11a)]({'lastMessage':_0x4517a4[_0x207852(0x157)]});};exports[a398_0x271c6d(0x120)]=verifyMessage;const verifyMessageMedia=async(_0x22cb00,_0xb3724c,_0x53a8dc)=>{const _0x516538=a398_0x271c6d,{data:_0x408d2a}=await axios_1[_0x516538(0x121)][_0x516538(0x133)](_0x22cb00[_0x516538(0x143)][0x0][_0x516538(0x134)][_0x516538(0x15d)],{'responseType':_0x516538(0x12a)}),{fileTypeFromBuffer:_0x155ec8}=await eval('import(\'file-type\');'),_0x5308e0=await _0x155ec8(_0x408d2a),_0xef672c=new Date()[_0x516538(0x14f)]()+'.'+_0x5308e0[_0x516538(0x11b)],_0x560c47=_0x516538(0x160)+_0xb3724c['companyId'];!fs_2[_0x516538(0x121)][_0x516538(0x140)](_0x560c47)&&(fs_2[_0x516538(0x121)][_0x516538(0x12b)](_0x560c47),fs_2[_0x516538(0x121)][_0x516538(0x15e)](_0x560c47,0x1ff));(0x0,fs_1[_0x516538(0x141)])((0x0,path_1[_0x516538(0x131)])(__dirname,'..','..','..',_0x560c47,_0xef672c),_0x408d2a,_0x516538(0x149));const _0xac88c3={'wid':_0x22cb00[_0x516538(0x14e)],'ticketId':_0xb3724c['id'],'contactId':_0x22cb00[_0x516538(0x13f)]?undefined:_0x53a8dc['id'],'body':_0x22cb00[_0x516538(0x157)]||_0xef672c,'fromMe':_0x22cb00[_0x516538(0x13f)],'mediaType':_0x22cb00['attachments'][0x0][_0x516538(0x115)],'mediaUrl':_0xef672c,'read':_0x22cb00['is_echo'],'quotedMsgId':null,'ack':0x3,'dataJson':JSON[_0x516538(0x12d)](_0x22cb00)};await(0x0,CreateMessageService_1[_0x516538(0x121)])({'messageData':_0xac88c3,'companyId':_0xb3724c['companyId']}),await _0xb3724c[_0x516538(0x11a)]({'lastMessage':_0x22cb00['text']});};exports[a398_0x271c6d(0x12f)]=verifyMessageMedia;const verifyQuotedMessage=async _0x5c22b2=>{const _0x537760=a398_0x271c6d;if(!_0x5c22b2)return null;const _0x2b51f4=_0x5c22b2?.[_0x537760(0x161)]?.['mid'];if(!_0x2b51f4)return null;const _0x343aea=await Message_1[_0x537760(0x121)][_0x537760(0x162)]({'where':{'id':_0x2b51f4}});if(!_0x343aea)return null;return _0x343aea;},handleMessage=async(_0x258131,_0xc10b3,_0x49499e,_0x29edea)=>{const _0x84fba2=a398_0x271c6d;try{if(_0xc10b3[_0x84fba2(0x135)]){let _0x27870f,_0x419da5=null;const _0x39be08=_0xc10b3['sender']['id'],_0x23a325=_0xc10b3[_0x84fba2(0x130)]['id'],{message:_0x1cef52}=_0xc10b3,_0xc07f57=_0x1cef52[_0x84fba2(0x13f)];if(_0xc07f57){if(/\u200e/[_0x84fba2(0x116)](_0x1cef52['text']))return;_0x27870f=await(0x0,graphAPI_1[_0x84fba2(0x128)])(_0x23a325,_0x258131[_0x84fba2(0x150)]);}else _0x27870f=await(0x0,graphAPI_1[_0x84fba2(0x128)])(_0x39be08,_0x258131[_0x84fba2(0x150)]);const _0x259c88=await verifyContact(_0x27870f,_0x49499e,_0x29edea),_0x208ca6=_0xc07f57?0x0:0x1,_0x3d4064=await Whatsapp_1[_0x84fba2(0x121)][_0x84fba2(0x162)]({'where':{'facebookPageUserId':_0x258131[_0x84fba2(0x11e)]},'include':[{'model':Queue_1[_0x84fba2(0x121)],'as':_0x84fba2(0x158),'attributes':['id','name',_0x84fba2(0x119),'greetingMessage'],'include':[{'model':Chatbot_1[_0x84fba2(0x121)],'as':_0x84fba2(0x15b),'attributes':['id','name',_0x84fba2(0x148)]}]}],'order':[['queues','id',_0x84fba2(0x165)],[_0x84fba2(0x158),_0x84fba2(0x15b),'id','ASC']]});let _0x5097da=![];if(!_0x419da5){const {ticket:_0x5c5663,isCreated:_0x5f2129}=await(0x0,FindOrCreateTicketService_1[_0x84fba2(0x121)])(_0x259c88,_0x3d4064['id'],_0x208ca6,_0x29edea,0x0,0x0,null,_0x49499e);_0x419da5=_0x5c5663,_0x5097da=_0x5f2129;}if(_0x3d4064[_0x84fba2(0x127)]&&(0x0,Mustache_1['default'])(_0x3d4064[_0x84fba2(0x127)],_0x419da5)===_0x1cef52[_0x84fba2(0x157)])return;if(!_0x5097da){const {ticket:_0x3c66a6,isCreated:_0x5b48f6}=await(0x0,FindOrCreateTicketService_1[_0x84fba2(0x121)])(_0x259c88,_0x3d4064['id'],_0x208ca6,_0x29edea,0x0,0x0,null,_0x49499e);_0x419da5=_0x3c66a6;}await _0x419da5[_0x84fba2(0x11a)]({'lastMessage':_0x1cef52['text']}),_0x1cef52[_0x84fba2(0x143)]?await(0x0,exports[_0x84fba2(0x12f)])(_0x1cef52,_0x419da5,_0x259c88):await(0x0,exports['verifyMessage'])(_0x1cef52,_0x1cef52[_0x84fba2(0x157)],_0x419da5,_0x259c88),!_0x419da5[_0x84fba2(0x153)]&&!_0xc07f57&&!_0x419da5[_0x84fba2(0x151)]&&_0x3d4064[_0x84fba2(0x158)]['length']>=0x1&&await verifyQueue(_0x3d4064,_0x1cef52,_0x419da5,_0x259c88),_0x419da5[_0x84fba2(0x153)]&&_0x419da5[_0x84fba2(0x15c)]&&(!_0x419da5['user']&&await(0x0,ChatbotListenerFacebook_1[_0x84fba2(0x144)])(_0x419da5[_0x84fba2(0x15c)],_0x3d4064,_0x419da5,_0x259c88,_0x1cef52));}return;}catch(_0x3606d3){throw new Error(_0x3606d3);}};exports['handleMessage']=handleMessage;const verifyQueue=async(_0x3f6754,_0xa4f46e,_0x583c36,_0x4d7876)=>{const _0x5d3306=a398_0x271c6d,{queues:_0x50f1d1,greetingMessage:_0x567752}=await(0x0,ShowWhatsAppService_1[_0x5d3306(0x121)])(_0x3f6754['id'],_0x583c36[_0x5d3306(0x117)]);if(_0x50f1d1[_0x5d3306(0x122)]===0x1){await(0x0,UpdateTicketService_1[_0x5d3306(0x121)])({'ticketData':{'queueId':_0x50f1d1[0x0]['id']},'ticketId':_0x583c36['id'],'companyId':_0x583c36['companyId']});return;}const _0x39c74e=_0xa4f46e[_0x5d3306(0x157)],_0x30ef56=_0x50f1d1[+_0x39c74e-0x1];if(_0x30ef56){await(0x0,UpdateTicketService_1[_0x5d3306(0x121)])({'ticketData':{'queueId':_0x30ef56['id']},'ticketId':_0x583c36['id'],'companyId':_0x583c36['companyId']});if(_0x30ef56['chatbots'][_0x5d3306(0x122)]>0x0){let _0xb544c4='';_0x30ef56[_0x5d3306(0x15b)][_0x5d3306(0x138)]((_0x7f5209,_0x5b4735)=>{const _0x4f6792=_0x5d3306;_0xb544c4+='['+(_0x5b4735+0x1)+_0x4f6792(0x154)+_0x7f5209['name']+'\x0a';});const _0x7ef61a=(0x0,Mustache_1[_0x5d3306(0x121)])('‎'+_0x30ef56[_0x5d3306(0x148)]+'\x0a\x0a'+_0xb544c4+_0x5d3306(0x12c),_0x583c36);return(0x0,graphAPI_1[_0x5d3306(0x11d)])(_0x4d7876[_0x5d3306(0x123)],(0x0,Mustache_1[_0x5d3306(0x121)])(_0x7ef61a,_0x583c36),_0x583c36[_0x5d3306(0x13a)][_0x5d3306(0x150)]),await(0x0,exports['verifyMessage'])(_0xa4f46e,_0x7ef61a,_0x583c36,_0x4d7876);}if(!_0x30ef56[_0x5d3306(0x15b)][_0x5d3306(0x122)]){const _0x3633bf=(0x0,Mustache_1[_0x5d3306(0x121)])('‎'+_0x30ef56['greetingMessage'],_0x583c36);return(0x0,graphAPI_1['sendText'])(_0x4d7876['number'],(0x0,Mustache_1[_0x5d3306(0x121)])(_0x3633bf,_0x583c36),_0x583c36[_0x5d3306(0x13a)][_0x5d3306(0x150)]),await(0x0,exports['verifyMessage'])(_0xa4f46e,_0x3633bf,_0x583c36,_0x4d7876);}}else{let _0x1d335d='';_0x50f1d1['forEach']((_0x48eaf8,_0x5d3027)=>{const _0xd160be=_0x5d3306;_0x1d335d+='['+(_0x5d3027+0x1)+']\x20-\x20'+_0x48eaf8[_0xd160be(0x156)]+'\x0a';});const _0x215274=(0x0,Mustache_1[_0x5d3306(0x121)])('‎'+_0x567752+'\x0a\x0a'+_0x1d335d,_0x583c36),_0x291e9f=(0x0,Debounce_1[_0x5d3306(0x12e)])(async()=>{const _0x5450a6=_0x5d3306;return(0x0,graphAPI_1[_0x5450a6(0x11d)])(_0x4d7876['number'],(0x0,Mustache_1[_0x5450a6(0x121)])(_0x215274,_0x583c36),_0x583c36[_0x5450a6(0x13a)]['facebookUserToken']),(0x0,exports[_0x5450a6(0x120)])(_0xa4f46e,_0x215274,_0x583c36,_0x4d7876);},0xbb8,_0x583c36['id']);_0x291e9f();}};function a398_0x3aca(){const _0x1a9d24=['chatbots','queueId','url','chmodSync','path','public/company','reply_to','findOne','defineProperty','../../models/Chatbot','ASC','type','test','companyId','__esModule','color','update','ext','5369598xXtPsb','sendText','facebookPageUserId','../../models/Message','verifyMessage','default','length','number','24FUhzQS','5218728mOmiJU','__importDefault','farewellMessage','profilePsid','../MessageServices/CreateMessageService','arraybuffer','mkdirSync','\x0a*#*\x20Voltar\x20para\x20o\x20menu\x20principal','stringify','debounce','verifyMessageMedia','recipient','join','axios','get','payload','message','137974LOMVyL','../TicketServices/FindOrCreateTicketService','forEach','../TicketServices/UpdateTicketService','whatsapp','./graphAPI','478277acXADN','../../helpers/Mustache','3sqzUgM','is_echo','existsSync','writeFileSync','first_name','attachments','sayChatbot','95491oJhccN','10VSQcNN','last_name','greetingMessage','base64','718868cIeqMC','../../helpers/Debounce','2029979fNFrni','840nkUcPa','mid','getTime','facebookUserToken','userId','../ContactServices/CreateOrUpdateContactService','queue',']\x20-\x20','../WhatsappService/ShowWhatsAppService','name','text','queues','../WbotServices/ChatbotListenerFacebook','../../models/Queue'];a398_0x3aca=function(){return _0x1a9d24;};return a398_0x3aca();}