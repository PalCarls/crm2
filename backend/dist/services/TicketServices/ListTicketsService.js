'use strict';const a503_0x29e25e=a503_0x1f3d;(function(_0x597708,_0x4b085f){const _0x3d38aa=a503_0x1f3d,_0x371640=_0x597708();while(!![]){try{const _0x49e44f=-parseInt(_0x3d38aa(0x1fc))/0x1+-parseInt(_0x3d38aa(0x229))/0x2*(-parseInt(_0x3d38aa(0x204))/0x3)+-parseInt(_0x3d38aa(0x22e))/0x4+parseInt(_0x3d38aa(0x1fa))/0x5+-parseInt(_0x3d38aa(0x21e))/0x6*(-parseInt(_0x3d38aa(0x21a))/0x7)+parseInt(_0x3d38aa(0x225))/0x8*(-parseInt(_0x3d38aa(0x220))/0x9)+-parseInt(_0x3d38aa(0x20e))/0xa*(-parseInt(_0x3d38aa(0x1f9))/0xb);if(_0x49e44f===_0x4b085f)break;else _0x371640['push'](_0x371640['shift']());}catch(_0x533813){_0x371640['push'](_0x371640['shift']());}}}(a503_0x1095,0x4780e));var __importDefault=this&&this[a503_0x29e25e(0x1ef)]||function(_0x518401){return _0x518401&&_0x518401['__esModule']?_0x518401:{'default':_0x518401};};function a503_0x1f3d(_0x5c3937,_0x4f0e6d){const _0x109525=a503_0x1095();return a503_0x1f3d=function(_0x1f3d45,_0x4eeb90){_0x1f3d45=_0x1f3d45-0x1ea;let _0x477c30=_0x109525[_0x1f3d45];return _0x477c30;},a503_0x1f3d(_0x5c3937,_0x4f0e6d);}function a503_0x1095(){const _0x383545=['intersection','email','max','true','admin','updatedAt','allTicket','../../models/ContactTag','345240rQIqjc','expiresTicket','pending','__esModule','42ohQdiq','contactId','261243DgwSnJ','../UserServices/ShowUserService','tags','group','contact','152GjuGrw','profile','open','push','7088DVGTRW','Sequelize','color','extraInfo','body','2162528nqttgx','findAll','isArray','closed','../../models/Ticket','queue','__importDefault','map','LIKE','trim','like','acceptAudioMessage','contact.name','search','defineProperty','active','13273843CvMdVu','310055XJeeDP','../../models/Tag','462845bFMRHX','DESC','disable','contactTags','where','whatsapp','enable','../../models/Queue','198ONNRpY','LOWER','user','profilePicUrl','allowGroup','companyId','../../models/Contact','whatsappId','default','name','10ywGrLg','length','queueId','col'];a503_0x1095=function(){return _0x383545;};return a503_0x1095();}Object[a503_0x29e25e(0x1f7)](exports,a503_0x29e25e(0x21d),{'value':!![]});const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require(a503_0x29e25e(0x1ed))),Contact_1=__importDefault(require(a503_0x29e25e(0x20a))),Message_1=__importDefault(require('../../models/Message')),Queue_1=__importDefault(require(a503_0x29e25e(0x203))),User_1=__importDefault(require('../../models/User')),ShowUserService_1=__importDefault(require(a503_0x29e25e(0x221))),Tag_1=__importDefault(require(a503_0x29e25e(0x1fb))),lodash_1=require('lodash'),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),ContactTag_1=__importDefault(require(a503_0x29e25e(0x219))),ListTicketsService=async({searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x1aafac,tags:_0x1702c6,users:_0x1e4627,status:_0x514454,date:_0x3a6a8a,dateStart:_0x4366d6,dateEnd:_0x546d20,updatedAt:_0x216700,showAll:_0x508076,userId:_0x4806e2,withUnreadMessages:_0x42821c,whatsappIds:_0x281ff3,statusFilters:_0x2f945c,companyId:_0x2993ea})=>{const _0x2d920e=a503_0x29e25e;let _0x665259={'status':_0x2d920e(0x21c)},_0x3868d8;_0x3868d8=[{'model':Contact_1[_0x2d920e(0x20c)],'as':_0x2d920e(0x224),'attributes':['id',_0x2d920e(0x20d),'number',_0x2d920e(0x213),_0x2d920e(0x207),_0x2d920e(0x1f4),_0x2d920e(0x1f8)],'include':[_0x2d920e(0x22c),_0x2d920e(0x1ff),_0x2d920e(0x222)]},{'model':Queue_1[_0x2d920e(0x20c)],'as':_0x2d920e(0x1ee),'attributes':['id',_0x2d920e(0x20d),'color']},{'model':User_1[_0x2d920e(0x20c)],'as':_0x2d920e(0x206),'attributes':['id',_0x2d920e(0x20d)]},{'model':Tag_1[_0x2d920e(0x20c)],'as':'tags','attributes':['id','name',_0x2d920e(0x22b)]},{'model':Whatsapp_1['default'],'as':_0x2d920e(0x201),'attributes':[_0x2d920e(0x20d),_0x2d920e(0x21b)]}];const _0x411cbc=await(0x0,ShowUserService_1[_0x2d920e(0x20c)])(_0x4806e2);_0x514454===_0x2d920e(0x227)&&(_0x665259={..._0x665259,'userId':_0x4806e2,'queueId':{[sequelize_1['Op']['in']]:_0x1aafac}});_0x514454===_0x2d920e(0x223)&&(_0x665259={..._0x665259,'queueId':_0x411cbc[_0x2d920e(0x208)]&&_0x411cbc['allTicket']||_0x508076===_0x2d920e(0x215)?null:{[sequelize_1['Op']['in']]:_0x1aafac}});if(_0x411cbc[_0x2d920e(0x226)]===_0x2d920e(0x206)&&_0x514454===_0x2d920e(0x21c)&&_0x411cbc[_0x2d920e(0x218)]===_0x2d920e(0x202)){const _0x44d67a=[],_0x19c6aa=await Ticket_1['default'][_0x2d920e(0x1ea)]({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x411cbc['id'],null]},'queueId':{[sequelize_1['Op']['or']]:[_0x1aafac,null]},'status':'pending'}});_0x19c6aa&&_0x44d67a[_0x2d920e(0x228)](_0x19c6aa[_0x2d920e(0x1f0)](_0x5aece8=>_0x5aece8['id']));const _0x30b76d=(0x0,lodash_1[_0x2d920e(0x212)])(..._0x44d67a);_0x665259={..._0x665259,'id':{[sequelize_1['Op']['in']]:_0x30b76d}};}if(_0x411cbc['profile']===_0x2d920e(0x206)&&_0x514454==='pending'&&_0x411cbc[_0x2d920e(0x218)]===_0x2d920e(0x1fe)){const _0x348304=[],_0x2b5036=await Ticket_1[_0x2d920e(0x20c)][_0x2d920e(0x1ea)]({'where':{[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op']['or']]:[_0x411cbc['id'],null]}},{'status':{[sequelize_1['Op']['or']]:[_0x2d920e(0x21c),'closed']}}],'queueId':{[sequelize_1['Op']['in']]:_0x1aafac},'status':_0x2d920e(0x21c)}});_0x2b5036&&_0x348304['push'](_0x2b5036['map'](_0x598adf=>_0x598adf['id']));const _0x4720da=(0x0,lodash_1[_0x2d920e(0x212)])(..._0x348304);_0x665259={..._0x665259,'id':{[sequelize_1['Op']['in']]:_0x4720da}};}_0x508076==='true'&&_0x411cbc['profile']===_0x2d920e(0x216)&&(_0x665259={'queueId':{[sequelize_1['Op']['or']]:[_0x1aafac,null]}});_0x514454&&_0x514454!==_0x2d920e(0x1f6)&&(_0x665259={..._0x665259,'status':_0x514454});if(_0x514454===_0x2d920e(0x1ec)){const _0x13d56f=[],_0x45bf6a=await Ticket_1[_0x2d920e(0x20c)]['findAll']({'where':{'queueId':_0x508076===_0x2d920e(0x215)||_0x411cbc['allTicket']==='enable'?{[sequelize_1['Op']['or']]:[_0x1aafac,null]}:_0x1aafac},'group':[_0x2d920e(0x209),_0x2d920e(0x21f),_0x2d920e(0x210),_0x2d920e(0x20b)],'attributes':[_0x2d920e(0x209),_0x2d920e(0x21f),_0x2d920e(0x210),_0x2d920e(0x20b),[sequelize_1[_0x2d920e(0x22a)]['fn'](_0x2d920e(0x214),sequelize_1['Sequelize'][_0x2d920e(0x211)]('id')),'id']]});_0x45bf6a&&_0x13d56f[_0x2d920e(0x228)](_0x45bf6a[_0x2d920e(0x1f0)](_0x36f82e=>_0x36f82e['id']));const _0x154164=(0x0,lodash_1[_0x2d920e(0x212)])(..._0x13d56f);_0x665259={..._0x665259,'id':{[sequelize_1['Op']['in']]:_0x154164}};}if(_0x514454===_0x2d920e(0x1f6)){_0x665259={'companyId':_0x2993ea};_0x411cbc['profile']===_0x2d920e(0x206)&&(_0x665259={..._0x665259,'queueId':{[sequelize_1['Op']['in']]:_0x1aafac}});_0x42821c===_0x2d920e(0x215)&&(_0x665259={..._0x665259,[sequelize_1['Op']['or']]:[{'userId':_0x4806e2},{'status':_0x2d920e(0x21c)}],'queueId':{[sequelize_1['Op']['or']]:[_0x1aafac,null]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0}});if(searchParam){const _0x4d051b=searchParam['toLocaleLowerCase']()[_0x2d920e(0x1f2)]();_0x3868d8=[..._0x3868d8,{'model':Message_1[_0x2d920e(0x20c)],'as':'messages','attributes':['id',_0x2d920e(0x22d)],'where':{'body':(0x0,sequelize_1[_0x2d920e(0x200)])((0x0,sequelize_1['fn'])('LOWER',(0x0,sequelize_1[_0x2d920e(0x211)])(_0x2d920e(0x22d))),_0x2d920e(0x1f1),'%'+_0x4d051b+'%')},'required':![],'duplicating':![]}],_0x665259={..._0x665259,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x2d920e(0x200)])((0x0,sequelize_1['fn'])(_0x2d920e(0x205),(0x0,sequelize_1[_0x2d920e(0x211)])(_0x2d920e(0x1f5))),_0x2d920e(0x1f1),'%'+_0x4d051b+'%')},{'$contact.number$':{[sequelize_1['Op'][_0x2d920e(0x1f3)]]:'%'+_0x4d051b+'%'}},{'$message.body$':(0x0,sequelize_1['where'])((0x0,sequelize_1['fn'])(_0x2d920e(0x205),(0x0,sequelize_1[_0x2d920e(0x211)])(_0x2d920e(0x22d))),_0x2d920e(0x1f1),'%'+_0x4d051b+'%')}]};}if(Array[_0x2d920e(0x1eb)](_0x1702c6)&&_0x1702c6[_0x2d920e(0x20f)]>0x0){const _0x3fbe82=[],_0x3a93fb=await ContactTag_1[_0x2d920e(0x20c)][_0x2d920e(0x1ea)]({'where':{'tagId':{[sequelize_1['Op']['in']]:_0x1702c6}}});_0x3a93fb&&_0x3fbe82[_0x2d920e(0x228)](_0x3a93fb[_0x2d920e(0x1f0)](_0x57ba4f=>_0x57ba4f[_0x2d920e(0x21f)]));const _0x214562=(0x0,lodash_1[_0x2d920e(0x212)])(..._0x3fbe82);_0x665259={..._0x665259,'contactId':{[sequelize_1['Op']['in']]:_0x214562}};}Array[_0x2d920e(0x1eb)](_0x1e4627)&&_0x1e4627[_0x2d920e(0x20f)]>0x0&&(_0x665259={..._0x665259,'userId':{[sequelize_1['Op']['in']]:_0x1e4627}}),Array[_0x2d920e(0x1eb)](_0x281ff3)&&_0x281ff3['length']>0x0&&(_0x665259={..._0x665259,'whatsappId':{[sequelize_1['Op']['in']]:_0x281ff3}}),Array['isArray'](_0x2f945c)&&_0x2f945c['length']>0x0&&(_0x665259={..._0x665259,'status':{[sequelize_1['Op']['in']]:_0x2f945c}});}const _0x13fd99=0x28,_0x47bff6=_0x13fd99*(+pageNumber-0x1);_0x665259={..._0x665259,'companyId':_0x2993ea};const {count:_0x469efc,rows:_0x379e4f}=await Ticket_1[_0x2d920e(0x20c)]['findAndCountAll']({'where':_0x665259,'include':_0x3868d8,'distinct':!![],'limit':_0x13fd99,'offset':_0x47bff6,'order':[[_0x2d920e(0x217),_0x2d920e(0x1fd)]],'subQuery':![]}),_0x59f8a7=_0x469efc>_0x47bff6+_0x379e4f['length'];return{'tickets':_0x379e4f,'count':_0x469efc,'hasMore':_0x59f8a7};};exports['default']=ListTicketsService;