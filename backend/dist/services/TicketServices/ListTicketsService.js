'use strict';function a583_0x3bc7(_0x49878e,_0x4f9efd){const _0x3b721d=a583_0x3b72();return a583_0x3bc7=function(_0x3bc792,_0x3e6ab3){_0x3bc792=_0x3bc792-0x1aa;let _0x17f4db=_0x3b721d[_0x3bc792];return _0x17f4db;},a583_0x3bc7(_0x49878e,_0x4f9efd);}function a583_0x3b72(){const _0x1b8fee=['allHistoric','expiresTicket','allUserChat','groupAsTicket','intersection','like','7GPkteJ','../UserServices/ShowUserService','findAndCountAll','name','email','where','contact','enabled','extraInfo','trim','../../models/Contact','228774gyqeIy','messages','findAll','contactId','whatsapp','urlPicture','183024lZYwjl','companyId','admin','notIn','true','profile','false','MAX(\x22id\x22)','3511096HcCMUj','user','__esModule','585078HfHRaT','search','allTicket','default','pending','color','length','whatsappId','open','842135wcXShc','contactTags','allowGroup','500160UjzPFH','profilePicUrl','col','nps','literal','../../models/Queue','LIKE','../../models/Whatsapp','enable','map','number','unaccent','../../models/ContactTag','queue','isArray','body','push','DESC','../../models/Tag','sequelize','contact.name','closed','1569228obhNWI','__importDefault','tags','LOWER','group'];a583_0x3b72=function(){return _0x1b8fee;};return a583_0x3b72();}const a583_0x3cc845=a583_0x3bc7;(function(_0x404def,_0x581b29){const _0x197ee4=a583_0x3bc7,_0x103e31=_0x404def();while(!![]){try{const _0x5af6cb=parseInt(_0x197ee4(0x1da))/0x1+-parseInt(_0x197ee4(0x1ae))/0x2+parseInt(_0x197ee4(0x1eb))/0x3+-parseInt(_0x197ee4(0x1e0))/0x4+-parseInt(_0x197ee4(0x1ab))/0x5+-parseInt(_0x197ee4(0x1c4))/0x6+-parseInt(_0x197ee4(0x1cf))/0x7*(-parseInt(_0x197ee4(0x1e8))/0x8);if(_0x5af6cb===_0x581b29)break;else _0x103e31['push'](_0x103e31['shift']());}catch(_0x1ea29f){_0x103e31['push'](_0x103e31['shift']());}}}(a583_0x3b72,0x216b6));var __importDefault=this&&this[a583_0x3cc845(0x1c5)]||function(_0x1cbdb0){const _0x395a23=a583_0x3cc845;return _0x1cbdb0&&_0x1cbdb0[_0x395a23(0x1ea)]?_0x1cbdb0:{'default':_0x1cbdb0};};Object['defineProperty'](exports,a583_0x3cc845(0x1ea),{'value':!![]});const sequelize_1=require(a583_0x3cc845(0x1c1)),Ticket_1=__importDefault(require('../../models/Ticket')),Contact_1=__importDefault(require(a583_0x3cc845(0x1d9))),Message_1=__importDefault(require('../../models/Message')),Queue_1=__importDefault(require(a583_0x3cc845(0x1b3))),User_1=__importDefault(require('../../models/User')),ShowUserService_1=__importDefault(require(a583_0x3cc845(0x1d0))),Tag_1=__importDefault(require(a583_0x3cc845(0x1c0))),lodash_1=require('lodash'),Whatsapp_1=__importDefault(require(a583_0x3cc845(0x1b5))),ContactTag_1=__importDefault(require(a583_0x3cc845(0x1ba))),remove_accents_1=__importDefault(require('remove-accents')),isQueueIdHistoryBlocked_1=__importDefault(require('../UserServices/isQueueIdHistoryBlocked')),ListTicketsService=async({searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x5b7231,tags:_0x517804,users:_0x2249ed,status:_0x5ded76,date:_0x1031de,dateStart:_0x5a3917,dateEnd:_0x118ff4,updatedAt:_0x4ed8d8,showAll:_0x34970d,userId:_0x15328a,withUnreadMessages:_0x216a27,whatsappIds:_0x598fe5,statusFilters:_0x47f0ae,companyId:_0xb7cc87})=>{const _0x3405ae=a583_0x3cc845,_0x28edc4=await(0x0,isQueueIdHistoryBlocked_1[_0x3405ae(0x1ee)])({'userRequest':_0x15328a});let _0x467dd1;!_0x28edc4?_0x467dd1={[sequelize_1['Op']['or']]:[{'userId':_0x15328a},{'status':_0x3405ae(0x1ef)}],'queueId':{[sequelize_1['Op']['or']]:[_0x5b7231,null]},'companyId':_0xb7cc87}:_0x467dd1={[sequelize_1['Op']['or']]:[{'userId':_0x15328a},{'status':_0x3405ae(0x1ef)}],'companyId':_0xb7cc87};let _0x57e34c;_0x57e34c=[{'model':Contact_1['default'],'as':_0x3405ae(0x1d5),'attributes':['id','name',_0x3405ae(0x1b8),_0x3405ae(0x1d3),_0x3405ae(0x1af),'acceptAudioMessage','active',_0x3405ae(0x1df),_0x3405ae(0x1e1)],'include':[_0x3405ae(0x1d7),_0x3405ae(0x1ac)]},{'model':Queue_1[_0x3405ae(0x1ee)],'as':_0x3405ae(0x1bb),'attributes':['id',_0x3405ae(0x1d2),_0x3405ae(0x1f0)]},{'model':User_1[_0x3405ae(0x1ee)],'as':_0x3405ae(0x1e9),'attributes':['id',_0x3405ae(0x1d2)]},{'model':Tag_1[_0x3405ae(0x1ee)],'as':_0x3405ae(0x1c6),'attributes':['id','name',_0x3405ae(0x1f0)]},{'model':Whatsapp_1[_0x3405ae(0x1ee)],'as':_0x3405ae(0x1de),'attributes':['id',_0x3405ae(0x1d2),_0x3405ae(0x1ca),_0x3405ae(0x1cc)]}];const _0x160dba=await(0x0,ShowUserService_1[_0x3405ae(0x1ee)])(_0x15328a,_0xb7cc87),_0xfd850=_0x160dba['queues'][_0x3405ae(0x1b7)](_0x25f9f0=>_0x25f9f0['id']);_0x5ded76===_0x3405ae(0x1aa)&&(_0x467dd1={..._0x467dd1,'userId':_0x15328a,'queueId':{[sequelize_1['Op']['in']]:_0x5b7231}});_0x5ded76==='group'&&(_0x160dba['allowGroup']||_0x34970d===_0x3405ae(0x1e4))&&(_0x467dd1={..._0x467dd1,'queueId':{[sequelize_1['Op']['or']]:[_0x5b7231,null]}});if(_0x160dba['profile']===_0x3405ae(0x1e9)&&_0x5ded76==='pending'&&_0x160dba[_0x3405ae(0x1ed)]===_0x3405ae(0x1b6)){const _0xf8d68=[];let _0x45e88b=[];!_0x28edc4?_0x45e88b=await Ticket_1[_0x3405ae(0x1ee)]['findAll']({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x160dba['id'],null]},'queueId':{[sequelize_1['Op']['or']]:[_0x5b7231,null]},'status':_0x3405ae(0x1ef),'companyId':_0xb7cc87}}):_0x45e88b=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x160dba['id'],null]},'status':_0x3405ae(0x1ef),'companyId':_0xb7cc87}});_0x45e88b&&_0xf8d68['push'](_0x45e88b[_0x3405ae(0x1b7)](_0xd59ed3=>_0xd59ed3['id']));const _0x1da9d3=(0x0,lodash_1['intersection'])(..._0xf8d68);_0x467dd1={..._0x467dd1,'id':_0x1da9d3};}if(_0x160dba[_0x3405ae(0x1e5)]===_0x3405ae(0x1e9)&&_0x5ded76===_0x3405ae(0x1ef)&&_0x160dba[_0x3405ae(0x1ed)]==='disable'){const _0x9e2e99=[];let _0x1cd4ac=[];!_0x28edc4?_0x1cd4ac=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'where':{'companyId':_0xb7cc87,'userId':{[sequelize_1['Op']['or']]:[_0x160dba['id'],null]},'status':_0x3405ae(0x1ef),'queueId':{[sequelize_1['Op']['in']]:_0x5b7231}}}):_0x1cd4ac=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'where':{'companyId':_0xb7cc87,[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op']['or']]:[_0x160dba['id'],null]}},{'status':_0x3405ae(0x1ef)}],'status':'pending'}});_0x1cd4ac&&_0x9e2e99[_0x3405ae(0x1be)](_0x1cd4ac[_0x3405ae(0x1b7)](_0x27d19d=>_0x27d19d['id']));const _0x1302cc=(0x0,lodash_1[_0x3405ae(0x1cd)])(..._0x9e2e99);_0x467dd1={..._0x467dd1,'id':_0x1302cc};}_0x34970d===_0x3405ae(0x1e4)&&(_0x160dba[_0x3405ae(0x1e5)]===_0x3405ae(0x1e2)||_0x160dba[_0x3405ae(0x1cb)]===_0x3405ae(0x1d6))&&(_0x160dba[_0x3405ae(0x1c9)]==='enabled'?_0x467dd1={}:_0x467dd1={'queueId':{[sequelize_1['Op']['or']]:[_0x5b7231,null]}});_0x5ded76&&_0x5ded76!==_0x3405ae(0x1ec)&&(_0x467dd1={..._0x467dd1,'status':_0x5ded76});if(_0x5ded76==='closed'){let _0xd8dcdf;if(!_0x28edc4){let _0x295625={'companyId':_0xb7cc87,'status':_0x3405ae(0x1c3)};_0x34970d===_0x3405ae(0x1e6)&&_0x160dba[_0x3405ae(0x1e5)]==='admin'?_0x295625={..._0x295625,'queueId':_0x5b7231,'userId':_0x15328a}:_0x295625={..._0x295625,'queueId':_0x34970d===_0x3405ae(0x1e4)||_0x160dba['allTicket']===_0x3405ae(0x1b6)?{[sequelize_1['Op']['or']]:[_0x5b7231,null]}:_0x5b7231},_0xd8dcdf=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'attributes':[_0x3405ae(0x1e1),_0x3405ae(0x1dd),_0x3405ae(0x1f2),[(0x0,sequelize_1[_0x3405ae(0x1b2)])(_0x3405ae(0x1e7)),'id']],'where':_0x295625,'group':['companyId',_0x3405ae(0x1dd),_0x3405ae(0x1f2)]});}else{let _0x593c87={'companyId':_0xb7cc87,'status':_0x3405ae(0x1c3)};_0x34970d==='false'&&(_0x160dba['profile']===_0x3405ae(0x1e2)||_0x160dba[_0x3405ae(0x1cb)]==='enabled')&&(_0x593c87={..._0x593c87,'queueId':_0x5b7231,'userId':_0x15328a}),_0xd8dcdf=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'attributes':[_0x3405ae(0x1e1),_0x3405ae(0x1dd),_0x3405ae(0x1f2),[(0x0,sequelize_1[_0x3405ae(0x1b2)])('MAX(\x22id\x22)'),'id']],'where':_0x593c87,'group':[_0x3405ae(0x1e1),_0x3405ae(0x1dd),_0x3405ae(0x1f2)]});}const _0xfb798e=_0xd8dcdf[_0x3405ae(0x1b7)](_0x3d2416=>_0x3d2416['id']);_0x467dd1={'id':_0xfb798e};};if(_0x5ded76===_0x3405ae(0x1ec)){_0x467dd1={'companyId':_0xb7cc87};let _0x4301ca;if(!_0x28edc4)_0x4301ca=await Ticket_1['default'][_0x3405ae(0x1dc)]({'attributes':[_0x3405ae(0x1e1),_0x3405ae(0x1dd),_0x3405ae(0x1f2),[(0x0,sequelize_1[_0x3405ae(0x1b2)])(_0x3405ae(0x1e7)),'id']],'where':{[sequelize_1['Op']['or']]:[{'userId':_0x15328a},{'status':[_0x3405ae(0x1ef),_0x3405ae(0x1c3)]}],'queueId':_0x34970d==='true'||_0x160dba[_0x3405ae(0x1ed)]==='enable'?{[sequelize_1['Op']['or']]:[_0x5b7231,null]}:_0x5b7231,'companyId':_0xb7cc87},'group':[_0x3405ae(0x1e1),'contactId',_0x3405ae(0x1f2)]});else{let _0xe17348={'companyId':_0xb7cc87,[sequelize_1['Op']['or']]:[{'userId':_0x15328a},{'status':[_0x3405ae(0x1ef),'closed']}]};_0x34970d===_0x3405ae(0x1e6)&&_0x160dba[_0x3405ae(0x1e5)]===_0x3405ae(0x1e2)&&(_0xe17348={..._0xe17348,'queueId':_0x5b7231}),_0x4301ca=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'attributes':['companyId',_0x3405ae(0x1dd),_0x3405ae(0x1f2),[(0x0,sequelize_1[_0x3405ae(0x1b2)])(_0x3405ae(0x1e7)),'id']],'where':_0xe17348,'group':[_0x3405ae(0x1e1),_0x3405ae(0x1dd),_0x3405ae(0x1f2)]});}const _0x27609a=_0x4301ca[_0x3405ae(0x1b7)](_0x2af1ef=>_0x2af1ef['id']);_0x467dd1={..._0x467dd1,'id':{[sequelize_1['Op']['in']]:_0x27609a}};if(searchParam){const _0x55752a=(0x0,remove_accents_1[_0x3405ae(0x1ee)])(searchParam['toLocaleLowerCase']()[_0x3405ae(0x1d8)]());_0x57e34c=[..._0x57e34c,{'model':Message_1['default'],'as':_0x3405ae(0x1db),'attributes':['id',_0x3405ae(0x1bd)],'where':{'body':(0x0,sequelize_1[_0x3405ae(0x1d4)])((0x0,sequelize_1['fn'])(_0x3405ae(0x1c7),(0x0,sequelize_1['fn'])(_0x3405ae(0x1b9),(0x0,sequelize_1[_0x3405ae(0x1b0)])(_0x3405ae(0x1bd)))),'LIKE','%'+_0x55752a+'%')},'required':![],'duplicating':![]}],_0x467dd1={..._0x467dd1,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x3405ae(0x1d4)])((0x0,sequelize_1['fn'])(_0x3405ae(0x1c7),(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1[_0x3405ae(0x1b0)])(_0x3405ae(0x1c2)))),_0x3405ae(0x1b4),'%'+_0x55752a+'%')},{'$contact.number$':{[sequelize_1['Op'][_0x3405ae(0x1ce)]]:'%'+_0x55752a+'%'}},{'$message.body$':(0x0,sequelize_1[_0x3405ae(0x1d4)])((0x0,sequelize_1['fn'])(_0x3405ae(0x1c7),(0x0,sequelize_1['fn'])(_0x3405ae(0x1b9),(0x0,sequelize_1[_0x3405ae(0x1b0)])('body'))),_0x3405ae(0x1b4),'%'+_0x55752a+'%')}]};}if(Array[_0x3405ae(0x1bc)](_0x517804)&&_0x517804[_0x3405ae(0x1f1)]>0x0){const _0x3a691a=[],_0x2e063a=await ContactTag_1[_0x3405ae(0x1ee)][_0x3405ae(0x1dc)]({'where':{'tagId':{[sequelize_1['Op']['in']]:_0x517804}}});_0x2e063a&&_0x3a691a['push'](_0x2e063a[_0x3405ae(0x1b7)](_0x412a5a=>_0x412a5a[_0x3405ae(0x1dd)]));const _0x9039b=(0x0,lodash_1['intersection'])(..._0x3a691a);_0x467dd1={..._0x467dd1,'contactId':{[sequelize_1['Op']['in']]:_0x9039b}};}Array[_0x3405ae(0x1bc)](_0x2249ed)&&_0x2249ed[_0x3405ae(0x1f1)]>0x0&&(_0x467dd1={..._0x467dd1,'userId':{[sequelize_1['Op']['in']]:_0x2249ed}}),Array[_0x3405ae(0x1bc)](_0x598fe5)&&_0x598fe5[_0x3405ae(0x1f1)]>0x0&&(_0x467dd1={..._0x467dd1,'whatsappId':{[sequelize_1['Op']['in']]:_0x598fe5}}),Array[_0x3405ae(0x1bc)](_0x47f0ae)&&_0x47f0ae[_0x3405ae(0x1f1)]>0x0&&(_0x467dd1={..._0x467dd1,'status':{[sequelize_1['Op']['in']]:_0x47f0ae}});}_0x216a27==='true'&&(_0x467dd1={[sequelize_1['Op']['or']]:[{'userId':_0x15328a,'status':{[sequelize_1['Op'][_0x3405ae(0x1e3)]]:[_0x3405ae(0x1c3),'lgpd',_0x3405ae(0x1b1)]},'queueId':{[sequelize_1['Op']['in']]:_0xfd850},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0xb7cc87},{'status':{[sequelize_1['Op']['in']]:[_0x3405ae(0x1ef),_0x3405ae(0x1c8)]},'queueId':{[sequelize_1['Op']['or']]:[_0xfd850,null]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0xb7cc87}]},_0x5ded76===_0x3405ae(0x1c8)&&(_0x160dba[_0x3405ae(0x1ad)]||_0x34970d==='true')&&(_0x467dd1={..._0x467dd1,'queueId':{[sequelize_1['Op']['or']]:[_0xfd850,null]}}));_0x467dd1={..._0x467dd1,'companyId':_0xb7cc87};const _0x1e4be2=0x28,_0x165863=_0x1e4be2*(+pageNumber-0x1),{count:_0x20c45e,rows:_0x1adc6f}=await Ticket_1[_0x3405ae(0x1ee)][_0x3405ae(0x1d1)]({'where':_0x467dd1,'include':_0x57e34c,'distinct':!![],'limit':_0x1e4be2,'offset':_0x165863,'order':[['updatedAt',_0x3405ae(0x1bf)]],'subQuery':![]}),_0x280d93=_0x20c45e>_0x165863+_0x1adc6f[_0x3405ae(0x1f1)];return{'tickets':_0x1adc6f,'count':_0x20c45e,'hasMore':_0x280d93};};exports['default']=ListTicketsService;