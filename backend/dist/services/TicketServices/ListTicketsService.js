'use strict';const a601_0x564878=a601_0x2b11;(function(_0x7f0753,_0x2d13ab){const _0x5cb846=a601_0x2b11,_0x243020=_0x7f0753();while(!![]){try{const _0x199d10=-parseInt(_0x5cb846(0x9d))/0x1*(-parseInt(_0x5cb846(0x7f))/0x2)+-parseInt(_0x5cb846(0x7b))/0x3*(parseInt(_0x5cb846(0x77))/0x4)+parseInt(_0x5cb846(0x83))/0x5+parseInt(_0x5cb846(0x8e))/0x6*(parseInt(_0x5cb846(0x9f))/0x7)+-parseInt(_0x5cb846(0x90))/0x8+-parseInt(_0x5cb846(0x74))/0x9*(parseInt(_0x5cb846(0x85))/0xa)+parseInt(_0x5cb846(0x87))/0xb*(parseInt(_0x5cb846(0xa4))/0xc);if(_0x199d10===_0x2d13ab)break;else _0x243020['push'](_0x243020['shift']());}catch(_0xf0aa15){_0x243020['push'](_0x243020['shift']());}}}(a601_0x1642,0xdc532));function a601_0x1642(){const _0x850837=['profilePicUrl','3181385gcXuDi','queue','30PxntkJ','length','11hPRMWo','urlPicture','trim','push','../UserServices/isQueueIdHistoryBlocked','group','lodash','11094IcBYKK','findAndCountAll','9969848pePSTG','closed','where','__esModule','pending','../../models/Ticket','isArray','../UserServices/ShowUserService','DESC','allHistoric','col','extraInfo','../../models/Queue','9QUjsyJ','toLocaleLowerCase','1302vroAid','LOWER','contactTags','lgpd','allowGroup','15060684zUQBiU','literal','defineProperty','disable','../../models/Message','../../models/Contact','whatsapp','number','allTicket','whatsappId','name','admin','active','messages','profile','../../models/ContactTag','like','default','expiresTicket','enabled','__importDefault','companyId','enable','unaccent','intersection','open','contactId','sequelize','true','body','search','false','740277HaQSaE','allUserChat','color','20qWPQHP','LIKE','user','MAX(\x22id\x22)','281901yxeNEI','contact','findAll','map','140006XMBzBx','tags','remove-accents'];a601_0x1642=function(){return _0x850837;};return a601_0x1642();}var __importDefault=this&&this[a601_0x564878(0xb8)]||function(_0x165705){const _0x4cb20f=a601_0x564878;return _0x165705&&_0x165705[_0x4cb20f(0x93)]?_0x165705:{'default':_0x165705};};Object[a601_0x564878(0xa6)](exports,a601_0x564878(0x93),{'value':!![]});function a601_0x2b11(_0x45a923,_0x593603){const _0x164206=a601_0x1642();return a601_0x2b11=function(_0x2b11dd,_0x45b6c0){_0x2b11dd=_0x2b11dd-0x73;let _0x49a72a=_0x164206[_0x2b11dd];return _0x49a72a;},a601_0x2b11(_0x45a923,_0x593603);}const sequelize_1=require(a601_0x564878(0xbf)),Ticket_1=__importDefault(require(a601_0x564878(0x95))),Contact_1=__importDefault(require(a601_0x564878(0xa9))),Message_1=__importDefault(require(a601_0x564878(0xa8))),Queue_1=__importDefault(require(a601_0x564878(0x9c))),User_1=__importDefault(require('../../models/User')),ShowUserService_1=__importDefault(require(a601_0x564878(0x97))),Tag_1=__importDefault(require('../../models/Tag')),lodash_1=require(a601_0x564878(0x8d)),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),ContactTag_1=__importDefault(require(a601_0x564878(0xb3))),remove_accents_1=__importDefault(require(a601_0x564878(0x81))),isQueueIdHistoryBlocked_1=__importDefault(require(a601_0x564878(0x8b))),ListTicketsService=async({searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x145681,tags:_0x310827,users:_0x5a6c05,status:_0x2d9d81,date:_0x5f18c1,dateStart:_0x41e317,dateEnd:_0x4ebcab,updatedAt:_0x5a96bb,showAll:_0x26a5c3,userId:_0x368148,withUnreadMessages:_0x5e610a,whatsappIds:_0x58181c,statusFilters:_0x48b339,companyId:_0x45eafa})=>{const _0x2ae200=a601_0x564878,_0x431fcf=await(0x0,isQueueIdHistoryBlocked_1[_0x2ae200(0xb5)])({'userRequest':_0x368148});let _0x21bcb0;!_0x431fcf?_0x21bcb0={[sequelize_1['Op']['or']]:[{'userId':_0x368148},{'status':'pending'}],'queueId':{[sequelize_1['Op']['or']]:[_0x145681,null]},'companyId':_0x45eafa}:_0x21bcb0={[sequelize_1['Op']['or']]:[{'userId':_0x368148},{'status':_0x2ae200(0x94)}],'companyId':_0x45eafa};let _0x44e7dc;_0x44e7dc=[{'model':Contact_1['default'],'as':_0x2ae200(0x7c),'attributes':['id','name',_0x2ae200(0xab),'email',_0x2ae200(0x82),'acceptAudioMessage',_0x2ae200(0xb0),_0x2ae200(0x88),_0x2ae200(0xb9)],'include':[_0x2ae200(0x9b),_0x2ae200(0xa1)]},{'model':Queue_1['default'],'as':_0x2ae200(0x84),'attributes':['id',_0x2ae200(0xae),_0x2ae200(0x76)]},{'model':User_1['default'],'as':'user','attributes':['id',_0x2ae200(0xae)]},{'model':Tag_1[_0x2ae200(0xb5)],'as':_0x2ae200(0x80),'attributes':['id','name',_0x2ae200(0x76)]},{'model':Whatsapp_1[_0x2ae200(0xb5)],'as':_0x2ae200(0xaa),'attributes':['id',_0x2ae200(0xae),_0x2ae200(0xb6),'groupAsTicket']}];const _0x260a2f=await(0x0,ShowUserService_1[_0x2ae200(0xb5)])(_0x368148,_0x45eafa),_0x1a8653=_0x260a2f['queues'][_0x2ae200(0x7e)](_0x7bd167=>_0x7bd167['id']);_0x2d9d81===_0x2ae200(0xbd)&&(_0x21bcb0={..._0x21bcb0,'userId':_0x368148,'queueId':{[sequelize_1['Op']['in']]:_0x145681}});_0x2d9d81===_0x2ae200(0x8c)&&(_0x260a2f[_0x2ae200(0xa3)]||_0x260a2f['profile']==='admin')&&(_0x21bcb0={'companyId':_0x45eafa,'queueId':{[sequelize_1['Op']['or']]:[_0x145681,null]}});if(_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0x79)&&_0x2d9d81===_0x2ae200(0x94)&&_0x260a2f[_0x2ae200(0xac)]===_0x2ae200(0xba)){const _0x32b945=[];let _0x60850=[];!_0x431fcf?_0x60850=await Ticket_1[_0x2ae200(0xb5)][_0x2ae200(0x7d)]({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x260a2f['id'],null]},'queueId':{[sequelize_1['Op']['or']]:[_0x145681,null]},'status':'pending','companyId':_0x45eafa}}):_0x60850=await Ticket_1['default'][_0x2ae200(0x7d)]({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x260a2f['id'],null]},'status':'pending','companyId':_0x45eafa}});_0x60850&&_0x32b945[_0x2ae200(0x8a)](_0x60850['map'](_0x1f88b8=>_0x1f88b8['id']));const _0x2aa8ae=(0x0,lodash_1['intersection'])(..._0x32b945);_0x21bcb0={..._0x21bcb0,'id':_0x2aa8ae};}if(_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0x79)&&_0x2d9d81==='pending'&&_0x260a2f[_0x2ae200(0xac)]===_0x2ae200(0xa7)){const _0x14a3dd=[];let _0x35c65e=[];!_0x431fcf?_0x35c65e=await Ticket_1[_0x2ae200(0xb5)][_0x2ae200(0x7d)]({'where':{'companyId':_0x45eafa,'userId':{[sequelize_1['Op']['or']]:[_0x260a2f['id'],null]},'status':_0x2ae200(0x94),'queueId':{[sequelize_1['Op']['in']]:_0x145681}}}):_0x35c65e=await Ticket_1[_0x2ae200(0xb5)][_0x2ae200(0x7d)]({'where':{'companyId':_0x45eafa,[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op']['or']]:[_0x260a2f['id'],null]}},{'status':_0x2ae200(0x94)}],'status':'pending'}});_0x35c65e&&_0x14a3dd['push'](_0x35c65e[_0x2ae200(0x7e)](_0x55d15d=>_0x55d15d['id']));const _0x2f9651=(0x0,lodash_1[_0x2ae200(0xbc)])(..._0x14a3dd);_0x21bcb0={..._0x21bcb0,'id':_0x2f9651};}_0x26a5c3==='true'&&(_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0xaf)||_0x260a2f[_0x2ae200(0x75)]==='enabled')&&(_0x260a2f[_0x2ae200(0x99)]===_0x2ae200(0xb7)?_0x21bcb0={}:_0x21bcb0={'queueId':{[sequelize_1['Op']['or']]:[_0x145681,null]}});_0x2d9d81&&_0x2d9d81!==_0x2ae200(0xc2)&&(_0x21bcb0={..._0x21bcb0,'status':_0x2d9d81});if(_0x2d9d81===_0x2ae200(0x91)){let _0x62e019;if(!_0x431fcf){let _0x492f6b={'companyId':_0x45eafa,'status':_0x2ae200(0x91)};_0x26a5c3==='false'&&_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0xaf)?_0x492f6b={..._0x492f6b,'queueId':_0x145681,'userId':_0x368148}:_0x492f6b={..._0x492f6b,'queueId':_0x26a5c3===_0x2ae200(0xc0)||_0x260a2f[_0x2ae200(0xac)]===_0x2ae200(0xba)?{[sequelize_1['Op']['or']]:[_0x145681,null]}:_0x145681},_0x62e019=await Ticket_1[_0x2ae200(0xb5)]['findAll']({'attributes':['companyId',_0x2ae200(0xbe),_0x2ae200(0xad),[(0x0,sequelize_1[_0x2ae200(0xa5)])(_0x2ae200(0x7a)),'id']],'where':_0x492f6b,'group':[_0x2ae200(0xb9),_0x2ae200(0xbe),_0x2ae200(0xad)]});}else{let _0x3dbbfa={'companyId':_0x45eafa,'status':_0x2ae200(0x91)};_0x26a5c3==='false'&&(_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0xaf)||_0x260a2f[_0x2ae200(0x75)]===_0x2ae200(0xb7))?_0x3dbbfa={..._0x3dbbfa,'queueId':_0x145681,'userId':_0x368148}:_0x3dbbfa={..._0x3dbbfa,'queueId':_0x26a5c3==='true'||_0x260a2f[_0x2ae200(0xac)]===_0x2ae200(0xba)?{[sequelize_1['Op']['or']]:[_0x145681,null]}:_0x145681},_0x62e019=await Ticket_1['default'][_0x2ae200(0x7d)]({'attributes':['companyId',_0x2ae200(0xbe),'whatsappId',[(0x0,sequelize_1[_0x2ae200(0xa5)])(_0x2ae200(0x7a)),'id']],'where':_0x3dbbfa,'group':[_0x2ae200(0xb9),_0x2ae200(0xbe),_0x2ae200(0xad)]});}const _0x18edff=_0x62e019[_0x2ae200(0x7e)](_0x158735=>_0x158735['id']);_0x21bcb0={'id':_0x18edff};};if(_0x2d9d81==='search'){_0x21bcb0={'companyId':_0x45eafa};let _0x5e8dc0;if(!_0x431fcf&&_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0x79))_0x5e8dc0=await Ticket_1[_0x2ae200(0xb5)][_0x2ae200(0x7d)]({'attributes':[_0x2ae200(0xb9),_0x2ae200(0xbe),_0x2ae200(0xad),[(0x0,sequelize_1[_0x2ae200(0xa5)])(_0x2ae200(0x7a)),'id']],'where':{[sequelize_1['Op']['or']]:[{'userId':_0x368148},{'status':[_0x2ae200(0x94),_0x2ae200(0x91),_0x2ae200(0x8c)]}],'queueId':_0x26a5c3===_0x2ae200(0xc0)||_0x260a2f[_0x2ae200(0xac)]===_0x2ae200(0xba)?{[sequelize_1['Op']['or']]:[_0x145681,null]}:_0x145681,'companyId':_0x45eafa},'group':['companyId','contactId','whatsappId']});else{let _0x265b74={'companyId':_0x45eafa,[sequelize_1['Op']['or']]:[{'userId':_0x368148},{'status':['pending',_0x2ae200(0x91),'group']}]};if(_0x26a5c3===_0x2ae200(0x73)&&_0x260a2f[_0x2ae200(0xb2)]==='admin')_0x265b74={..._0x265b74,'queueId':_0x145681};else _0x26a5c3===_0x2ae200(0xc0)&&_0x260a2f[_0x2ae200(0xb2)]===_0x2ae200(0xaf)&&(_0x265b74={'companyId':_0x45eafa,'queueId':{[sequelize_1['Op']['or']]:[_0x145681,null]}});_0x5e8dc0=await Ticket_1[_0x2ae200(0xb5)][_0x2ae200(0x7d)]({'attributes':[_0x2ae200(0xb9),_0x2ae200(0xbe),'whatsappId',[(0x0,sequelize_1[_0x2ae200(0xa5)])(_0x2ae200(0x7a)),'id']],'where':_0x265b74,'group':[_0x2ae200(0xb9),_0x2ae200(0xbe),_0x2ae200(0xad)]});}const _0x400a9c=_0x5e8dc0[_0x2ae200(0x7e)](_0x3c46d7=>_0x3c46d7['id']);_0x21bcb0={..._0x21bcb0,'id':{[sequelize_1['Op']['in']]:_0x400a9c}};if(searchParam){const _0x3440f0=(0x0,remove_accents_1['default'])(searchParam[_0x2ae200(0x9e)]()[_0x2ae200(0x89)]());_0x44e7dc=[..._0x44e7dc,{'model':Message_1[_0x2ae200(0xb5)],'as':_0x2ae200(0xb1),'attributes':['id',_0x2ae200(0xc1)],'where':{'body':(0x0,sequelize_1[_0x2ae200(0x92)])((0x0,sequelize_1['fn'])('LOWER',(0x0,sequelize_1['fn'])(_0x2ae200(0xbb),(0x0,sequelize_1['col'])(_0x2ae200(0xc1)))),_0x2ae200(0x78),'%'+_0x3440f0+'%')},'required':![],'duplicating':![]}],_0x21bcb0={..._0x21bcb0,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x2ae200(0x92)])((0x0,sequelize_1['fn'])(_0x2ae200(0xa0),(0x0,sequelize_1['fn'])(_0x2ae200(0xbb),(0x0,sequelize_1['col'])('contact.name'))),_0x2ae200(0x78),'%'+_0x3440f0+'%')},{'$contact.number$':{[sequelize_1['Op'][_0x2ae200(0xb4)]]:'%'+_0x3440f0+'%'}},{'$message.body$':(0x0,sequelize_1[_0x2ae200(0x92)])((0x0,sequelize_1['fn'])(_0x2ae200(0xa0),(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1[_0x2ae200(0x9a)])(_0x2ae200(0xc1)))),'LIKE','%'+_0x3440f0+'%')}]};}if(Array[_0x2ae200(0x96)](_0x310827)&&_0x310827[_0x2ae200(0x86)]>0x0){const _0x395bc6=[],_0x3730dc=await ContactTag_1[_0x2ae200(0xb5)][_0x2ae200(0x7d)]({'where':{'tagId':{[sequelize_1['Op']['in']]:_0x310827}}});_0x3730dc&&_0x395bc6['push'](_0x3730dc['map'](_0xad800d=>_0xad800d[_0x2ae200(0xbe)]));const _0x4ae876=(0x0,lodash_1['intersection'])(..._0x395bc6);_0x21bcb0={..._0x21bcb0,'contactId':{[sequelize_1['Op']['in']]:_0x4ae876}};}Array[_0x2ae200(0x96)](_0x5a6c05)&&_0x5a6c05['length']>0x0&&(_0x21bcb0={..._0x21bcb0,'userId':{[sequelize_1['Op']['in']]:_0x5a6c05}}),Array[_0x2ae200(0x96)](_0x58181c)&&_0x58181c['length']>0x0&&(_0x21bcb0={..._0x21bcb0,'whatsappId':{[sequelize_1['Op']['in']]:_0x58181c}}),Array[_0x2ae200(0x96)](_0x48b339)&&_0x48b339['length']>0x0&&(_0x21bcb0={..._0x21bcb0,'status':{[sequelize_1['Op']['in']]:_0x48b339}});}_0x5e610a==='true'&&(_0x21bcb0={[sequelize_1['Op']['or']]:[{'userId':_0x368148,'status':{[sequelize_1['Op']['notIn']]:[_0x2ae200(0x91),_0x2ae200(0xa2),'nps']},'queueId':{[sequelize_1['Op']['in']]:_0x1a8653},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0x45eafa},{'status':{[sequelize_1['Op']['in']]:[_0x2ae200(0x94),_0x2ae200(0x8c)]},'queueId':{[sequelize_1['Op']['or']]:[_0x1a8653,null]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0x45eafa}]},_0x2d9d81===_0x2ae200(0x8c)&&(_0x260a2f[_0x2ae200(0xa3)]||_0x26a5c3===_0x2ae200(0xc0))&&(_0x21bcb0={..._0x21bcb0,'queueId':{[sequelize_1['Op']['or']]:[_0x1a8653,null]}}));_0x21bcb0={..._0x21bcb0,'companyId':_0x45eafa};const _0x1a062e=0x28,_0x4738f7=_0x1a062e*(+pageNumber-0x1),{count:_0x316437,rows:_0xdc1214}=await Ticket_1['default'][_0x2ae200(0x8f)]({'where':_0x21bcb0,'include':_0x44e7dc,'distinct':!![],'limit':_0x1a062e,'offset':_0x4738f7,'order':[['updatedAt',_0x2ae200(0x98)]],'subQuery':![]}),_0xca9faf=_0x316437>_0x4738f7+_0xdc1214['length'];return{'tickets':_0xdc1214,'count':_0x316437,'hasMore':_0xca9faf};};exports['default']=ListTicketsService;