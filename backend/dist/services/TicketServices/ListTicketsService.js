'use strict';const a594_0x161ee3=a594_0x31e8;(function(_0x400308,_0x55bf98){const _0x5a1f9a=a594_0x31e8,_0xd15247=_0x400308();while(!![]){try{const _0x2d3d85=parseInt(_0x5a1f9a(0x192))/0x1+-parseInt(_0x5a1f9a(0x198))/0x2*(parseInt(_0x5a1f9a(0x185))/0x3)+parseInt(_0x5a1f9a(0x1c7))/0x4*(-parseInt(_0x5a1f9a(0x1a1))/0x5)+-parseInt(_0x5a1f9a(0x1ad))/0x6+parseInt(_0x5a1f9a(0x1c1))/0x7*(parseInt(_0x5a1f9a(0x1a3))/0x8)+parseInt(_0x5a1f9a(0x1c3))/0x9*(parseInt(_0x5a1f9a(0x1b3))/0xa)+parseInt(_0x5a1f9a(0x1b8))/0xb;if(_0x2d3d85===_0x55bf98)break;else _0xd15247['push'](_0xd15247['shift']());}catch(_0x4ed733){_0xd15247['push'](_0xd15247['shift']());}}}(a594_0x2b12,0x1f989));var __importDefault=this&&this[a594_0x161ee3(0x18f)]||function(_0x564cca){const _0x4e80dc=a594_0x161ee3;return _0x564cca&&_0x564cca[_0x4e80dc(0x1c0)]?_0x564cca:{'default':_0x564cca};};function a594_0x31e8(_0xb3d20,_0xcfc092){const _0x2b12f1=a594_0x2b12();return a594_0x31e8=function(_0x31e88f,_0x3aade5){_0x31e88f=_0x31e88f-0x17a;let _0x27384a=_0x2b12f1[_0x31e88f];return _0x27384a;},a594_0x31e8(_0xb3d20,_0xcfc092);}Object[a594_0x161ee3(0x199)](exports,a594_0x161ee3(0x1c0),{'value':!![]});const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require(a594_0x161ee3(0x197))),Contact_1=__importDefault(require(a594_0x161ee3(0x1a6))),Message_1=__importDefault(require(a594_0x161ee3(0x1b5))),Queue_1=__importDefault(require(a594_0x161ee3(0x19e))),User_1=__importDefault(require(a594_0x161ee3(0x1a2))),ShowUserService_1=__importDefault(require(a594_0x161ee3(0x1bd))),Tag_1=__importDefault(require(a594_0x161ee3(0x1b4))),lodash_1=require(a594_0x161ee3(0x17a)),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),ContactTag_1=__importDefault(require(a594_0x161ee3(0x19c))),remove_accents_1=__importDefault(require('remove-accents')),isQueueIdHistoryBlocked_1=__importDefault(require('../UserServices/isQueueIdHistoryBlocked')),ListTicketsService=async({searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x27d970,tags:_0x599b7f,users:_0x78ed7b,status:_0x49eba9,date:_0x5af7db,dateStart:_0x16e27a,dateEnd:_0x2de6b0,updatedAt:_0x53c333,showAll:_0xf5233b,userId:_0x421146,withUnreadMessages:_0x389fdb,whatsappIds:_0x1ee834,statusFilters:_0x3d6626,companyId:_0x5910ef})=>{const _0x4522ca=a594_0x161ee3,_0x1e2529=await(0x0,isQueueIdHistoryBlocked_1[_0x4522ca(0x18e)])({'userRequest':_0x421146});let _0x5f22f4;!_0x1e2529?_0x5f22f4={[sequelize_1['Op']['or']]:[{'userId':_0x421146},{'status':_0x4522ca(0x1ab)}],'queueId':{[sequelize_1['Op']['or']]:[_0x27d970,null]},'companyId':_0x5910ef}:_0x5f22f4={[sequelize_1['Op']['or']]:[{'userId':_0x421146},{'status':_0x4522ca(0x1ab)}],'companyId':_0x5910ef};let _0x341655;_0x341655=[{'model':Contact_1['default'],'as':'contact','attributes':['id','name',_0x4522ca(0x1b9),'email',_0x4522ca(0x1a9),_0x4522ca(0x1c6),_0x4522ca(0x18b),_0x4522ca(0x1b1),_0x4522ca(0x1ba)],'include':[_0x4522ca(0x1af),_0x4522ca(0x1a5)]},{'model':Queue_1['default'],'as':_0x4522ca(0x1be),'attributes':['id','name',_0x4522ca(0x194)]},{'model':User_1[_0x4522ca(0x18e)],'as':'user','attributes':['id','name']},{'model':Tag_1[_0x4522ca(0x18e)],'as':_0x4522ca(0x1a8),'attributes':['id',_0x4522ca(0x19b),'color']},{'model':Whatsapp_1[_0x4522ca(0x18e)],'as':_0x4522ca(0x1a0),'attributes':['id','name',_0x4522ca(0x1b6),_0x4522ca(0x190)]}];const _0x3976eb=await(0x0,ShowUserService_1[_0x4522ca(0x18e)])(_0x421146,_0x5910ef),_0x21649f=_0x3976eb[_0x4522ca(0x17c)]['map'](_0x1c26e8=>_0x1c26e8['id']);_0x49eba9===_0x4522ca(0x1a4)&&(_0x5f22f4={..._0x5f22f4,'userId':_0x421146,'queueId':{[sequelize_1['Op']['in']]:_0x27d970}});_0x49eba9==='group'&&(_0x3976eb['allowGroup']||_0xf5233b===_0x4522ca(0x1c5))&&(_0x5f22f4={..._0x5f22f4,'queueId':{[sequelize_1['Op']['or']]:[_0x27d970,null]}});if(_0x3976eb['profile']===_0x4522ca(0x17e)&&_0x49eba9==='pending'&&_0x3976eb[_0x4522ca(0x1ac)]===_0x4522ca(0x18c)){const _0x464582=[];let _0x1562fa=[];!_0x1e2529?_0x1562fa=await Ticket_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x3976eb['id'],null]},'queueId':{[sequelize_1['Op']['or']]:[_0x27d970,null]},'status':'pending','companyId':_0x5910ef}}):_0x1562fa=await Ticket_1[_0x4522ca(0x18e)]['findAll']({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x3976eb['id'],null]},'status':'pending','companyId':_0x5910ef}});_0x1562fa&&_0x464582['push'](_0x1562fa[_0x4522ca(0x1ae)](_0x17ef00=>_0x17ef00['id']));const _0x2ae2c7=(0x0,lodash_1['intersection'])(..._0x464582);_0x5f22f4={..._0x5f22f4,'id':_0x2ae2c7};}if(_0x3976eb[_0x4522ca(0x182)]==='user'&&_0x49eba9==='pending'&&_0x3976eb['allTicket']===_0x4522ca(0x1bc)){const _0x463531=[];let _0x4c25d8=[];!_0x1e2529?_0x4c25d8=await Ticket_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'where':{'companyId':_0x5910ef,'userId':{[sequelize_1['Op']['or']]:[_0x3976eb['id'],null]},'status':_0x4522ca(0x1ab),'queueId':{[sequelize_1['Op']['in']]:_0x27d970}}}):_0x4c25d8=await Ticket_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'where':{'companyId':_0x5910ef,[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op']['or']]:[_0x3976eb['id'],null]}},{'status':_0x4522ca(0x1ab)}],'status':_0x4522ca(0x1ab)}});_0x4c25d8&&_0x463531[_0x4522ca(0x19f)](_0x4c25d8[_0x4522ca(0x1ae)](_0x436217=>_0x436217['id']));const _0x5430af=(0x0,lodash_1[_0x4522ca(0x17b)])(..._0x463531);_0x5f22f4={..._0x5f22f4,'id':_0x5430af};}_0xf5233b==='true'&&(_0x3976eb[_0x4522ca(0x182)]===_0x4522ca(0x188)||_0x3976eb[_0x4522ca(0x196)]==='enabled')&&(_0x3976eb['allHistoric']===_0x4522ca(0x180)?_0x5f22f4={}:_0x5f22f4={'queueId':{[sequelize_1['Op']['or']]:[_0x27d970,null]}});_0x49eba9&&_0x49eba9!==_0x4522ca(0x191)&&(_0x5f22f4={..._0x5f22f4,'status':_0x49eba9});if(_0x49eba9===_0x4522ca(0x189)){let _0x3cc3f3;if(!_0x1e2529){let _0x289f1b={'companyId':_0x5910ef,'status':_0x4522ca(0x189)};_0xf5233b===_0x4522ca(0x1b2)&&_0x3976eb[_0x4522ca(0x182)]===_0x4522ca(0x188)?_0x289f1b={..._0x289f1b,'queueId':_0x27d970,'userId':_0x421146}:_0x289f1b={..._0x289f1b,'queueId':_0xf5233b==='true'||_0x3976eb['allTicket']===_0x4522ca(0x18c)?{[sequelize_1['Op']['or']]:[_0x27d970,null]}:_0x27d970},_0x3cc3f3=await Ticket_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'attributes':['companyId',_0x4522ca(0x18d),_0x4522ca(0x1b7),[(0x0,sequelize_1[_0x4522ca(0x1c2)])('MAX(\x22id\x22)'),'id']],'where':_0x289f1b,'group':[_0x4522ca(0x1ba),'contactId',_0x4522ca(0x1b7)]});}else{let _0x3f2aaa={'companyId':_0x5910ef,'status':_0x4522ca(0x189)};_0xf5233b===_0x4522ca(0x1b2)&&(_0x3976eb[_0x4522ca(0x182)]===_0x4522ca(0x188)||_0x3976eb[_0x4522ca(0x196)]===_0x4522ca(0x180))&&(_0x3f2aaa={..._0x3f2aaa,'queueId':_0x27d970,'userId':_0x421146}),_0x3cc3f3=await Ticket_1['default'][_0x4522ca(0x1bb)]({'attributes':[_0x4522ca(0x1ba),_0x4522ca(0x18d),_0x4522ca(0x1b7),[(0x0,sequelize_1[_0x4522ca(0x1c2)])(_0x4522ca(0x1c4)),'id']],'where':_0x3f2aaa,'group':['companyId',_0x4522ca(0x18d),'whatsappId']});}const _0x1e6a77=_0x3cc3f3[_0x4522ca(0x1ae)](_0x50d666=>_0x50d666['id']);_0x5f22f4={'id':_0x1e6a77};};if(_0x49eba9===_0x4522ca(0x191)){_0x5f22f4={'companyId':_0x5910ef};let _0x5b6ca2;if(!_0x1e2529&&_0x3976eb[_0x4522ca(0x182)]==='user')_0x5b6ca2=await Ticket_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'attributes':[_0x4522ca(0x1ba),'contactId',_0x4522ca(0x1b7),[(0x0,sequelize_1['literal'])(_0x4522ca(0x1c4)),'id']],'where':{[sequelize_1['Op']['or']]:[{'userId':_0x421146},{'status':[_0x4522ca(0x1ab),_0x4522ca(0x189)]}],'queueId':_0xf5233b==='true'||_0x3976eb[_0x4522ca(0x1ac)]===_0x4522ca(0x18c)?{[sequelize_1['Op']['or']]:[_0x27d970,null]}:_0x27d970,'companyId':_0x5910ef},'group':['companyId',_0x4522ca(0x18d),'whatsappId']});else{let _0x5319e7={'companyId':_0x5910ef,[sequelize_1['Op']['or']]:[{'userId':_0x421146},{'status':['pending',_0x4522ca(0x189)]}]};if(_0xf5233b===_0x4522ca(0x1b2)&&_0x3976eb['profile']==='admin')_0x5319e7={..._0x5319e7,'queueId':_0x27d970};else _0xf5233b===_0x4522ca(0x1c5)&&_0x3976eb[_0x4522ca(0x182)]==='admin'&&(_0x5319e7={'companyId':_0x5910ef,'queueId':_0x27d970});_0x5b6ca2=await Ticket_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'attributes':[_0x4522ca(0x1ba),_0x4522ca(0x18d),'whatsappId',[(0x0,sequelize_1[_0x4522ca(0x1c2)])('MAX(\x22id\x22)'),'id']],'where':_0x5319e7,'group':['companyId',_0x4522ca(0x18d),_0x4522ca(0x1b7)]});}const _0x33c2d7=_0x5b6ca2[_0x4522ca(0x1ae)](_0x30d02f=>_0x30d02f['id']);_0x5f22f4={..._0x5f22f4,'id':{[sequelize_1['Op']['in']]:_0x33c2d7}};if(searchParam){const _0x3d634e=(0x0,remove_accents_1[_0x4522ca(0x18e)])(searchParam['toLocaleLowerCase']()[_0x4522ca(0x1aa)]());_0x341655=[..._0x341655,{'model':Message_1[_0x4522ca(0x18e)],'as':'messages','attributes':['id',_0x4522ca(0x195)],'where':{'body':(0x0,sequelize_1[_0x4522ca(0x193)])((0x0,sequelize_1['fn'])(_0x4522ca(0x19d),(0x0,sequelize_1['fn'])(_0x4522ca(0x19a),(0x0,sequelize_1[_0x4522ca(0x186)])('body'))),'LIKE','%'+_0x3d634e+'%')},'required':![],'duplicating':![]}],_0x5f22f4={..._0x5f22f4,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x4522ca(0x193)])((0x0,sequelize_1['fn'])('LOWER',(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1[_0x4522ca(0x186)])(_0x4522ca(0x181)))),'LIKE','%'+_0x3d634e+'%')},{'$contact.number$':{[sequelize_1['Op'][_0x4522ca(0x187)]]:'%'+_0x3d634e+'%'}},{'$message.body$':(0x0,sequelize_1[_0x4522ca(0x193)])((0x0,sequelize_1['fn'])(_0x4522ca(0x19d),(0x0,sequelize_1['fn'])(_0x4522ca(0x19a),(0x0,sequelize_1[_0x4522ca(0x186)])(_0x4522ca(0x195)))),'LIKE','%'+_0x3d634e+'%')}]};}if(Array[_0x4522ca(0x18a)](_0x599b7f)&&_0x599b7f[_0x4522ca(0x184)]>0x0){const _0xefd99e=[],_0x1fd8ab=await ContactTag_1[_0x4522ca(0x18e)][_0x4522ca(0x1bb)]({'where':{'tagId':{[sequelize_1['Op']['in']]:_0x599b7f}}});_0x1fd8ab&&_0xefd99e[_0x4522ca(0x19f)](_0x1fd8ab[_0x4522ca(0x1ae)](_0x4ea5d6=>_0x4ea5d6[_0x4522ca(0x18d)]));const _0x323413=(0x0,lodash_1[_0x4522ca(0x17b)])(..._0xefd99e);_0x5f22f4={..._0x5f22f4,'contactId':{[sequelize_1['Op']['in']]:_0x323413}};}Array[_0x4522ca(0x18a)](_0x78ed7b)&&_0x78ed7b[_0x4522ca(0x184)]>0x0&&(_0x5f22f4={..._0x5f22f4,'userId':{[sequelize_1['Op']['in']]:_0x78ed7b}}),Array[_0x4522ca(0x18a)](_0x1ee834)&&_0x1ee834['length']>0x0&&(_0x5f22f4={..._0x5f22f4,'whatsappId':{[sequelize_1['Op']['in']]:_0x1ee834}}),Array[_0x4522ca(0x18a)](_0x3d6626)&&_0x3d6626[_0x4522ca(0x184)]>0x0&&(_0x5f22f4={..._0x5f22f4,'status':{[sequelize_1['Op']['in']]:_0x3d6626}});}_0x389fdb==='true'&&(_0x5f22f4={[sequelize_1['Op']['or']]:[{'userId':_0x421146,'status':{[sequelize_1['Op']['notIn']]:[_0x4522ca(0x189),_0x4522ca(0x17f),_0x4522ca(0x17d)]},'queueId':{[sequelize_1['Op']['in']]:_0x21649f},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0x5910ef},{'status':{[sequelize_1['Op']['in']]:[_0x4522ca(0x1ab),'group']},'queueId':{[sequelize_1['Op']['or']]:[_0x21649f,null]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0x5910ef}]},_0x49eba9===_0x4522ca(0x1a7)&&(_0x3976eb[_0x4522ca(0x1bf)]||_0xf5233b==='true')&&(_0x5f22f4={..._0x5f22f4,'queueId':{[sequelize_1['Op']['or']]:[_0x21649f,null]}}));_0x5f22f4={..._0x5f22f4,'companyId':_0x5910ef};const _0x555731=0x28,_0x22ee74=_0x555731*(+pageNumber-0x1),{count:_0x495ef7,rows:_0x4cbd2b}=await Ticket_1['default'][_0x4522ca(0x183)]({'where':_0x5f22f4,'include':_0x341655,'distinct':!![],'limit':_0x555731,'offset':_0x22ee74,'order':[[_0x4522ca(0x1b0),'DESC']],'subQuery':![]}),_0x542448=_0x495ef7>_0x22ee74+_0x4cbd2b[_0x4522ca(0x184)];return{'tickets':_0x4cbd2b,'count':_0x495ef7,'hasMore':_0x542448};};exports[a594_0x161ee3(0x18e)]=ListTicketsService;function a594_0x2b12(){const _0x58a7b2=['companyId','findAll','disable','../UserServices/ShowUserService','queue','allowGroup','__esModule','3262fjDNCu','literal','9DBACdp','MAX(\x22id\x22)','true','acceptAudioMessage','4TSeNrP','lodash','intersection','queues','nps','user','lgpd','enabled','contact.name','profile','findAndCountAll','length','359838gsIift','col','like','admin','closed','isArray','active','enable','contactId','default','__importDefault','groupAsTicket','search','236463QppHds','where','color','body','allUserChat','../../models/Ticket','4GVqrzY','defineProperty','unaccent','name','../../models/ContactTag','LOWER','../../models/Queue','push','whatsapp','1063745lsHyfC','../../models/User','688VxHbyW','open','contactTags','../../models/Contact','group','tags','profilePicUrl','trim','pending','allTicket','745548oKBITA','map','extraInfo','updatedAt','urlPicture','false','599020Zvrkoc','../../models/Tag','../../models/Message','expiresTicket','whatsappId','4068625dqNOfo','number'];a594_0x2b12=function(){return _0x58a7b2;};return a594_0x2b12();}