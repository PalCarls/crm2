'use strict';const a537_0x289c8e=a537_0x3784;function a537_0x1ed1(){const _0x2e6a74=['LIKE','tags','trim','sequelize','1271881ZlpMXY','allTicket','LOWER','954osepRL','../../models/Queue','enable','col','2672DzNmqD','push','email','messages','contact','../../models/User','remove-accents','../../models/Whatsapp','14128JGjMUD','open','1329fJUKLv','../../models/Tag','name','325070BOfGru','urlPicture','../../models/Ticket','where','DESC','../UserServices/ShowUserService','419815pjuKAP','4698ykZBdC','user','2889LURYax','default','acceptAudioMessage','1599367gKUnJx','active','../../models/Message','176MFmabb','companyId','contactId','max','lodash','expiresTicket','queue','pending','map','number','allowGroup','disable','444iorQpM','extraInfo','defineProperty','intersection','length','contact.name','isArray','__esModule','body','6BYBqAx','profile','findAll','updatedAt','unaccent','closed','like','search','true','admin','profilePicUrl'];a537_0x1ed1=function(){return _0x2e6a74;};return a537_0x1ed1();}function a537_0x3784(_0x5c1ef0,_0x5cb78f){const _0x1ed199=a537_0x1ed1();return a537_0x3784=function(_0x378480,_0x11d21){_0x378480=_0x378480-0x1a4;let _0x14fa0a=_0x1ed199[_0x378480];return _0x14fa0a;},a537_0x3784(_0x5c1ef0,_0x5cb78f);}(function(_0x560283,_0x4dac4a){const _0x55fda5=a537_0x3784,_0x4aa762=_0x560283();while(!![]){try{const _0x491366=-parseInt(_0x55fda5(0x1e2))/0x1*(parseInt(_0x55fda5(0x1c8))/0x2)+parseInt(_0x55fda5(0x1d6))/0x3*(-parseInt(_0x55fda5(0x1d4))/0x4)+parseInt(_0x55fda5(0x1df))/0x5+parseInt(_0x55fda5(0x1b6))/0x6*(-parseInt(_0x55fda5(0x1e5))/0x7)+parseInt(_0x55fda5(0x1cc))/0x8*(-parseInt(_0x55fda5(0x1e0))/0x9)+-parseInt(_0x55fda5(0x1d9))/0xa*(-parseInt(_0x55fda5(0x1e8))/0xb)+-parseInt(_0x55fda5(0x1ad))/0xc*(-parseInt(_0x55fda5(0x1c5))/0xd);if(_0x491366===_0x4dac4a)break;else _0x4aa762['push'](_0x4aa762['shift']());}catch(_0x41427b){_0x4aa762['push'](_0x4aa762['shift']());}}}(a537_0x1ed1,0xd6796));var __importDefault=this&&this['__importDefault']||function(_0x327ab5){const _0xb2e4d=a537_0x3784;return _0x327ab5&&_0x327ab5[_0xb2e4d(0x1b4)]?_0x327ab5:{'default':_0x327ab5};};Object[a537_0x289c8e(0x1af)](exports,a537_0x289c8e(0x1b4),{'value':!![]});const sequelize_1=require(a537_0x289c8e(0x1c4)),Ticket_1=__importDefault(require(a537_0x289c8e(0x1db))),Contact_1=__importDefault(require('../../models/Contact')),Message_1=__importDefault(require(a537_0x289c8e(0x1e7))),Queue_1=__importDefault(require(a537_0x289c8e(0x1c9))),User_1=__importDefault(require(a537_0x289c8e(0x1d1))),ShowUserService_1=__importDefault(require(a537_0x289c8e(0x1de))),Tag_1=__importDefault(require(a537_0x289c8e(0x1d7))),lodash_1=require(a537_0x289c8e(0x1a5)),Whatsapp_1=__importDefault(require(a537_0x289c8e(0x1d3))),ContactTag_1=__importDefault(require('../../models/ContactTag')),remove_accents_1=__importDefault(require(a537_0x289c8e(0x1d2))),ListTicketsService=async({searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x3b5f7e,tags:_0xd4463c,users:_0x38a872,status:_0x2a7d1b,date:_0x43f331,dateStart:_0x58446b,dateEnd:_0x4f7038,updatedAt:_0x3fa9ab,showAll:_0x6c7511,userId:_0x1292df,withUnreadMessages:_0x107d2a,whatsappIds:_0xc08cb2,statusFilters:_0x25b269,companyId:_0xf67171})=>{const _0x1b0ccb=a537_0x289c8e;let _0x50d48e={'status':'pending'},_0x4a2cdf;_0x4a2cdf=[{'model':Contact_1[_0x1b0ccb(0x1e3)],'as':_0x1b0ccb(0x1d0),'attributes':['id',_0x1b0ccb(0x1d8),_0x1b0ccb(0x1aa),_0x1b0ccb(0x1ce),_0x1b0ccb(0x1c0),_0x1b0ccb(0x1e4),_0x1b0ccb(0x1e6),_0x1b0ccb(0x1da),_0x1b0ccb(0x1e9)],'include':[_0x1b0ccb(0x1ae),'contactTags',_0x1b0ccb(0x1c2)]},{'model':Queue_1['default'],'as':_0x1b0ccb(0x1a7),'attributes':['id',_0x1b0ccb(0x1d8),'color']},{'model':User_1['default'],'as':_0x1b0ccb(0x1e1),'attributes':['id','name']},{'model':Tag_1[_0x1b0ccb(0x1e3)],'as':'tags','attributes':['id',_0x1b0ccb(0x1d8),'color']},{'model':Whatsapp_1[_0x1b0ccb(0x1e3)],'as':'whatsapp','attributes':['id',_0x1b0ccb(0x1d8),_0x1b0ccb(0x1a6)]}];const _0x44af7d=await(0x0,ShowUserService_1['default'])(_0x1292df);_0x2a7d1b===_0x1b0ccb(0x1d5)&&(_0x50d48e={..._0x50d48e,'userId':_0x1292df,'queueId':{[sequelize_1['Op']['in']]:_0x3b5f7e}});_0x2a7d1b==='group'&&(_0x44af7d[_0x1b0ccb(0x1ab)]||_0x6c7511===_0x1b0ccb(0x1be))&&(_0x50d48e={..._0x50d48e,'queueId':{[sequelize_1['Op']['or']]:[_0x3b5f7e,null]}});if(_0x44af7d[_0x1b0ccb(0x1b7)]===_0x1b0ccb(0x1e1)&&_0x2a7d1b==='pending'&&_0x44af7d[_0x1b0ccb(0x1c6)]===_0x1b0ccb(0x1ca)){const _0x5ef25f=[],_0x45c822=await Ticket_1['default']['findAll']({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x44af7d['id'],null]},'queueId':{[sequelize_1['Op']['or']]:[_0x3b5f7e,null]},'status':_0x1b0ccb(0x1a8)}});_0x45c822&&_0x5ef25f[_0x1b0ccb(0x1cd)](_0x45c822[_0x1b0ccb(0x1a9)](_0xfb8248=>_0xfb8248['id']));const _0x371ee5=(0x0,lodash_1[_0x1b0ccb(0x1b0)])(..._0x5ef25f);_0x50d48e={..._0x50d48e,'id':{[sequelize_1['Op']['in']]:_0x371ee5}};}if(_0x44af7d[_0x1b0ccb(0x1b7)]===_0x1b0ccb(0x1e1)&&_0x2a7d1b===_0x1b0ccb(0x1a8)&&_0x44af7d[_0x1b0ccb(0x1c6)]===_0x1b0ccb(0x1ac)){const _0x29ebe6=[],_0xc9a741=await Ticket_1[_0x1b0ccb(0x1e3)][_0x1b0ccb(0x1b8)]({'where':{[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op']['or']]:[_0x44af7d['id'],null]}},{'status':{[sequelize_1['Op']['or']]:['pending','closed']}}],'queueId':{[sequelize_1['Op']['in']]:_0x3b5f7e},'status':'pending'}});_0xc9a741&&_0x29ebe6[_0x1b0ccb(0x1cd)](_0xc9a741[_0x1b0ccb(0x1a9)](_0x2af1d0=>_0x2af1d0['id']));const _0x1564aa=(0x0,lodash_1[_0x1b0ccb(0x1b0)])(..._0x29ebe6);_0x50d48e={..._0x50d48e,'id':{[sequelize_1['Op']['in']]:_0x1564aa}};}_0x6c7511===_0x1b0ccb(0x1be)&&_0x44af7d['profile']===_0x1b0ccb(0x1bf)&&(_0x50d48e={'queueId':{[sequelize_1['Op']['or']]:[_0x3b5f7e,null]}});_0x2a7d1b&&_0x2a7d1b!==_0x1b0ccb(0x1bd)&&(_0x50d48e={..._0x50d48e,'status':_0x2a7d1b});if(_0x2a7d1b===_0x1b0ccb(0x1bb)){const _0x213dff=[],_0x377ee3=await Ticket_1['default'][_0x1b0ccb(0x1b8)]({'where':{'queueId':_0x6c7511===_0x1b0ccb(0x1be)||_0x44af7d['allTicket']==='enable'?{[sequelize_1['Op']['or']]:[_0x3b5f7e,null]}:_0x3b5f7e,'status':_0x1b0ccb(0x1bb)},'group':[_0x1b0ccb(0x1e9),_0x1b0ccb(0x1ea),'whatsappId'],'attributes':[_0x1b0ccb(0x1e9),_0x1b0ccb(0x1ea),'whatsappId',[(0x0,sequelize_1['fn'])(_0x1b0ccb(0x1a4),(0x0,sequelize_1[_0x1b0ccb(0x1cb)])('id')),'id']]});_0x377ee3&&_0x213dff[_0x1b0ccb(0x1cd)](_0x377ee3['map'](_0x2c2a96=>_0x2c2a96['id']));const _0x34256d=(0x0,lodash_1[_0x1b0ccb(0x1b0)])(..._0x213dff);_0x50d48e={..._0x50d48e,'id':{[sequelize_1['Op']['in']]:_0x34256d}};}if(_0x2a7d1b===_0x1b0ccb(0x1bd)){_0x50d48e={'companyId':_0xf67171};_0x44af7d[_0x1b0ccb(0x1b7)]===_0x1b0ccb(0x1e1)&&(_0x50d48e={..._0x50d48e,'queueId':{[sequelize_1['Op']['in']]:_0x3b5f7e}});_0x107d2a===_0x1b0ccb(0x1be)&&(_0x50d48e={..._0x50d48e,[sequelize_1['Op']['or']]:[{'userId':_0x1292df},{'status':'pending'}],'queueId':{[sequelize_1['Op']['or']]:[_0x3b5f7e,null]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0}});if(searchParam){const _0x1f4632=(0x0,remove_accents_1[_0x1b0ccb(0x1e3)])(searchParam['toLocaleLowerCase']()[_0x1b0ccb(0x1c3)]());_0x4a2cdf=[..._0x4a2cdf,{'model':Message_1['default'],'as':_0x1b0ccb(0x1cf),'attributes':['id','body'],'where':{'body':(0x0,sequelize_1[_0x1b0ccb(0x1dc)])((0x0,sequelize_1['fn'])(_0x1b0ccb(0x1c7),(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1[_0x1b0ccb(0x1cb)])('body'))),'LIKE','%'+_0x1f4632+'%')},'required':![],'duplicating':![]}],_0x50d48e={..._0x50d48e,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x1b0ccb(0x1dc)])((0x0,sequelize_1['fn'])(_0x1b0ccb(0x1c7),(0x0,sequelize_1['fn'])(_0x1b0ccb(0x1ba),(0x0,sequelize_1['col'])(_0x1b0ccb(0x1b2)))),_0x1b0ccb(0x1c1),'%'+_0x1f4632+'%')},{'$contact.number$':{[sequelize_1['Op'][_0x1b0ccb(0x1bc)]]:'%'+_0x1f4632+'%'}},{'$message.body$':(0x0,sequelize_1[_0x1b0ccb(0x1dc)])((0x0,sequelize_1['fn'])(_0x1b0ccb(0x1c7),(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1['col'])(_0x1b0ccb(0x1b5)))),'LIKE','%'+_0x1f4632+'%')}]};}if(Array[_0x1b0ccb(0x1b3)](_0xd4463c)&&_0xd4463c[_0x1b0ccb(0x1b1)]>0x0){const _0x57c5f7=[],_0xc48420=await ContactTag_1[_0x1b0ccb(0x1e3)][_0x1b0ccb(0x1b8)]({'where':{'tagId':{[sequelize_1['Op']['in']]:_0xd4463c}}});_0xc48420&&_0x57c5f7[_0x1b0ccb(0x1cd)](_0xc48420[_0x1b0ccb(0x1a9)](_0x20dcad=>_0x20dcad[_0x1b0ccb(0x1ea)]));const _0x53cc7c=(0x0,lodash_1[_0x1b0ccb(0x1b0)])(..._0x57c5f7);_0x50d48e={..._0x50d48e,'contactId':{[sequelize_1['Op']['in']]:_0x53cc7c}};}Array[_0x1b0ccb(0x1b3)](_0x38a872)&&_0x38a872['length']>0x0&&(_0x50d48e={..._0x50d48e,'userId':{[sequelize_1['Op']['in']]:_0x38a872}}),Array[_0x1b0ccb(0x1b3)](_0xc08cb2)&&_0xc08cb2['length']>0x0&&(_0x50d48e={..._0x50d48e,'whatsappId':{[sequelize_1['Op']['in']]:_0xc08cb2}}),Array[_0x1b0ccb(0x1b3)](_0x25b269)&&_0x25b269[_0x1b0ccb(0x1b1)]>0x0&&(_0x50d48e={..._0x50d48e,'status':{[sequelize_1['Op']['in']]:_0x25b269}});}const _0x458592=0x28,_0x46f984=_0x458592*(+pageNumber-0x1);_0x50d48e={..._0x50d48e,'companyId':_0xf67171};const {count:_0x1a1bcc,rows:_0x530ab9}=await Ticket_1[_0x1b0ccb(0x1e3)]['findAndCountAll']({'where':_0x50d48e,'include':_0x4a2cdf,'distinct':!![],'limit':_0x458592,'offset':_0x46f984,'order':[[_0x1b0ccb(0x1b9),_0x1b0ccb(0x1dd)]],'subQuery':![]}),_0x359c91=_0x1a1bcc>_0x46f984+_0x530ab9[_0x1b0ccb(0x1b1)];return{'tickets':_0x530ab9,'count':_0x1a1bcc,'hasMore':_0x359c91};};exports[a537_0x289c8e(0x1e3)]=ListTicketsService;