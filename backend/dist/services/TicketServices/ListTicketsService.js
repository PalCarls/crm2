'use strict';const a543_0x1ae26c=a543_0x5e80;(function(_0x5ce0b2,_0x2d42bc){const _0x36caa6=a543_0x5e80,_0x2684f6=_0x5ce0b2();while(!![]){try{const _0x1d892c=-parseInt(_0x36caa6(0x93))/0x1+-parseInt(_0x36caa6(0xce))/0x2+-parseInt(_0x36caa6(0xcb))/0x3+-parseInt(_0x36caa6(0xa8))/0x4+-parseInt(_0x36caa6(0xa5))/0x5+parseInt(_0x36caa6(0xbf))/0x6+parseInt(_0x36caa6(0xa7))/0x7*(parseInt(_0x36caa6(0xd2))/0x8);if(_0x1d892c===_0x2d42bc)break;else _0x2684f6['push'](_0x2684f6['shift']());}catch(_0x190727){_0x2684f6['push'](_0x2684f6['shift']());}}}(a543_0x58d1,0x67ff7));function a543_0x58d1(){const _0x4098e3=['length','../../models/Tag','whatsapp','queue','3245230VzzdAd','messages','248969LrvFhF','1148356ymclqM','__esModule','body','map','closed','DESC','color','col','__importDefault','acceptAudioMessage','expiresTicket','../../models/Ticket','MAX(\x22id\x22)','push','nps','true','../../models/Queue','tags','LOWER','trim','companyId','updatedAt','unaccent','1799646BynNKM','contactId','isArray','toLocaleLowerCase','pending','user','../../models/ContactTag','urlPicture','sequelize','admin','enable','where','2280168FdtLCj','intersection','name','874802cEomVQ','findAll','../../models/Contact','number','584kHRBmS','whatsappId','profile','findAndCountAll','active','../../models/User','../UserServices/ShowUserService','contactTags','336765SLJTIV','queues','notIn','extraInfo','allowGroup','group','LIKE','disable','default','literal','lgpd','groupAsTicket','allTicket','search'];a543_0x58d1=function(){return _0x4098e3;};return a543_0x58d1();}function a543_0x5e80(_0x389c25,_0x2a85ba){const _0x58d194=a543_0x58d1();return a543_0x5e80=function(_0x5e80a1,_0x2d96bd){_0x5e80a1=_0x5e80a1-0x8c;let _0x49f569=_0x58d194[_0x5e80a1];return _0x49f569;},a543_0x5e80(_0x389c25,_0x2a85ba);}var __importDefault=this&&this[a543_0x1ae26c(0xb0)]||function(_0x15e554){return _0x15e554&&_0x15e554['__esModule']?_0x15e554:{'default':_0x15e554};};Object['defineProperty'](exports,a543_0x1ae26c(0xa9),{'value':!![]});const sequelize_1=require(a543_0x1ae26c(0xc7)),Ticket_1=__importDefault(require(a543_0x1ae26c(0xb3))),Contact_1=__importDefault(require(a543_0x1ae26c(0xd0))),Message_1=__importDefault(require('../../models/Message')),Queue_1=__importDefault(require(a543_0x1ae26c(0xb8))),User_1=__importDefault(require(a543_0x1ae26c(0x90))),ShowUserService_1=__importDefault(require(a543_0x1ae26c(0x91))),Tag_1=__importDefault(require(a543_0x1ae26c(0xa2))),lodash_1=require('lodash'),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),ContactTag_1=__importDefault(require(a543_0x1ae26c(0xc5))),remove_accents_1=__importDefault(require('remove-accents')),ListTicketsService=async({searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x21938b,tags:_0x8f3d4c,users:_0x63364f,status:_0x7925ed,date:_0x2c7c63,dateStart:_0x3993f0,dateEnd:_0x5ceb17,updatedAt:_0x297170,showAll:_0x321f63,userId:_0x594ea8,withUnreadMessages:_0x5522b5,whatsappIds:_0x4e7485,statusFilters:_0x521d5e,companyId:_0x56c7e9})=>{const _0x3dc50e=a543_0x1ae26c;let _0x5f19b4={[sequelize_1['Op']['or']]:[{'userId':_0x594ea8},{'status':_0x3dc50e(0xc3)}],'queueId':{[sequelize_1['Op']['or']]:[_0x21938b,null]},'companyId':_0x56c7e9},_0x35db03;_0x35db03=[{'model':Contact_1[_0x3dc50e(0x9b)],'as':'contact','attributes':['id','name',_0x3dc50e(0xd1),'email','profilePicUrl',_0x3dc50e(0xb1),_0x3dc50e(0x8f),_0x3dc50e(0xc6),'companyId'],'include':[_0x3dc50e(0x96),_0x3dc50e(0x92),_0x3dc50e(0xb9)]},{'model':Queue_1[_0x3dc50e(0x9b)],'as':_0x3dc50e(0xa4),'attributes':['id',_0x3dc50e(0xcd),_0x3dc50e(0xae)]},{'model':User_1[_0x3dc50e(0x9b)],'as':'user','attributes':['id',_0x3dc50e(0xcd)]},{'model':Tag_1[_0x3dc50e(0x9b)],'as':'tags','attributes':['id',_0x3dc50e(0xcd),_0x3dc50e(0xae)]},{'model':Whatsapp_1[_0x3dc50e(0x9b)],'as':_0x3dc50e(0xa3),'attributes':['id',_0x3dc50e(0xcd),_0x3dc50e(0xb2),_0x3dc50e(0x9e)]}];const _0x8abd0d=await(0x0,ShowUserService_1[_0x3dc50e(0x9b)])(_0x594ea8),_0x2f8a77=_0x8abd0d[_0x3dc50e(0x94)][_0x3dc50e(0xab)](_0x4628fa=>_0x4628fa['id']);_0x7925ed==='open'&&(_0x5f19b4={..._0x5f19b4,'userId':_0x594ea8,'queueId':{[sequelize_1['Op']['in']]:_0x21938b}});_0x7925ed===_0x3dc50e(0x98)&&(_0x8abd0d[_0x3dc50e(0x97)]||_0x321f63===_0x3dc50e(0xb7))&&(_0x5f19b4={..._0x5f19b4,'queueId':{[sequelize_1['Op']['or']]:[_0x21938b,null]}});if(_0x8abd0d[_0x3dc50e(0x8d)]===_0x3dc50e(0xc4)&&_0x7925ed==='pending'&&_0x8abd0d['allTicket']===_0x3dc50e(0xc9)){const _0x39b1a2=[],_0x355a2f=await Ticket_1[_0x3dc50e(0x9b)][_0x3dc50e(0xcf)]({'where':{'userId':{[sequelize_1['Op']['or']]:[_0x8abd0d['id'],null]},'queueId':{[sequelize_1['Op']['or']]:[_0x21938b,null]},'status':_0x3dc50e(0xc3)}});_0x355a2f&&_0x39b1a2['push'](_0x355a2f[_0x3dc50e(0xab)](_0x1a2a6f=>_0x1a2a6f['id']));const _0x5bf332=(0x0,lodash_1['intersection'])(..._0x39b1a2);_0x5f19b4={..._0x5f19b4,'id':{[sequelize_1['Op']['in']]:_0x5bf332}};}if(_0x8abd0d['profile']===_0x3dc50e(0xc4)&&_0x7925ed===_0x3dc50e(0xc3)&&_0x8abd0d[_0x3dc50e(0x9f)]===_0x3dc50e(0x9a)){const _0x562e5a=[],_0x393e3f=await Ticket_1[_0x3dc50e(0x9b)]['findAll']({'where':{[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op']['or']]:[_0x8abd0d['id'],null]}},{'status':{[sequelize_1['Op']['or']]:[_0x3dc50e(0xc3),'closed']}}],'queueId':{[sequelize_1['Op']['in']]:_0x21938b},'status':_0x3dc50e(0xc3)}});_0x393e3f&&_0x562e5a[_0x3dc50e(0xb5)](_0x393e3f[_0x3dc50e(0xab)](_0x2e9917=>_0x2e9917['id']));const _0x1de287=(0x0,lodash_1[_0x3dc50e(0xcc)])(..._0x562e5a);_0x5f19b4={..._0x5f19b4,'id':{[sequelize_1['Op']['in']]:_0x1de287}};}_0x321f63===_0x3dc50e(0xb7)&&_0x8abd0d[_0x3dc50e(0x8d)]===_0x3dc50e(0xc8)&&(_0x5f19b4={'queueId':{[sequelize_1['Op']['or']]:[_0x21938b,null]}});_0x7925ed&&_0x7925ed!==_0x3dc50e(0xa0)&&(_0x5f19b4={..._0x5f19b4,'status':_0x7925ed});if(_0x7925ed==='closed'){const _0x2ba867=await Ticket_1[_0x3dc50e(0x9b)][_0x3dc50e(0xcf)]({'attributes':[_0x3dc50e(0xbc),_0x3dc50e(0xc0),_0x3dc50e(0x8c),[(0x0,sequelize_1[_0x3dc50e(0x9c)])(_0x3dc50e(0xb4)),'id']],'where':{'queueId':_0x321f63===_0x3dc50e(0xb7)||_0x8abd0d[_0x3dc50e(0x9f)]==='enable'?{[sequelize_1['Op']['or']]:[_0x21938b,null]}:_0x21938b,'status':'closed'},'group':['companyId',_0x3dc50e(0xc0),_0x3dc50e(0x8c)]}),_0x4dd7bd=_0x2ba867[_0x3dc50e(0xab)](_0x5ae41b=>_0x5ae41b['id']);_0x5f19b4={..._0x5f19b4,'id':{[sequelize_1['Op']['in']]:_0x4dd7bd}};}if(_0x7925ed==='search'){_0x5f19b4={'companyId':_0x56c7e9};const _0x2b47a3=await Ticket_1[_0x3dc50e(0x9b)]['findAll']({'attributes':[_0x3dc50e(0xbc),_0x3dc50e(0xc0),_0x3dc50e(0x8c),[(0x0,sequelize_1['literal'])(_0x3dc50e(0xb4)),'id']],'where':{'queueId':_0x321f63===_0x3dc50e(0xb7)||_0x8abd0d[_0x3dc50e(0x9f)]===_0x3dc50e(0xc9)?{[sequelize_1['Op']['or']]:[_0x21938b,null]}:_0x21938b},'group':[_0x3dc50e(0xbc),_0x3dc50e(0xc0),_0x3dc50e(0x8c)]}),_0x533768=_0x2b47a3['map'](_0x3a9799=>_0x3a9799['id']);_0x5f19b4={..._0x5f19b4,'id':{[sequelize_1['Op']['in']]:_0x533768}};if(searchParam){const _0x19dee0=(0x0,remove_accents_1['default'])(searchParam[_0x3dc50e(0xc2)]()[_0x3dc50e(0xbb)]());_0x35db03=[..._0x35db03,{'model':Message_1[_0x3dc50e(0x9b)],'as':_0x3dc50e(0xa6),'attributes':['id',_0x3dc50e(0xaa)],'where':{'body':(0x0,sequelize_1[_0x3dc50e(0xca)])((0x0,sequelize_1['fn'])('LOWER',(0x0,sequelize_1['fn'])(_0x3dc50e(0xbe),(0x0,sequelize_1['col'])(_0x3dc50e(0xaa)))),'LIKE','%'+_0x19dee0+'%')},'required':![],'duplicating':![]}],_0x5f19b4={..._0x5f19b4,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x3dc50e(0xca)])((0x0,sequelize_1['fn'])(_0x3dc50e(0xba),(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1[_0x3dc50e(0xaf)])('contact.name'))),_0x3dc50e(0x99),'%'+_0x19dee0+'%')},{'$contact.number$':{[sequelize_1['Op']['like']]:'%'+_0x19dee0+'%'}},{'$message.body$':(0x0,sequelize_1['where'])((0x0,sequelize_1['fn'])(_0x3dc50e(0xba),(0x0,sequelize_1['fn'])('unaccent',(0x0,sequelize_1[_0x3dc50e(0xaf)])(_0x3dc50e(0xaa)))),_0x3dc50e(0x99),'%'+_0x19dee0+'%')}]};}if(Array[_0x3dc50e(0xc1)](_0x8f3d4c)&&_0x8f3d4c[_0x3dc50e(0xa1)]>0x0){const _0x1ee81d=[],_0x32b7d9=await ContactTag_1[_0x3dc50e(0x9b)][_0x3dc50e(0xcf)]({'where':{'tagId':{[sequelize_1['Op']['in']]:_0x8f3d4c}}});_0x32b7d9&&_0x1ee81d[_0x3dc50e(0xb5)](_0x32b7d9[_0x3dc50e(0xab)](_0x1b7338=>_0x1b7338[_0x3dc50e(0xc0)]));const _0x54a260=(0x0,lodash_1[_0x3dc50e(0xcc)])(..._0x1ee81d);_0x5f19b4={..._0x5f19b4,'contactId':{[sequelize_1['Op']['in']]:_0x54a260}};}Array['isArray'](_0x63364f)&&_0x63364f['length']>0x0&&(_0x5f19b4={..._0x5f19b4,'userId':{[sequelize_1['Op']['in']]:_0x63364f}}),Array[_0x3dc50e(0xc1)](_0x4e7485)&&_0x4e7485[_0x3dc50e(0xa1)]>0x0&&(_0x5f19b4={..._0x5f19b4,'whatsappId':{[sequelize_1['Op']['in']]:_0x4e7485}}),Array[_0x3dc50e(0xc1)](_0x521d5e)&&_0x521d5e['length']>0x0&&(_0x5f19b4={..._0x5f19b4,'status':{[sequelize_1['Op']['in']]:_0x521d5e}});}_0x5522b5===_0x3dc50e(0xb7)&&(_0x5f19b4={[sequelize_1['Op']['or']]:[{'userId':_0x594ea8,'status':{[sequelize_1['Op'][_0x3dc50e(0x95)]]:[_0x3dc50e(0xac),_0x3dc50e(0x9d),_0x3dc50e(0xb6)]},'queueId':{[sequelize_1['Op']['in']]:_0x2f8a77},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0x56c7e9},{'status':{[sequelize_1['Op']['in']]:[_0x3dc50e(0xc3),'group']},'queueId':{[sequelize_1['Op']['or']]:[_0x2f8a77,null]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0},'companyId':_0x56c7e9}]},_0x7925ed===_0x3dc50e(0x98)&&(_0x8abd0d[_0x3dc50e(0x97)]||_0x321f63===_0x3dc50e(0xb7))&&(_0x5f19b4={..._0x5f19b4,'queueId':{[sequelize_1['Op']['or']]:[_0x2f8a77,null]}}));_0x5f19b4={..._0x5f19b4,'companyId':_0x56c7e9};const _0x57afa0=0x28,_0x52224b=_0x57afa0*(+pageNumber-0x1),{count:_0x117549,rows:_0x308c95}=await Ticket_1[_0x3dc50e(0x9b)][_0x3dc50e(0x8e)]({'where':_0x5f19b4,'include':_0x35db03,'distinct':!![],'limit':_0x57afa0,'offset':_0x52224b,'order':[[_0x3dc50e(0xbd),_0x3dc50e(0xad)]],'subQuery':![]}),_0x4a1ebf=_0x117549>_0x52224b+_0x308c95[_0x3dc50e(0xa1)];return{'tickets':_0x308c95,'count':_0x117549,'hasMore':_0x4a1ebf};};exports[a543_0x1ae26c(0x9b)]=ListTicketsService;