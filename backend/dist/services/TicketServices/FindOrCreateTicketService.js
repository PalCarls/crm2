'use strict';const a520_0x2a64e5=a520_0x2a2b;(function(_0x202d95,_0x2af68e){const _0x177818=a520_0x2a2b,_0x1ead9d=_0x202d95();while(!![]){try{const _0xbf7929=parseInt(_0x177818(0x16c))/0x1*(parseInt(_0x177818(0x142))/0x2)+parseInt(_0x177818(0x16d))/0x3+-parseInt(_0x177818(0x163))/0x4+-parseInt(_0x177818(0x13e))/0x5*(-parseInt(_0x177818(0x159))/0x6)+parseInt(_0x177818(0x164))/0x7*(-parseInt(_0x177818(0x144))/0x8)+parseInt(_0x177818(0x169))/0x9*(parseInt(_0x177818(0x14c))/0xa)+parseInt(_0x177818(0x160))/0xb*(-parseInt(_0x177818(0x15c))/0xc);if(_0xbf7929===_0x2af68e)break;else _0x1ead9d['push'](_0x1ead9d['shift']());}catch(_0x5c9fe1){_0x1ead9d['push'](_0x1ead9d['shift']());}}}(a520_0x4868,0x96ea7));function a520_0x4868(){const _0x4775ec=['findOne','logger','status','enableLGPD','3050WUFuvt','defineProperty','notification','update','timeCreateNewTicket','./ShowTicketService','../../libs/socket','lodash','key','date-fns','value','add','toString','6936222CYOYIR','lgpdMessage','../../utils/logger','828WCrPCQ','__esModule','emit','open','343739Hwybkc','../../models/Ticket','userId','2372344truXmW','28609ikPOqg','lgpd','pending','closed','error','8811WAFCoc','default','log','987939ErJYCH','2860368BVMQGz','group','isNil','between','5xcxZiE','groupAsTicket','create','enabled','2tmnEiy','./FindOrCreateATicketTrakingService','56kBsaNO','Error\x20to\x20find\x20or\x20create\x20a\x20ticket:','DESC','find'];a520_0x4868=function(){return _0x4775ec;};return a520_0x4868();}var __importDefault=this&&this['__importDefault']||function(_0x369e3b){const _0x30d253=a520_0x2a2b;return _0x369e3b&&_0x369e3b[_0x30d253(0x15d)]?_0x369e3b:{'default':_0x369e3b};};function a520_0x2a2b(_0xb4bb09,_0x14176b){const _0x4868fa=a520_0x4868();return a520_0x2a2b=function(_0x2a2b06,_0x26a3db){_0x2a2b06=_0x2a2b06-0x13c;let _0x169b10=_0x4868fa[_0x2a2b06];return _0x169b10;},a520_0x2a2b(_0xb4bb09,_0x14176b);}Object[a520_0x2a64e5(0x14d)](exports,a520_0x2a64e5(0x15d),{'value':!![]});const sequelize_1=require('sequelize'),date_fns_1=require(a520_0x2a64e5(0x155)),Ticket_1=__importDefault(require(a520_0x2a64e5(0x161))),ShowTicketService_1=__importDefault(require(a520_0x2a64e5(0x151))),FindOrCreateATicketTrakingService_1=__importDefault(require(a520_0x2a64e5(0x143))),lodash_1=require(a520_0x2a64e5(0x153)),socket_1=require(a520_0x2a64e5(0x152)),logger_1=require(a520_0x2a64e5(0x15b)),FindOrCreateTicketService=async(_0x3647be,_0x37e942,_0x51131e,_0x3093dd,_0xc21473,_0x55ad2a,_0x39feb1,_0x13bdd0,_0x5d6d09,_0x44c3a0,_0x1f9077)=>{const _0x130e60=a520_0x2a64e5;try{let _0x398fb0=![];const _0x2ea506=_0x1f9077[_0x130e60(0x147)](_0x563ed4=>_0x563ed4[_0x130e60(0x154)]===_0x130e60(0x14b)),_0x37d457=_0x1f9077[_0x130e60(0x147)](_0x2f9b5e=>_0x2f9b5e['key']===_0x130e60(0x15a));let _0x92cc07=![];_0x2ea506&&_0x37d457&&(_0x92cc07=_0x2ea506?.['value']===_0x130e60(0x141)&&_0x37d457?.[_0x130e60(0x156)]!=='');console[_0x130e60(0x16b)](_0x92cc07);const _0x4cf142=(0x0,socket_1['getIO'])();let _0x27477a=await Ticket_1[_0x130e60(0x16a)][_0x130e60(0x148)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x130e60(0x15f),'pending',_0x130e60(0x16e),'nps',_0x130e60(0x165)]},'contactId':_0x39feb1?_0x39feb1['id']:_0x3647be['id'],'companyId':_0x3093dd,'whatsappId':_0x37e942['id']},'order':[['id',_0x130e60(0x146)]]});if(_0x27477a){await _0x27477a[_0x130e60(0x14f)]({'unreadMessages':_0x51131e}),_0x27477a=await(0x0,ShowTicketService_1['default'])(_0x27477a['id'],_0x3093dd),_0x398fb0=!![];return{'ticket':_0x27477a,'isCreated':_0x398fb0};;}const _0x18b761=_0x37e942[_0x130e60(0x150)];!_0x27477a&&(_0x18b761!==0x0&&(_0x27477a=await Ticket_1[_0x130e60(0x16a)][_0x130e60(0x148)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x130e60(0x13d)]]:[+(0x0,date_fns_1[_0x130e60(0x157)])(new Date(),{'minutes':_0x18b761}),+new Date()]},'contactId':_0x3647be['id'],'companyId':_0x3093dd,'whatsappId':_0x37e942['id']},'order':[['updatedAt',_0x130e60(0x146)]]})),_0x27477a&&_0x27477a[_0x130e60(0x14a)]!=='nps'&&await _0x27477a[_0x130e60(0x14f)]({'status':_0x130e60(0x167),'userId':null,'unreadMessages':_0x51131e,'companyId':_0x3093dd}));!_0x27477a&&(_0x27477a=await Ticket_1[_0x130e60(0x16a)][_0x130e60(0x140)]({'contactId':_0x39feb1?_0x39feb1['id']:_0x3647be['id'],'status':!_0x5d6d09&&!(0x0,lodash_1[_0x130e60(0x13c)])(_0x2ea506['value'])&&_0x92cc07&&!_0x39feb1?_0x130e60(0x165):_0x37e942[_0x130e60(0x13f)]===_0x130e60(0x141)||!_0x39feb1?_0x130e60(0x166):_0x130e60(0x16e),'isGroup':!!_0x39feb1,'unreadMessages':_0x51131e,'whatsappId':_0x37e942['id'],'companyId':_0x3093dd,'isBot':!![],'channel':_0x13bdd0,'imported':_0x5d6d09?new Date():null}),await(0x0,FindOrCreateATicketTrakingService_1[_0x130e60(0x16a)])({'ticketId':_0x27477a['id'],'companyId':_0x3093dd,'whatsappId':_0x37e942['id'],'userId':_0x27477a[_0x130e60(0x162)]}),_0x398fb0=!![]);_0xc21473!=0x0&&_0xc21473!=undefined&&await _0x27477a[_0x130e60(0x14f)]({'queueId':_0xc21473});_0x55ad2a!=0x0&&_0x55ad2a!=undefined&&await _0x27477a['update']({'userId':_0x55ad2a});_0x27477a=await(0x0,ShowTicketService_1[_0x130e60(0x16a)])(_0x27477a['id'],_0x3093dd);!_0x44c3a0&&_0x4cf142['to'](_0x27477a[_0x130e60(0x14a)])['to'](_0x130e60(0x14e))['to'](_0x27477a['id'][_0x130e60(0x158)]())[_0x130e60(0x15e)]('company-'+_0x3093dd+'-ticket',{'action':_0x130e60(0x14f),'ticket':_0x27477a});;return{'ticket':_0x27477a,'isCreated':_0x398fb0};}catch(_0x52702e){logger_1[_0x130e60(0x149)][_0x130e60(0x168)](_0x130e60(0x145),_0x52702e);}};exports[a520_0x2a64e5(0x16a)]=FindOrCreateTicketService;