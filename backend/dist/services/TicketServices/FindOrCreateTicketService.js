'use strict';const a592_0x2d5578=a592_0x417c;(function(_0x1685e2,_0x39ba52){const _0x10c2e0=a592_0x417c,_0x3123a4=_0x1685e2();while(!![]){try{const _0x477b1f=-parseInt(_0x10c2e0(0x198))/0x1*(-parseInt(_0x10c2e0(0x1ab))/0x2)+parseInt(_0x10c2e0(0x18c))/0x3+-parseInt(_0x10c2e0(0x1b2))/0x4*(-parseInt(_0x10c2e0(0x193))/0x5)+-parseInt(_0x10c2e0(0x1b1))/0x6*(-parseInt(_0x10c2e0(0x1a2))/0x7)+parseInt(_0x10c2e0(0x187))/0x8*(parseInt(_0x10c2e0(0x197))/0x9)+parseInt(_0x10c2e0(0x195))/0xa+-parseInt(_0x10c2e0(0x19f))/0xb*(parseInt(_0x10c2e0(0x1af))/0xc);if(_0x477b1f===_0x39ba52)break;else _0x3123a4['push'](_0x3123a4['shift']());}catch(_0x524825){_0x3123a4['push'](_0x3123a4['shift']());}}}(a592_0x1bac,0x2796c));var __importDefault=this&&this['__importDefault']||function(_0x431bef){const _0x311666=a592_0x417c;return _0x431bef&&_0x431bef[_0x311666(0x186)]?_0x431bef:{'default':_0x431bef};};function a592_0x417c(_0x3448a7,_0x418a03){const _0x1bac92=a592_0x1bac();return a592_0x417c=function(_0x417c0a,_0x5d7232){_0x417c0a=_0x417c0a-0x17f;let _0x59261b=_0x1bac92[_0x417c0a];return _0x59261b;},a592_0x417c(_0x3448a7,_0x418a03);}Object[a592_0x2d5578(0x19c)](exports,a592_0x2d5578(0x186),{'value':!![]});const sequelize_1=require('sequelize'),date_fns_1=require('date-fns'),Ticket_1=__importDefault(require(a592_0x2d5578(0x19b))),ShowTicketService_1=__importDefault(require(a592_0x2d5578(0x1ae))),FindOrCreateATicketTrakingService_1=__importDefault(require(a592_0x2d5578(0x1a1))),lodash_1=require(a592_0x2d5578(0x196)),socket_1=require('../../libs/socket'),CreateLogTicketService_1=__importDefault(require(a592_0x2d5578(0x18f))),AppError_1=__importDefault(require(a592_0x2d5578(0x1a8))),UpdateTicketService_1=__importDefault(require('./UpdateTicketService')),FindOrCreateTicketService=async(_0xaa3cf3,_0x450dcd,_0x406679,_0x238b7,_0x47ad35,_0xa5c47c,_0x206eda,_0x5cbc8b,_0x410214,_0x3c3f88,_0x3f9c6b,_0x15a83c)=>{const _0x147cbc=a592_0x2d5578;let _0xce48aa=![],_0x5338a5=![];_0x3f9c6b[_0x147cbc(0x190)]&&(_0x5338a5=!_0x15a83c&&_0x3f9c6b[_0x147cbc(0x190)]===_0x147cbc(0x18b)&&_0x3f9c6b[_0x147cbc(0x188)]!==''&&(_0x3f9c6b[_0x147cbc(0x1a9)]===_0x147cbc(0x18b)||_0x3f9c6b['lgpdConsent']===_0x147cbc(0x1a3)&&(0x0,lodash_1[_0x147cbc(0x189)])(_0xaa3cf3?.[_0x147cbc(0x18d)])));const _0x3d125b=(0x0,socket_1[_0x147cbc(0x1a6)])(),_0x410ea7=_0x3f9c6b[_0x147cbc(0x18a)];let _0x442684=await Ticket_1[_0x147cbc(0x1a0)][_0x147cbc(0x19a)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x147cbc(0x17f),_0x147cbc(0x18e),_0x147cbc(0x1ac),_0x147cbc(0x185),_0x147cbc(0x19d)]},'contactId':_0x206eda?_0x206eda['id']:_0xaa3cf3['id'],'companyId':_0x238b7,'whatsappId':_0x450dcd['id']},'order':[['id','DESC']]});if(_0x442684){await(0x0,UpdateTicketService_1['default'])({'ticketId':_0x442684['id'],'ticketData':{'unreadMessages':_0x406679,'isBot':![]},'companyId':_0x238b7}),_0x442684=await(0x0,ShowTicketService_1[_0x147cbc(0x1a0)])(_0x442684['id'],_0x238b7);if(Number(_0x442684?.[_0x147cbc(0x1ad)])!==Number(_0xa5c47c)&&_0xa5c47c!==0x0&&_0xa5c47c!==''&&_0xa5c47c!=='0'&&_0xa5c47c!==undefined||_0x47ad35!==0x0&&Number(_0x442684?.[_0x147cbc(0x184)])!==Number(_0x47ad35)&&_0x47ad35!==''&&_0x47ad35!=='0'&&_0x47ad35!==undefined)throw new AppError_1[(_0x147cbc(0x1a0))](_0x147cbc(0x194)+('Atendente:\x20'+_0x442684['user']['name'])+_0x147cbc(0x1a4)+(_0x147cbc(0x183)+_0x442684[_0x147cbc(0x180)]['name']));return _0xce48aa=!![],{'ticket':_0x442684,'isCreated':_0xce48aa};}const _0xe8f2db=_0x450dcd['timeCreateNewTicket'];!_0x442684&&_0xe8f2db!==0x0&&(_0xe8f2db!==0x0&&_0xe8f2db!=='0'&&(_0x442684=await Ticket_1[_0x147cbc(0x1a0)][_0x147cbc(0x19a)]({'where':{'updatedAt':{[sequelize_1['Op']['between']]:[+(0x0,date_fns_1[_0x147cbc(0x19e)])(new Date(),{'minutes':Number(_0xe8f2db)}),+new Date()]},'contactId':_0xaa3cf3['id'],'companyId':_0x238b7,'whatsappId':_0x450dcd['id']},'order':[[_0x147cbc(0x181),_0x147cbc(0x192)]]})),_0x442684&&_0x442684['status']!=='nps'&&await _0x442684['update']({'status':_0x147cbc(0x18e),'unreadMessages':_0x406679,'companyId':_0x238b7}));if(!_0x442684){const _0x4bc1d6={'contactId':_0x206eda?_0x206eda['id']:_0xaa3cf3['id'],'status':!_0x410214&&!(0x0,lodash_1[_0x147cbc(0x189)])(_0x3f9c6b[_0x147cbc(0x190)])&&_0x5338a5&&!_0x206eda?_0x147cbc(0x19d):_0x450dcd[_0x147cbc(0x1a7)]===_0x147cbc(0x18b)||!_0x206eda?'pending':'group','isGroup':!!_0x206eda,'unreadMessages':_0x406679,'whatsappId':_0x450dcd['id'],'companyId':_0x238b7,'isBot':_0x206eda?![]:!![],'channel':_0x5cbc8b,'imported':_0x410214?new Date():null,'isActiveDemand':![]};if(_0x410ea7&&_0xaa3cf3['id']){const _0x3c999c=_0xaa3cf3,_0x4b167b=await _0x3c999c[_0x147cbc(0x1b0)]();_0x4b167b&&_0x4b167b[0x0]?.['id']&&(_0x4bc1d6[_0x147cbc(0x182)]=!_0x410214&&!(0x0,lodash_1[_0x147cbc(0x189)])(_0x3f9c6b[_0x147cbc(0x190)])&&_0x5338a5&&!_0x206eda?_0x147cbc(0x19d):_0x450dcd[_0x147cbc(0x1a7)]===_0x147cbc(0x18b)||!_0x206eda?_0x147cbc(0x17f):_0x147cbc(0x1ac),_0x4bc1d6[_0x147cbc(0x1ad)]=_0x4b167b[0x0]['id']);}_0x442684=await Ticket_1[_0x147cbc(0x1a0)][_0x147cbc(0x199)](_0x4bc1d6),await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x442684['id'],'companyId':_0x238b7,'whatsappId':_0x450dcd['id'],'userId':_0xa5c47c?_0xa5c47c:_0x442684[_0x147cbc(0x1ad)]}),_0xce48aa=!![];}_0x47ad35!=0x0&&_0x47ad35!=undefined&&await _0x442684[_0x147cbc(0x191)]({'queueId':_0x47ad35});_0xa5c47c!=0x0&&_0xa5c47c!=undefined&&await _0x442684[_0x147cbc(0x191)]({'userId':_0xa5c47c});_0x442684=await(0x0,ShowTicketService_1['default'])(_0x442684['id'],_0x238b7),await(0x0,CreateLogTicketService_1['default'])({'ticketId':_0x442684['id'],'type':_0x5338a5?_0x147cbc(0x19d):_0x147cbc(0x199)});!_0x3c3f88&&!_0x15a83c&&_0x3d125b['to'](_0x442684[_0x147cbc(0x182)])['to'](_0x147cbc(0x1aa))['to'](_0x442684['id']['toString']())['emit'](_0x147cbc(0x1a5)+_0x238b7+'-ticket',{'action':'update','ticket':_0x442684});;return{'ticket':_0x442684,'isCreated':_0xce48aa};};exports[a592_0x2d5578(0x1a0)]=FindOrCreateTicketService;function a592_0x1bac(){const _0x3c4839=['open','queue','updatedAt','status','Fila:\x20','queueId','nps','__esModule','992984miwxPR','lgpdMessage','isNil','DirectTicketsToWallets','enabled','720660ixCPBA','lgpdAcceptedAt','pending','./CreateLogTicketService','enableLGPD','update','DESC','119010SebxUM','Ticket\x20em\x20outro\x20atendimento.\x20','2404610iEAGyz','lodash','18bhLKJO','7027dAhAUe','create','findOne','../../models/Ticket','defineProperty','lgpd','sub','88KPFLJB','default','./FindOrCreateATicketTrakingService','140xhatMy','disabled','\x20-\x20','company-','getIO','groupAsTicket','../../errors/AppError','lgpdConsent','notification','66pPmfDo','group','userId','./ShowTicketService','1705416wsgedu','getWallets','22938dGRRwu','44dCSONL'];a592_0x1bac=function(){return _0x3c4839;};return a592_0x1bac();}