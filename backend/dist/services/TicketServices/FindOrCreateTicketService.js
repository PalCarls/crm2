'use strict';function a581_0x56d8(_0x2cad5f,_0x2829ef){const _0x55db3b=a581_0x55db();return a581_0x56d8=function(_0x56d8e1,_0x4e7858){_0x56d8e1=_0x56d8e1-0x1f0;let _0x113982=_0x55db3b[_0x56d8e1];return _0x113982;},a581_0x56d8(_0x2cad5f,_0x2829ef);}const a581_0x3b3bf3=a581_0x56d8;(function(_0x11ae12,_0x3cd588){const _0xa9df1c=a581_0x56d8,_0x5e9e57=_0x11ae12();while(!![]){try{const _0x3ed1df=parseInt(_0xa9df1c(0x1fe))/0x1+parseInt(_0xa9df1c(0x217))/0x2+parseInt(_0xa9df1c(0x1f0))/0x3*(-parseInt(_0xa9df1c(0x212))/0x4)+-parseInt(_0xa9df1c(0x218))/0x5+-parseInt(_0xa9df1c(0x203))/0x6*(-parseInt(_0xa9df1c(0x20e))/0x7)+-parseInt(_0xa9df1c(0x208))/0x8*(parseInt(_0xa9df1c(0x209))/0x9)+parseInt(_0xa9df1c(0x214))/0xa*(-parseInt(_0xa9df1c(0x210))/0xb);if(_0x3ed1df===_0x3cd588)break;else _0x5e9e57['push'](_0x5e9e57['shift']());}catch(_0x27bd9c){_0x5e9e57['push'](_0x5e9e57['shift']());}}}(a581_0x55db,0x1c4ae));function a581_0x55db(){const _0x5c43fc=['enabled','DESC','lgpdMessage','company-','enableLGPD','notification','open','__importDefault','status','lodash','groupAsTicket','133050giUARz','queueId','userId','sequelize','./FindOrCreateATicketTrakingService','4818svFXIN','../../libs/socket','name','user','isNil','40ZxhlIn','96525KsIiJs','updatedAt','__esModule','timeCreateNewTicket','../../errors/AppError','1883WVLBym','queue','11PbBGIV','getIO','7244VAhMKC','pending','1328570osYOXF','-ticket','update','228638mHQHvE','470005zKBLlr','./UpdateTicketService','Fila:\x20','../../models/Ticket','create','between','date-fns','./ShowTicketService','Ticket\x20em\x20outro\x20atendimento.\x20','lgpd','group','nps','lgpdConsent','default','findOne','disabled','111jkeLSl','\x20-\x20','sub'];a581_0x55db=function(){return _0x5c43fc;};return a581_0x55db();}var __importDefault=this&&this[a581_0x3b3bf3(0x1fa)]||function(_0x808d79){const _0x180f72=a581_0x3b3bf3;return _0x808d79&&_0x808d79[_0x180f72(0x20b)]?_0x808d79:{'default':_0x808d79};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const sequelize_1=require(a581_0x3b3bf3(0x201)),date_fns_1=require(a581_0x3b3bf3(0x21e)),Ticket_1=__importDefault(require(a581_0x3b3bf3(0x21b))),ShowTicketService_1=__importDefault(require(a581_0x3b3bf3(0x21f))),FindOrCreateATicketTrakingService_1=__importDefault(require(a581_0x3b3bf3(0x202))),lodash_1=require(a581_0x3b3bf3(0x1fc)),socket_1=require(a581_0x3b3bf3(0x204)),CreateLogTicketService_1=__importDefault(require('./CreateLogTicketService')),AppError_1=__importDefault(require(a581_0x3b3bf3(0x20d))),UpdateTicketService_1=__importDefault(require(a581_0x3b3bf3(0x219))),FindOrCreateTicketService=async(_0x353dee,_0x55480d,_0x45312d,_0x195bb7,_0x392fa8,_0x596e56,_0x523d4c,_0x1b87f3,_0x4e1ba9,_0x2b262a,_0x464aa0)=>{const _0x18077a=a581_0x3b3bf3;let _0x2f6d7c=![],_0xddb713=![];_0x464aa0[_0x18077a(0x1f7)]&&(_0xddb713=_0x464aa0['enableLGPD']===_0x18077a(0x1f3)&&_0x464aa0[_0x18077a(0x1f5)]!==''&&(_0x464aa0[_0x18077a(0x224)]===_0x18077a(0x1f3)||_0x464aa0[_0x18077a(0x224)]===_0x18077a(0x227)&&(0x0,lodash_1['isNil'])(_0x353dee['lgpdAcceptedAt'])));const _0x377810=(0x0,socket_1[_0x18077a(0x211)])();let _0x509ce8=await Ticket_1['default'][_0x18077a(0x226)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x18077a(0x1f9),_0x18077a(0x213),_0x18077a(0x222),_0x18077a(0x223),_0x18077a(0x221)]},'contactId':_0x523d4c?_0x523d4c['id']:_0x353dee['id'],'companyId':_0x195bb7,'whatsappId':_0x55480d['id']},'order':[['id',_0x18077a(0x1f4)]]});if(_0x509ce8){await(0x0,UpdateTicketService_1[_0x18077a(0x225)])({'ticketId':_0x509ce8['id'],'ticketData':{'unreadMessages':_0x45312d,'isBot':![]},'companyId':_0x195bb7}),_0x509ce8=await(0x0,ShowTicketService_1[_0x18077a(0x225)])(_0x509ce8['id'],_0x195bb7);if(Number(_0x509ce8?.[_0x18077a(0x200)])!==Number(_0x596e56)&&_0x596e56!==0x0&&_0x596e56!==''&&_0x596e56!=='0'||_0x392fa8!==0x0&&Number(_0x509ce8?.[_0x18077a(0x1ff)])!==Number(_0x392fa8)&&_0x392fa8!==''&&_0x392fa8!=='0')throw new AppError_1['default'](_0x18077a(0x220)+('Atendente:\x20'+_0x509ce8[_0x18077a(0x206)][_0x18077a(0x205)])+_0x18077a(0x1f1)+(_0x18077a(0x21a)+_0x509ce8[_0x18077a(0x20f)]['name']));return _0x2f6d7c=!![],{'ticket':_0x509ce8,'isCreated':_0x2f6d7c};}const _0xf8d14f=_0x55480d[_0x18077a(0x20c)];!_0x509ce8&&_0xf8d14f!==0x0&&(_0xf8d14f!==0x0&&_0xf8d14f!=='0'&&(_0x509ce8=await Ticket_1[_0x18077a(0x225)]['findOne']({'where':{'updatedAt':{[sequelize_1['Op'][_0x18077a(0x21d)]]:[+(0x0,date_fns_1[_0x18077a(0x1f2)])(new Date(),{'minutes':Number(_0xf8d14f)}),+new Date()]},'contactId':_0x353dee['id'],'companyId':_0x195bb7,'whatsappId':_0x55480d['id']},'order':[[_0x18077a(0x20a),_0x18077a(0x1f4)]]})),_0x509ce8&&_0x509ce8[_0x18077a(0x1fb)]!==_0x18077a(0x223)&&await _0x509ce8['update']({'status':'pending','unreadMessages':_0x45312d,'companyId':_0x195bb7}));!_0x509ce8&&(_0x509ce8=await Ticket_1[_0x18077a(0x225)][_0x18077a(0x21c)]({'contactId':_0x523d4c?_0x523d4c['id']:_0x353dee['id'],'status':!_0x4e1ba9&&!(0x0,lodash_1[_0x18077a(0x207)])(_0x464aa0['enableLGPD'])&&_0xddb713&&!_0x523d4c?_0x18077a(0x221):_0x55480d[_0x18077a(0x1fd)]==='enabled'||!_0x523d4c?_0x18077a(0x213):_0x18077a(0x222),'isGroup':!!_0x523d4c,'unreadMessages':_0x45312d,'whatsappId':_0x55480d['id'],'companyId':_0x195bb7,'isBot':_0x523d4c?![]:!![],'channel':_0x1b87f3,'imported':_0x4e1ba9?new Date():null}),await(0x0,FindOrCreateATicketTrakingService_1[_0x18077a(0x225)])({'ticketId':_0x509ce8['id'],'companyId':_0x195bb7,'whatsappId':_0x55480d['id'],'userId':_0x509ce8[_0x18077a(0x200)]}),_0x2f6d7c=!![]);_0x392fa8!=0x0&&_0x392fa8!=undefined&&await _0x509ce8[_0x18077a(0x216)]({'queueId':_0x392fa8});_0x596e56!=0x0&&_0x596e56!=undefined&&await _0x509ce8[_0x18077a(0x216)]({'userId':_0x596e56});_0x509ce8=await(0x0,ShowTicketService_1[_0x18077a(0x225)])(_0x509ce8['id'],_0x195bb7),await(0x0,CreateLogTicketService_1[_0x18077a(0x225)])({'ticketId':_0x509ce8['id'],'type':_0xddb713?_0x18077a(0x221):_0x18077a(0x21c)});!_0x2b262a&&_0x377810['to'](_0x509ce8[_0x18077a(0x1fb)])['to'](_0x18077a(0x1f8))['to'](_0x509ce8['id']['toString']())['emit'](_0x18077a(0x1f6)+_0x195bb7+_0x18077a(0x215),{'action':'update','ticket':_0x509ce8});;return{'ticket':_0x509ce8,'isCreated':_0x2f6d7c};};exports[a581_0x3b3bf3(0x225)]=FindOrCreateTicketService;