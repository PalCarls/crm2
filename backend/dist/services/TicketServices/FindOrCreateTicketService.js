'use strict';const a592_0x364f52=a592_0x124e;(function(_0x19a62b,_0x5beaf4){const _0x267fcd=a592_0x124e,_0x37ade2=_0x19a62b();while(!![]){try{const _0x13fefc=parseInt(_0x267fcd(0x1e4))/0x1+-parseInt(_0x267fcd(0x1eb))/0x2*(parseInt(_0x267fcd(0x1d9))/0x3)+parseInt(_0x267fcd(0x1e0))/0x4*(parseInt(_0x267fcd(0x1e8))/0x5)+-parseInt(_0x267fcd(0x1fa))/0x6+parseInt(_0x267fcd(0x200))/0x7+-parseInt(_0x267fcd(0x1fd))/0x8*(parseInt(_0x267fcd(0x1e9))/0x9)+parseInt(_0x267fcd(0x1f0))/0xa;if(_0x13fefc===_0x5beaf4)break;else _0x37ade2['push'](_0x37ade2['shift']());}catch(_0xdb8752){_0x37ade2['push'](_0x37ade2['shift']());}}}(a592_0x31d1,0x25fa9));function a592_0x31d1(){const _0x110336=['__importDefault','lgpd','123SloAFO','findOne','notification','defineProperty','\x20-\x20','pending','../../libs/socket','68zpePxk','open','user','nps','113971uZfMCR','name','DESC','sub','15700RxSaiz','1287lhqXBD','Ticket\x20em\x20outro\x20atendimento.\x20','1052axKjfj','enabled','./CreateLogTicketService','queueId','Fila:\x20','67180wTdjmo','group','toString','../../errors/AppError','update','enableLGPD','./UpdateTicketService','getIO','groupAsTicket','create','234378vRxIqy','./FindOrCreateATicketTrakingService','date-fns','3928AGXlQs','lgpdAcceptedAt','timeCreateNewTicket','786338jKaHGO','status','emit','lgpdMessage','lodash','isNil','./ShowTicketService','__esModule','-ticket','getWallets','userId','disabled','lgpdConsent','default'];a592_0x31d1=function(){return _0x110336;};return a592_0x31d1();}var __importDefault=this&&this[a592_0x364f52(0x1d7)]||function(_0x19ade1){const _0x30d038=a592_0x364f52;return _0x19ade1&&_0x19ade1[_0x30d038(0x1d0)]?_0x19ade1:{'default':_0x19ade1};};function a592_0x124e(_0x39af48,_0x1a2030){const _0x31d1a0=a592_0x31d1();return a592_0x124e=function(_0x124e62,_0x3eee9f){_0x124e62=_0x124e62-0x1d0;let _0x44ccaf=_0x31d1a0[_0x124e62];return _0x44ccaf;},a592_0x124e(_0x39af48,_0x1a2030);}Object[a592_0x364f52(0x1dc)](exports,a592_0x364f52(0x1d0),{'value':!![]});const sequelize_1=require('sequelize'),date_fns_1=require(a592_0x364f52(0x1fc)),Ticket_1=__importDefault(require('../../models/Ticket')),ShowTicketService_1=__importDefault(require(a592_0x364f52(0x206))),FindOrCreateATicketTrakingService_1=__importDefault(require(a592_0x364f52(0x1fb))),lodash_1=require(a592_0x364f52(0x204)),socket_1=require(a592_0x364f52(0x1df)),CreateLogTicketService_1=__importDefault(require(a592_0x364f52(0x1ed))),AppError_1=__importDefault(require(a592_0x364f52(0x1f3))),UpdateTicketService_1=__importDefault(require(a592_0x364f52(0x1f6))),FindOrCreateTicketService=async(_0x400bba,_0x3c2d18,_0x23c5cc,_0x3c02ac,_0x439c2e,_0x137504,_0x56e09c,_0x26c8c0,_0x203516,_0x3e38fe,_0x3f5418,_0x1cb33d)=>{const _0x675f93=a592_0x364f52;let _0x6b8e75=![],_0x2320f7=![];_0x3f5418[_0x675f93(0x1f5)]&&(_0x2320f7=!_0x1cb33d&&_0x3f5418['enableLGPD']===_0x675f93(0x1ec)&&_0x3f5418[_0x675f93(0x203)]!==''&&(_0x3f5418['lgpdConsent']===_0x675f93(0x1ec)||_0x3f5418[_0x675f93(0x1d5)]===_0x675f93(0x1d4)&&(0x0,lodash_1[_0x675f93(0x205)])(_0x400bba?.[_0x675f93(0x1fe)])));const _0x3e04df=(0x0,socket_1[_0x675f93(0x1f7)])(),_0x5e081=_0x3f5418['DirectTicketsToWallets'];let _0x26f7e5=await Ticket_1[_0x675f93(0x1d6)][_0x675f93(0x1da)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x675f93(0x1e1),_0x675f93(0x1de),'group',_0x675f93(0x1e3),_0x675f93(0x1d8)]},'contactId':_0x56e09c?_0x56e09c['id']:_0x400bba['id'],'companyId':_0x3c02ac,'whatsappId':_0x3c2d18['id']},'order':[['id',_0x675f93(0x1e6)]]});if(_0x26f7e5){await(0x0,UpdateTicketService_1[_0x675f93(0x1d6)])({'ticketId':_0x26f7e5['id'],'ticketData':{'unreadMessages':_0x23c5cc,'isBot':![]},'companyId':_0x3c02ac}),_0x26f7e5=await(0x0,ShowTicketService_1[_0x675f93(0x1d6)])(_0x26f7e5['id'],_0x3c02ac);if(Number(_0x26f7e5?.[_0x675f93(0x1d3)])!==Number(_0x137504)&&_0x137504!==0x0&&_0x137504!==''&&_0x137504!=='0'&&_0x137504!==undefined||_0x439c2e!==0x0&&Number(_0x26f7e5?.[_0x675f93(0x1ee)])!==Number(_0x439c2e)&&_0x439c2e!==''&&_0x439c2e!=='0'&&_0x439c2e!==undefined)throw new AppError_1[(_0x675f93(0x1d6))](_0x675f93(0x1ea)+('Atendente:\x20'+_0x26f7e5[_0x675f93(0x1e2)][_0x675f93(0x1e5)])+_0x675f93(0x1dd)+(_0x675f93(0x1ef)+_0x26f7e5['queue'][_0x675f93(0x1e5)]));return _0x6b8e75=!![],{'ticket':_0x26f7e5,'isCreated':_0x6b8e75};}const _0x301bc3=_0x3c2d18[_0x675f93(0x1ff)];!_0x26f7e5&&_0x301bc3!==0x0&&(_0x301bc3!==0x0&&_0x301bc3!=='0'&&(_0x26f7e5=await Ticket_1[_0x675f93(0x1d6)][_0x675f93(0x1da)]({'where':{'updatedAt':{[sequelize_1['Op']['between']]:[+(0x0,date_fns_1[_0x675f93(0x1e7)])(new Date(),{'minutes':Number(_0x301bc3)}),+new Date()]},'contactId':_0x400bba['id'],'companyId':_0x3c02ac,'whatsappId':_0x3c2d18['id']},'order':[['updatedAt',_0x675f93(0x1e6)]]})),_0x26f7e5&&_0x26f7e5[_0x675f93(0x201)]!=='nps'&&await _0x26f7e5[_0x675f93(0x1f4)]({'status':_0x675f93(0x1de),'unreadMessages':_0x23c5cc,'companyId':_0x3c02ac}));if(!_0x26f7e5){const _0x3515ab={'contactId':_0x56e09c?_0x56e09c['id']:_0x400bba['id'],'status':!_0x203516&&!(0x0,lodash_1[_0x675f93(0x205)])(_0x3f5418['enableLGPD'])&&_0x2320f7&&!_0x56e09c?_0x675f93(0x1d8):_0x3c2d18['groupAsTicket']===_0x675f93(0x1ec)||!_0x56e09c?'pending':_0x675f93(0x1f1),'isGroup':!!_0x56e09c,'unreadMessages':_0x23c5cc,'whatsappId':_0x3c2d18['id'],'companyId':_0x3c02ac,'isBot':_0x56e09c?![]:!![],'channel':_0x26c8c0,'imported':_0x203516?new Date():null,'isActiveDemand':![]};if(_0x5e081&&_0x400bba['id']){const _0x551ae7=_0x400bba,_0x150d17=await _0x551ae7[_0x675f93(0x1d2)]();_0x150d17&&_0x150d17[0x0]?.['id']&&(_0x3515ab[_0x675f93(0x201)]=!_0x203516&&!(0x0,lodash_1[_0x675f93(0x205)])(_0x3f5418[_0x675f93(0x1f5)])&&_0x2320f7&&!_0x56e09c?_0x675f93(0x1d8):_0x3c2d18[_0x675f93(0x1f8)]===_0x675f93(0x1ec)||!_0x56e09c?'open':_0x675f93(0x1f1),_0x3515ab['userId']=_0x150d17[0x0]['id']);}_0x26f7e5=await Ticket_1[_0x675f93(0x1d6)]['create'](_0x3515ab),await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x26f7e5['id'],'companyId':_0x3c02ac,'whatsappId':_0x3c2d18['id'],'userId':_0x137504?_0x137504:_0x26f7e5[_0x675f93(0x1d3)]}),_0x6b8e75=!![];}_0x439c2e!=0x0&&_0x439c2e!=undefined&&await _0x26f7e5['update']({'queueId':_0x439c2e});_0x137504!=0x0&&_0x137504!=undefined&&await _0x26f7e5[_0x675f93(0x1f4)]({'userId':_0x137504});_0x26f7e5=await(0x0,ShowTicketService_1[_0x675f93(0x1d6)])(_0x26f7e5['id'],_0x3c02ac),await(0x0,CreateLogTicketService_1[_0x675f93(0x1d6)])({'ticketId':_0x26f7e5['id'],'type':_0x2320f7?_0x675f93(0x1d8):_0x675f93(0x1f9)});!_0x3e38fe&&!_0x1cb33d&&_0x3e04df['to'](_0x26f7e5[_0x675f93(0x201)])['to'](_0x675f93(0x1db))['to'](_0x26f7e5['id'][_0x675f93(0x1f2)]())[_0x675f93(0x202)]('company-'+_0x3c02ac+_0x675f93(0x1d1),{'action':_0x675f93(0x1f4),'ticket':_0x26f7e5});;return{'ticket':_0x26f7e5,'isCreated':_0x6b8e75};};exports[a592_0x364f52(0x1d6)]=FindOrCreateTicketService;