'use strict';const a535_0x164c90=a535_0x4fe2;(function(_0x31f389,_0x24223b){const _0x4c0ae6=a535_0x4fe2,_0x310b61=_0x31f389();while(!![]){try{const _0x147aac=parseInt(_0x4c0ae6(0x167))/0x1+-parseInt(_0x4c0ae6(0x14f))/0x2*(-parseInt(_0x4c0ae6(0x174))/0x3)+-parseInt(_0x4c0ae6(0x157))/0x4+parseInt(_0x4c0ae6(0x153))/0x5+-parseInt(_0x4c0ae6(0x163))/0x6+-parseInt(_0x4c0ae6(0x15c))/0x7*(-parseInt(_0x4c0ae6(0x158))/0x8)+parseInt(_0x4c0ae6(0x154))/0x9;if(_0x147aac===_0x24223b)break;else _0x310b61['push'](_0x310b61['shift']());}catch(_0x5971c2){_0x310b61['push'](_0x310b61['shift']());}}}(a535_0x3019,0x5bc5b));var __importDefault=this&&this[a535_0x164c90(0x15d)]||function(_0x23f810){const _0x412dac=a535_0x164c90;return _0x23f810&&_0x23f810[_0x412dac(0x176)]?_0x23f810:{'default':_0x23f810};};Object[a535_0x164c90(0x175)](exports,a535_0x164c90(0x176),{'value':!![]});const sequelize_1=require('sequelize'),date_fns_1=require(a535_0x164c90(0x168)),Ticket_1=__importDefault(require('../../models/Ticket')),ShowTicketService_1=__importDefault(require('./ShowTicketService')),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),lodash_1=require(a535_0x164c90(0x172)),socket_1=require('../../libs/socket'),logger_1=require(a535_0x164c90(0x16e)),CreateLogTicketService_1=__importDefault(require(a535_0x164c90(0x16c))),FindOrCreateTicketService=async(_0x3a165e,_0x155fe6,_0x45255a,_0x2c5622,_0x226e0f,_0xdc9585,_0x220381,_0x2b2e3c,_0xff1834,_0x20fe92,_0x278120)=>{const _0x4f0cac=a535_0x164c90;try{let _0xcea974=![],_0x2b8229=![];_0x278120['enableLGPD']&&(_0x2b8229=_0x278120[_0x4f0cac(0x162)]===_0x4f0cac(0x17a)&&_0x278120[_0x4f0cac(0x178)]!==''&&(_0x278120[_0x4f0cac(0x14e)]===_0x4f0cac(0x17a)||_0x278120[_0x4f0cac(0x14e)]===_0x4f0cac(0x14d)&&(0x0,lodash_1[_0x4f0cac(0x165)])(_0x3a165e[_0x4f0cac(0x16b)])));const _0x135371=(0x0,socket_1[_0x4f0cac(0x150)])();let _0xe3ca05=await Ticket_1[_0x4f0cac(0x15a)][_0x4f0cac(0x152)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x4f0cac(0x173),_0x4f0cac(0x155),'group',_0x4f0cac(0x171),_0x4f0cac(0x15f)]},'contactId':_0x220381?_0x220381['id']:_0x3a165e['id'],'companyId':_0x2c5622,'whatsappId':_0x155fe6['id']},'order':[['id','DESC']]});if(_0xe3ca05){await _0xe3ca05[_0x4f0cac(0x164)]({'unreadMessages':_0x45255a}),_0xe3ca05=await(0x0,ShowTicketService_1['default'])(_0xe3ca05['id'],_0x2c5622),_0xcea974=!![];return{'ticket':_0xe3ca05,'isCreated':_0xcea974};;}const _0x213e5f=_0x155fe6['timeCreateNewTicket'];if(!_0xe3ca05){_0x213e5f!==0x0&&(_0xe3ca05=await Ticket_1[_0x4f0cac(0x15a)][_0x4f0cac(0x152)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x4f0cac(0x151)]]:[+(0x0,date_fns_1[_0x4f0cac(0x170)])(new Date(),{'minutes':Number(_0x213e5f)}),+new Date()]},'contactId':_0x3a165e['id'],'companyId':_0x2c5622,'whatsappId':_0x155fe6['id']},'order':[[_0x4f0cac(0x166),'DESC']]}));if(_0xe3ca05&&_0xe3ca05[_0x4f0cac(0x16f)]!==_0x4f0cac(0x171))return await _0xe3ca05[_0x4f0cac(0x164)]({'status':_0x4f0cac(0x159),'unreadMessages':_0x45255a,'companyId':_0x2c5622}),_0xe3ca05=await(0x0,ShowTicketService_1[_0x4f0cac(0x15a)])(_0xe3ca05['id'],_0x2c5622),_0x135371['to']('closed')[_0x4f0cac(0x15b)](_0x4f0cac(0x177)+_0x2c5622+_0x4f0cac(0x156),{'action':_0x4f0cac(0x169),'ticketId':_0xe3ca05['id']}),{'ticket':_0xe3ca05,'isCreated':_0xcea974};}!_0xe3ca05&&(_0xe3ca05=await Ticket_1[_0x4f0cac(0x15a)][_0x4f0cac(0x16d)]({'contactId':_0x220381?_0x220381['id']:_0x3a165e['id'],'status':!_0xff1834&&!(0x0,lodash_1[_0x4f0cac(0x165)])(_0x278120[_0x4f0cac(0x162)])&&_0x2b8229&&!_0x220381?_0x4f0cac(0x15f):_0x155fe6['groupAsTicket']===_0x4f0cac(0x17a)||!_0x220381?'pending':'group','isGroup':!!_0x220381,'unreadMessages':_0x45255a,'whatsappId':_0x155fe6['id'],'companyId':_0x2c5622,'isBot':!![],'channel':_0x2b2e3c,'imported':_0xff1834?new Date():null}),await(0x0,FindOrCreateATicketTrakingService_1[_0x4f0cac(0x15a)])({'ticketId':_0xe3ca05['id'],'companyId':_0x2c5622,'whatsappId':_0x155fe6['id'],'userId':_0xe3ca05[_0x4f0cac(0x161)]}),_0xcea974=!![]);_0x226e0f!=0x0&&_0x226e0f!=undefined&&await _0xe3ca05['update']({'queueId':_0x226e0f});_0xdc9585!=0x0&&_0xdc9585!=undefined&&await _0xe3ca05[_0x4f0cac(0x164)]({'userId':_0xdc9585});_0xe3ca05=await(0x0,ShowTicketService_1[_0x4f0cac(0x15a)])(_0xe3ca05['id'],_0x2c5622),await(0x0,CreateLogTicketService_1[_0x4f0cac(0x15a)])({'ticketId':_0xe3ca05['id'],'type':_0x2b8229?_0x4f0cac(0x15f):'create'});!_0x20fe92&&_0x135371['to'](_0xe3ca05['status'])['to'](_0x4f0cac(0x160))['to'](_0xe3ca05['id'][_0x4f0cac(0x15e)]())[_0x4f0cac(0x15b)]('company-'+_0x2c5622+_0x4f0cac(0x156),{'action':_0x4f0cac(0x164),'ticket':_0xe3ca05});;return{'ticket':_0xe3ca05,'isCreated':_0xcea974};}catch(_0x1e7854){logger_1[_0x4f0cac(0x16a)]['error'](_0x4f0cac(0x179),_0x1e7854);}};exports['default']=FindOrCreateTicketService;function a535_0x4fe2(_0x25eec9,_0x3ce167){const _0x3019c1=a535_0x3019();return a535_0x4fe2=function(_0x4fe2fd,_0x1993ea){_0x4fe2fd=_0x4fe2fd-0x14d;let _0x1b240b=_0x3019c1[_0x4fe2fd];return _0x1b240b;},a535_0x4fe2(_0x25eec9,_0x3ce167);}function a535_0x3019(){const _0x4256ff=['2992782tEFnRl','update','isNil','updatedAt','143630TJHmnF','date-fns','delete','logger','lgpdAcceptedAt','./CreateLogTicketService','create','../../utils/logger','status','sub','nps','lodash','open','27yjJRFg','defineProperty','__esModule','company-','lgpdMessage','Error\x20to\x20find\x20or\x20create\x20a\x20ticket:','enabled','disabled','lgpdConsent','48842bZSvKQ','getIO','between','findOne','1899505AoJYvT','4151124cXyiYl','pending','-ticket','1700476KtrBjx','254024mrukNp','closed','default','emit','21fNfmhD','__importDefault','toString','lgpd','notification','userId','enableLGPD'];a535_0x3019=function(){return _0x4256ff;};return a535_0x3019();}