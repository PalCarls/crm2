'use strict';const a599_0xef5852=a599_0x5a90;(function(_0x27c297,_0xda6437){const _0x53736f=a599_0x5a90,_0x21f402=_0x27c297();while(!![]){try{const _0x11b1e4=-parseInt(_0x53736f(0x157))/0x1*(parseInt(_0x53736f(0x152))/0x2)+parseInt(_0x53736f(0x13d))/0x3*(-parseInt(_0x53736f(0x16c))/0x4)+parseInt(_0x53736f(0x156))/0x5*(-parseInt(_0x53736f(0x14e))/0x6)+-parseInt(_0x53736f(0x166))/0x7+parseInt(_0x53736f(0x146))/0x8+parseInt(_0x53736f(0x164))/0x9*(parseInt(_0x53736f(0x161))/0xa)+parseInt(_0x53736f(0x158))/0xb;if(_0x11b1e4===_0xda6437)break;else _0x21f402['push'](_0x21f402['shift']());}catch(_0x5f34a0){_0x21f402['push'](_0x21f402['shift']());}}}(a599_0x2435,0xcc152));function a599_0x2435(){const _0x20bd18=['update','2193280iDxqLf','toString','emit','lodash','./FindOrCreateATicketTrakingService','sequelize','status','timeCreateNewTicket','390EWIijS','isNil','findOne','name','8314GORYGy','\x20-\x20','disabled','default','64995QPWQkN','258RTWTuW','37755674KuSobi','Fila:\x20','lgpd','DirectTicketsToWallets','../../models/Ticket','date-fns','./ShowTicketService','create','user','10EXLrmp','DESC','open','4704714kdjHSw','group','1998780rBLIQZ','userId','getWallets','groupAsTicket','enableLGPD','notification','2564qncbkE','defineProperty','../../libs/socket','between','__importDefault','Atendente:\x20','5571TvvOsU','queueId','__esModule','lgpdAcceptedAt','reload','lgpdMessage','enabled','pending'];a599_0x2435=function(){return _0x20bd18;};return a599_0x2435();}function a599_0x5a90(_0x4278b3,_0x5dd683){const _0x24359e=a599_0x2435();return a599_0x5a90=function(_0x5a90b1,_0x202eb4){_0x5a90b1=_0x5a90b1-0x138;let _0x2d24da=_0x24359e[_0x5a90b1];return _0x2d24da;},a599_0x5a90(_0x4278b3,_0x5dd683);}var __importDefault=this&&this[a599_0xef5852(0x13b)]||function(_0x1a6c00){const _0x1e193f=a599_0xef5852;return _0x1a6c00&&_0x1a6c00[_0x1e193f(0x13f)]?_0x1a6c00:{'default':_0x1a6c00};};Object[a599_0xef5852(0x138)](exports,'__esModule',{'value':!![]});const sequelize_1=require(a599_0xef5852(0x14b)),date_fns_1=require(a599_0xef5852(0x15d)),Ticket_1=__importDefault(require(a599_0xef5852(0x15c))),ShowTicketService_1=__importDefault(require(a599_0xef5852(0x15e))),FindOrCreateATicketTrakingService_1=__importDefault(require(a599_0xef5852(0x14a))),lodash_1=require(a599_0xef5852(0x149)),socket_1=require(a599_0xef5852(0x139)),CreateLogTicketService_1=__importDefault(require('./CreateLogTicketService')),AppError_1=__importDefault(require('../../errors/AppError')),FindOrCreateTicketService=async(_0x1075ea,_0x49ec15,_0x13dd76,_0x272979,_0x5ef405=null,_0x2351b9=null,_0x507056,_0x548d5d,_0x17c0b3,_0x55b88a,_0x2a6508,_0x290273,_0x4c3a0c=![])=>{const _0x2ed90e=a599_0xef5852;let _0x515d17=![],_0x359648=![];_0x2a6508[_0x2ed90e(0x16a)]&&(_0x359648=!_0x290273&&_0x2a6508['enableLGPD']===_0x2ed90e(0x143)&&_0x2a6508[_0x2ed90e(0x142)]!==''&&(_0x2a6508['lgpdConsent']==='enabled'||_0x2a6508['lgpdConsent']===_0x2ed90e(0x154)&&(0x0,lodash_1['isNil'])(_0x1075ea?.[_0x2ed90e(0x140)])));const _0x5c0a99=(0x0,socket_1['getIO'])(),_0xcc7c94=_0x2a6508[_0x2ed90e(0x15b)];let _0x45a8c5=await Ticket_1[_0x2ed90e(0x155)][_0x2ed90e(0x150)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x2ed90e(0x163),'pending','group','nps','lgpd']},'contactId':_0x507056?_0x507056['id']:_0x1075ea['id'],'companyId':_0x272979,'whatsappId':_0x49ec15['id']},'order':[['id',_0x2ed90e(0x162)]]});if(_0x45a8c5){await _0x45a8c5[_0x2ed90e(0x145)]({'unreadMessages':_0x13dd76,'isBot':![]}),await _0x45a8c5[_0x2ed90e(0x141)](),_0x45a8c5=await(0x0,ShowTicketService_1['default'])(_0x45a8c5['id'],_0x272979);if(!_0x4c3a0c){if(Number(_0x45a8c5?.[_0x2ed90e(0x167)])!==Number(_0x2351b9)&&_0x2351b9!==0x0&&_0x2351b9!==''&&_0x2351b9!=='0'&&!(0x0,lodash_1[_0x2ed90e(0x14f)])(_0x2351b9)||_0x5ef405!==0x0&&Number(_0x45a8c5?.[_0x2ed90e(0x13e)])!==Number(_0x5ef405)&&_0x5ef405!==''&&_0x5ef405!=='0'&&!(0x0,lodash_1[_0x2ed90e(0x14f)])(_0x5ef405))throw new AppError_1[(_0x2ed90e(0x155))]('Ticket\x20em\x20outro\x20atendimento.\x20'+(_0x2ed90e(0x13c)+_0x45a8c5?.[_0x2ed90e(0x160)]?.[_0x2ed90e(0x151)])+_0x2ed90e(0x153)+(_0x2ed90e(0x159)+_0x45a8c5?.['queue']?.[_0x2ed90e(0x151)]));}return _0x515d17=!![],{'ticket':_0x45a8c5,'isCreated':_0x515d17};}const _0x525434=_0x49ec15[_0x2ed90e(0x14d)];!_0x45a8c5&&_0x525434!==0x0&&(_0x525434!==0x0&&_0x525434!=='0'&&(_0x45a8c5=await Ticket_1['default'][_0x2ed90e(0x150)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x2ed90e(0x13a)]]:[+(0x0,date_fns_1['sub'])(new Date(),{'minutes':Number(_0x525434)}),+new Date()]},'contactId':_0x1075ea['id'],'companyId':_0x272979,'whatsappId':_0x49ec15['id']},'order':[['updatedAt',_0x2ed90e(0x162)]]})),_0x45a8c5&&_0x45a8c5[_0x2ed90e(0x14c)]!=='nps'&&await _0x45a8c5[_0x2ed90e(0x145)]({'status':_0x2ed90e(0x144),'unreadMessages':_0x13dd76,'companyId':_0x272979}));if(!_0x45a8c5){const _0x5e2f87={'contactId':_0x507056?_0x507056['id']:_0x1075ea['id'],'status':!_0x17c0b3&&!(0x0,lodash_1['isNil'])(_0x2a6508['enableLGPD'])&&_0x359648&&!_0x507056?_0x2ed90e(0x15a):_0x49ec15[_0x2ed90e(0x169)]===_0x2ed90e(0x143)||!_0x507056?_0x2ed90e(0x144):_0x2ed90e(0x165),'isGroup':!!_0x507056,'unreadMessages':_0x13dd76,'whatsappId':_0x49ec15['id'],'companyId':_0x272979,'isBot':_0x507056?![]:!![],'channel':_0x548d5d,'imported':_0x17c0b3?new Date():null,'isActiveDemand':![]};if(_0xcc7c94&&_0x1075ea['id']){const _0x7fc337=_0x1075ea,_0xddec5c=await _0x7fc337[_0x2ed90e(0x168)]();_0xddec5c&&_0xddec5c[0x0]?.['id']&&(_0x5e2f87[_0x2ed90e(0x14c)]=!_0x17c0b3&&!(0x0,lodash_1[_0x2ed90e(0x14f)])(_0x2a6508['enableLGPD'])&&_0x359648&&!_0x507056?'lgpd':_0x49ec15[_0x2ed90e(0x169)]===_0x2ed90e(0x143)||!_0x507056?_0x2ed90e(0x163):_0x2ed90e(0x165),_0x5e2f87[_0x2ed90e(0x167)]=_0xddec5c[0x0]['id']);}_0x45a8c5=await Ticket_1[_0x2ed90e(0x155)][_0x2ed90e(0x15f)](_0x5e2f87),await(0x0,FindOrCreateATicketTrakingService_1[_0x2ed90e(0x155)])({'ticketId':_0x45a8c5['id'],'companyId':_0x272979,'whatsappId':_0x49ec15['id'],'userId':_0x2351b9?_0x2351b9:_0x45a8c5['userId']}),_0x515d17=!![];}_0x5ef405!=0x0&&_0x5ef405!=undefined&&await _0x45a8c5[_0x2ed90e(0x145)]({'queueId':_0x5ef405});_0x2351b9!=0x0&&_0x2351b9!=undefined&&await _0x45a8c5[_0x2ed90e(0x145)]({'userId':_0x2351b9});_0x45a8c5=await(0x0,ShowTicketService_1[_0x2ed90e(0x155)])(_0x45a8c5['id'],_0x272979),await(0x0,CreateLogTicketService_1[_0x2ed90e(0x155)])({'ticketId':_0x45a8c5['id'],'type':_0x359648?'lgpd':_0x2ed90e(0x15f)});!_0x55b88a&&!_0x290273&&_0x5c0a99['to'](_0x45a8c5[_0x2ed90e(0x14c)])['to'](_0x2ed90e(0x16b))['to'](_0x45a8c5['id'][_0x2ed90e(0x147)]())[_0x2ed90e(0x148)]('company-'+_0x272979+'-ticket',{'action':'update','ticket':_0x45a8c5});;return{'ticket':_0x45a8c5,'isCreated':_0x515d17};};exports[a599_0xef5852(0x155)]=FindOrCreateTicketService;