'use strict';const a592_0x1163fa=a592_0x3ccc;(function(_0x342c07,_0x22cd00){const _0x2f83cd=a592_0x3ccc,_0x242384=_0x342c07();while(!![]){try{const _0x148850=-parseInt(_0x2f83cd(0x1d7))/0x1*(parseInt(_0x2f83cd(0x1c8))/0x2)+-parseInt(_0x2f83cd(0x1c4))/0x3+parseInt(_0x2f83cd(0x1ad))/0x4*(-parseInt(_0x2f83cd(0x1ba))/0x5)+-parseInt(_0x2f83cd(0x1d3))/0x6*(-parseInt(_0x2f83cd(0x1c1))/0x7)+-parseInt(_0x2f83cd(0x1d1))/0x8+-parseInt(_0x2f83cd(0x1ce))/0x9*(-parseInt(_0x2f83cd(0x1cb))/0xa)+-parseInt(_0x2f83cd(0x1c5))/0xb*(-parseInt(_0x2f83cd(0x1b1))/0xc);if(_0x148850===_0x22cd00)break;else _0x242384['push'](_0x242384['shift']());}catch(_0x46d46e){_0x242384['push'](_0x242384['shift']());}}}(a592_0x45f8,0x5e398));function a592_0x45f8(){const _0x4262c1=['disabled','toString','709flphzg','isNil','userId','lgpdAcceptedAt','../../models/Ticket','lgpd','groupAsTicket','open','enableLGPD','4WUgPTS','./UpdateTicketService','company-','./FindOrCreateATicketTrakingService','636WPbSkL','notification','../../errors/AppError','timeCreateNewTicket','lgpdMessage','lodash','../../libs/socket','sub','findOne','2656070NvZdrP','emit','lgpdConsent','Fila:\x20','name','update','group','93597WjJDOh','date-fns','default','119448WLhuuF','259534AhxYtn','queue','\x20-\x20','994zwoLGT','enabled','Ticket\x20em\x20outro\x20atendimento.\x20','30iysUpH','pending','user','166842bBkekm','__esModule','DESC','1150640WFqFGG','sequelize','66ISFLKW','status'];a592_0x45f8=function(){return _0x4262c1;};return a592_0x45f8();}var __importDefault=this&&this['__importDefault']||function(_0x5a9c06){const _0x3e19a9=a592_0x3ccc;return _0x5a9c06&&_0x5a9c06[_0x3e19a9(0x1cf)]?_0x5a9c06:{'default':_0x5a9c06};};Object['defineProperty'](exports,'__esModule',{'value':!![]});function a592_0x3ccc(_0x123874,_0x2aa048){const _0x45f811=a592_0x45f8();return a592_0x3ccc=function(_0x3ccc2b,_0xcc3519){_0x3ccc2b=_0x3ccc2b-0x1ad;let _0x5688b4=_0x45f811[_0x3ccc2b];return _0x5688b4;},a592_0x3ccc(_0x123874,_0x2aa048);}const sequelize_1=require(a592_0x1163fa(0x1d2)),date_fns_1=require(a592_0x1163fa(0x1c2)),Ticket_1=__importDefault(require(a592_0x1163fa(0x1db))),ShowTicketService_1=__importDefault(require('./ShowTicketService')),FindOrCreateATicketTrakingService_1=__importDefault(require(a592_0x1163fa(0x1b0))),lodash_1=require(a592_0x1163fa(0x1b6)),socket_1=require(a592_0x1163fa(0x1b7)),CreateLogTicketService_1=__importDefault(require('./CreateLogTicketService')),AppError_1=__importDefault(require(a592_0x1163fa(0x1b3))),UpdateTicketService_1=__importDefault(require(a592_0x1163fa(0x1ae))),FindOrCreateTicketService=async(_0x1ff81e,_0x4927e8,_0x50a097,_0x3af649,_0x110742,_0x4a2047,_0x5d884a,_0x415aa8,_0x3f1ae7,_0x42cdd6,_0x116aa0,_0x54bd5d)=>{const _0x59c3bf=a592_0x1163fa;let _0x237760=![],_0x5ed8a9=![];_0x116aa0[_0x59c3bf(0x1df)]&&(_0x5ed8a9=!_0x54bd5d&&_0x116aa0['enableLGPD']===_0x59c3bf(0x1c9)&&_0x116aa0[_0x59c3bf(0x1b5)]!==''&&(_0x116aa0[_0x59c3bf(0x1bc)]===_0x59c3bf(0x1c9)||_0x116aa0[_0x59c3bf(0x1bc)]===_0x59c3bf(0x1d5)&&(0x0,lodash_1['isNil'])(_0x1ff81e?.[_0x59c3bf(0x1da)])));const _0x4ba383=(0x0,socket_1['getIO'])(),_0x34db07=_0x116aa0['DirectTicketsToWallets'];let _0x36fdf8=await Ticket_1[_0x59c3bf(0x1c3)]['findOne']({'where':{'status':{[sequelize_1['Op']['or']]:[_0x59c3bf(0x1de),_0x59c3bf(0x1cc),_0x59c3bf(0x1c0),'nps',_0x59c3bf(0x1dc)]},'contactId':_0x5d884a?_0x5d884a['id']:_0x1ff81e['id'],'companyId':_0x3af649,'whatsappId':_0x4927e8['id']},'order':[['id',_0x59c3bf(0x1d0)]]});if(_0x36fdf8){await(0x0,UpdateTicketService_1[_0x59c3bf(0x1c3)])({'ticketId':_0x36fdf8['id'],'ticketData':{'unreadMessages':_0x50a097,'isBot':![]},'companyId':_0x3af649}),_0x36fdf8=await(0x0,ShowTicketService_1['default'])(_0x36fdf8['id'],_0x3af649);if(Number(_0x36fdf8?.['userId'])!==Number(_0x4a2047)&&_0x4a2047!==0x0&&_0x4a2047!==''&&_0x4a2047!=='0'&&_0x4a2047!==undefined||_0x110742!==0x0&&Number(_0x36fdf8?.['queueId'])!==Number(_0x110742)&&_0x110742!==''&&_0x110742!=='0'&&_0x110742!==undefined)throw new AppError_1[(_0x59c3bf(0x1c3))](_0x59c3bf(0x1ca)+('Atendente:\x20'+_0x36fdf8[_0x59c3bf(0x1cd)][_0x59c3bf(0x1be)])+_0x59c3bf(0x1c7)+(_0x59c3bf(0x1bd)+_0x36fdf8[_0x59c3bf(0x1c6)][_0x59c3bf(0x1be)]));return _0x237760=!![],{'ticket':_0x36fdf8,'isCreated':_0x237760};}const _0x280e1d=_0x4927e8[_0x59c3bf(0x1b4)];!_0x36fdf8&&_0x280e1d!==0x0&&(_0x280e1d!==0x0&&_0x280e1d!=='0'&&(_0x36fdf8=await Ticket_1[_0x59c3bf(0x1c3)][_0x59c3bf(0x1b9)]({'where':{'updatedAt':{[sequelize_1['Op']['between']]:[+(0x0,date_fns_1[_0x59c3bf(0x1b8)])(new Date(),{'minutes':Number(_0x280e1d)}),+new Date()]},'contactId':_0x1ff81e['id'],'companyId':_0x3af649,'whatsappId':_0x4927e8['id']},'order':[['updatedAt',_0x59c3bf(0x1d0)]]})),_0x36fdf8&&_0x36fdf8[_0x59c3bf(0x1d4)]!=='nps'&&await _0x36fdf8[_0x59c3bf(0x1bf)]({'status':_0x59c3bf(0x1cc),'unreadMessages':_0x50a097,'companyId':_0x3af649}));if(!_0x36fdf8){const _0x153e42={'contactId':_0x5d884a?_0x5d884a['id']:_0x1ff81e['id'],'status':!_0x3f1ae7&&!(0x0,lodash_1[_0x59c3bf(0x1d8)])(_0x116aa0[_0x59c3bf(0x1df)])&&_0x5ed8a9&&!_0x5d884a?_0x59c3bf(0x1dc):_0x4927e8[_0x59c3bf(0x1dd)]===_0x59c3bf(0x1c9)||!_0x5d884a?_0x59c3bf(0x1cc):'group','isGroup':!!_0x5d884a,'unreadMessages':_0x50a097,'whatsappId':_0x4927e8['id'],'companyId':_0x3af649,'isBot':_0x5d884a?![]:!![],'channel':_0x415aa8,'imported':_0x3f1ae7?new Date():null,'isActiveDemand':![]};if(_0x34db07&&_0x1ff81e['id']){const _0x2b55c1=_0x1ff81e,_0x4a08e9=await _0x2b55c1['getWallets']();_0x4a08e9&&_0x4a08e9[0x0]?.['id']&&(_0x153e42[_0x59c3bf(0x1d4)]=!_0x3f1ae7&&!(0x0,lodash_1['isNil'])(_0x116aa0[_0x59c3bf(0x1df)])&&_0x5ed8a9&&!_0x5d884a?_0x59c3bf(0x1dc):_0x4927e8[_0x59c3bf(0x1dd)]===_0x59c3bf(0x1c9)||!_0x5d884a?_0x59c3bf(0x1de):'group',_0x153e42[_0x59c3bf(0x1d9)]=_0x4a08e9[0x0]['id']);}_0x36fdf8=await Ticket_1[_0x59c3bf(0x1c3)]['create'](_0x153e42),await(0x0,FindOrCreateATicketTrakingService_1[_0x59c3bf(0x1c3)])({'ticketId':_0x36fdf8['id'],'companyId':_0x3af649,'whatsappId':_0x4927e8['id'],'userId':_0x4a2047?_0x4a2047:_0x36fdf8[_0x59c3bf(0x1d9)]}),_0x237760=!![];}_0x110742!=0x0&&_0x110742!=undefined&&await _0x36fdf8[_0x59c3bf(0x1bf)]({'queueId':_0x110742});_0x4a2047!=0x0&&_0x4a2047!=undefined&&await _0x36fdf8['update']({'userId':_0x4a2047});_0x36fdf8=await(0x0,ShowTicketService_1['default'])(_0x36fdf8['id'],_0x3af649),await(0x0,CreateLogTicketService_1['default'])({'ticketId':_0x36fdf8['id'],'type':_0x5ed8a9?_0x59c3bf(0x1dc):'create'});!_0x42cdd6&&!_0x54bd5d&&_0x4ba383['to'](_0x36fdf8['status'])['to'](_0x59c3bf(0x1b2))['to'](_0x36fdf8['id'][_0x59c3bf(0x1d6)]())[_0x59c3bf(0x1bb)](_0x59c3bf(0x1af)+_0x3af649+'-ticket',{'action':_0x59c3bf(0x1bf),'ticket':_0x36fdf8});;return{'ticket':_0x36fdf8,'isCreated':_0x237760};};exports[a592_0x1163fa(0x1c3)]=FindOrCreateTicketService;