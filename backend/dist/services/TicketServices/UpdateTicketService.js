'use strict';const a526_0x442cd7=a526_0x2d87;(function(_0x1c9653,_0x52e263){const _0x1c024b=a526_0x2d87,_0x4f9d6a=_0x1c9653();while(!![]){try{const _0x34872e=-parseInt(_0x1c024b(0x189))/0x1*(parseInt(_0x1c024b(0x13e))/0x2)+parseInt(_0x1c024b(0x15c))/0x3*(parseInt(_0x1c024b(0x149))/0x4)+parseInt(_0x1c024b(0x159))/0x5*(parseInt(_0x1c024b(0x13a))/0x6)+-parseInt(_0x1c024b(0x18d))/0x7*(-parseInt(_0x1c024b(0x161))/0x8)+parseInt(_0x1c024b(0x16c))/0x9+-parseInt(_0x1c024b(0x139))/0xa+-parseInt(_0x1c024b(0x134))/0xb*(parseInt(_0x1c024b(0x17f))/0xc);if(_0x34872e===_0x52e263)break;else _0x4f9d6a['push'](_0x4f9d6a['shift']());}catch(_0x32c5ca){_0x4f9d6a['push'](_0x4f9d6a['shift']());}}}(a526_0x2a6f,0x2c3d2));function a526_0x2a6f(){const _0x38636f=['16818SEktFi','sequelize','findOne','toString','571672KehMGp','log','open','farewellMessage','../../helpers/GetTicketWbot','defineProperty','@sentry/node','closed','*\x20e\x20será\x20atendido\x20por\x20*','getOwnPropertyDescriptor','queueOptionId','12icYfCj','-ticket','contact','includes','../../libs/socket','lodash','../UserServices/ShowUserService','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','../WbotServices/wbotMessageListener','Checking\x20if\x20','moment','s.whatsapp.net','queueId','userRating','../../helpers/SetTicketMessagesAsRead','queue','35nUzvfd','nps','sendFarewellWaitingTicket','325590LtdwzK','value','name','../FacebookServices/sendFacebookMessage','update','559144jmBcCx','notification','instagram','../../models/Ticket','findByPk','amountUsedBotQueues','pending','toDate','getIO','facebook','reload','3046581LCvpsW','isNil','status','enabled','channel','number','whatsappId','color','../WhatsappService/ShowWhatsAppService','captureException','lastMessage','g.us','__createBinding','verifyMessage','../SettingServices/ListSettingsServiceOne','*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','default','../../models/Setting','finishedAt','47004LJWaux','\x20is\x20a\x20valid\x20','\x20contact','contactId','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','user','save','./FindOrCreateATicketTrakingService','userId','../../models/Queue','1Ewmubz','company-','../../models/User','queuedAt','35jwZkQT','./ShowTicketService','isBot','indexOf','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','__esModule','emit','delete','1243MPXAsC','create','whatsapp','sendMessage','isGroup','1235260JocGNb'];a526_0x2a6f=function(){return _0x38636f;};return a526_0x2a6f();}var __createBinding=this&&this[a526_0x442cd7(0x178)]||(Object[a526_0x442cd7(0x135)]?function(_0xfc9fde,_0x58ddf4,_0x383425,_0x1fb039){const _0x1ad0d2=a526_0x442cd7;if(_0x1fb039===undefined)_0x1fb039=_0x383425;var _0x48e21c=Object[_0x1ad0d2(0x147)](_0x58ddf4,_0x383425);(!_0x48e21c||('get'in _0x48e21c?!_0x58ddf4[_0x1ad0d2(0x131)]:_0x48e21c['writable']||_0x48e21c['configurable']))&&(_0x48e21c={'enumerable':!![],'get':function(){return _0x58ddf4[_0x383425];}}),Object[_0x1ad0d2(0x143)](_0xfc9fde,_0x1fb039,_0x48e21c);}:function(_0x3f90ae,_0x2f8a28,_0xaa7d56,_0x560943){if(_0x560943===undefined)_0x560943=_0xaa7d56;_0x3f90ae[_0x560943]=_0x2f8a28[_0xaa7d56];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a526_0x442cd7(0x135)]?function(_0x77e63,_0x3787af){const _0x26f24a=a526_0x442cd7;Object[_0x26f24a(0x143)](_0x77e63,'default',{'enumerable':!![],'value':_0x3787af});}:function(_0x459f24,_0x28b145){const _0x57de7c=a526_0x442cd7;_0x459f24[_0x57de7c(0x17c)]=_0x28b145;}),__importStar=this&&this['__importStar']||function(_0x21d664){const _0x305b60=a526_0x442cd7;if(_0x21d664&&_0x21d664[_0x305b60(0x131)])return _0x21d664;var _0x1c1e7e={};if(_0x21d664!=null){for(var _0x639689 in _0x21d664)if(_0x639689!==_0x305b60(0x17c)&&Object['prototype']['hasOwnProperty']['call'](_0x21d664,_0x639689))__createBinding(_0x1c1e7e,_0x21d664,_0x639689);}return __setModuleDefault(_0x1c1e7e,_0x21d664),_0x1c1e7e;},__importDefault=this&&this['__importDefault']||function(_0x5003e8){const _0x516101=a526_0x442cd7;return _0x5003e8&&_0x5003e8[_0x516101(0x131)]?_0x5003e8:{'default':_0x5003e8};};function a526_0x2d87(_0x12ded1,_0x3b2e54){const _0x2a6f0c=a526_0x2a6f();return a526_0x2d87=function(_0x2d87ce,_0x554e19){_0x2d87ce=_0x2d87ce-0x12e;let _0x5ac9fa=_0x2a6f0c[_0x2d87ce];return _0x5ac9fa;},a526_0x2d87(_0x12ded1,_0x3b2e54);}Object[a526_0x442cd7(0x143)](exports,a526_0x442cd7(0x131),{'value':!![]});const moment_1=__importDefault(require(a526_0x442cd7(0x153))),Sentry=__importStar(require(a526_0x442cd7(0x144))),sequelize_1=require(a526_0x442cd7(0x13b)),SetTicketMessagesAsRead_1=__importDefault(require(a526_0x442cd7(0x157))),socket_1=require(a526_0x442cd7(0x14d)),Ticket_1=__importDefault(require(a526_0x442cd7(0x164))),Setting_1=__importDefault(require(a526_0x442cd7(0x17d))),Queue_1=__importDefault(require(a526_0x442cd7(0x188))),ShowTicketService_1=__importDefault(require(a526_0x442cd7(0x18e))),ShowWhatsAppService_1=__importDefault(require(a526_0x442cd7(0x174))),SendWhatsAppMessage_1=__importDefault(require('../WbotServices/SendWhatsAppMessage')),FindOrCreateATicketTrakingService_1=__importDefault(require(a526_0x442cd7(0x186))),GetTicketWbot_1=__importDefault(require(a526_0x442cd7(0x142))),wbotMessageListener_1=require(a526_0x442cd7(0x151)),lodash_1=require(a526_0x442cd7(0x14e)),ListSettingsServiceOne_1=__importDefault(require(a526_0x442cd7(0x17a))),sendFacebookMessage_1=__importDefault(require(a526_0x442cd7(0x15f))),ShowUserService_1=__importDefault(require(a526_0x442cd7(0x14f))),User_1=__importDefault(require(a526_0x442cd7(0x18b))),UpdateTicketService=async({ticketData:_0x454b69,ticketId:_0xc5f8c7,companyId:_0x326475})=>{const _0x5a62af=a526_0x442cd7;try{const {status:_0x24a9c5}=_0x454b69;let {queueId:_0x59fa6c,userId:_0xc466c3,sendFarewellMessage:_0x389c52,amountUsedBotQueues:_0x507c6e,lastMessage:_0x36d230}=_0x454b69,_0x5b2f00=_0x454b69[_0x5a62af(0x12e)]||![],_0x55b35b=_0x454b69[_0x5a62af(0x148)]||null;const _0x3eaf18=(0x0,socket_1[_0x5a62af(0x169)])(),_0x382ada=await Setting_1['default'][_0x5a62af(0x13c)]({'where':{'companyId':_0x326475,'key':_0x5a62af(0x156)}});let _0x4d3adb=await Setting_1['default']['findOne']({'where':{'key':_0x5a62af(0x15b),'companyId':_0x326475}});const _0x113983=await(0x0,ShowTicketService_1[_0x5a62af(0x17c)])(_0xc5f8c7,_0x326475);_0x113983[_0x5a62af(0x170)]===_0x5a62af(0x136)&&await(0x0,SetTicketMessagesAsRead_1[_0x5a62af(0x17c)])(_0x113983);const _0x1186eb=_0x113983?.[_0x5a62af(0x16e)],_0x2b9d32=_0x113983['user']?.['id'],_0x141b7a=_0x113983?.[_0x5a62af(0x155)];if(_0x1186eb===_0x5a62af(0x145)){const _0x51cf56=await Ticket_1[_0x5a62af(0x17c)][_0x5a62af(0x13c)]({'where':{'contactId':_0x113983[_0x5a62af(0x182)],'status':{[sequelize_1['Op']['or']]:[_0x5a62af(0x140),_0x5a62af(0x167),'group']},'whatsappId':_0x113983[_0x5a62af(0x172)]},'include':[{'model':Queue_1[_0x5a62af(0x17c)],'as':_0x5a62af(0x158),'attributes':['id',_0x5a62af(0x15e),_0x5a62af(0x173)]},{'model':User_1[_0x5a62af(0x17c)],'as':_0x5a62af(0x184),'attributes':['id','name']}]});if(_0x51cf56){if(_0x51cf56['id']!==_0x113983['id'])return{'ticket':_0x51cf56,'oldStatus':_0x1186eb,'oldUserId':_0x2b9d32};}_0x5b2f00=![];}const _0x16624e=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0xc5f8c7,'companyId':_0x326475,'whatsappId':_0x113983['whatsappId']});if(_0x24a9c5!==undefined&&[_0x5a62af(0x145)][_0x5a62af(0x12f)](_0x24a9c5)>-0x1){const {complationMessage:_0x21b687,ratingMessage:_0x228323}=await(0x0,ShowWhatsAppService_1[_0x5a62af(0x17c)])(_0x113983['whatsappId'],_0x326475);if(_0x382ada?.[_0x5a62af(0x15d)]===_0x5a62af(0x16f)&&(_0x389c52||_0x389c52===undefined)&&(!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x228323)&&_0x228323!=='')&&!_0x113983[_0x5a62af(0x138)]){if(_0x16624e['ratingAt']==null){const _0xc17d49=_0x228323||'';let _0x50a0ac='‎'+_0xc17d49+'\x0a';if(_0x113983['channel']==='whatsapp'){const _0x4a2cd6=await(0x0,SendWhatsAppMessage_1[_0x5a62af(0x17c)])({'body':_0x50a0ac,'ticket':_0x113983});await(0x0,wbotMessageListener_1[_0x5a62af(0x179)])(_0x4a2cd6,_0x113983,_0x113983[_0x5a62af(0x14b)]);}if([_0x5a62af(0x16a),'instagram'][_0x5a62af(0x14c)](_0x113983[_0x5a62af(0x170)])){console[_0x5a62af(0x13f)](_0x5a62af(0x152)+_0x113983[_0x5a62af(0x14b)][_0x5a62af(0x171)]+_0x5a62af(0x180)+_0x113983[_0x5a62af(0x170)]+_0x5a62af(0x181));const _0x20e5da=await(0x0,sendFacebookMessage_1[_0x5a62af(0x17c)])({'body':_0x50a0ac,'ticket':_0x113983});await(0x0,wbotMessageListener_1[_0x5a62af(0x179)])(_0x20e5da,_0x113983,_0x113983['contact']);}return await _0x16624e[_0x5a62af(0x160)]({'userId':_0x113983[_0x5a62af(0x187)],'closedAt':(0x0,moment_1[_0x5a62af(0x17c)])()[_0x5a62af(0x168)]()}),await _0x113983['update']({'status':_0x5a62af(0x15a),'amountUseBotQueuesNPS':0x1}),_0x3eaf18['to'](_0x5a62af(0x140))['to'](_0xc5f8c7[_0x5a62af(0x13d)]())[_0x5a62af(0x132)]('company-'+_0x113983['companyId']+'-ticket',{'action':_0x5a62af(0x133),'ticketId':_0x113983['id']}),{'ticket':_0x113983,'oldStatus':_0x1186eb,'oldUserId':_0x2b9d32};}}if(!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x21b687)&&_0x21b687!==''&&(_0x389c52||_0x389c52===undefined)){const _0x11145f=_0x113983[_0x5a62af(0x187)]||_0xc466c3,_0x312994=await User_1[_0x5a62af(0x17c)]['findByPk'](_0x11145f);let _0x5a0899;if(_0x113983['status']!==_0x5a62af(0x167)||_0x113983[_0x5a62af(0x16e)]===_0x5a62af(0x167)&&_0x4d3adb?.[_0x5a62af(0x15d)]===_0x5a62af(0x16f)){_0x312994['farewellMessage']?_0x5a0899='‎'+_0x312994[_0x5a62af(0x141)]:_0x5a0899='‎'+_0x21b687;if(_0x113983['channel']===_0x5a62af(0x136)&&!_0x113983[_0x5a62af(0x138)]){const _0x7c9541=await(0x0,SendWhatsAppMessage_1[_0x5a62af(0x17c)])({'body':_0x5a0899,'ticket':_0x113983});await(0x0,wbotMessageListener_1[_0x5a62af(0x179)])(_0x7c9541,_0x113983,_0x113983[_0x5a62af(0x14b)]);}[_0x5a62af(0x16a),_0x5a62af(0x163)][_0x5a62af(0x14c)](_0x113983[_0x5a62af(0x170)])&&!_0x113983['isGroup']&&(console['log']('Checking\x20if\x20'+_0x113983[_0x5a62af(0x14b)][_0x5a62af(0x171)]+'\x20is\x20a\x20valid\x20'+_0x113983['channel']+'\x20contact'),await(0x0,sendFacebookMessage_1[_0x5a62af(0x17c)])({'body':_0x5a0899,'ticket':_0x113983}));}}_0x16624e[_0x5a62af(0x17e)]=(0x0,moment_1['default'])()[_0x5a62af(0x168)](),_0x16624e['closedAt']=(0x0,moment_1[_0x5a62af(0x17c)])()['toDate'](),_0x16624e[_0x5a62af(0x172)]=_0x113983['whatsappId'],_0x16624e[_0x5a62af(0x187)]=_0x113983[_0x5a62af(0x187)];}!(0x0,lodash_1['isNil'])(_0x59fa6c)&&(_0x16624e[_0x5a62af(0x18c)]=(0x0,moment_1[_0x5a62af(0x17c)])()[_0x5a62af(0x168)]());const _0x4bc377=await(0x0,ListSettingsServiceOne_1['default'])({'companyId':_0x326475,'key':'sendMsgTransfTicket'});if(_0x4bc377?.[_0x5a62af(0x15d)]===_0x5a62af(0x16f)){if(_0x141b7a!==_0x59fa6c&&_0x2b9d32===_0xc466c3&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x141b7a)&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x59fa6c)){const _0x2b8547=await Queue_1[_0x5a62af(0x17c)][_0x5a62af(0x165)](_0x59fa6c),_0x52c102=await(0x0,GetTicketWbot_1[_0x5a62af(0x17c)])(_0x113983),_0x104199=_0x5a62af(0x183)+_0x2b8547?.[_0x5a62af(0x15e)]+_0x5a62af(0x130),_0x3ae3cd=await _0x52c102[_0x5a62af(0x137)](_0x113983[_0x5a62af(0x14b)][_0x5a62af(0x171)]+'@'+(_0x113983[_0x5a62af(0x138)]?'g.us':_0x5a62af(0x154)),{'text':_0x104199});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x3ae3cd,_0x113983,_0x113983[_0x5a62af(0x14b)],_0x16624e);}else{if(_0x2b9d32!==_0xc466c3&&_0x141b7a===_0x59fa6c&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x2b9d32)&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0xc466c3)&&!_0x113983[_0x5a62af(0x138)]){const _0xe19ca6=await(0x0,GetTicketWbot_1[_0x5a62af(0x17c)])(_0x113983),_0x16d74c=await(0x0,ShowUserService_1['default'])(_0x454b69[_0x5a62af(0x187)]),_0x452d0d='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*'+_0x16d74c[_0x5a62af(0x15e)]+_0x5a62af(0x150),_0x18f3bf=await _0xe19ca6[_0x5a62af(0x137)](_0x113983[_0x5a62af(0x14b)]['number']+'@'+(_0x113983[_0x5a62af(0x138)]?_0x5a62af(0x177):_0x5a62af(0x154)),{'text':_0x452d0d});await(0x0,wbotMessageListener_1[_0x5a62af(0x179)])(_0x18f3bf,_0x113983,_0x113983[_0x5a62af(0x14b)],_0x16624e);}else{if(_0x2b9d32!==_0xc466c3&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x2b9d32)&&!(0x0,lodash_1['isNil'])(_0xc466c3)&&_0x141b7a!==_0x59fa6c&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x141b7a)&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x59fa6c)){const _0x7ee315=await(0x0,GetTicketWbot_1['default'])(_0x113983),_0x4f11d8=await Queue_1[_0x5a62af(0x17c)][_0x5a62af(0x165)](_0x59fa6c),_0x432450=await(0x0,ShowUserService_1[_0x5a62af(0x17c)])(_0x454b69[_0x5a62af(0x187)]),_0x1c56b7=_0x5a62af(0x183)+_0x4f11d8?.[_0x5a62af(0x15e)]+_0x5a62af(0x146)+_0x432450[_0x5a62af(0x15e)]+_0x5a62af(0x150),_0x5ac3ca=await _0x7ee315[_0x5a62af(0x137)](_0x113983['contact']['number']+'@'+(_0x113983[_0x5a62af(0x138)]?_0x5a62af(0x177):'s.whatsapp.net'),{'text':_0x1c56b7});await(0x0,wbotMessageListener_1[_0x5a62af(0x179)])(_0x5ac3ca,_0x113983,_0x113983[_0x5a62af(0x14b)]);}else{if(_0x2b9d32!==undefined&&(0x0,lodash_1[_0x5a62af(0x16d)])(_0xc466c3)&&_0x141b7a!==_0x59fa6c&&!(0x0,lodash_1[_0x5a62af(0x16d)])(_0x59fa6c)){const _0x38a78d=await Queue_1[_0x5a62af(0x17c)][_0x5a62af(0x165)](_0x59fa6c),_0x4c2d24=await(0x0,GetTicketWbot_1[_0x5a62af(0x17c)])(_0x113983),_0x5dffa0=_0x5a62af(0x17b)+_0x38a78d?.[_0x5a62af(0x15e)]+_0x5a62af(0x150),_0xa54670=await _0x4c2d24[_0x5a62af(0x137)](_0x113983[_0x5a62af(0x14b)][_0x5a62af(0x171)]+'@'+(_0x113983[_0x5a62af(0x138)]?'g.us':_0x5a62af(0x154)),{'text':_0x5dffa0});await(0x0,wbotMessageListener_1[_0x5a62af(0x179)])(_0xa54670,_0x113983,_0x113983[_0x5a62af(0x14b)]);}}}}}return await _0x113983['update']({'status':_0x24a9c5,'queueId':_0x59fa6c,'userId':_0xc466c3,'isBot':_0x5b2f00,'queueOptionId':_0x55b35b,'amountUsedBotQueues':_0x24a9c5===_0x5a62af(0x145)?0x0:_0x507c6e?_0x507c6e:_0x113983[_0x5a62af(0x166)],'lastMessage':_0x36d230?_0x36d230:_0x113983[_0x5a62af(0x176)]}),_0x16624e[_0x5a62af(0x18c)]=(0x0,moment_1[_0x5a62af(0x17c)])()[_0x5a62af(0x168)](),_0x16624e[_0x5a62af(0x155)]=_0x59fa6c,await _0x113983[_0x5a62af(0x16b)](),_0x24a9c5!==undefined&&[_0x5a62af(0x167)]['indexOf'](_0x24a9c5)>-0x1&&_0x16624e[_0x5a62af(0x160)]({'whatsappId':_0x113983[_0x5a62af(0x172)],'startedAt':null,'userId':null}),_0x24a9c5!==undefined&&[_0x5a62af(0x140)][_0x5a62af(0x12f)](_0x24a9c5)>-0x1&&_0x16624e[_0x5a62af(0x160)]({'startedAt':(0x0,moment_1[_0x5a62af(0x17c)])()[_0x5a62af(0x168)](),'ratingAt':null,'rated':![],'whatsappId':_0x113983[_0x5a62af(0x172)],'userId':_0x113983[_0x5a62af(0x187)],'queueId':_0x113983['queueId']}),(_0x113983['status']!==_0x1186eb||_0x113983[_0x5a62af(0x184)]?.['id']!==_0x2b9d32)&&(_0x16624e['update']({'userId':_0x113983[_0x5a62af(0x187)]}),_0x3eaf18['to'](_0x1186eb)['emit'](_0x5a62af(0x18a)+_0x326475+_0x5a62af(0x14a),{'action':_0x5a62af(0x133),'ticketId':_0x113983['id']})),await _0x16624e[_0x5a62af(0x185)](),_0x3eaf18['to'](_0x113983['status'])['to'](_0x5a62af(0x162))['to'](_0xc5f8c7[_0x5a62af(0x13d)]())['emit'](_0x5a62af(0x18a)+_0x326475+_0x5a62af(0x14a),{'action':'update','ticket':_0x113983,'ticketId':_0xc5f8c7}),{'ticket':_0x113983,'oldStatus':_0x1186eb,'oldUserId':_0x2b9d32};}catch(_0x591a17){Sentry[_0x5a62af(0x175)](_0x591a17);}};exports[a526_0x442cd7(0x17c)]=UpdateTicketService;