'use strict';const a607_0x50ec47=a607_0x4f41;(function(_0x24f9ca,_0x200506){const _0x381566=a607_0x4f41,_0x31b444=_0x24f9ca();while(!![]){try{const _0x12d730=parseInt(_0x381566(0x1b2))/0x1*(-parseInt(_0x381566(0x1ae))/0x2)+-parseInt(_0x381566(0x191))/0x3*(-parseInt(_0x381566(0x17c))/0x4)+parseInt(_0x381566(0x1d1))/0x5*(parseInt(_0x381566(0x1c9))/0x6)+parseInt(_0x381566(0x1b3))/0x7*(parseInt(_0x381566(0x1d2))/0x8)+parseInt(_0x381566(0x19f))/0x9+-parseInt(_0x381566(0x1c7))/0xa*(-parseInt(_0x381566(0x17b))/0xb)+-parseInt(_0x381566(0x167))/0xc;if(_0x12d730===_0x200506)break;else _0x31b444['push'](_0x31b444['shift']());}catch(_0x2db0e){_0x31b444['push'](_0x31b444['shift']());}}}(a607_0x25ae,0x283a7));function a607_0x4f41(_0x4d583c,_0x48c9da){const _0x25aebd=a607_0x25ae();return a607_0x4f41=function(_0x4f4167,_0x9e5c2a){_0x4f4167=_0x4f4167-0x165;let _0x389435=_0x25aebd[_0x4f4167];return _0x389435;},a607_0x4f41(_0x4d583c,_0x48c9da);}var __createBinding=this&&this[a607_0x50ec47(0x184)]||(Object[a607_0x50ec47(0x19b)]?function(_0xd931e,_0x350374,_0x255a0e,_0x3e0500){const _0x5b7d5e=a607_0x50ec47;if(_0x3e0500===undefined)_0x3e0500=_0x255a0e;var _0x529043=Object[_0x5b7d5e(0x1ba)](_0x350374,_0x255a0e);(!_0x529043||(_0x5b7d5e(0x1ad)in _0x529043?!_0x350374[_0x5b7d5e(0x1c5)]:_0x529043['writable']||_0x529043[_0x5b7d5e(0x198)]))&&(_0x529043={'enumerable':!![],'get':function(){return _0x350374[_0x255a0e];}}),Object[_0x5b7d5e(0x18e)](_0xd931e,_0x3e0500,_0x529043);}:function(_0x2e4a78,_0x4db437,_0x3bcc8e,_0x1b00e8){if(_0x1b00e8===undefined)_0x1b00e8=_0x3bcc8e;_0x2e4a78[_0x1b00e8]=_0x4db437[_0x3bcc8e];}),__setModuleDefault=this&&this[a607_0x50ec47(0x181)]||(Object['create']?function(_0x5e6c02,_0xec021e){Object['defineProperty'](_0x5e6c02,'default',{'enumerable':!![],'value':_0xec021e});}:function(_0x35b4ef,_0x2509ca){const _0x195bf3=a607_0x50ec47;_0x35b4ef[_0x195bf3(0x171)]=_0x2509ca;}),__importStar=this&&this['__importStar']||function(_0x4d2e32){const _0xf0751=a607_0x50ec47;if(_0x4d2e32&&_0x4d2e32[_0xf0751(0x1c5)])return _0x4d2e32;var _0x58d38a={};if(_0x4d2e32!=null){for(var _0x5141bc in _0x4d2e32)if(_0x5141bc!=='default'&&Object[_0xf0751(0x16b)][_0xf0751(0x1b5)][_0xf0751(0x166)](_0x4d2e32,_0x5141bc))__createBinding(_0x58d38a,_0x4d2e32,_0x5141bc);}return __setModuleDefault(_0x58d38a,_0x4d2e32),_0x58d38a;},__importDefault=this&&this[a607_0x50ec47(0x1c1)]||function(_0xc4793e){const _0x26e716=a607_0x50ec47;return _0xc4793e&&_0xc4793e[_0x26e716(0x1c5)]?_0xc4793e:{'default':_0xc4793e};};Object['defineProperty'](exports,a607_0x50ec47(0x1c5),{'value':!![]});const moment_1=__importDefault(require(a607_0x50ec47(0x17f))),Sentry=__importStar(require('@sentry/node')),sequelize_1=require('sequelize'),SetTicketMessagesAsRead_1=__importDefault(require(a607_0x50ec47(0x1ab))),socket_1=require(a607_0x50ec47(0x183)),Ticket_1=__importDefault(require(a607_0x50ec47(0x1ca))),Queue_1=__importDefault(require(a607_0x50ec47(0x19a))),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require(a607_0x50ec47(0x1b4))),SendWhatsAppMessage_1=__importDefault(require(a607_0x50ec47(0x168))),FindOrCreateATicketTrakingService_1=__importDefault(require(a607_0x50ec47(0x1a9))),GetTicketWbot_1=__importDefault(require('../../helpers/GetTicketWbot')),wbotMessageListener_1=require(a607_0x50ec47(0x1a0)),lodash_1=require(a607_0x50ec47(0x186)),sendFacebookMessage_1=__importDefault(require(a607_0x50ec47(0x172))),facebookMessageListener_1=require(a607_0x50ec47(0x1ac)),ShowUserService_1=__importDefault(require(a607_0x50ec47(0x188))),User_1=__importDefault(require('../../models/User')),CompaniesSettings_1=__importDefault(require(a607_0x50ec47(0x1bd))),CreateLogTicketService_1=__importDefault(require(a607_0x50ec47(0x16e))),TicketTag_1=__importDefault(require(a607_0x50ec47(0x180))),Tag_1=__importDefault(require('../../models/Tag')),CreateMessageService_1=__importDefault(require(a607_0x50ec47(0x165))),FindOrCreateTicketService_1=__importDefault(require('./FindOrCreateTicketService')),UpdateTicketService=async({ticketData:_0x37b7a9,ticketId:_0x29a310,companyId:_0x11236e})=>{const _0x368153=a607_0x50ec47;try{let {status:_0x48b431}=_0x37b7a9,{queueId:_0x2f7f10,userId:_0x3a62ee,sendFarewellMessage:_0x1db31c,amountUsedBotQueues:_0x595cf7,lastMessage:_0x3ea7cc,integrationId:_0x2d96cd,useIntegration:_0x291199,unreadMessages:_0x526d61,msgTransfer:_0x5b4da8,isTransfered:isTransfered=![]}=_0x37b7a9,_0x50fda2=_0x37b7a9[_0x368153(0x1a4)]||![],_0x8b55ac=_0x37b7a9[_0x368153(0x1d0)]||null;const _0x2c6c5f=(0x0,socket_1[_0x368153(0x190)])(),_0x765eba=await CompaniesSettings_1['default'][_0x368153(0x1a1)]({'where':{'companyId':_0x11236e}});let _0x30755b=await(0x0,ShowTicketService_1[_0x368153(0x171)])(_0x29a310,_0x11236e);_0x30755b['channel']===_0x368153(0x192)&&await(0x0,SetTicketMessagesAsRead_1[_0x368153(0x171)])(_0x30755b);const _0x4000f6=_0x30755b?.['status'],_0x3481d6=_0x30755b[_0x368153(0x1aa)]?.['id'],_0x467f0c=_0x30755b?.[_0x368153(0x185)];if(_0x4000f6===_0x368153(0x1cc)){let _0x5d9041=await Ticket_1[_0x368153(0x171)][_0x368153(0x1a1)]({'where':{'contactId':_0x30755b['contactId'],'status':{[sequelize_1['Op']['or']]:['open',_0x368153(0x169),_0x368153(0x175)]},'whatsappId':_0x30755b[_0x368153(0x18c)]}});if(_0x5d9041){if(_0x5d9041['id']!==_0x30755b['id'])return _0x5d9041=await(0x0,ShowTicketService_1['default'])(_0x5d9041['id'],_0x11236e),{'ticket':_0x5d9041,'oldStatus':_0x4000f6,'oldUserId':_0x3481d6};}_0x50fda2=![];}const _0x4a2168=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x29a310,'companyId':_0x11236e,'whatsappId':_0x30755b['whatsappId']}),{complationMessage:_0x5f3ef2,ratingMessage:_0x449578,groupAsTicket:_0x39b4ac}=await(0x0,ShowWhatsAppService_1[_0x368153(0x171)])(_0x30755b[_0x368153(0x18c)],_0x11236e);if(_0x48b431!==undefined&&[_0x368153(0x1cc)][_0x368153(0x174)](_0x48b431)>-0x1){const _0x1c7279=_0x30755b[_0x368153(0x16a)]||_0x3a62ee,_0x422eed=await User_1[_0x368153(0x171)][_0x368153(0x19d)](_0x1c7279);if(_0x765eba[_0x368153(0x1c8)]===_0x368153(0x1d6)&&(_0x1db31c||_0x1db31c===undefined)&&(!(0x0,lodash_1[_0x368153(0x1a7)])(_0x449578)&&_0x449578!=='')&&!_0x30755b[_0x368153(0x1c4)]){if(_0x4a2168[_0x368153(0x1af)]==null){const _0x547a86=_0x449578||'';let _0x3b910f='‎\x20'+_0x547a86+'\x0a';if(_0x30755b[_0x368153(0x1c0)]===_0x368153(0x192)){const _0x2503f7=await(0x0,SendWhatsAppMessage_1[_0x368153(0x171)])({'body':_0x3b910f,'ticket':_0x30755b,'isForwarded':![]});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x2503f7,_0x30755b,_0x30755b[_0x368153(0x182)]);}else{if(['facebook',_0x368153(0x16c)]['includes'](_0x30755b['channel'])){console[_0x368153(0x1a2)](_0x368153(0x197)+_0x30755b['contact']['number']+_0x368153(0x1bf)+_0x30755b['channel']+'\x20contact');const _0x43e595=await(0x0,sendFacebookMessage_1[_0x368153(0x171)])({'body':_0x3b910f,'ticket':_0x30755b});await(0x0,facebookMessageListener_1['verifyMessageFace'])(_0x43e595,_0x3b910f,_0x30755b,_0x30755b['contact']);}}await _0x4a2168[_0x368153(0x17d)]({'userId':_0x30755b[_0x368153(0x16a)],'closedAt':(0x0,moment_1[_0x368153(0x171)])()[_0x368153(0x19c)]()}),await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x30755b[_0x368153(0x16a)],'queueId':_0x30755b[_0x368153(0x185)],'ticketId':_0x29a310,'type':_0x368153(0x1a6)});try{const _0x45fec3=await TicketTag_1['default'][_0x368153(0x189)]({'where':{'ticketId':_0x29a310}}),_0x4a88b4=_0x45fec3[_0x368153(0x1b7)](_0x3e898a=>_0x3e898a[_0x368153(0x1c6)]),_0x1b98e5=await Tag_1[_0x368153(0x171)][_0x368153(0x189)]({'where':{'id':_0x4a88b4,'kanban':0x1}}),_0x44e159=_0x1b98e5['map'](_0x1f5859=>_0x1f5859['id']);if(_0x44e159)await TicketTag_1[_0x368153(0x171)][_0x368153(0x1ce)]({'where':{'ticketId':_0x29a310,'tagId':_0x44e159}});}catch(_0x468f01){Sentry[_0x368153(0x196)](_0x468f01);}return await _0x30755b[_0x368153(0x17d)]({'status':_0x368153(0x1a6),'amountUsedBotQueuesNPS':0x1}),_0x2c6c5f['to']('open')['to'](_0x29a310['toString']())[_0x368153(0x179)](_0x368153(0x16f)+_0x30755b['companyId']+_0x368153(0x1b8),{'action':_0x368153(0x1b9),'ticketId':_0x30755b['id']}),{'ticket':_0x30755b,'oldStatus':_0x4000f6,'oldUserId':_0x3481d6};}}if((!(0x0,lodash_1[_0x368153(0x1a7)])(_0x422eed?.[_0x368153(0x194)])&&_0x422eed?.[_0x368153(0x194)]!==''||!(0x0,lodash_1['isNil'])(_0x5f3ef2)&&_0x5f3ef2!=='')&&(_0x1db31c||_0x1db31c===undefined)){let _0x37ae12;if(_0x30755b[_0x368153(0x1a5)]!==_0x368153(0x169)||_0x30755b[_0x368153(0x1a5)]===_0x368153(0x169)&&_0x765eba['sendFarewellWaitingTicket']===_0x368153(0x1d6)){!(0x0,lodash_1[_0x368153(0x1a7)])(_0x422eed)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x422eed?.[_0x368153(0x194)])&&_0x422eed?.['farewellMessage']!==''?_0x37ae12='‎\x20'+_0x422eed['farewellMessage']:_0x37ae12='‎\x20'+_0x5f3ef2;if(_0x30755b[_0x368153(0x1c0)]===_0x368153(0x192)&&(!_0x30755b[_0x368153(0x1c4)]||_0x39b4ac===_0x368153(0x1d6))){const _0x38eba6=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x37ae12,'ticket':_0x30755b,'isForwarded':![]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x38eba6,_0x30755b,_0x30755b[_0x368153(0x182)]);}if([_0x368153(0x1cd),_0x368153(0x16c)][_0x368153(0x1c2)](_0x30755b[_0x368153(0x1c0)])&&(!_0x30755b[_0x368153(0x1c4)]||_0x39b4ac===_0x368153(0x1d6))){console[_0x368153(0x1a2)](_0x368153(0x197)+_0x30755b[_0x368153(0x182)][_0x368153(0x173)]+_0x368153(0x1bf)+_0x30755b[_0x368153(0x1c0)]+'\x20contact');const _0x51266e=await(0x0,sendFacebookMessage_1['default'])({'body':_0x37ae12,'ticket':_0x30755b});}}}return _0x4a2168[_0x368153(0x1d4)]=(0x0,moment_1['default'])()[_0x368153(0x19c)](),_0x4a2168[_0x368153(0x1cf)]=(0x0,moment_1[_0x368153(0x171)])()[_0x368153(0x19c)](),_0x4a2168[_0x368153(0x18c)]=_0x30755b[_0x368153(0x18c)],_0x4a2168[_0x368153(0x16a)]=_0x30755b[_0x368153(0x16a)],await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3a62ee,'queueId':_0x30755b[_0x368153(0x185)],'ticketId':_0x29a310,'type':_0x368153(0x1cc)}),await _0x4a2168[_0x368153(0x1d3)](),await _0x30755b[_0x368153(0x17d)]({'status':_0x368153(0x1cc)}),_0x2c6c5f['to'](_0x4000f6)['to'](_0x29a310[_0x368153(0x1be)]())[_0x368153(0x179)](_0x368153(0x16f)+_0x30755b[_0x368153(0x1b6)]+_0x368153(0x1b8),{'action':'delete','ticketId':_0x30755b['id']}),{'ticket':_0x30755b,'oldStatus':_0x4000f6,'oldUserId':_0x3481d6};}let _0x4ac1e8;!(0x0,lodash_1[_0x368153(0x1a7)])(_0x2f7f10)&&(_0x4ac1e8=await Queue_1[_0x368153(0x171)]['findByPk'](_0x2f7f10),_0x4a2168[_0x368153(0x1a3)]=(0x0,moment_1[_0x368153(0x171)])()[_0x368153(0x19c)]());if(isTransfered){if(_0x765eba[_0x368153(0x1bb)]){let _0x43ff6f=_0x30755b;if(_0x467f0c!==_0x2f7f10){await _0x30755b[_0x368153(0x17d)]({'status':_0x368153(0x1cc)}),await _0x30755b[_0x368153(0x187)](),_0x2c6c5f['to'](_0x4000f6)['to'](_0x29a310[_0x368153(0x1be)]())[_0x368153(0x179)](_0x368153(0x16f)+_0x30755b['companyId']+_0x368153(0x1b8),{'action':_0x368153(0x1b9),'ticketId':_0x30755b['id']});const {ticket:_0x1129d6}=await(0x0,FindOrCreateTicketService_1[_0x368153(0x171)])(_0x30755b[_0x368153(0x182)],_0x30755b[_0x368153(0x192)],0x1,_0x30755b['companyId'],_0x2f7f10,_0x3a62ee,null,_0x368153(0x192),![],![],_0x765eba,isTransfered);_0x43ff6f=_0x1129d6;}if(!(0x0,lodash_1['isNil'])(_0x5b4da8)){const _0x324777={'wid':_0x368153(0x1b0)+_0x43ff6f[_0x368153(0x176)][_0x368153(0x1be)]()[_0x368153(0x178)]('\x20',''),'ticketId':_0x43ff6f['id'],'contactId':undefined,'body':_0x5b4da8,'fromMe':!![],'mediaType':'extendedTextMessage','read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x43ff6f['contact']?.['remoteJid'],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1[_0x368153(0x171)])({'messageData':_0x324777,'companyId':_0x30755b[_0x368153(0x1b6)]});}await _0x43ff6f[_0x368153(0x17d)]({'queueId':_0x2f7f10,'userId':_0x3a62ee,'status':_0x48b431}),await _0x43ff6f[_0x368153(0x187)]();if(_0x765eba[_0x368153(0x1cb)]===_0x368153(0x1d6)){if(_0x467f0c!==_0x2f7f10&&_0x3481d6===_0x3a62ee&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x467f0c)&&!(0x0,lodash_1['isNil'])(_0x2f7f10)){const _0x2f6611=await(0x0,GetTicketWbot_1[_0x368153(0x171)])(_0x30755b),_0x5ab647=_0x368153(0x193)+_0x4ac1e8?.[_0x368153(0x1d5)]+_0x368153(0x170),_0x326872=await _0x2f6611[_0x368153(0x1c3)](_0x30755b[_0x368153(0x182)][_0x368153(0x173)]+'@'+(_0x30755b[_0x368153(0x1c4)]?_0x368153(0x177):'s.whatsapp.net'),{'text':_0x5ab647});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x326872,_0x30755b,_0x30755b['contact'],_0x4a2168);}else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c===_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&(!_0x30755b['isGroup']||_0x39b4ac===_0x368153(0x1d6))){const _0x213ab9=await(0x0,GetTicketWbot_1['default'])(_0x30755b),_0x254c46=await(0x0,ShowUserService_1['default'])(_0x37b7a9[_0x368153(0x16a)],_0x11236e),_0x195c12=_0x368153(0x17e)+_0x254c46[_0x368153(0x1d5)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x18c286=await _0x213ab9['sendMessage'](_0x30755b[_0x368153(0x182)][_0x368153(0x173)]+'@'+(_0x30755b['isGroup']?_0x368153(0x177):_0x368153(0x19e)),{'text':_0x195c12});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x18c286,_0x30755b,_0x30755b[_0x368153(0x182)],_0x4a2168);}else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&(!_0x30755b[_0x368153(0x1c4)]||_0x39b4ac===_0x368153(0x1d6))){const _0xc40437=await(0x0,GetTicketWbot_1['default'])(_0x30755b),_0x49fee5=await(0x0,ShowUserService_1['default'])(_0x37b7a9['userId'],_0x11236e),_0x445504=_0x368153(0x193)+_0x4ac1e8?.['name']+_0x368153(0x195)+_0x49fee5[_0x368153(0x1d5)]+_0x368153(0x17a),_0x3a7552=await _0xc40437[_0x368153(0x1c3)](_0x30755b[_0x368153(0x182)][_0x368153(0x173)]+'@'+(_0x30755b[_0x368153(0x1c4)]?'g.us':_0x368153(0x19e)),{'text':_0x445504});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x3a7552,_0x30755b,_0x30755b[_0x368153(0x182)]);}else{if(_0x3481d6!==undefined&&(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x2f7f10)){const _0x21f408=await(0x0,GetTicketWbot_1[_0x368153(0x171)])(_0x30755b),_0x1d7fd4=_0x368153(0x193)+_0x4ac1e8?.['name']+_0x368153(0x17a),_0x3fa9da=await _0x21f408[_0x368153(0x1c3)](_0x30755b[_0x368153(0x182)][_0x368153(0x173)]+'@'+(_0x30755b[_0x368153(0x1c4)]?_0x368153(0x177):_0x368153(0x19e)),{'text':_0x1d7fd4});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x3fa9da,_0x30755b,_0x30755b['contact']);}}}}}if(_0x3481d6!==_0x3a62ee&&_0x467f0c===_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1['isNil'])(_0x3a62ee))await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':'transfered'});else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c===_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee))await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)}),await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3a62ee,'queueId':_0x467f0c,'ticketId':_0x43ff6f['id'],'type':_0x368153(0x1a8)});else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee))await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)}),await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3a62ee,'queueId':_0x2f7f10,'ticketId':_0x43ff6f['id'],'type':_0x368153(0x1a8)});else _0x3481d6!==undefined&&(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1['isNil'])(_0x2f7f10)&&await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)});}}return(_0x43ff6f[_0x368153(0x1a5)]!==_0x4000f6||_0x43ff6f['user']?.['id']!==_0x3481d6)&&(await _0x4a2168[_0x368153(0x17d)]({'userId':_0x43ff6f[_0x368153(0x16a)]}),_0x2c6c5f['to'](_0x4000f6)[_0x368153(0x179)](_0x368153(0x16f)+_0x11236e+_0x368153(0x1b8),{'action':_0x368153(0x1b9),'ticketId':_0x43ff6f['id']})),_0x2c6c5f['to'](_0x43ff6f['status'])['to'](_0x368153(0x18f))['to'](_0x43ff6f['id'][_0x368153(0x1be)]())['emit'](_0x368153(0x16f)+_0x11236e+_0x368153(0x1b8),{'action':'update','ticket':_0x43ff6f}),{'ticket':_0x43ff6f,'oldStatus':_0x4000f6,'oldUserId':_0x3481d6};}else{if(_0x765eba['sendMsgTransfTicket']===_0x368153(0x1d6)){if(_0x467f0c!==_0x2f7f10&&_0x3481d6===_0x3a62ee&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x467f0c)&&!(0x0,lodash_1['isNil'])(_0x2f7f10)){const _0x47c00f=await(0x0,GetTicketWbot_1[_0x368153(0x171)])(_0x30755b),_0x3004a0=_0x368153(0x193)+_0x4ac1e8?.[_0x368153(0x1d5)]+_0x368153(0x170),_0x18894a=await _0x47c00f[_0x368153(0x1c3)](_0x30755b[_0x368153(0x182)][_0x368153(0x173)]+'@'+(_0x30755b[_0x368153(0x1c4)]?_0x368153(0x177):_0x368153(0x19e)),{'text':_0x3004a0});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x18894a,_0x30755b,_0x30755b[_0x368153(0x182)],_0x4a2168);}else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c===_0x2f7f10&&!(0x0,lodash_1['isNil'])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&(!_0x30755b[_0x368153(0x1c4)]||_0x39b4ac===_0x368153(0x1d6))){const _0x46085e=await(0x0,GetTicketWbot_1[_0x368153(0x171)])(_0x30755b),_0x497188=await(0x0,ShowUserService_1['default'])(_0x37b7a9['userId'],_0x11236e),_0xd1545d=_0x368153(0x17e)+_0x497188[_0x368153(0x1d5)]+_0x368153(0x17a),_0x17d001=await _0x46085e[_0x368153(0x1c3)](_0x30755b['contact'][_0x368153(0x173)]+'@'+(_0x30755b[_0x368153(0x1c4)]?_0x368153(0x177):_0x368153(0x19e)),{'text':_0xd1545d});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x17d001,_0x30755b,_0x30755b[_0x368153(0x182)],_0x4a2168);}else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&(!_0x30755b[_0x368153(0x1c4)]||_0x39b4ac===_0x368153(0x1d6))){const _0x23d08d=await(0x0,GetTicketWbot_1[_0x368153(0x171)])(_0x30755b),_0x43d45d=await(0x0,ShowUserService_1[_0x368153(0x171)])(_0x37b7a9[_0x368153(0x16a)],_0x11236e),_0xb5ab35=_0x368153(0x193)+_0x4ac1e8?.[_0x368153(0x1d5)]+'*\x20e\x20será\x20atendido\x20por\x20*'+_0x43d45d[_0x368153(0x1d5)]+_0x368153(0x17a),_0x2a21b8=await _0x23d08d[_0x368153(0x1c3)](_0x30755b['contact']['number']+'@'+(_0x30755b[_0x368153(0x1c4)]?'g.us':_0x368153(0x19e)),{'text':_0xb5ab35});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x2a21b8,_0x30755b,_0x30755b[_0x368153(0x182)]);}else{if(_0x3481d6!==undefined&&(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1['isNil'])(_0x2f7f10)){const _0x158785=await(0x0,GetTicketWbot_1['default'])(_0x30755b),_0x1d0194=_0x368153(0x193)+_0x4ac1e8?.[_0x368153(0x1d5)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x4ed615=await _0x158785[_0x368153(0x1c3)](_0x30755b[_0x368153(0x182)]['number']+'@'+(_0x30755b[_0x368153(0x1c4)]?_0x368153(0x177):_0x368153(0x19e)),{'text':_0x1d0194});await(0x0,wbotMessageListener_1[_0x368153(0x18d)])(_0x4ed615,_0x30755b,_0x30755b[_0x368153(0x182)]);}}}}}if(!(0x0,lodash_1[_0x368153(0x1a7)])(_0x5b4da8)){const _0x55d601={'wid':_0x368153(0x1b0)+_0x30755b[_0x368153(0x176)][_0x368153(0x1be)]()[_0x368153(0x178)]('\x20',''),'ticketId':_0x30755b['id'],'contactId':undefined,'body':_0x5b4da8,'fromMe':!![],'mediaType':'extendedTextMessage','read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x30755b[_0x368153(0x182)]?.[_0x368153(0x16d)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1['default'])({'messageData':_0x55d601,'companyId':_0x30755b['companyId']});}if(_0x3481d6!==_0x3a62ee&&_0x467f0c===_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee))await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)});else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c===_0x2f7f10&&!(0x0,lodash_1['isNil'])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)}),await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3a62ee,'queueId':_0x467f0c,'ticketId':_0x30755b['id'],'type':_0x368153(0x1a8)});else{if(_0x3481d6!==_0x3a62ee&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee))await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)}),await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3a62ee,'queueId':_0x2f7f10,'ticketId':_0x30755b['id'],'type':'receivedTransfer'});else _0x3481d6!==undefined&&(0x0,lodash_1[_0x368153(0x1a7)])(_0x3a62ee)&&_0x467f0c!==_0x2f7f10&&!(0x0,lodash_1['isNil'])(_0x2f7f10)&&await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'queueId':_0x467f0c,'ticketId':_0x29a310,'type':_0x368153(0x18b)});}}}}return _0x48b431=_0x4ac1e8&&_0x4ac1e8[_0x368153(0x1bc)]?'closed':_0x48b431,await _0x30755b[_0x368153(0x17d)]({'status':_0x48b431,'queueId':_0x2f7f10,'userId':_0x3a62ee,'isBot':_0x50fda2,'queueOptionId':_0x8b55ac,'amountUsedBotQueues':_0x48b431===_0x368153(0x1cc)?0x0:_0x595cf7?_0x595cf7:_0x30755b['amountUsedBotQueues'],'lastMessage':_0x3ea7cc?_0x3ea7cc:_0x30755b[_0x368153(0x18a)],'useIntegration':_0x291199,'integrationId':_0x2d96cd,'typebotSessionId':!_0x291199?null:_0x30755b['typebotSessionId'],'typebotStatus':_0x291199,'unreadMessages':_0x526d61}),_0x4a2168[_0x368153(0x1a3)]=(0x0,moment_1[_0x368153(0x171)])()[_0x368153(0x19c)](),_0x4a2168[_0x368153(0x185)]=_0x2f7f10,_0x30755b=await(0x0,ShowTicketService_1[_0x368153(0x171)])(_0x30755b['id'],_0x11236e),_0x48b431!==undefined&&[_0x368153(0x169)]['indexOf'](_0x48b431)>-0x1&&!(0x0,lodash_1[_0x368153(0x1a7)])(_0x3481d6)&&(await(0x0,CreateLogTicketService_1[_0x368153(0x171)])({'userId':_0x3481d6,'ticketId':_0x29a310,'type':'pending'}),await _0x4a2168['update']({'whatsappId':_0x30755b[_0x368153(0x18c)],'startedAt':null,'userId':null})),_0x48b431!==undefined&&_0x48b431!==_0x4000f6&&[_0x368153(0x1b1)][_0x368153(0x174)](_0x48b431)>-0x1&&(await _0x4a2168[_0x368153(0x17d)]({'startedAt':(0x0,moment_1['default'])()[_0x368153(0x19c)](),'ratingAt':null,'rated':![],'whatsappId':_0x30755b[_0x368153(0x18c)],'userId':_0x30755b[_0x368153(0x16a)],'queueId':_0x30755b[_0x368153(0x185)]}),await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3a62ee,'queueId':_0x30755b[_0x368153(0x185)],'ticketId':_0x29a310,'type':_0x4000f6===_0x368153(0x169)?_0x368153(0x1b1):_0x368153(0x199)})),await _0x4a2168[_0x368153(0x1d3)](),(_0x30755b[_0x368153(0x1a5)]!==_0x4000f6||_0x30755b['user']?.['id']!==_0x3481d6)&&(await _0x4a2168['update']({'userId':_0x30755b['userId']}),_0x2c6c5f['to'](_0x4000f6)['emit'](_0x368153(0x16f)+_0x11236e+_0x368153(0x1b8),{'action':_0x368153(0x1b9),'ticketId':_0x30755b['id']})),_0x2c6c5f['to'](_0x30755b[_0x368153(0x1a5)])['to']('notification')['to'](_0x29a310['toString']())[_0x368153(0x179)](_0x368153(0x16f)+_0x11236e+'-ticket',{'action':_0x368153(0x17d),'ticket':_0x30755b}),{'ticket':_0x30755b,'oldStatus':_0x4000f6,'oldUserId':_0x3481d6};}catch(_0x125989){Sentry[_0x368153(0x196)](_0x125989);}};function a607_0x25ae(){const _0x42f58d=['open','9HGyysg','28875ZbADIS','../WhatsappService/ShowWhatsAppService','hasOwnProperty','companyId','map','-ticket','delete','getOwnPropertyDescriptor','closeTicketOnTransfer','closeTicket','../../models/CompaniesSettings','toString','\x20is\x20a\x20valid\x20','channel','__importDefault','includes','sendMessage','isGroup','__esModule','tagId','50IbqRxM','userRating','204ybNMqF','../../models/Ticket','sendMsgTransfTicket','closed','facebook','destroy','closedAt','queueOptionId','21610DoIPwQ','552JNStIP','save','finishedAt','name','enabled','../MessageServices/CreateMessageService','call','7924044rimLve','../WbotServices/SendWhatsAppMessage','pending','userId','prototype','instagram','remoteJid','./CreateLogTicketService','company-','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','default','../FacebookServices/sendFacebookMessage','number','indexOf','group','updatedAt','g.us','replace','emit','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','477895VeGldj','48tehZnM','update','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','moment','../../models/TicketTag','__setModuleDefault','contact','../../libs/socket','__createBinding','queueId','lodash','reload','../UserServices/ShowUserService','findAll','lastMessage','transfered','whatsappId','verifyMessage','defineProperty','notification','getIO','58431rInbAY','whatsapp','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','farewellMessage','*\x20e\x20será\x20atendido\x20por\x20*','captureException','Checking\x20if\x20','configurable','reopen','../../models/Queue','create','toDate','findByPk','s.whatsapp.net','1602756ojmBCr','../WbotServices/wbotMessageListener','findOne','log','queuedAt','isBot','status','nps','isNil','receivedTransfer','./FindOrCreateATicketTrakingService','user','../../helpers/SetTicketMessagesAsRead','../FacebookServices/facebookMessageListener','get','52332LlrWgb','ratingAt','PVT'];a607_0x25ae=function(){return _0x42f58d;};return a607_0x25ae();}exports[a607_0x50ec47(0x171)]=UpdateTicketService;