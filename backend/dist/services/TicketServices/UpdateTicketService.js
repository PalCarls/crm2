'use strict';const a526_0x2f5775=a526_0x43c3;function a526_0x2534(){const _0x1117a8=['s.whatsapp.net','*\x20e\x20será\x20atendido\x20por\x20*','Checking\x20if\x20','pending','verifyMessage','__createBinding','11ofRVVg','finishedAt','../WbotServices/wbotMessageListener','52624qXyzOu','call','update','../../models/Setting','../../models/Queue','153JMLdtU','queue','delete','../UserServices/ShowUserService','whatsapp','open','color','*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','@sentry/node','queuedAt','emit','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','userId','getOwnPropertyDescriptor','../../models/User','moment','userRating','../../helpers/GetTicketWbot','toDate','1630512MWsvQA','lastMessage','queueId','closed','-ticket','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','lodash','sendMessage','get','company-','default','companyId','10uBXZHh','isNil','../WbotServices/SendWhatsAppMessage','\x20contact','name','./ShowTicketService','closedAt','captureException','../../models/Ticket','g.us','isGroup','__esModule','enabled','findByPk','96601MLOfxg','value','20VDOuGL','../../helpers/SetTicketMessagesAsRead','status','../WhatsappService/ShowWhatsAppService','contact','queueOptionId','channel','hasOwnProperty','../SettingServices/ListSettingsServiceOne','toString','6952600mCeLdE','instagram','2427135elSJjr','sendMsgTransfTicket','../FacebookServices/sendFacebookMessage','group','whatsappId','number','amountUsedBotQueues','log','user','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','354536yUPXFo','farewellMessage','includes','__importDefault','191274UfGCmN','\x20is\x20a\x20valid\x20','prototype','facebook','notification','nps','configurable','ratingAt','indexOf'];a526_0x2534=function(){return _0x1117a8;};return a526_0x2534();}(function(_0x21a504,_0x31effd){const _0x4f2843=a526_0x43c3,_0x32895f=_0x21a504();while(!![]){try{const _0x360f0c=-parseInt(_0x4f2843(0x1cc))/0x1*(parseInt(_0x4f2843(0x21f))/0x2)+-parseInt(_0x4f2843(0x1e8))/0x3*(-parseInt(_0x4f2843(0x1ce))/0x4)+-parseInt(_0x4f2843(0x1da))/0x5+parseInt(_0x4f2843(0x213))/0x6+parseInt(_0x4f2843(0x1e4))/0x7+-parseInt(_0x4f2843(0x1fa))/0x8*(parseInt(_0x4f2843(0x1ff))/0x9)+-parseInt(_0x4f2843(0x1d8))/0xa*(-parseInt(_0x4f2843(0x1f7))/0xb);if(_0x360f0c===_0x31effd)break;else _0x32895f['push'](_0x32895f['shift']());}catch(_0x370312){_0x32895f['push'](_0x32895f['shift']());}}}(a526_0x2534,0x3e8c0));var __createBinding=this&&this[a526_0x2f5775(0x1f6)]||(Object['create']?function(_0x458cba,_0x14d326,_0x2ade8a,_0x5a13c1){const _0x11cef2=a526_0x2f5775;if(_0x5a13c1===undefined)_0x5a13c1=_0x2ade8a;var _0x1856cf=Object[_0x11cef2(0x20d)](_0x14d326,_0x2ade8a);(!_0x1856cf||(_0x11cef2(0x21b)in _0x1856cf?!_0x14d326[_0x11cef2(0x1c9)]:_0x1856cf['writable']||_0x1856cf[_0x11cef2(0x1ee)]))&&(_0x1856cf={'enumerable':!![],'get':function(){return _0x14d326[_0x2ade8a];}}),Object['defineProperty'](_0x458cba,_0x5a13c1,_0x1856cf);}:function(_0x162cdb,_0x41fb61,_0x5f35d3,_0x55f8ab){if(_0x55f8ab===undefined)_0x55f8ab=_0x5f35d3;_0x162cdb[_0x55f8ab]=_0x41fb61[_0x5f35d3];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x5b9688,_0x1f5aeb){const _0x5628f8=a526_0x2f5775;Object['defineProperty'](_0x5b9688,_0x5628f8(0x21d),{'enumerable':!![],'value':_0x1f5aeb});}:function(_0x8bfcd4,_0x4278e5){const _0x63f57=a526_0x2f5775;_0x8bfcd4[_0x63f57(0x21d)]=_0x4278e5;}),__importStar=this&&this['__importStar']||function(_0x2e4f4c){const _0x2d95b2=a526_0x2f5775;if(_0x2e4f4c&&_0x2e4f4c[_0x2d95b2(0x1c9)])return _0x2e4f4c;var _0xe61906={};if(_0x2e4f4c!=null){for(var _0xfc96c3 in _0x2e4f4c)if(_0xfc96c3!=='default'&&Object[_0x2d95b2(0x1ea)][_0x2d95b2(0x1d5)][_0x2d95b2(0x1fb)](_0x2e4f4c,_0xfc96c3))__createBinding(_0xe61906,_0x2e4f4c,_0xfc96c3);}return __setModuleDefault(_0xe61906,_0x2e4f4c),_0xe61906;},__importDefault=this&&this[a526_0x2f5775(0x1e7)]||function(_0x1478dd){return _0x1478dd&&_0x1478dd['__esModule']?_0x1478dd:{'default':_0x1478dd};};Object['defineProperty'](exports,a526_0x2f5775(0x1c9),{'value':!![]});function a526_0x43c3(_0x3bef62,_0x35a9ee){const _0x2534c0=a526_0x2534();return a526_0x43c3=function(_0x43c312,_0x4ecf3c){_0x43c312=_0x43c312-0x1c8;let _0x5295f5=_0x2534c0[_0x43c312];return _0x5295f5;},a526_0x43c3(_0x3bef62,_0x35a9ee);}const moment_1=__importDefault(require(a526_0x2f5775(0x20f))),Sentry=__importStar(require(a526_0x2f5775(0x207))),sequelize_1=require('sequelize'),SetTicketMessagesAsRead_1=__importDefault(require(a526_0x2f5775(0x1cf))),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(a526_0x2f5775(0x227))),Setting_1=__importDefault(require(a526_0x2f5775(0x1fd))),Queue_1=__importDefault(require(a526_0x2f5775(0x1fe))),ShowTicketService_1=__importDefault(require(a526_0x2f5775(0x224))),ShowWhatsAppService_1=__importDefault(require(a526_0x2f5775(0x1d1))),SendWhatsAppMessage_1=__importDefault(require(a526_0x2f5775(0x221))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a526_0x2f5775(0x211))),wbotMessageListener_1=require(a526_0x2f5775(0x1f9)),lodash_1=require(a526_0x2f5775(0x219)),ListSettingsServiceOne_1=__importDefault(require(a526_0x2f5775(0x1d6))),sendFacebookMessage_1=__importDefault(require(a526_0x2f5775(0x1dc))),ShowUserService_1=__importDefault(require(a526_0x2f5775(0x202))),User_1=__importDefault(require(a526_0x2f5775(0x20e))),UpdateTicketService=async({ticketData:_0x52547e,ticketId:_0x405437,companyId:_0x293eaa})=>{const _0x1857fa=a526_0x2f5775;try{const {status:_0x254f91}=_0x52547e;let {queueId:_0x48d526,userId:_0x337df4,sendFarewellMessage:_0x102e83,amountUsedBotQueues:_0x2f50e8,lastMessage:_0xe523b9}=_0x52547e,_0x5ec740=_0x52547e['isBot']||![],_0x23c70a=_0x52547e[_0x1857fa(0x1d3)]||null;const _0x275d42=(0x0,socket_1['getIO'])(),_0x100c74=await Setting_1[_0x1857fa(0x21d)]['findOne']({'where':{'companyId':_0x293eaa,'key':_0x1857fa(0x210)}});let _0x207fbe=await Setting_1[_0x1857fa(0x21d)]['findOne']({'where':{'key':'sendFarewellWaitingTicket','companyId':_0x293eaa}});const _0xcf9e0c=await(0x0,ShowTicketService_1[_0x1857fa(0x21d)])(_0x405437,_0x293eaa);_0xcf9e0c[_0x1857fa(0x1d4)]==='whatsapp'&&await(0x0,SetTicketMessagesAsRead_1[_0x1857fa(0x21d)])(_0xcf9e0c);const _0x3e4d00=_0xcf9e0c?.[_0x1857fa(0x1d0)],_0x46a3d2=_0xcf9e0c[_0x1857fa(0x1e2)]?.['id'],_0x1cf70d=_0xcf9e0c?.[_0x1857fa(0x215)];if(_0x3e4d00===_0x1857fa(0x216)){const _0x2c5ba3=await Ticket_1[_0x1857fa(0x21d)]['findOne']({'where':{'contactId':_0xcf9e0c['contactId'],'status':{[sequelize_1['Op']['or']]:['open','pending',_0x1857fa(0x1dd)]},'whatsappId':_0xcf9e0c[_0x1857fa(0x1de)]},'include':[{'model':Queue_1[_0x1857fa(0x21d)],'as':_0x1857fa(0x200),'attributes':['id',_0x1857fa(0x223),_0x1857fa(0x205)]},{'model':User_1[_0x1857fa(0x21d)],'as':_0x1857fa(0x1e2),'attributes':['id',_0x1857fa(0x223)]}]});if(_0x2c5ba3){if(_0x2c5ba3['id']!==_0xcf9e0c['id'])return{'ticket':_0x2c5ba3,'oldStatus':_0x3e4d00,'oldUserId':_0x46a3d2};}_0x5ec740=![];}const _0x41c84c=await(0x0,FindOrCreateATicketTrakingService_1[_0x1857fa(0x21d)])({'ticketId':_0x405437,'companyId':_0x293eaa,'whatsappId':_0xcf9e0c[_0x1857fa(0x1de)]});if(_0x254f91!==undefined&&[_0x1857fa(0x216)][_0x1857fa(0x1f0)](_0x254f91)>-0x1){const {complationMessage:_0x43a8d7,ratingMessage:_0x26229f}=await(0x0,ShowWhatsAppService_1[_0x1857fa(0x21d)])(_0xcf9e0c[_0x1857fa(0x1de)],_0x293eaa);if(_0x100c74?.[_0x1857fa(0x1cd)]==='enabled'&&(_0x102e83||_0x102e83===undefined)&&(!(0x0,lodash_1[_0x1857fa(0x220)])(_0x26229f)&&_0x26229f!=='')&&!_0xcf9e0c[_0x1857fa(0x1c8)]){if(_0x41c84c[_0x1857fa(0x1ef)]==null){const _0x5e35dc=_0x26229f||'';let _0xa418f4='‎'+_0x5e35dc+'\x0a';if(_0xcf9e0c[_0x1857fa(0x1d4)]===_0x1857fa(0x203)){const _0x5b0160=await(0x0,SendWhatsAppMessage_1[_0x1857fa(0x21d)])({'body':_0xa418f4,'ticket':_0xcf9e0c});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x5b0160,_0xcf9e0c,_0xcf9e0c[_0x1857fa(0x1d2)]);}if([_0x1857fa(0x1eb),_0x1857fa(0x1d9)][_0x1857fa(0x1e6)](_0xcf9e0c[_0x1857fa(0x1d4)])){console['log'](_0x1857fa(0x1f3)+_0xcf9e0c[_0x1857fa(0x1d2)][_0x1857fa(0x1df)]+'\x20is\x20a\x20valid\x20'+_0xcf9e0c[_0x1857fa(0x1d4)]+_0x1857fa(0x222));const _0x3e8932=await(0x0,sendFacebookMessage_1['default'])({'body':_0xa418f4,'ticket':_0xcf9e0c});await(0x0,wbotMessageListener_1[_0x1857fa(0x1f5)])(_0x3e8932,_0xcf9e0c,_0xcf9e0c[_0x1857fa(0x1d2)]);}return await _0x41c84c[_0x1857fa(0x1fc)]({'userId':_0xcf9e0c[_0x1857fa(0x20c)],'closedAt':(0x0,moment_1[_0x1857fa(0x21d)])()['toDate']()}),await _0xcf9e0c['update']({'status':_0x1857fa(0x1ed),'amountUseBotQueuesNPS':0x1}),_0x275d42['to']('open')['to'](_0x405437['toString']())[_0x1857fa(0x209)]('company-'+_0xcf9e0c[_0x1857fa(0x21e)]+_0x1857fa(0x217),{'action':_0x1857fa(0x201),'ticketId':_0xcf9e0c['id']}),{'ticket':_0xcf9e0c,'oldStatus':_0x3e4d00,'oldUserId':_0x46a3d2};}}if(!(0x0,lodash_1[_0x1857fa(0x220)])(_0x43a8d7)&&_0x43a8d7!==''&&(_0x102e83||_0x102e83===undefined)){const _0x43ce63=_0xcf9e0c['userId']||_0x337df4,_0x13b2c6=await User_1[_0x1857fa(0x21d)][_0x1857fa(0x1cb)](_0x43ce63);let _0xb443d0;if(_0xcf9e0c['status']!==_0x1857fa(0x1f4)||_0xcf9e0c[_0x1857fa(0x1d0)]===_0x1857fa(0x1f4)&&_0x207fbe?.[_0x1857fa(0x1cd)]===_0x1857fa(0x1ca)){_0x13b2c6['farewellMessage']?_0xb443d0='‎'+_0x13b2c6[_0x1857fa(0x1e5)]:_0xb443d0='‎'+_0x43a8d7;if(_0xcf9e0c['channel']===_0x1857fa(0x203)&&!_0xcf9e0c[_0x1857fa(0x1c8)]){const _0x280944=await(0x0,SendWhatsAppMessage_1[_0x1857fa(0x21d)])({'body':_0xb443d0,'ticket':_0xcf9e0c});await(0x0,wbotMessageListener_1[_0x1857fa(0x1f5)])(_0x280944,_0xcf9e0c,_0xcf9e0c['contact']);}['facebook',_0x1857fa(0x1d9)][_0x1857fa(0x1e6)](_0xcf9e0c[_0x1857fa(0x1d4)])&&!_0xcf9e0c[_0x1857fa(0x1c8)]&&(console[_0x1857fa(0x1e1)](_0x1857fa(0x1f3)+_0xcf9e0c[_0x1857fa(0x1d2)][_0x1857fa(0x1df)]+_0x1857fa(0x1e9)+_0xcf9e0c[_0x1857fa(0x1d4)]+_0x1857fa(0x222)),await(0x0,sendFacebookMessage_1[_0x1857fa(0x21d)])({'body':_0xb443d0,'ticket':_0xcf9e0c}));}}_0x41c84c[_0x1857fa(0x1f8)]=(0x0,moment_1['default'])()[_0x1857fa(0x212)](),_0x41c84c[_0x1857fa(0x225)]=(0x0,moment_1[_0x1857fa(0x21d)])()[_0x1857fa(0x212)](),_0x41c84c[_0x1857fa(0x1de)]=_0xcf9e0c[_0x1857fa(0x1de)],_0x41c84c[_0x1857fa(0x20c)]=_0xcf9e0c[_0x1857fa(0x20c)];}!(0x0,lodash_1[_0x1857fa(0x220)])(_0x48d526)&&(_0x41c84c[_0x1857fa(0x208)]=(0x0,moment_1[_0x1857fa(0x21d)])()[_0x1857fa(0x212)]());const _0x29f940=await(0x0,ListSettingsServiceOne_1[_0x1857fa(0x21d)])({'companyId':_0x293eaa,'key':_0x1857fa(0x1db)});if(_0x29f940?.[_0x1857fa(0x1cd)]===_0x1857fa(0x1ca)){if(_0x1cf70d!==_0x48d526&&_0x46a3d2===_0x337df4&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x1cf70d)&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x48d526)){const _0x51fff5=await Queue_1[_0x1857fa(0x21d)][_0x1857fa(0x1cb)](_0x48d526),_0x2cf6c1=await(0x0,GetTicketWbot_1[_0x1857fa(0x21d)])(_0xcf9e0c),_0x4c38ca='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x51fff5?.[_0x1857fa(0x223)]+_0x1857fa(0x20b),_0x4bd124=await _0x2cf6c1[_0x1857fa(0x21a)](_0xcf9e0c[_0x1857fa(0x1d2)]['number']+'@'+(_0xcf9e0c[_0x1857fa(0x1c8)]?_0x1857fa(0x228):'s.whatsapp.net'),{'text':_0x4c38ca});await(0x0,wbotMessageListener_1[_0x1857fa(0x1f5)])(_0x4bd124,_0xcf9e0c,_0xcf9e0c['contact'],_0x41c84c);}else{if(_0x46a3d2!==_0x337df4&&_0x1cf70d===_0x48d526&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x46a3d2)&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x337df4)&&!_0xcf9e0c[_0x1857fa(0x1c8)]){const _0x1c1d77=await(0x0,GetTicketWbot_1[_0x1857fa(0x21d)])(_0xcf9e0c),_0x358349=await(0x0,ShowUserService_1['default'])(_0x52547e[_0x1857fa(0x20c)]),_0x278cde=_0x1857fa(0x1e3)+_0x358349[_0x1857fa(0x223)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x59187a=await _0x1c1d77[_0x1857fa(0x21a)](_0xcf9e0c[_0x1857fa(0x1d2)][_0x1857fa(0x1df)]+'@'+(_0xcf9e0c[_0x1857fa(0x1c8)]?_0x1857fa(0x228):_0x1857fa(0x1f1)),{'text':_0x278cde});await(0x0,wbotMessageListener_1[_0x1857fa(0x1f5)])(_0x59187a,_0xcf9e0c,_0xcf9e0c[_0x1857fa(0x1d2)],_0x41c84c);}else{if(_0x46a3d2!==_0x337df4&&!(0x0,lodash_1['isNil'])(_0x46a3d2)&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x337df4)&&_0x1cf70d!==_0x48d526&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x1cf70d)&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x48d526)){const _0x56a70e=await(0x0,GetTicketWbot_1[_0x1857fa(0x21d)])(_0xcf9e0c),_0x3edff2=await Queue_1[_0x1857fa(0x21d)]['findByPk'](_0x48d526),_0x4d89ac=await(0x0,ShowUserService_1[_0x1857fa(0x21d)])(_0x52547e[_0x1857fa(0x20c)]),_0x5e88a6=_0x1857fa(0x218)+_0x3edff2?.['name']+_0x1857fa(0x1f2)+_0x4d89ac[_0x1857fa(0x223)]+_0x1857fa(0x20a),_0x54229c=await _0x56a70e[_0x1857fa(0x21a)](_0xcf9e0c[_0x1857fa(0x1d2)][_0x1857fa(0x1df)]+'@'+(_0xcf9e0c[_0x1857fa(0x1c8)]?_0x1857fa(0x228):_0x1857fa(0x1f1)),{'text':_0x5e88a6});await(0x0,wbotMessageListener_1[_0x1857fa(0x1f5)])(_0x54229c,_0xcf9e0c,_0xcf9e0c[_0x1857fa(0x1d2)]);}else{if(_0x46a3d2!==undefined&&(0x0,lodash_1[_0x1857fa(0x220)])(_0x337df4)&&_0x1cf70d!==_0x48d526&&!(0x0,lodash_1[_0x1857fa(0x220)])(_0x48d526)){const _0x39bc92=await Queue_1[_0x1857fa(0x21d)][_0x1857fa(0x1cb)](_0x48d526),_0x450cf6=await(0x0,GetTicketWbot_1[_0x1857fa(0x21d)])(_0xcf9e0c),_0x2041bf=_0x1857fa(0x206)+_0x39bc92?.[_0x1857fa(0x223)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x40ae06=await _0x450cf6['sendMessage'](_0xcf9e0c[_0x1857fa(0x1d2)]['number']+'@'+(_0xcf9e0c[_0x1857fa(0x1c8)]?_0x1857fa(0x228):_0x1857fa(0x1f1)),{'text':_0x2041bf});await(0x0,wbotMessageListener_1[_0x1857fa(0x1f5)])(_0x40ae06,_0xcf9e0c,_0xcf9e0c[_0x1857fa(0x1d2)]);}}}}}return await _0xcf9e0c['update']({'status':_0x254f91,'queueId':_0x48d526,'userId':_0x337df4,'isBot':_0x5ec740,'queueOptionId':_0x23c70a,'amountUsedBotQueues':_0x254f91===_0x1857fa(0x216)?0x0:_0x2f50e8?_0x2f50e8:_0xcf9e0c[_0x1857fa(0x1e0)],'lastMessage':_0xe523b9?_0xe523b9:_0xcf9e0c[_0x1857fa(0x214)]}),_0x41c84c['queuedAt']=(0x0,moment_1[_0x1857fa(0x21d)])()[_0x1857fa(0x212)](),_0x41c84c[_0x1857fa(0x215)]=_0x48d526,await _0xcf9e0c['reload'](),_0x254f91!==undefined&&[_0x1857fa(0x1f4)]['indexOf'](_0x254f91)>-0x1&&_0x41c84c[_0x1857fa(0x1fc)]({'whatsappId':_0xcf9e0c['whatsappId'],'startedAt':null,'userId':null}),_0x254f91!==undefined&&[_0x1857fa(0x204)]['indexOf'](_0x254f91)>-0x1&&_0x41c84c[_0x1857fa(0x1fc)]({'startedAt':(0x0,moment_1[_0x1857fa(0x21d)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0xcf9e0c[_0x1857fa(0x1de)],'userId':_0xcf9e0c['userId'],'queueId':_0xcf9e0c[_0x1857fa(0x215)]}),(_0xcf9e0c[_0x1857fa(0x1d0)]!==_0x3e4d00||_0xcf9e0c[_0x1857fa(0x1e2)]?.['id']!==_0x46a3d2)&&(_0x41c84c[_0x1857fa(0x1fc)]({'userId':_0xcf9e0c[_0x1857fa(0x20c)]}),_0x275d42['to'](_0x3e4d00)[_0x1857fa(0x209)](_0x1857fa(0x21c)+_0x293eaa+'-ticket',{'action':_0x1857fa(0x201),'ticketId':_0xcf9e0c['id']})),await _0x41c84c['save'](),_0x275d42['to'](_0xcf9e0c[_0x1857fa(0x1d0)])['to'](_0x1857fa(0x1ec))['to'](_0x405437[_0x1857fa(0x1d7)]())[_0x1857fa(0x209)](_0x1857fa(0x21c)+_0x293eaa+'-ticket',{'action':_0x1857fa(0x1fc),'ticket':_0xcf9e0c,'ticketId':_0x405437}),{'ticket':_0xcf9e0c,'oldStatus':_0x3e4d00,'oldUserId':_0x46a3d2};}catch(_0x5b0ae6){Sentry[_0x1857fa(0x226)](_0x5b0ae6);}};exports[a526_0x2f5775(0x21d)]=UpdateTicketService;