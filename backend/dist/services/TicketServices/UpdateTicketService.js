'use strict';function a507_0x14c6(_0x2dba2e,_0xff31d2){const _0x288f54=a507_0x288f();return a507_0x14c6=function(_0x14c6d4,_0x1f783f){_0x14c6d4=_0x14c6d4-0x13d;let _0x4d8822=_0x288f54[_0x14c6d4];return _0x4d8822;},a507_0x14c6(_0x2dba2e,_0xff31d2);}const a507_0xb3ac50=a507_0x14c6;function a507_0x288f(){const _0x55ede2=['261IlArHY','-ticket','sendMsgTransfTicket','432472YsHBnu','companyId','includes','open','1485YcJnUn','ratingAt','4904AqBvgL','name','*\x20e\x20será\x20atendido\x20por\x20*','userRating','../UserServices/ShowUserService','queue','../../models/Ticket','g.us','38464789dYTRGs','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','queueId','verifyMessage','../FacebookServices/sendFacebookMessage','configurable','closedAt','getOwnPropertyDescriptor','nps','Checking\x20if\x20','get','lastMessage','4668BcuXvX','toString','465lOQXPR','../../helpers/GetTicketWbot','farewellMessage','@sentry/node','log','group','status','__importDefault','number','s.whatsapp.net','whatsapp','delete','../WbotServices/wbotMessageListener','../SettingServices/ListSettingsServiceOne','save','pending','__esModule','407020llZJDA','6213064knKXit','\x20is\x20a\x20valid\x20','../../helpers/SetTicketMessagesAsRead','../../libs/socket','findOne','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','../../models/User','toDate','prototype','default','amountUsedBotQueues','isNil','isGroup','userId','queueOptionId','reload','contactId','../WbotServices/SendWhatsAppMessage','value','emit','captureException','__importStar','__createBinding','sequelize','facebook','instagram','notification','channel','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','10pYazCR','color','7519106XDwcTw','contact','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','indexOf','queuedAt','whatsappId','getIO','closed','enabled','sendMessage','./FindOrCreateATicketTrakingService','update','user','company-','lodash','findByPk','hasOwnProperty','create','\x20contact','finishedAt'];a507_0x288f=function(){return _0x55ede2;};return a507_0x288f();}(function(_0x49732c,_0x5aadb9){const _0x4200d5=a507_0x14c6,_0x119da4=_0x49732c();while(!![]){try{const _0x40c0e4=parseInt(_0x4200d5(0x147))/0x1+parseInt(_0x4200d5(0x185))/0x2*(parseInt(_0x4200d5(0x183))/0x3)+-parseInt(_0x4200d5(0x148))/0x4+-parseInt(_0x4200d5(0x19b))/0x5*(parseInt(_0x4200d5(0x199))/0x6)+-parseInt(_0x4200d5(0x167))/0x7+parseInt(_0x4200d5(0x17f))/0x8*(-parseInt(_0x4200d5(0x17c))/0x9)+-parseInt(_0x4200d5(0x165))/0xa*(-parseInt(_0x4200d5(0x18d))/0xb);if(_0x40c0e4===_0x5aadb9)break;else _0x119da4['push'](_0x119da4['shift']());}catch(_0x412b0d){_0x119da4['push'](_0x119da4['shift']());}}}(a507_0x288f,0xcf896));var __createBinding=this&&this[a507_0xb3ac50(0x15e)]||(Object[a507_0xb3ac50(0x179)]?function(_0x41deaf,_0x4801b2,_0x5dd4d8,_0xd24f2e){const _0x11069e=a507_0xb3ac50;if(_0xd24f2e===undefined)_0xd24f2e=_0x5dd4d8;var _0x4821ef=Object[_0x11069e(0x194)](_0x4801b2,_0x5dd4d8);(!_0x4821ef||(_0x11069e(0x197)in _0x4821ef?!_0x4801b2[_0x11069e(0x146)]:_0x4821ef['writable']||_0x4821ef[_0x11069e(0x192)]))&&(_0x4821ef={'enumerable':!![],'get':function(){return _0x4801b2[_0x5dd4d8];}}),Object['defineProperty'](_0x41deaf,_0xd24f2e,_0x4821ef);}:function(_0x413c81,_0x4a4dae,_0x4009b6,_0x4435be){if(_0x4435be===undefined)_0x4435be=_0x4009b6;_0x413c81[_0x4435be]=_0x4a4dae[_0x4009b6];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x1b2b51,_0x43b5db){const _0x3d432b=a507_0xb3ac50;Object['defineProperty'](_0x1b2b51,_0x3d432b(0x151),{'enumerable':!![],'value':_0x43b5db});}:function(_0x47ffd9,_0x58a21c){_0x47ffd9['default']=_0x58a21c;}),__importStar=this&&this[a507_0xb3ac50(0x15d)]||function(_0x5d2feb){const _0x2f8495=a507_0xb3ac50;if(_0x5d2feb&&_0x5d2feb[_0x2f8495(0x146)])return _0x5d2feb;var _0x35120e={};if(_0x5d2feb!=null){for(var _0x59aa59 in _0x5d2feb)if(_0x59aa59!==_0x2f8495(0x151)&&Object[_0x2f8495(0x150)][_0x2f8495(0x178)]['call'](_0x5d2feb,_0x59aa59))__createBinding(_0x35120e,_0x5d2feb,_0x59aa59);}return __setModuleDefault(_0x35120e,_0x5d2feb),_0x35120e;},__importDefault=this&&this[a507_0xb3ac50(0x13d)]||function(_0x24a61f){const _0x1e1344=a507_0xb3ac50;return _0x24a61f&&_0x24a61f[_0x1e1344(0x146)]?_0x24a61f:{'default':_0x24a61f};};Object['defineProperty'](exports,a507_0xb3ac50(0x146),{'value':!![]});const moment_1=__importDefault(require('moment')),Sentry=__importStar(require(a507_0xb3ac50(0x19e))),sequelize_1=require(a507_0xb3ac50(0x15f)),SetTicketMessagesAsRead_1=__importDefault(require(a507_0xb3ac50(0x14a))),socket_1=require(a507_0xb3ac50(0x14b)),Ticket_1=__importDefault(require(a507_0xb3ac50(0x18b))),Setting_1=__importDefault(require('../../models/Setting')),Queue_1=__importDefault(require('../../models/Queue')),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require(a507_0xb3ac50(0x159))),FindOrCreateATicketTrakingService_1=__importDefault(require(a507_0xb3ac50(0x172))),GetTicketWbot_1=__importDefault(require(a507_0xb3ac50(0x19c))),wbotMessageListener_1=require(a507_0xb3ac50(0x142)),lodash_1=require(a507_0xb3ac50(0x176)),ListSettingsServiceOne_1=__importDefault(require(a507_0xb3ac50(0x143))),sendFacebookMessage_1=__importDefault(require(a507_0xb3ac50(0x191))),ShowUserService_1=__importDefault(require(a507_0xb3ac50(0x189))),User_1=__importDefault(require(a507_0xb3ac50(0x14e))),UpdateTicketService=async({ticketData:_0x4b644a,ticketId:_0x440b1c,companyId:_0x40a630})=>{const _0x528f2a=a507_0xb3ac50;try{const {status:_0x59f888}=_0x4b644a;let {queueId:_0x3f5641,userId:_0xf17cbc,sendFarewellMessage:_0x44723e,amountUsedBotQueues:_0x508331,lastMessage:_0xf13c7c}=_0x4b644a,_0x4279e8=_0x4b644a['isBot']||![],_0x37afb3=_0x4b644a[_0x528f2a(0x156)]||null;const _0x4b2a88=(0x0,socket_1[_0x528f2a(0x16e)])(),_0x54aa47=await Setting_1[_0x528f2a(0x151)][_0x528f2a(0x14c)]({'where':{'companyId':_0x40a630,'key':_0x528f2a(0x188)}});let _0x675cbe=await Setting_1[_0x528f2a(0x151)]['findOne']({'where':{'key':'sendFarewellWaitingTicket','companyId':_0x40a630}});const _0x4ff97b=await(0x0,ShowTicketService_1[_0x528f2a(0x151)])(_0x440b1c,_0x40a630);_0x4ff97b[_0x528f2a(0x163)]===_0x528f2a(0x140)&&await(0x0,SetTicketMessagesAsRead_1[_0x528f2a(0x151)])(_0x4ff97b);const _0x27380b=_0x4ff97b?.[_0x528f2a(0x1a1)],_0x28e0a9=_0x4ff97b['user']?.['id'],_0x27e090=_0x4ff97b?.[_0x528f2a(0x18f)];if(_0x27380b===_0x528f2a(0x16f)){const _0x3e958a=await Ticket_1[_0x528f2a(0x151)]['findOne']({'where':{'contactId':_0x4ff97b[_0x528f2a(0x158)],'status':{[sequelize_1['Op']['or']]:[_0x528f2a(0x182),_0x528f2a(0x145),_0x528f2a(0x1a0)]},'whatsappId':_0x4ff97b[_0x528f2a(0x16d)]},'include':[{'model':Queue_1[_0x528f2a(0x151)],'as':_0x528f2a(0x18a),'attributes':['id','name',_0x528f2a(0x166)]},{'model':User_1[_0x528f2a(0x151)],'as':_0x528f2a(0x174),'attributes':['id','name']}]});if(_0x3e958a){if(_0x3e958a['id']!==_0x4ff97b['id'])return{'ticket':_0x3e958a,'oldStatus':_0x27380b,'oldUserId':_0x28e0a9};}_0x4279e8=![];}const _0x5a441c=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x440b1c,'companyId':_0x40a630,'whatsappId':_0x4ff97b[_0x528f2a(0x16d)]});if(_0x59f888!==undefined&&[_0x528f2a(0x16f)][_0x528f2a(0x16b)](_0x59f888)>-0x1){const {complationMessage:_0x4e2303,ratingMessage:_0x3a79c8}=await(0x0,ShowWhatsAppService_1[_0x528f2a(0x151)])(_0x4ff97b[_0x528f2a(0x16d)],_0x40a630);if(_0x54aa47?.[_0x528f2a(0x15a)]===_0x528f2a(0x170)&&(_0x44723e||_0x44723e===undefined)&&(!(0x0,lodash_1[_0x528f2a(0x153)])(_0x3a79c8)&&_0x3a79c8!=='')&&!_0x4ff97b['isGroup']){if(_0x5a441c[_0x528f2a(0x184)]==null){const _0x8fe734=_0x3a79c8||'';let _0x36d669='‎'+_0x8fe734+'\x0a';if(_0x4ff97b[_0x528f2a(0x163)]===_0x528f2a(0x140)){const _0x15c22d=await(0x0,SendWhatsAppMessage_1[_0x528f2a(0x151)])({'body':_0x36d669,'ticket':_0x4ff97b});await(0x0,wbotMessageListener_1[_0x528f2a(0x190)])(_0x15c22d,_0x4ff97b,_0x4ff97b['contact']);}if([_0x528f2a(0x160),_0x528f2a(0x161)][_0x528f2a(0x181)](_0x4ff97b[_0x528f2a(0x163)])){console['log'](_0x528f2a(0x196)+_0x4ff97b[_0x528f2a(0x168)][_0x528f2a(0x13e)]+'\x20is\x20a\x20valid\x20'+_0x4ff97b[_0x528f2a(0x163)]+_0x528f2a(0x17a));const _0x32f85d=await(0x0,sendFacebookMessage_1['default'])({'body':_0x36d669,'ticket':_0x4ff97b});await(0x0,wbotMessageListener_1[_0x528f2a(0x190)])(_0x32f85d,_0x4ff97b,_0x4ff97b[_0x528f2a(0x168)]);}return await _0x5a441c[_0x528f2a(0x173)]({'userId':_0x4ff97b[_0x528f2a(0x155)],'closedAt':(0x0,moment_1[_0x528f2a(0x151)])()['toDate']()}),await _0x4ff97b[_0x528f2a(0x173)]({'status':_0x528f2a(0x195),'amountUseBotQueuesNPS':0x1}),_0x4b2a88['to'](_0x528f2a(0x182))['to'](_0x440b1c[_0x528f2a(0x19a)]())[_0x528f2a(0x15b)](_0x528f2a(0x175)+_0x4ff97b[_0x528f2a(0x180)]+'-ticket',{'action':_0x528f2a(0x141),'ticketId':_0x4ff97b['id']}),{'ticket':_0x4ff97b,'oldStatus':_0x27380b,'oldUserId':_0x28e0a9};}}if(!(0x0,lodash_1[_0x528f2a(0x153)])(_0x4e2303)&&_0x4e2303!==''&&(_0x44723e||_0x44723e===undefined)){const _0x235070=_0x4ff97b[_0x528f2a(0x155)]||_0xf17cbc,_0x300ad8=await User_1[_0x528f2a(0x151)][_0x528f2a(0x177)](_0x235070);let _0x42bd3c;if(_0x4ff97b[_0x528f2a(0x1a1)]!==_0x528f2a(0x145)||_0x4ff97b[_0x528f2a(0x1a1)]===_0x528f2a(0x145)&&_0x675cbe?.[_0x528f2a(0x15a)]==='enabled'){_0x300ad8['farewellMessage']?_0x42bd3c='‎'+_0x300ad8[_0x528f2a(0x19d)]:_0x42bd3c='‎'+_0x4e2303;if(_0x4ff97b[_0x528f2a(0x163)]==='whatsapp'&&!_0x4ff97b[_0x528f2a(0x154)]){const _0x333323=await(0x0,SendWhatsAppMessage_1[_0x528f2a(0x151)])({'body':_0x42bd3c,'ticket':_0x4ff97b});await(0x0,wbotMessageListener_1[_0x528f2a(0x190)])(_0x333323,_0x4ff97b,_0x4ff97b['contact']);}['facebook','instagram']['includes'](_0x4ff97b[_0x528f2a(0x163)])&&!_0x4ff97b['isGroup']&&(console[_0x528f2a(0x19f)](_0x528f2a(0x196)+_0x4ff97b[_0x528f2a(0x168)][_0x528f2a(0x13e)]+_0x528f2a(0x149)+_0x4ff97b[_0x528f2a(0x163)]+'\x20contact'),await(0x0,sendFacebookMessage_1[_0x528f2a(0x151)])({'body':_0x42bd3c,'ticket':_0x4ff97b}));}}_0x5a441c[_0x528f2a(0x17b)]=(0x0,moment_1[_0x528f2a(0x151)])()['toDate'](),_0x5a441c[_0x528f2a(0x193)]=(0x0,moment_1[_0x528f2a(0x151)])()[_0x528f2a(0x14f)](),_0x5a441c['whatsappId']=_0x4ff97b[_0x528f2a(0x16d)],_0x5a441c[_0x528f2a(0x155)]=_0x4ff97b[_0x528f2a(0x155)];}!(0x0,lodash_1[_0x528f2a(0x153)])(_0x3f5641)&&(_0x5a441c[_0x528f2a(0x16c)]=(0x0,moment_1[_0x528f2a(0x151)])()[_0x528f2a(0x14f)]());const _0x1f9220=await(0x0,ListSettingsServiceOne_1[_0x528f2a(0x151)])({'companyId':_0x40a630,'key':_0x528f2a(0x17e)});if(_0x1f9220?.[_0x528f2a(0x15a)]===_0x528f2a(0x170)){if(_0x27e090!==_0x3f5641&&_0x28e0a9===_0xf17cbc&&!(0x0,lodash_1['isNil'])(_0x27e090)&&!(0x0,lodash_1[_0x528f2a(0x153)])(_0x3f5641)){const _0x56d74e=await Queue_1[_0x528f2a(0x151)][_0x528f2a(0x177)](_0x3f5641),_0x1fd828=await(0x0,GetTicketWbot_1[_0x528f2a(0x151)])(_0x4ff97b),_0x2064d5=_0x528f2a(0x18e)+_0x56d74e?.[_0x528f2a(0x186)]+_0x528f2a(0x169),_0x314bca=await _0x1fd828[_0x528f2a(0x171)](_0x4ff97b[_0x528f2a(0x168)][_0x528f2a(0x13e)]+'@'+(_0x4ff97b[_0x528f2a(0x154)]?'g.us':_0x528f2a(0x13f)),{'text':_0x2064d5});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x314bca,_0x4ff97b,_0x4ff97b[_0x528f2a(0x168)],_0x5a441c);}else{if(_0x28e0a9!==_0xf17cbc&&_0x27e090===_0x3f5641&&!(0x0,lodash_1[_0x528f2a(0x153)])(_0x28e0a9)&&!(0x0,lodash_1['isNil'])(_0xf17cbc)&&!_0x4ff97b[_0x528f2a(0x154)]){const _0x1daea6=await(0x0,GetTicketWbot_1[_0x528f2a(0x151)])(_0x4ff97b),_0x216f8a=await(0x0,ShowUserService_1[_0x528f2a(0x151)])(_0x4b644a[_0x528f2a(0x155)]),_0x3cab81=_0x528f2a(0x164)+_0x216f8a[_0x528f2a(0x186)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x3d150f=await _0x1daea6[_0x528f2a(0x171)](_0x4ff97b[_0x528f2a(0x168)][_0x528f2a(0x13e)]+'@'+(_0x4ff97b[_0x528f2a(0x154)]?_0x528f2a(0x18c):_0x528f2a(0x13f)),{'text':_0x3cab81});await(0x0,wbotMessageListener_1[_0x528f2a(0x190)])(_0x3d150f,_0x4ff97b,_0x4ff97b[_0x528f2a(0x168)],_0x5a441c);}else{if(_0x28e0a9!==_0xf17cbc&&!(0x0,lodash_1[_0x528f2a(0x153)])(_0x28e0a9)&&!(0x0,lodash_1[_0x528f2a(0x153)])(_0xf17cbc)&&_0x27e090!==_0x3f5641&&!(0x0,lodash_1['isNil'])(_0x27e090)&&!(0x0,lodash_1[_0x528f2a(0x153)])(_0x3f5641)){const _0x268ee2=await(0x0,GetTicketWbot_1[_0x528f2a(0x151)])(_0x4ff97b),_0xc92091=await Queue_1['default'][_0x528f2a(0x177)](_0x3f5641),_0x15710d=await(0x0,ShowUserService_1[_0x528f2a(0x151)])(_0x4b644a['userId']),_0x33ef29='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0xc92091?.[_0x528f2a(0x186)]+_0x528f2a(0x187)+_0x15710d['name']+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x1935f3=await _0x268ee2[_0x528f2a(0x171)](_0x4ff97b[_0x528f2a(0x168)]['number']+'@'+(_0x4ff97b['isGroup']?_0x528f2a(0x18c):_0x528f2a(0x13f)),{'text':_0x33ef29});await(0x0,wbotMessageListener_1[_0x528f2a(0x190)])(_0x1935f3,_0x4ff97b,_0x4ff97b['contact']);}else{if(_0x28e0a9!==undefined&&(0x0,lodash_1[_0x528f2a(0x153)])(_0xf17cbc)&&_0x27e090!==_0x3f5641&&!(0x0,lodash_1[_0x528f2a(0x153)])(_0x3f5641)){const _0x339cbc=await Queue_1[_0x528f2a(0x151)]['findByPk'](_0x3f5641),_0x3258b7=await(0x0,GetTicketWbot_1[_0x528f2a(0x151)])(_0x4ff97b),_0x53923b=_0x528f2a(0x16a)+_0x339cbc?.[_0x528f2a(0x186)]+_0x528f2a(0x14d),_0x56656b=await _0x3258b7[_0x528f2a(0x171)](_0x4ff97b['contact'][_0x528f2a(0x13e)]+'@'+(_0x4ff97b[_0x528f2a(0x154)]?_0x528f2a(0x18c):'s.whatsapp.net'),{'text':_0x53923b});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x56656b,_0x4ff97b,_0x4ff97b['contact']);}}}}}return await _0x4ff97b['update']({'status':_0x59f888,'queueId':_0x3f5641,'userId':_0xf17cbc,'isBot':_0x4279e8,'queueOptionId':_0x37afb3,'amountUsedBotQueues':_0x59f888==='closed'?0x0:_0x508331?_0x508331:_0x4ff97b[_0x528f2a(0x152)],'lastMessage':_0xf13c7c?_0xf13c7c:_0x4ff97b[_0x528f2a(0x198)]}),_0x5a441c[_0x528f2a(0x16c)]=(0x0,moment_1[_0x528f2a(0x151)])()[_0x528f2a(0x14f)](),_0x5a441c[_0x528f2a(0x18f)]=_0x3f5641,await _0x4ff97b[_0x528f2a(0x157)](),_0x59f888!==undefined&&[_0x528f2a(0x145)][_0x528f2a(0x16b)](_0x59f888)>-0x1&&_0x5a441c[_0x528f2a(0x173)]({'whatsappId':_0x4ff97b[_0x528f2a(0x16d)],'startedAt':null,'userId':null}),_0x59f888!==undefined&&[_0x528f2a(0x182)]['indexOf'](_0x59f888)>-0x1&&_0x5a441c[_0x528f2a(0x173)]({'startedAt':(0x0,moment_1[_0x528f2a(0x151)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0x4ff97b[_0x528f2a(0x16d)],'userId':_0x4ff97b['userId'],'queueId':_0x4ff97b['queueId']}),(_0x4ff97b[_0x528f2a(0x1a1)]!==_0x27380b||_0x4ff97b[_0x528f2a(0x174)]?.['id']!==_0x28e0a9)&&(_0x5a441c[_0x528f2a(0x173)]({'userId':_0x4ff97b[_0x528f2a(0x155)]}),_0x4b2a88['to'](_0x27380b)[_0x528f2a(0x15b)](_0x528f2a(0x175)+_0x40a630+'-ticket',{'action':_0x528f2a(0x141),'ticketId':_0x4ff97b['id']})),await _0x5a441c[_0x528f2a(0x144)](),_0x4b2a88['to'](_0x4ff97b[_0x528f2a(0x1a1)])['to'](_0x528f2a(0x162))['to'](_0x440b1c['toString']())[_0x528f2a(0x15b)]('company-'+_0x40a630+_0x528f2a(0x17d),{'action':_0x528f2a(0x173),'ticket':_0x4ff97b,'ticketId':_0x440b1c}),{'ticket':_0x4ff97b,'oldStatus':_0x27380b,'oldUserId':_0x28e0a9};}catch(_0x25657d){Sentry[_0x528f2a(0x15c)](_0x25657d);}};exports[a507_0xb3ac50(0x151)]=UpdateTicketService;