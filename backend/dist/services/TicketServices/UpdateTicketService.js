'use strict';const a526_0x26ea08=a526_0xa830;(function(_0x5d4822,_0x2940d9){const _0x211a5a=a526_0xa830,_0x3990eb=_0x5d4822();while(!![]){try{const _0x4c122c=-parseInt(_0x211a5a(0x12d))/0x1+-parseInt(_0x211a5a(0x12b))/0x2*(parseInt(_0x211a5a(0x137))/0x3)+-parseInt(_0x211a5a(0x148))/0x4+-parseInt(_0x211a5a(0x168))/0x5+parseInt(_0x211a5a(0x12f))/0x6+parseInt(_0x211a5a(0x111))/0x7+-parseInt(_0x211a5a(0x153))/0x8*(-parseInt(_0x211a5a(0x126))/0x9);if(_0x4c122c===_0x2940d9)break;else _0x3990eb['push'](_0x3990eb['shift']());}catch(_0x4230d4){_0x3990eb['push'](_0x3990eb['shift']());}}}(a526_0x22ef,0xdbbae));var __createBinding=this&&this[a526_0x26ea08(0x147)]||(Object[a526_0x26ea08(0x159)]?function(_0x3cd983,_0x32fb8a,_0x36fecd,_0x49f350){const _0x1331f7=a526_0x26ea08;if(_0x49f350===undefined)_0x49f350=_0x36fecd;var _0x277eb9=Object['getOwnPropertyDescriptor'](_0x32fb8a,_0x36fecd);(!_0x277eb9||(_0x1331f7(0x136)in _0x277eb9?!_0x32fb8a[_0x1331f7(0x131)]:_0x277eb9[_0x1331f7(0x14d)]||_0x277eb9[_0x1331f7(0x150)]))&&(_0x277eb9={'enumerable':!![],'get':function(){return _0x32fb8a[_0x36fecd];}}),Object[_0x1331f7(0x156)](_0x3cd983,_0x49f350,_0x277eb9);}:function(_0x484878,_0x4a39c9,_0x59f1da,_0x14da29){if(_0x14da29===undefined)_0x14da29=_0x59f1da;_0x484878[_0x14da29]=_0x4a39c9[_0x59f1da];}),__setModuleDefault=this&&this[a526_0x26ea08(0x15f)]||(Object['create']?function(_0x228f94,_0x2ea1a8){const _0x22db59=a526_0x26ea08;Object[_0x22db59(0x156)](_0x228f94,'default',{'enumerable':!![],'value':_0x2ea1a8});}:function(_0x268554,_0x552cea){const _0x346838=a526_0x26ea08;_0x268554[_0x346838(0x164)]=_0x552cea;}),__importStar=this&&this[a526_0x26ea08(0x113)]||function(_0x252cab){const _0x5cfae9=a526_0x26ea08;if(_0x252cab&&_0x252cab[_0x5cfae9(0x131)])return _0x252cab;var _0x11b1a1={};if(_0x252cab!=null){for(var _0x25b06f in _0x252cab)if(_0x25b06f!==_0x5cfae9(0x164)&&Object[_0x5cfae9(0x11b)]['hasOwnProperty'][_0x5cfae9(0x134)](_0x252cab,_0x25b06f))__createBinding(_0x11b1a1,_0x252cab,_0x25b06f);}return __setModuleDefault(_0x11b1a1,_0x252cab),_0x11b1a1;},__importDefault=this&&this[a526_0x26ea08(0x14e)]||function(_0x59db23){const _0x46624e=a526_0x26ea08;return _0x59db23&&_0x59db23[_0x46624e(0x131)]?_0x59db23:{'default':_0x59db23};};function a526_0x22ef(){const _0x46d92f=['1891765CJzCjl','status','../../libs/socket','contactId','indexOf','instagram','g.us','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','3313044SqDxeU','user','__importStar','\x20is\x20a\x20valid\x20','log','../WhatsappService/ShowWhatsAppService','delete','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','notification','enabled','prototype','s.whatsapp.net','../FacebookServices/sendFacebookMessage','open','pending','../../models/Ticket','../../models/Setting','amountUsedBotQueues','./FindOrCreateATicketTrakingService','toDate','sequelize','36mJCyEK','channel','queueOptionId','includes','color','2CjXfjl','isNil','71931cGVilS','company-','5403324jqljcv','contact','__esModule','./ShowTicketService','toString','call','emit','get','4601571CIhLMl','sendMessage','group','save','closed','closedAt','Checking\x20if\x20','userId','../WbotServices/SendWhatsAppMessage','queueId','moment','findByPk','../WbotServices/wbotMessageListener','companyId','\x20contact','isGroup','__createBinding','3672828fPzDwU','number','*\x20e\x20será\x20atendido\x20por\x20*','../../helpers/GetTicketWbot','value','writable','__importDefault','-ticket','configurable','findOne','verifyMessage','4857032iASAEf','farewellMessage','whatsapp','defineProperty','name','../../helpers/SetTicketMessagesAsRead','create','update','finishedAt','../UserServices/ShowUserService','nps','../../models/User','__setModuleDefault','queuedAt','queue','@sentry/node','whatsappId','default','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','lodash','../../models/Queue'];a526_0x22ef=function(){return _0x46d92f;};return a526_0x22ef();}function a526_0xa830(_0x4c4be6,_0x56b59c){const _0x22ef9a=a526_0x22ef();return a526_0xa830=function(_0xa830ac,_0x39f825){_0xa830ac=_0xa830ac-0x10c;let _0x1db4fd=_0x22ef9a[_0xa830ac];return _0x1db4fd;},a526_0xa830(_0x4c4be6,_0x56b59c);}Object[a526_0x26ea08(0x156)](exports,a526_0x26ea08(0x131),{'value':!![]});const moment_1=__importDefault(require(a526_0x26ea08(0x141))),Sentry=__importStar(require(a526_0x26ea08(0x162))),sequelize_1=require(a526_0x26ea08(0x125)),SetTicketMessagesAsRead_1=__importDefault(require(a526_0x26ea08(0x158))),socket_1=require(a526_0x26ea08(0x16a)),Ticket_1=__importDefault(require(a526_0x26ea08(0x120))),Setting_1=__importDefault(require(a526_0x26ea08(0x121))),Queue_1=__importDefault(require(a526_0x26ea08(0x167))),ShowTicketService_1=__importDefault(require(a526_0x26ea08(0x132))),ShowWhatsAppService_1=__importDefault(require(a526_0x26ea08(0x116))),SendWhatsAppMessage_1=__importDefault(require(a526_0x26ea08(0x13f))),FindOrCreateATicketTrakingService_1=__importDefault(require(a526_0x26ea08(0x123))),GetTicketWbot_1=__importDefault(require(a526_0x26ea08(0x14b))),wbotMessageListener_1=require(a526_0x26ea08(0x143)),lodash_1=require(a526_0x26ea08(0x166)),ListSettingsServiceOne_1=__importDefault(require('../SettingServices/ListSettingsServiceOne')),sendFacebookMessage_1=__importDefault(require(a526_0x26ea08(0x11d))),ShowUserService_1=__importDefault(require(a526_0x26ea08(0x15c))),User_1=__importDefault(require(a526_0x26ea08(0x15e))),UpdateTicketService=async({ticketData:_0xd3da35,ticketId:_0x181306,companyId:_0x971c37})=>{const _0x89fe98=a526_0x26ea08;try{const {status:_0x5e7290}=_0xd3da35;let {queueId:_0x3d1b06,userId:_0x3c459c,sendFarewellMessage:_0x21bed0,amountUsedBotQueues:_0x1d2c5c,lastMessage:_0x3e52c9}=_0xd3da35,_0x211406=_0xd3da35['isBot']||![],_0x1739f5=_0xd3da35[_0x89fe98(0x128)]||null;const _0x44a762=(0x0,socket_1['getIO'])(),_0x2c46e7=await Setting_1['default']['findOne']({'where':{'companyId':_0x971c37,'key':'userRating'}});let _0x5c45fb=await Setting_1[_0x89fe98(0x164)][_0x89fe98(0x151)]({'where':{'key':'sendFarewellWaitingTicket','companyId':_0x971c37}});const _0x31a1ed=await(0x0,ShowTicketService_1[_0x89fe98(0x164)])(_0x181306,_0x971c37);_0x31a1ed['channel']===_0x89fe98(0x155)&&await(0x0,SetTicketMessagesAsRead_1['default'])(_0x31a1ed);const _0x5728cc=_0x31a1ed?.[_0x89fe98(0x169)],_0x40c76b=_0x31a1ed[_0x89fe98(0x112)]?.['id'],_0x2a30bb=_0x31a1ed?.[_0x89fe98(0x140)];if(_0x5728cc===_0x89fe98(0x13b)){const _0x5bf8b3=await Ticket_1[_0x89fe98(0x164)]['findOne']({'where':{'contactId':_0x31a1ed[_0x89fe98(0x16b)],'status':{[sequelize_1['Op']['or']]:[_0x89fe98(0x11e),_0x89fe98(0x11f),_0x89fe98(0x139)]},'whatsappId':_0x31a1ed['whatsappId']},'include':[{'model':Queue_1[_0x89fe98(0x164)],'as':_0x89fe98(0x161),'attributes':['id',_0x89fe98(0x157),_0x89fe98(0x12a)]},{'model':User_1['default'],'as':'user','attributes':['id','name']}]});if(_0x5bf8b3){if(_0x5bf8b3['id']!==_0x31a1ed['id'])return{'ticket':_0x5bf8b3,'oldStatus':_0x5728cc,'oldUserId':_0x40c76b};}_0x211406=![];}const _0x2255c4=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x181306,'companyId':_0x971c37,'whatsappId':_0x31a1ed['whatsappId']});if(_0x5e7290!==undefined&&[_0x89fe98(0x13b)][_0x89fe98(0x10c)](_0x5e7290)>-0x1){const {complationMessage:_0x4e926e,ratingMessage:_0x1a456d}=await(0x0,ShowWhatsAppService_1['default'])(_0x31a1ed[_0x89fe98(0x163)],_0x971c37);if(_0x2c46e7?.[_0x89fe98(0x14c)]===_0x89fe98(0x11a)&&(_0x21bed0||_0x21bed0===undefined)&&(!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x1a456d)&&_0x1a456d!=='')&&!_0x31a1ed[_0x89fe98(0x146)]){if(_0x2255c4['ratingAt']==null){const _0x1f90b4=_0x1a456d||'';let _0x3e045e='‎'+_0x1f90b4+'\x0a';if(_0x31a1ed['channel']===_0x89fe98(0x155)){const _0x485e57=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3e045e,'ticket':_0x31a1ed});await(0x0,wbotMessageListener_1[_0x89fe98(0x152)])(_0x485e57,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)]);}if(['facebook',_0x89fe98(0x10d)][_0x89fe98(0x129)](_0x31a1ed[_0x89fe98(0x127)])){console[_0x89fe98(0x115)]('Checking\x20if\x20'+_0x31a1ed[_0x89fe98(0x130)][_0x89fe98(0x149)]+_0x89fe98(0x114)+_0x31a1ed[_0x89fe98(0x127)]+_0x89fe98(0x145));const _0x1d1f6c=await(0x0,sendFacebookMessage_1[_0x89fe98(0x164)])({'body':_0x3e045e,'ticket':_0x31a1ed});await(0x0,wbotMessageListener_1[_0x89fe98(0x152)])(_0x1d1f6c,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)]);}return await _0x2255c4[_0x89fe98(0x15a)]({'userId':_0x31a1ed[_0x89fe98(0x13e)],'closedAt':(0x0,moment_1[_0x89fe98(0x164)])()[_0x89fe98(0x124)]()}),await _0x31a1ed[_0x89fe98(0x15a)]({'status':_0x89fe98(0x15d),'amountUseBotQueuesNPS':0x1}),_0x44a762['to'](_0x89fe98(0x11e))['to'](_0x181306[_0x89fe98(0x133)]())[_0x89fe98(0x135)](_0x89fe98(0x12e)+_0x31a1ed[_0x89fe98(0x144)]+_0x89fe98(0x14f),{'action':_0x89fe98(0x117),'ticketId':_0x31a1ed['id']}),{'ticket':_0x31a1ed,'oldStatus':_0x5728cc,'oldUserId':_0x40c76b};}}if(!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x4e926e)&&_0x4e926e!==''&&(_0x21bed0||_0x21bed0===undefined)){const _0x24f58d=_0x31a1ed[_0x89fe98(0x13e)]||_0x3c459c,_0xd19bca=await User_1[_0x89fe98(0x164)][_0x89fe98(0x142)](_0x24f58d);let _0x3b5cda;if(_0x31a1ed[_0x89fe98(0x169)]!==_0x89fe98(0x11f)||_0x31a1ed[_0x89fe98(0x169)]===_0x89fe98(0x11f)&&_0x5c45fb?.[_0x89fe98(0x14c)]==='enabled'){_0xd19bca[_0x89fe98(0x154)]?_0x3b5cda='‎'+_0xd19bca[_0x89fe98(0x154)]:_0x3b5cda='‎'+_0x4e926e;if(_0x31a1ed[_0x89fe98(0x127)]==='whatsapp'&&!_0x31a1ed[_0x89fe98(0x146)]){const _0x382095=await(0x0,SendWhatsAppMessage_1[_0x89fe98(0x164)])({'body':_0x3b5cda,'ticket':_0x31a1ed});await(0x0,wbotMessageListener_1[_0x89fe98(0x152)])(_0x382095,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)]);}['facebook',_0x89fe98(0x10d)][_0x89fe98(0x129)](_0x31a1ed[_0x89fe98(0x127)])&&!_0x31a1ed[_0x89fe98(0x146)]&&(console[_0x89fe98(0x115)](_0x89fe98(0x13d)+_0x31a1ed[_0x89fe98(0x130)][_0x89fe98(0x149)]+_0x89fe98(0x114)+_0x31a1ed[_0x89fe98(0x127)]+_0x89fe98(0x145)),await(0x0,sendFacebookMessage_1[_0x89fe98(0x164)])({'body':_0x3b5cda,'ticket':_0x31a1ed}));}}_0x2255c4[_0x89fe98(0x15b)]=(0x0,moment_1[_0x89fe98(0x164)])()[_0x89fe98(0x124)](),_0x2255c4[_0x89fe98(0x13c)]=(0x0,moment_1['default'])()[_0x89fe98(0x124)](),_0x2255c4['whatsappId']=_0x31a1ed[_0x89fe98(0x163)],_0x2255c4['userId']=_0x31a1ed[_0x89fe98(0x13e)];}!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3d1b06)&&(_0x2255c4[_0x89fe98(0x160)]=(0x0,moment_1[_0x89fe98(0x164)])()['toDate']());const _0x2542e7=await(0x0,ListSettingsServiceOne_1[_0x89fe98(0x164)])({'companyId':_0x971c37,'key':'sendMsgTransfTicket'});if(_0x2542e7?.[_0x89fe98(0x14c)]==='enabled'){if(_0x2a30bb!==_0x3d1b06&&_0x40c76b===_0x3c459c&&!(0x0,lodash_1['isNil'])(_0x2a30bb)&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3d1b06)){const _0x5053ac=await Queue_1[_0x89fe98(0x164)][_0x89fe98(0x142)](_0x3d1b06),_0x2f2262=await(0x0,GetTicketWbot_1['default'])(_0x31a1ed),_0x40a1d2=_0x89fe98(0x10f)+_0x5053ac?.['name']+'\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x2d0526=await _0x2f2262[_0x89fe98(0x138)](_0x31a1ed[_0x89fe98(0x130)][_0x89fe98(0x149)]+'@'+(_0x31a1ed[_0x89fe98(0x146)]?'g.us':_0x89fe98(0x11c)),{'text':_0x40a1d2});await(0x0,wbotMessageListener_1[_0x89fe98(0x152)])(_0x2d0526,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)],_0x2255c4);}else{if(_0x40c76b!==_0x3c459c&&_0x2a30bb===_0x3d1b06&&!(0x0,lodash_1['isNil'])(_0x40c76b)&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3c459c)&&!_0x31a1ed[_0x89fe98(0x146)]){const _0x1fda90=await(0x0,GetTicketWbot_1[_0x89fe98(0x164)])(_0x31a1ed),_0x1fade5=await(0x0,ShowUserService_1[_0x89fe98(0x164)])(_0xd3da35[_0x89fe98(0x13e)]),_0x519900=_0x89fe98(0x118)+_0x1fade5[_0x89fe98(0x157)]+_0x89fe98(0x165),_0x1648ec=await _0x1fda90['sendMessage'](_0x31a1ed[_0x89fe98(0x130)][_0x89fe98(0x149)]+'@'+(_0x31a1ed['isGroup']?'g.us':_0x89fe98(0x11c)),{'text':_0x519900});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x1648ec,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)],_0x2255c4);}else{if(_0x40c76b!==_0x3c459c&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x40c76b)&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3c459c)&&_0x2a30bb!==_0x3d1b06&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x2a30bb)&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3d1b06)){const _0x598eb0=await(0x0,GetTicketWbot_1[_0x89fe98(0x164)])(_0x31a1ed),_0x22c034=await Queue_1[_0x89fe98(0x164)][_0x89fe98(0x142)](_0x3d1b06),_0x574c1c=await(0x0,ShowUserService_1[_0x89fe98(0x164)])(_0xd3da35[_0x89fe98(0x13e)]),_0x5b5f15=_0x89fe98(0x10f)+_0x22c034?.[_0x89fe98(0x157)]+_0x89fe98(0x14a)+_0x574c1c['name']+_0x89fe98(0x165),_0x27ba95=await _0x598eb0[_0x89fe98(0x138)](_0x31a1ed['contact'][_0x89fe98(0x149)]+'@'+(_0x31a1ed[_0x89fe98(0x146)]?_0x89fe98(0x10e):'s.whatsapp.net'),{'text':_0x5b5f15});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x27ba95,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)]);}else{if(_0x40c76b!==undefined&&(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3c459c)&&_0x2a30bb!==_0x3d1b06&&!(0x0,lodash_1[_0x89fe98(0x12c)])(_0x3d1b06)){const _0x2b43e4=await Queue_1[_0x89fe98(0x164)][_0x89fe98(0x142)](_0x3d1b06),_0x11440b=await(0x0,GetTicketWbot_1[_0x89fe98(0x164)])(_0x31a1ed),_0x427fda=_0x89fe98(0x110)+_0x2b43e4?.[_0x89fe98(0x157)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x1bbe12=await _0x11440b[_0x89fe98(0x138)](_0x31a1ed[_0x89fe98(0x130)][_0x89fe98(0x149)]+'@'+(_0x31a1ed[_0x89fe98(0x146)]?_0x89fe98(0x10e):_0x89fe98(0x11c)),{'text':_0x427fda});await(0x0,wbotMessageListener_1[_0x89fe98(0x152)])(_0x1bbe12,_0x31a1ed,_0x31a1ed[_0x89fe98(0x130)]);}}}}}return await _0x31a1ed[_0x89fe98(0x15a)]({'status':_0x5e7290,'queueId':_0x3d1b06,'userId':_0x3c459c,'isBot':_0x211406,'queueOptionId':_0x1739f5,'amountUsedBotQueues':_0x5e7290===_0x89fe98(0x13b)?0x0:_0x1d2c5c?_0x1d2c5c:_0x31a1ed[_0x89fe98(0x122)],'lastMessage':_0x3e52c9?_0x3e52c9:_0x31a1ed['lastMessage']}),_0x2255c4[_0x89fe98(0x160)]=(0x0,moment_1[_0x89fe98(0x164)])()[_0x89fe98(0x124)](),_0x2255c4[_0x89fe98(0x140)]=_0x3d1b06,await _0x31a1ed['reload'](),_0x5e7290!==undefined&&['pending'][_0x89fe98(0x10c)](_0x5e7290)>-0x1&&_0x2255c4[_0x89fe98(0x15a)]({'whatsappId':_0x31a1ed[_0x89fe98(0x163)],'startedAt':null,'userId':null}),_0x5e7290!==undefined&&[_0x89fe98(0x11e)][_0x89fe98(0x10c)](_0x5e7290)>-0x1&&_0x2255c4[_0x89fe98(0x15a)]({'startedAt':(0x0,moment_1['default'])()[_0x89fe98(0x124)](),'ratingAt':null,'rated':![],'whatsappId':_0x31a1ed[_0x89fe98(0x163)],'userId':_0x31a1ed['userId'],'queueId':_0x31a1ed['queueId']}),(_0x31a1ed[_0x89fe98(0x169)]!==_0x5728cc||_0x31a1ed[_0x89fe98(0x112)]?.['id']!==_0x40c76b)&&(_0x2255c4[_0x89fe98(0x15a)]({'userId':_0x31a1ed['userId']}),_0x44a762['to'](_0x5728cc)['emit']('company-'+_0x971c37+_0x89fe98(0x14f),{'action':'delete','ticketId':_0x31a1ed['id']})),await _0x2255c4[_0x89fe98(0x13a)](),_0x44a762['to'](_0x31a1ed[_0x89fe98(0x169)])['to'](_0x89fe98(0x119))['to'](_0x181306[_0x89fe98(0x133)]())[_0x89fe98(0x135)](_0x89fe98(0x12e)+_0x971c37+'-ticket',{'action':_0x89fe98(0x15a),'ticket':_0x31a1ed,'ticketId':_0x181306}),{'ticket':_0x31a1ed,'oldStatus':_0x5728cc,'oldUserId':_0x40c76b};}catch(_0x3acee6){Sentry['captureException'](_0x3acee6);}};exports['default']=UpdateTicketService;