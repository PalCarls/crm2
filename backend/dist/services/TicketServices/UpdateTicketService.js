'use strict';function a600_0x1abf(_0x2e4e50,_0x48f23e){const _0x30e254=a600_0x30e2();return a600_0x1abf=function(_0x1abfce,_0x29f874){_0x1abfce=_0x1abfce-0x7a;let _0x383590=_0x30e254[_0x1abfce];return _0x383590;},a600_0x1abf(_0x2e4e50,_0x48f23e);}const a600_0x5d59f8=a600_0x1abf;(function(_0x5cc844,_0x24c9ec){const _0x1cd79c=a600_0x1abf,_0x54e49d=_0x5cc844();while(!![]){try{const _0x372038=-parseInt(_0x1cd79c(0x9d))/0x1*(-parseInt(_0x1cd79c(0xce))/0x2)+-parseInt(_0x1cd79c(0x85))/0x3*(-parseInt(_0x1cd79c(0xb8))/0x4)+parseInt(_0x1cd79c(0xe2))/0x5+parseInt(_0x1cd79c(0xd2))/0x6+-parseInt(_0x1cd79c(0xb4))/0x7*(parseInt(_0x1cd79c(0x99))/0x8)+parseInt(_0x1cd79c(0x7c))/0x9+-parseInt(_0x1cd79c(0xae))/0xa;if(_0x372038===_0x24c9ec)break;else _0x54e49d['push'](_0x54e49d['shift']());}catch(_0x301b1c){_0x54e49d['push'](_0x54e49d['shift']());}}}(a600_0x30e2,0x844ae));function a600_0x30e2(){const _0x985288=['amountUsedBotQueues','userRating','@sentry/node','6421530grpXcH','transfered','call','../UserServices/ShowUserService','queueOptionId','../../helpers/GetTicketWbot','notification','../FacebookServices/facebookMessageListener','\x20contact','../../models/Ticket','company-','__esModule','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','lodash','__importStar','./ShowTicketService','3005745rWjTfu','whatsappId','default','g.us','__setModuleDefault','../WhatsappService/ShowWhatsAppService','\x20is\x20a\x20valid\x20','verifyMessageFace','../FacebookServices/sendFacebookMessage','8133768wzUvWt','emit','closed','../../libs/socket','ratingAt','isNil','farewellMessage','name','closeTicket','1499496zSLudU','../../models/User','Checking\x20if\x20','s.whatsapp.net','channel','getOwnPropertyDescriptor','sendMsgTransfTicket','contact','queuedAt','queueId','toString','log','instagram','open','tagId','closeTicketOnTransfer','remoteJid','get','enabled','../WbotServices/wbotMessageListener','16NOVAje','userId','writable','status','1039ZpfmYs','pending','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','delete','group','__importDefault','user','-ticket','verifyMessage','includes','finishedAt','map','save','replace','update','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','updatedAt','18650420SRcvaU','sendFarewellWaitingTicket','PVT','findByPk','hasOwnProperty','extendedTextMessage','3072839LIAikU','facebook','../../models/CompaniesSettings','create','4MkjeWf','receivedTransfer','reload','lastMessage','closedAt','companyId','nps','captureException','sendMessage','sequelize','toDate','reopen','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','indexOf','findOne','isGroup','defineProperty','whatsapp','../WbotServices/SendWhatsAppMessage','./FindOrCreateTicketService','configurable','number','404AOVWvp'];a600_0x30e2=function(){return _0x985288;};return a600_0x30e2();}var __createBinding=this&&this['__createBinding']||(Object[a600_0x5d59f8(0xb7)]?function(_0x5cb7ea,_0x6b2387,_0x5e9414,_0x3f9238){const _0x5c599d=a600_0x5d59f8;if(_0x3f9238===undefined)_0x3f9238=_0x5e9414;var _0x4d8181=Object[_0x5c599d(0x8a)](_0x6b2387,_0x5e9414);(!_0x4d8181||(_0x5c599d(0x96)in _0x4d8181?!_0x6b2387[_0x5c599d(0xdd)]:_0x4d8181[_0x5c599d(0x9b)]||_0x4d8181[_0x5c599d(0xcc)]))&&(_0x4d8181={'enumerable':!![],'get':function(){return _0x6b2387[_0x5e9414];}}),Object['defineProperty'](_0x5cb7ea,_0x3f9238,_0x4d8181);}:function(_0x3a31a7,_0x3609b8,_0x23bd25,_0x411a93){if(_0x411a93===undefined)_0x411a93=_0x23bd25;_0x3a31a7[_0x411a93]=_0x3609b8[_0x23bd25];}),__setModuleDefault=this&&this[a600_0x5d59f8(0xe6)]||(Object[a600_0x5d59f8(0xb7)]?function(_0x7b75f5,_0x367e99){const _0x3810bb=a600_0x5d59f8;Object[_0x3810bb(0xc8)](_0x7b75f5,_0x3810bb(0xe4),{'enumerable':!![],'value':_0x367e99});}:function(_0x223538,_0x36534e){const _0x30363b=a600_0x5d59f8;_0x223538[_0x30363b(0xe4)]=_0x36534e;}),__importStar=this&&this[a600_0x5d59f8(0xe0)]||function(_0x313cac){const _0x5eec9a=a600_0x5d59f8;if(_0x313cac&&_0x313cac['__esModule'])return _0x313cac;var _0x143607={};if(_0x313cac!=null){for(var _0x377436 in _0x313cac)if(_0x377436!==_0x5eec9a(0xe4)&&Object['prototype'][_0x5eec9a(0xb2)][_0x5eec9a(0xd4)](_0x313cac,_0x377436))__createBinding(_0x143607,_0x313cac,_0x377436);}return __setModuleDefault(_0x143607,_0x313cac),_0x143607;},__importDefault=this&&this[a600_0x5d59f8(0xa2)]||function(_0x27923f){const _0x312db2=a600_0x5d59f8;return _0x27923f&&_0x27923f[_0x312db2(0xdd)]?_0x27923f:{'default':_0x27923f};};Object['defineProperty'](exports,a600_0x5d59f8(0xdd),{'value':!![]});const moment_1=__importDefault(require('moment')),Sentry=__importStar(require(a600_0x5d59f8(0xd1))),sequelize_1=require(a600_0x5d59f8(0xc1)),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require(a600_0x5d59f8(0x7f)),Ticket_1=__importDefault(require(a600_0x5d59f8(0xdb))),Queue_1=__importDefault(require('../../models/Queue')),ShowTicketService_1=__importDefault(require(a600_0x5d59f8(0xe1))),ShowWhatsAppService_1=__importDefault(require(a600_0x5d59f8(0xe7))),SendWhatsAppMessage_1=__importDefault(require(a600_0x5d59f8(0xca))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a600_0x5d59f8(0xd7))),wbotMessageListener_1=require(a600_0x5d59f8(0x98)),lodash_1=require(a600_0x5d59f8(0xdf)),sendFacebookMessage_1=__importDefault(require(a600_0x5d59f8(0x7b))),facebookMessageListener_1=require(a600_0x5d59f8(0xd9)),ShowUserService_1=__importDefault(require(a600_0x5d59f8(0xd5))),User_1=__importDefault(require(a600_0x5d59f8(0x86))),CompaniesSettings_1=__importDefault(require(a600_0x5d59f8(0xb6))),CreateLogTicketService_1=__importDefault(require('./CreateLogTicketService')),TicketTag_1=__importDefault(require('../../models/TicketTag')),Tag_1=__importDefault(require('../../models/Tag')),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),FindOrCreateTicketService_1=__importDefault(require(a600_0x5d59f8(0xcb))),UpdateTicketService=async({ticketData:_0x5039f3,ticketId:_0x1e7fc9,companyId:_0x500c6b})=>{const _0x4f512c=a600_0x5d59f8;try{let {status:_0x499088}=_0x5039f3,{queueId:_0x213c89,userId:_0x5277b7,sendFarewellMessage:_0x412e74,amountUsedBotQueues:_0x1253f6,lastMessage:_0x465494,integrationId:_0xbe2dee,useIntegration:_0x4b1b73,unreadMessages:_0x5888da,msgTransfer:_0x38efc2,isTransfered:isTransfered=![]}=_0x5039f3,_0xa66a15=_0x5039f3['isBot']||![],_0x44040b=_0x5039f3[_0x4f512c(0xd6)]||null;const _0x443b0d=(0x0,socket_1['getIO'])(),_0xbabb19=await CompaniesSettings_1['default'][_0x4f512c(0xc6)]({'where':{'companyId':_0x500c6b}});let _0x1391b3=await(0x0,ShowTicketService_1[_0x4f512c(0xe4)])(_0x1e7fc9,_0x500c6b);_0x1391b3[_0x4f512c(0x89)]===_0x4f512c(0xc9)&&await(0x0,SetTicketMessagesAsRead_1[_0x4f512c(0xe4)])(_0x1391b3);const _0x2dee74=_0x1391b3?.[_0x4f512c(0x9c)],_0x3fa04f=_0x1391b3[_0x4f512c(0xa3)]?.['id'],_0x22dc35=_0x1391b3?.[_0x4f512c(0x8e)];if(_0x2dee74===_0x4f512c(0x7e)){let _0x5e3ed2=await Ticket_1[_0x4f512c(0xe4)][_0x4f512c(0xc6)]({'where':{'contactId':_0x1391b3['contactId'],'status':{[sequelize_1['Op']['or']]:[_0x4f512c(0x92),_0x4f512c(0x9e),_0x4f512c(0xa1)]},'whatsappId':_0x1391b3[_0x4f512c(0xe3)]}});if(_0x5e3ed2){if(_0x5e3ed2['id']!==_0x1391b3['id'])return _0x5e3ed2=await(0x0,ShowTicketService_1['default'])(_0x5e3ed2['id'],_0x500c6b),{'ticket':_0x5e3ed2,'oldStatus':_0x2dee74,'oldUserId':_0x3fa04f};}_0xa66a15=![];}const _0x5aa8fe=await(0x0,FindOrCreateATicketTrakingService_1[_0x4f512c(0xe4)])({'ticketId':_0x1e7fc9,'companyId':_0x500c6b,'whatsappId':_0x1391b3[_0x4f512c(0xe3)]}),{complationMessage:_0x3647e2,ratingMessage:_0x5568a9,groupAsTicket:_0x35b911}=await(0x0,ShowWhatsAppService_1[_0x4f512c(0xe4)])(_0x1391b3[_0x4f512c(0xe3)],_0x500c6b);if(_0x499088!==undefined&&[_0x4f512c(0x7e)][_0x4f512c(0xc5)](_0x499088)>-0x1){const _0x50d48e=_0x1391b3[_0x4f512c(0x9a)]||_0x5277b7,_0x2c2690=await User_1[_0x4f512c(0xe4)][_0x4f512c(0xb1)](_0x50d48e);if(_0xbabb19[_0x4f512c(0xd0)]==='enabled'&&(_0x412e74||_0x412e74===undefined)&&(!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5568a9)&&_0x5568a9!=='')&&!_0x1391b3['isGroup']){if(_0x5aa8fe[_0x4f512c(0x80)]==null){const _0x44c3aa=_0x5568a9||'';let _0x1919cf='‎'+_0x44c3aa+'\x0a';if(_0x1391b3[_0x4f512c(0x89)]===_0x4f512c(0xc9)){const _0x21d78e=await(0x0,SendWhatsAppMessage_1[_0x4f512c(0xe4)])({'body':_0x1919cf,'ticket':_0x1391b3,'isForwarded':![]});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x21d78e,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)]);}if(['facebook','instagram']['includes'](_0x1391b3[_0x4f512c(0x89)])){console['log'](_0x4f512c(0x87)+_0x1391b3[_0x4f512c(0x8c)]['number']+_0x4f512c(0xe8)+_0x1391b3[_0x4f512c(0x89)]+_0x4f512c(0xda));const _0x1dc06d=await(0x0,sendFacebookMessage_1[_0x4f512c(0xe4)])({'body':_0x1919cf,'ticket':_0x1391b3});await(0x0,facebookMessageListener_1[_0x4f512c(0x7a)])(_0x1dc06d,_0x1919cf,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)]);}await _0x5aa8fe['update']({'userId':_0x1391b3[_0x4f512c(0x9a)],'closedAt':(0x0,moment_1[_0x4f512c(0xe4)])()[_0x4f512c(0xc2)]()}),await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x1391b3[_0x4f512c(0x9a)],'queueId':_0x1391b3[_0x4f512c(0x8e)],'ticketId':_0x1e7fc9,'type':_0x4f512c(0xbe)});try{const _0x1adc94=await TicketTag_1[_0x4f512c(0xe4)]['findAll']({'where':{'ticketId':_0x1e7fc9}}),_0x5ebbda=_0x1adc94[_0x4f512c(0xa8)](_0x3d4cb9=>_0x3d4cb9[_0x4f512c(0x93)]),_0x5a3e47=await Tag_1[_0x4f512c(0xe4)]['findAll']({'where':{'id':_0x5ebbda,'kanban':0x1}}),_0x1df520=_0x5a3e47[_0x4f512c(0xa8)](_0x2bb6e7=>_0x2bb6e7['id']);if(_0x1df520)await TicketTag_1[_0x4f512c(0xe4)]['destroy']({'where':{'ticketId':_0x1e7fc9,'tagId':_0x1df520}});}catch(_0xd593b9){Sentry[_0x4f512c(0xbf)](_0xd593b9);}return await _0x1391b3[_0x4f512c(0xab)]({'status':_0x4f512c(0xbe),'amountUseBotQueuesNPS':0x1}),_0x443b0d['to'](_0x4f512c(0x92))['to'](_0x1e7fc9[_0x4f512c(0x8f)]())[_0x4f512c(0x7d)](_0x4f512c(0xdc)+_0x1391b3['companyId']+'-ticket',{'action':_0x4f512c(0xa0),'ticketId':_0x1391b3['id']}),{'ticket':_0x1391b3,'oldStatus':_0x2dee74,'oldUserId':_0x3fa04f};}}if((!(0x0,lodash_1['isNil'])(_0x2c2690?.[_0x4f512c(0x82)])&&_0x2c2690?.['farewellMessage']!==''||!(0x0,lodash_1['isNil'])(_0x3647e2)&&_0x3647e2!=='')&&(_0x412e74||_0x412e74===undefined)){let _0x31872e;if(_0x1391b3['status']!==_0x4f512c(0x9e)||_0x1391b3[_0x4f512c(0x9c)]===_0x4f512c(0x9e)&&_0xbabb19[_0x4f512c(0xaf)]==='enabled'){!(0x0,lodash_1[_0x4f512c(0x81)])(_0x2c2690)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x2c2690?.['farewellMessage'])&&_0x2c2690?.[_0x4f512c(0x82)]!==''?_0x31872e='‎\x20'+_0x2c2690[_0x4f512c(0x82)]:_0x31872e='‎\x20'+_0x3647e2;if(_0x1391b3['channel']===_0x4f512c(0xc9)&&(!_0x1391b3[_0x4f512c(0xc7)]||_0x35b911===_0x4f512c(0x97))){const _0x8aaabb=await(0x0,SendWhatsAppMessage_1[_0x4f512c(0xe4)])({'body':_0x31872e,'ticket':_0x1391b3,'isForwarded':![]});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x8aaabb,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)]);}if([_0x4f512c(0xb5),_0x4f512c(0x91)][_0x4f512c(0xa6)](_0x1391b3[_0x4f512c(0x89)])&&(!_0x1391b3[_0x4f512c(0xc7)]||_0x35b911===_0x4f512c(0x97))){console[_0x4f512c(0x90)](_0x4f512c(0x87)+_0x1391b3[_0x4f512c(0x8c)][_0x4f512c(0xcd)]+'\x20is\x20a\x20valid\x20'+_0x1391b3[_0x4f512c(0x89)]+_0x4f512c(0xda));const _0x1b923a=await(0x0,sendFacebookMessage_1[_0x4f512c(0xe4)])({'body':_0x31872e,'ticket':_0x1391b3});}}}return _0x5aa8fe[_0x4f512c(0xa7)]=(0x0,moment_1[_0x4f512c(0xe4)])()[_0x4f512c(0xc2)](),_0x5aa8fe[_0x4f512c(0xbc)]=(0x0,moment_1['default'])()['toDate'](),_0x5aa8fe['whatsappId']=_0x1391b3[_0x4f512c(0xe3)],_0x5aa8fe['userId']=_0x1391b3[_0x4f512c(0x9a)],await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x5277b7,'queueId':_0x1391b3[_0x4f512c(0x8e)],'ticketId':_0x1e7fc9,'type':_0x4f512c(0x7e)}),await _0x5aa8fe[_0x4f512c(0xa9)](),await _0x1391b3[_0x4f512c(0xab)]({'status':_0x4f512c(0x7e)}),_0x443b0d['to'](_0x2dee74)['to'](_0x1e7fc9['toString']())[_0x4f512c(0x7d)](_0x4f512c(0xdc)+_0x1391b3[_0x4f512c(0xbd)]+_0x4f512c(0xa4),{'action':_0x4f512c(0xa0),'ticketId':_0x1391b3['id']}),{'ticket':_0x1391b3,'oldStatus':_0x2dee74,'oldUserId':_0x3fa04f};}!(0x0,lodash_1[_0x4f512c(0x81)])(_0x213c89)&&(_0x5aa8fe[_0x4f512c(0x8d)]=(0x0,moment_1['default'])()[_0x4f512c(0xc2)]());const _0x394c40=await Queue_1[_0x4f512c(0xe4)][_0x4f512c(0xb1)](_0x213c89);if(isTransfered){if(_0xbabb19[_0x4f512c(0x94)]){let _0xd0c7ad=_0x1391b3;if(_0x22dc35!==_0x213c89){await _0x1391b3[_0x4f512c(0xab)]({'status':_0x4f512c(0x7e)}),await _0x1391b3[_0x4f512c(0xba)](),_0x443b0d['to'](_0x2dee74)['to'](_0x1e7fc9[_0x4f512c(0x8f)]())[_0x4f512c(0x7d)](_0x4f512c(0xdc)+_0x1391b3[_0x4f512c(0xbd)]+'-ticket',{'action':'delete','ticketId':_0x1391b3['id']});const {ticket:_0x1fa7e2}=await(0x0,FindOrCreateTicketService_1[_0x4f512c(0xe4)])(_0x1391b3['contact'],_0x1391b3[_0x4f512c(0xc9)],0x1,_0x1391b3[_0x4f512c(0xbd)],_0x213c89,_0x5277b7,null,'whatsapp',![],![],_0xbabb19,isTransfered);_0xd0c7ad=_0x1fa7e2;}if(!(0x0,lodash_1[_0x4f512c(0x81)])(_0x38efc2)){const _0xd5c84e={'wid':_0x4f512c(0xb0)+_0xd0c7ad[_0x4f512c(0xad)]['toString']()[_0x4f512c(0xaa)]('\x20',''),'ticketId':_0xd0c7ad['id'],'contactId':undefined,'body':_0x38efc2,'fromMe':!![],'mediaType':'extendedTextMessage','read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0xd0c7ad[_0x4f512c(0x8c)]?.[_0x4f512c(0x95)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1[_0x4f512c(0xe4)])({'messageData':_0xd5c84e,'companyId':_0x1391b3[_0x4f512c(0xbd)]});}await _0xd0c7ad[_0x4f512c(0xab)]({'queueId':_0x213c89,'userId':_0x5277b7,'status':_0x499088}),await _0xd0c7ad['reload']();if(_0xbabb19[_0x4f512c(0x8b)]===_0x4f512c(0x97)){if(_0x22dc35!==_0x213c89&&_0x3fa04f===_0x5277b7&&!(0x0,lodash_1['isNil'])(_0x22dc35)&&!(0x0,lodash_1['isNil'])(_0x213c89)){const _0x4a52c1=await(0x0,GetTicketWbot_1[_0x4f512c(0xe4)])(_0x1391b3),_0x5813ab='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x394c40?.[_0x4f512c(0x83)]+_0x4f512c(0xde),_0x386a39=await _0x4a52c1[_0x4f512c(0xc0)](_0x1391b3[_0x4f512c(0x8c)][_0x4f512c(0xcd)]+'@'+(_0x1391b3[_0x4f512c(0xc7)]?_0x4f512c(0xe5):_0x4f512c(0x88)),{'text':_0x5813ab});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x386a39,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)],_0x5aa8fe);}else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35===_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&(!_0x1391b3[_0x4f512c(0xc7)]||_0x35b911===_0x4f512c(0x97))){const _0x29d7a7=await(0x0,GetTicketWbot_1['default'])(_0x1391b3),_0x1390a9=await(0x0,ShowUserService_1[_0x4f512c(0xe4)])(_0x5039f3['userId'],_0x500c6b),_0x4d0b29=_0x4f512c(0xc4)+_0x1390a9[_0x4f512c(0x83)]+_0x4f512c(0xac),_0x24db75=await _0x29d7a7['sendMessage'](_0x1391b3['contact']['number']+'@'+(_0x1391b3[_0x4f512c(0xc7)]?_0x4f512c(0xe5):_0x4f512c(0x88)),{'text':_0x4d0b29});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x24db75,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)],_0x5aa8fe);}else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&(!_0x1391b3[_0x4f512c(0xc7)]||_0x35b911===_0x4f512c(0x97))){const _0x3d4435=await(0x0,GetTicketWbot_1[_0x4f512c(0xe4)])(_0x1391b3),_0x4dfd3c=await(0x0,ShowUserService_1[_0x4f512c(0xe4)])(_0x5039f3[_0x4f512c(0x9a)],_0x500c6b),_0x2dbe68=_0x4f512c(0x9f)+_0x394c40?.['name']+'*\x20e\x20será\x20atendido\x20por\x20*'+_0x4dfd3c[_0x4f512c(0x83)]+_0x4f512c(0xac),_0x4bc60e=await _0x3d4435[_0x4f512c(0xc0)](_0x1391b3[_0x4f512c(0x8c)][_0x4f512c(0xcd)]+'@'+(_0x1391b3['isGroup']?'g.us':_0x4f512c(0x88)),{'text':_0x2dbe68});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x4bc60e,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)]);}else{if(_0x3fa04f!==undefined&&(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x213c89)){const _0x15a807=await(0x0,GetTicketWbot_1[_0x4f512c(0xe4)])(_0x1391b3),_0x201d79=_0x4f512c(0x9f)+_0x394c40?.[_0x4f512c(0x83)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x476823=await _0x15a807[_0x4f512c(0xc0)](_0x1391b3['contact'][_0x4f512c(0xcd)]+'@'+(_0x1391b3[_0x4f512c(0xc7)]?'g.us':_0x4f512c(0x88)),{'text':_0x201d79});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x476823,_0x1391b3,_0x1391b3['contact']);}}}}}if(_0x3fa04f!==_0x5277b7&&_0x22dc35===_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)});else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35===_0x213c89&&!(0x0,lodash_1['isNil'])(_0x3fa04f)&&!(0x0,lodash_1['isNil'])(_0x5277b7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':'transfered'}),await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x5277b7,'queueId':_0x22dc35,'ticketId':_0xd0c7ad['id'],'type':_0x4f512c(0xb9)});else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1['isNil'])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)}),await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x5277b7,'queueId':_0x213c89,'ticketId':_0xd0c7ad['id'],'type':_0x4f512c(0xb9)});else _0x3fa04f!==undefined&&(0x0,lodash_1['isNil'])(_0x5277b7)&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x213c89)&&await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)});}}return(_0xd0c7ad[_0x4f512c(0x9c)]!==_0x2dee74||_0xd0c7ad['user']?.['id']!==_0x3fa04f)&&(await _0x5aa8fe[_0x4f512c(0xab)]({'userId':_0xd0c7ad['userId']}),_0x443b0d['to'](_0x2dee74)[_0x4f512c(0x7d)]('company-'+_0x500c6b+_0x4f512c(0xa4),{'action':_0x4f512c(0xa0),'ticketId':_0xd0c7ad['id']})),_0x443b0d['to'](_0xd0c7ad[_0x4f512c(0x9c)])['to'](_0x4f512c(0xd8))['to'](_0xd0c7ad['id']['toString']())[_0x4f512c(0x7d)](_0x4f512c(0xdc)+_0x500c6b+_0x4f512c(0xa4),{'action':_0x4f512c(0xab),'ticket':_0xd0c7ad}),{'ticket':_0xd0c7ad,'oldStatus':_0x2dee74,'oldUserId':_0x3fa04f};}else{if(_0xbabb19[_0x4f512c(0x8b)]===_0x4f512c(0x97)){if(_0x22dc35!==_0x213c89&&_0x3fa04f===_0x5277b7&&!(0x0,lodash_1['isNil'])(_0x22dc35)&&!(0x0,lodash_1['isNil'])(_0x213c89)){const _0x1c6148=await(0x0,GetTicketWbot_1[_0x4f512c(0xe4)])(_0x1391b3),_0x2dcc9d=_0x4f512c(0x9f)+_0x394c40?.[_0x4f512c(0x83)]+'\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x13d150=await _0x1c6148[_0x4f512c(0xc0)](_0x1391b3[_0x4f512c(0x8c)]['number']+'@'+(_0x1391b3[_0x4f512c(0xc7)]?'g.us':_0x4f512c(0x88)),{'text':_0x2dcc9d});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x13d150,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)],_0x5aa8fe);}else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35===_0x213c89&&!(0x0,lodash_1['isNil'])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&(!_0x1391b3['isGroup']||_0x35b911==='enabled')){const _0x29efba=await(0x0,GetTicketWbot_1['default'])(_0x1391b3),_0x1d13fa=await(0x0,ShowUserService_1[_0x4f512c(0xe4)])(_0x5039f3[_0x4f512c(0x9a)],_0x500c6b),_0x174b3d=_0x4f512c(0xc4)+_0x1d13fa[_0x4f512c(0x83)]+_0x4f512c(0xac),_0x442c0d=await _0x29efba[_0x4f512c(0xc0)](_0x1391b3[_0x4f512c(0x8c)]['number']+'@'+(_0x1391b3[_0x4f512c(0xc7)]?_0x4f512c(0xe5):'s.whatsapp.net'),{'text':_0x174b3d});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x442c0d,_0x1391b3,_0x1391b3['contact'],_0x5aa8fe);}else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&(!_0x1391b3[_0x4f512c(0xc7)]||_0x35b911===_0x4f512c(0x97))){const _0x3ef99e=await(0x0,GetTicketWbot_1[_0x4f512c(0xe4)])(_0x1391b3),_0xcd8945=await(0x0,ShowUserService_1['default'])(_0x5039f3['userId'],_0x500c6b),_0x42a787=_0x4f512c(0x9f)+_0x394c40?.['name']+'*\x20e\x20será\x20atendido\x20por\x20*'+_0xcd8945[_0x4f512c(0x83)]+_0x4f512c(0xac),_0x18a3a4=await _0x3ef99e[_0x4f512c(0xc0)](_0x1391b3[_0x4f512c(0x8c)][_0x4f512c(0xcd)]+'@'+(_0x1391b3['isGroup']?_0x4f512c(0xe5):_0x4f512c(0x88)),{'text':_0x42a787});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x18a3a4,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)]);}else{if(_0x3fa04f!==undefined&&(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1['isNil'])(_0x213c89)){const _0x51cd8d=await(0x0,GetTicketWbot_1[_0x4f512c(0xe4)])(_0x1391b3),_0x22fb3f='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x394c40?.['name']+_0x4f512c(0xac),_0x1134a7=await _0x51cd8d[_0x4f512c(0xc0)](_0x1391b3[_0x4f512c(0x8c)][_0x4f512c(0xcd)]+'@'+(_0x1391b3[_0x4f512c(0xc7)]?_0x4f512c(0xe5):_0x4f512c(0x88)),{'text':_0x22fb3f});await(0x0,wbotMessageListener_1[_0x4f512c(0xa5)])(_0x1134a7,_0x1391b3,_0x1391b3[_0x4f512c(0x8c)]);}}}}}if(!(0x0,lodash_1[_0x4f512c(0x81)])(_0x38efc2)){const _0x9b7e68={'wid':'PVT'+_0x1391b3[_0x4f512c(0xad)]['toString']()[_0x4f512c(0xaa)]('\x20',''),'ticketId':_0x1391b3['id'],'contactId':undefined,'body':_0x38efc2,'fromMe':!![],'mediaType':_0x4f512c(0xb3),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x1391b3[_0x4f512c(0x8c)]?.[_0x4f512c(0x95)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1['default'])({'messageData':_0x9b7e68,'companyId':_0x1391b3[_0x4f512c(0xbd)]});}if(_0x3fa04f!==_0x5277b7&&_0x22dc35===_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&!(0x0,lodash_1['isNil'])(_0x5277b7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)});else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35===_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)}),await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x5277b7,'queueId':_0x22dc35,'ticketId':_0x1391b3['id'],'type':_0x4f512c(0xb9)});else{if(_0x3fa04f!==_0x5277b7&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1['isNil'])(_0x3fa04f)&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7))await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)}),await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x5277b7,'queueId':_0x213c89,'ticketId':_0x1391b3['id'],'type':'receivedTransfer'});else _0x3fa04f!==undefined&&(0x0,lodash_1[_0x4f512c(0x81)])(_0x5277b7)&&_0x22dc35!==_0x213c89&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x213c89)&&await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x3fa04f,'queueId':_0x22dc35,'ticketId':_0x1e7fc9,'type':_0x4f512c(0xd3)});}}}}return _0x499088=_0x394c40[_0x4f512c(0x84)]?_0x4f512c(0x7e):_0x499088,await _0x1391b3['update']({'status':_0x499088,'queueId':_0x213c89,'userId':_0x5277b7,'isBot':_0xa66a15,'queueOptionId':_0x44040b,'amountUsedBotQueues':_0x499088===_0x4f512c(0x7e)?0x0:_0x1253f6?_0x1253f6:_0x1391b3[_0x4f512c(0xcf)],'lastMessage':_0x465494?_0x465494:_0x1391b3[_0x4f512c(0xbb)],'useIntegration':_0x4b1b73,'integrationId':_0xbe2dee,'unreadMessages':_0x5888da}),_0x5aa8fe[_0x4f512c(0x8d)]=(0x0,moment_1[_0x4f512c(0xe4)])()[_0x4f512c(0xc2)](),_0x5aa8fe[_0x4f512c(0x8e)]=_0x213c89,_0x1391b3=await(0x0,ShowTicketService_1[_0x4f512c(0xe4)])(_0x1391b3['id'],_0x500c6b),_0x499088!==undefined&&[_0x4f512c(0x9e)][_0x4f512c(0xc5)](_0x499088)>-0x1&&!(0x0,lodash_1[_0x4f512c(0x81)])(_0x3fa04f)&&(await(0x0,CreateLogTicketService_1['default'])({'userId':_0x3fa04f,'ticketId':_0x1e7fc9,'type':_0x4f512c(0x9e)}),await _0x5aa8fe[_0x4f512c(0xab)]({'whatsappId':_0x1391b3[_0x4f512c(0xe3)],'startedAt':null,'userId':null})),_0x499088!==undefined&&_0x499088!==_0x2dee74&&[_0x4f512c(0x92)][_0x4f512c(0xc5)](_0x499088)>-0x1&&(await _0x5aa8fe[_0x4f512c(0xab)]({'startedAt':(0x0,moment_1[_0x4f512c(0xe4)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0x1391b3[_0x4f512c(0xe3)],'userId':_0x1391b3[_0x4f512c(0x9a)],'queueId':_0x1391b3[_0x4f512c(0x8e)]}),await(0x0,CreateLogTicketService_1[_0x4f512c(0xe4)])({'userId':_0x5277b7,'queueId':_0x1391b3[_0x4f512c(0x8e)],'ticketId':_0x1e7fc9,'type':_0x2dee74===_0x4f512c(0x9e)?'open':_0x4f512c(0xc3)})),await _0x5aa8fe[_0x4f512c(0xa9)](),(_0x1391b3['status']!==_0x2dee74||_0x1391b3[_0x4f512c(0xa3)]?.['id']!==_0x3fa04f)&&(await _0x5aa8fe[_0x4f512c(0xab)]({'userId':_0x1391b3['userId']}),_0x443b0d['to'](_0x2dee74)['emit'](_0x4f512c(0xdc)+_0x500c6b+_0x4f512c(0xa4),{'action':'delete','ticketId':_0x1391b3['id']})),_0x443b0d['to'](_0x1391b3[_0x4f512c(0x9c)])['to'](_0x4f512c(0xd8))['to'](_0x1e7fc9[_0x4f512c(0x8f)]())['emit'](_0x4f512c(0xdc)+_0x500c6b+_0x4f512c(0xa4),{'action':_0x4f512c(0xab),'ticket':_0x1391b3}),{'ticket':_0x1391b3,'oldStatus':_0x2dee74,'oldUserId':_0x3fa04f};}catch(_0x3215f2){Sentry['captureException'](_0x3215f2);}};exports[a600_0x5d59f8(0xe4)]=UpdateTicketService;