'use strict';const a490_0x601fb4=a490_0x36df;(function(_0x2c6395,_0xf2d883){const _0x5625eb=a490_0x36df,_0x57ea63=_0x2c6395();while(!![]){try{const _0x430e38=-parseInt(_0x5625eb(0x186))/0x1*(parseInt(_0x5625eb(0x194))/0x2)+-parseInt(_0x5625eb(0x1b6))/0x3*(-parseInt(_0x5625eb(0x184))/0x4)+-parseInt(_0x5625eb(0x174))/0x5*(-parseInt(_0x5625eb(0x1be))/0x6)+parseInt(_0x5625eb(0x1c7))/0x7+-parseInt(_0x5625eb(0x1a8))/0x8+parseInt(_0x5625eb(0x1bb))/0x9+-parseInt(_0x5625eb(0x1b8))/0xa*(-parseInt(_0x5625eb(0x196))/0xb);if(_0x430e38===_0xf2d883)break;else _0x57ea63['push'](_0x57ea63['shift']());}catch(_0x44e871){_0x57ea63['push'](_0x57ea63['shift']());}}}(a490_0x4852,0xe2d99));var __createBinding=this&&this[a490_0x601fb4(0x17c)]||(Object[a490_0x601fb4(0x1bd)]?function(_0x2176ff,_0x526ba6,_0x1a7c54,_0x4252ae){const _0x415b2d=a490_0x601fb4;if(_0x4252ae===undefined)_0x4252ae=_0x1a7c54;var _0x1b2c7d=Object[_0x415b2d(0x17e)](_0x526ba6,_0x1a7c54);(!_0x1b2c7d||('get'in _0x1b2c7d?!_0x526ba6[_0x415b2d(0x17b)]:_0x1b2c7d[_0x415b2d(0x1b5)]||_0x1b2c7d['configurable']))&&(_0x1b2c7d={'enumerable':!![],'get':function(){return _0x526ba6[_0x1a7c54];}}),Object[_0x415b2d(0x193)](_0x2176ff,_0x4252ae,_0x1b2c7d);}:function(_0x8e078d,_0x36dae9,_0x19cf74,_0x469a12){if(_0x469a12===undefined)_0x469a12=_0x19cf74;_0x8e078d[_0x469a12]=_0x36dae9[_0x19cf74];}),__setModuleDefault=this&&this[a490_0x601fb4(0x19b)]||(Object[a490_0x601fb4(0x1bd)]?function(_0x3d19e4,_0x4aef34){const _0x37ef4d=a490_0x601fb4;Object['defineProperty'](_0x3d19e4,_0x37ef4d(0x1cc),{'enumerable':!![],'value':_0x4aef34});}:function(_0x446609,_0x2be6ed){const _0x32817a=a490_0x601fb4;_0x446609[_0x32817a(0x1cc)]=_0x2be6ed;}),__importStar=this&&this[a490_0x601fb4(0x1a6)]||function(_0x22002f){const _0x5ebf01=a490_0x601fb4;if(_0x22002f&&_0x22002f[_0x5ebf01(0x17b)])return _0x22002f;var _0x8c3947={};if(_0x22002f!=null){for(var _0x18f6a9 in _0x22002f)if(_0x18f6a9!==_0x5ebf01(0x1cc)&&Object[_0x5ebf01(0x182)][_0x5ebf01(0x17a)][_0x5ebf01(0x198)](_0x22002f,_0x18f6a9))__createBinding(_0x8c3947,_0x22002f,_0x18f6a9);}return __setModuleDefault(_0x8c3947,_0x22002f),_0x8c3947;},__importDefault=this&&this[a490_0x601fb4(0x17f)]||function(_0x3fb71e){const _0x271b83=a490_0x601fb4;return _0x3fb71e&&_0x3fb71e[_0x271b83(0x17b)]?_0x3fb71e:{'default':_0x3fb71e};};Object[a490_0x601fb4(0x193)](exports,a490_0x601fb4(0x17b),{'value':!![]});function a490_0x36df(_0x338e39,_0x518a06){const _0x4852a1=a490_0x4852();return a490_0x36df=function(_0x36dfd4,_0x44182b){_0x36dfd4=_0x36dfd4-0x173;let _0x1e5d9e=_0x4852a1[_0x36dfd4];return _0x1e5d9e;},a490_0x36df(_0x338e39,_0x518a06);}const moment_1=__importDefault(require(a490_0x601fb4(0x1ca))),Sentry=__importStar(require(a490_0x601fb4(0x1a9))),sequelize_1=require('sequelize'),SetTicketMessagesAsRead_1=__importDefault(require(a490_0x601fb4(0x1cd))),socket_1=require(a490_0x601fb4(0x173)),Ticket_1=__importDefault(require('../../models/Ticket')),Setting_1=__importDefault(require(a490_0x601fb4(0x1ac))),Queue_1=__importDefault(require(a490_0x601fb4(0x185))),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require('../WbotServices/SendWhatsAppMessage')),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a490_0x601fb4(0x183))),wbotMessageListener_1=require(a490_0x601fb4(0x1b7)),lodash_1=require(a490_0x601fb4(0x1a4)),ListSettingsServiceOne_1=__importDefault(require(a490_0x601fb4(0x18a))),sendFacebookMessage_1=__importDefault(require(a490_0x601fb4(0x1a7))),ShowUserService_1=__importDefault(require(a490_0x601fb4(0x1c4))),User_1=__importDefault(require('../../models/User')),UpdateTicketService=async({ticketData:_0x383c91,ticketId:_0x2268ab,companyId:_0x16ae7c})=>{const _0x3fdc6e=a490_0x601fb4;try{const {status:_0x39c7f5}=_0x383c91;let {queueId:_0x5a2d65,userId:_0x1166b8,sendFarewellMessage:_0x302c5e,amountUsedBotQueues:_0x4de99e}=_0x383c91,_0x2a9816=_0x383c91['isBot']||![],_0x4b128e=_0x383c91['queueOptionId']||null;const _0x2cf4f9=(0x0,socket_1[_0x3fdc6e(0x189)])(),_0x3fb84c=await Setting_1[_0x3fdc6e(0x1cc)][_0x3fdc6e(0x18b)]({'where':{'companyId':_0x16ae7c,'key':_0x3fdc6e(0x17d)}});let _0x36965c=await Setting_1['default'][_0x3fdc6e(0x18b)]({'where':{'key':'sendFarewellWaitingTicket','companyId':_0x16ae7c}});const _0x374f19=await(0x0,ShowTicketService_1['default'])(_0x2268ab,_0x16ae7c);_0x374f19[_0x3fdc6e(0x18e)]===_0x3fdc6e(0x1a0)&&await(0x0,SetTicketMessagesAsRead_1['default'])(_0x374f19);const _0x3a0c0a=_0x374f19?.[_0x3fdc6e(0x19e)],_0x7a4eae=_0x374f19['user']?.['id'],_0x3b3ccb=_0x374f19?.[_0x3fdc6e(0x1af)];if(_0x3a0c0a===_0x3fdc6e(0x1ad)){const _0x2947b8=await Ticket_1[_0x3fdc6e(0x1cc)][_0x3fdc6e(0x18b)]({'where':{'contactId':_0x374f19[_0x3fdc6e(0x177)],'status':{[sequelize_1['Op']['or']]:[_0x3fdc6e(0x18c),_0x3fdc6e(0x1a3),_0x3fdc6e(0x1ce)]},'whatsappId':_0x374f19[_0x3fdc6e(0x1b4)]},'include':[{'model':Queue_1['default'],'as':'queue','attributes':['id',_0x3fdc6e(0x1c8),_0x3fdc6e(0x176)]},{'model':User_1[_0x3fdc6e(0x1cc)],'as':_0x3fdc6e(0x18f),'attributes':['id',_0x3fdc6e(0x1c8)]}]});if(_0x2947b8){if(_0x2947b8['id']!==_0x374f19['id'])return{'ticket':_0x2947b8,'oldStatus':_0x3a0c0a,'oldUserId':_0x7a4eae};}_0x2a9816=![];}const _0x444957=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x2268ab,'companyId':_0x16ae7c,'whatsappId':_0x374f19[_0x3fdc6e(0x1b4)]});if(_0x39c7f5!==undefined&&[_0x3fdc6e(0x1ad)][_0x3fdc6e(0x19d)](_0x39c7f5)>-0x1){const {complationMessage:_0x233911,ratingMessage:_0x2180c4}=await(0x0,ShowWhatsAppService_1[_0x3fdc6e(0x1cc)])(_0x374f19[_0x3fdc6e(0x1b4)],_0x16ae7c);if(_0x3fb84c?.[_0x3fdc6e(0x1c1)]==='enabled'&&(_0x302c5e||_0x302c5e===undefined)&&(!(0x0,lodash_1['isNil'])(_0x2180c4)&&_0x2180c4!=='')&&!_0x374f19['isGroup']){if(_0x444957['ratingAt']==null){const _0x5c7f60=_0x2180c4||'';let _0x3dcf01='‎'+_0x5c7f60+'\x0a';if(_0x374f19[_0x3fdc6e(0x18e)]===_0x3fdc6e(0x1a0)){const _0x1b1618=await(0x0,SendWhatsAppMessage_1[_0x3fdc6e(0x1cc)])({'body':_0x3dcf01,'ticket':_0x374f19});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x1b1618,_0x374f19,_0x374f19[_0x3fdc6e(0x187)]);}if([_0x3fdc6e(0x1bc),_0x3fdc6e(0x199)][_0x3fdc6e(0x18d)](_0x374f19[_0x3fdc6e(0x18e)])){console[_0x3fdc6e(0x197)]('Checking\x20if\x20'+_0x374f19[_0x3fdc6e(0x187)][_0x3fdc6e(0x19f)]+_0x3fdc6e(0x1c6)+_0x374f19['channel']+_0x3fdc6e(0x1c5));const _0x2ade21=await(0x0,sendFacebookMessage_1['default'])({'body':_0x3dcf01,'ticket':_0x374f19});await(0x0,wbotMessageListener_1[_0x3fdc6e(0x179)])(_0x2ade21,_0x374f19,_0x374f19['contact']);}return await _0x444957['update']({'userId':_0x374f19['userId'],'closedAt':(0x0,moment_1[_0x3fdc6e(0x1cc)])()[_0x3fdc6e(0x195)]()}),await _0x374f19[_0x3fdc6e(0x1a2)]({'status':_0x3fdc6e(0x1ab),'amountUseBotQueuesNPS':0x1}),_0x2cf4f9['to'](_0x3fdc6e(0x18c))['to'](_0x2268ab['toString']())[_0x3fdc6e(0x1b2)](_0x3fdc6e(0x1c9)+_0x374f19[_0x3fdc6e(0x190)]+_0x3fdc6e(0x1a1),{'action':_0x3fdc6e(0x1ba),'ticketId':_0x374f19['id']}),{'ticket':_0x374f19,'oldStatus':_0x3a0c0a,'oldUserId':_0x7a4eae};}}if(!(0x0,lodash_1[_0x3fdc6e(0x1b0)])(_0x233911)&&_0x233911!==''&&(_0x302c5e||_0x302c5e===undefined)){const _0x5aebe3=_0x374f19[_0x3fdc6e(0x1b3)]||_0x1166b8,_0x1c6685=await User_1['default'][_0x3fdc6e(0x1c3)](_0x5aebe3);let _0x471625;if(_0x374f19[_0x3fdc6e(0x19e)]!==_0x3fdc6e(0x1a3)||_0x374f19[_0x3fdc6e(0x19e)]===_0x3fdc6e(0x1a3)&&_0x36965c?.[_0x3fdc6e(0x1c1)]===_0x3fdc6e(0x1c0)){_0x1c6685[_0x3fdc6e(0x180)]?_0x471625='‎'+_0x1c6685[_0x3fdc6e(0x180)]:_0x471625='‎'+_0x233911;if(_0x374f19[_0x3fdc6e(0x18e)]==='whatsapp'&&!_0x374f19[_0x3fdc6e(0x1aa)]){const _0x40ac94=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x471625,'ticket':_0x374f19});await(0x0,wbotMessageListener_1[_0x3fdc6e(0x179)])(_0x40ac94,_0x374f19,_0x374f19[_0x3fdc6e(0x187)]);}[_0x3fdc6e(0x1bc),_0x3fdc6e(0x199)]['includes'](_0x374f19[_0x3fdc6e(0x18e)])&&!_0x374f19[_0x3fdc6e(0x1aa)]&&(console[_0x3fdc6e(0x197)]('Checking\x20if\x20'+_0x374f19[_0x3fdc6e(0x187)]['number']+'\x20is\x20a\x20valid\x20'+_0x374f19[_0x3fdc6e(0x18e)]+'\x20contact'),await(0x0,sendFacebookMessage_1[_0x3fdc6e(0x1cc)])({'body':_0x471625,'ticket':_0x374f19}));}}_0x444957[_0x3fdc6e(0x181)]=(0x0,moment_1[_0x3fdc6e(0x1cc)])()[_0x3fdc6e(0x195)](),_0x444957[_0x3fdc6e(0x1ae)]=(0x0,moment_1[_0x3fdc6e(0x1cc)])()[_0x3fdc6e(0x195)](),_0x444957[_0x3fdc6e(0x1b4)]=_0x374f19['whatsappId'],_0x444957[_0x3fdc6e(0x1b3)]=_0x374f19[_0x3fdc6e(0x1b3)];}!(0x0,lodash_1['isNil'])(_0x5a2d65)&&(_0x444957['queuedAt']=(0x0,moment_1[_0x3fdc6e(0x1cc)])()['toDate']());const _0x3ef879=await(0x0,ListSettingsServiceOne_1[_0x3fdc6e(0x1cc)])({'companyId':_0x16ae7c,'key':_0x3fdc6e(0x1a5)});if(_0x3ef879?.['value']===_0x3fdc6e(0x1c0)){if(_0x3b3ccb!==_0x5a2d65&&_0x7a4eae===_0x1166b8&&!(0x0,lodash_1['isNil'])(_0x3b3ccb)&&!(0x0,lodash_1[_0x3fdc6e(0x1b0)])(_0x5a2d65)){const _0xf904a4=await Queue_1['default'][_0x3fdc6e(0x1c3)](_0x5a2d65),_0x44e78c=await(0x0,GetTicketWbot_1['default'])(_0x374f19),_0x5ef8d3=_0x3fdc6e(0x1c2)+_0xf904a4?.[_0x3fdc6e(0x1c8)]+_0x3fdc6e(0x175),_0x2fbaec=await _0x44e78c[_0x3fdc6e(0x1b9)](_0x374f19['contact']['number']+'@'+(_0x374f19[_0x3fdc6e(0x1aa)]?_0x3fdc6e(0x178):_0x3fdc6e(0x19a)),{'text':_0x5ef8d3});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x2fbaec,_0x374f19,_0x374f19[_0x3fdc6e(0x187)],_0x444957);}else{if(_0x7a4eae!==_0x1166b8&&_0x3b3ccb===_0x5a2d65&&!(0x0,lodash_1['isNil'])(_0x7a4eae)&&!(0x0,lodash_1['isNil'])(_0x1166b8)&&!_0x374f19[_0x3fdc6e(0x1aa)]){const _0x216cbb=await(0x0,GetTicketWbot_1[_0x3fdc6e(0x1cc)])(_0x374f19),_0x1fdaa5=await(0x0,ShowUserService_1[_0x3fdc6e(0x1cc)])(_0x383c91['userId']),_0x33fdb7=_0x3fdc6e(0x188)+_0x1fdaa5[_0x3fdc6e(0x1c8)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x4bd53b=await _0x216cbb[_0x3fdc6e(0x1b9)](_0x374f19['contact']['number']+'@'+(_0x374f19['isGroup']?_0x3fdc6e(0x178):_0x3fdc6e(0x19a)),{'text':_0x33fdb7});await(0x0,wbotMessageListener_1[_0x3fdc6e(0x179)])(_0x4bd53b,_0x374f19,_0x374f19[_0x3fdc6e(0x187)],_0x444957);}else{if(_0x7a4eae!==_0x1166b8&&!(0x0,lodash_1[_0x3fdc6e(0x1b0)])(_0x7a4eae)&&!(0x0,lodash_1['isNil'])(_0x1166b8)&&_0x3b3ccb!==_0x5a2d65&&!(0x0,lodash_1[_0x3fdc6e(0x1b0)])(_0x3b3ccb)&&!(0x0,lodash_1['isNil'])(_0x5a2d65)){const _0x209479=await(0x0,GetTicketWbot_1[_0x3fdc6e(0x1cc)])(_0x374f19),_0x969a7b=await Queue_1[_0x3fdc6e(0x1cc)]['findByPk'](_0x5a2d65),_0x3eb195=await(0x0,ShowUserService_1[_0x3fdc6e(0x1cc)])(_0x383c91[_0x3fdc6e(0x1b3)]),_0x11bf49='*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x969a7b?.[_0x3fdc6e(0x1c8)]+_0x3fdc6e(0x191)+_0x3eb195[_0x3fdc6e(0x1c8)]+_0x3fdc6e(0x175),_0x2f65c3=await _0x209479['sendMessage'](_0x374f19[_0x3fdc6e(0x187)]['number']+'@'+(_0x374f19['isGroup']?'g.us':_0x3fdc6e(0x19a)),{'text':_0x11bf49});await(0x0,wbotMessageListener_1[_0x3fdc6e(0x179)])(_0x2f65c3,_0x374f19,_0x374f19[_0x3fdc6e(0x187)]);}else{if(_0x7a4eae!==undefined&&(0x0,lodash_1[_0x3fdc6e(0x1b0)])(_0x1166b8)&&_0x3b3ccb!==_0x5a2d65&&!(0x0,lodash_1[_0x3fdc6e(0x1b0)])(_0x5a2d65)){const _0x48149c=await Queue_1[_0x3fdc6e(0x1cc)][_0x3fdc6e(0x1c3)](_0x5a2d65),_0x2d6dfc=await(0x0,GetTicketWbot_1['default'])(_0x374f19),_0x41cb4c=_0x3fdc6e(0x1c2)+_0x48149c?.[_0x3fdc6e(0x1c8)]+_0x3fdc6e(0x175),_0x47f177=await _0x2d6dfc['sendMessage'](_0x374f19['contact'][_0x3fdc6e(0x19f)]+'@'+(_0x374f19['isGroup']?'g.us':_0x3fdc6e(0x19a)),{'text':_0x41cb4c});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x47f177,_0x374f19,_0x374f19['contact']);}}}}}return await _0x374f19['update']({'status':_0x39c7f5,'queueId':_0x5a2d65,'userId':_0x1166b8,'isBot':_0x2a9816,'queueOptionId':_0x4b128e,'amountUsedBotQueues':_0x39c7f5===_0x3fdc6e(0x1ad)?0x0:_0x4de99e?_0x4de99e:_0x374f19[_0x3fdc6e(0x1cb)]}),_0x444957[_0x3fdc6e(0x1bf)]=(0x0,moment_1[_0x3fdc6e(0x1cc)])()[_0x3fdc6e(0x195)](),_0x444957[_0x3fdc6e(0x1af)]=_0x5a2d65,await _0x374f19[_0x3fdc6e(0x19c)](),_0x39c7f5!==undefined&&[_0x3fdc6e(0x1a3)][_0x3fdc6e(0x19d)](_0x39c7f5)>-0x1&&_0x444957[_0x3fdc6e(0x1a2)]({'whatsappId':_0x374f19[_0x3fdc6e(0x1b4)],'startedAt':null,'userId':null}),_0x39c7f5!==undefined&&['open'][_0x3fdc6e(0x19d)](_0x39c7f5)>-0x1&&_0x444957[_0x3fdc6e(0x1a2)]({'startedAt':(0x0,moment_1[_0x3fdc6e(0x1cc)])()[_0x3fdc6e(0x195)](),'ratingAt':null,'rated':![],'whatsappId':_0x374f19['whatsappId'],'userId':_0x374f19[_0x3fdc6e(0x1b3)],'queueId':_0x374f19['queueId']}),(_0x374f19[_0x3fdc6e(0x19e)]!==_0x3a0c0a||_0x374f19[_0x3fdc6e(0x18f)]?.['id']!==_0x7a4eae)&&(_0x444957['update']({'userId':_0x374f19[_0x3fdc6e(0x1b3)]}),_0x2cf4f9['to'](_0x3a0c0a)[_0x3fdc6e(0x1b2)]('company-'+_0x16ae7c+'-ticket',{'action':_0x3fdc6e(0x1ba),'ticketId':_0x374f19['id']})),await _0x444957['save'](),_0x2cf4f9['to'](_0x374f19[_0x3fdc6e(0x19e)])['to']('notification')['to'](_0x2268ab[_0x3fdc6e(0x192)]())[_0x3fdc6e(0x1b2)](_0x3fdc6e(0x1c9)+_0x16ae7c+_0x3fdc6e(0x1a1),{'action':_0x3fdc6e(0x1a2),'ticket':_0x374f19,'ticketId':_0x2268ab}),{'ticket':_0x374f19,'oldStatus':_0x3a0c0a,'oldUserId':_0x7a4eae};}catch(_0x42ada7){Sentry[_0x3fdc6e(0x1b1)](_0x42ada7);}};function a490_0x4852(){const _0xac9c92=['closedAt','queueId','isNil','captureException','emit','userId','whatsappId','writable','3xXhGEj','../WbotServices/wbotMessageListener','5770dGAdRh','sendMessage','delete','14894262FHtvyB','facebook','create','36yGbTXc','queuedAt','enabled','value','*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','findByPk','../UserServices/ShowUserService','\x20contact','\x20is\x20a\x20valid\x20','927066fcfBKx','name','company-','moment','amountUsedBotQueues','default','../../helpers/SetTicketMessagesAsRead','group','../../libs/socket','63505ROXstn','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','color','contactId','g.us','verifyMessage','hasOwnProperty','__esModule','__createBinding','userRating','getOwnPropertyDescriptor','__importDefault','farewellMessage','finishedAt','prototype','../../helpers/GetTicketWbot','585348IkQQbx','../../models/Queue','1844929NeEktK','contact','*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','getIO','../SettingServices/ListSettingsServiceOne','findOne','open','includes','channel','user','companyId','*\x20e\x20será\x20atendido\x20por\x20*','toString','defineProperty','2ILURjy','toDate','45859oMruSK','log','call','instagram','s.whatsapp.net','__setModuleDefault','reload','indexOf','status','number','whatsapp','-ticket','update','pending','lodash','sendMsgTransfTicket','__importStar','../FacebookServices/sendFacebookMessage','13130448qKKkLO','@sentry/node','isGroup','nps','../../models/Setting','closed'];a490_0x4852=function(){return _0xac9c92;};return a490_0x4852();}exports[a490_0x601fb4(0x1cc)]=UpdateTicketService;