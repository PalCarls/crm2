'use strict';const a527_0x560111=a527_0x5dc9;(function(_0x49770a,_0x55ee19){const _0x1b5527=a527_0x5dc9,_0x4a23fe=_0x49770a();while(!![]){try{const _0x440cc7=parseInt(_0x1b5527(0xc7))/0x1*(-parseInt(_0x1b5527(0xc4))/0x2)+parseInt(_0x1b5527(0xd0))/0x3*(parseInt(_0x1b5527(0xa5))/0x4)+-parseInt(_0x1b5527(0xdc))/0x5+parseInt(_0x1b5527(0x9d))/0x6*(-parseInt(_0x1b5527(0xb2))/0x7)+-parseInt(_0x1b5527(0xa2))/0x8+-parseInt(_0x1b5527(0xd5))/0x9+parseInt(_0x1b5527(0xb9))/0xa*(parseInt(_0x1b5527(0xa6))/0xb);if(_0x440cc7===_0x55ee19)break;else _0x4a23fe['push'](_0x4a23fe['shift']());}catch(_0x51a3fd){_0x4a23fe['push'](_0x4a23fe['shift']());}}}(a527_0x4fd8,0xb460c));function a527_0x4fd8(){const _0x4c9cfd=['2URNIjA','../../helpers/SetTicketMessagesAsRead','findOne','102038VjWzpQ','create','__esModule','./FindOrCreateATicketTrakingService','getOwnPropertyDescriptor','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','../UserServices/ShowUserService','writable','queuedAt','2726991gctpCH','sequelize','prototype','isBot','queueId','11753820OSDRCN','sendMessage','instagram','reload','delete','queue','userRating','772485wQKcjc','__setModuleDefault','isGroup','Checking\x20if\x20','\x20contact','call','../WbotServices/SendWhatsAppMessage','../../helpers/GetTicketWbot','lastMessage','facebook','companyId','\x20is\x20a\x20valid\x20','contact','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','pending','g.us','emit','../../models/User','value','-ticket','number','open','findByPk','indexOf','queueOptionId','nps','includes','channel','32724UbHCLn','contactId','update','../FacebookServices/sendFacebookMessage','whatsappId','8562368eBHbfw','toDate','ratingAt','4KlGjfp','42987472Fyptvz','captureException','defineProperty','isNil','default','color','log','sendFarewellWaitingTicket','closed','sendMsgTransfTicket','toString','user','1855aqwICd','name','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','amountUsedBotQueues','notification','whatsapp','verifyMessage','10ebmriu','./ShowTicketService','enabled','status','../../models/Setting','company-','farewellMessage','group','../../libs/socket','userId','s.whatsapp.net'];a527_0x4fd8=function(){return _0x4c9cfd;};return a527_0x4fd8();}var __createBinding=this&&this['__createBinding']||(Object[a527_0x560111(0xc8)]?function(_0x853001,_0x4bdfeb,_0x5ace8a,_0x48dbef){const _0x3abb03=a527_0x560111;if(_0x48dbef===undefined)_0x48dbef=_0x5ace8a;var _0x6a2361=Object[_0x3abb03(0xcb)](_0x4bdfeb,_0x5ace8a);(!_0x6a2361||('get'in _0x6a2361?!_0x4bdfeb[_0x3abb03(0xc9)]:_0x6a2361[_0x3abb03(0xce)]||_0x6a2361['configurable']))&&(_0x6a2361={'enumerable':!![],'get':function(){return _0x4bdfeb[_0x5ace8a];}}),Object[_0x3abb03(0xa8)](_0x853001,_0x48dbef,_0x6a2361);}:function(_0x1b31cb,_0x9b1952,_0x48e38f,_0x4c3798){if(_0x4c3798===undefined)_0x4c3798=_0x48e38f;_0x1b31cb[_0x4c3798]=_0x9b1952[_0x48e38f];}),__setModuleDefault=this&&this[a527_0x560111(0xdd)]||(Object['create']?function(_0x4ed5ff,_0x271304){const _0x2810b9=a527_0x560111;Object[_0x2810b9(0xa8)](_0x4ed5ff,_0x2810b9(0xaa),{'enumerable':!![],'value':_0x271304});}:function(_0xe3049e,_0xe0e469){const _0x285d05=a527_0x560111;_0xe3049e[_0x285d05(0xaa)]=_0xe0e469;}),__importStar=this&&this['__importStar']||function(_0x5105a7){const _0x8fa57=a527_0x560111;if(_0x5105a7&&_0x5105a7['__esModule'])return _0x5105a7;var _0x1a3576={};if(_0x5105a7!=null){for(var _0x2e57bc in _0x5105a7)if(_0x2e57bc!==_0x8fa57(0xaa)&&Object[_0x8fa57(0xd2)]['hasOwnProperty'][_0x8fa57(0xe1)](_0x5105a7,_0x2e57bc))__createBinding(_0x1a3576,_0x5105a7,_0x2e57bc);}return __setModuleDefault(_0x1a3576,_0x5105a7),_0x1a3576;},__importDefault=this&&this['__importDefault']||function(_0x1b227c){const _0x54f991=a527_0x560111;return _0x1b227c&&_0x1b227c[_0x54f991(0xc9)]?_0x1b227c:{'default':_0x1b227c};};Object[a527_0x560111(0xa8)](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require('moment')),Sentry=__importStar(require('@sentry/node')),sequelize_1=require(a527_0x560111(0xd1)),SetTicketMessagesAsRead_1=__importDefault(require(a527_0x560111(0xc5))),socket_1=require(a527_0x560111(0xc1)),Ticket_1=__importDefault(require('../../models/Ticket')),Setting_1=__importDefault(require(a527_0x560111(0xbd))),Queue_1=__importDefault(require('../../models/Queue')),ShowTicketService_1=__importDefault(require(a527_0x560111(0xba))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require(a527_0x560111(0xe2))),FindOrCreateATicketTrakingService_1=__importDefault(require(a527_0x560111(0xca))),GetTicketWbot_1=__importDefault(require(a527_0x560111(0xe3))),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),lodash_1=require('lodash'),ListSettingsServiceOne_1=__importDefault(require('../SettingServices/ListSettingsServiceOne')),sendFacebookMessage_1=__importDefault(require(a527_0x560111(0xa0))),ShowUserService_1=__importDefault(require(a527_0x560111(0xcd))),User_1=__importDefault(require(a527_0x560111(0xed))),UpdateTicketService=async({ticketData:_0x585221,ticketId:_0x1ae7ef,companyId:_0x37d730})=>{const _0x36447f=a527_0x560111;try{const {status:_0x52fb0e}=_0x585221;let {queueId:_0xf4d36c,userId:_0x38c1bd,sendFarewellMessage:_0x240ac2,amountUsedBotQueues:_0x4ea097,lastMessage:_0x13e215}=_0x585221,_0x196cac=_0x585221[_0x36447f(0xd3)]||![],_0x1e4bdd=_0x585221[_0x36447f(0x99)]||null;const _0x387b3b=(0x0,socket_1['getIO'])(),_0x4a1219=await Setting_1['default']['findOne']({'where':{'companyId':_0x37d730,'key':_0x36447f(0xdb)}});let _0x22ebdf=await Setting_1[_0x36447f(0xaa)][_0x36447f(0xc6)]({'where':{'key':_0x36447f(0xad),'companyId':_0x37d730}});const _0x2a4f7e=await(0x0,ShowTicketService_1[_0x36447f(0xaa)])(_0x1ae7ef,_0x37d730);_0x2a4f7e[_0x36447f(0x9c)]===_0x36447f(0xb7)&&await(0x0,SetTicketMessagesAsRead_1[_0x36447f(0xaa)])(_0x2a4f7e);const _0x29cadd=_0x2a4f7e?.[_0x36447f(0xbc)],_0x14486d=_0x2a4f7e[_0x36447f(0xb1)]?.['id'],_0x27dee0=_0x2a4f7e?.['queueId'];if(_0x29cadd==='closed'){const _0x2f8c6a=await Ticket_1[_0x36447f(0xaa)][_0x36447f(0xc6)]({'where':{'contactId':_0x2a4f7e[_0x36447f(0x9e)],'status':{[sequelize_1['Op']['or']]:['open','pending',_0x36447f(0xc0)]},'whatsappId':_0x2a4f7e[_0x36447f(0xa1)]},'include':[{'model':Queue_1[_0x36447f(0xaa)],'as':_0x36447f(0xda),'attributes':['id',_0x36447f(0xb3),_0x36447f(0xab)]},{'model':User_1[_0x36447f(0xaa)],'as':_0x36447f(0xb1),'attributes':['id',_0x36447f(0xb3)]}]});if(_0x2f8c6a){if(_0x2f8c6a['id']!==_0x2a4f7e['id'])return{'ticket':_0x2f8c6a,'oldStatus':_0x29cadd,'oldUserId':_0x14486d};}_0x196cac=![];}const _0x1d5d6f=await(0x0,FindOrCreateATicketTrakingService_1[_0x36447f(0xaa)])({'ticketId':_0x1ae7ef,'companyId':_0x37d730,'whatsappId':_0x2a4f7e['whatsappId']});if(_0x52fb0e!==undefined&&[_0x36447f(0xae)][_0x36447f(0x98)](_0x52fb0e)>-0x1){const {complationMessage:_0x24078d,ratingMessage:_0x9d4119}=await(0x0,ShowWhatsAppService_1[_0x36447f(0xaa)])(_0x2a4f7e['whatsappId'],_0x37d730);if(_0x4a1219?.[_0x36447f(0xee)]===_0x36447f(0xbb)&&(_0x240ac2||_0x240ac2===undefined)&&(!(0x0,lodash_1[_0x36447f(0xa9)])(_0x9d4119)&&_0x9d4119!=='')&&!_0x2a4f7e[_0x36447f(0xde)]){if(_0x1d5d6f[_0x36447f(0xa4)]==null){const _0x47670f=_0x9d4119||'';let _0x348e0c='‎'+_0x47670f+'\x0a';if(_0x2a4f7e[_0x36447f(0x9c)]==='whatsapp'){const _0x5d652=await(0x0,SendWhatsAppMessage_1[_0x36447f(0xaa)])({'body':_0x348e0c,'ticket':_0x2a4f7e});await(0x0,wbotMessageListener_1[_0x36447f(0xb8)])(_0x5d652,_0x2a4f7e,_0x2a4f7e[_0x36447f(0xe8)]);}if([_0x36447f(0xe5),_0x36447f(0xd7)][_0x36447f(0x9b)](_0x2a4f7e[_0x36447f(0x9c)])){console[_0x36447f(0xac)](_0x36447f(0xdf)+_0x2a4f7e[_0x36447f(0xe8)][_0x36447f(0x95)]+_0x36447f(0xe7)+_0x2a4f7e[_0x36447f(0x9c)]+_0x36447f(0xe0));const _0x1b7db5=await(0x0,sendFacebookMessage_1[_0x36447f(0xaa)])({'body':_0x348e0c,'ticket':_0x2a4f7e});await(0x0,wbotMessageListener_1[_0x36447f(0xb8)])(_0x1b7db5,_0x2a4f7e,_0x2a4f7e[_0x36447f(0xe8)]);}return await _0x1d5d6f[_0x36447f(0x9f)]({'userId':_0x2a4f7e[_0x36447f(0xc2)],'closedAt':(0x0,moment_1[_0x36447f(0xaa)])()['toDate']()}),await _0x2a4f7e[_0x36447f(0x9f)]({'status':_0x36447f(0x9a),'amountUseBotQueuesNPS':0x1}),_0x387b3b['to']('open')['to'](_0x1ae7ef[_0x36447f(0xb0)]())['emit']('company-'+_0x2a4f7e[_0x36447f(0xe6)]+_0x36447f(0x94),{'action':'delete','ticketId':_0x2a4f7e['id']}),{'ticket':_0x2a4f7e,'oldStatus':_0x29cadd,'oldUserId':_0x14486d};}}if(!(0x0,lodash_1[_0x36447f(0xa9)])(_0x24078d)&&_0x24078d!==''&&(_0x240ac2||_0x240ac2===undefined)){const _0x4c83b6=_0x2a4f7e['userId']||_0x38c1bd,_0x40966a=await User_1[_0x36447f(0xaa)][_0x36447f(0x97)](_0x4c83b6);let _0x57e15d;if(_0x2a4f7e[_0x36447f(0xbc)]!==_0x36447f(0xea)||_0x2a4f7e['status']===_0x36447f(0xea)&&_0x22ebdf?.[_0x36447f(0xee)]===_0x36447f(0xbb)){_0x40966a[_0x36447f(0xbf)]?_0x57e15d='‎'+_0x40966a[_0x36447f(0xbf)]:_0x57e15d='‎'+_0x24078d;if(_0x2a4f7e['channel']===_0x36447f(0xb7)&&!_0x2a4f7e[_0x36447f(0xde)]){const _0x3d58be=await(0x0,SendWhatsAppMessage_1[_0x36447f(0xaa)])({'body':_0x57e15d,'ticket':_0x2a4f7e});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x3d58be,_0x2a4f7e,_0x2a4f7e[_0x36447f(0xe8)]);}[_0x36447f(0xe5),_0x36447f(0xd7)]['includes'](_0x2a4f7e[_0x36447f(0x9c)])&&!_0x2a4f7e[_0x36447f(0xde)]&&(console[_0x36447f(0xac)](_0x36447f(0xdf)+_0x2a4f7e['contact'][_0x36447f(0x95)]+_0x36447f(0xe7)+_0x2a4f7e[_0x36447f(0x9c)]+_0x36447f(0xe0)),await(0x0,sendFacebookMessage_1[_0x36447f(0xaa)])({'body':_0x57e15d,'ticket':_0x2a4f7e}));}}_0x1d5d6f['finishedAt']=(0x0,moment_1[_0x36447f(0xaa)])()[_0x36447f(0xa3)](),_0x1d5d6f['closedAt']=(0x0,moment_1[_0x36447f(0xaa)])()[_0x36447f(0xa3)](),_0x1d5d6f['whatsappId']=_0x2a4f7e[_0x36447f(0xa1)],_0x1d5d6f[_0x36447f(0xc2)]=_0x2a4f7e[_0x36447f(0xc2)];}!(0x0,lodash_1[_0x36447f(0xa9)])(_0xf4d36c)&&(_0x1d5d6f[_0x36447f(0xcf)]=(0x0,moment_1[_0x36447f(0xaa)])()['toDate']());const _0x385644=await(0x0,ListSettingsServiceOne_1['default'])({'companyId':_0x37d730,'key':_0x36447f(0xaf)});if(_0x385644?.['value']==='enabled'){if(_0x27dee0!==_0xf4d36c&&_0x14486d===_0x38c1bd&&!(0x0,lodash_1['isNil'])(_0x27dee0)&&!(0x0,lodash_1['isNil'])(_0xf4d36c)){const _0x4b0b20=await Queue_1['default'][_0x36447f(0x97)](_0xf4d36c),_0x40421c=await(0x0,GetTicketWbot_1[_0x36447f(0xaa)])(_0x2a4f7e),_0x7e0f59=_0x36447f(0xb4)+_0x4b0b20?.[_0x36447f(0xb3)]+_0x36447f(0xcc),_0xdf02ee=await _0x40421c[_0x36447f(0xd6)](_0x2a4f7e[_0x36447f(0xe8)][_0x36447f(0x95)]+'@'+(_0x2a4f7e['isGroup']?_0x36447f(0xeb):_0x36447f(0xc3)),{'text':_0x7e0f59});await(0x0,wbotMessageListener_1[_0x36447f(0xb8)])(_0xdf02ee,_0x2a4f7e,_0x2a4f7e[_0x36447f(0xe8)],_0x1d5d6f);}else{if(_0x14486d!==_0x38c1bd&&_0x27dee0===_0xf4d36c&&!(0x0,lodash_1['isNil'])(_0x14486d)&&!(0x0,lodash_1[_0x36447f(0xa9)])(_0x38c1bd)&&!_0x2a4f7e[_0x36447f(0xde)]){const _0xe8e732=await(0x0,GetTicketWbot_1[_0x36447f(0xaa)])(_0x2a4f7e),_0x9bea21=await(0x0,ShowUserService_1[_0x36447f(0xaa)])(_0x585221[_0x36447f(0xc2)]),_0x46c3ca='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*'+_0x9bea21[_0x36447f(0xb3)]+_0x36447f(0xe9),_0x2708e2=await _0xe8e732[_0x36447f(0xd6)](_0x2a4f7e[_0x36447f(0xe8)][_0x36447f(0x95)]+'@'+(_0x2a4f7e[_0x36447f(0xde)]?_0x36447f(0xeb):'s.whatsapp.net'),{'text':_0x46c3ca});await(0x0,wbotMessageListener_1[_0x36447f(0xb8)])(_0x2708e2,_0x2a4f7e,_0x2a4f7e[_0x36447f(0xe8)],_0x1d5d6f);}else{if(_0x14486d!==_0x38c1bd&&!(0x0,lodash_1[_0x36447f(0xa9)])(_0x14486d)&&!(0x0,lodash_1['isNil'])(_0x38c1bd)&&_0x27dee0!==_0xf4d36c&&!(0x0,lodash_1[_0x36447f(0xa9)])(_0x27dee0)&&!(0x0,lodash_1[_0x36447f(0xa9)])(_0xf4d36c)){const _0x593b22=await(0x0,GetTicketWbot_1[_0x36447f(0xaa)])(_0x2a4f7e),_0x338b41=await Queue_1[_0x36447f(0xaa)]['findByPk'](_0xf4d36c),_0x1b0d01=await(0x0,ShowUserService_1[_0x36447f(0xaa)])(_0x585221[_0x36447f(0xc2)]),_0x207a34='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x338b41?.[_0x36447f(0xb3)]+'*\x20e\x20será\x20atendido\x20por\x20*'+_0x1b0d01[_0x36447f(0xb3)]+_0x36447f(0xe9),_0x24bca2=await _0x593b22[_0x36447f(0xd6)](_0x2a4f7e['contact']['number']+'@'+(_0x2a4f7e[_0x36447f(0xde)]?_0x36447f(0xeb):_0x36447f(0xc3)),{'text':_0x207a34});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x24bca2,_0x2a4f7e,_0x2a4f7e['contact']);}else{if(_0x14486d!==undefined&&(0x0,lodash_1[_0x36447f(0xa9)])(_0x38c1bd)&&_0x27dee0!==_0xf4d36c&&!(0x0,lodash_1[_0x36447f(0xa9)])(_0xf4d36c)){const _0x405498=await Queue_1[_0x36447f(0xaa)][_0x36447f(0x97)](_0xf4d36c),_0x374326=await(0x0,GetTicketWbot_1['default'])(_0x2a4f7e),_0x56950c='*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x405498?.[_0x36447f(0xb3)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x5ce4f1=await _0x374326[_0x36447f(0xd6)](_0x2a4f7e[_0x36447f(0xe8)][_0x36447f(0x95)]+'@'+(_0x2a4f7e['isGroup']?'g.us':_0x36447f(0xc3)),{'text':_0x56950c});await(0x0,wbotMessageListener_1[_0x36447f(0xb8)])(_0x5ce4f1,_0x2a4f7e,_0x2a4f7e[_0x36447f(0xe8)]);}}}}}return await _0x2a4f7e[_0x36447f(0x9f)]({'status':_0x52fb0e,'queueId':_0xf4d36c,'userId':_0x38c1bd,'isBot':_0x196cac,'queueOptionId':_0x1e4bdd,'amountUsedBotQueues':_0x52fb0e===_0x36447f(0xae)?0x0:_0x4ea097?_0x4ea097:_0x2a4f7e[_0x36447f(0xb5)],'lastMessage':_0x13e215?_0x13e215:_0x2a4f7e[_0x36447f(0xe4)]}),_0x1d5d6f[_0x36447f(0xcf)]=(0x0,moment_1[_0x36447f(0xaa)])()[_0x36447f(0xa3)](),_0x1d5d6f[_0x36447f(0xd4)]=_0xf4d36c,await _0x2a4f7e[_0x36447f(0xd8)](),_0x52fb0e!==undefined&&[_0x36447f(0xea)][_0x36447f(0x98)](_0x52fb0e)>-0x1&&_0x1d5d6f[_0x36447f(0x9f)]({'whatsappId':_0x2a4f7e[_0x36447f(0xa1)],'startedAt':null,'userId':null}),_0x52fb0e!==undefined&&[_0x36447f(0x96)][_0x36447f(0x98)](_0x52fb0e)>-0x1&&_0x1d5d6f[_0x36447f(0x9f)]({'startedAt':(0x0,moment_1[_0x36447f(0xaa)])()[_0x36447f(0xa3)](),'ratingAt':null,'rated':![],'whatsappId':_0x2a4f7e[_0x36447f(0xa1)],'userId':_0x2a4f7e['userId'],'queueId':_0x2a4f7e[_0x36447f(0xd4)]}),(_0x2a4f7e['status']!==_0x29cadd||_0x2a4f7e['user']?.['id']!==_0x14486d)&&(_0x1d5d6f[_0x36447f(0x9f)]({'userId':_0x2a4f7e[_0x36447f(0xc2)]}),_0x387b3b['to'](_0x29cadd)[_0x36447f(0xec)](_0x36447f(0xbe)+_0x37d730+'-ticket',{'action':_0x36447f(0xd9),'ticketId':_0x2a4f7e['id']})),await _0x1d5d6f['save'](),_0x387b3b['to'](_0x2a4f7e[_0x36447f(0xbc)])['to'](_0x36447f(0xb6))['to'](_0x1ae7ef[_0x36447f(0xb0)]())['emit'](_0x36447f(0xbe)+_0x37d730+_0x36447f(0x94),{'action':_0x36447f(0x9f),'ticket':_0x2a4f7e,'ticketId':_0x1ae7ef}),{'ticket':_0x2a4f7e,'oldStatus':_0x29cadd,'oldUserId':_0x14486d};}catch(_0x4fa6ce){Sentry[_0x36447f(0xa7)](_0x4fa6ce);}};function a527_0x5dc9(_0x384c99,_0x5f48e3){const _0x4fd89f=a527_0x4fd8();return a527_0x5dc9=function(_0x5dc920,_0x32cf37){_0x5dc920=_0x5dc920-0x94;let _0x3ac83f=_0x4fd89f[_0x5dc920];return _0x3ac83f;},a527_0x5dc9(_0x384c99,_0x5f48e3);}exports[a527_0x560111(0xaa)]=UpdateTicketService;