'use strict';function a600_0x5f39(_0x44d575,_0x309370){const _0x1c2486=a600_0x1c24();return a600_0x5f39=function(_0x5f39c4,_0xe5bd42){_0x5f39c4=_0x5f39c4-0x162;let _0xce6630=_0x1c2486[_0x5f39c4];return _0xce6630;},a600_0x5f39(_0x44d575,_0x309370);}const a600_0x5f1133=a600_0x5f39;(function(_0x1e3602,_0x3af4e6){const _0x3a3c77=a600_0x5f39,_0x41ba51=_0x1e3602();while(!![]){try{const _0x2f3736=parseInt(_0x3a3c77(0x1cc))/0x1*(-parseInt(_0x3a3c77(0x18c))/0x2)+parseInt(_0x3a3c77(0x1b6))/0x3*(-parseInt(_0x3a3c77(0x18f))/0x4)+-parseInt(_0x3a3c77(0x195))/0x5+parseInt(_0x3a3c77(0x17a))/0x6+parseInt(_0x3a3c77(0x1b0))/0x7*(parseInt(_0x3a3c77(0x1a8))/0x8)+-parseInt(_0x3a3c77(0x192))/0x9+parseInt(_0x3a3c77(0x19a))/0xa*(parseInt(_0x3a3c77(0x1cd))/0xb);if(_0x2f3736===_0x3af4e6)break;else _0x41ba51['push'](_0x41ba51['shift']());}catch(_0x4a92dc){_0x41ba51['push'](_0x41ba51['shift']());}}}(a600_0x1c24,0xa96f8));var __createBinding=this&&this[a600_0x5f1133(0x1d2)]||(Object['create']?function(_0x54e78e,_0x333a4d,_0x23b333,_0xd268b8){const _0x5a6296=a600_0x5f1133;if(_0xd268b8===undefined)_0xd268b8=_0x23b333;var _0x45a75e=Object[_0x5a6296(0x1b7)](_0x333a4d,_0x23b333);(!_0x45a75e||('get'in _0x45a75e?!_0x333a4d[_0x5a6296(0x1c0)]:_0x45a75e[_0x5a6296(0x1b1)]||_0x45a75e[_0x5a6296(0x16a)]))&&(_0x45a75e={'enumerable':!![],'get':function(){return _0x333a4d[_0x23b333];}}),Object[_0x5a6296(0x199)](_0x54e78e,_0xd268b8,_0x45a75e);}:function(_0xc93587,_0xd3a53f,_0x243e17,_0x3e16db){if(_0x3e16db===undefined)_0x3e16db=_0x243e17;_0xc93587[_0x3e16db]=_0xd3a53f[_0x243e17];}),__setModuleDefault=this&&this[a600_0x5f1133(0x174)]||(Object[a600_0x5f1133(0x16c)]?function(_0x25711e,_0x106146){const _0x3c13c1=a600_0x5f1133;Object[_0x3c13c1(0x199)](_0x25711e,_0x3c13c1(0x169),{'enumerable':!![],'value':_0x106146});}:function(_0x379192,_0x32db72){const _0x52dc73=a600_0x5f1133;_0x379192[_0x52dc73(0x169)]=_0x32db72;}),__importStar=this&&this[a600_0x5f1133(0x17e)]||function(_0x45f891){const _0x223fc0=a600_0x5f1133;if(_0x45f891&&_0x45f891[_0x223fc0(0x1c0)])return _0x45f891;var _0x41e87f={};if(_0x45f891!=null){for(var _0x1fb770 in _0x45f891)if(_0x1fb770!==_0x223fc0(0x169)&&Object[_0x223fc0(0x1a2)]['hasOwnProperty'][_0x223fc0(0x163)](_0x45f891,_0x1fb770))__createBinding(_0x41e87f,_0x45f891,_0x1fb770);}return __setModuleDefault(_0x41e87f,_0x45f891),_0x41e87f;},__importDefault=this&&this[a600_0x5f1133(0x1af)]||function(_0x210e7f){return _0x210e7f&&_0x210e7f['__esModule']?_0x210e7f:{'default':_0x210e7f};};function a600_0x1c24(){const _0x1637a1=['indexOf','lastMessage','pending','../MessageServices/CreateMessageService','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','isNil','sendMessage','finishedAt','queueId','userRating','facebook','87049nGHDPF','715xBIPZH','delete','closeTicket','../UserServices/ShowUserService','PVT','__createBinding','./FindOrCreateATicketTrakingService','call','contact','farewellMessage','verifyMessage','../../models/Queue','sendMsgTransfTicket','default','configurable','log','create','replace','map','moment','../../models/CompaniesSettings','reopen','extendedTextMessage','../WbotServices/SendWhatsAppMessage','__setModuleDefault','../FacebookServices/facebookMessageListener','../../helpers/SetTicketMessagesAsRead','updatedAt','update','../../models/Tag','5092476uPertK','companyId','../../libs/socket','-ticket','__importStar','*\x20e\x20será\x20atendido\x20por\x20*','number','sequelize','toDate','transfered','open','./ShowTicketService','whatsappId','findByPk','status','\x20contact','emit','isGroup','2FVCWLa','reload','toString','344068qtnahx','findAll','getIO','11540331cstNjM','Checking\x20if\x20','destroy','4767085wOnXJj','./CreateLogTicketService','instagram','g.us','defineProperty','382550rXnbVs','userId','name','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','captureException','../../models/TicketTag','whatsapp','closed','prototype','enabled','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','includes','save','remoteJid','8ncWajp','receivedTransfer','../../models/User','tagId','notification','sendFarewellWaitingTicket','company-','__importDefault','5597431dTOHDg','writable','s.whatsapp.net','channel','lodash','closedAt','39bpUlVh','getOwnPropertyDescriptor','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','nps','\x20is\x20a\x20valid\x20','queuedAt','contactId','closeTicketOnTransfer','../WhatsappService/ShowWhatsAppService','user','__esModule'];a600_0x1c24=function(){return _0x1637a1;};return a600_0x1c24();}Object[a600_0x5f1133(0x199)](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require(a600_0x5f1133(0x16f))),Sentry=__importStar(require('@sentry/node')),sequelize_1=require(a600_0x5f1133(0x181)),SetTicketMessagesAsRead_1=__importDefault(require(a600_0x5f1133(0x176))),socket_1=require(a600_0x5f1133(0x17c)),Ticket_1=__importDefault(require('../../models/Ticket')),Queue_1=__importDefault(require(a600_0x5f1133(0x167))),ShowTicketService_1=__importDefault(require(a600_0x5f1133(0x185))),ShowWhatsAppService_1=__importDefault(require(a600_0x5f1133(0x1be))),SendWhatsAppMessage_1=__importDefault(require(a600_0x5f1133(0x173))),FindOrCreateATicketTrakingService_1=__importDefault(require(a600_0x5f1133(0x162))),GetTicketWbot_1=__importDefault(require('../../helpers/GetTicketWbot')),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),lodash_1=require(a600_0x5f1133(0x1b4)),sendFacebookMessage_1=__importDefault(require('../FacebookServices/sendFacebookMessage')),facebookMessageListener_1=require(a600_0x5f1133(0x175)),ShowUserService_1=__importDefault(require(a600_0x5f1133(0x1d0))),User_1=__importDefault(require(a600_0x5f1133(0x1aa))),CompaniesSettings_1=__importDefault(require(a600_0x5f1133(0x170))),CreateLogTicketService_1=__importDefault(require(a600_0x5f1133(0x196))),TicketTag_1=__importDefault(require(a600_0x5f1133(0x19f))),Tag_1=__importDefault(require(a600_0x5f1133(0x179))),CreateMessageService_1=__importDefault(require(a600_0x5f1133(0x1c4))),FindOrCreateTicketService_1=__importDefault(require('./FindOrCreateTicketService')),UpdateTicketService=async({ticketData:_0x19fa8a,ticketId:_0x289366,companyId:_0x1f3e00})=>{const _0xb9acbc=a600_0x5f1133;try{let {status:_0x3377bc}=_0x19fa8a,{queueId:_0x335997,userId:_0x457cf4,sendFarewellMessage:_0x3090ac,amountUsedBotQueues:_0x5d229f,lastMessage:_0x235650,integrationId:_0x408153,useIntegration:_0x3281ab,unreadMessages:_0x3db9d5,msgTransfer:_0x37cd0d,isTransfered:isTransfered=![]}=_0x19fa8a,_0x325efa=_0x19fa8a['isBot']||![],_0x546ae7=_0x19fa8a['queueOptionId']||null;const _0x1d4b33=(0x0,socket_1[_0xb9acbc(0x191)])(),_0x40b242=await CompaniesSettings_1[_0xb9acbc(0x169)]['findOne']({'where':{'companyId':_0x1f3e00}});let _0xf56fe2=await(0x0,ShowTicketService_1[_0xb9acbc(0x169)])(_0x289366,_0x1f3e00);_0xf56fe2[_0xb9acbc(0x1b3)]===_0xb9acbc(0x1a0)&&await(0x0,SetTicketMessagesAsRead_1[_0xb9acbc(0x169)])(_0xf56fe2);const _0x2e891c=_0xf56fe2?.[_0xb9acbc(0x188)],_0x48ac3b=_0xf56fe2[_0xb9acbc(0x1bf)]?.['id'],_0x1f8901=_0xf56fe2?.[_0xb9acbc(0x1c9)];if(_0x2e891c===_0xb9acbc(0x1a1)){let _0x529185=await Ticket_1[_0xb9acbc(0x169)]['findOne']({'where':{'contactId':_0xf56fe2[_0xb9acbc(0x1bc)],'status':{[sequelize_1['Op']['or']]:['open',_0xb9acbc(0x1c3),'group']},'whatsappId':_0xf56fe2[_0xb9acbc(0x186)]}});if(_0x529185){if(_0x529185['id']!==_0xf56fe2['id'])return _0x529185=await(0x0,ShowTicketService_1['default'])(_0x529185['id'],_0x1f3e00),{'ticket':_0x529185,'oldStatus':_0x2e891c,'oldUserId':_0x48ac3b};}_0x325efa=![];}const _0x2979d8=await(0x0,FindOrCreateATicketTrakingService_1[_0xb9acbc(0x169)])({'ticketId':_0x289366,'companyId':_0x1f3e00,'whatsappId':_0xf56fe2[_0xb9acbc(0x186)]}),{complationMessage:_0x4b4319,ratingMessage:_0x1406d3,groupAsTicket:_0x12c0d4}=await(0x0,ShowWhatsAppService_1[_0xb9acbc(0x169)])(_0xf56fe2[_0xb9acbc(0x186)],_0x1f3e00);if(_0x3377bc!==undefined&&[_0xb9acbc(0x1a1)][_0xb9acbc(0x1c1)](_0x3377bc)>-0x1){const _0x199ca3=_0xf56fe2['userId']||_0x457cf4,_0x31d3ec=await User_1[_0xb9acbc(0x169)][_0xb9acbc(0x187)](_0x199ca3);if(_0x40b242[_0xb9acbc(0x1ca)]===_0xb9acbc(0x1a3)&&(_0x3090ac||_0x3090ac===undefined)&&(!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x1406d3)&&_0x1406d3!=='')&&!_0xf56fe2[_0xb9acbc(0x18b)]){if(_0x2979d8['ratingAt']==null){const _0x215f9a=_0x1406d3||'';let _0x4f91f1='‎'+_0x215f9a+'\x0a';if(_0xf56fe2[_0xb9acbc(0x1b3)]===_0xb9acbc(0x1a0)){const _0x3d0a94=await(0x0,SendWhatsAppMessage_1[_0xb9acbc(0x169)])({'body':_0x4f91f1,'ticket':_0xf56fe2,'isForwarded':![]});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x3d0a94,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)]);}if([_0xb9acbc(0x1cb),_0xb9acbc(0x197)][_0xb9acbc(0x1a5)](_0xf56fe2[_0xb9acbc(0x1b3)])){console[_0xb9acbc(0x16b)]('Checking\x20if\x20'+_0xf56fe2[_0xb9acbc(0x164)][_0xb9acbc(0x180)]+_0xb9acbc(0x1ba)+_0xf56fe2[_0xb9acbc(0x1b3)]+_0xb9acbc(0x189));const _0x2a485e=await(0x0,sendFacebookMessage_1['default'])({'body':_0x4f91f1,'ticket':_0xf56fe2});await(0x0,facebookMessageListener_1['verifyMessageFace'])(_0x2a485e,_0x4f91f1,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)]);}await _0x2979d8[_0xb9acbc(0x178)]({'userId':_0xf56fe2[_0xb9acbc(0x19b)],'closedAt':(0x0,moment_1[_0xb9acbc(0x169)])()[_0xb9acbc(0x182)]()}),await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0xf56fe2[_0xb9acbc(0x19b)],'queueId':_0xf56fe2[_0xb9acbc(0x1c9)],'ticketId':_0x289366,'type':_0xb9acbc(0x1b9)});try{const _0x3d423b=await TicketTag_1[_0xb9acbc(0x169)]['findAll']({'where':{'ticketId':_0x289366}}),_0x402926=_0x3d423b[_0xb9acbc(0x16e)](_0x49276d=>_0x49276d[_0xb9acbc(0x1ab)]),_0x326aa6=await Tag_1['default'][_0xb9acbc(0x190)]({'where':{'id':_0x402926,'kanban':0x1}}),_0x24dbe3=_0x326aa6[_0xb9acbc(0x16e)](_0x8b8491=>_0x8b8491['id']);if(_0x24dbe3)await TicketTag_1[_0xb9acbc(0x169)][_0xb9acbc(0x194)]({'where':{'ticketId':_0x289366,'tagId':_0x24dbe3}});}catch(_0x29f260){Sentry[_0xb9acbc(0x19e)](_0x29f260);}return await _0xf56fe2[_0xb9acbc(0x178)]({'status':_0xb9acbc(0x1b9),'amountUseBotQueuesNPS':0x1}),_0x1d4b33['to']('open')['to'](_0x289366[_0xb9acbc(0x18e)]())[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0xf56fe2[_0xb9acbc(0x17b)]+'-ticket',{'action':_0xb9acbc(0x1ce),'ticketId':_0xf56fe2['id']}),{'ticket':_0xf56fe2,'oldStatus':_0x2e891c,'oldUserId':_0x48ac3b};}}if((!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x31d3ec?.[_0xb9acbc(0x165)])&&_0x31d3ec?.['farewellMessage']!==''||!(0x0,lodash_1['isNil'])(_0x4b4319)&&_0x4b4319!=='')&&(_0x3090ac||_0x3090ac===undefined)){let _0x2dadd1;if(_0xf56fe2[_0xb9acbc(0x188)]!=='pending'||_0xf56fe2['status']==='pending'&&_0x40b242[_0xb9acbc(0x1ad)]===_0xb9acbc(0x1a3)){!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x31d3ec)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x31d3ec?.[_0xb9acbc(0x165)])&&_0x31d3ec?.[_0xb9acbc(0x165)]!==''?_0x2dadd1='‎\x20'+_0x31d3ec[_0xb9acbc(0x165)]:_0x2dadd1='‎\x20'+_0x4b4319;if(_0xf56fe2['channel']===_0xb9acbc(0x1a0)&&(!_0xf56fe2[_0xb9acbc(0x18b)]||_0x12c0d4===_0xb9acbc(0x1a3))){const _0x57e50e=await(0x0,SendWhatsAppMessage_1[_0xb9acbc(0x169)])({'body':_0x2dadd1,'ticket':_0xf56fe2,'isForwarded':![]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x57e50e,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)]);}if(['facebook',_0xb9acbc(0x197)][_0xb9acbc(0x1a5)](_0xf56fe2[_0xb9acbc(0x1b3)])&&(!_0xf56fe2[_0xb9acbc(0x18b)]||_0x12c0d4==='enabled')){console[_0xb9acbc(0x16b)](_0xb9acbc(0x193)+_0xf56fe2['contact'][_0xb9acbc(0x180)]+_0xb9acbc(0x1ba)+_0xf56fe2[_0xb9acbc(0x1b3)]+'\x20contact');const _0x119f25=await(0x0,sendFacebookMessage_1[_0xb9acbc(0x169)])({'body':_0x2dadd1,'ticket':_0xf56fe2});}}}return _0x2979d8[_0xb9acbc(0x1c8)]=(0x0,moment_1[_0xb9acbc(0x169)])()[_0xb9acbc(0x182)](),_0x2979d8[_0xb9acbc(0x1b5)]=(0x0,moment_1[_0xb9acbc(0x169)])()[_0xb9acbc(0x182)](),_0x2979d8['whatsappId']=_0xf56fe2[_0xb9acbc(0x186)],_0x2979d8['userId']=_0xf56fe2[_0xb9acbc(0x19b)],await(0x0,CreateLogTicketService_1['default'])({'userId':_0x457cf4,'queueId':_0xf56fe2['queueId'],'ticketId':_0x289366,'type':_0xb9acbc(0x1a1)}),await _0x2979d8[_0xb9acbc(0x1a6)](),await _0xf56fe2[_0xb9acbc(0x178)]({'status':_0xb9acbc(0x1a1)}),_0x1d4b33['to'](_0x2e891c)['to'](_0x289366['toString']())[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0xf56fe2[_0xb9acbc(0x17b)]+_0xb9acbc(0x17d),{'action':_0xb9acbc(0x1ce),'ticketId':_0xf56fe2['id']}),{'ticket':_0xf56fe2,'oldStatus':_0x2e891c,'oldUserId':_0x48ac3b};}let _0x32f803;!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x335997)&&(_0x32f803=await Queue_1[_0xb9acbc(0x169)][_0xb9acbc(0x187)](_0x335997),_0x2979d8[_0xb9acbc(0x1bb)]=(0x0,moment_1[_0xb9acbc(0x169)])()[_0xb9acbc(0x182)]());if(isTransfered){if(_0x40b242[_0xb9acbc(0x1bd)]){let _0x5e0f36=_0xf56fe2;if(_0x1f8901!==_0x335997){await _0xf56fe2[_0xb9acbc(0x178)]({'status':_0xb9acbc(0x1a1)}),await _0xf56fe2['reload'](),_0x1d4b33['to'](_0x2e891c)['to'](_0x289366[_0xb9acbc(0x18e)]())[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0xf56fe2[_0xb9acbc(0x17b)]+_0xb9acbc(0x17d),{'action':_0xb9acbc(0x1ce),'ticketId':_0xf56fe2['id']});const {ticket:_0x4734ae}=await(0x0,FindOrCreateTicketService_1['default'])(_0xf56fe2[_0xb9acbc(0x164)],_0xf56fe2['whatsapp'],0x1,_0xf56fe2[_0xb9acbc(0x17b)],_0x335997,_0x457cf4,null,_0xb9acbc(0x1a0),![],![],_0x40b242,isTransfered);_0x5e0f36=_0x4734ae;}if(!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x37cd0d)){const _0x6bb5d8={'wid':_0xb9acbc(0x1d1)+_0x5e0f36[_0xb9acbc(0x177)][_0xb9acbc(0x18e)]()[_0xb9acbc(0x16d)]('\x20',''),'ticketId':_0x5e0f36['id'],'contactId':undefined,'body':_0x37cd0d,'fromMe':!![],'mediaType':_0xb9acbc(0x172),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x5e0f36[_0xb9acbc(0x164)]?.[_0xb9acbc(0x1a7)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1[_0xb9acbc(0x169)])({'messageData':_0x6bb5d8,'companyId':_0xf56fe2[_0xb9acbc(0x17b)]});}await _0x5e0f36[_0xb9acbc(0x178)]({'queueId':_0x335997,'userId':_0x457cf4,'status':_0x3377bc}),await _0x5e0f36[_0xb9acbc(0x18d)]();if(_0x40b242[_0xb9acbc(0x168)]===_0xb9acbc(0x1a3)){if(_0x1f8901!==_0x335997&&_0x48ac3b===_0x457cf4&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x1f8901)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x335997)){const _0x15990d=await(0x0,GetTicketWbot_1['default'])(_0xf56fe2),_0x1d9d77=_0xb9acbc(0x1a4)+_0x32f803?.[_0xb9acbc(0x19c)]+'\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x420ffc=await _0x15990d[_0xb9acbc(0x1c7)](_0xf56fe2[_0xb9acbc(0x164)]['number']+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?_0xb9acbc(0x198):'s.whatsapp.net'),{'text':_0x1d9d77});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x420ffc,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)],_0x2979d8);}else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901===_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&(!_0xf56fe2['isGroup']||_0x12c0d4===_0xb9acbc(0x1a3))){const _0x596cd1=await(0x0,GetTicketWbot_1['default'])(_0xf56fe2),_0x1dc634=await(0x0,ShowUserService_1[_0xb9acbc(0x169)])(_0x19fa8a[_0xb9acbc(0x19b)],_0x1f3e00),_0x5efe6b=_0xb9acbc(0x1b8)+_0x1dc634[_0xb9acbc(0x19c)]+_0xb9acbc(0x1c5),_0x1f27be=await _0x596cd1[_0xb9acbc(0x1c7)](_0xf56fe2['contact'][_0xb9acbc(0x180)]+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?_0xb9acbc(0x198):_0xb9acbc(0x1b2)),{'text':_0x5efe6b});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x1f27be,_0xf56fe2,_0xf56fe2['contact'],_0x2979d8);}else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901!==_0x335997&&!(0x0,lodash_1['isNil'])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&(!_0xf56fe2[_0xb9acbc(0x18b)]||_0x12c0d4===_0xb9acbc(0x1a3))){const _0x55f32c=await(0x0,GetTicketWbot_1[_0xb9acbc(0x169)])(_0xf56fe2),_0xa8c2bc=await(0x0,ShowUserService_1[_0xb9acbc(0x169)])(_0x19fa8a[_0xb9acbc(0x19b)],_0x1f3e00),_0x1d1bce='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*'+_0x32f803?.[_0xb9acbc(0x19c)]+_0xb9acbc(0x17f)+_0xa8c2bc[_0xb9acbc(0x19c)]+_0xb9acbc(0x1c5),_0x3ee9e4=await _0x55f32c[_0xb9acbc(0x1c7)](_0xf56fe2['contact'][_0xb9acbc(0x180)]+'@'+(_0xf56fe2['isGroup']?'g.us':'s.whatsapp.net'),{'text':_0x1d1bce});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x3ee9e4,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)]);}else{if(_0x48ac3b!==undefined&&(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&_0x1f8901!==_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x335997)){const _0x1a9598=await(0x0,GetTicketWbot_1[_0xb9acbc(0x169)])(_0xf56fe2),_0x57fc7b=_0xb9acbc(0x1a4)+_0x32f803?.[_0xb9acbc(0x19c)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0x33c0b9=await _0x1a9598[_0xb9acbc(0x1c7)](_0xf56fe2['contact'][_0xb9acbc(0x180)]+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?_0xb9acbc(0x198):'s.whatsapp.net'),{'text':_0x57fc7b});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x33c0b9,_0xf56fe2,_0xf56fe2['contact']);}}}}}if(_0x48ac3b!==_0x457cf4&&_0x1f8901===_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4))await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)});else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901===_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4))await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)}),await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x457cf4,'queueId':_0x1f8901,'ticketId':_0x5e0f36['id'],'type':'receivedTransfer'});else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901!==_0x335997&&!(0x0,lodash_1['isNil'])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4))await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)}),await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x457cf4,'queueId':_0x335997,'ticketId':_0x5e0f36['id'],'type':'receivedTransfer'});else _0x48ac3b!==undefined&&(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&_0x1f8901!==_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x335997)&&await(0x0,CreateLogTicketService_1['default'])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)});}}return(_0x5e0f36[_0xb9acbc(0x188)]!==_0x2e891c||_0x5e0f36[_0xb9acbc(0x1bf)]?.['id']!==_0x48ac3b)&&(await _0x2979d8[_0xb9acbc(0x178)]({'userId':_0x5e0f36[_0xb9acbc(0x19b)]}),_0x1d4b33['to'](_0x2e891c)[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0x1f3e00+_0xb9acbc(0x17d),{'action':'delete','ticketId':_0x5e0f36['id']})),_0x1d4b33['to'](_0x5e0f36['status'])['to']('notification')['to'](_0x5e0f36['id'][_0xb9acbc(0x18e)]())[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0x1f3e00+_0xb9acbc(0x17d),{'action':_0xb9acbc(0x178),'ticket':_0x5e0f36}),{'ticket':_0x5e0f36,'oldStatus':_0x2e891c,'oldUserId':_0x48ac3b};}else{if(_0x40b242[_0xb9acbc(0x168)]==='enabled'){if(_0x1f8901!==_0x335997&&_0x48ac3b===_0x457cf4&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x1f8901)&&!(0x0,lodash_1['isNil'])(_0x335997)){const _0x3b51a4=await(0x0,GetTicketWbot_1[_0xb9acbc(0x169)])(_0xf56fe2),_0x1b042e=_0xb9acbc(0x1a4)+_0x32f803?.[_0xb9acbc(0x19c)]+_0xb9acbc(0x19d),_0x5d5eeb=await _0x3b51a4[_0xb9acbc(0x1c7)](_0xf56fe2[_0xb9acbc(0x164)]['number']+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?_0xb9acbc(0x198):'s.whatsapp.net'),{'text':_0x1b042e});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x5d5eeb,_0xf56fe2,_0xf56fe2['contact'],_0x2979d8);}else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901===_0x335997&&!(0x0,lodash_1['isNil'])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&(!_0xf56fe2[_0xb9acbc(0x18b)]||_0x12c0d4===_0xb9acbc(0x1a3))){const _0x399446=await(0x0,GetTicketWbot_1['default'])(_0xf56fe2),_0x12dd33=await(0x0,ShowUserService_1[_0xb9acbc(0x169)])(_0x19fa8a['userId'],_0x1f3e00),_0x5c3f8f=_0xb9acbc(0x1b8)+_0x12dd33[_0xb9acbc(0x19c)]+_0xb9acbc(0x1c5),_0x325d7f=await _0x399446[_0xb9acbc(0x1c7)](_0xf56fe2[_0xb9acbc(0x164)][_0xb9acbc(0x180)]+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?_0xb9acbc(0x198):'s.whatsapp.net'),{'text':_0x5c3f8f});await(0x0,wbotMessageListener_1[_0xb9acbc(0x166)])(_0x325d7f,_0xf56fe2,_0xf56fe2['contact'],_0x2979d8);}else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901!==_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&(!_0xf56fe2[_0xb9acbc(0x18b)]||_0x12c0d4===_0xb9acbc(0x1a3))){const _0x4e6e44=await(0x0,GetTicketWbot_1[_0xb9acbc(0x169)])(_0xf56fe2),_0x2a089f=await(0x0,ShowUserService_1[_0xb9acbc(0x169)])(_0x19fa8a[_0xb9acbc(0x19b)],_0x1f3e00),_0x1cea01=_0xb9acbc(0x1a4)+_0x32f803?.['name']+_0xb9acbc(0x17f)+_0x2a089f['name']+_0xb9acbc(0x1c5),_0x3259aa=await _0x4e6e44[_0xb9acbc(0x1c7)](_0xf56fe2[_0xb9acbc(0x164)]['number']+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?'g.us':_0xb9acbc(0x1b2)),{'text':_0x1cea01});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x3259aa,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)]);}else{if(_0x48ac3b!==undefined&&(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4)&&_0x1f8901!==_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x335997)){const _0x79f1fb=await(0x0,GetTicketWbot_1['default'])(_0xf56fe2),_0x5eb03c=_0xb9acbc(0x1a4)+_0x32f803?.['name']+_0xb9acbc(0x1c5),_0xc26358=await _0x79f1fb['sendMessage'](_0xf56fe2[_0xb9acbc(0x164)][_0xb9acbc(0x180)]+'@'+(_0xf56fe2[_0xb9acbc(0x18b)]?_0xb9acbc(0x198):'s.whatsapp.net'),{'text':_0x5eb03c});await(0x0,wbotMessageListener_1['verifyMessage'])(_0xc26358,_0xf56fe2,_0xf56fe2[_0xb9acbc(0x164)]);}}}}}if(!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x37cd0d)){const _0x489b27={'wid':_0xb9acbc(0x1d1)+_0xf56fe2['updatedAt'][_0xb9acbc(0x18e)]()[_0xb9acbc(0x16d)]('\x20',''),'ticketId':_0xf56fe2['id'],'contactId':undefined,'body':_0x37cd0d,'fromMe':!![],'mediaType':'extendedTextMessage','read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0xf56fe2[_0xb9acbc(0x164)]?.['remoteJid'],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1['default'])({'messageData':_0x489b27,'companyId':_0xf56fe2['companyId']});}if(_0x48ac3b!==_0x457cf4&&_0x1f8901===_0x335997&&!(0x0,lodash_1['isNil'])(_0x48ac3b)&&!(0x0,lodash_1['isNil'])(_0x457cf4))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)});else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901===_0x335997&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4))await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)}),await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x457cf4,'queueId':_0x1f8901,'ticketId':_0xf56fe2['id'],'type':_0xb9acbc(0x1a9)});else{if(_0x48ac3b!==_0x457cf4&&_0x1f8901!==_0x335997&&!(0x0,lodash_1['isNil'])(_0x48ac3b)&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x457cf4))await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':_0xb9acbc(0x183)}),await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x457cf4,'queueId':_0x335997,'ticketId':_0xf56fe2['id'],'type':'receivedTransfer'});else _0x48ac3b!==undefined&&(0x0,lodash_1['isNil'])(_0x457cf4)&&_0x1f8901!==_0x335997&&!(0x0,lodash_1['isNil'])(_0x335997)&&await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'queueId':_0x1f8901,'ticketId':_0x289366,'type':'transfered'});}}}}return _0x3377bc=_0x32f803&&_0x32f803[_0xb9acbc(0x1cf)]?_0xb9acbc(0x1a1):_0x3377bc,await _0xf56fe2[_0xb9acbc(0x178)]({'status':_0x3377bc,'queueId':_0x335997,'userId':_0x457cf4,'isBot':_0x325efa,'queueOptionId':_0x546ae7,'amountUsedBotQueues':_0x3377bc===_0xb9acbc(0x1a1)?0x0:_0x5d229f?_0x5d229f:_0xf56fe2['amountUsedBotQueues'],'lastMessage':_0x235650?_0x235650:_0xf56fe2[_0xb9acbc(0x1c2)],'useIntegration':_0x3281ab,'integrationId':_0x408153,'unreadMessages':_0x3db9d5}),_0x2979d8[_0xb9acbc(0x1bb)]=(0x0,moment_1['default'])()[_0xb9acbc(0x182)](),_0x2979d8[_0xb9acbc(0x1c9)]=_0x335997,_0xf56fe2=await(0x0,ShowTicketService_1['default'])(_0xf56fe2['id'],_0x1f3e00),_0x3377bc!==undefined&&['pending'][_0xb9acbc(0x1c1)](_0x3377bc)>-0x1&&!(0x0,lodash_1[_0xb9acbc(0x1c6)])(_0x48ac3b)&&(await(0x0,CreateLogTicketService_1[_0xb9acbc(0x169)])({'userId':_0x48ac3b,'ticketId':_0x289366,'type':_0xb9acbc(0x1c3)}),await _0x2979d8[_0xb9acbc(0x178)]({'whatsappId':_0xf56fe2['whatsappId'],'startedAt':null,'userId':null})),_0x3377bc!==undefined&&_0x3377bc!==_0x2e891c&&['open'][_0xb9acbc(0x1c1)](_0x3377bc)>-0x1&&(await _0x2979d8['update']({'startedAt':(0x0,moment_1[_0xb9acbc(0x169)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0xf56fe2[_0xb9acbc(0x186)],'userId':_0xf56fe2[_0xb9acbc(0x19b)],'queueId':_0xf56fe2['queueId']}),await(0x0,CreateLogTicketService_1['default'])({'userId':_0x457cf4,'queueId':_0xf56fe2[_0xb9acbc(0x1c9)],'ticketId':_0x289366,'type':_0x2e891c==='pending'?_0xb9acbc(0x184):_0xb9acbc(0x171)})),await _0x2979d8['save'](),(_0xf56fe2[_0xb9acbc(0x188)]!==_0x2e891c||_0xf56fe2[_0xb9acbc(0x1bf)]?.['id']!==_0x48ac3b)&&(await _0x2979d8[_0xb9acbc(0x178)]({'userId':_0xf56fe2[_0xb9acbc(0x19b)]}),_0x1d4b33['to'](_0x2e891c)[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0x1f3e00+_0xb9acbc(0x17d),{'action':_0xb9acbc(0x1ce),'ticketId':_0xf56fe2['id']})),_0x1d4b33['to'](_0xf56fe2[_0xb9acbc(0x188)])['to'](_0xb9acbc(0x1ac))['to'](_0x289366[_0xb9acbc(0x18e)]())[_0xb9acbc(0x18a)](_0xb9acbc(0x1ae)+_0x1f3e00+'-ticket',{'action':'update','ticket':_0xf56fe2}),{'ticket':_0xf56fe2,'oldStatus':_0x2e891c,'oldUserId':_0x48ac3b};}catch(_0x51fb0e){Sentry['captureException'](_0x51fb0e);}};exports[a600_0x5f1133(0x169)]=UpdateTicketService;