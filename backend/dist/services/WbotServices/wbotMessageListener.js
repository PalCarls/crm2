'use strict';const a635_0x4f3874=a635_0x4a1a;(function(_0xb50bb5,_0x32c343){const _0xfaeec7=a635_0x4a1a,_0x4d8d69=_0xb50bb5();while(!![]){try{const _0x2681d1=-parseInt(_0xfaeec7(0x184))/0x1*(parseInt(_0xfaeec7(0x10b))/0x2)+parseInt(_0xfaeec7(0x20f))/0x3*(parseInt(_0xfaeec7(0x1bf))/0x4)+parseInt(_0xfaeec7(0x133))/0x5+-parseInt(_0xfaeec7(0x95))/0x6*(parseInt(_0xfaeec7(0x119))/0x7)+parseInt(_0xfaeec7(0xf6))/0x8+-parseInt(_0xfaeec7(0x11e))/0x9*(parseInt(_0xfaeec7(0x183))/0xa)+parseInt(_0xfaeec7(0xc7))/0xb;if(_0x2681d1===_0x32c343)break;else _0x4d8d69['push'](_0x4d8d69['shift']());}catch(_0x28644e){_0x4d8d69['push'](_0x4d8d69['shift']());}}}(a635_0x26a6,0xf1bb6));var __createBinding=this&&this[a635_0x4f3874(0xd2)]||(Object[a635_0x4f3874(0x1fb)]?function(_0x5a0525,_0x553966,_0x47708c,_0x5a16e7){const _0x1de277=a635_0x4f3874;if(_0x5a16e7===undefined)_0x5a16e7=_0x47708c;var _0x549e9c=Object[_0x1de277(0xaf)](_0x553966,_0x47708c);(!_0x549e9c||(_0x1de277(0x1d6)in _0x549e9c?!_0x553966[_0x1de277(0x203)]:_0x549e9c[_0x1de277(0x11f)]||_0x549e9c[_0x1de277(0x91)]))&&(_0x549e9c={'enumerable':!![],'get':function(){return _0x553966[_0x47708c];}}),Object[_0x1de277(0xa3)](_0x5a0525,_0x5a16e7,_0x549e9c);}:function(_0x19eecb,_0x43f6af,_0x1159f4,_0x50e055){if(_0x50e055===undefined)_0x50e055=_0x1159f4;_0x19eecb[_0x50e055]=_0x43f6af[_0x1159f4];}),__setModuleDefault=this&&this[a635_0x4f3874(0xb0)]||(Object[a635_0x4f3874(0x1fb)]?function(_0x4fe8f5,_0x146958){Object['defineProperty'](_0x4fe8f5,'default',{'enumerable':!![],'value':_0x146958});}:function(_0x5a84be,_0x328c1d){const _0x3fceb3=a635_0x4f3874;_0x5a84be[_0x3fceb3(0xe2)]=_0x328c1d;}),__importStar=this&&this[a635_0x4f3874(0x207)]||function(_0x47c860){const _0xa725cb=a635_0x4f3874;if(_0x47c860&&_0x47c860[_0xa725cb(0x203)])return _0x47c860;var _0x17b579={};if(_0x47c860!=null){for(var _0x97959d in _0x47c860)if(_0x97959d!=='default'&&Object[_0xa725cb(0x130)][_0xa725cb(0xae)][_0xa725cb(0x124)](_0x47c860,_0x97959d))__createBinding(_0x17b579,_0x47c860,_0x97959d);}return __setModuleDefault(_0x17b579,_0x47c860),_0x17b579;},__importDefault=this&&this['__importDefault']||function(_0x56f2c9){const _0x4334f6=a635_0x4f3874;return _0x56f2c9&&_0x56f2c9[_0x4334f6(0x203)]?_0x56f2c9:{'default':_0x56f2c9};};Object[a635_0x4f3874(0xa3)](exports,a635_0x4f3874(0x203),{'value':!![]}),exports[a635_0x4f3874(0x21d)]=exports[a635_0x4f3874(0x1b4)]=exports[a635_0x4f3874(0x154)]=exports[a635_0x4f3874(0x14f)]=exports[a635_0x4f3874(0x12e)]=exports[a635_0x4f3874(0x169)]=exports[a635_0x4f3874(0x13a)]=exports[a635_0x4f3874(0x8c)]=exports['verifyMediaMessage']=exports[a635_0x4f3874(0x1dd)]=exports[a635_0x4f3874(0xdc)]=exports[a635_0x4f3874(0xb4)]=exports[a635_0x4f3874(0xd3)]=void 0x0;const path_1=__importStar(require(a635_0x4f3874(0x1c1))),util_1=require('util'),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require('@sentry/node')),lodash_1=require(a635_0x4f3874(0xbf)),baileys_1=require('@whiskeysockets/baileys'),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require(a635_0x4f3874(0xc1))),Message_1=__importDefault(require(a635_0x4f3874(0x9c))),socket_1=require('../../libs/socket'),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),logger_1=require(a635_0x4f3874(0x186)),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),FindOrCreateTicketService_1=__importDefault(require(a635_0x4f3874(0x152))),ShowWhatsAppService_1=__importDefault(require(a635_0x4f3874(0xd5))),Debounce_1=require('../../helpers/Debounce'),UpdateTicketService_1=__importDefault(require(a635_0x4f3874(0xd9))),Mustache_1=__importDefault(require(a635_0x4f3874(0xe0))),UserRating_1=__importDefault(require(a635_0x4f3874(0x173))),SendWhatsAppMessage_1=__importDefault(require(a635_0x4f3874(0x1ee))),sendFacebookMessage_1=__importDefault(require('../FacebookServices/sendFacebookMessage')),moment_1=__importDefault(require(a635_0x4f3874(0x12c))),Queue_1=__importDefault(require(a635_0x4f3874(0x137))),FindOrCreateATicketTrakingService_1=__importDefault(require('../TicketServices/FindOrCreateATicketTrakingService')),VerifyCurrentSchedule_1=__importDefault(require(a635_0x4f3874(0x145))),Campaign_1=__importDefault(require(a635_0x4f3874(0x1ea))),CampaignShipping_1=__importDefault(require(a635_0x4f3874(0x16c))),sequelize_1=require(a635_0x4f3874(0x126)),queues_1=require(a635_0x4f3874(0x19c)),User_1=__importDefault(require(a635_0x4f3874(0xfd))),ChatBotListener_1=require('./ChatBotListener'),MarkDeleteWhatsAppMessage_1=__importDefault(require(a635_0x4f3874(0x151))),ListUserQueueServices_1=__importDefault(require(a635_0x4f3874(0x105))),cache_1=__importDefault(require(a635_0x4f3874(0x1a0))),addLogs_1=require(a635_0x4f3874(0x90)),SendWhatsAppMedia_1=__importStar(require('./SendWhatsAppMedia')),ShowQueueIntegrationService_1=__importDefault(require(a635_0x4f3874(0x1f3))),CreateSessionDialogflow_1=require(a635_0x4f3874(0x1fe)),QueryDialogflow_1=require(a635_0x4f3874(0x102)),CompaniesSettings_1=__importDefault(require(a635_0x4f3874(0x185))),CreateLogTicketService_1=__importDefault(require(a635_0x4f3874(0x149))),Whatsapp_1=__importDefault(require(a635_0x4f3874(0xfe))),ShowService_1=__importDefault(require(a635_0x4f3874(0x21e))),openai_1=require(a635_0x4f3874(0x125)),fluent_ffmpeg_1=__importDefault(require(a635_0x4f3874(0xc3))),microsoft_cognitiveservices_speech_sdk_1=require(a635_0x4f3874(0xdd)),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),os=require('os'),request=require(a635_0x4f3874(0x157));let ffmpegPath;if(os[a635_0x4f3874(0xf1)]()===a635_0x4f3874(0x7f))ffmpegPath='C:\x5cffmpeg\x5cffmpeg.exe';else os['platform']()===a635_0x4f3874(0x1c3)?ffmpegPath=a635_0x4f3874(0x1ae):ffmpegPath=a635_0x4f3874(0x1d0);function a635_0x4a1a(_0x4b1b04,_0x3b3cdd){const _0x26a611=a635_0x26a6();return a635_0x4a1a=function(_0x4a1a47,_0x406417){_0x4a1a47=_0x4a1a47-0x79;let _0x1a9a33=_0x26a611[_0x4a1a47];return _0x1a9a33;},a635_0x4a1a(_0x4b1b04,_0x3b3cdd);}fluent_ffmpeg_1[a635_0x4f3874(0xe2)][a635_0x4f3874(0x210)](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a635_0x4f3874(0x219)])(fs_1[a635_0x4f3874(0x1e6)]);function removeFile(_0x22750d){const _0x38a6a1=a635_0x4f3874;fs_2[_0x38a6a1(0xe2)]['unlink'](_0x22750d,_0x3a3d8c=>{if(_0x3a3d8c)throw _0x3a3d8c;});}const getTimestampMessage=_0x17cee9=>{return _0x17cee9*0x1;},multVecardGet=function(_0x3b368d){const _0x58d56f=a635_0x4f3874;let _0xba1033='\x20',_0x1cd0f3=_0x3b368d[_0x58d56f(0x20c)]('\x0a')[0x2][_0x58d56f(0x153)](_0x58d56f(0x123),'\x0a')['replace']('N:','')[_0x58d56f(0x153)](';','')['replace'](';','\x20')['replace'](';;','\x20')[_0x58d56f(0x153)]('\x0a',''),_0x31b45c=_0x3b368d['split']('\x0a')[0x4][_0x58d56f(0x109)]('='),_0x4c5c74=_0x3b368d[_0x58d56f(0x20c)]('\x0a')[0x4]['indexOf'](':'),_0x5ac4bc=_0x3b368d[_0x58d56f(0x20c)]('\x0a')[0x4][_0x58d56f(0x96)](_0x31b45c+0x1,_0x4c5c74)[_0x58d56f(0x153)](';',''),_0x43c0e9=_0x3b368d[_0x58d56f(0x20c)]('\x0a')[0x4][_0x58d56f(0x153)](_0x58d56f(0x14b),'');if(_0x5ac4bc!='item1.TEL')_0xba1033=_0xba1033+_0x1cd0f3+_0x58d56f(0x187)+_0x5ac4bc+''+'\x0a';else _0xba1033=_0xba1033+_0x1cd0f3+_0x58d56f(0x187)+_0x43c0e9+''+'\x0a';return _0xba1033;},contactsArrayMessageGet=_0x1ab534=>{const _0x590ba7=a635_0x4f3874;let _0x432c1e=_0x1ab534[_0x590ba7(0x159)]?.[_0x590ba7(0x197)]?.['contacts'],_0x3656e3=_0x432c1e[_0x590ba7(0x1f8)](function(_0x494d9c,_0x4b7580){const _0x34dd19=_0x590ba7;return _0x494d9c[_0x34dd19(0x86)];}),_0x1a186d='';_0x3656e3[_0x590ba7(0x1e8)](function(_0x5d07ed,_0x3fbdf9){_0x1a186d+=_0x5d07ed+'\x0a\x0a'+'';});let _0x5e4ba0=_0x1a186d[_0x590ba7(0x20c)](_0x590ba7(0x17f));_0x5e4ba0[_0x590ba7(0xb9)]();let _0x46a70f='';for(let _0x366055 of _0x5e4ba0){_0x46a70f=_0x46a70f+multVecardGet(_0x366055);}return _0x46a70f;},getTypeMessage=_0x295351=>{const _0x4c0a49=a635_0x4f3874,_0x2c7e4a=(0x0,baileys_1[_0x4c0a49(0x104)])(_0x295351['message']);if(_0x295351[_0x4c0a49(0x159)]?.['viewOnceMessageV2'])return'viewOnceMessageV2';return _0x2c7e4a;};exports[a635_0x4f3874(0x21d)]=getTypeMessage;const getBodyButton=_0x1d4af4=>{const _0x5bebd2=a635_0x4f3874;if(_0x1d4af4[_0x5bebd2(0x189)][_0x5bebd2(0x1b8)]&&_0x1d4af4[_0x5bebd2(0x159)]['buttonsMessage']?.[_0x5bebd2(0x10a)]){let _0x30e001=''+_0x1d4af4?.[_0x5bebd2(0x159)]?.['buttonsMessage']?.[_0x5bebd2(0x10a)];for(const _0x108411 of _0x1d4af4[_0x5bebd2(0x159)]?.[_0x5bebd2(0x204)]?.[_0x5bebd2(0x15c)]){_0x30e001+='\x0a\x0a'+_0x108411[_0x5bebd2(0x1b0)]?.[_0x5bebd2(0x155)];}return _0x30e001;}if(_0x1d4af4[_0x5bebd2(0x189)][_0x5bebd2(0x1b8)]&&_0x1d4af4?.[_0x5bebd2(0x159)]?.[_0x5bebd2(0x11d)]?.[_0x5bebd2(0x159)]?.[_0x5bebd2(0x93)]){let _0x607757=''+_0x1d4af4?.[_0x5bebd2(0x159)]?.[_0x5bebd2(0x11d)]?.[_0x5bebd2(0x159)]?.[_0x5bebd2(0x93)]?.[_0x5bebd2(0x170)];for(const _0x335176 of _0x1d4af4[_0x5bebd2(0x159)]?.[_0x5bebd2(0x11d)]?.[_0x5bebd2(0x159)]?.['listMessage']?.[_0x5bebd2(0xa5)]){for(const _0x215d13 of _0x335176[_0x5bebd2(0x195)]){_0x607757+='\x0a\x0a'+_0x215d13[_0x5bebd2(0x165)];}}return _0x607757;}},getBodyList=_0x5607b9=>{const _0x71175d=a635_0x4f3874;if(_0x5607b9[_0x71175d(0x189)][_0x71175d(0x1b8)]&&_0x5607b9['message'][_0x71175d(0x93)]?.['description']){let _0xb52f04=''+_0x5607b9[_0x71175d(0x159)][_0x71175d(0x93)]?.[_0x71175d(0x170)];for(const _0x2bc5ea of _0x5607b9[_0x71175d(0x159)][_0x71175d(0x93)]?.[_0x71175d(0xa5)]){for(const _0x629424 of _0x2bc5ea[_0x71175d(0x195)]){_0xb52f04+='\x0a\x0a'+_0x629424[_0x71175d(0x165)];}}return _0xb52f04;}if(_0x5607b9[_0x71175d(0x189)]['fromMe']&&_0x5607b9?.['message']?.['viewOnceMessage']?.[_0x71175d(0x159)]?.[_0x71175d(0x93)]){let _0x44ec09=''+_0x5607b9?.['message']?.['viewOnceMessage']?.[_0x71175d(0x159)]?.['listMessage']?.[_0x71175d(0x170)];for(const _0x333834 of _0x5607b9[_0x71175d(0x159)]?.[_0x71175d(0x11d)]?.[_0x71175d(0x159)]?.[_0x71175d(0x93)]?.[_0x71175d(0xa5)]){for(const _0x2e4f0d of _0x333834[_0x71175d(0x195)]){_0x44ec09+='\x0a\x0a'+_0x2e4f0d[_0x71175d(0x165)];}}return _0x44ec09;}},msgLocation=(_0x4bfa0f,_0x3264bc,_0x397581)=>{const _0x335897=a635_0x4f3874;if(_0x4bfa0f){var _0x49ba6f=Buffer[_0x335897(0x141)](_0x4bfa0f)[_0x335897(0x1df)](_0x335897(0x10d));let _0x3912db='data:image/png;base64,\x20'+_0x49ba6f+_0x335897(0x1bd)+_0x3264bc+_0x335897(0x18b)+_0x397581+'&z=17&hl=pt-BR|'+_0x3264bc+',\x20'+_0x397581+'\x20';return _0x3912db;}},getBodyMessage=_0x17d540=>{const _0x363ca8=a635_0x4f3874;try{let _0x1cbc0a=getTypeMessage(_0x17d540);if(_0x1cbc0a===undefined)console[_0x363ca8(0xfa)](_0x17d540);const _0x86e0ef={'conversation':_0x17d540[_0x363ca8(0x159)]?.['conversation'],'imageMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x15f)]?.[_0x363ca8(0xf2)],'videoMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x13d)]?.['caption'],'extendedTextMessage':_0x17d540?.[_0x363ca8(0x159)]?.[_0x363ca8(0x172)]?.['text'],'buttonsResponseMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x200)]?.['selectedDisplayText'],'listResponseMessage':_0x17d540['message']?.[_0x363ca8(0x1c9)]?.['title']||_0x17d540[_0x363ca8(0x159)]?.['listResponseMessage']?.['singleSelectReply']?.[_0x363ca8(0x1c5)],'templateButtonReplyMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0xa4)]?.[_0x363ca8(0x179)],'messageContextInfo':_0x17d540['message']?.['buttonsResponseMessage']?.[_0x363ca8(0xf3)]||_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x1c9)]?.[_0x363ca8(0x165)],'buttonsMessage':getBodyButton(_0x17d540)||_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x1c9)]?.['title'],'stickerMessage':_0x363ca8(0x19f),'contactMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x18d)]?.[_0x363ca8(0x86)],'contactsArrayMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x197)]?.['contacts']&&contactsArrayMessageGet(_0x17d540),'locationMessage':msgLocation(_0x17d540[_0x363ca8(0x159)]?.['locationMessage']?.[_0x363ca8(0x18c)],_0x17d540[_0x363ca8(0x159)]?.['locationMessage']?.[_0x363ca8(0xef)],_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x163)]?.[_0x363ca8(0x164)]),'liveLocationMessage':'Latitude:\x20'+_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x110)]?.[_0x363ca8(0xef)]+_0x363ca8(0x21c)+_0x17d540[_0x363ca8(0x159)]?.['liveLocationMessage']?.[_0x363ca8(0x164)],'documentMessage':_0x17d540['message']?.[_0x363ca8(0x1d5)]?.[_0x363ca8(0xf2)],'audioMessage':'Áudio','listMessage':getBodyList(_0x17d540)||_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0x1c9)]?.[_0x363ca8(0x165)],'viewOnceMessage':getBodyButton(_0x17d540),'reactionMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0xad)]?.[_0x363ca8(0x83)]||'reaction','senderKeyDistributionMessage':_0x17d540?.[_0x363ca8(0x159)]?.[_0x363ca8(0x1cc)]?.['axolotlSenderKeyDistributionMessage'],'documentWithCaptionMessage':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0xd0)]?.[_0x363ca8(0x159)]?.['documentMessage']?.['caption'],'viewOnceMessageV2':_0x17d540[_0x363ca8(0x159)]?.[_0x363ca8(0xf4)]?.[_0x363ca8(0x159)]?.[_0x363ca8(0x15f)]?.[_0x363ca8(0xf2)],'editedMessage':_0x17d540[_0x363ca8(0x159)]?.['editedMessage']?.['message']?.[_0x363ca8(0x172)]?.[_0x363ca8(0x83)],'ephemeralMessage':_0x17d540[_0x363ca8(0x159)]?.['ephemeralMessage']?.[_0x363ca8(0x159)]?.[_0x363ca8(0x172)]?.['text']},_0x2fd6a9=Object[_0x363ca8(0x17c)](_0x86e0ef)['find'](_0x302348=>_0x302348===_0x1cbc0a);return!_0x2fd6a9&&(logger_1[_0x363ca8(0xab)][_0x363ca8(0x15a)](_0x363ca8(0xe9)+_0x1cbc0a+'\x0a'+JSON[_0x363ca8(0x14e)](_0x17d540)),Sentry[_0x363ca8(0x161)]('Mensagem',{'BodyMsg':_0x17d540['message'],'msg':_0x17d540,'type':_0x1cbc0a}),Sentry[_0x363ca8(0x1fd)](new Error(_0x363ca8(0x10c)))),_0x86e0ef[_0x1cbc0a];}catch(_0x2b7735){Sentry[_0x363ca8(0x161)](_0x363ca8(0x1a1),{'msg':_0x17d540,'BodyMsg':_0x17d540[_0x363ca8(0x159)]}),Sentry['captureException'](_0x2b7735),console[_0x363ca8(0xfa)](_0x2b7735);}};exports[a635_0x4f3874(0xd3)]=getBodyMessage;const getQuotedMessage=_0xa45562=>{const _0x556849=a635_0x4f3874,_0x1685f5=(0x0,baileys_1[_0x556849(0x13e)])(_0xa45562[_0x556849(0x159)])[Object[_0x556849(0x17c)](_0xa45562?.[_0x556849(0x159)])[_0x556849(0x131)]()[_0x556849(0x1ef)]()['value']];if(!_0x1685f5?.[_0x556849(0x192)]?.[_0x556849(0x7a)])return;const _0x17bf37=(0x0,baileys_1[_0x556849(0x13e)])(_0x1685f5?.[_0x556849(0x192)]?.[_0x556849(0x7a)][Object[_0x556849(0x17c)](_0x1685f5?.[_0x556849(0x192)]?.[_0x556849(0x7a)])[_0x556849(0x131)]()[_0x556849(0x1ef)]()[_0x556849(0x148)]]);return _0x17bf37;};exports[a635_0x4f3874(0xb4)]=getQuotedMessage;const getQuotedMessageId=_0x5603ea=>{const _0x5ecc2e=a635_0x4f3874,_0x47ad86=(0x0,baileys_1[_0x5ecc2e(0x13e)])(_0x5603ea[_0x5ecc2e(0x159)])[Object[_0x5ecc2e(0x17c)](_0x5603ea?.['message'])[_0x5ecc2e(0x131)]()[_0x5ecc2e(0x1ef)]()[_0x5ecc2e(0x148)]];let _0x4a1b09=_0x5603ea?.['message']?.[_0x5ecc2e(0xad)]?_0x5603ea?.['message']?.['reactionMessage']?.['key']?.['id']:'';return _0x4a1b09?_0x4a1b09:_0x47ad86?.['contextInfo']?.[_0x5ecc2e(0x15d)];};exports['getQuotedMessageId']=getQuotedMessageId;const getMeSocket=_0x5abc6e=>{const _0x1b55d1=a635_0x4f3874;return{'id':(0x0,baileys_1[_0x1b55d1(0x9e)])(_0x5abc6e['user']['id']),'name':_0x5abc6e[_0x1b55d1(0x14c)][_0x1b55d1(0x8b)]};},getSenderMessage=(_0x30511b,_0x3fdff2)=>{const _0x224cf8=a635_0x4f3874,_0x880076=getMeSocket(_0x3fdff2);if(_0x30511b[_0x224cf8(0x189)][_0x224cf8(0x1b8)])return _0x880076['id'];const _0x41b7b7=_0x30511b[_0x224cf8(0xb3)]||_0x30511b[_0x224cf8(0x189)][_0x224cf8(0xb3)]||_0x30511b[_0x224cf8(0x189)]['remoteJid']||undefined;return _0x41b7b7&&(0x0,baileys_1[_0x224cf8(0x9e)])(_0x41b7b7);},getContactMessage=async(_0x3e3abd,_0x4cda51)=>{const _0x43d3a6=a635_0x4f3874,_0xce071b=_0x3e3abd[_0x43d3a6(0x189)][_0x43d3a6(0x14d)]['includes'](_0x43d3a6(0x1a9)),_0x407f3c=_0x3e3abd[_0x43d3a6(0x189)][_0x43d3a6(0x14d)]['replace'](/\D/g,'');return _0xce071b?{'id':getSenderMessage(_0x3e3abd,_0x4cda51),'name':_0x3e3abd[_0x43d3a6(0x85)]}:{'id':_0x3e3abd[_0x43d3a6(0x189)]['remoteJid'],'name':_0x3e3abd[_0x43d3a6(0x189)][_0x43d3a6(0x1b8)]?_0x407f3c:_0x3e3abd[_0x43d3a6(0x85)]};},downloadMedia=async(_0x303071,_0xc3c212=null)=>{const _0x4b8a4c=a635_0x4f3874;let _0x5a9aea;try{_0x5a9aea=await(0x0,baileys_1[_0x4b8a4c(0x218)])(_0x303071,_0x4b8a4c(0x1d2),{});}catch(_0x4cf029){_0xc3c212?console['log'](_0x4b8a4c(0x8a)):console[_0x4b8a4c(0x1e1)](_0x4b8a4c(0x1c7),_0x4cf029);}let _0x5b8bba=_0x303071['message']?.[_0x4b8a4c(0x1d5)]?.[_0x4b8a4c(0x178)]||'';const _0x55791e=_0x303071['message']?.[_0x4b8a4c(0x15f)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x9f)]||_0x303071['message']?.['videoMessage']||_0x303071['message']?.[_0x4b8a4c(0x121)]||_0x303071['message']?.[_0x4b8a4c(0x1d5)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xd0)]?.[_0x4b8a4c(0x159)]?.['documentMessage']||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xe1)]?.[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x9f)]||_0x303071[_0x4b8a4c(0x159)]?.['ephemeralMessage']?.['message']?.[_0x4b8a4c(0x1d5)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xe1)]?.[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x13d)]||_0x303071[_0x4b8a4c(0x159)]?.['ephemeralMessage']?.[_0x4b8a4c(0x159)]?.['stickerMessage']||_0x303071['message']?.['viewOnceMessage']?.[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x15f)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x11d)]?.[_0x4b8a4c(0x159)]?.['videoMessage']||_0x303071['message']?.[_0x4b8a4c(0xe1)]?.[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x11d)]?.['message']?.[_0x4b8a4c(0x15f)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xe1)]?.['message']?.[_0x4b8a4c(0x11d)]?.[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x13d)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xe1)]?.['message']?.['viewOnceMessage']?.[_0x4b8a4c(0x159)]?.['audioMessage']||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xe1)]?.[_0x4b8a4c(0x159)]?.['viewOnceMessage']?.[_0x4b8a4c(0x159)]?.['documentMessage']||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0xd0)]?.['message']?.[_0x4b8a4c(0x1d5)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x181)]?.['hydratedTemplate']?.[_0x4b8a4c(0x15f)]||_0x303071[_0x4b8a4c(0x159)]?.['templateMessage']?.[_0x4b8a4c(0x213)]?.[_0x4b8a4c(0x1d5)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x181)]?.[_0x4b8a4c(0x213)]?.[_0x4b8a4c(0x13d)]||_0x303071['message']?.[_0x4b8a4c(0x181)]?.[_0x4b8a4c(0x1db)]?.['imageMessage']||_0x303071[_0x4b8a4c(0x159)]?.['templateMessage']?.[_0x4b8a4c(0x1db)]?.[_0x4b8a4c(0x1d5)]||_0x303071['message']?.['templateMessage']?.[_0x4b8a4c(0x1db)]?.[_0x4b8a4c(0x13d)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x181)]?.[_0x4b8a4c(0x190)]?.[_0x4b8a4c(0x15f)]||_0x303071[_0x4b8a4c(0x159)]?.[_0x4b8a4c(0x181)]?.[_0x4b8a4c(0x190)]?.[_0x4b8a4c(0x1d5)]||_0x303071[_0x4b8a4c(0x159)]?.['templateMessage']?.[_0x4b8a4c(0x190)]?.[_0x4b8a4c(0x13d)]||_0x303071['message']?.[_0x4b8a4c(0x18a)]?.[_0x4b8a4c(0xea)]?.[_0x4b8a4c(0x15f)]||_0x303071[_0x4b8a4c(0x159)]?.['interactiveMessage']?.[_0x4b8a4c(0xea)]?.[_0x4b8a4c(0x1d5)]||_0x303071['message']?.[_0x4b8a4c(0x18a)]?.[_0x4b8a4c(0xea)]?.[_0x4b8a4c(0x13d)];if(!_0x55791e)console['log'](_0x303071);if(!_0x5b8bba){const _0x509029=_0x55791e[_0x4b8a4c(0xe4)]['split']('/')[0x1][_0x4b8a4c(0x20c)](';')[0x0];_0x5b8bba=new Date()['getTime']()+'.'+_0x509029;}else _0x5b8bba=new Date()[_0x4b8a4c(0xc6)]()+'_'+_0x5b8bba;const _0x3fef4a={'data':_0x5a9aea,'mimetype':_0x55791e[_0x4b8a4c(0xe4)],'filename':_0x5b8bba};return _0x3fef4a;};exports['downloadMedia']=downloadMedia;const verifyContact=async(_0x38ff87,_0x5a4de2,_0xbb3e96)=>{const _0x3ee6b0=a635_0x4f3874;let _0x810cd9;try{_0x810cd9=await _0x5a4de2['profilePictureUrl'](_0x38ff87['id'],'image');}catch(_0x699567){Sentry[_0x3ee6b0(0x1fd)](_0x699567),_0x810cd9=process['env']['FRONTEND_URL']+'/nopicture.png';}const _0x4704f0={'name':_0x38ff87[_0x3ee6b0(0x8b)]||_0x38ff87['id'][_0x3ee6b0(0x153)](/\D/g,''),'number':_0x38ff87['id']['replace'](/\D/g,''),'profilePicUrl':_0x810cd9,'isGroup':_0x38ff87['id']['includes'](_0x3ee6b0(0x1a9)),'companyId':_0xbb3e96,'remoteJid':_0x38ff87['id']};_0x4704f0[_0x3ee6b0(0xb1)]&&(_0x4704f0['number']=_0x38ff87['id'][_0x3ee6b0(0x153)](_0x3ee6b0(0x156),''));const _0x1553d8=await(0x0,CreateOrUpdateContactService_1[_0x3ee6b0(0xe2)])(_0x4704f0);return _0x1553d8;},verifyQuotedMessage=async _0x35462e=>{const _0x91f57f=a635_0x4f3874;if(!_0x35462e)return null;const _0x38f68c=(0x0,exports['getQuotedMessageId'])(_0x35462e);if(!_0x38f68c)return null;const _0x1ab79e=await Message_1[_0x91f57f(0xe2)][_0x91f57f(0x19a)]({'where':{'wid':_0x38f68c}});if(!_0x1ab79e)return null;return _0x1ab79e;},verifyMediaMessage=async(_0x1fec28,_0x44e323,_0x3cca7c,_0x3f3271,_0x44ecfc)=>{const _0xffa2ef=a635_0x4f3874,_0x4579ce=(0x0,socket_1['getIO'])(),_0x51ec3c=await verifyQuotedMessage(_0x1fec28),_0x1c5198=_0x44e323[_0xffa2ef(0x1a5)];try{const _0x28fec3=await(0x0,exports[_0xffa2ef(0x1dd)])(_0x1fec28,_0x44e323?.['imported']);if(!_0x28fec3&&_0x44e323[_0xffa2ef(0x1f0)]){const _0x4e3c24=_0xffa2ef(0xac),_0x45ae74={'wid':_0x1fec28[_0xffa2ef(0x189)]['id'],'ticketId':_0x44e323['id'],'contactId':_0x1fec28[_0xffa2ef(0x189)][_0xffa2ef(0x1b8)]?undefined:_0x44e323[_0xffa2ef(0x142)],'body':_0x4e3c24,'reactionMessage':_0x1fec28[_0xffa2ef(0x159)]?.[_0xffa2ef(0xad)],'fromMe':_0x1fec28[_0xffa2ef(0x189)][_0xffa2ef(0x1b8)],'mediaType':getTypeMessage(_0x1fec28),'read':_0x1fec28[_0xffa2ef(0x189)][_0xffa2ef(0x1b8)],'quotedMsgId':_0x51ec3c?.['id']||_0x1fec28[_0xffa2ef(0x159)]?.[_0xffa2ef(0xad)]?.[_0xffa2ef(0x189)]?.['id'],'ack':_0x1fec28['status'],'companyId':_0x1c5198,'remoteJid':_0x1fec28['key']['remoteJid'],'participant':_0x1fec28[_0xffa2ef(0x189)][_0xffa2ef(0xb3)],'timestamp':getTimestampMessage(_0x1fec28[_0xffa2ef(0xba)]),'createdAt':new Date(Math[_0xffa2ef(0x8d)](getTimestampMessage(_0x1fec28[_0xffa2ef(0xba)])*0x3e8))[_0xffa2ef(0x1b7)](),'dataJson':JSON[_0xffa2ef(0x14e)](_0x1fec28),'ticketImported':_0x44e323[_0xffa2ef(0x1f0)],'isForwarded':_0x44ecfc};return await _0x44e323[_0xffa2ef(0x111)]({'lastMessage':_0x4e3c24}),logger_1[_0xffa2ef(0xab)][_0xffa2ef(0x1e1)](Error('ERR_WAPP_DOWNLOAD_MEDIA')),(0x0,CreateMessageService_1[_0xffa2ef(0xe2)])({'messageData':_0x45ae74,'companyId':_0x1c5198});}if(!_0x28fec3)throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');if(!_0x28fec3[_0xffa2ef(0xed)]){const _0x15020d=_0x28fec3['mimetype'][_0xffa2ef(0x20c)]('/')[0x1][_0xffa2ef(0x20c)](';')[0x0];_0x28fec3[_0xffa2ef(0xed)]=new Date()[_0xffa2ef(0xc6)]()+'.'+_0x15020d;}else{const _0x3aac3d=_0x28fec3[_0xffa2ef(0xed)][_0xffa2ef(0x20c)]('.')['pop'](),_0x590931=_0x28fec3[_0xffa2ef(0xed)]['split']('.')[_0xffa2ef(0x182)](0x0,-0x1)['join']('.')['replace'](/\s/g,'_')[_0xffa2ef(0x1ca)](_0xffa2ef(0x1eb))[_0xffa2ef(0x153)](/[\u0300-\u036f]/g,'');_0x28fec3[_0xffa2ef(0xed)]=_0x590931[_0xffa2ef(0xcc)]()+'_'+new Date()[_0xffa2ef(0xc6)]()+'.'+_0x3aac3d;}try{const _0x26cca5=path_1[_0xffa2ef(0xe2)]['resolve'](__dirname,'..','..','..',_0xffa2ef(0xe5),'company'+_0x1c5198);!fs_2['default'][_0xffa2ef(0x1b5)](_0x26cca5)&&(fs_2['default']['mkdirSync'](_0x26cca5,{'recursive':!![]}),fs_2[_0xffa2ef(0xe2)][_0xffa2ef(0x11c)](_0x26cca5,0x1ff)),await writeFileAsync((0x0,path_1['join'])(_0x26cca5,_0x28fec3[_0xffa2ef(0xed)]),_0x28fec3['data'][_0xffa2ef(0x1df)](_0xffa2ef(0x10d)),'base64')[_0xffa2ef(0x21f)](()=>{const _0x4a1828=_0xffa2ef;if(_0x28fec3['mimetype'][_0x4a1828(0xcb)](_0x4a1828(0x10f))){const _0x2e370a=path_1['default'][_0x4a1828(0x167)](_0x26cca5,_0x28fec3['filename']);let _0x23b343;if(_0x2e370a['endsWith']('.mpeg'))_0x23b343=_0x2e370a[_0x4a1828(0x153)](_0x4a1828(0x11b),_0x4a1828(0xeb));else{if(_0x2e370a[_0x4a1828(0x202)]('.ogg'))_0x23b343=_0x2e370a[_0x4a1828(0x153)](_0x4a1828(0x215),'.mp3');else{console[_0x4a1828(0x1e1)](_0x4a1828(0x138),_0x2e370a);return;}}return new Promise((_0x43a831,_0x489955)=>{const _0x85f524=_0x4a1828;(0x0,fluent_ffmpeg_1[_0x85f524(0xe2)])(_0x2e370a)[_0x85f524(0x1e4)]('mp3')[_0x85f524(0x12b)](_0x23b343)['on'](_0x85f524(0xb7),()=>{_0x43a831();})['on'](_0x85f524(0x1e1),_0x563584=>{_0x489955(_0x563584);});});}});}catch(_0x23741b){Sentry[_0xffa2ef(0x161)]('Erro\x20media',{'companyId':_0x1c5198,'ticket':_0x44e323,'contact':_0x3cca7c,'media':_0x28fec3,'quotedMsg':_0x51ec3c}),Sentry[_0xffa2ef(0x1fd)](_0x23741b),logger_1[_0xffa2ef(0xab)][_0xffa2ef(0x1e1)](_0x23741b),console['log'](_0x1fec28);}const _0x245fe2=(0x0,exports[_0xffa2ef(0xd3)])(_0x1fec28),_0x5121a1={'wid':_0x1fec28[_0xffa2ef(0x189)]['id'],'ticketId':_0x44e323['id'],'contactId':_0x1fec28[_0xffa2ef(0x189)][_0xffa2ef(0x1b8)]?undefined:_0x3cca7c['id'],'body':_0x245fe2||_0x28fec3[_0xffa2ef(0xed)],'fromMe':_0x1fec28[_0xffa2ef(0x189)]['fromMe'],'read':_0x1fec28[_0xffa2ef(0x189)][_0xffa2ef(0x1b8)],'mediaUrl':_0x28fec3[_0xffa2ef(0xed)],'mediaType':_0x28fec3[_0xffa2ef(0xe4)][_0xffa2ef(0x20c)]('/')[0x0],'quotedMsgId':_0x51ec3c?.['id'],'ack':_0x1fec28['status'],'remoteJid':_0x1fec28['key'][_0xffa2ef(0x14d)],'participant':_0x1fec28['key']['participant'],'dataJson':JSON[_0xffa2ef(0x14e)](_0x1fec28),'ticketTrakingId':_0x3f3271?.['id'],'createdAt':new Date(Math[_0xffa2ef(0x8d)](getTimestampMessage(_0x1fec28[_0xffa2ef(0xba)])*0x3e8))[_0xffa2ef(0x1b7)](),'ticketImported':_0x44e323[_0xffa2ef(0x1f0)],'isForwarded':_0x44ecfc};await _0x44e323['update']({'lastMessage':_0x245fe2||_0x28fec3[_0xffa2ef(0xed)]});const _0x484e5c=await(0x0,CreateMessageService_1[_0xffa2ef(0xe2)])({'messageData':_0x5121a1,'companyId':_0x1c5198});return!_0x1fec28[_0xffa2ef(0x189)]['fromMe']&&_0x44e323[_0xffa2ef(0x222)]===_0xffa2ef(0x160)&&(await _0x44e323[_0xffa2ef(0x111)]({'status':_0xffa2ef(0x144)}),await _0x44e323[_0xffa2ef(0x87)]({'include':[{'model':Queue_1[_0xffa2ef(0xe2)],'as':_0xffa2ef(0x10e)},{'model':User_1[_0xffa2ef(0xe2)],'as':_0xffa2ef(0x14c)},{'model':Contact_1[_0xffa2ef(0xe2)],'as':_0xffa2ef(0x11a)},{'model':Whatsapp_1['default'],'as':'whatsapp'}]}),_0x4579ce['to']('closed')[_0xffa2ef(0x143)](_0xffa2ef(0xbd)+_0x1c5198+_0xffa2ef(0x1a4),{'action':_0xffa2ef(0x7d),'ticket':_0x44e323,'ticketId':_0x44e323['id']}),_0x4579ce['to'](_0x44e323['status'])['to'](_0x44e323['id']['toString']())['emit'](_0xffa2ef(0xbd)+_0x1c5198+_0xffa2ef(0x1a4),{'action':_0xffa2ef(0x111),'ticket':_0x44e323,'ticketId':_0x44e323['id']})),_0x484e5c;}catch(_0x2b0606){console[_0xffa2ef(0xfa)](_0x2b0606),logger_1['logger']['warn'](_0xffa2ef(0x1c4));}};function a635_0x26a6(){const _0x20e682=['speechSynthesisVoiceName','-appMessage','defineProperty','templateButtonReplyMessage','sections','isBetween','CIPHERTEXT','createChatCompletion','collectiveVacationEnd','voice','logger','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mídia\x20verifique\x20no\x20dispositivo','reactionMessage','hasOwnProperty','getOwnPropertyDescriptor','__setModuleDefault','isGroup','lgpdAcceptedAt','participant','getQuotedMessage','integrationId','groups.update','end','editedMessage','shift','messageTimestamp','Nas\x20respostas\x20utilize\x20o\x20nome\x20','gpt-3.5-turbo-1106','company-','chatBot','lodash','Importando\x20Mensagem:\x20','../../models/Ticket','@c.us','fluent-ffmpeg','processImportMessagesWppId','E2E_IDENTITY_CHANGED','getTime','16914348zVFnrh','lgpdSendMessageAt','isInteger','sayChatbot','includes','trim',':*\x20Não\x20consegui\x20entender\x20sua\x20dúvida.','fileListId','type','documentWithCaptionMessage','language','__createBinding','getBodyMessage','Mensagem','../WhatsappService/ShowWhatsAppService','speakTextAsync','voiceKey','maxMessages','../TicketServices/UpdateTicketService','>>>>>>>>>>>>>>>>>>>','setMinutes','getQuotedMessageId','microsoft-cognitiveservices-speech-sdk','ASC','Configuration','../../helpers/Mustache','ephemeralMessage','default','queueId','mimetype','public','userId','REVOKE','disableBot','####\x20Nao\x20achou\x20o\x20type\x20152:\x20','header','.mp3','‎\x20*','filename','useIntegration','degreesLatitude','open','platform','caption','selectedButtonId','viewOnceMessageV2','FRONTEND_URL','3485208LisMxD','stringValue','toDate','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','log','findAndCountAll','isForwarded','../../models/User','../../models/Whatsapp','conversation','groupMetadata','Validação\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','../QueueIntegrationServices/QueryDialogflow','POST','getContentType','../UserQueueServices/ListUserQueueServices','fromSubscription','acceptAudioMessageContact','resolve','indexOf','contentText','52cwRxXi','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage','base64','queue','audio','liveLocationMessage','update','endConversation','WAMessageStubType','unlinkSync','delay','Erro\x20para\x20responder\x20com\x20audio:\x20','lgpd','timeUseBotQueues','7OhvldY','contact','.mpeg','chmodSync','viewOnceMessage','7379883hLjXXL','writable','catch','stickerMessage','paused',';;;','call','openai','sequelize','getIO','\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento','isNull','collectiveVacationMessage','save','moment','medias','handleMessageIntegration','subject','prototype','values','findByPk','6103205ezKjNr','sair','finishedAt','campaignId','../../models/Queue','Formato\x20de\x20arquivo\x20não\x20suportado:','entries','verifyRating','system','sendMessage','videoMessage','extractMessageContent','contacts:','farewellMessage','from','contactId','emit','pending','../CompanyService/VerifyCurrentSchedule','texto','pt-BR-FabioNeural','value','../TicketServices/CreateLogTicketService','createReadStream','item1.TEL:','user','remoteJid','stringify','wbotMessageListener','collectiveVacationStart','./MarkDeleteWhatsAppMessage','../TicketServices/FindOrCreateTicketService','replace','handleMessage','displayText','@g.us','request','Erro\x20ao\x20deletar\x20o\x20arquivo:','message','warn','ratingAt','buttons','stanzaId','OpenAIApi','imageMessage','closed','setExtra','filter','locationMessage','degreesLongitude','title','Amigo(a)','join','mediaMessage','handleRating','set','mp3','../../models/CampaignShipping','channel','Error\x20converting\x20file:\x20','createDialogflowSessionWithModel','description','acceptAudioMessage','extendedTextMessage','../../models/UserRating','inActivity','verifyMediaMessage','profilePictureUrl','Esta\x20mensagem\x20já\x20existe','fileName','selectedId','greetingMediaAttachment','getMessageOptions','keys','lgpdLink','fromAudioFileOutput','BEGIN:','apiKey','templateMessage','slice','20DuHpBD','9929uGzCrV','../../models/CompaniesSettings','../../utils/logger',':\x20📞','sendPresenceUpdate','key','interactiveMessage','%2C','jpegThumbnail','contactMessage','EM_ANDAMENTO','composing','fourRowTemplate','.wav','contextInfo','complationMessage','‎*Assistente\x20Virtual*:\x0aInfelizmente\x20não\x20conseguimos\x20escutar\x20nem\x20enviar\x20áudios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.','rows','min','contactsArrayMessage','ticketId','\x20]*\x20-\x20','findOne','messages.upsert','../../queues','getMinutes','input','sticker','../../libs/cache','Error\x20getTypeMessage','isNaN','responses','-ticket','companyId','options','disabled','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posição\x20na\x20fila\x20de\x20atendimento\x20é:\x20*','g.us','instagram','messageContextInfo','maxUseBotQueues','Error\x20isValidMsg','/opt/homebrew/bin/ffmpeg','closeTicket','buttonText','scheduleType','chat','debounce','isValidMsg','existsSync','content','toISOString','fromMe','enabled','‎Opção\x20inválida,\x20tente\x20novamente.\x0a','info','typebot','\x20|\x20https://maps.google.com/maps?q=','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','100lUFcBb','fileList','path','randomValue','darwin','Erro\x20ao\x20baixar\x20media','selectedRowId','*[\x20','Erro\x20ao\x20baixar\x20mídia:','now','listResponseMessage','normalize','env','senderKeyDistributionMessage','messages','image','outOfHoursMessage','/usr/bin/ffmpeg','whatsapp','buffer','dialogflow','voiceRegion','documentMessage','get','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','s.whatsapp.net','createTranscription','maxUseBotQueuesNPS','hydratedFourRowTemplate','campaignQueue','downloadMedia','whatsappId','toString','recording','error','number','push','toFormat','temperature','writeFile','quotedMsg','forEach','assistant','../../models/Campaign','NFD','choices','SpeechConfig','./SendWhatsAppMessage','next','imported','protocolMessage','groupAsTicket','../QueueIntegrationServices/ShowQueueIntegrationService','lgpdMessage','encodedAudio','amountUsedBotQueues','pop','map','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','allowGroup','create','company','captureException','../QueueIntegrationServices/CreateSessionDialogflow','whisper-1','buttonsResponseMessage','7bit','endsWith','__esModule','buttonsMessage','maxTokens',':unreads','__importStar','projectName','\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','Error\x20handling\x20message\x20ack.\x20Err:\x20','split','No\x20result\x20from\x20synthesizer','chatBotType','90507xBmPUR','setFfmpegPath','test',':*\x20','hydratedTemplate','urlN8N','.ogg','presenceSubscribe','addLogs','downloadMediaMessage','promisify','messageStubType','body','\x20-\x20Longitude:\x20','getTypeMessage','../FileServices/ShowService','then','SpeechSynthesizer','isNil','status','greetingMessage','mediaType','quotedMessage','count','nps','delete','connection','win32','application/json','n8n','Error:\x20','text','amountUsedBotQueuesNPS','pushName','vcard','reload','parseToMilliseconds','chatbotAt','Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20já\x20não\x20esta\x20mais\x20disponível','name','verifyMessage','floor','createdAt','chatbots','../../helpers/addLogs','configurable','prompt','listMessage','data','6359538DmDqOr','substring','debug','singleSelectReply','findIndex','queues','length','../../models/Message','entrou\x20no\x20typebot','jidNormalizedUser','audioMessage','lgpdConsent'];a635_0x26a6=function(){return _0x20e682;};return a635_0x26a6();}exports['verifyMediaMessage']=verifyMediaMessage;const verifyMessage=async(_0x3dc09e,_0x44e314,_0x526ece,_0x158639,_0x5d1a2a,_0x334b69)=>{const _0x29b1c4=a635_0x4f3874,_0x36ac94=(0x0,socket_1[_0x29b1c4(0x127)])(),_0xf4b3f1=await verifyQuotedMessage(_0x3dc09e),_0x15711f=(0x0,exports[_0x29b1c4(0xd3)])(_0x3dc09e),_0x17bf71=_0x44e314[_0x29b1c4(0x1a5)],_0x552982={'wid':_0x3dc09e[_0x29b1c4(0x189)]['id'],'ticketId':_0x44e314['id'],'contactId':_0x3dc09e[_0x29b1c4(0x189)]['fromMe']?undefined:_0x526ece['id'],'body':_0x15711f,'fromMe':_0x3dc09e[_0x29b1c4(0x189)][_0x29b1c4(0x1b8)],'mediaType':getTypeMessage(_0x3dc09e),'read':_0x3dc09e[_0x29b1c4(0x189)][_0x29b1c4(0x1b8)],'quotedMsgId':_0xf4b3f1?.['id'],'ack':_0x3dc09e['status'],'remoteJid':_0x3dc09e[_0x29b1c4(0x189)][_0x29b1c4(0x14d)],'participant':_0x3dc09e['key']['participant'],'dataJson':JSON[_0x29b1c4(0x14e)](_0x3dc09e),'ticketTrakingId':_0x158639?.['id'],'isPrivate':![],'createdAt':new Date(Math['floor'](getTimestampMessage(_0x3dc09e[_0x29b1c4(0xba)])*0x3e8))[_0x29b1c4(0x1b7)](),'ticketImported':_0x44e314[_0x29b1c4(0x1f0)],'isForwarded':_0x334b69};await _0x44e314[_0x29b1c4(0x111)]({'lastMessage':_0x15711f}),await(0x0,CreateMessageService_1[_0x29b1c4(0xe2)])({'messageData':_0x552982,'companyId':_0x17bf71}),!_0x3dc09e['key'][_0x29b1c4(0x1b8)]&&_0x44e314[_0x29b1c4(0x222)]==='closed'&&(await _0x44e314[_0x29b1c4(0x111)]({'status':_0x29b1c4(0x144)}),await _0x44e314[_0x29b1c4(0x87)]({'include':[{'model':Queue_1[_0x29b1c4(0xe2)],'as':_0x29b1c4(0x10e)},{'model':User_1['default'],'as':'user'},{'model':Contact_1[_0x29b1c4(0xe2)],'as':'contact'},{'model':Whatsapp_1[_0x29b1c4(0xe2)],'as':_0x29b1c4(0x1d1)}]}),!_0x44e314[_0x29b1c4(0x1f0)]&&_0x36ac94['to'](_0x44e314[_0x29b1c4(0x222)])['to'](_0x44e314['id'][_0x29b1c4(0x1df)]())['emit'](_0x29b1c4(0xbd)+_0x17bf71+'-ticket',{'action':'update','ticket':_0x44e314,'ticketId':_0x44e314['id']}));};exports['verifyMessage']=verifyMessage;const isValidMsg=_0x3a9ef2=>{const _0x1cd54f=a635_0x4f3874;if(_0x3a9ef2[_0x1cd54f(0x189)][_0x1cd54f(0x14d)]==='status@broadcast')return![];try{const _0x1afabf=getTypeMessage(_0x3a9ef2);if(!_0x1afabf)return;const _0x1c9088=_0x1afabf===_0x1cd54f(0xff)||_0x1afabf==='extendedTextMessage'||_0x1afabf===_0x1cd54f(0x9f)||_0x1afabf===_0x1cd54f(0x13d)||_0x1afabf==='imageMessage'||_0x1afabf==='documentMessage'||_0x1afabf==='stickerMessage'||_0x1afabf===_0x1cd54f(0x200)||_0x1afabf==='buttonsMessage'||_0x1afabf===_0x1cd54f(0x1ab)||_0x1afabf===_0x1cd54f(0x163)||_0x1afabf===_0x1cd54f(0x110)||_0x1afabf===_0x1cd54f(0x18d)||_0x1afabf==='voiceMessage'||_0x1afabf===_0x1cd54f(0x168)||_0x1afabf===_0x1cd54f(0x197)||_0x1afabf===_0x1cd54f(0xad)||_0x1afabf===_0x1cd54f(0xe1)||_0x1afabf===_0x1cd54f(0x1f1)||_0x1afabf===_0x1cd54f(0x1c9)||_0x1afabf===_0x1cd54f(0x93)||_0x1afabf===_0x1cd54f(0x11d)||_0x1afabf===_0x1cd54f(0xd0)||_0x1afabf===_0x1cd54f(0xf4)||_0x1afabf==='editedMessage';return!_0x1c9088&&(logger_1[_0x1cd54f(0xab)][_0x1cd54f(0x15a)]('####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20'+_0x1afabf+'\x0a'+JSON[_0x1cd54f(0x14e)](_0x3a9ef2?.[_0x1cd54f(0x159)])),Sentry[_0x1cd54f(0x161)](_0x1cd54f(0xd4),{'BodyMsg':_0x3a9ef2[_0x1cd54f(0x159)],'msg':_0x3a9ef2,'msgType':_0x1afabf}),Sentry[_0x1cd54f(0x1fd)](new Error(_0x1cd54f(0x1d7)))),!!_0x1c9088;}catch(_0x46d8c2){Sentry[_0x1cd54f(0x161)](_0x1cd54f(0x1ad),{'msg':_0x3a9ef2}),Sentry[_0x1cd54f(0x1fd)](_0x46d8c2);}};exports['isValidMsg']=isValidMsg;const sendDialogflowAwswer=async(_0x35d858,_0x1b3901,_0x419c09,_0x3c9506,_0x1224bd,_0x79fe36,_0x210825)=>{const _0x4799fa=a635_0x4f3874,_0x11cdad=await(0x0,CreateSessionDialogflow_1[_0x4799fa(0x16f)])(_0x210825);if(_0x11cdad===undefined)return;_0x35d858[_0x4799fa(0x216)](_0x3c9506[_0x4799fa(0x14d)]),await(0x0,baileys_1[_0x4799fa(0x115)])(0x1f4);let _0x1eb764=await(0x0,QueryDialogflow_1['queryDialogFlow'])(_0x11cdad,_0x210825[_0x4799fa(0x208)],_0x3c9506[_0x4799fa(0x14d)],(0x0,exports[_0x4799fa(0xd3)])(_0x419c09),_0x210825[_0x4799fa(0xd1)],_0x1224bd);if(!_0x1eb764){_0x35d858[_0x4799fa(0x188)](_0x4799fa(0x18f),_0x3c9506[_0x4799fa(0x14d)]);const _0x39a3a4=(0x0,Mustache_1['default'])(_0x4799fa(0xec)+_0x210825?.[_0x4799fa(0x8b)]+_0x4799fa(0xcd));await(0x0,baileys_1[_0x4799fa(0x115)])(0x3e8),await _0x35d858[_0x4799fa(0x188)](_0x4799fa(0x122),_0x3c9506[_0x4799fa(0x14d)]);const _0xfa0cdc=await _0x35d858['sendMessage'](_0x3c9506[_0x4799fa(0x1e2)]+_0x4799fa(0xc2),{'text':_0x39a3a4});await(0x0,exports[_0x4799fa(0x8c)])(_0xfa0cdc,_0x1b3901,_0x3c9506);return;}_0x1eb764[_0x4799fa(0x112)]&&await _0x1b3901[_0x4799fa(0x111)]({'contactId':_0x1b3901[_0x4799fa(0x11a)]['id'][_0x4799fa(0x1df)](),'useIntegration':![]});const _0x387b03=_0x1eb764['parameters'][_0x4799fa(0x1ce)]?.[_0x4799fa(0xf7)]??undefined,_0x4fcc8b=_0x1eb764['parameters']['react']?.[_0x4799fa(0xf7)]??undefined,_0x144438=_0x1eb764[_0x4799fa(0x1f5)]['toString'](_0x4799fa(0x10d))??undefined;_0x35d858['sendPresenceUpdate'](_0x4799fa(0x18f),_0x3c9506['remoteJid']),await(0x0,baileys_1[_0x4799fa(0x115)])(0x1f4);let _0x105f55;for(let _0x3fc816 of _0x1eb764[_0x4799fa(0x1a3)]){_0x105f55=_0x3fc816[_0x4799fa(0x83)]['text'][0x0]?_0x3fc816[_0x4799fa(0x83)]['text'][0x0]:_0x105f55;}for(let _0x434762 of _0x1eb764[_0x4799fa(0x1a3)]){_0x434762[_0x4799fa(0x83)]&&await sendDelayedMessages(_0x35d858,_0x1b3901,_0x3c9506,_0x434762[_0x4799fa(0x83)][_0x4799fa(0x83)][0x0],_0x105f55,_0x144438,_0x210825);}};async function sendDelayedMessages(_0x4330bc,_0x17def2,_0x26a8f4,_0x1ce8e0,_0x33c372,_0x3929c8,_0x54f2b6){const _0x419f39=a635_0x4f3874,_0x184878=_0x17def2[_0x419f39(0x1a5)],_0x21d10c=await(0x0,ShowWhatsAppService_1[_0x419f39(0xe2)])(_0x4330bc['id'],_0x184878),_0x17bdc3=_0x21d10c[_0x419f39(0x140)][_0x419f39(0x153)](/[_*]/g,''),_0x42acfe=await _0x4330bc[_0x419f39(0x13c)](_0x26a8f4[_0x419f39(0x1e2)]+_0x419f39(0xc2),{'text':_0x419f39(0xec)+_0x54f2b6?.['name']+_0x419f39(0x212)+_0x1ce8e0});await(0x0,exports['verifyMessage'])(_0x42acfe,_0x17def2,_0x26a8f4);if(_0x1ce8e0!=_0x33c372)await(0x0,baileys_1[_0x419f39(0x115)])(0x1f4),_0x4330bc[_0x419f39(0x188)](_0x419f39(0x18f),_0x26a8f4[_0x419f39(0x14d)]);else _0x3929c8&&(_0x4330bc[_0x419f39(0x188)](_0x419f39(0x1e0),_0x26a8f4[_0x419f39(0x14d)]),await(0x0,baileys_1[_0x419f39(0x115)])(0x1f4),_0x17bdc3&&_0x1ce8e0[_0x419f39(0xcb)](_0x17bdc3)&&(await(0x0,baileys_1[_0x419f39(0x115)])(0x3e8),setTimeout(async()=>{const _0x48f17f=_0x419f39;await _0x17def2['update']({'contactId':_0x17def2[_0x48f17f(0x11a)]['id'][_0x48f17f(0x1df)](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1[_0x48f17f(0xe2)])({'ticketId':_0x17def2['id'],'ticketData':{'status':_0x48f17f(0x160)},'companyId':_0x184878});},0xbb8)));}const verifyQueue=async(_0x269a6a,_0x50f1c2,_0x331244,_0x5bbf87,_0x2e1e49,_0x34209f)=>{const _0x2bdb85=a635_0x4f3874,_0x126ce8=_0x331244[_0x2bdb85(0x1a5)],{queues:_0x4ead5a,greetingMessage:_0x13c0b9,maxUseBotQueues:_0x366888,timeUseBotQueues:_0x5b29f9}=await(0x0,ShowWhatsAppService_1['default'])(_0x269a6a['id'],_0x126ce8);let _0x54a723=![];_0x4ead5a[_0x2bdb85(0x9b)]===0x1&&(_0x54a723=_0x4ead5a[0x0]?.[_0x2bdb85(0x8f)][_0x2bdb85(0x9b)]>0x1);const _0x534ea4=_0x2e1e49['sendQueuePosition']===_0x2bdb85(0x1b9);if(_0x4ead5a[_0x2bdb85(0x9b)]===0x1&&!_0x54a723){const _0x5bb003=_0x2e1e49['sendGreetingMessageOneQueues']===_0x2bdb85(0x1b9)||![];if(!_0x50f1c2[_0x2bdb85(0x189)][_0x2bdb85(0x1b8)]&&!_0x331244[_0x2bdb85(0xb1)]&&_0x4ead5a[0x0][_0x2bdb85(0xb5)]){const _0x36ba73=await(0x0,ShowQueueIntegrationService_1['default'])(_0x4ead5a[0x0][_0x2bdb85(0xb5)],_0x126ce8);await(0x0,exports[_0x2bdb85(0x12e)])(_0x50f1c2,_0x269a6a,_0x126ce8,_0x36ba73,_0x331244),await _0x331244[_0x2bdb85(0x111)]({'useIntegration':!![],'integrationId':_0x36ba73['id']});}if(_0x13c0b9['length']>0x1&&_0x5bb003){const _0x53a9dd=(0x0,Mustache_1[_0x2bdb85(0xe2)])(''+_0x13c0b9,_0x331244);if(_0x331244[_0x2bdb85(0x1d1)][_0x2bdb85(0x17a)]!==null){const _0x55acae=path_1['default'][_0x2bdb85(0x108)](_0x2bdb85(0xe5),'company'+_0x126ce8,_0x331244[_0x2bdb85(0x1d1)][_0x2bdb85(0x17a)]),_0x24c2fa=_0x331244[_0x2bdb85(0x1d1)]['greetingMediaAttachment'],_0xb57ff=await(0x0,SendWhatsAppMedia_1[_0x2bdb85(0x17b)])(_0x24c2fa,_0x55acae,String(_0x126ce8),_0x53a9dd),_0x6d8ffb=(0x0,Debounce_1[_0x2bdb85(0x1b3)])(async()=>{const _0x14435d=_0x2bdb85,_0x3de2ea=await _0x269a6a[_0x14435d(0x13c)](_0x331244['contact'][_0x14435d(0x1e2)]+'@'+(_0x331244['isGroup']?_0x14435d(0x1a9):_0x14435d(0x1d8)),{..._0xb57ff});await(0x0,exports[_0x14435d(0x175)])(_0x3de2ea,_0x331244,_0x5bbf87,_0x34209f);},0x3e8,_0x331244['id']);_0x6d8ffb();}else await _0x269a6a[_0x2bdb85(0x13c)](_0x5bbf87[_0x2bdb85(0x1e2)]+'@'+(_0x331244[_0x2bdb85(0xb1)]?'g.us':_0x2bdb85(0x1d8)),{'text':_0x53a9dd});}if(!(0x0,lodash_1[_0x2bdb85(0x221)])(_0x4ead5a[0x0][_0x2bdb85(0xce)]))try{const _0x2db30d=path_1[_0x2bdb85(0xe2)][_0x2bdb85(0x108)](__dirname,'..','..','..',_0x2bdb85(0xe5)),_0x5058af=await(0x0,ShowService_1[_0x2bdb85(0xe2)])(_0x4ead5a[0x0][_0x2bdb85(0xce)],_0x331244[_0x2bdb85(0x1a5)]),_0x32e22b=path_1[_0x2bdb85(0xe2)][_0x2bdb85(0x108)](_0x2db30d,_0x2bdb85(0x1fc)+_0x331244[_0x2bdb85(0x1a5)],_0x2bdb85(0x1c0),String(_0x5058af['id']));for(const [_0xd1bae6,_0x1b30c2]of _0x5058af[_0x2bdb85(0x1a6)]['entries']()){const _0x26d889={'fieldname':'medias','originalname':_0x1b30c2[_0x2bdb85(0x1c1)],'encoding':_0x2bdb85(0x201),'mimetype':_0x1b30c2['mediaType'],'filename':_0x1b30c2[_0x2bdb85(0x1c1)],'path':path_1[_0x2bdb85(0xe2)][_0x2bdb85(0x108)](_0x32e22b,_0x1b30c2[_0x2bdb85(0x1c1)])};await(0x0,SendWhatsAppMedia_1[_0x2bdb85(0xe2)])({'media':_0x26d889,'ticket':_0x331244,'body':_0x1b30c2[_0x2bdb85(0x8b)],'isPrivate':![],'isForwarded':![]});};}catch(_0x1388d7){logger_1[_0x2bdb85(0xab)][_0x2bdb85(0x1bb)](_0x1388d7);}if(_0x4ead5a[0x0][_0x2bdb85(0x1af)]){await(0x0,UpdateTicketService_1[_0x2bdb85(0xe2)])({'ticketData':{'status':_0x2bdb85(0x160),'queueId':_0x4ead5a[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x331244['id'],'companyId':_0x126ce8});return;}else await(0x0,UpdateTicketService_1[_0x2bdb85(0xe2)])({'ticketData':{'queueId':_0x4ead5a[0x0]['id']},'ticketId':_0x331244['id'],'companyId':_0x126ce8});const _0x25ef72=await Ticket_1[_0x2bdb85(0xe2)][_0x2bdb85(0xfb)]({'where':{'userId':null,'status':_0x2bdb85(0x144),'companyId':_0x126ce8,'queueId':_0x4ead5a[0x0]['id'],'isGroup':![]}});if(_0x534ea4){const _0xa56538=_0x25ef72[_0x2bdb85(0x7b)]===0x0?0x1:_0x25ef72[_0x2bdb85(0x7b)],_0x2eb362=_0x2bdb85(0x1a8)+_0xa56538+'*',_0x1c1c1c=(0x0,Mustache_1['default'])(''+_0x2eb362,_0x331244),_0x13bf2e=(0x0,Debounce_1[_0x2bdb85(0x1b3)])(async()=>{const _0x113862=_0x2bdb85;await _0x269a6a[_0x113862(0x13c)](_0x5bbf87[_0x113862(0x1e2)]+'@'+(_0x331244['isGroup']?_0x113862(0x1a9):'s.whatsapp.net'),{'text':_0x1c1c1c});},0xbb8,_0x331244['id']);_0x13bf2e();}return;}if(_0x5bbf87[_0x2bdb85(0xe8)])return;let _0x21bda7='';if(_0x331244[_0x2bdb85(0x222)]!==_0x2bdb85(0x117))_0x21bda7=_0x50f1c2?.[_0x2bdb85(0x159)]?.['buttonsResponseMessage']?.['selectedButtonId']||_0x50f1c2?.['message']?.[_0x2bdb85(0x1c9)]?.[_0x2bdb85(0x98)]['selectedRowId']||(0x0,exports[_0x2bdb85(0xd3)])(_0x50f1c2);else{if(!(0x0,lodash_1[_0x2bdb85(0x221)])(_0x331244[_0x2bdb85(0xb2)]))await _0x331244[_0x2bdb85(0x111)]({'status':'pending'});await _0x331244[_0x2bdb85(0x87)]();}if(_0x21bda7['toLocaleLowerCase']()==_0x2bdb85(0x134)){const _0x30c945={'isBot':![],'status':'closed','sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x2bdb85(0xe2)])({'ticketData':_0x30c945,'ticketId':_0x331244['id'],'companyId':_0x126ce8});return;}let _0x26489d=_0x54a723&&_0x4ead5a[_0x2bdb85(0x9b)]===0x1?_0x4ead5a[+_0x21bda7]:_0x4ead5a[+_0x21bda7-0x1];const _0x51d5ec=_0x2e1e49?.[_0x2bdb85(0x20e)]||_0x2bdb85(0x83);let _0x24def6;if(_0x26489d)try{const _0x13532d=await(0x0,ListUserQueueServices_1['default'])(_0x26489d['id']);_0x13532d[_0x2bdb85(0xe6)]>-0x1&&(_0x24def6=_0x13532d[_0x2bdb85(0xe6)]);}catch(_0x55c8b9){console[_0x2bdb85(0x1e1)](_0x55c8b9);}const _0x505f0d=async()=>{const _0x5ba3d6=_0x2bdb85;if(_0x26489d||_0x4ead5a['length']===0x1&&_0x54a723){if(_0x4ead5a[_0x5ba3d6(0x9b)]===0x1)_0x26489d=_0x4ead5a[0x0];const _0x3493bb=await Queue_1[_0x5ba3d6(0xe2)][_0x5ba3d6(0x132)](_0x26489d['id']);let _0x1c04ae;_0x2e1e49?.[_0x5ba3d6(0x1b1)]==='queue'&&(_0x1c04ae=await(0x0,VerifyCurrentSchedule_1[_0x5ba3d6(0xe2)])(_0x126ce8,_0x3493bb['id'],0x0));if(_0x2e1e49?.[_0x5ba3d6(0x1b1)]==='queue'&&!(0x0,lodash_1['isNil'])(_0x1c04ae)&&(!_0x1c04ae||_0x1c04ae['inActivity']===![])&&(!_0x331244[_0x5ba3d6(0xb1)]||_0x331244[_0x5ba3d6(0x1d1)]?.[_0x5ba3d6(0x1f2)]===_0x5ba3d6(0x1b9))){const _0x5b02e7=_0x3493bb[_0x5ba3d6(0x1cf)];if(_0x5b02e7!==''){const _0x4df509=(0x0,Mustache_1[_0x5ba3d6(0xe2)])(''+_0x5b02e7,_0x331244),_0x5cb682=(0x0,Debounce_1[_0x5ba3d6(0x1b3)])(async()=>{const _0x428d52=_0x5ba3d6;await _0x269a6a[_0x428d52(0x13c)](_0x331244[_0x428d52(0x11a)][_0x428d52(0x1e2)]+'@'+(_0x331244[_0x428d52(0xb1)]?_0x428d52(0x1a9):'s.whatsapp.net'),{'text':_0x4df509});},0x3e8,_0x331244['id']);_0x5cb682(),await _0x331244['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x331244['amountUsedBotQueues']+0x1});return;}await _0x331244[_0x5ba3d6(0x111)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x331244[_0x5ba3d6(0x1f6)]+0x1});return;}await(0x0,UpdateTicketService_1[_0x5ba3d6(0xe2)])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x26489d['id']},'ticketId':_0x331244['id'],'companyId':_0x126ce8});if(_0x26489d[_0x5ba3d6(0x8f)][_0x5ba3d6(0x9b)]>0x0&&!_0x331244[_0x5ba3d6(0xb1)]){let _0x45f1d0='';_0x26489d['chatbots'][_0x5ba3d6(0x1e8)]((_0x259123,_0x58f165)=>{const _0x111c9d=_0x5ba3d6;_0x45f1d0+=_0x111c9d(0x1c6)+(_0x58f165+0x1)+_0x111c9d(0x199)+_0x259123[_0x111c9d(0x8b)]+'\x0a';});const _0x5ecab0=(0x0,Mustache_1[_0x5ba3d6(0xe2)])('‎\x20'+_0x26489d[_0x5ba3d6(0x223)]+'\x0a\x0a'+_0x45f1d0+_0x5ba3d6(0x209),_0x331244),_0x51d46f=await _0x269a6a[_0x5ba3d6(0x13c)](_0x5bbf87[_0x5ba3d6(0x1e2)]+'@'+(_0x331244[_0x5ba3d6(0xb1)]?_0x5ba3d6(0x1a9):_0x5ba3d6(0x1d8)),{'text':_0x5ecab0});await(0x0,exports[_0x5ba3d6(0x8c)])(_0x51d46f,_0x331244,_0x5bbf87,_0x34209f),_0x2e1e49?.['settingsUserRandom']===_0x5ba3d6(0x1b9)&&await(0x0,UpdateTicketService_1[_0x5ba3d6(0xe2)])({'ticketData':{'userId':_0x24def6},'ticketId':_0x331244['id'],'companyId':_0x126ce8});}if(!_0x26489d['chatbots'][_0x5ba3d6(0x9b)]&&_0x26489d[_0x5ba3d6(0x223)][_0x5ba3d6(0x9b)]!==0x0){const _0x484da3=(0x0,Mustache_1[_0x5ba3d6(0xe2)])('‎'+_0x26489d[_0x5ba3d6(0x223)],_0x331244),_0x1a199c=await _0x269a6a[_0x5ba3d6(0x13c)](_0x5bbf87['number']+'@'+(_0x331244[_0x5ba3d6(0xb1)]?_0x5ba3d6(0x1a9):_0x5ba3d6(0x1d8)),{'text':_0x484da3});await(0x0,exports['verifyMessage'])(_0x1a199c,_0x331244,_0x5bbf87,_0x34209f);}if(!_0x50f1c2[_0x5ba3d6(0x189)][_0x5ba3d6(0x1b8)]&&!_0x331244['isGroup']&&_0x26489d?.['integrationId']){const _0x248d03=await(0x0,ShowQueueIntegrationService_1[_0x5ba3d6(0xe2)])(_0x26489d[_0x5ba3d6(0xb5)],_0x126ce8);await(0x0,exports[_0x5ba3d6(0x12e)])(_0x50f1c2,_0x269a6a,_0x126ce8,_0x248d03,_0x331244),await _0x331244['update']({'useIntegration':!![],'integrationId':_0x26489d[_0x5ba3d6(0xb5)]});}if(!(0x0,lodash_1['isNil'])(_0x26489d[_0x5ba3d6(0xce)]))try{const _0x1f4377=path_1[_0x5ba3d6(0xe2)][_0x5ba3d6(0x108)](__dirname,'..','..','..',_0x5ba3d6(0xe5)),_0xd531e=await(0x0,ShowService_1[_0x5ba3d6(0xe2)])(_0x26489d['fileListId'],_0x331244['companyId']),_0xf36977=path_1[_0x5ba3d6(0xe2)]['resolve'](_0x1f4377,_0x5ba3d6(0x1fc)+_0x331244['companyId'],'fileList',String(_0xd531e['id']));for(const [_0x42c96d,_0x5c0f78]of _0xd531e[_0x5ba3d6(0x1a6)][_0x5ba3d6(0x139)]()){const _0x24c093={'fieldname':_0x5ba3d6(0x12d),'originalname':_0x5c0f78['path'],'encoding':_0x5ba3d6(0x201),'mimetype':_0x5c0f78[_0x5ba3d6(0x79)],'filename':_0x5c0f78[_0x5ba3d6(0x1c1)],'path':path_1['default'][_0x5ba3d6(0x108)](_0xf36977,_0x5c0f78[_0x5ba3d6(0x1c1)])},_0xc3cadd=await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x24c093,'ticket':_0x331244,'body':'‎\x20'+_0x5c0f78[_0x5ba3d6(0x8b)],'isPrivate':![],'isForwarded':![]});await(0x0,exports[_0x5ba3d6(0x175)])(_0xc3cadd,_0x331244,_0x331244[_0x5ba3d6(0x11a)],_0x34209f,![]);};await(0x0,baileys_1[_0x5ba3d6(0x115)])(0x7d0);}catch(_0x6d82e){logger_1[_0x5ba3d6(0xab)]['info'](_0x6d82e);}if(_0x26489d[_0x5ba3d6(0x1af)]){await(0x0,UpdateTicketService_1[_0x5ba3d6(0xe2)])({'ticketData':{'status':_0x5ba3d6(0x160),'queueId':_0x26489d['id'],'sendFarewellMessage':![]},'ticketId':_0x331244['id'],'companyId':_0x126ce8}),await(0x0,CreateLogTicketService_1[_0x5ba3d6(0xe2)])({'ticketId':_0x331244['id'],'type':_0x5ba3d6(0x160),'queueId':_0x26489d['id']});return;}const _0x56c925=await Ticket_1[_0x5ba3d6(0xe2)][_0x5ba3d6(0xfb)]({'where':{'userId':null,'status':_0x5ba3d6(0x144),'companyId':_0x126ce8,'queueId':_0x26489d['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1[_0x5ba3d6(0xe2)])({'ticketId':_0x331244['id'],'type':_0x5ba3d6(0x10e),'queueId':_0x26489d['id']});if(_0x534ea4&&!_0x26489d['chatbots'][_0x5ba3d6(0x9b)]){const _0x3da390=_0x56c925['count']===0x0?0x1:_0x56c925[_0x5ba3d6(0x7b)],_0x121633=_0x5ba3d6(0x1a8)+_0x3da390+'*',_0x5575af=(0x0,Mustache_1[_0x5ba3d6(0xe2)])(''+_0x121633,_0x331244),_0x1faa09=(0x0,Debounce_1[_0x5ba3d6(0x1b3)])(async()=>{const _0x244a14=_0x5ba3d6;await _0x269a6a[_0x244a14(0x13c)](_0x5bbf87['number']+'@'+(_0x331244[_0x244a14(0xb1)]?_0x244a14(0x1a9):_0x244a14(0x1d8)),{'text':_0x5575af});},0xbb8,_0x331244['id']);_0x1faa09();}}else{if(_0x331244[_0x5ba3d6(0xb1)])return;if(_0x366888&&_0x366888!==0x0&&_0x331244[_0x5ba3d6(0x1f6)]>=_0x366888)return;const _0x12d6cf=await(0x0,FindOrCreateATicketTrakingService_1[_0x5ba3d6(0xe2)])({'ticketId':_0x331244['id'],'companyId':_0x126ce8});let _0x1adb1a=new Date(),_0x3ed0f6=new Date();if(_0x12d6cf[_0x5ba3d6(0x89)]!==null){_0x1adb1a[_0x5ba3d6(0xdb)](_0x12d6cf[_0x5ba3d6(0x89)][_0x5ba3d6(0x19d)]()+Number(_0x5b29f9));if(_0x12d6cf['chatbotAt']!==null&&_0x3ed0f6<_0x1adb1a&&_0x5b29f9!=='0'&&_0x331244['amountUsedBotQueues']!==0x0)return;}await _0x12d6cf[_0x5ba3d6(0x111)]({'chatbotAt':null}),_0x269a6a['presenceSubscribe'](_0x5bbf87['remoteJid']);let _0x14277c='';_0x269a6a['sendPresenceUpdate']('composing',_0x5bbf87[_0x5ba3d6(0x14d)]),_0x4ead5a[_0x5ba3d6(0x1e8)]((_0x56de41,_0x4ecd95)=>{const _0x508b9c=_0x5ba3d6;_0x14277c+=_0x508b9c(0x1c6)+(_0x4ecd95+0x1)+_0x508b9c(0x199)+_0x56de41[_0x508b9c(0x8b)]+'\x0a';}),_0x14277c+=_0x5ba3d6(0x128);const _0x7e78b=(0x0,Mustache_1[_0x5ba3d6(0xe2)])('‎'+_0x13c0b9+'\x0a\x0a'+_0x14277c,_0x331244);await(0x0,CreateLogTicketService_1[_0x5ba3d6(0xe2)])({'ticketId':_0x331244['id'],'type':_0x5ba3d6(0xbe)}),await(0x0,baileys_1['delay'])(0x3e8),await _0x269a6a['sendPresenceUpdate']('paused',_0x5bbf87['remoteJid']);if(_0x331244['whatsapp'][_0x5ba3d6(0x17a)]!==null){const _0x494b6b=path_1[_0x5ba3d6(0xe2)][_0x5ba3d6(0x108)]('public','company'+_0x126ce8,_0x331244['whatsapp']['greetingMediaAttachment']),_0x1225aa=_0x331244[_0x5ba3d6(0x1d1)][_0x5ba3d6(0x17a)],_0x32ea1f=await(0x0,SendWhatsAppMedia_1[_0x5ba3d6(0x17b)])(_0x1225aa,_0x494b6b,String(_0x126ce8),_0x7e78b),_0x20ced1=(0x0,Debounce_1[_0x5ba3d6(0x1b3)])(async()=>{const _0x15e316=_0x5ba3d6;let _0x5dfcd5=await _0x269a6a[_0x15e316(0x13c)](_0x331244['contact']['number']+'@'+(_0x331244['isGroup']?'g.us':_0x15e316(0x1d8)),{..._0x32ea1f});await(0x0,exports[_0x15e316(0x175)])(_0x5dfcd5,_0x331244,_0x5bbf87,_0x12d6cf);},0x3e8,_0x331244['id']);_0x20ced1(),await(0x0,UpdateTicketService_1[_0x5ba3d6(0xe2)])({'ticketData':{'amountUsedBotQueues':_0x331244['amountUsedBotQueues']+0x1},'ticketId':_0x331244['id'],'companyId':_0x126ce8});return;}else{const _0x4b6c64=(0x0,Debounce_1[_0x5ba3d6(0x1b3)])(async()=>{const _0x3911ea=_0x5ba3d6,_0x50941a=await _0x269a6a[_0x3911ea(0x13c)](_0x5bbf87['number']+'@'+(_0x331244[_0x3911ea(0xb1)]?_0x3911ea(0x1a9):_0x3911ea(0x1d8)),{'text':_0x7e78b});(0x0,exports[_0x3911ea(0x8c)])(_0x50941a,_0x331244,_0x5bbf87,_0x12d6cf);},0x3e8,_0x331244['id']);await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':_0x331244['amountUsedBotQueues']+0x1},'ticketId':_0x331244['id'],'companyId':_0x126ce8}),_0x4b6c64();}}};if(_0x51d5ec===_0x2bdb85(0x83))return _0x505f0d();if(_0x51d5ec==='button'&&_0x4ead5a[_0x2bdb85(0x9b)]>0x3)return _0x505f0d();},verifyRating=_0x322676=>{const _0x5e0e3c=a635_0x4f3874;if(_0x322676&&_0x322676[_0x5e0e3c(0x135)]===null&&_0x322676['closedAt']!==null&&_0x322676['userId']!==null&&_0x322676[_0x5e0e3c(0x15b)]===null)return!![];return![];};exports[a635_0x4f3874(0x13a)]=verifyRating;const handleRating=async(_0x370c0e,_0x439b36,_0x28c857)=>{const _0x23fc37=a635_0x4f3874,_0x19ed9d=(0x0,socket_1[_0x23fc37(0x127)])(),_0x5f49a8=_0x439b36['companyId'],{complationMessage:_0x16e635}=await(0x0,ShowWhatsAppService_1[_0x23fc37(0xe2)])(_0x439b36[_0x23fc37(0x1de)],_0x5f49a8);let _0xbae81d=_0x370c0e;_0x370c0e<0x0&&(_0xbae81d=0x0);_0x370c0e>0xa&&(_0xbae81d=0xa);await UserRating_1[_0x23fc37(0xe2)][_0x23fc37(0x1fb)]({'ticketId':_0x28c857[_0x23fc37(0x198)],'companyId':_0x28c857['companyId'],'userId':_0x28c857['userId'],'rate':_0xbae81d});if(!(0x0,lodash_1[_0x23fc37(0x221)])(_0x16e635)&&_0x16e635!==''&&!_0x439b36['isGroup']){const _0x451c3c=(0x0,Mustache_1[_0x23fc37(0xe2)])('‎'+_0x16e635,_0x439b36);if(_0x439b36[_0x23fc37(0x16d)]==='whatsapp'){const _0x437853=await(0x0,SendWhatsAppMessage_1[_0x23fc37(0xe2)])({'body':_0x451c3c,'ticket':_0x439b36});await(0x0,exports['verifyMessage'])(_0x437853,_0x439b36,_0x439b36[_0x23fc37(0x11a)],_0x28c857);}['facebook',_0x23fc37(0x1aa)][_0x23fc37(0xcb)](_0x439b36[_0x23fc37(0x16d)])&&await(0x0,sendFacebookMessage_1[_0x23fc37(0xe2)])({'body':_0x451c3c,'ticket':_0x439b36});}await _0x439b36[_0x23fc37(0x111)]({'chatbot':null,'status':_0x23fc37(0x160),'amountUsedBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1['default'])({'userId':_0x439b36[_0x23fc37(0xe6)],'queueId':_0x439b36[_0x23fc37(0xe3)],'ticketId':_0x439b36['id'],'type':_0x23fc37(0x160)}),_0x19ed9d['to']('open')['emit'](_0x23fc37(0xbd)+_0x5f49a8+'-ticket',{'action':_0x23fc37(0x7d),'ticket':_0x439b36,'ticketId':_0x439b36['id']}),_0x19ed9d['to'](_0x439b36[_0x23fc37(0x222)])['to'](_0x439b36['id'][_0x23fc37(0x1df)]())[_0x23fc37(0x143)](_0x23fc37(0xbd)+_0x5f49a8+_0x23fc37(0x1a4),{'action':_0x23fc37(0x111),'ticket':_0x439b36,'ticketId':_0x439b36['id']});};exports['handleRating']=handleRating;const sanitizeName=_0x4733db=>{const _0x59fb6f=a635_0x4f3874;let _0x19ddfa=_0x4733db[_0x59fb6f(0x20c)]('\x20')[0x0];return _0x19ddfa=_0x19ddfa[_0x59fb6f(0x153)](/[^a-zA-Z0-9]/g,''),_0x19ddfa[_0x59fb6f(0x96)](0x0,0x3c);},deleteFileSync=_0x5742ea=>{const _0x223bcd=a635_0x4f3874;try{fs_2[_0x223bcd(0xe2)][_0x223bcd(0x114)](_0x5742ea);}catch(_0x5bf145){console[_0x223bcd(0x1e1)](_0x223bcd(0x158),_0x5bf145);}},convertTextToSpeechAndSaveToFile=(_0x228ac9,_0x1bae70,_0x36e85f,_0xc46831,_0x597281=a635_0x4f3874(0x147),_0x5889c8=a635_0x4f3874(0x16b))=>{return new Promise((_0x2d4b16,_0x59899c)=>{const _0x167e0b=a635_0x4a1a,_0x4776b7=microsoft_cognitiveservices_speech_sdk_1[_0x167e0b(0x1ed)][_0x167e0b(0x106)](_0x36e85f,_0xc46831);_0x4776b7[_0x167e0b(0xa1)]=_0x597281;const _0x46e7ae=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x167e0b(0x17e)](_0x1bae70+_0x167e0b(0x191)),_0x2eabae=new microsoft_cognitiveservices_speech_sdk_1[(_0x167e0b(0x220))](_0x4776b7,_0x46e7ae);_0x2eabae[_0x167e0b(0xd6)](_0x228ac9,_0x238ae8=>{const _0x5f36aa=_0x167e0b;_0x238ae8?convertWavToAnotherFormat(_0x1bae70+_0x5f36aa(0x191),_0x1bae70+'.'+_0x5889c8,_0x5889c8)[_0x5f36aa(0x21f)](_0x5c8576=>{_0x2d4b16();})[_0x5f36aa(0x120)](_0x4522f6=>{console['error'](_0x4522f6),_0x59899c(_0x4522f6);}):_0x59899c(new Error(_0x5f36aa(0x20d))),_0x2eabae['close']();},_0x143db9=>{const _0x16d71d=_0x167e0b;console[_0x16d71d(0x1e1)](_0x16d71d(0x82)+_0x143db9),_0x2eabae['close'](),_0x59899c(_0x143db9);});});},convertWavToAnotherFormat=(_0x1b25d4,_0x3ffd38,_0x235d85)=>{return new Promise((_0x4221f5,_0x1fa17b)=>{const _0x310319=a635_0x4a1a;(0x0,fluent_ffmpeg_1[_0x310319(0xe2)])()[_0x310319(0x19e)](_0x1b25d4)[_0x310319(0x1e4)](_0x235d85)['on']('end',()=>_0x4221f5(_0x3ffd38))['on'](_0x310319(0x1e1),_0x539568=>_0x1fa17b(new Error(_0x310319(0x16e)+_0x539568[_0x310319(0x159)])))[_0x310319(0x12b)](_0x3ffd38);});},keepOnlySpecifiedChars=_0x24be30=>{const _0x6ae55=a635_0x4f3874;return _0x24be30[_0x6ae55(0x153)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x30a2e5,_0x1f7ebd,_0x1dc029,_0x4dcdc1,_0xc5e6df)=>{const _0x16728f=a635_0x4f3874,_0x5d437a=(0x0,exports['getBodyMessage'])(_0x30a2e5);if(!_0x5d437a)return;const {prompt:_0x4306c8}=await(0x0,ShowWhatsAppService_1[_0x16728f(0xe2)])(_0x1f7ebd['id'],_0x1dc029[_0x16728f(0x1a5)]);if(!_0x4306c8)return;if(_0x30a2e5[_0x16728f(0x21a)])return;const _0x28c5a3=path_1[_0x16728f(0xe2)]['resolve'](__dirname,'..','..','..',_0x16728f(0xe5),_0x16728f(0x1fc)+_0x1dc029[_0x16728f(0x1a5)]);let _0x4051af;const _0xc6afb4=sessionsOpenAi[_0x16728f(0x99)](_0x3b224e=>_0x3b224e['id']===_0x1f7ebd['id']);if(_0xc6afb4===-0x1){const _0x579b03=new openai_1[(_0x16728f(0xdf))]({'apiKey':_0x4306c8[_0x16728f(0x180)]});_0x4051af=new openai_1[(_0x16728f(0x15e))](_0x579b03),_0x4051af['id']=_0x1f7ebd['id'],sessionsOpenAi['push'](_0x4051af);}else _0x4051af=sessionsOpenAi[_0xc6afb4];const _0x99ec75=await Message_1[_0x16728f(0xe2)]['findAll']({'where':{'ticketId':_0x1dc029['id']},'order':[[_0x16728f(0x8e),_0x16728f(0xde)]],'limit':_0x4306c8['maxMessages']}),_0x3e5617=_0x16728f(0xbb)+sanitizeName(_0x4dcdc1[_0x16728f(0x8b)]||_0x16728f(0x166))+_0x16728f(0x1f9)+_0x4306c8[_0x16728f(0x205)]+_0x16728f(0x20a)+_0x4306c8[_0x16728f(0x92)]+'\x0a';let _0x361446=[];if(_0x30a2e5[_0x16728f(0x159)]?.[_0x16728f(0xff)]||_0x30a2e5[_0x16728f(0x159)]?.[_0x16728f(0x172)]?.[_0x16728f(0x83)]){_0x361446=[],_0x361446[_0x16728f(0x1e3)]({'role':_0x16728f(0x13b),'content':_0x3e5617});for(let _0x3f24fd=0x0;_0x3f24fd<Math[_0x16728f(0x196)](_0x4306c8[_0x16728f(0xd8)],_0x99ec75[_0x16728f(0x9b)]);_0x3f24fd++){const _0x1109ba=_0x99ec75[_0x3f24fd];_0x1109ba[_0x16728f(0x79)]===_0x16728f(0x1b2)&&(_0x1109ba[_0x16728f(0x1b8)]?_0x361446['push']({'role':'assistant','content':_0x1109ba[_0x16728f(0x21b)]}):_0x361446[_0x16728f(0x1e3)]({'role':_0x16728f(0x14c),'content':_0x1109ba['body']}));}_0x361446[_0x16728f(0x1e3)]({'role':'user','content':_0x5d437a});const _0x4971ef=await _0x4051af[_0x16728f(0xa8)]({'model':_0x16728f(0xbc),'messages':_0x361446,'max_tokens':_0x4306c8[_0x16728f(0x205)],'temperature':_0x4306c8[_0x16728f(0x1e5)]});let _0xeab724=_0x4971ef['data'][_0x16728f(0x1ec)][0x0][_0x16728f(0x159)]?.[_0x16728f(0x1b6)];_0xeab724?.[_0x16728f(0xcb)](_0x16728f(0x1be))&&(await transferQueue(_0x4306c8[_0x16728f(0xe3)],_0x1dc029,_0x4dcdc1),_0xeab724=_0xeab724[_0x16728f(0x153)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','')['trim']());if(_0x4306c8['voice']===_0x16728f(0x146)){const _0x17bff5=await _0x1f7ebd[_0x16728f(0x13c)](_0x30a2e5[_0x16728f(0x189)][_0x16728f(0x14d)],{'text':'‎\x20'+_0xeab724});await(0x0,exports[_0x16728f(0x8c)])(_0x17bff5,_0x1dc029,_0x4dcdc1);}else{const _0x10b63b=_0x1dc029['id']+'_'+Date[_0x16728f(0x1c8)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0xeab724),_0x28c5a3+'/'+_0x10b63b,_0x4306c8[_0x16728f(0xd7)],_0x4306c8['voiceRegion'],_0x4306c8[_0x16728f(0xaa)],'mp3')[_0x16728f(0x21f)](async()=>{const _0x5ac135=_0x16728f;try{const _0x58bdff=await _0x1f7ebd[_0x5ac135(0x13c)](_0x30a2e5[_0x5ac135(0x189)][_0x5ac135(0x14d)],{'audio':{'url':_0x28c5a3+'/'+_0x10b63b+_0x5ac135(0xeb)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports[_0x5ac135(0x175)])(_0x58bdff,_0x1dc029,_0x4dcdc1),deleteFileSync(_0x28c5a3+'/'+_0x10b63b+_0x5ac135(0xeb)),deleteFileSync(_0x28c5a3+'/'+_0x10b63b+_0x5ac135(0x191));}catch(_0x502768){console['log'](_0x5ac135(0x116)+_0x502768);}});}}else{if(_0x30a2e5[_0x16728f(0x159)]?.[_0x16728f(0x9f)]){const _0x236431=_0xc5e6df['mediaUrl'][_0x16728f(0x20c)]('/')[_0x16728f(0x1f7)](),_0x4afbbc=fs_2[_0x16728f(0xe2)][_0x16728f(0x14a)](_0x28c5a3+'/'+_0x236431),_0x39b3a7=await _0x4051af[_0x16728f(0x1d9)](_0x4afbbc,_0x16728f(0x1ff));_0x361446=[],_0x361446[_0x16728f(0x1e3)]({'role':'system','content':_0x3e5617});for(let _0x977cd1=0x0;_0x977cd1<Math['min'](_0x4306c8[_0x16728f(0xd8)],_0x99ec75['length']);_0x977cd1++){const _0x1eb537=_0x99ec75[_0x977cd1];_0x1eb537['mediaType']===_0x16728f(0x1b2)&&(_0x1eb537[_0x16728f(0x1b8)]?_0x361446[_0x16728f(0x1e3)]({'role':_0x16728f(0x1e9),'content':_0x1eb537[_0x16728f(0x21b)]}):_0x361446['push']({'role':'user','content':_0x1eb537[_0x16728f(0x21b)]}));}_0x361446[_0x16728f(0x1e3)]({'role':_0x16728f(0x14c),'content':_0x39b3a7[_0x16728f(0x94)][_0x16728f(0x83)]});const _0x4e2352=await _0x4051af[_0x16728f(0xa8)]({'model':_0x16728f(0xbc),'messages':_0x361446,'max_tokens':_0x4306c8['maxTokens'],'temperature':_0x4306c8[_0x16728f(0x1e5)]});let _0x5caa4a=_0x4e2352[_0x16728f(0x94)][_0x16728f(0x1ec)][0x0][_0x16728f(0x159)]?.[_0x16728f(0x1b6)];_0x5caa4a?.[_0x16728f(0xcb)](_0x16728f(0x1be))&&(await transferQueue(_0x4306c8[_0x16728f(0xe3)],_0x1dc029,_0x4dcdc1),_0x5caa4a=_0x5caa4a[_0x16728f(0x153)](_0x16728f(0x1be),'')[_0x16728f(0xcc)]());if(_0x4306c8[_0x16728f(0xaa)]===_0x16728f(0x146)){const _0x34de11=await _0x1f7ebd['sendMessage'](_0x30a2e5['key'][_0x16728f(0x14d)],{'text':'‎\x20'+_0x5caa4a});await(0x0,exports[_0x16728f(0x8c)])(_0x34de11,_0x1dc029,_0x4dcdc1);}else{const _0x565ff7=_0x1dc029['id']+'_'+Date[_0x16728f(0x1c8)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x5caa4a),_0x28c5a3+'/'+_0x565ff7,_0x4306c8['voiceKey'],_0x4306c8[_0x16728f(0x1d4)],_0x4306c8[_0x16728f(0xaa)],_0x16728f(0x16b))[_0x16728f(0x21f)](async()=>{const _0x33bf60=_0x16728f;try{const _0xa5ecd0=await _0x1f7ebd[_0x33bf60(0x13c)](_0x30a2e5[_0x33bf60(0x189)][_0x33bf60(0x14d)],{'audio':{'url':_0x28c5a3+'/'+_0x565ff7+_0x33bf60(0xeb)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports[_0x33bf60(0x175)])(_0xa5ecd0,_0x1dc029,_0x4dcdc1),deleteFileSync(_0x28c5a3+'/'+_0x565ff7+_0x33bf60(0xeb)),deleteFileSync(_0x28c5a3+'/'+_0x565ff7+_0x33bf60(0x191));}catch(_0x5d42f5){console[_0x33bf60(0xfa)]('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x5d42f5);}});}}}_0x361446=[];},transferQueue=async(_0x1a56e2,_0x2a9c6d,_0x443d07)=>{const _0x5610ac=a635_0x4f3874;await(0x0,UpdateTicketService_1[_0x5610ac(0xe2)])({'ticketData':{'queueId':_0x1a56e2},'ticketId':_0x2a9c6d['id'],'companyId':_0x2a9c6d[_0x5610ac(0x1a5)]});},handleMessageIntegration=async(_0x48bfd7,_0x5f4fa2,_0x29fcc1,_0x271aee,_0x1ad863)=>{const _0x6d3bd5=a635_0x4f3874,_0x25966c=getTypeMessage(_0x48bfd7);if(_0x271aee[_0x6d3bd5(0xcf)]===_0x6d3bd5(0x81)||_0x271aee['type']==='webhook'){if(_0x271aee?.['urlN8N']){const _0x12a0b2={'method':_0x6d3bd5(0x103),'url':_0x271aee?.[_0x6d3bd5(0x214)],'headers':{'Content-Type':_0x6d3bd5(0x80)},'json':_0x48bfd7};try{request(_0x12a0b2,function(_0xce418e,_0x514bad){const _0x2fbf83=_0x6d3bd5;if(_0xce418e)throw new Error(_0xce418e);else console[_0x2fbf83(0xfa)](_0x514bad[_0x2fbf83(0x21b)]);});}catch(_0x51ef9a){throw new Error(_0x51ef9a);}}}else{if(_0x271aee[_0x6d3bd5(0xcf)]===_0x6d3bd5(0x1d3)){let _0x102b86;if(_0x25966c===_0x6d3bd5(0x9f)){let _0x559e5a=_0x48bfd7[_0x6d3bd5(0xba)]+'.ogg';(0x0,fs_1['readFile'])((0x0,path_1[_0x6d3bd5(0x167)])(__dirname,'..','..','..',_0x6d3bd5(0xe5),_0x6d3bd5(0x1fc)+_0x29fcc1,_0x559e5a),'base64',(_0x5080db,_0x32f00f)=>{const _0x239f23=_0x6d3bd5;_0x102b86=_0x32f00f,_0x5080db&&logger_1[_0x239f23(0xab)][_0x239f23(0x1e1)](_0x5080db);});}else _0x102b86=undefined;const _0x3f8b8a=(0x0,Debounce_1['debounce'])(async()=>{const _0xe61d5f=_0x6d3bd5;await sendDialogflowAwswer(_0x5f4fa2,_0x1ad863,_0x48bfd7,_0x1ad863[_0xe61d5f(0x11a)],_0x102b86,_0x29fcc1,_0x271aee);},0x1f4,_0x1ad863['id']);_0x3f8b8a();}else _0x271aee[_0x6d3bd5(0xcf)]===_0x6d3bd5(0x1bc)&&(console[_0x6d3bd5(0xfa)](_0x6d3bd5(0x9d)),await(0x0,typebotListener_1['default'])({'ticket':_0x1ad863,'msg':_0x48bfd7,'wbot':_0x5f4fa2,'typebot':_0x271aee}));}};exports[a635_0x4f3874(0x12e)]=handleMessageIntegration;const handleMessage=async(_0x95b11,_0x37d318,_0x4d7e6d,_0x1db01d=![])=>{const _0x3d91a4=a635_0x4f3874;if(_0x1db01d){(0x0,addLogs_1[_0x3d91a4(0x217)])({'fileName':_0x3d91a4(0xc4)+_0x37d318['id']+'.txt','text':_0x3d91a4(0xc0)+JSON[_0x3d91a4(0x14e)](_0x95b11,null,0x2)+_0x3d91a4(0xda)});let _0x5b26a1=_0x95b11['key']['id'],_0x572665=await Message_1[_0x3d91a4(0xe2)]['findOne']({'where':{'wid':_0x5b26a1}});if(_0x572665){await new Promise(_0x4b42f1=>setTimeout(_0x4b42f1,0x96)),console['log'](_0x3d91a4(0x177));return;}else await new Promise(_0x454c11=>setTimeout(_0x454c11,parseInt(process[_0x3d91a4(0x1cb)]['TIMEOUT_TO_IMPORT_MESSAGE'])||0x14a));}else await new Promise(_0x30d249=>setTimeout(_0x30d249,i*0x28a)),i++;if(!isValidMsg(_0x95b11))return;try{let _0x235fb,_0x491b25,_0x5653ad=0x0,_0x364fa1=0x0,_0x27150b=0x0,_0x3268ca=(0x0,exports['getBodyMessage'])(_0x95b11);const _0x400dc6=getTypeMessage(_0x95b11);if(_0x400dc6===_0x3d91a4(0x1f1))return;const _0x5745f8=_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x15f)]||_0x95b11['message']?.[_0x3d91a4(0x9f)]||_0x95b11['message']?.[_0x3d91a4(0x13d)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x121)]||_0x95b11['message']?.[_0x3d91a4(0x1d5)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0xd0)]?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x1d5)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0xe1)]?.['message']?.['audioMessage']||_0x95b11['message']?.[_0x3d91a4(0xe1)]?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x1d5)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0xe1)]?.[_0x3d91a4(0x159)]?.['videoMessage']||_0x95b11['message']?.[_0x3d91a4(0xe1)]?.['message']?.['stickerMessage']||_0x95b11['message']?.[_0x3d91a4(0x11d)]?.[_0x3d91a4(0x159)]?.['imageMessage']||_0x95b11['message']?.['viewOnceMessage']?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x13d)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0xe1)]?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x11d)]?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x15f)]||_0x95b11['message']?.['ephemeralMessage']?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x11d)]?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x13d)]||_0x95b11[_0x3d91a4(0x159)]?.['ephemeralMessage']?.[_0x3d91a4(0x159)]?.['viewOnceMessage']?.['message']?.['audioMessage']||_0x95b11['message']?.[_0x3d91a4(0xe1)]?.[_0x3d91a4(0x159)]?.[_0x3d91a4(0x11d)]?.[_0x3d91a4(0x159)]?.['documentMessage']||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0xd0)]?.[_0x3d91a4(0x159)]?.['documentMessage']||_0x95b11[_0x3d91a4(0x159)]?.['templateMessage']?.[_0x3d91a4(0x213)]?.['imageMessage']||_0x95b11['message']?.[_0x3d91a4(0x181)]?.[_0x3d91a4(0x213)]?.[_0x3d91a4(0x1d5)]||_0x95b11['message']?.['templateMessage']?.[_0x3d91a4(0x213)]?.[_0x3d91a4(0x13d)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x181)]?.[_0x3d91a4(0x1db)]?.['imageMessage']||_0x95b11['message']?.[_0x3d91a4(0x181)]?.['hydratedFourRowTemplate']?.[_0x3d91a4(0x1d5)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x181)]?.['hydratedFourRowTemplate']?.[_0x3d91a4(0x13d)]||_0x95b11[_0x3d91a4(0x159)]?.['templateMessage']?.[_0x3d91a4(0x190)]?.[_0x3d91a4(0x15f)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x181)]?.[_0x3d91a4(0x190)]?.[_0x3d91a4(0x1d5)]||_0x95b11['message']?.[_0x3d91a4(0x181)]?.[_0x3d91a4(0x190)]?.[_0x3d91a4(0x13d)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x18a)]?.[_0x3d91a4(0xea)]?.[_0x3d91a4(0x15f)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x18a)]?.[_0x3d91a4(0xea)]?.[_0x3d91a4(0x1d5)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x18a)]?.[_0x3d91a4(0xea)]?.[_0x3d91a4(0x13d)];if(_0x95b11['key'][_0x3d91a4(0x1b8)]){if(/\u200e/[_0x3d91a4(0x211)](_0x3268ca))return;if(!_0x5745f8&&_0x400dc6!=='conversation'&&_0x400dc6!==_0x3d91a4(0x172)&&_0x400dc6!==_0x3d91a4(0x18d)&&_0x400dc6!=='reactionMessage'&&_0x400dc6!=='ephemeralMessage'&&_0x400dc6!==_0x3d91a4(0x1f1)&&_0x400dc6!=='viewOnceMessage'&&_0x400dc6!==_0x3d91a4(0xb8))return;_0x235fb=await getContactMessage(_0x95b11,_0x37d318);}else _0x235fb=await getContactMessage(_0x95b11,_0x37d318);const _0x51b908=_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x14d)]?.['endsWith'](_0x3d91a4(0x156)),_0x2dcc46=await(0x0,ShowWhatsAppService_1['default'])(_0x37d318['id'],_0x4d7e6d);if(!_0x2dcc46[_0x3d91a4(0x1fa)]&&_0x51b908)return;if(_0x51b908){const _0x10af0c=await _0x37d318[_0x3d91a4(0x100)](_0x95b11['key'][_0x3d91a4(0x14d)]),_0x198037={'id':_0x10af0c['id'],'name':_0x10af0c[_0x3d91a4(0x12f)]};_0x491b25=await verifyContact(_0x198037,_0x37d318,_0x4d7e6d);}const _0x30b46a=await verifyContact(_0x235fb,_0x37d318,_0x4d7e6d);let _0x1b0e5a=0x0;if(_0x95b11[_0x3d91a4(0x189)]['fromMe'])await cache_1[_0x3d91a4(0xe2)][_0x3d91a4(0x16a)](_0x3d91a4(0x13f)+_0x30b46a['id']+_0x3d91a4(0x206),'0');else{const _0x2e7a5f=await cache_1[_0x3d91a4(0xe2)]['get']('contacts:'+_0x30b46a['id']+_0x3d91a4(0x206));_0x1b0e5a=+_0x2e7a5f+0x1,await cache_1['default'][_0x3d91a4(0x16a)](_0x3d91a4(0x13f)+_0x30b46a['id']+_0x3d91a4(0x206),''+_0x1b0e5a);}const _0x243ab4=await CompaniesSettings_1[_0x3d91a4(0xe2)]['findOne']({'where':{'companyId':_0x4d7e6d}}),_0x1fdfc1=_0x243ab4['enableLGPD']===_0x3d91a4(0x1b9),{ticket:_0x140621}=await(0x0,FindOrCreateTicketService_1[_0x3d91a4(0xe2)])(_0x30b46a,_0x2dcc46,_0x1b0e5a,_0x4d7e6d,_0x5653ad,_0x27150b,_0x491b25,_0x3d91a4(0x1d1),_0x1db01d,![],_0x243ab4);if(_0x140621[_0x3d91a4(0x222)]===_0x3d91a4(0x160)||_0x1b0e5a===0x0&&_0x2dcc46[_0x3d91a4(0x193)]&&(0x0,Mustache_1[_0x3d91a4(0xe2)])(_0x2dcc46[_0x3d91a4(0x193)],_0x140621)===_0x3268ca)return;if(_0x400dc6==='editedMessage'){const _0x5a183a=_0x95b11[_0x3d91a4(0x159)][_0x3d91a4(0xb8)][_0x3d91a4(0x159)]['protocolMessage']['key']['id'],_0x823342=_0x95b11[_0x3d91a4(0x159)]['editedMessage']['message'][_0x3d91a4(0x1f1)][_0x3d91a4(0xb8)][_0x3d91a4(0xff)],_0x378add=(0x0,socket_1[_0x3d91a4(0x127)])();try{const _0x130a0b=await Message_1[_0x3d91a4(0xe2)][_0x3d91a4(0x19a)]({'where':{'wid':_0x5a183a,'companyId':_0x4d7e6d,'ticketId':_0x140621['id']}});if(!_0x130a0b)return;await _0x130a0b[_0x3d91a4(0x111)]({'isEdited':!![],'body':_0x823342}),await _0x140621['update']({'lastMessage':_0x823342}),_0x378add['to'](_0x130a0b['ticketId'][_0x3d91a4(0x1df)]())[_0x3d91a4(0x143)](_0x3d91a4(0xbd)+_0x130a0b['companyId']+'-appMessage',{'action':_0x3d91a4(0x111),'message':_0x130a0b});}catch(_0x19456f){Sentry[_0x3d91a4(0x1fd)](_0x19456f),logger_1[_0x3d91a4(0xab)][_0x3d91a4(0x1e1)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x19456f);}return;}const _0x3c8385=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x140621['id'],'companyId':_0x4d7e6d,'whatsappId':_0x2dcc46?.['id']});try{if(!_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x1b8)]){if(!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x2dcc46[_0x3d91a4(0x12a)]&&!_0x51b908)){const _0x26792e=(0x0,moment_1['default'])();if(_0x26792e[_0x3d91a4(0xa6)]((0x0,moment_1[_0x3d91a4(0xe2)])(_0x2dcc46[_0x3d91a4(0x150)]),(0x0,moment_1['default'])(_0x2dcc46[_0x3d91a4(0xa9)]))){_0x37d318[_0x3d91a4(0x13c)](_0x30b46a['remoteJid'],{'text':_0x2dcc46['collectiveVacationMessage']});return;}}if(_0x140621[_0x3d91a4(0x222)]===_0x3d91a4(0x7c)&&_0x3c8385!==null&&(0x0,exports[_0x3d91a4(0x13a)])(_0x3c8385)){_0x5745f8?await(0x0,exports[_0x3d91a4(0x175)])(_0x95b11,_0x140621,_0x30b46a):await(0x0,exports[_0x3d91a4(0x8c)])(_0x95b11,_0x140621,_0x30b46a,_0x3c8385);if(!isNaN(parseFloat(_0x3268ca))){(0x0,exports[_0x3d91a4(0x169)])(parseFloat(_0x3268ca),_0x140621,_0x3c8385),await _0x3c8385[_0x3d91a4(0x111)]({'ratingAt':(0x0,moment_1[_0x3d91a4(0xe2)])()[_0x3d91a4(0xf8)](),'finishedAt':(0x0,moment_1[_0x3d91a4(0xe2)])()[_0x3d91a4(0xf8)](),'rated':!![]});return;}else{if(_0x140621[_0x3d91a4(0x84)]<_0x2dcc46[_0x3d91a4(0x1da)]){let _0x58ff00=_0x3d91a4(0x1ba);const _0x2a9d6f=await _0x37d318[_0x3d91a4(0x13c)](_0x140621[_0x3d91a4(0x11a)][_0x3d91a4(0x1e2)]+'@'+(_0x140621[_0x3d91a4(0xb1)]?_0x3d91a4(0x1a9):'s.whatsapp.net'),{'text':_0x58ff00});(0x0,exports[_0x3d91a4(0x8c)])(_0x2a9d6f,_0x140621,_0x30b46a,_0x3c8385),await(0x0,baileys_1[_0x3d91a4(0x115)])(0x3e8);let _0x462fd8='‎'+_0x2dcc46['ratingMessage']+'\x0a';const _0x2515eb=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x462fd8,'ticket':_0x140621});await(0x0,exports[_0x3d91a4(0x8c)])(_0x2515eb,_0x140621,_0x140621[_0x3d91a4(0x11a)]),await _0x140621[_0x3d91a4(0x111)]({'amountUsedBotQueuesNPS':_0x140621[_0x3d91a4(0x84)]+0x1});}return;}}if(_0x1fdfc1&&_0x140621[_0x3d91a4(0x222)]===_0x3d91a4(0x117)&&!_0x1db01d){if((0x0,lodash_1[_0x3d91a4(0x221)])(_0x140621[_0x3d91a4(0xb2)])&&!(0x0,lodash_1['isNil'])(_0x140621[_0x3d91a4(0xc8)])){let _0x52a512=parseFloat(_0x3268ca);if(!Number[_0x3d91a4(0x1a2)](_0x52a512)&&Number[_0x3d91a4(0xc9)](_0x52a512)&&!(0x0,lodash_1[_0x3d91a4(0x129)])(_0x52a512)&&_0x52a512>0x0){if(_0x52a512===0x1)await _0x30b46a[_0x3d91a4(0x111)]({'lgpdAcceptedAt':(0x0,moment_1[_0x3d91a4(0xe2)])()[_0x3d91a4(0xf8)]()}),await _0x140621[_0x3d91a4(0x111)]({'lgpdAcceptedAt':(0x0,moment_1['default'])()[_0x3d91a4(0xf8)](),'amountUsedBotQueues':0x0});else{if(_0x52a512===0x2){if(_0x2dcc46[_0x3d91a4(0x193)]!==''&&_0x2dcc46[_0x3d91a4(0x193)]!==undefined){const _0x50667c=await _0x37d318['sendMessage'](_0x140621['contact'][_0x3d91a4(0x1e2)]+'@'+(_0x140621['isGroup']?_0x3d91a4(0x1a9):_0x3d91a4(0x1d8)),{'text':'‎'+_0x2dcc46[_0x3d91a4(0x193)]});(0x0,exports['verifyMessage'])(_0x50667c,_0x140621,_0x30b46a,_0x3c8385);}await _0x140621['update']({'status':_0x3d91a4(0x160),'amountUsedBotQueues':0x0}),await _0x3c8385['destroy'];return;}else _0x140621[_0x3d91a4(0x1f6)]<_0x2dcc46['maxUseBotQueues']&&_0x2dcc46[_0x3d91a4(0x1ac)]>0x0&&await _0x140621[_0x3d91a4(0x111)]({'amountUsedBotQueues':_0x140621[_0x3d91a4(0x1f6)]+0x1,'lgpdSendMessageAt':null});}}else _0x140621[_0x3d91a4(0x1f6)]<_0x2dcc46[_0x3d91a4(0x1ac)]&&_0x2dcc46['maxUseBotQueues']>0x0&&await _0x140621['update']({'amountUsedBotQueues':_0x140621['amountUsedBotQueues']+0x1,'lgpdSendMessageAt':null});}if((_0x30b46a['lgpdAcceptedAt']===null||_0x243ab4?.[_0x3d91a4(0xa0)]==='enabled')&&!_0x30b46a[_0x3d91a4(0xb1)]&&(0x0,lodash_1['isNil'])(_0x140621[_0x3d91a4(0xc8)])&&_0x140621[_0x3d91a4(0x1f6)]<=_0x2dcc46[_0x3d91a4(0x1ac)]&&!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x243ab4?.[_0x3d91a4(0x1f4)])){_0x5745f8?await(0x0,exports[_0x3d91a4(0x175)])(_0x95b11,_0x140621,_0x30b46a):await(0x0,exports[_0x3d91a4(0x8c)])(_0x95b11,_0x140621,_0x30b46a,_0x3c8385);if(!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x243ab4?.[_0x3d91a4(0x1f4)])&&_0x243ab4[_0x3d91a4(0x1f4)]!==''){const _0x16df71=(0x0,Mustache_1[_0x3d91a4(0xe2)])('‎'+_0x243ab4?.[_0x3d91a4(0x1f4)],_0x140621),_0x44d0c4=await _0x37d318['sendMessage'](_0x140621[_0x3d91a4(0x11a)][_0x3d91a4(0x1e2)]+'@'+(_0x140621[_0x3d91a4(0xb1)]?_0x3d91a4(0x1a9):_0x3d91a4(0x1d8)),{'text':_0x16df71});(0x0,exports['verifyMessage'])(_0x44d0c4,_0x140621,_0x30b46a,_0x3c8385);}await(0x0,baileys_1[_0x3d91a4(0x115)])(0x3e8);if(!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x243ab4?.[_0x3d91a4(0x17d)])&&_0x243ab4?.[_0x3d91a4(0x17d)]!==''){const _0x377b1d=(0x0,Mustache_1[_0x3d91a4(0xe2)])('‎'+_0x243ab4?.[_0x3d91a4(0x17d)],_0x140621),_0x106996=await _0x37d318[_0x3d91a4(0x13c)](_0x140621[_0x3d91a4(0x11a)][_0x3d91a4(0x1e2)]+'@'+(_0x140621['isGroup']?_0x3d91a4(0x1a9):_0x3d91a4(0x1d8)),{'text':_0x377b1d});await(0x0,exports['verifyMessage'])(_0x106996,_0x140621,_0x30b46a,_0x3c8385);};await(0x0,baileys_1[_0x3d91a4(0x115)])(0x3e8);const _0x5b13e4=(0x0,Mustache_1[_0x3d91a4(0xe2)])('‎Estou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20Não',_0x140621),_0x368afa=await _0x37d318[_0x3d91a4(0x13c)](_0x140621[_0x3d91a4(0x11a)][_0x3d91a4(0x1e2)]+'@'+(_0x140621[_0x3d91a4(0xb1)]?'g.us':_0x3d91a4(0x1d8)),{'text':_0x5b13e4});await(0x0,exports[_0x3d91a4(0x8c)])(_0x368afa,_0x140621,_0x30b46a,_0x3c8385),await _0x140621[_0x3d91a4(0x111)]({'lgpdSendMessageAt':(0x0,moment_1[_0x3d91a4(0xe2)])()[_0x3d91a4(0xf8)](),'amountUsedBotQueues':_0x140621[_0x3d91a4(0x1f6)]+0x1}),await _0x140621['reload']();return;};if(!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x140621[_0x3d91a4(0xc8)])&&(0x0,lodash_1['isNil'])(_0x140621[_0x3d91a4(0xb2)]))return;}}}catch(_0x274242){Sentry[_0x3d91a4(0x1fd)](_0x274242),console[_0x3d91a4(0xfa)](_0x274242);}const _0xefc89d=_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x172)]?.['contextInfo']?.[_0x3d91a4(0xfc)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x15f)]?.[_0x3d91a4(0x192)]?.[_0x3d91a4(0xfc)]||_0x95b11['message']?.['audioMessage']?.[_0x3d91a4(0x192)]?.[_0x3d91a4(0xfc)]||_0x95b11[_0x3d91a4(0x159)]?.[_0x3d91a4(0x13d)]?.[_0x3d91a4(0x192)]?.['isForwarded']||_0x95b11[_0x3d91a4(0x159)]?.['documentMessage']?.[_0x3d91a4(0x192)]?.[_0x3d91a4(0xfc)];let _0x257576;_0x5745f8?_0x257576=await(0x0,exports[_0x3d91a4(0x175)])(_0x95b11,_0x140621,_0x30b46a,_0x3c8385,_0xefc89d):await(0x0,exports[_0x3d91a4(0x8c)])(_0x95b11,_0x140621,_0x30b46a,_0x3c8385,![],_0xefc89d);try{await _0x140621[_0x3d91a4(0x111)]({'fromMe':_0x95b11[_0x3d91a4(0x189)]['fromMe']});}catch(_0x3a4ce6){Sentry['captureException'](_0x3a4ce6),console[_0x3d91a4(0xfa)](_0x3a4ce6);}let _0x19cfb4;if(_0x243ab4[_0x3d91a4(0x1b1)]===_0x3d91a4(0x1fc))_0x19cfb4=await(0x0,VerifyCurrentSchedule_1[_0x3d91a4(0xe2)])(_0x4d7e6d,0x0,0x0);else _0x243ab4[_0x3d91a4(0x1b1)]===_0x3d91a4(0x7e)&&(_0x19cfb4=await(0x0,VerifyCurrentSchedule_1[_0x3d91a4(0xe2)])(_0x4d7e6d,0x0,_0x2dcc46['id']));try{if(!_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x1b8)]&&_0x243ab4[_0x3d91a4(0x1b1)]&&(!_0x140621['isGroup']||_0x2dcc46['groupAsTicket']==='enabled')){if((_0x243ab4['scheduleType']===_0x3d91a4(0x1fc)||_0x243ab4[_0x3d91a4(0x1b1)]===_0x3d91a4(0x7e))&&!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x19cfb4)&&(!_0x19cfb4||_0x19cfb4['inActivity']===![])){_0x3c8385[_0x3d91a4(0x89)]===null&&await _0x3c8385['update']({'chatbotAt':(0x0,moment_1['default'])()[_0x3d91a4(0xf8)]()});if(_0x2dcc46[_0x3d91a4(0x1ac)]&&_0x2dcc46[_0x3d91a4(0x1ac)]!==0x0&&_0x140621[_0x3d91a4(0x1f6)]>=_0x2dcc46['maxUseBotQueues'])return;let _0x1aecbb=new Date(),_0x2076c0=new Date();if(_0x3c8385[_0x3d91a4(0x89)]!==null){_0x1aecbb[_0x3d91a4(0xdb)](_0x3c8385['chatbotAt']['getMinutes']()+Number(_0x2dcc46['timeUseBotQueues']));if(_0x3c8385[_0x3d91a4(0x89)]!==null&&_0x2076c0<_0x1aecbb&&_0x2dcc46[_0x3d91a4(0x118)]!=='0'&&_0x140621[_0x3d91a4(0x1f6)]!==0x0)return;}await _0x3c8385[_0x3d91a4(0x111)]({'chatbotAt':null});if(_0x2dcc46[_0x3d91a4(0x1cf)]!==''){const _0x1c703e=(0x0,Mustache_1['default'])(''+_0x2dcc46['outOfHoursMessage'],_0x140621),_0x112ee0=(0x0,Debounce_1[_0x3d91a4(0x1b3)])(async()=>{const _0x273162=_0x3d91a4;await _0x37d318[_0x273162(0x13c)](_0x140621[_0x273162(0x11a)][_0x273162(0x1e2)]+'@'+(_0x140621[_0x273162(0xb1)]?'g.us':_0x273162(0x1d8)),{'text':_0x1c703e});},0x3e8,_0x140621['id']);_0x112ee0(),await _0x140621[_0x3d91a4(0x111)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x140621[_0x3d91a4(0x1f6)]+0x1});return;}await _0x140621['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x140621[_0x3d91a4(0x1f6)]+0x1});return;}}}catch(_0x73ce6e){Sentry[_0x3d91a4(0x1fd)](_0x73ce6e),console['log'](_0x73ce6e);}!_0x140621[_0x3d91a4(0x1f0)]&&!_0x140621[_0x3d91a4(0x10e)]&&!_0x51b908&&!_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x1b8)]&&!_0x140621[_0x3d91a4(0xe6)]&&!(0x0,lodash_1['isNil'])(_0x2dcc46['promptId'])&&await handleOpenAi(_0x95b11,_0x37d318,_0x140621,_0x30b46a,_0x257576);if(!_0x140621[_0x3d91a4(0x1f0)]&&!_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x1b8)]&&!_0x140621[_0x3d91a4(0xb1)]&&!_0x140621[_0x3d91a4(0x10e)]&&!_0x140621['user']&&_0x140621['isBot']&&!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x2dcc46[_0x3d91a4(0xb5)])&&!_0x140621[_0x3d91a4(0xee)]){const _0x318e05=await(0x0,ShowQueueIntegrationService_1['default'])(_0x2dcc46['integrationId'],_0x4d7e6d);await(0x0,exports[_0x3d91a4(0x12e)])(_0x95b11,_0x37d318,_0x4d7e6d,_0x318e05,_0x140621);return;}if(!_0x140621[_0x3d91a4(0x1f0)]&&!_0x95b11[_0x3d91a4(0x189)]['fromMe']&&!_0x140621['isGroup']&&!_0x140621[_0x3d91a4(0xe6)]&&_0x140621[_0x3d91a4(0xb5)]&&_0x140621[_0x3d91a4(0xee)]){const _0x350fe7=await(0x0,ShowQueueIntegrationService_1[_0x3d91a4(0xe2)])(_0x140621[_0x3d91a4(0xb5)],_0x4d7e6d);await(0x0,exports[_0x3d91a4(0x12e)])(_0x95b11,_0x37d318,_0x4d7e6d,_0x350fe7,_0x140621);}!_0x140621[_0x3d91a4(0x1f0)]&&!_0x140621[_0x3d91a4(0x10e)]&&(!_0x140621['isGroup']||_0x2dcc46['groupAsTicket']===_0x3d91a4(0x1b9))&&!_0x95b11['key'][_0x3d91a4(0x1b8)]&&!_0x140621[_0x3d91a4(0xe6)]&&_0x2dcc46[_0x3d91a4(0x9a)][_0x3d91a4(0x9b)]>=0x1&&!_0x140621['useIntegration']&&(await verifyQueue(_0x37d318,_0x95b11,_0x140621,_0x30b46a,_0x243ab4),_0x3c8385[_0x3d91a4(0x89)]===null&&await _0x3c8385['update']({'chatbotAt':(0x0,moment_1['default'])()['toDate']()}));_0x140621['queueId']>0x0&&await _0x3c8385[_0x3d91a4(0x111)]({'queueId':_0x140621[_0x3d91a4(0xe3)]});if((getTypeMessage(_0x95b11)===_0x3d91a4(0x9f)||getTypeMessage(_0x95b11)===_0x3d91a4(0x13d))&&!_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x1b8)]&&(!_0x140621[_0x3d91a4(0xb1)]||_0x2dcc46[_0x3d91a4(0x1f2)]==='enabled')&&(!_0x30b46a?.[_0x3d91a4(0x171)]||_0x243ab4?.[_0x3d91a4(0x107)]===_0x3d91a4(0x1a7))){const _0x407c2e=await _0x37d318[_0x3d91a4(0x13c)](_0x30b46a[_0x3d91a4(0x1e2)]+_0x3d91a4(0xc2),{'text':_0x3d91a4(0x194)},{'quoted':{'key':_0x95b11[_0x3d91a4(0x189)],'message':{'extendedTextMessage':_0x95b11[_0x3d91a4(0x159)][_0x3d91a4(0x172)]}}});await(0x0,exports['verifyMessage'])(_0x407c2e,_0x140621,_0x30b46a,_0x3c8385);}try{if(!_0x95b11[_0x3d91a4(0x189)][_0x3d91a4(0x1b8)]&&_0x243ab4?.['scheduleType']&&_0x140621[_0x3d91a4(0xe3)]!==null&&(!_0x140621['isGroup']||_0x2dcc46[_0x3d91a4(0x1f2)]===_0x3d91a4(0x1b9))){const _0x568e35=await Queue_1['default'][_0x3d91a4(0x132)](_0x140621[_0x3d91a4(0xe3)]);_0x243ab4?.['scheduleType']==='queue'&&(_0x19cfb4=await(0x0,VerifyCurrentSchedule_1[_0x3d91a4(0xe2)])(_0x4d7e6d,_0x568e35['id'],0x0));if(_0x243ab4?.[_0x3d91a4(0x1b1)]===_0x3d91a4(0x10e)&&!(0x0,lodash_1[_0x3d91a4(0x221)])(_0x19cfb4)&&(!_0x19cfb4||_0x19cfb4[_0x3d91a4(0x174)]===![])){const _0x5bc076=_0x568e35['outOfHoursMessage'];if(_0x5bc076!==''){const _0x5bd859=(0x0,Mustache_1['default'])(''+_0x5bc076,_0x140621),_0x41ecf6=(0x0,Debounce_1[_0x3d91a4(0x1b3)])(async()=>{const _0x4390f9=_0x3d91a4;await _0x37d318[_0x4390f9(0x13c)](_0x140621[_0x4390f9(0x11a)][_0x4390f9(0x1e2)]+'@'+(_0x140621[_0x4390f9(0xb1)]?_0x4390f9(0x1a9):_0x4390f9(0x1d8)),{'text':_0x5bd859});},0x3e8,_0x140621['id']);_0x41ecf6(),await _0x140621[_0x3d91a4(0x111)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x140621['amountUsedBotQueues']+0x1});return;}await _0x140621['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x140621[_0x3d91a4(0x1f6)]+0x1});return;}}}catch(_0x372170){Sentry[_0x3d91a4(0x1fd)](_0x372170),console[_0x3d91a4(0xfa)](_0x372170);}_0x140621[_0x3d91a4(0x10e)]&&_0x140621['queueId']&&!_0x95b11['key']['fromMe']&&((!_0x140621[_0x3d91a4(0x14c)]||_0x140621['queue']?.[_0x3d91a4(0x8f)]?.[_0x3d91a4(0x9b)]>0x0)&&await(0x0,ChatBotListener_1[_0x3d91a4(0xca)])(_0x140621[_0x3d91a4(0xe3)],_0x37d318,_0x140621,_0x30b46a,_0x95b11),await _0x140621[_0x3d91a4(0x111)]({'sendInactiveMessage':![]})),await _0x140621[_0x3d91a4(0x87)]();}catch(_0x4b3215){Sentry[_0x3d91a4(0x1fd)](_0x4b3215),console[_0x3d91a4(0xfa)](_0x4b3215),logger_1['logger'][_0x3d91a4(0x1e1)](_0x3d91a4(0xf9)+_0x4b3215);}};exports[a635_0x4f3874(0x154)]=handleMessage;const handleMsgAck=async(_0x18640c,_0x494e45)=>{const _0x16feb1=a635_0x4f3874;await new Promise(_0x44d61f=>setTimeout(_0x44d61f,0x1f4));const _0x10d759=(0x0,socket_1['getIO'])();try{const _0x4029a1=await Message_1[_0x16feb1(0xe2)][_0x16feb1(0x19a)]({'where':{'wid':_0x18640c[_0x16feb1(0x189)]['id']},'include':[_0x16feb1(0x11a),{'model':Message_1['default'],'as':_0x16feb1(0x1e7),'include':[_0x16feb1(0x11a)]}]});if(!_0x4029a1)return;await _0x4029a1['update']({'ack':_0x494e45}),_0x10d759['to'](_0x4029a1[_0x16feb1(0x198)][_0x16feb1(0x1df)]())[_0x16feb1(0x143)]('company-'+_0x4029a1[_0x16feb1(0x1a5)]+_0x16feb1(0xa2),{'action':_0x16feb1(0x111),'message':_0x4029a1});}catch(_0x42d9d2){Sentry[_0x16feb1(0x1fd)](_0x42d9d2),logger_1['logger']['error'](_0x16feb1(0x20b)+_0x42d9d2);}},verifyRecentCampaign=async(_0x586de6,_0x3a9d60)=>{const _0x20f2b8=a635_0x4f3874;if(!isValidMsg(_0x586de6))return;if(!_0x586de6[_0x20f2b8(0x189)]['fromMe']){const _0x3627aa=_0x586de6[_0x20f2b8(0x189)][_0x20f2b8(0x14d)][_0x20f2b8(0x153)](/\D/g,''),_0x3f24b0=await Campaign_1[_0x20f2b8(0xe2)]['findAll']({'where':{'companyId':_0x3a9d60,'status':_0x20f2b8(0x18e),'confirmation':!![]}});if(_0x3f24b0){const _0x16ca12=_0x3f24b0['map'](_0x1f5f4b=>_0x1f5f4b['id']),_0x5cbd8c=await CampaignShipping_1['default'][_0x20f2b8(0x19a)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x16ca12},'number':_0x3627aa,'confirmation':null}});_0x5cbd8c&&(await _0x5cbd8c[_0x20f2b8(0x111)]({'confirmedAt':(0x0,moment_1[_0x20f2b8(0xe2)])(),'confirmation':!![]}),await queues_1[_0x20f2b8(0x1dc)]['add']('DispatchCampaign',{'campaignShippingId':_0x5cbd8c['id'],'campaignId':_0x5cbd8c[_0x20f2b8(0x136)]},{'delay':(0x0,queues_1[_0x20f2b8(0x88)])((0x0,queues_1[_0x20f2b8(0x1c2)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x3fe5f0,_0x594300,_0x19ebc8)=>{const _0x24ff6a=a635_0x4f3874;if(!isValidMsg(_0x3fe5f0))return;let _0x57a5ac;_0x57a5ac=await getContactMessage(_0x3fe5f0,_0x19ebc8);const _0x56d574=await verifyContact(_0x57a5ac,_0x19ebc8,_0x594300),_0x549445=(0x0,socket_1[_0x24ff6a(0x127)])(),_0x569176=await(0x0,exports[_0x24ff6a(0xd3)])(_0x3fe5f0),_0x5778a6=/\u200c/[_0x24ff6a(0x211)](_0x569176);if(_0x3fe5f0[_0x24ff6a(0x189)]['fromMe']&&_0x5778a6){const _0x4203d7=await Message_1[_0x24ff6a(0xe2)][_0x24ff6a(0x19a)]({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x3fe5f0[_0x24ff6a(0x189)]['id']},{'contactId':_0x56d574['id']}],'companyId':_0x594300}});if(!(0x0,lodash_1[_0x24ff6a(0x129)])(_0x4203d7)||!(0x0,lodash_1['isNil'])(_0x4203d7)||_0x4203d7!==null){const _0x5c2c6e=await Ticket_1['default']['findByPk'](_0x4203d7[_0x24ff6a(0x198)]);await _0x5c2c6e[_0x24ff6a(0x111)]({'status':_0x24ff6a(0x160),'amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x549445['to'](_0x24ff6a(0xf0))[_0x24ff6a(0x143)](_0x24ff6a(0xbd)+_0x594300+_0x24ff6a(0x1a4),{'action':_0x24ff6a(0x7d),'ticket':_0x5c2c6e,'ticketId':_0x5c2c6e['id']}),_0x549445['to'](_0x5c2c6e[_0x24ff6a(0x222)])['to'](_0x5c2c6e['id']['toString']())[_0x24ff6a(0x143)](_0x24ff6a(0xbd)+_0x594300+_0x24ff6a(0x1a4),{'action':'update','ticket':_0x5c2c6e,'ticketId':_0x5c2c6e['id']});}}},filterMessages=_0xccc2ec=>{const _0x4e1299=a635_0x4f3874;if(_0xccc2ec[_0x4e1299(0x159)]?.['protocolMessage'])return![];if([baileys_1[_0x4e1299(0x113)][_0x4e1299(0xe7)],baileys_1[_0x4e1299(0x113)]['E2E_DEVICE_CHANGED'],baileys_1[_0x4e1299(0x113)][_0x4e1299(0xc5)],baileys_1[_0x4e1299(0x113)][_0x4e1299(0xa7)]][_0x4e1299(0xcb)](_0xccc2ec['messageStubType']))return![];return!![];},wbotMessageListener=(_0x3e8fd3,_0x3170c7)=>{const _0x24f4e2=a635_0x4f3874;_0x3e8fd3['ev']['on'](_0x24f4e2(0x19b),async _0x5923cb=>{const _0x3508ba=_0x24f4e2,_0x5739ea=_0x5923cb[_0x3508ba(0x1cd)][_0x3508ba(0x162)](filterMessages)[_0x3508ba(0x1f8)](_0x82bb09=>_0x82bb09);if(!_0x5739ea)return;_0x5739ea[_0x3508ba(0x1e8)](async _0xb9ebf6=>{const _0x4d83d6=_0x3508ba,_0x360ccd=await Message_1[_0x4d83d6(0xe2)][_0x4d83d6(0x7b)]({'where':{'wid':_0xb9ebf6['key']['id'],'companyId':_0x3170c7}});if(!_0x360ccd){let _0x1fc487=![],_0x59d1e0=await(0x0,exports[_0x4d83d6(0xd3)])(_0xb9ebf6);const _0x9b77d7=_0xb9ebf6?.[_0x4d83d6(0x189)]?.[_0x4d83d6(0x1b8)];if(_0x9b77d7)_0x1fc487=/\u200c/[_0x4d83d6(0x211)](_0x59d1e0);else{if(/\u200c/['test'](_0x59d1e0))_0x59d1e0=_0x59d1e0[_0x4d83d6(0x153)](/\u200c/,'');logger_1[_0x4d83d6(0xab)][_0x4d83d6(0x97)](_0x4d83d6(0x101)+_0x59d1e0);}!_0x1fc487&&await handleMessage(_0xb9ebf6,_0x3e8fd3,_0x3170c7),await verifyRecentCampaign(_0xb9ebf6,_0x3170c7),await verifyCampaignMessageAndCloseTicket(_0xb9ebf6,_0x3170c7,_0x3e8fd3);}_0xb9ebf6[_0x4d83d6(0x189)]['remoteJid']?.[_0x4d83d6(0x202)](_0x4d83d6(0x156))&&handleMsgAck(_0xb9ebf6,0x2);});}),_0x3e8fd3['ev']['on']('messages.update',_0x5dc453=>{const _0x46809b=_0x24f4e2;if(_0x5dc453[_0x46809b(0x9b)]===0x0)return;_0x5dc453[_0x46809b(0x1e8)](async _0x11bc80=>{const _0x55ccaa=_0x46809b;_0x3e8fd3['readMessages']([_0x11bc80['key']]);const _0x41d4e3={..._0x5dc453};_0x41d4e3['0']?.[_0x55ccaa(0x111)]['messageStubType']===0x1&&_0x41d4e3['0']?.['key'][_0x55ccaa(0x14d)]!=='status@broadcast'&&(0x0,MarkDeleteWhatsAppMessage_1[_0x55ccaa(0xe2)])(_0x41d4e3['0']?.[_0x55ccaa(0x189)]['remoteJid'],null,_0x41d4e3['0']?.[_0x55ccaa(0x189)]['id'],_0x3170c7);let _0x5e37d0;_0x11bc80['update']['status']===0x3&&_0x11bc80?.[_0x55ccaa(0x189)]?.[_0x55ccaa(0x1b8)]?_0x5e37d0=0x2:_0x5e37d0=_0x11bc80['update'][_0x55ccaa(0x222)],handleMsgAck(_0x11bc80,_0x5e37d0);});}),_0x3e8fd3['ev']['on'](_0x24f4e2(0xb6),_0x1a90d2=>{const _0x76b413=_0x24f4e2;if(_0x1a90d2[_0x76b413(0x9b)]===0x0)return;_0x1a90d2[_0x76b413(0x1e8)](async _0x22c4e9=>{const _0x241141=_0x76b413,_0x39b01e=_0x22c4e9['id']['replace'](/\D/g,''),_0x2373c3=_0x22c4e9[_0x241141(0x12f)]||_0x39b01e;let _0x5a804b;try{_0x5a804b=await _0x3e8fd3[_0x241141(0x176)](_0x22c4e9['id'],_0x241141(0x1ce));}catch(_0x3c2339){Sentry['captureException'](_0x3c2339),_0x5a804b=process['env'][_0x241141(0xf5)]+'/nopicture.png';}const _0x6ea3ee={'name':_0x2373c3,'number':_0x39b01e,'isGroup':!![],'companyId':_0x3170c7,'remoteJid':_0x22c4e9['id'],'profilePicUrl':_0x5a804b},_0x6cb7c3=await(0x0,CreateOrUpdateContactService_1[_0x241141(0xe2)])(_0x6ea3ee);});});};exports[a635_0x4f3874(0x14f)]=wbotMessageListener;