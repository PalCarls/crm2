'use strict';const a627_0x530503=a627_0x94d3;(function(_0x367827,_0x5ce593){const _0x33fbc3=a627_0x94d3,_0x1a596f=_0x367827();while(!![]){try{const _0x1658db=-parseInt(_0x33fbc3(0x1a5))/0x1+-parseInt(_0x33fbc3(0x151))/0x2+parseInt(_0x33fbc3(0xf2))/0x3+parseInt(_0x33fbc3(0x1f7))/0x4*(-parseInt(_0x33fbc3(0x1c0))/0x5)+parseInt(_0x33fbc3(0xf8))/0x6+parseInt(_0x33fbc3(0xd9))/0x7+parseInt(_0x33fbc3(0x23c))/0x8*(parseInt(_0x33fbc3(0x160))/0x9);if(_0x1658db===_0x5ce593)break;else _0x1a596f['push'](_0x1a596f['shift']());}catch(_0x40ba6c){_0x1a596f['push'](_0x1a596f['shift']());}}}(a627_0x2c82,0xde65a));var __createBinding=this&&this['__createBinding']||(Object[a627_0x530503(0x145)]?function(_0xe90a33,_0x22b96f,_0x5ee384,_0x27413d){const _0x4900ea=a627_0x530503;if(_0x27413d===undefined)_0x27413d=_0x5ee384;var _0x109956=Object[_0x4900ea(0x105)](_0x22b96f,_0x5ee384);(!_0x109956||(_0x4900ea(0x241)in _0x109956?!_0x22b96f[_0x4900ea(0x17a)]:_0x109956[_0x4900ea(0x1fa)]||_0x109956[_0x4900ea(0x235)]))&&(_0x109956={'enumerable':!![],'get':function(){return _0x22b96f[_0x5ee384];}}),Object[_0x4900ea(0x130)](_0xe90a33,_0x27413d,_0x109956);}:function(_0x15487f,_0x1e2b7e,_0x2e4129,_0x3ee327){if(_0x3ee327===undefined)_0x3ee327=_0x2e4129;_0x15487f[_0x3ee327]=_0x1e2b7e[_0x2e4129];}),__setModuleDefault=this&&this[a627_0x530503(0x1a8)]||(Object[a627_0x530503(0x145)]?function(_0x56ac54,_0x1b06f5){Object['defineProperty'](_0x56ac54,'default',{'enumerable':!![],'value':_0x1b06f5});}:function(_0x282472,_0x32edad){const _0x37b03c=a627_0x530503;_0x282472[_0x37b03c(0x118)]=_0x32edad;}),__importStar=this&&this[a627_0x530503(0x19e)]||function(_0x13807a){const _0x4818c8=a627_0x530503;if(_0x13807a&&_0x13807a[_0x4818c8(0x17a)])return _0x13807a;var _0x2ecbd1={};if(_0x13807a!=null){for(var _0x2397fb in _0x13807a)if(_0x2397fb!==_0x4818c8(0x118)&&Object[_0x4818c8(0x21a)][_0x4818c8(0xf4)][_0x4818c8(0x12d)](_0x13807a,_0x2397fb))__createBinding(_0x2ecbd1,_0x13807a,_0x2397fb);}return __setModuleDefault(_0x2ecbd1,_0x13807a),_0x2ecbd1;},__importDefault=this&&this['__importDefault']||function(_0x264ce3){const _0x1b3bfb=a627_0x530503;return _0x264ce3&&_0x264ce3[_0x1b3bfb(0x17a)]?_0x264ce3:{'default':_0x264ce3};};Object[a627_0x530503(0x130)](exports,'__esModule',{'value':!![]}),exports[a627_0x530503(0x1d3)]=exports[a627_0x530503(0x19d)]=exports['handleMessage']=exports[a627_0x530503(0x136)]=exports[a627_0x530503(0x12b)]=exports[a627_0x530503(0x165)]=exports[a627_0x530503(0x1df)]=exports[a627_0x530503(0xe0)]=exports[a627_0x530503(0x157)]=exports[a627_0x530503(0x1bb)]=exports[a627_0x530503(0x15e)]=exports[a627_0x530503(0x1d6)]=exports[a627_0x530503(0x194)]=void 0x0;const path_1=__importStar(require(a627_0x530503(0x176))),util_1=require('util'),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require(a627_0x530503(0x25b))),lodash_1=require(a627_0x530503(0x1a1)),baileys_1=require('@whiskeysockets/baileys'),Contact_1=__importDefault(require(a627_0x530503(0x17b))),Ticket_1=__importDefault(require(a627_0x530503(0x1a4))),Message_1=__importDefault(require(a627_0x530503(0x1f2))),socket_1=require(a627_0x530503(0x187)),CreateMessageService_1=__importDefault(require(a627_0x530503(0x188))),logger_1=require(a627_0x530503(0x196)),CreateOrUpdateContactService_1=__importDefault(require(a627_0x530503(0xe7))),FindOrCreateTicketService_1=__importDefault(require(a627_0x530503(0x24d))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),Debounce_1=require('../../helpers/Debounce'),UpdateTicketService_1=__importDefault(require(a627_0x530503(0x207))),Mustache_1=__importDefault(require(a627_0x530503(0x1b9))),UserRating_1=__importDefault(require(a627_0x530503(0x238))),SendWhatsAppMessage_1=__importDefault(require(a627_0x530503(0x114))),sendFacebookMessage_1=__importDefault(require('../FacebookServices/sendFacebookMessage')),moment_1=__importDefault(require(a627_0x530503(0x156))),Queue_1=__importDefault(require(a627_0x530503(0x1fe))),FindOrCreateATicketTrakingService_1=__importDefault(require(a627_0x530503(0x1b1))),VerifyCurrentSchedule_1=__importDefault(require(a627_0x530503(0xe6))),Campaign_1=__importDefault(require(a627_0x530503(0xd0))),CampaignShipping_1=__importDefault(require(a627_0x530503(0x146))),sequelize_1=require('sequelize'),queues_1=require(a627_0x530503(0x163)),User_1=__importDefault(require(a627_0x530503(0x1a7))),ChatBotListener_1=require(a627_0x530503(0x170)),MarkDeleteWhatsAppMessage_1=__importDefault(require('./MarkDeleteWhatsAppMessage')),ListUserQueueServices_1=__importDefault(require('../UserQueueServices/ListUserQueueServices')),cache_1=__importDefault(require('../../libs/cache')),addLogs_1=require(a627_0x530503(0xf0)),SendWhatsAppMedia_1=__importStar(require(a627_0x530503(0x254))),ShowQueueIntegrationService_1=__importDefault(require(a627_0x530503(0xcc))),CreateSessionDialogflow_1=require(a627_0x530503(0x1ff)),QueryDialogflow_1=require(a627_0x530503(0x219)),CompaniesSettings_1=__importDefault(require('../../models/CompaniesSettings')),CreateLogTicketService_1=__importDefault(require(a627_0x530503(0x12c))),Whatsapp_1=__importDefault(require(a627_0x530503(0xc9))),ShowService_1=__importDefault(require(a627_0x530503(0x16a))),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require(a627_0x530503(0x256))),microsoft_cognitiveservices_speech_sdk_1=require(a627_0x530503(0xd2)),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),os=require('os'),request=require('request');let ffmpegPath;if(os[a627_0x530503(0x18f)]()===a627_0x530503(0xec))ffmpegPath=a627_0x530503(0xf1);else os['platform']()==='darwin'?ffmpegPath=a627_0x530503(0x1eb):ffmpegPath=a627_0x530503(0x225);fluent_ffmpeg_1[a627_0x530503(0x118)][a627_0x530503(0x18c)](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a627_0x530503(0x162)])(fs_1[a627_0x530503(0x22f)]);function removeFile(_0x3af9d6){fs_2['default']['unlink'](_0x3af9d6,_0x59ba99=>{if(_0x59ba99)throw _0x59ba99;});}const getTimestampMessage=_0x8aa88c=>{return _0x8aa88c*0x1;},multVecardGet=function(_0x33b20f){const _0x998612=a627_0x530503;let _0x5057c3='\x20',_0x5e4afa=_0x33b20f[_0x998612(0x240)]('\x0a')[0x2][_0x998612(0x224)](_0x998612(0x1f6),'\x0a')[_0x998612(0x224)]('N:','')[_0x998612(0x224)](';','')[_0x998612(0x224)](';','\x20')[_0x998612(0x224)](';;','\x20')[_0x998612(0x224)]('\x0a',''),_0x26366c=_0x33b20f[_0x998612(0x240)]('\x0a')[0x4]['indexOf']('='),_0x145a53=_0x33b20f[_0x998612(0x240)]('\x0a')[0x4]['indexOf'](':'),_0x4b80fd=_0x33b20f[_0x998612(0x240)]('\x0a')[0x4][_0x998612(0x22c)](_0x26366c+0x1,_0x145a53)[_0x998612(0x224)](';',''),_0x394103=_0x33b20f['split']('\x0a')[0x4]['replace'](_0x998612(0x18d),'');if(_0x4b80fd!=_0x998612(0x213))_0x5057c3=_0x5057c3+_0x5e4afa+':\x20ðŸ“ž'+_0x4b80fd+''+'\x0a';else _0x5057c3=_0x5057c3+_0x5e4afa+_0x998612(0x1ce)+_0x394103+''+'\x0a';return _0x5057c3;},contactsArrayMessageGet=_0x1bb5d0=>{const _0x4a5fcf=a627_0x530503;let _0x1e587d=_0x1bb5d0['message']?.[_0x4a5fcf(0x25d)]?.[_0x4a5fcf(0xf9)],_0x1cd093=_0x1e587d[_0x4a5fcf(0x23a)](function(_0x5bba09,_0x477d72){const _0x2db60d=_0x4a5fcf;return _0x5bba09[_0x2db60d(0x1d0)];}),_0x2a531e='';_0x1cd093[_0x4a5fcf(0xd5)](function(_0x16a881,_0x5f244e){_0x2a531e+=_0x16a881+'\x0a\x0a'+'';});let _0x593d3d=_0x2a531e[_0x4a5fcf(0x240)](_0x4a5fcf(0x161));_0x593d3d['shift']();let _0x58802e='';for(let _0x191b99 of _0x593d3d){_0x58802e=_0x58802e+multVecardGet(_0x191b99);}return _0x58802e;},getTypeMessage=_0x278079=>{const _0x3d61ba=a627_0x530503,_0x34ad00=(0x0,baileys_1['getContentType'])(_0x278079[_0x3d61ba(0xfe)]);if(_0x278079['message']?.['viewOnceMessageV2'])return'viewOnceMessageV2';return _0x34ad00;};function a627_0x2c82(){const _0x513ed0=['endsWith','.mpeg','user','chatbots','verifyMessage','paused','destroy','lgpdMessage','rows','stringValue','../CompanyService/VerifyCurrentSchedule','../ContactServices/CreateOrUpdateContactService','delete','toLocaleLowerCase','prompt','company-','win32','pop','speakTextAsync','integrationId','../../helpers/addLogs','C:\x5cffmpeg\x5cffmpeg.exe','241665kmMwqJ','contacts:','hasOwnProperty','open','sayChatbot','caption','7779756bEerpp','contacts','delay','documentMessage','voiceKey','createTranscription','message','buttonText','filter','includes','reactionMessage','participant','isNil','getOwnPropertyDescriptor','debounce','REVOKE','apiKey','typebot','Error\x20getTypeMessage','end','button','%2C','Erro\x20ao\x20baixar\x20mÃ­dia:','join','Ãudio','NFD','temperature','find','./SendWhatsAppMessage','templateButtonReplyMessage','chatbotAt','stanzaId','default','body','setExtra','error','language','No\x20result\x20from\x20synthesizer','dialogflow','stringify','Erro\x20ao\x20baixar\x20media','viewOnceMessageV2','Nas\x20respostas\x20utilize\x20o\x20nome\x20','Erro\x20para\x20responder\x20com\x20audio:\x20','videoMessage','captureException','E2E_IDENTITY_CHANGED','isBot','amountUseBotQueuesNPS','Error\x20converting\x20file:\x20','name','handleMessageIntegration','../TicketServices/CreateLogTicketService','call','protocolMessage','.wav','defineProperty','ASC','now','responses','sections','.ogg','wbotMessageListener','closedAt','/nopicture.png','maxMessages','getMinutes','description','@g.us','floor','options','closed','.txt','subject','\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento','Importando\x20Mensagem:\x20','assistant','create','../../models/CampaignShipping','mediaUrl','add','webhook','findAll','value','title','AudioConfig','extendedTextMessage','degreesLatitude','-appMessage','1545706TOdKBS','Formato\x20de\x20arquivo\x20nÃ£o\x20suportado:','reload','n8n','resolve','moment','verifyMediaMessage','maxTokens','imageMessage','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','status','farewellMessage','allowGroup','getQuotedMessageId','messageStubType','234mmWiiS','BEGIN:','promisify','../../queues','toDate','handleRating','trim','enableLGPD','groupMetadata','info','../FileServices/ShowService','min','messages','closeTicket','chat','length','./ChatBotListener','key','buffer','composing','outOfHoursMessage','CIPHERTEXT','path','contentText','greetingMediaAttachment','public','__esModule','../../models/Contact','contact','SpeechSynthesizer','AÃ§Ã£o:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','profilePictureUrl','-ticket','isGroup','setMinutes','pending','finishedAt','isNull','Esta\x20mensagem\x20jÃ¡\x20existe','../../libs/socket','../MessageServices/CreateMessageService','voice','push','messageTimestamp','setFfmpegPath','item1.TEL:','acceptAudioMessage','platform','entrou\x20no\x20typebot','mediaType','findByPk','fromMe','getBodyMessage','.mp3','../../utils/logger','debug','update','emit','listMessage','listResponseMessage','createChatCompletion','isValidMsg','__importStar','company','then','lodash','type','set','../../models/Ticket','1161943uBnuQS','log','../../models/User','__setModuleDefault','mediaMessage','buttonsResponseMessage','7bit','contactId','content','jpegThumbnail','documentWithCaptionMessage','s.whatsapp.net','../TicketServices/FindOrCreateATicketTrakingService','next','choices','input','text','locationMessage','ratingMessage','toFormat','../../helpers/Mustache','jidNormalizedUser','downloadMedia','system','useIntegration','channel','scheduleType','26710ZpiXRK','readMessages','projectName','ticketId','viewOnceMessage','parseToMilliseconds','DispatchCampaign','whisper-1','texto','â€ŽOpÃ§Ã£o\x20invÃ¡lida,\x20tente\x20novamente.\x0a','mimetype','Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20jÃ¡\x20nÃ£o\x20esta\x20mais\x20disponÃ­vel','isForwarded','image',':\x20ðŸ“ž','fileList','vcard','sendQueuePosition','chatBot','getTypeMessage','warn','audio/mpeg','getQuotedMessage','fromAudioFileOutput','settingsUserRandom','getTime','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','imported','fromSubscription','TIMEOUT_TO_IMPORT_MESSAGE','maxUseBotQueues','verifyRating',':*\x20NÃ£o\x20consegui\x20entender\x20sua\x20dÃºvida.','base64','stickerMessage','queueId','campaignQueue','selectedId','medias','greetingMessage','quotedMessage','voiceRegion','urlN8N','/opt/homebrew/bin/ffmpeg','@c.us','ValidaÃ§Ã£o\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','singleSelectReply','getIO','selectedButtonId',':unreads','../../models/Message','selectedDisplayText','complationMessage','editedMessage',';;;','612yzmgeH','logger','Erro\x20ao\x20deletar\x20o\x20arquivo:','writable','amountUsedBotQueues','presenceSubscribe','messages.upsert','../../models/Queue','../QueueIntegrationServices/CreateSessionDialogflow','axolotlSenderKeyDistributionMessage','lgpdSendMessageAt','extractMessageContent','findOne','ERR_WAPP_DOWNLOAD_MEDIA','filename','fileListId','../TicketServices/UpdateTicketService','number','save','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','contextInfo','â€ŽEstou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20NÃ£o','queue','\x20-\x20Longitude:\x20','isNaN','senderKeyDistributionMessage','audio','userId','item1.TEL','speechSynthesisVoiceName','Mensagem','messages.update','createDialogflowSessionWithModel','displayText','../QueueIntegrationServices/QueryDialogflow','prototype','Amigo(a)','â€Ž\x20*','toString','findAndCountAll','from','data','audioMessage','selectedRowId','keys','replace','/usr/bin/ffmpeg','promptId','test','sendPresenceUpdate','disabled','ephemeralMessage','enabled','substring','POST','sendGreetingMessageOneQueues','writeFile','EM_ANDAMENTO','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posiÃ§Ã£o\x20na\x20fila\x20de\x20atendimento\x20Ã©:\x20*','lgpdLink','Error\x20handling\x20message\x20ack.\x20Err:\x20','lgpdConsent','configurable','acceptAudioMessageContact','conversation','../../models/UserRating','ratingAt','map','g.us','366264LiMnXc','remoteJid','mp3','count','split','get','degreesLongitude','Error:\x20','isInteger','timeUseBotQueues','sticker','unlinkSync','buttons','disableBot','slice','messageContextInfo','endConversation','../TicketServices/FindOrCreateTicketService','readFile','buttonsMessage','randomValue','sendMessage','gpt-3.5-turbo','queryDialogFlow','./SendWhatsAppMedia','&z=17&hl=pt-BR|','fluent-ffmpeg','*[\x20','downloadMediaMessage','companyId','close','@sentry/node','lgpd','contactsArrayMessage','lgpdAcceptedAt','toISOString','groupAsTicket',':*\x20','../../models/Whatsapp','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20mÃ¡ximo\x20','Escolha\x20uma\x20opÃ§Ã£o','../QueueIntegrationServices/ShowQueueIntegrationService','FRONTEND_URL','parameters','pushName','../../models/Campaign','liveLocationMessage','microsoft-cognitiveservices-speech-sdk','status@broadcast','whatsapp','forEach','WAMessageStubType','env','values','7668647ubQdft','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mÃ­dia\x20verifique\x20no\x20dispositivo','findIndex'];a627_0x2c82=function(){return _0x513ed0;};return a627_0x2c82();}exports[a627_0x530503(0x1d3)]=getTypeMessage;const getBodyButton=_0x4d7479=>{const _0x1bbcd3=a627_0x530503;if(_0x4d7479[_0x1bbcd3(0x171)][_0x1bbcd3(0x193)]&&_0x4d7479['message'][_0x1bbcd3(0x24f)]?.[_0x1bbcd3(0x177)]){let _0x2887cc=''+_0x4d7479?.['message']?.[_0x1bbcd3(0x24f)]?.[_0x1bbcd3(0x177)];for(const _0x1a6b39 of _0x4d7479[_0x1bbcd3(0xfe)]?.[_0x1bbcd3(0x24f)]?.[_0x1bbcd3(0x248)]){_0x2887cc+='\x0a\x0a'+_0x1a6b39[_0x1bbcd3(0xff)]?.[_0x1bbcd3(0x218)];}return _0x2887cc;}if(_0x4d7479[_0x1bbcd3(0x171)][_0x1bbcd3(0x193)]&&_0x4d7479?.[_0x1bbcd3(0xfe)]?.[_0x1bbcd3(0x1c4)]?.['message']?.[_0x1bbcd3(0x19a)]){let _0x54bab5=''+_0x4d7479?.['message']?.[_0x1bbcd3(0x1c4)]?.['message']?.['listMessage']?.[_0x1bbcd3(0x13b)];for(const _0x583e74 of _0x4d7479[_0x1bbcd3(0xfe)]?.[_0x1bbcd3(0x1c4)]?.[_0x1bbcd3(0xfe)]?.[_0x1bbcd3(0x19a)]?.[_0x1bbcd3(0x134)]){for(const _0x46ec30 of _0x583e74[_0x1bbcd3(0xe4)]){_0x54bab5+='\x0a\x0a'+_0x46ec30['title'];}}return _0x54bab5;}},getBodyList=_0x1cfcb1=>{const _0x3bf7bb=a627_0x530503;if(_0x1cfcb1['key']['fromMe']&&_0x1cfcb1[_0x3bf7bb(0xfe)][_0x3bf7bb(0x19a)]?.[_0x3bf7bb(0x13b)]){let _0x487a4d=''+_0x1cfcb1['message'][_0x3bf7bb(0x19a)]?.[_0x3bf7bb(0x13b)];for(const _0xe10edd of _0x1cfcb1[_0x3bf7bb(0xfe)]['listMessage']?.[_0x3bf7bb(0x134)]){for(const _0x151ec8 of _0xe10edd[_0x3bf7bb(0xe4)]){_0x487a4d+='\x0a\x0a'+_0x151ec8[_0x3bf7bb(0x14c)];}}return _0x487a4d;}if(_0x1cfcb1[_0x3bf7bb(0x171)][_0x3bf7bb(0x193)]&&_0x1cfcb1?.[_0x3bf7bb(0xfe)]?.['viewOnceMessage']?.['message']?.[_0x3bf7bb(0x19a)]){let _0x43336b=''+_0x1cfcb1?.[_0x3bf7bb(0xfe)]?.['viewOnceMessage']?.[_0x3bf7bb(0xfe)]?.['listMessage']?.[_0x3bf7bb(0x13b)];for(const _0x1931f6 of _0x1cfcb1['message']?.['viewOnceMessage']?.[_0x3bf7bb(0xfe)]?.[_0x3bf7bb(0x19a)]?.[_0x3bf7bb(0x134)]){for(const _0x43e978 of _0x1931f6[_0x3bf7bb(0xe4)]){_0x43336b+='\x0a\x0a'+_0x43e978[_0x3bf7bb(0x14c)];}}return _0x43336b;}},msgLocation=(_0x12ff0d,_0x49da20,_0x513dd6)=>{const _0x32d8bd=a627_0x530503;if(_0x12ff0d){var _0x4386f8=Buffer[_0x32d8bd(0x21f)](_0x12ff0d)[_0x32d8bd(0x21d)]('base64');let _0x5ae723='data:image/png;base64,\x20'+_0x4386f8+'\x20|\x20https://maps.google.com/maps?q='+_0x49da20+_0x32d8bd(0x10d)+_0x513dd6+_0x32d8bd(0x255)+_0x49da20+',\x20'+_0x513dd6+'\x20';return _0x5ae723;}},getBodyMessage=_0x43ae66=>{const _0x148b1a=a627_0x530503;try{let _0x1a76d1=getTypeMessage(_0x43ae66);if(_0x1a76d1===undefined)console[_0x148b1a(0x1a6)](_0x43ae66);const _0xe57489={'conversation':_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x237)],'imageMessage':_0x43ae66[_0x148b1a(0xfe)]?.['imageMessage']?.[_0x148b1a(0xf7)],'videoMessage':_0x43ae66['message']?.[_0x148b1a(0x124)]?.[_0x148b1a(0xf7)],'extendedTextMessage':_0x43ae66?.[_0x148b1a(0xfe)]?.[_0x148b1a(0x14e)]?.[_0x148b1a(0x1b5)],'buttonsResponseMessage':_0x43ae66['message']?.['buttonsResponseMessage']?.[_0x148b1a(0x1f3)],'listResponseMessage':_0x43ae66['message']?.['listResponseMessage']?.['title']||_0x43ae66[_0x148b1a(0xfe)]?.['listResponseMessage']?.[_0x148b1a(0x1ee)]?.['selectedRowId'],'templateButtonReplyMessage':_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x115)]?.[_0x148b1a(0x1e5)],'messageContextInfo':_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x1aa)]?.['selectedButtonId']||_0x43ae66['message']?.[_0x148b1a(0x19b)]?.[_0x148b1a(0x14c)],'buttonsMessage':getBodyButton(_0x43ae66)||_0x43ae66['message']?.[_0x148b1a(0x19b)]?.[_0x148b1a(0x14c)],'stickerMessage':_0x148b1a(0x246),'contactMessage':_0x43ae66[_0x148b1a(0xfe)]?.['contactMessage']?.[_0x148b1a(0x1d0)],'contactsArrayMessage':_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x25d)]?.[_0x148b1a(0xf9)]&&contactsArrayMessageGet(_0x43ae66),'locationMessage':msgLocation(_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x1b6)]?.[_0x148b1a(0x1ae)],_0x43ae66['message']?.['locationMessage']?.['degreesLatitude'],_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x1b6)]?.[_0x148b1a(0x242)]),'liveLocationMessage':'Latitude:\x20'+_0x43ae66[_0x148b1a(0xfe)]?.['liveLocationMessage']?.[_0x148b1a(0x14f)]+_0x148b1a(0x20e)+_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0xd1)]?.[_0x148b1a(0x242)],'documentMessage':_0x43ae66[_0x148b1a(0xfe)]?.['documentMessage']?.[_0x148b1a(0xf7)],'audioMessage':_0x148b1a(0x110),'listMessage':getBodyList(_0x43ae66)||_0x43ae66[_0x148b1a(0xfe)]?.['listResponseMessage']?.[_0x148b1a(0x14c)],'viewOnceMessage':getBodyButton(_0x43ae66),'reactionMessage':_0x43ae66['message']?.[_0x148b1a(0x102)]?.[_0x148b1a(0x1b5)]||'reaction','senderKeyDistributionMessage':_0x43ae66?.[_0x148b1a(0xfe)]?.[_0x148b1a(0x210)]?.[_0x148b1a(0x200)],'documentWithCaptionMessage':_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x1af)]?.[_0x148b1a(0xfe)]?.[_0x148b1a(0xfb)]?.['caption'],'viewOnceMessageV2':_0x43ae66[_0x148b1a(0xfe)]?.['viewOnceMessageV2']?.[_0x148b1a(0xfe)]?.[_0x148b1a(0x159)]?.[_0x148b1a(0xf7)],'editedMessage':_0x43ae66['message']?.[_0x148b1a(0x1f5)]?.[_0x148b1a(0xfe)]?.['extendedTextMessage']?.[_0x148b1a(0x1b5)],'ephemeralMessage':_0x43ae66[_0x148b1a(0xfe)]?.[_0x148b1a(0x22a)]?.['message']?.['extendedTextMessage']?.[_0x148b1a(0x1b5)]},_0x33a08d=Object['keys'](_0xe57489)[_0x148b1a(0x113)](_0x4682cd=>_0x4682cd===_0x1a76d1);return!_0x33a08d&&(logger_1[_0x148b1a(0x1f8)][_0x148b1a(0x1d4)]('####\x20Nao\x20achou\x20o\x20type\x20152:\x20'+_0x1a76d1+'\x0a'+JSON[_0x148b1a(0x11f)](_0x43ae66)),Sentry[_0x148b1a(0x11a)](_0x148b1a(0x215),{'BodyMsg':_0x43ae66[_0x148b1a(0xfe)],'msg':_0x43ae66,'type':_0x1a76d1}),Sentry[_0x148b1a(0x125)](new Error('Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage'))),_0xe57489[_0x1a76d1];}catch(_0x46f1b8){Sentry[_0x148b1a(0x11a)](_0x148b1a(0x10a),{'msg':_0x43ae66,'BodyMsg':_0x43ae66[_0x148b1a(0xfe)]}),Sentry[_0x148b1a(0x125)](_0x46f1b8),console['log'](_0x46f1b8);}};exports[a627_0x530503(0x194)]=getBodyMessage;const getQuotedMessage=_0x184375=>{const _0x4d4698=a627_0x530503,_0x1bec6a=(0x0,baileys_1[_0x4d4698(0x202)])(_0x184375[_0x4d4698(0xfe)])[Object[_0x4d4698(0x223)](_0x184375?.['message'])[_0x4d4698(0xd8)]()[_0x4d4698(0x1b2)]()[_0x4d4698(0x14b)]];if(!_0x1bec6a?.[_0x4d4698(0x20b)]?.['quotedMessage'])return;const _0x2da8c9=(0x0,baileys_1['extractMessageContent'])(_0x1bec6a?.[_0x4d4698(0x20b)]?.[_0x4d4698(0x1e8)][Object['keys'](_0x1bec6a?.['contextInfo']?.[_0x4d4698(0x1e8)])[_0x4d4698(0xd8)]()[_0x4d4698(0x1b2)]()['value']]);return _0x2da8c9;};exports[a627_0x530503(0x1d6)]=getQuotedMessage;const getQuotedMessageId=_0x57f6e0=>{const _0xc248cb=a627_0x530503,_0x1d90b6=(0x0,baileys_1[_0xc248cb(0x202)])(_0x57f6e0[_0xc248cb(0xfe)])[Object['keys'](_0x57f6e0?.[_0xc248cb(0xfe)])['values']()['next']()[_0xc248cb(0x14b)]];let _0x173e49=_0x57f6e0?.[_0xc248cb(0xfe)]?.[_0xc248cb(0x102)]?_0x57f6e0?.[_0xc248cb(0xfe)]?.['reactionMessage']?.[_0xc248cb(0x171)]?.['id']:'';return _0x173e49?_0x173e49:_0x1d90b6?.[_0xc248cb(0x20b)]?.[_0xc248cb(0x117)];};exports[a627_0x530503(0x15e)]=getQuotedMessageId;const getMeSocket=_0x24d399=>{const _0x15b7a8=a627_0x530503;return{'id':(0x0,baileys_1['jidNormalizedUser'])(_0x24d399[_0x15b7a8(0xde)]['id']),'name':_0x24d399['user'][_0x15b7a8(0x12a)]};},getSenderMessage=(_0x45eb2b,_0x54a22c)=>{const _0x1ff956=a627_0x530503,_0x2eac8d=getMeSocket(_0x54a22c);if(_0x45eb2b[_0x1ff956(0x171)][_0x1ff956(0x193)])return _0x2eac8d['id'];const _0xfe0dfc=_0x45eb2b[_0x1ff956(0x103)]||_0x45eb2b[_0x1ff956(0x171)][_0x1ff956(0x103)]||_0x45eb2b['key'][_0x1ff956(0x23d)]||undefined;return _0xfe0dfc&&(0x0,baileys_1[_0x1ff956(0x1ba)])(_0xfe0dfc);},getContactMessage=async(_0x43c7ee,_0x1d789e)=>{const _0xa56ff9=a627_0x530503,_0x3b09b2=_0x43c7ee[_0xa56ff9(0x171)][_0xa56ff9(0x23d)]['includes'](_0xa56ff9(0x23b)),_0x34e586=_0x43c7ee[_0xa56ff9(0x171)]['remoteJid'][_0xa56ff9(0x224)](/\D/g,'');return _0x3b09b2?{'id':getSenderMessage(_0x43c7ee,_0x1d789e),'name':_0x43c7ee[_0xa56ff9(0xcf)]}:{'id':_0x43c7ee[_0xa56ff9(0x171)][_0xa56ff9(0x23d)],'name':_0x43c7ee[_0xa56ff9(0x171)][_0xa56ff9(0x193)]?_0x34e586:_0x43c7ee[_0xa56ff9(0xcf)]};},downloadMedia=async(_0x4ab495,_0x2f35f5=null)=>{const _0xd7ece0=a627_0x530503;let _0x2ef779;try{_0x2ef779=await(0x0,baileys_1[_0xd7ece0(0x258)])(_0x4ab495,_0xd7ece0(0x172),{});}catch(_0x28783a){_0x2f35f5?console[_0xd7ece0(0x1a6)](_0xd7ece0(0x1cb)):console[_0xd7ece0(0x11b)](_0xd7ece0(0x10e),_0x28783a);}let _0x4bc050=_0x4ab495['message']?.[_0xd7ece0(0xfb)]?.['fileName']||'';const _0x3eef31=_0x4ab495['message']?.[_0xd7ece0(0x159)]||_0x4ab495[_0xd7ece0(0xfe)]?.[_0xd7ece0(0x221)]||_0x4ab495[_0xd7ece0(0xfe)]?.[_0xd7ece0(0x124)]||_0x4ab495['message']?.[_0xd7ece0(0x1e2)]||_0x4ab495[_0xd7ece0(0xfe)]?.[_0xd7ece0(0xfb)]||_0x4ab495[_0xd7ece0(0xfe)]?.[_0xd7ece0(0x1af)]?.[_0xd7ece0(0xfe)]?.[_0xd7ece0(0xfb)]||_0x4ab495[_0xd7ece0(0xfe)]?.[_0xd7ece0(0x14e)]?.[_0xd7ece0(0x20b)]?.['quotedMessage']?.[_0xd7ece0(0x159)]||_0x4ab495[_0xd7ece0(0xfe)]?.[_0xd7ece0(0x14e)]?.[_0xd7ece0(0x20b)]?.[_0xd7ece0(0x1e8)]?.[_0xd7ece0(0x124)];if(!_0x3eef31)console[_0xd7ece0(0x1a6)](_0x4ab495);if(!_0x4bc050){const _0x2af470=_0x3eef31[_0xd7ece0(0x1ca)]['split']('/')[0x1][_0xd7ece0(0x240)](';')[0x0];_0x4bc050=new Date()[_0xd7ece0(0x1d9)]()+'.'+_0x2af470;}else _0x4bc050=new Date()[_0xd7ece0(0x1d9)]()+'_'+_0x4bc050;const _0x591f37={'data':_0x2ef779,'mimetype':_0x3eef31[_0xd7ece0(0x1ca)],'filename':_0x4bc050};return _0x591f37;};exports[a627_0x530503(0x1bb)]=downloadMedia;function a627_0x94d3(_0x4abdb,_0x4a2903){const _0x2c8246=a627_0x2c82();return a627_0x94d3=function(_0x94d300,_0x37d003){_0x94d300=_0x94d300-0xc5;let _0xd69a1e=_0x2c8246[_0x94d300];return _0xd69a1e;},a627_0x94d3(_0x4abdb,_0x4a2903);}const verifyContact=async(_0x3f54de,_0x96ff3b,_0x4296e3)=>{const _0x2d3f1f=a627_0x530503;let _0x3d40b7;try{_0x3d40b7=await _0x96ff3b[_0x2d3f1f(0x17f)](_0x3f54de['id'],'image');}catch(_0x2f5831){Sentry[_0x2d3f1f(0x125)](_0x2f5831),_0x3d40b7=process['env']['FRONTEND_URL']+_0x2d3f1f(0x138);}const _0x377e5f={'name':_0x3f54de[_0x2d3f1f(0x12a)]||_0x3f54de['id'][_0x2d3f1f(0x224)](/\D/g,''),'number':_0x3f54de['id'][_0x2d3f1f(0x224)](/\D/g,''),'profilePicUrl':_0x3d40b7,'isGroup':_0x3f54de['id'][_0x2d3f1f(0x101)](_0x2d3f1f(0x23b)),'companyId':_0x4296e3,'remoteJid':_0x3f54de['id']};_0x377e5f[_0x2d3f1f(0x181)]&&(_0x377e5f[_0x2d3f1f(0x208)]=_0x3f54de['id'][_0x2d3f1f(0x224)](_0x2d3f1f(0x13c),''));const _0x30264a=await(0x0,CreateOrUpdateContactService_1[_0x2d3f1f(0x118)])(_0x377e5f);return _0x30264a;},verifyQuotedMessage=async _0x2b71b=>{const _0x2dd354=a627_0x530503;if(!_0x2b71b)return null;const _0x5bfd69=(0x0,exports['getQuotedMessageId'])(_0x2b71b);if(!_0x5bfd69)return null;const _0x17c2c5=await Message_1[_0x2dd354(0x118)][_0x2dd354(0x203)]({'where':{'wid':_0x5bfd69}});if(!_0x17c2c5)return null;return _0x17c2c5;},verifyMediaMessage=async(_0x363792,_0xcc7f62,_0x30cc0e,_0x233810,_0x166d79)=>{const _0x34061d=a627_0x530503,_0x5c6438=(0x0,socket_1['getIO'])(),_0x511458=await verifyQuotedMessage(_0x363792),_0x3688db=_0xcc7f62[_0x34061d(0x259)];try{const _0x1a62c3=await(0x0,exports[_0x34061d(0x1bb)])(_0x363792,_0xcc7f62?.['imported']);if(!_0x1a62c3&&_0xcc7f62['imported']){const _0x579ea3=_0x34061d(0xda),_0x5dfd48={'wid':_0x363792['key']['id'],'ticketId':_0xcc7f62['id'],'contactId':_0x363792[_0x34061d(0x171)][_0x34061d(0x193)]?undefined:_0xcc7f62[_0x34061d(0x1ac)],'body':_0x579ea3,'reactionMessage':_0x363792[_0x34061d(0xfe)]?.['reactionMessage'],'fromMe':_0x363792['key'][_0x34061d(0x193)],'mediaType':getTypeMessage(_0x363792),'read':_0x363792[_0x34061d(0x171)][_0x34061d(0x193)],'quotedMsgId':_0x511458?.['id']||_0x363792[_0x34061d(0xfe)]?.['reactionMessage']?.[_0x34061d(0x171)]?.['id'],'ack':_0x363792[_0x34061d(0x15b)],'companyId':_0x3688db,'remoteJid':_0x363792[_0x34061d(0x171)][_0x34061d(0x23d)],'participant':_0x363792['key'][_0x34061d(0x103)],'timestamp':getTimestampMessage(_0x363792[_0x34061d(0x18b)]),'createdAt':new Date(Math[_0x34061d(0x13d)](getTimestampMessage(_0x363792[_0x34061d(0x18b)])*0x3e8))[_0x34061d(0xc6)](),'dataJson':JSON[_0x34061d(0x11f)](_0x363792),'ticketImported':_0xcc7f62[_0x34061d(0x1db)],'isForwarded':_0x166d79};return await _0xcc7f62[_0x34061d(0x198)]({'lastMessage':_0x579ea3}),logger_1['logger'][_0x34061d(0x11b)](Error(_0x34061d(0x204))),(0x0,CreateMessageService_1[_0x34061d(0x118)])({'messageData':_0x5dfd48,'companyId':_0x3688db});}if(!_0x1a62c3)throw new Error(_0x34061d(0x204));if(!_0x1a62c3[_0x34061d(0x205)]){const _0x2ef36d=_0x1a62c3[_0x34061d(0x1ca)][_0x34061d(0x240)]('/')[0x1][_0x34061d(0x240)](';')[0x0];_0x1a62c3['filename']=new Date()['getTime']()+'.'+_0x2ef36d;}else{const _0x1cf342=_0x1a62c3[_0x34061d(0x205)][_0x34061d(0x240)]('.')[_0x34061d(0xed)](),_0x1c85e6=_0x1a62c3[_0x34061d(0x205)][_0x34061d(0x240)]('.')[_0x34061d(0x24a)](0x0,-0x1)[_0x34061d(0x10f)]('.')['replace'](/\s/g,'_')['normalize'](_0x34061d(0x111))['replace'](/[\u0300-\u036f]/g,'');_0x1a62c3[_0x34061d(0x205)]=_0x1c85e6[_0x34061d(0x166)]()+'_'+new Date()[_0x34061d(0x1d9)]()+'.'+_0x1cf342;}try{const _0x365ab3=path_1[_0x34061d(0x118)][_0x34061d(0x155)](__dirname,'..','..','..',_0x34061d(0x179),_0x34061d(0x19f)+_0x3688db);!fs_2[_0x34061d(0x118)]['existsSync'](_0x365ab3)&&(fs_2['default']['mkdirSync'](_0x365ab3,{'recursive':!![]}),fs_2[_0x34061d(0x118)]['chmodSync'](_0x365ab3,0x1ff)),await writeFileAsync((0x0,path_1[_0x34061d(0x10f)])(_0x365ab3,_0x1a62c3['filename']),_0x1a62c3[_0x34061d(0x220)][_0x34061d(0x21d)](_0x34061d(0x1e1)),_0x34061d(0x1e1))[_0x34061d(0x1a0)](()=>{const _0x1bc956=_0x34061d;if(_0x1a62c3[_0x1bc956(0x1ca)][_0x1bc956(0x101)](_0x1bc956(0x211))){const _0x12a0c9=path_1[_0x1bc956(0x118)]['join'](_0x365ab3,_0x1a62c3['filename']);let _0x16589e;if(_0x12a0c9[_0x1bc956(0xdc)]('.mpeg'))_0x16589e=_0x12a0c9[_0x1bc956(0x224)](_0x1bc956(0xdd),'.mp3');else{if(_0x12a0c9[_0x1bc956(0xdc)](_0x1bc956(0x135)))_0x16589e=_0x12a0c9[_0x1bc956(0x224)](_0x1bc956(0x135),_0x1bc956(0x195));else{console['error'](_0x1bc956(0x152),_0x12a0c9);return;}}return new Promise((_0x57b839,_0x4850e9)=>{const _0x43a2c9=_0x1bc956;(0x0,fluent_ffmpeg_1[_0x43a2c9(0x118)])(_0x12a0c9)[_0x43a2c9(0x1b8)](_0x43a2c9(0x23e))[_0x43a2c9(0x209)](_0x16589e)['on'](_0x43a2c9(0x10b),()=>{_0x57b839();})['on'](_0x43a2c9(0x11b),_0xa817c7=>{_0x4850e9(_0xa817c7);});});}});}catch(_0xf6bfd3){Sentry['setExtra']('Erro\x20media',{'companyId':_0x3688db,'ticket':_0xcc7f62,'contact':_0x30cc0e,'media':_0x1a62c3,'quotedMsg':_0x511458}),Sentry[_0x34061d(0x125)](_0xf6bfd3),logger_1['logger'][_0x34061d(0x11b)](_0xf6bfd3),console['log'](_0x363792);}const _0x3e04f2=(0x0,exports['getBodyMessage'])(_0x363792),_0x20acb3={'wid':_0x363792['key']['id'],'ticketId':_0xcc7f62['id'],'contactId':_0x363792['key'][_0x34061d(0x193)]?undefined:_0x30cc0e['id'],'body':_0x3e04f2||_0x1a62c3[_0x34061d(0x205)],'fromMe':_0x363792[_0x34061d(0x171)][_0x34061d(0x193)],'read':_0x363792['key'][_0x34061d(0x193)],'mediaUrl':_0x1a62c3['filename'],'mediaType':_0x1a62c3['mimetype'][_0x34061d(0x240)]('/')[0x0],'quotedMsgId':_0x511458?.['id'],'ack':_0x363792[_0x34061d(0x15b)],'remoteJid':_0x363792[_0x34061d(0x171)][_0x34061d(0x23d)],'participant':_0x363792[_0x34061d(0x171)]['participant'],'dataJson':JSON[_0x34061d(0x11f)](_0x363792),'ticketTrakingId':_0x233810?.['id'],'createdAt':new Date(Math[_0x34061d(0x13d)](getTimestampMessage(_0x363792[_0x34061d(0x18b)])*0x3e8))[_0x34061d(0xc6)](),'ticketImported':_0xcc7f62[_0x34061d(0x1db)],'isForwarded':_0x166d79};await _0xcc7f62['update']({'lastMessage':_0x3e04f2||_0x1a62c3[_0x34061d(0x205)]});const _0x385339=await(0x0,CreateMessageService_1[_0x34061d(0x118)])({'messageData':_0x20acb3,'companyId':_0x3688db});return!_0x363792[_0x34061d(0x171)][_0x34061d(0x193)]&&_0xcc7f62[_0x34061d(0x15b)]===_0x34061d(0x13f)&&(await _0xcc7f62['update']({'status':_0x34061d(0x183)}),await _0xcc7f62[_0x34061d(0x153)]({'include':[{'model':Queue_1[_0x34061d(0x118)],'as':_0x34061d(0x20d)},{'model':User_1[_0x34061d(0x118)],'as':'user'},{'model':Contact_1[_0x34061d(0x118)],'as':_0x34061d(0x17c)},{'model':Whatsapp_1[_0x34061d(0x118)],'as':'whatsapp'}]}),_0x5c6438['to'](_0x34061d(0x13f))[_0x34061d(0x199)](_0x34061d(0xeb)+_0x3688db+_0x34061d(0x180),{'action':'delete','ticket':_0xcc7f62,'ticketId':_0xcc7f62['id']}),_0x5c6438['to'](_0xcc7f62[_0x34061d(0x15b)])['to'](_0xcc7f62['id'][_0x34061d(0x21d)]())[_0x34061d(0x199)]('company-'+_0x3688db+_0x34061d(0x180),{'action':'update','ticket':_0xcc7f62,'ticketId':_0xcc7f62['id']})),_0x385339;}catch(_0x44d910){console[_0x34061d(0x1a6)](_0x44d910),logger_1['logger']['warn'](_0x34061d(0x120));}};exports[a627_0x530503(0x157)]=verifyMediaMessage;const verifyMessage=async(_0x97f259,_0x1d33ed,_0x57c296,_0x2013ef,_0x34c9a7,_0x252288)=>{const _0x1250e0=a627_0x530503,_0x2a9c64=(0x0,socket_1['getIO'])(),_0x21af48=await verifyQuotedMessage(_0x97f259),_0x11cfa9=(0x0,exports[_0x1250e0(0x194)])(_0x97f259),_0x4c9307=_0x1d33ed['companyId'],_0x4c0062={'wid':_0x97f259[_0x1250e0(0x171)]['id'],'ticketId':_0x1d33ed['id'],'contactId':_0x97f259[_0x1250e0(0x171)][_0x1250e0(0x193)]?undefined:_0x57c296['id'],'body':_0x11cfa9,'fromMe':_0x97f259[_0x1250e0(0x171)][_0x1250e0(0x193)],'mediaType':getTypeMessage(_0x97f259),'read':_0x97f259['key']['fromMe'],'quotedMsgId':_0x21af48?.['id'],'ack':_0x97f259['status'],'remoteJid':_0x97f259['key'][_0x1250e0(0x23d)],'participant':_0x97f259[_0x1250e0(0x171)][_0x1250e0(0x103)],'dataJson':JSON['stringify'](_0x97f259),'ticketTrakingId':_0x2013ef?.['id'],'isPrivate':![],'createdAt':new Date(Math[_0x1250e0(0x13d)](getTimestampMessage(_0x97f259['messageTimestamp'])*0x3e8))['toISOString'](),'ticketImported':_0x1d33ed[_0x1250e0(0x1db)],'isForwarded':_0x252288};await _0x1d33ed[_0x1250e0(0x198)]({'lastMessage':_0x11cfa9}),await(0x0,CreateMessageService_1[_0x1250e0(0x118)])({'messageData':_0x4c0062,'companyId':_0x4c9307}),!_0x97f259[_0x1250e0(0x171)][_0x1250e0(0x193)]&&_0x1d33ed['status']===_0x1250e0(0x13f)&&(await _0x1d33ed['update']({'status':_0x1250e0(0x183)}),await _0x1d33ed[_0x1250e0(0x153)]({'include':[{'model':Queue_1[_0x1250e0(0x118)],'as':_0x1250e0(0x20d)},{'model':User_1[_0x1250e0(0x118)],'as':_0x1250e0(0xde)},{'model':Contact_1[_0x1250e0(0x118)],'as':_0x1250e0(0x17c)},{'model':Whatsapp_1[_0x1250e0(0x118)],'as':'whatsapp'}]}),!_0x1d33ed[_0x1250e0(0x1db)]&&_0x2a9c64['to'](_0x1d33ed[_0x1250e0(0x15b)])['to'](_0x1d33ed['id'][_0x1250e0(0x21d)]())[_0x1250e0(0x199)](_0x1250e0(0xeb)+_0x4c9307+_0x1250e0(0x180),{'action':_0x1250e0(0x198),'ticket':_0x1d33ed,'ticketId':_0x1d33ed['id']}));};exports[a627_0x530503(0xe0)]=verifyMessage;const isValidMsg=_0xa58ddb=>{const _0x5eeff7=a627_0x530503;if(_0xa58ddb[_0x5eeff7(0x171)][_0x5eeff7(0x23d)]===_0x5eeff7(0xd3))return![];try{const _0x2105d5=getTypeMessage(_0xa58ddb);if(!_0x2105d5)return;const _0x12b2d1=_0x2105d5===_0x5eeff7(0x237)||_0x2105d5==='extendedTextMessage'||_0x2105d5===_0x5eeff7(0x221)||_0x2105d5===_0x5eeff7(0x124)||_0x2105d5==='imageMessage'||_0x2105d5===_0x5eeff7(0xfb)||_0x2105d5===_0x5eeff7(0x1e2)||_0x2105d5==='buttonsResponseMessage'||_0x2105d5===_0x5eeff7(0x24f)||_0x2105d5===_0x5eeff7(0x24b)||_0x2105d5===_0x5eeff7(0x1b6)||_0x2105d5===_0x5eeff7(0xd1)||_0x2105d5==='contactMessage'||_0x2105d5==='voiceMessage'||_0x2105d5===_0x5eeff7(0x1a9)||_0x2105d5===_0x5eeff7(0x25d)||_0x2105d5===_0x5eeff7(0x102)||_0x2105d5==='ephemeralMessage'||_0x2105d5===_0x5eeff7(0x12e)||_0x2105d5===_0x5eeff7(0x19b)||_0x2105d5===_0x5eeff7(0x19a)||_0x2105d5==='viewOnceMessage'||_0x2105d5===_0x5eeff7(0x1af)||_0x2105d5===_0x5eeff7(0x121)||_0x2105d5===_0x5eeff7(0x1f5);return!_0x12b2d1&&(logger_1[_0x5eeff7(0x1f8)][_0x5eeff7(0x1d4)](_0x5eeff7(0x20a)+_0x2105d5+'\x0a'+JSON[_0x5eeff7(0x11f)](_0xa58ddb?.[_0x5eeff7(0xfe)])),Sentry[_0x5eeff7(0x11a)](_0x5eeff7(0x215),{'BodyMsg':_0xa58ddb[_0x5eeff7(0xfe)],'msg':_0xa58ddb,'msgType':_0x2105d5}),Sentry[_0x5eeff7(0x125)](new Error(_0x5eeff7(0x1da)))),!!_0x12b2d1;}catch(_0x40e954){Sentry[_0x5eeff7(0x11a)]('Error\x20isValidMsg',{'msg':_0xa58ddb}),Sentry[_0x5eeff7(0x125)](_0x40e954);}};exports[a627_0x530503(0x19d)]=isValidMsg;const sendDialogflowAwswer=async(_0x2d59d5,_0x489d4c,_0x1a4ee1,_0x2fe1d6,_0x462850,_0x42977a,_0x20aabb)=>{const _0x395dcb=a627_0x530503,_0x4ead2c=await(0x0,CreateSessionDialogflow_1[_0x395dcb(0x217)])(_0x20aabb);if(_0x4ead2c===undefined)return;_0x2d59d5['presenceSubscribe'](_0x2fe1d6[_0x395dcb(0x23d)]),await(0x0,baileys_1['delay'])(0x1f4);let _0x5075a0=await(0x0,QueryDialogflow_1[_0x395dcb(0x253)])(_0x4ead2c,_0x20aabb[_0x395dcb(0x1c2)],_0x2fe1d6[_0x395dcb(0x23d)],(0x0,exports['getBodyMessage'])(_0x1a4ee1),_0x20aabb[_0x395dcb(0x11c)],_0x462850);if(!_0x5075a0){_0x2d59d5[_0x395dcb(0x228)](_0x395dcb(0x173),_0x2fe1d6[_0x395dcb(0x23d)]);const _0x8514d0=(0x0,Mustache_1['default'])(_0x395dcb(0x21c)+_0x20aabb?.[_0x395dcb(0x12a)]+_0x395dcb(0x1e0));await(0x0,baileys_1[_0x395dcb(0xfa)])(0x3e8),await _0x2d59d5[_0x395dcb(0x228)](_0x395dcb(0xe1),_0x2fe1d6['remoteJid']);const _0x1c1ae0=await _0x2d59d5['sendMessage'](_0x2fe1d6[_0x395dcb(0x208)]+_0x395dcb(0x1ec),{'text':_0x8514d0});await(0x0,exports['verifyMessage'])(_0x1c1ae0,_0x489d4c,_0x2fe1d6);return;}_0x5075a0[_0x395dcb(0x24c)]&&await _0x489d4c[_0x395dcb(0x198)]({'contactId':_0x489d4c[_0x395dcb(0x17c)]['id'][_0x395dcb(0x21d)](),'useIntegration':![]});const _0x487ab9=_0x5075a0[_0x395dcb(0xce)][_0x395dcb(0x1cd)]?.[_0x395dcb(0xe5)]??undefined,_0x284e7f=_0x5075a0[_0x395dcb(0xce)]['react']?.[_0x395dcb(0xe5)]??undefined,_0x5abff3=_0x5075a0['encodedAudio'][_0x395dcb(0x21d)](_0x395dcb(0x1e1))??undefined;_0x2d59d5['sendPresenceUpdate'](_0x395dcb(0x173),_0x2fe1d6[_0x395dcb(0x23d)]),await(0x0,baileys_1[_0x395dcb(0xfa)])(0x1f4);let _0x3adf23;for(let _0x29b127 of _0x5075a0['responses']){_0x3adf23=_0x29b127[_0x395dcb(0x1b5)][_0x395dcb(0x1b5)][0x0]?_0x29b127[_0x395dcb(0x1b5)][_0x395dcb(0x1b5)][0x0]:_0x3adf23;}for(let _0x391e11 of _0x5075a0[_0x395dcb(0x133)]){_0x391e11[_0x395dcb(0x1b5)]&&await sendDelayedMessages(_0x2d59d5,_0x489d4c,_0x2fe1d6,_0x391e11[_0x395dcb(0x1b5)]['text'][0x0],_0x3adf23,_0x5abff3,_0x20aabb);}};async function sendDelayedMessages(_0x19b941,_0x46e609,_0x145db9,_0x5bc6c,_0x56f7a2,_0x125b99,_0x159e27){const _0x1fc392=a627_0x530503,_0x88596=_0x46e609[_0x1fc392(0x259)],_0xebc1e=await(0x0,ShowWhatsAppService_1[_0x1fc392(0x118)])(_0x19b941['id'],_0x88596),_0x56c306=_0xebc1e[_0x1fc392(0x15c)]['replace'](/[_*]/g,''),_0x55319e=await _0x19b941['sendMessage'](_0x145db9[_0x1fc392(0x208)]+_0x1fc392(0x1ec),{'text':_0x1fc392(0x21c)+_0x159e27?.[_0x1fc392(0x12a)]+_0x1fc392(0xc8)+_0x5bc6c});await(0x0,exports['verifyMessage'])(_0x55319e,_0x46e609,_0x145db9);if(_0x5bc6c!=_0x56f7a2)await(0x0,baileys_1[_0x1fc392(0xfa)])(0x1f4),_0x19b941[_0x1fc392(0x228)](_0x1fc392(0x173),_0x145db9[_0x1fc392(0x23d)]);else _0x125b99&&(_0x19b941[_0x1fc392(0x228)]('recording',_0x145db9[_0x1fc392(0x23d)]),await(0x0,baileys_1['delay'])(0x1f4),_0x56c306&&_0x5bc6c[_0x1fc392(0x101)](_0x56c306)&&(await(0x0,baileys_1['delay'])(0x3e8),setTimeout(async()=>{const _0x3ab5e2=_0x1fc392;await _0x46e609[_0x3ab5e2(0x198)]({'contactId':_0x46e609[_0x3ab5e2(0x17c)]['id'][_0x3ab5e2(0x21d)](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1[_0x3ab5e2(0x118)])({'ticketId':_0x46e609['id'],'ticketData':{'status':_0x3ab5e2(0x13f)},'companyId':_0x88596});},0xbb8)));}const verifyQueue=async(_0x558ad9,_0xf5d0db,_0x4fdfe4,_0x359e13,_0x2dcbf4,_0x260d9a)=>{const _0x418be9=a627_0x530503,_0x1f7dfc=_0x4fdfe4[_0x418be9(0x259)],{queues:_0x52352b,greetingMessage:_0xa85d98,maxUseBotQueues:_0x51efb6,timeUseBotQueues:_0x2d4c7a}=await(0x0,ShowWhatsAppService_1['default'])(_0x558ad9['id'],_0x1f7dfc);let _0x120d5b=![];_0x52352b[_0x418be9(0x16f)]===0x1&&(_0x120d5b=_0x52352b[0x0]?.[_0x418be9(0xdf)][_0x418be9(0x16f)]>0x1);const _0x248a1b=_0x2dcbf4[_0x418be9(0x1d1)]==='enabled';if(_0x52352b[_0x418be9(0x16f)]===0x1&&!_0x120d5b){const _0x307742=_0x2dcbf4[_0x418be9(0x22e)]===_0x418be9(0x22b)||![];if(!_0xf5d0db['key'][_0x418be9(0x193)]&&!_0x4fdfe4[_0x418be9(0x181)]&&_0x52352b[0x0]['integrationId']){const _0x62638f=await(0x0,ShowQueueIntegrationService_1[_0x418be9(0x118)])(_0x52352b[0x0]['integrationId'],_0x1f7dfc);await(0x0,exports[_0x418be9(0x12b)])(_0xf5d0db,_0x558ad9,_0x1f7dfc,_0x62638f,_0x4fdfe4),await _0x4fdfe4[_0x418be9(0x198)]({'useIntegration':!![],'integrationId':_0x62638f['id']});}if(_0xa85d98[_0x418be9(0x16f)]>0x1&&_0x307742){const _0x2dbb79=(0x0,Mustache_1[_0x418be9(0x118)])(''+_0xa85d98,_0x4fdfe4);if(_0x4fdfe4[_0x418be9(0xd4)]['greetingMediaAttachment']!==null){const _0x3878a9=path_1[_0x418be9(0x118)]['resolve'](_0x418be9(0x179),'company'+_0x1f7dfc,_0x4fdfe4['whatsapp'][_0x418be9(0x178)]),_0x4da048=_0x4fdfe4[_0x418be9(0xd4)][_0x418be9(0x178)],_0x75165d=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x4da048,_0x3878a9,String(_0x1f7dfc),_0x2dbb79),_0x39a369=(0x0,Debounce_1['debounce'])(async()=>{const _0x465fef=_0x418be9,_0x282c06=await _0x558ad9[_0x465fef(0x251)](_0x4fdfe4[_0x465fef(0x17c)][_0x465fef(0x208)]+'@'+(_0x4fdfe4['isGroup']?_0x465fef(0x23b):_0x465fef(0x1b0)),{..._0x75165d});await(0x0,exports[_0x465fef(0x157)])(_0x282c06,_0x4fdfe4,_0x359e13,_0x260d9a);},0x3e8,_0x4fdfe4['id']);_0x39a369();}else await _0x558ad9[_0x418be9(0x251)](_0x359e13[_0x418be9(0x208)]+'@'+(_0x4fdfe4[_0x418be9(0x181)]?_0x418be9(0x23b):'s.whatsapp.net'),{'text':_0x2dbb79});}if(!(0x0,lodash_1[_0x418be9(0x104)])(_0x52352b[0x0][_0x418be9(0x206)]))try{const _0x3c14a9=path_1[_0x418be9(0x118)][_0x418be9(0x155)](__dirname,'..','..','..',_0x418be9(0x179)),_0x5a018e=await(0x0,ShowService_1[_0x418be9(0x118)])(_0x52352b[0x0][_0x418be9(0x206)],_0x4fdfe4[_0x418be9(0x259)]),_0x244c1a=path_1['default']['resolve'](_0x3c14a9,_0x418be9(0x19f)+_0x4fdfe4[_0x418be9(0x259)],_0x418be9(0x1cf),String(_0x5a018e['id']));for(const [_0x20bc37,_0x46ad26]of _0x5a018e[_0x418be9(0x13e)]['entries']()){const _0xfe40a5={'fieldname':'medias','originalname':_0x46ad26[_0x418be9(0x176)],'encoding':_0x418be9(0x1ab),'mimetype':_0x46ad26[_0x418be9(0x191)],'filename':_0x46ad26[_0x418be9(0x176)],'path':path_1[_0x418be9(0x118)][_0x418be9(0x155)](_0x244c1a,_0x46ad26[_0x418be9(0x176)])};await(0x0,SendWhatsAppMedia_1[_0x418be9(0x118)])({'media':_0xfe40a5,'ticket':_0x4fdfe4,'body':_0x46ad26['name'],'isPrivate':![],'isForwarded':![]});};}catch(_0x1dfe5c){logger_1[_0x418be9(0x1f8)][_0x418be9(0x169)](_0x1dfe5c);}if(_0x52352b[0x0][_0x418be9(0x16d)]){await(0x0,UpdateTicketService_1[_0x418be9(0x118)])({'ticketData':{'status':_0x418be9(0x13f),'queueId':_0x52352b[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});return;}else await(0x0,UpdateTicketService_1[_0x418be9(0x118)])({'ticketData':{'queueId':_0x52352b[0x0]['id']},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});const _0x4c56d8=await Ticket_1['default'][_0x418be9(0x21e)]({'where':{'userId':null,'status':_0x418be9(0x183),'companyId':_0x1f7dfc,'queueId':_0x52352b[0x0]['id'],'isGroup':![]}});if(_0x248a1b){const _0x2fa88f=_0x4c56d8[_0x418be9(0x23f)]===0x0?0x1:_0x4c56d8[_0x418be9(0x23f)],_0x420b6d=_0x418be9(0x231)+_0x2fa88f+'*',_0xf169d6=(0x0,Mustache_1['default'])(''+_0x420b6d,_0x4fdfe4),_0x18a65f=(0x0,Debounce_1[_0x418be9(0x106)])(async()=>{const _0x1c7a7b=_0x418be9;await _0x558ad9[_0x1c7a7b(0x251)](_0x359e13[_0x1c7a7b(0x208)]+'@'+(_0x4fdfe4[_0x1c7a7b(0x181)]?_0x1c7a7b(0x23b):_0x1c7a7b(0x1b0)),{'text':_0xf169d6});},0xbb8,_0x4fdfe4['id']);_0x18a65f();}return;}if(_0x359e13[_0x418be9(0x249)])return;let _0x578cee='';if(_0x4fdfe4[_0x418be9(0x15b)]!==_0x418be9(0x25c))_0x578cee=_0xf5d0db?.[_0x418be9(0xfe)]?.['buttonsResponseMessage']?.[_0x418be9(0x1f0)]||_0xf5d0db?.['message']?.[_0x418be9(0x19b)]?.[_0x418be9(0x1ee)][_0x418be9(0x222)]||(0x0,exports[_0x418be9(0x194)])(_0xf5d0db);else{if(!(0x0,lodash_1[_0x418be9(0x104)])(_0x4fdfe4[_0x418be9(0xc5)]))await _0x4fdfe4[_0x418be9(0x198)]({'status':_0x418be9(0x183)});await _0x4fdfe4[_0x418be9(0x153)]();}if(_0x578cee[_0x418be9(0xe9)]()=='sair'){const _0x4b1e9d={'isBot':![],'status':_0x418be9(0x13f),'sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x418be9(0x118)])({'ticketData':_0x4b1e9d,'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});return;}let _0x17210a=_0x120d5b&&_0x52352b[_0x418be9(0x16f)]===0x1?_0x52352b[+_0x578cee]:_0x52352b[+_0x578cee-0x1];if(!_0xf5d0db['key'][_0x418be9(0x193)]&&!_0x4fdfe4[_0x418be9(0x181)]&&_0x17210a?.[_0x418be9(0xef)]){const _0x517068=await(0x0,ShowQueueIntegrationService_1[_0x418be9(0x118)])(_0x17210a[_0x418be9(0xef)],_0x1f7dfc);await(0x0,exports[_0x418be9(0x12b)])(_0xf5d0db,_0x558ad9,_0x1f7dfc,_0x517068,_0x4fdfe4),await _0x4fdfe4['update']({'useIntegration':!![],'integrationId':_0x517068['id']});}const _0x182cce=_0x2dcbf4?.['chatBotType']||_0x418be9(0x1b5);let _0x1059cb;if(_0x17210a)try{const _0x403593=await(0x0,ListUserQueueServices_1[_0x418be9(0x118)])(_0x17210a['id']);_0x403593[_0x418be9(0x212)]>-0x1&&(_0x1059cb=_0x403593['userId']);}catch(_0x226fdc){console['error'](_0x226fdc);}const _0x34d6a1=async()=>{const _0x353db0=_0x418be9;if(_0x17210a||_0x52352b['length']===0x1&&_0x120d5b){if(_0x52352b[_0x353db0(0x16f)]===0x1)_0x17210a=_0x52352b[0x0];const _0x30334b=await Queue_1[_0x353db0(0x118)]['findByPk'](_0x17210a['id']);let _0x3e9994;_0x2dcbf4?.[_0x353db0(0x1bf)]===_0x353db0(0x20d)&&(_0x3e9994=await(0x0,VerifyCurrentSchedule_1[_0x353db0(0x118)])(_0x1f7dfc,_0x30334b['id'],0x0));if(_0x2dcbf4?.[_0x353db0(0x1bf)]==='queue'&&!(0x0,lodash_1['isNil'])(_0x3e9994)&&(!_0x3e9994||_0x3e9994['inActivity']===![])&&(!_0x4fdfe4['isGroup']||_0x4fdfe4[_0x353db0(0xd4)]?.[_0x353db0(0xc7)]===_0x353db0(0x22b))){const _0x4d30ba=_0x30334b[_0x353db0(0x174)];if(_0x4d30ba!==''){const _0x38e725=(0x0,Mustache_1['default'])(''+_0x4d30ba,_0x4fdfe4),_0x1f20a9=(0x0,Debounce_1[_0x353db0(0x106)])(async()=>{const _0x1c4464=_0x353db0;await _0x558ad9[_0x1c4464(0x251)](_0x4fdfe4['contact'][_0x1c4464(0x208)]+'@'+(_0x4fdfe4['isGroup']?_0x1c4464(0x23b):'s.whatsapp.net'),{'text':_0x38e725});},0x3e8,_0x4fdfe4['id']);_0x1f20a9(),await _0x4fdfe4[_0x353db0(0x198)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x4fdfe4['amountUsedBotQueues']+0x1});return;}await _0x4fdfe4[_0x353db0(0x198)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x4fdfe4[_0x353db0(0x1fb)]+0x1});return;}await(0x0,UpdateTicketService_1[_0x353db0(0x118)])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x17210a['id']},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});if(_0x17210a[_0x353db0(0xdf)][_0x353db0(0x16f)]>0x0&&!_0x4fdfe4[_0x353db0(0x181)]){let _0x459d29='';_0x17210a[_0x353db0(0xdf)][_0x353db0(0xd5)]((_0x98367f,_0x353a81)=>{const _0x6e13e3=_0x353db0;_0x459d29+='*[\x20'+(_0x353a81+0x1)+'\x20]*\x20-\x20'+_0x98367f[_0x6e13e3(0x12a)]+'\x0a';});const _0x4da64f=(0x0,Mustache_1[_0x353db0(0x118)])('â€Ž\x20'+_0x17210a[_0x353db0(0x1e7)]+'\x0a\x0a'+_0x459d29+_0x353db0(0x142),_0x4fdfe4),_0x59d99a=await _0x558ad9[_0x353db0(0x251)](_0x359e13[_0x353db0(0x208)]+'@'+(_0x4fdfe4[_0x353db0(0x181)]?_0x353db0(0x23b):_0x353db0(0x1b0)),{'text':_0x4da64f});await(0x0,exports[_0x353db0(0xe0)])(_0x59d99a,_0x4fdfe4,_0x359e13,_0x260d9a),_0x2dcbf4?.[_0x353db0(0x1d8)]==='enabled'&&await(0x0,UpdateTicketService_1[_0x353db0(0x118)])({'ticketData':{'userId':_0x1059cb},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});}if(!_0x17210a[_0x353db0(0xdf)][_0x353db0(0x16f)]&&_0x17210a[_0x353db0(0x1e7)][_0x353db0(0x16f)]!==0x0){const _0x502af8=(0x0,Mustache_1[_0x353db0(0x118)])('â€Ž'+_0x17210a[_0x353db0(0x1e7)],_0x4fdfe4),_0x1400f0=await _0x558ad9['sendMessage'](_0x359e13[_0x353db0(0x208)]+'@'+(_0x4fdfe4[_0x353db0(0x181)]?_0x353db0(0x23b):_0x353db0(0x1b0)),{'text':_0x502af8});await(0x0,exports[_0x353db0(0xe0)])(_0x1400f0,_0x4fdfe4,_0x359e13,_0x260d9a);}if(!(0x0,lodash_1[_0x353db0(0x104)])(_0x17210a[_0x353db0(0x206)]))try{const _0x1fa898=path_1[_0x353db0(0x118)]['resolve'](__dirname,'..','..','..',_0x353db0(0x179)),_0x583b30=await(0x0,ShowService_1[_0x353db0(0x118)])(_0x17210a['fileListId'],_0x4fdfe4[_0x353db0(0x259)]),_0x22055f=path_1[_0x353db0(0x118)][_0x353db0(0x155)](_0x1fa898,'company'+_0x4fdfe4[_0x353db0(0x259)],_0x353db0(0x1cf),String(_0x583b30['id']));for(const [_0xe94d7f,_0x388993]of _0x583b30[_0x353db0(0x13e)]['entries']()){const _0x9db29c={'fieldname':_0x353db0(0x1e6),'originalname':_0x388993[_0x353db0(0x176)],'encoding':_0x353db0(0x1ab),'mimetype':_0x388993['mediaType'],'filename':_0x388993[_0x353db0(0x176)],'path':path_1[_0x353db0(0x118)][_0x353db0(0x155)](_0x22055f,_0x388993[_0x353db0(0x176)])};await(0x0,SendWhatsAppMedia_1[_0x353db0(0x118)])({'media':_0x9db29c,'ticket':_0x4fdfe4,'body':_0x388993[_0x353db0(0x12a)],'isPrivate':![],'isForwarded':![]});};await(0x0,baileys_1[_0x353db0(0xfa)])(0x7d0);}catch(_0x5baf03){logger_1[_0x353db0(0x1f8)][_0x353db0(0x169)](_0x5baf03);}if(_0x17210a[_0x353db0(0x16d)]){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x353db0(0x13f),'queueId':_0x17210a['id'],'sendFarewellMessage':![]},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc}),await(0x0,CreateLogTicketService_1[_0x353db0(0x118)])({'ticketId':_0x4fdfe4['id'],'type':_0x353db0(0x13f),'queueId':_0x17210a['id']});return;}const _0x53f41b=await Ticket_1['default'][_0x353db0(0x21e)]({'where':{'userId':null,'status':_0x353db0(0x183),'companyId':_0x1f7dfc,'queueId':_0x17210a['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1[_0x353db0(0x118)])({'ticketId':_0x4fdfe4['id'],'type':_0x353db0(0x20d),'queueId':_0x17210a['id']});if(_0x248a1b&&!_0x17210a[_0x353db0(0xdf)][_0x353db0(0x16f)]){const _0x30966f=_0x53f41b[_0x353db0(0x23f)]===0x0?0x1:_0x53f41b[_0x353db0(0x23f)],_0x19f1af=_0x353db0(0x231)+_0x30966f+'*',_0x3bbf54=(0x0,Mustache_1[_0x353db0(0x118)])(''+_0x19f1af,_0x4fdfe4),_0x76c491=(0x0,Debounce_1['debounce'])(async()=>{const _0x4cab4f=_0x353db0;await _0x558ad9[_0x4cab4f(0x251)](_0x359e13[_0x4cab4f(0x208)]+'@'+(_0x4fdfe4[_0x4cab4f(0x181)]?_0x4cab4f(0x23b):_0x4cab4f(0x1b0)),{'text':_0x3bbf54});},0xbb8,_0x4fdfe4['id']);_0x76c491();}}else{if(_0x4fdfe4[_0x353db0(0x181)])return;if(_0x51efb6&&_0x51efb6!==0x0&&_0x4fdfe4['amountUsedBotQueues']>=_0x51efb6)return;const _0x4acf73=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});let _0x293e7d=new Date(),_0xeb8e85=new Date();if(_0x4acf73[_0x353db0(0x116)]!==null){_0x293e7d[_0x353db0(0x182)](_0x4acf73[_0x353db0(0x116)][_0x353db0(0x13a)]()+Number(_0x2d4c7a));if(_0x4acf73[_0x353db0(0x116)]!==null&&_0xeb8e85<_0x293e7d&&_0x2d4c7a!=='0'&&_0x4fdfe4[_0x353db0(0x1fb)]!==0x0)return;}await _0x4acf73['update']({'chatbotAt':null}),_0x558ad9[_0x353db0(0x1fc)](_0x359e13['remoteJid']);let _0x4259c3='';_0x558ad9[_0x353db0(0x228)](_0x353db0(0x173),_0x359e13[_0x353db0(0x23d)]),_0x52352b[_0x353db0(0xd5)]((_0x4904a6,_0x3eb6da)=>{const _0x5e62b5=_0x353db0;_0x4259c3+=_0x5e62b5(0x257)+(_0x3eb6da+0x1)+'\x20]*\x20-\x20'+_0x4904a6[_0x5e62b5(0x12a)]+'\x0a';}),_0x4259c3+='\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento';const _0x5986a5=(0x0,Mustache_1[_0x353db0(0x118)])('â€Ž'+_0xa85d98+'\x0a\x0a'+_0x4259c3,_0x4fdfe4);await(0x0,CreateLogTicketService_1[_0x353db0(0x118)])({'ticketId':_0x4fdfe4['id'],'type':_0x353db0(0x1d2)}),await(0x0,baileys_1[_0x353db0(0xfa)])(0x3e8),await _0x558ad9[_0x353db0(0x228)](_0x353db0(0xe1),_0x359e13['remoteJid']);if(_0x4fdfe4[_0x353db0(0xd4)][_0x353db0(0x178)]!==null){const _0x389199=path_1[_0x353db0(0x118)][_0x353db0(0x155)](_0x353db0(0x179),_0x353db0(0x19f)+_0x1f7dfc,_0x4fdfe4[_0x353db0(0xd4)][_0x353db0(0x178)]),_0x24035c=_0x4fdfe4[_0x353db0(0xd4)]['greetingMediaAttachment'],_0x187536=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x24035c,_0x389199,String(_0x1f7dfc),_0x5986a5),_0x135969=(0x0,Debounce_1[_0x353db0(0x106)])(async()=>{const _0x5f37c=_0x353db0;let _0xf35e7b=await _0x558ad9['sendMessage'](_0x4fdfe4[_0x5f37c(0x17c)][_0x5f37c(0x208)]+'@'+(_0x4fdfe4[_0x5f37c(0x181)]?'g.us':_0x5f37c(0x1b0)),{..._0x187536});await(0x0,exports[_0x5f37c(0x157)])(_0xf35e7b,_0x4fdfe4,_0x359e13,_0x4acf73);},0x3e8,_0x4fdfe4['id']);_0x135969(),await(0x0,UpdateTicketService_1[_0x353db0(0x118)])({'ticketData':{'amountUsedBotQueues':_0x4fdfe4[_0x353db0(0x1fb)]+0x1},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});return;}else{const _0x1c1e05=(0x0,Debounce_1['debounce'])(async()=>{const _0xd768ed=_0x353db0,_0x65376f=await _0x558ad9[_0xd768ed(0x251)](_0x359e13[_0xd768ed(0x208)]+'@'+(_0x4fdfe4[_0xd768ed(0x181)]?_0xd768ed(0x23b):_0xd768ed(0x1b0)),{'text':_0x5986a5});(0x0,exports[_0xd768ed(0xe0)])(_0x65376f,_0x4fdfe4,_0x359e13,_0x4acf73);},0x3e8,_0x4fdfe4['id']);await(0x0,UpdateTicketService_1[_0x353db0(0x118)])({'ticketData':{'amountUsedBotQueues':_0x4fdfe4['amountUsedBotQueues']+0x1},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc}),_0x1c1e05();}}},_0x436131=async()=>{const _0x37cf27=_0x418be9;if(_0x17210a){await(0x0,UpdateTicketService_1[_0x37cf27(0x118)])({'ticketData':{'queueId':_0x17210a['id']},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});if(_0x17210a['chatbots']['length']>0x0){const _0x29ba1d=[];_0x17210a[_0x37cf27(0xdf)][_0x37cf27(0xd5)]((_0x4f93c9,_0x23e701)=>{const _0x12bba6=_0x37cf27;_0x29ba1d['push']({'buttonId':''+(_0x23e701+0x1),'buttonText':{'displayText':_0x4f93c9[_0x12bba6(0x12a)]},'type':0x1});});const _0x155f88={'text':(0x0,Mustache_1[_0x37cf27(0x118)])(''+_0x17210a[_0x37cf27(0x1e7)],_0x4fdfe4),'buttons':_0x29ba1d,'headerType':0x4},_0x106614=await _0x558ad9[_0x37cf27(0x251)](_0x359e13[_0x37cf27(0x208)]+'@'+(_0x4fdfe4[_0x37cf27(0x181)]?_0x37cf27(0x23b):'s.whatsapp.net'),_0x155f88);await(0x0,exports[_0x37cf27(0xe0)])(_0x106614,_0x4fdfe4,_0x359e13,_0x260d9a);}if(!_0x17210a[_0x37cf27(0xdf)][_0x37cf27(0x16f)]){const _0x290af9=(0x0,Mustache_1['default'])(''+_0x17210a[_0x37cf27(0x1e7)],_0x4fdfe4),_0x5e4e1d=await _0x558ad9[_0x37cf27(0x251)](_0x359e13[_0x37cf27(0x208)]+'@'+(_0x4fdfe4[_0x37cf27(0x181)]?'g.us':'s.whatsapp.net'),{'text':_0x290af9});await(0x0,exports['verifyMessage'])(_0x5e4e1d,_0x4fdfe4,_0x359e13,_0x260d9a);}}else{const _0x1cfaa7=[];_0x52352b[_0x37cf27(0xd5)]((_0x4ae349,_0x42aee2)=>{const _0x8c7443=_0x37cf27;_0x1cfaa7[_0x8c7443(0x18a)]({'buttonId':''+(_0x42aee2+0x1),'buttonText':{'displayText':_0x4ae349['name']},'type':0x4});});const _0x279279={'text':(0x0,Mustache_1[_0x37cf27(0x118)])(''+_0xa85d98,_0x4fdfe4),'footer':'','buttons':_0x1cfaa7,'headerType':0x4},_0x30dd1f=await _0x558ad9['sendMessage'](_0x359e13[_0x37cf27(0x208)]+'@'+(_0x4fdfe4[_0x37cf27(0x181)]?_0x37cf27(0x23b):'s.whatsapp.net'),_0x279279);await(0x0,exports[_0x37cf27(0xe0)])(_0x30dd1f,_0x4fdfe4,_0x359e13,_0x260d9a),await(0x0,UpdateTicketService_1[_0x37cf27(0x118)])({'ticketData':{'amountUsedBotQueues':_0x4fdfe4['amountUsedBotQueues']+0x1},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});}},_0x23c36c=async()=>{const _0x38dcab=_0x418be9;if(_0x17210a){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x17210a['id']},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});if(_0x17210a[_0x38dcab(0xdf)][_0x38dcab(0x16f)]>0x0){const _0x3d9438=[];_0x17210a['chatbots'][_0x38dcab(0xd5)]((_0x2d7d38,_0xbb119)=>{const _0x533220=_0x38dcab;_0x3d9438[_0x533220(0x18a)]({'title':_0x2d7d38[_0x533220(0x12a)],'rowId':''+(_0xbb119+0x1)});});const _0x472924=[{'title':'Menu','rows':_0x3d9438}],_0x4264b9={'text':(0x0,Mustache_1['default'])(''+_0x17210a[_0x38dcab(0x1e7)],_0x4fdfe4),'buttonText':_0x38dcab(0xcb),'sections':_0x472924},_0x33b3a2=await _0x558ad9[_0x38dcab(0x251)](_0x359e13[_0x38dcab(0x208)]+'@'+(_0x4fdfe4['isGroup']?_0x38dcab(0x23b):'s.whatsapp.net'),_0x4264b9);await(0x0,exports[_0x38dcab(0xe0)])(_0x33b3a2,_0x4fdfe4,_0x359e13,_0x260d9a);}if(!_0x17210a['chatbots']['length']){const _0x563a72=(0x0,Mustache_1['default'])(''+_0x17210a[_0x38dcab(0x1e7)],_0x4fdfe4),_0x5c736e=await _0x558ad9[_0x38dcab(0x251)](_0x359e13[_0x38dcab(0x208)]+'@'+(_0x4fdfe4[_0x38dcab(0x181)]?_0x38dcab(0x23b):'s.whatsapp.net'),{'text':_0x563a72});await(0x0,exports[_0x38dcab(0xe0)])(_0x5c736e,_0x4fdfe4,_0x359e13,_0x260d9a);}}else{const _0x33838e=[];_0x52352b[_0x38dcab(0xd5)]((_0xbfb01e,_0x4a8959)=>{const _0x4dd253=_0x38dcab;_0x33838e[_0x4dd253(0x18a)]({'title':_0xbfb01e[_0x4dd253(0x12a)],'rowId':''+(_0x4a8959+0x1)});});const _0x4c4ced=[{'title':'Menu','rows':_0x33838e}],_0x50692f={'text':(0x0,Mustache_1[_0x38dcab(0x118)])(''+_0xa85d98,_0x4fdfe4),'buttonText':_0x38dcab(0xcb),'sections':_0x4c4ced},_0x3ad617=await _0x558ad9[_0x38dcab(0x251)](_0x359e13[_0x38dcab(0x208)]+'@'+(_0x4fdfe4[_0x38dcab(0x181)]?_0x38dcab(0x23b):_0x38dcab(0x1b0)),_0x50692f);await(0x0,exports[_0x38dcab(0xe0)])(_0x3ad617,_0x4fdfe4,_0x359e13,_0x260d9a),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':_0x4fdfe4[_0x38dcab(0x1fb)]+0x1},'ticketId':_0x4fdfe4['id'],'companyId':_0x1f7dfc});}};if(_0x182cce===_0x418be9(0x1b5))return _0x34d6a1();if(_0x182cce===_0x418be9(0x10c)&&_0x52352b['length']>0x3)return _0x34d6a1();if(_0x182cce==='button'&&_0x52352b[_0x418be9(0x16f)]<=0x3)return _0x436131();if(_0x182cce==='list')return _0x23c36c();},verifyRating=_0x5257a8=>{const _0x452f4e=a627_0x530503;if(_0x5257a8&&_0x5257a8[_0x452f4e(0x184)]===null&&_0x5257a8[_0x452f4e(0x137)]!==null&&_0x5257a8[_0x452f4e(0x212)]!==null&&_0x5257a8[_0x452f4e(0x239)]===null)return!![];return![];};exports[a627_0x530503(0x1df)]=verifyRating;const handleRating=async(_0x5f07eb,_0x546a1d,_0x4a1d7c)=>{const _0x1244e0=a627_0x530503,_0x421243=(0x0,socket_1['getIO'])(),_0x16f0d2=_0x546a1d[_0x1244e0(0x259)],{complationMessage:_0x2c9014}=await(0x0,ShowWhatsAppService_1[_0x1244e0(0x118)])(_0x546a1d['whatsappId'],_0x16f0d2);let _0x15715a=_0x5f07eb;_0x5f07eb<0x0&&(_0x15715a=0x0);_0x5f07eb>0xa&&(_0x15715a=0xa);await UserRating_1[_0x1244e0(0x118)][_0x1244e0(0x145)]({'ticketId':_0x4a1d7c[_0x1244e0(0x1c3)],'companyId':_0x4a1d7c[_0x1244e0(0x259)],'userId':_0x4a1d7c[_0x1244e0(0x212)],'rate':_0x15715a});if(!(0x0,lodash_1[_0x1244e0(0x104)])(_0x2c9014)&&_0x2c9014!==''&&!_0x546a1d[_0x1244e0(0x181)]){const _0x1dba1b=(0x0,Mustache_1[_0x1244e0(0x118)])('â€Ž'+_0x2c9014,_0x546a1d);if(_0x546a1d[_0x1244e0(0x1be)]===_0x1244e0(0xd4)){const _0x501cf5=await(0x0,SendWhatsAppMessage_1[_0x1244e0(0x118)])({'body':_0x1dba1b,'ticket':_0x546a1d});await(0x0,exports[_0x1244e0(0xe0)])(_0x501cf5,_0x546a1d,_0x546a1d[_0x1244e0(0x17c)],_0x4a1d7c);}['facebook','instagram']['includes'](_0x546a1d[_0x1244e0(0x1be)])&&await(0x0,sendFacebookMessage_1[_0x1244e0(0x118)])({'body':_0x1dba1b,'ticket':_0x546a1d});}await _0x546a1d[_0x1244e0(0x198)]({'chatbot':null,'status':'closed','amountUseBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1['default'])({'userId':_0x546a1d[_0x1244e0(0x212)],'queueId':_0x546a1d['queueId'],'ticketId':_0x546a1d['id'],'type':_0x1244e0(0x13f)}),_0x421243['to'](_0x1244e0(0xf5))[_0x1244e0(0x199)](_0x1244e0(0xeb)+_0x16f0d2+'-ticket',{'action':_0x1244e0(0xe8),'ticket':_0x546a1d,'ticketId':_0x546a1d['id']}),_0x421243['to'](_0x546a1d[_0x1244e0(0x15b)])['to'](_0x546a1d['id'][_0x1244e0(0x21d)]())['emit']('company-'+_0x16f0d2+_0x1244e0(0x180),{'action':'update','ticket':_0x546a1d,'ticketId':_0x546a1d['id']});};exports[a627_0x530503(0x165)]=handleRating;const sanitizeName=_0x3f62a8=>{const _0x1334ac=a627_0x530503;let _0x10b6ac=_0x3f62a8['split']('\x20')[0x0];return _0x10b6ac=_0x10b6ac['replace'](/[^a-zA-Z0-9]/g,''),_0x10b6ac[_0x1334ac(0x22c)](0x0,0x3c);},deleteFileSync=_0x160afe=>{const _0x834d50=a627_0x530503;try{fs_2[_0x834d50(0x118)][_0x834d50(0x247)](_0x160afe);}catch(_0x153782){console[_0x834d50(0x11b)](_0x834d50(0x1f9),_0x153782);}},convertTextToSpeechAndSaveToFile=(_0x4223b7,_0x59c743,_0xd8c2c9,_0x3bebb4,_0x34b796='pt-BR-FabioNeural',_0x3f3883=a627_0x530503(0x23e))=>{return new Promise((_0x4b7223,_0x3a4611)=>{const _0xf28615=a627_0x94d3,_0x47d0b0=microsoft_cognitiveservices_speech_sdk_1['SpeechConfig'][_0xf28615(0x1dc)](_0xd8c2c9,_0x3bebb4);_0x47d0b0[_0xf28615(0x214)]=_0x34b796;const _0x7c53d1=microsoft_cognitiveservices_speech_sdk_1[_0xf28615(0x14d)][_0xf28615(0x1d7)](_0x59c743+'.wav'),_0x348cd2=new microsoft_cognitiveservices_speech_sdk_1[(_0xf28615(0x17d))](_0x47d0b0,_0x7c53d1);_0x348cd2[_0xf28615(0xee)](_0x4223b7,_0x5eb3df=>{const _0x1c959d=_0xf28615;_0x5eb3df?convertWavToAnotherFormat(_0x59c743+_0x1c959d(0x12f),_0x59c743+'.'+_0x3f3883,_0x3f3883)['then'](_0x187095=>{_0x4b7223();})['catch'](_0x3e3630=>{const _0x483972=_0x1c959d;console[_0x483972(0x11b)](_0x3e3630),_0x3a4611(_0x3e3630);}):_0x3a4611(new Error(_0x1c959d(0x11d))),_0x348cd2[_0x1c959d(0x25a)]();},_0x41ffa=>{const _0x5be6a3=_0xf28615;console[_0x5be6a3(0x11b)](_0x5be6a3(0x243)+_0x41ffa),_0x348cd2[_0x5be6a3(0x25a)](),_0x3a4611(_0x41ffa);});});},convertWavToAnotherFormat=(_0x279afb,_0x1b37c8,_0x2e9945)=>{return new Promise((_0x132258,_0x491e26)=>{const _0x29796e=a627_0x94d3;(0x0,fluent_ffmpeg_1[_0x29796e(0x118)])()[_0x29796e(0x1b4)](_0x279afb)[_0x29796e(0x1b8)](_0x2e9945)['on']('end',()=>_0x132258(_0x1b37c8))['on'](_0x29796e(0x11b),_0x58487e=>_0x491e26(new Error(_0x29796e(0x129)+_0x58487e[_0x29796e(0xfe)])))['save'](_0x1b37c8);});},keepOnlySpecifiedChars=_0x326be2=>{return _0x326be2['replace'](/[^a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ¢ÃªÃ®Ã´Ã»Ã‚ÃŠÃŽÃ”Ã›Ã£ÃµÃƒÃ•Ã§Ã‡!?.,;:\s]/g,'');},handleOpenAi=async(_0x5c99d4,_0x2cbf74,_0x140631,_0x273a5f,_0x1571d6)=>{const _0x49d58f=a627_0x530503,_0x3f7c2d=(0x0,exports['getBodyMessage'])(_0x5c99d4);if(!_0x3f7c2d)return;const {prompt:_0x57ea41}=await(0x0,ShowWhatsAppService_1[_0x49d58f(0x118)])(_0x2cbf74['id'],_0x140631[_0x49d58f(0x259)]);if(!_0x57ea41)return;if(_0x5c99d4[_0x49d58f(0x15f)])return;const _0x48b086=path_1[_0x49d58f(0x118)][_0x49d58f(0x155)](__dirname,'..','..','..',_0x49d58f(0x179),_0x49d58f(0x19f)+_0x140631['companyId']);let _0x42fb69;const _0x480bb1=sessionsOpenAi[_0x49d58f(0xdb)](_0x136ddc=>_0x136ddc['id']===_0x2cbf74['id']);if(_0x480bb1===-0x1){const _0x597ed3=new openai_1['Configuration']({'apiKey':_0x57ea41[_0x49d58f(0x108)]});_0x42fb69=new openai_1['OpenAIApi'](_0x597ed3),_0x42fb69['id']=_0x2cbf74['id'],sessionsOpenAi['push'](_0x42fb69);}else _0x42fb69=sessionsOpenAi[_0x480bb1];const _0x3f7c4c=await Message_1[_0x49d58f(0x118)][_0x49d58f(0x14a)]({'where':{'ticketId':_0x140631['id']},'order':[['createdAt',_0x49d58f(0x131)]],'limit':_0x57ea41['maxMessages']}),_0x2ef564=_0x49d58f(0x122)+sanitizeName(_0x273a5f[_0x49d58f(0x12a)]||_0x49d58f(0x21b))+_0x49d58f(0xca)+_0x57ea41[_0x49d58f(0x158)]+'\x20tokens\x20e\x20cuide\x20para\x20nÃ£o\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possÃ­vel,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferÃªncia\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27AÃ§Ã£o:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20'+_0x57ea41[_0x49d58f(0xea)]+'\x0a';let _0x580ff0=[];if(_0x5c99d4[_0x49d58f(0xfe)]?.[_0x49d58f(0x237)]||_0x5c99d4[_0x49d58f(0xfe)]?.['extendedTextMessage']?.[_0x49d58f(0x1b5)]){_0x580ff0=[],_0x580ff0[_0x49d58f(0x18a)]({'role':'system','content':_0x2ef564});for(let _0x47a3fe=0x0;_0x47a3fe<Math[_0x49d58f(0x16b)](_0x57ea41[_0x49d58f(0x139)],_0x3f7c4c['length']);_0x47a3fe++){const _0x5a702b=_0x3f7c4c[_0x47a3fe];_0x5a702b[_0x49d58f(0x191)]===_0x49d58f(0x16e)&&(_0x5a702b[_0x49d58f(0x193)]?_0x580ff0['push']({'role':_0x49d58f(0x144),'content':_0x5a702b[_0x49d58f(0x119)]}):_0x580ff0[_0x49d58f(0x18a)]({'role':_0x49d58f(0xde),'content':_0x5a702b['body']}));}_0x580ff0[_0x49d58f(0x18a)]({'role':_0x49d58f(0xde),'content':_0x3f7c2d});const _0x3cbaaa=await _0x42fb69[_0x49d58f(0x19c)]({'model':_0x49d58f(0x252),'messages':_0x580ff0,'max_tokens':_0x57ea41['maxTokens'],'temperature':_0x57ea41[_0x49d58f(0x112)]});let _0x4e415e=_0x3cbaaa[_0x49d58f(0x220)][_0x49d58f(0x1b3)][0x0][_0x49d58f(0xfe)]?.[_0x49d58f(0x1ad)];_0x4e415e?.[_0x49d58f(0x101)]('AÃ§Ã£o:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x57ea41['queueId'],_0x140631,_0x273a5f),_0x4e415e=_0x4e415e['replace'](_0x49d58f(0x17e),'')[_0x49d58f(0x166)]());if(_0x57ea41[_0x49d58f(0x189)]==='texto'){const _0x1bb6b1=await _0x2cbf74[_0x49d58f(0x251)](_0x5c99d4[_0x49d58f(0x171)][_0x49d58f(0x23d)],{'text':_0x4e415e});await(0x0,exports['verifyMessage'])(_0x1bb6b1,_0x140631,_0x273a5f);}else{const _0x363f5a=_0x140631['id']+'_'+Date[_0x49d58f(0x132)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x4e415e),_0x48b086+'/'+_0x363f5a,_0x57ea41[_0x49d58f(0xfc)],_0x57ea41[_0x49d58f(0x1e9)],_0x57ea41[_0x49d58f(0x189)],_0x49d58f(0x23e))[_0x49d58f(0x1a0)](async()=>{const _0x21cdf2=_0x49d58f;try{const _0x38b22e=await _0x2cbf74['sendMessage'](_0x5c99d4[_0x21cdf2(0x171)][_0x21cdf2(0x23d)],{'audio':{'url':_0x48b086+'/'+_0x363f5a+_0x21cdf2(0x195)},'mimetype':_0x21cdf2(0x1d5),'ptt':!![]});await(0x0,exports[_0x21cdf2(0x157)])(_0x38b22e,_0x140631,_0x273a5f),deleteFileSync(_0x48b086+'/'+_0x363f5a+'.mp3'),deleteFileSync(_0x48b086+'/'+_0x363f5a+_0x21cdf2(0x12f));}catch(_0x14af0b){console[_0x21cdf2(0x1a6)]('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x14af0b);}});}}else{if(_0x5c99d4[_0x49d58f(0xfe)]?.[_0x49d58f(0x221)]){const _0x510ca0=_0x1571d6[_0x49d58f(0x147)]['split']('/')['pop'](),_0x3199f2=fs_2[_0x49d58f(0x118)]['createReadStream'](_0x48b086+'/'+_0x510ca0),_0x272b33=await _0x42fb69[_0x49d58f(0xfd)](_0x3199f2,_0x49d58f(0x1c7));_0x580ff0=[],_0x580ff0[_0x49d58f(0x18a)]({'role':_0x49d58f(0x1bc),'content':_0x2ef564});for(let _0x3e0777=0x0;_0x3e0777<Math['min'](_0x57ea41[_0x49d58f(0x139)],_0x3f7c4c[_0x49d58f(0x16f)]);_0x3e0777++){const _0x3ff760=_0x3f7c4c[_0x3e0777];_0x3ff760[_0x49d58f(0x191)]===_0x49d58f(0x16e)&&(_0x3ff760[_0x49d58f(0x193)]?_0x580ff0[_0x49d58f(0x18a)]({'role':_0x49d58f(0x144),'content':_0x3ff760[_0x49d58f(0x119)]}):_0x580ff0['push']({'role':_0x49d58f(0xde),'content':_0x3ff760['body']}));}_0x580ff0[_0x49d58f(0x18a)]({'role':_0x49d58f(0xde),'content':_0x272b33['data']['text']});const _0x397084=await _0x42fb69[_0x49d58f(0x19c)]({'model':_0x49d58f(0x252),'messages':_0x580ff0,'max_tokens':_0x57ea41[_0x49d58f(0x158)],'temperature':_0x57ea41[_0x49d58f(0x112)]});let _0x46a65f=_0x397084[_0x49d58f(0x220)][_0x49d58f(0x1b3)][0x0][_0x49d58f(0xfe)]?.[_0x49d58f(0x1ad)];_0x46a65f?.[_0x49d58f(0x101)](_0x49d58f(0x17e))&&(await transferQueue(_0x57ea41[_0x49d58f(0x1e3)],_0x140631,_0x273a5f),_0x46a65f=_0x46a65f[_0x49d58f(0x224)](_0x49d58f(0x17e),'')[_0x49d58f(0x166)]());if(_0x57ea41[_0x49d58f(0x189)]===_0x49d58f(0x1c8)){const _0x36d395=await _0x2cbf74['sendMessage'](_0x5c99d4[_0x49d58f(0x171)]['remoteJid'],{'text':_0x46a65f});await(0x0,exports[_0x49d58f(0xe0)])(_0x36d395,_0x140631,_0x273a5f);}else{const _0x4a62eb=_0x140631['id']+'_'+Date[_0x49d58f(0x132)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x46a65f),_0x48b086+'/'+_0x4a62eb,_0x57ea41[_0x49d58f(0xfc)],_0x57ea41[_0x49d58f(0x1e9)],_0x57ea41[_0x49d58f(0x189)],'mp3')[_0x49d58f(0x1a0)](async()=>{const _0x1ee4aa=_0x49d58f;try{const _0x536c53=await _0x2cbf74[_0x1ee4aa(0x251)](_0x5c99d4['key'][_0x1ee4aa(0x23d)],{'audio':{'url':_0x48b086+'/'+_0x4a62eb+_0x1ee4aa(0x195)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports[_0x1ee4aa(0x157)])(_0x536c53,_0x140631,_0x273a5f),deleteFileSync(_0x48b086+'/'+_0x4a62eb+_0x1ee4aa(0x195)),deleteFileSync(_0x48b086+'/'+_0x4a62eb+_0x1ee4aa(0x12f));}catch(_0xaf95c8){console['log'](_0x1ee4aa(0x123)+_0xaf95c8);}});}}}_0x580ff0=[];},transferQueue=async(_0x50d7fa,_0x542809,_0xba173d)=>{await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x50d7fa},'ticketId':_0x542809['id'],'companyId':_0x542809['companyId']});},handleMessageIntegration=async(_0x30a01b,_0x48423b,_0x3aa180,_0x533513,_0x288a93)=>{const _0x1ae577=a627_0x530503,_0x52971e=getTypeMessage(_0x30a01b);if(_0x533513[_0x1ae577(0x1a2)]===_0x1ae577(0x154)||_0x533513[_0x1ae577(0x1a2)]===_0x1ae577(0x149)){if(_0x533513?.[_0x1ae577(0x1ea)]){const _0x5d2628={'method':_0x1ae577(0x22d),'url':_0x533513?.['urlN8N'],'headers':{'Content-Type':'application/json'},'json':_0x30a01b};try{request(_0x5d2628,function(_0x355f2e,_0x4d4463){const _0x5a2dc2=_0x1ae577;if(_0x355f2e)throw new Error(_0x355f2e);else console[_0x5a2dc2(0x1a6)](_0x4d4463['body']);});}catch(_0x159e99){throw new Error(_0x159e99);}}}else{if(_0x533513[_0x1ae577(0x1a2)]===_0x1ae577(0x11e)){let _0x131310;if(_0x52971e==='audioMessage'){let _0x17b397=_0x30a01b[_0x1ae577(0x18b)]+'.ogg';(0x0,fs_1[_0x1ae577(0x24e)])((0x0,path_1[_0x1ae577(0x10f)])(__dirname,'..','..','..',_0x1ae577(0x179),_0x1ae577(0x19f)+_0x3aa180,_0x17b397),'base64',(_0x749b4c,_0x2d7328)=>{const _0x25b71a=_0x1ae577;_0x131310=_0x2d7328,_0x749b4c&&logger_1[_0x25b71a(0x1f8)][_0x25b71a(0x11b)](_0x749b4c);});}else _0x131310=undefined;const _0x3c0d1b=(0x0,Debounce_1['debounce'])(async()=>{const _0x481716=_0x1ae577;await sendDialogflowAwswer(_0x48423b,_0x288a93,_0x30a01b,_0x288a93[_0x481716(0x17c)],_0x131310,_0x3aa180,_0x533513);},0x1f4,_0x288a93['id']);_0x3c0d1b();}else _0x533513['type']===_0x1ae577(0x109)&&(console[_0x1ae577(0x1a6)](_0x1ae577(0x190)),await(0x0,typebotListener_1[_0x1ae577(0x118)])({'wbot':_0x48423b,'msg':_0x30a01b,'ticket':_0x288a93,'typebot':_0x533513}));}};exports['handleMessageIntegration']=handleMessageIntegration;const handleMessage=async(_0x4400d4,_0x537dd0,_0x37150b,_0x253be5=![])=>{const _0x3137d7=a627_0x530503;if(_0x253be5){(0x0,addLogs_1['addLogs'])({'fileName':'processImportMessagesWppId'+_0x537dd0['id']+_0x3137d7(0x140),'text':_0x3137d7(0x143)+JSON['stringify'](_0x4400d4,null,0x2)+'>>>>>>>>>>>>>>>>>>>'});let _0x2c20db=_0x4400d4[_0x3137d7(0x171)]['id'],_0x444292=await Message_1[_0x3137d7(0x118)][_0x3137d7(0x203)]({'where':{'wid':_0x2c20db}});if(_0x444292){await new Promise(_0x18e889=>setTimeout(_0x18e889,0x96)),console['log'](_0x3137d7(0x186));return;}else await new Promise(_0x1011cc=>setTimeout(_0x1011cc,parseInt(process['env'][_0x3137d7(0x1dd)])||0x14a));}else await new Promise(_0x32f6dc=>setTimeout(_0x32f6dc,i*0x28a)),i++;if(!isValidMsg(_0x4400d4))return;try{let _0x4b8858,_0x42c7d9,_0x16ea5d=0x0,_0x559045=0x0,_0x2b7b68=0x0,_0x547a48=(0x0,exports['getBodyMessage'])(_0x4400d4);const _0x384ad5=getTypeMessage(_0x4400d4);if(_0x384ad5==='protocolMessage')return;const _0x3d18b0=_0x4400d4[_0x3137d7(0xfe)]?.[_0x3137d7(0x221)]||_0x4400d4[_0x3137d7(0xfe)]?.['imageMessage']||_0x4400d4[_0x3137d7(0xfe)]?.[_0x3137d7(0x124)]||_0x4400d4['message']?.[_0x3137d7(0xfb)]||_0x4400d4[_0x3137d7(0xfe)][_0x3137d7(0x1e2)]||_0x4400d4?.['message']?.['ephemeralMessage']?.[_0x3137d7(0xfe)]?.['imageMessage']||_0x4400d4?.[_0x3137d7(0xfe)]?.[_0x3137d7(0x22a)]?.['message']?.[_0x3137d7(0x221)]||_0x4400d4?.[_0x3137d7(0xfe)]?.['ephemeralMessage']?.[_0x3137d7(0xfe)]?.['videoMessage']||_0x4400d4?.[_0x3137d7(0xfe)]?.[_0x3137d7(0x22a)]?.[_0x3137d7(0xfe)]?.[_0x3137d7(0xfb)]||_0x4400d4?.['message']?.['ephemeralMessage']?.[_0x3137d7(0xfe)]?.[_0x3137d7(0x1e2)]||_0x4400d4['message']?.[_0x3137d7(0x1c4)]?.[_0x3137d7(0xfe)]?.['imageMessage']||_0x4400d4[_0x3137d7(0xfe)]?.[_0x3137d7(0x1c4)]?.[_0x3137d7(0xfe)]?.[_0x3137d7(0x124)]||_0x4400d4[_0x3137d7(0xfe)]?.[_0x3137d7(0x22a)]?.[_0x3137d7(0xfe)]?.[_0x3137d7(0x1c4)]?.[_0x3137d7(0xfe)]?.[_0x3137d7(0x159)]||_0x4400d4[_0x3137d7(0xfe)]?.['ephemeralMessage']?.['message']?.[_0x3137d7(0x1c4)]?.[_0x3137d7(0xfe)]?.['videoMessage']||_0x4400d4[_0x3137d7(0xfe)]?.['documentWithCaptionMessage']?.[_0x3137d7(0xfe)]?.[_0x3137d7(0xfb)];if(_0x4400d4[_0x3137d7(0x171)]['fromMe']){if(/\u200e/[_0x3137d7(0x227)](_0x547a48))return;if(!_0x3d18b0&&_0x384ad5!=='conversation'&&_0x384ad5!==_0x3137d7(0x14e)&&_0x384ad5!=='contactMessage'&&_0x384ad5!=='reactionMessage'&&_0x384ad5!=='ephemeralMessage'&&_0x384ad5!==_0x3137d7(0x12e)&&_0x384ad5!==_0x3137d7(0x1c4)&&_0x384ad5!==_0x3137d7(0x1f5))return;_0x4b8858=await getContactMessage(_0x4400d4,_0x537dd0);}else _0x4b8858=await getContactMessage(_0x4400d4,_0x537dd0);const _0x1f57d8=_0x4400d4[_0x3137d7(0x171)]['remoteJid']?.['endsWith']('@g.us'),_0x3fc565=await(0x0,ShowWhatsAppService_1[_0x3137d7(0x118)])(_0x537dd0['id'],_0x37150b);if(!_0x3fc565[_0x3137d7(0x15d)]&&_0x1f57d8)return;if(_0x1f57d8){const _0x1559fb=await _0x537dd0[_0x3137d7(0x168)](_0x4400d4[_0x3137d7(0x171)]['remoteJid']),_0x7b34={'id':_0x1559fb['id'],'name':_0x1559fb['subject']};_0x42c7d9=await verifyContact(_0x7b34,_0x537dd0,_0x37150b);}const _0x4100ee=await verifyContact(_0x4b8858,_0x537dd0,_0x37150b);let _0x1afdea=0x0,_0x2cc158=null;if(_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)])await cache_1[_0x3137d7(0x118)][_0x3137d7(0x1a3)](_0x3137d7(0xf3)+_0x4100ee['id']+_0x3137d7(0x1f1),'0');else{const _0x22c184=await cache_1[_0x3137d7(0x118)][_0x3137d7(0x241)](_0x3137d7(0xf3)+_0x4100ee['id']+':unreads');_0x1afdea=+_0x22c184+0x1,await cache_1[_0x3137d7(0x118)][_0x3137d7(0x1a3)](_0x3137d7(0xf3)+_0x4100ee['id']+_0x3137d7(0x1f1),''+_0x1afdea);}const _0x51f997=await CompaniesSettings_1[_0x3137d7(0x118)][_0x3137d7(0x203)]({'where':{'companyId':_0x37150b}}),_0x579ab2=_0x51f997[_0x3137d7(0x167)]===_0x3137d7(0x22b),{ticket:_0x39b351,isCreated:_0x5a2488}=await(0x0,FindOrCreateTicketService_1[_0x3137d7(0x118)])(_0x4100ee,_0x3fc565,_0x1afdea,_0x37150b,_0x16ea5d,_0x2b7b68,_0x42c7d9,_0x3137d7(0xd4),_0x253be5,![],_0x51f997);_0x2cc158=_0x39b351;if(_0x2cc158['status']==='closed'||_0x1afdea===0x0&&_0x3fc565[_0x3137d7(0x1f4)]&&(0x0,Mustache_1[_0x3137d7(0x118)])(_0x3fc565['complationMessage'],_0x2cc158)===_0x547a48)return;if(!_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)]&&_0x3fc565?.[_0x3137d7(0xef)]>0x0){const _0x609520=await(0x0,ShowQueueIntegrationService_1[_0x3137d7(0x118)])(_0x3fc565[_0x3137d7(0xef)],_0x37150b);await(0x0,exports[_0x3137d7(0x12b)])(_0x4400d4,_0x537dd0,_0x37150b,_0x609520,_0x2cc158),await _0x2cc158[_0x3137d7(0x198)]({'useIntegration':!![],'integrationId':_0x609520['id']});}if(_0x384ad5==='editedMessage'){const _0x26954b=_0x4400d4['message'][_0x3137d7(0x1f5)]['message'][_0x3137d7(0x12e)][_0x3137d7(0x171)]['id'],_0x2ebd2b=_0x4400d4[_0x3137d7(0xfe)][_0x3137d7(0x1f5)][_0x3137d7(0xfe)][_0x3137d7(0x12e)][_0x3137d7(0x1f5)][_0x3137d7(0x237)],_0x1df5fd=(0x0,socket_1[_0x3137d7(0x1ef)])();try{const _0x4f5862=await Message_1[_0x3137d7(0x118)][_0x3137d7(0x203)]({'where':{'wid':_0x26954b,'companyId':_0x37150b,'ticketId':_0x2cc158['id']}});if(!_0x4f5862)return;await _0x4f5862[_0x3137d7(0x198)]({'isEdited':!![],'body':_0x2ebd2b}),await _0x2cc158['update']({'lastMessage':_0x2ebd2b}),_0x1df5fd['to'](_0x4f5862[_0x3137d7(0x1c3)][_0x3137d7(0x21d)]())['emit']('company-'+_0x4f5862['companyId']+'-appMessage',{'action':_0x3137d7(0x198),'message':_0x4f5862});}catch(_0x448416){Sentry['captureException'](_0x448416),logger_1[_0x3137d7(0x1f8)][_0x3137d7(0x11b)](_0x3137d7(0x233)+_0x448416);}return;}const _0x5acdb2=await(0x0,FindOrCreateATicketTrakingService_1[_0x3137d7(0x118)])({'ticketId':_0x2cc158['id'],'companyId':_0x37150b,'whatsappId':_0x3fc565?.['id']});try{if(!_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)]){if(_0x2cc158[_0x3137d7(0x15b)]==='nps'&&_0x5acdb2!==null&&(0x0,exports[_0x3137d7(0x1df)])(_0x5acdb2)){_0x3d18b0?await(0x0,exports['verifyMediaMessage'])(_0x4400d4,_0x2cc158,_0x4100ee):await(0x0,exports['verifyMessage'])(_0x4400d4,_0x2cc158,_0x4100ee,_0x5acdb2);if(!isNaN(parseFloat(_0x547a48))){(0x0,exports[_0x3137d7(0x165)])(parseFloat(_0x547a48),_0x2cc158,_0x5acdb2),await _0x5acdb2[_0x3137d7(0x198)]({'ratingAt':(0x0,moment_1[_0x3137d7(0x118)])()[_0x3137d7(0x164)](),'finishedAt':(0x0,moment_1[_0x3137d7(0x118)])()[_0x3137d7(0x164)](),'rated':!![]});return;}else{if(_0x2cc158['amountUseBotQueuesNPS']<_0x3fc565['maxUseBotQueuesNPS']){let _0x5b880d=_0x3137d7(0x1c9);const _0x137867=await _0x537dd0[_0x3137d7(0x251)](_0x2cc158[_0x3137d7(0x17c)][_0x3137d7(0x208)]+'@'+(_0x2cc158['isGroup']?_0x3137d7(0x23b):_0x3137d7(0x1b0)),{'text':_0x5b880d});(0x0,exports['verifyMessage'])(_0x137867,_0x2cc158,_0x4100ee,_0x5acdb2),await(0x0,baileys_1[_0x3137d7(0xfa)])(0x3e8);let _0x5b430a='â€Ž'+_0x3fc565[_0x3137d7(0x1b7)]+'\x0a';const _0x48bb60=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x5b430a,'ticket':_0x2cc158});await(0x0,exports[_0x3137d7(0xe0)])(_0x48bb60,_0x2cc158,_0x2cc158[_0x3137d7(0x17c)]),await _0x2cc158[_0x3137d7(0x198)]({'amountUseBotQueuesNPS':_0x2cc158[_0x3137d7(0x128)]+0x1});}return;}}if(_0x579ab2&&_0x2cc158['status']===_0x3137d7(0x25c)&&!_0x253be5){if((0x0,lodash_1[_0x3137d7(0x104)])(_0x2cc158[_0x3137d7(0xc5)])&&!(0x0,lodash_1['isNil'])(_0x2cc158['lgpdSendMessageAt'])){let _0x2ee578=parseFloat(_0x547a48);if(!Number[_0x3137d7(0x20f)](_0x2ee578)&&Number[_0x3137d7(0x244)](_0x2ee578)&&!(0x0,lodash_1[_0x3137d7(0x185)])(_0x2ee578)&&_0x2ee578>0x0){if(_0x2ee578===0x1)await _0x4100ee[_0x3137d7(0x198)]({'lgpdAcceptedAt':(0x0,moment_1[_0x3137d7(0x118)])()[_0x3137d7(0x164)]()}),await _0x2cc158[_0x3137d7(0x198)]({'lgpdAcceptedAt':(0x0,moment_1['default'])()[_0x3137d7(0x164)](),'amountUsedBotQueues':0x0});else{if(_0x2ee578===0x2){if(_0x3fc565['complationMessage']!==''&&_0x3fc565[_0x3137d7(0x1f4)]!==undefined){const _0x2b43d7=await _0x537dd0[_0x3137d7(0x251)](_0x2cc158[_0x3137d7(0x17c)]['number']+'@'+(_0x2cc158[_0x3137d7(0x181)]?_0x3137d7(0x23b):_0x3137d7(0x1b0)),{'text':'â€Ž'+_0x3fc565['complationMessage']});(0x0,exports[_0x3137d7(0xe0)])(_0x2b43d7,_0x2cc158,_0x4100ee,_0x5acdb2);}await _0x2cc158[_0x3137d7(0x198)]({'status':'closed','amountUsedBotQueues':0x0}),await _0x5acdb2[_0x3137d7(0xe2)];return;}else _0x2cc158[_0x3137d7(0x1fb)]<_0x3fc565[_0x3137d7(0x1de)]&&_0x3fc565[_0x3137d7(0x1de)]>0x0&&await _0x2cc158['update']({'amountUsedBotQueues':_0x2cc158[_0x3137d7(0x1fb)]+0x1,'lgpdSendMessageAt':null});}}else _0x2cc158['amountUsedBotQueues']<_0x3fc565[_0x3137d7(0x1de)]&&_0x3fc565['maxUseBotQueues']>0x0&&await _0x2cc158[_0x3137d7(0x198)]({'amountUsedBotQueues':_0x2cc158[_0x3137d7(0x1fb)]+0x1,'lgpdSendMessageAt':null});}if((_0x4100ee['lgpdAcceptedAt']===null||_0x51f997?.[_0x3137d7(0x234)]===_0x3137d7(0x22b))&&!_0x4100ee[_0x3137d7(0x181)]&&(0x0,lodash_1[_0x3137d7(0x104)])(_0x2cc158[_0x3137d7(0x201)])&&_0x2cc158[_0x3137d7(0x1fb)]<=_0x3fc565[_0x3137d7(0x1de)]&&!(0x0,lodash_1['isNil'])(_0x51f997?.[_0x3137d7(0xe3)])){_0x3d18b0?await(0x0,exports[_0x3137d7(0x157)])(_0x4400d4,_0x2cc158,_0x4100ee):await(0x0,exports['verifyMessage'])(_0x4400d4,_0x2cc158,_0x4100ee,_0x5acdb2);if(!(0x0,lodash_1[_0x3137d7(0x104)])(_0x51f997?.[_0x3137d7(0xe3)])&&_0x51f997[_0x3137d7(0xe3)]!==''){const _0x409d68=(0x0,Mustache_1[_0x3137d7(0x118)])('â€Ž'+_0x51f997?.['lgpdMessage'],_0x2cc158),_0xcceffe=await _0x537dd0['sendMessage'](_0x2cc158[_0x3137d7(0x17c)][_0x3137d7(0x208)]+'@'+(_0x2cc158[_0x3137d7(0x181)]?_0x3137d7(0x23b):'s.whatsapp.net'),{'text':_0x409d68});(0x0,exports[_0x3137d7(0xe0)])(_0xcceffe,_0x2cc158,_0x4100ee,_0x5acdb2);}await(0x0,baileys_1[_0x3137d7(0xfa)])(0x3e8);if(!(0x0,lodash_1[_0x3137d7(0x104)])(_0x51f997?.[_0x3137d7(0x232)])&&_0x51f997?.[_0x3137d7(0x232)]!==''){const _0x517b52=(0x0,Mustache_1[_0x3137d7(0x118)])('â€Ž'+_0x51f997?.[_0x3137d7(0x232)],_0x2cc158),_0x2a3e9a=await _0x537dd0[_0x3137d7(0x251)](_0x2cc158[_0x3137d7(0x17c)][_0x3137d7(0x208)]+'@'+(_0x2cc158['isGroup']?_0x3137d7(0x23b):_0x3137d7(0x1b0)),{'text':_0x517b52});await(0x0,exports[_0x3137d7(0xe0)])(_0x2a3e9a,_0x2cc158,_0x4100ee,_0x5acdb2);};await(0x0,baileys_1[_0x3137d7(0xfa)])(0x3e8);const _0x2feefe=(0x0,Mustache_1['default'])(_0x3137d7(0x20c),_0x2cc158),_0x54121e=await _0x537dd0[_0x3137d7(0x251)](_0x2cc158['contact'][_0x3137d7(0x208)]+'@'+(_0x2cc158[_0x3137d7(0x181)]?_0x3137d7(0x23b):_0x3137d7(0x1b0)),{'text':_0x2feefe});await(0x0,exports['verifyMessage'])(_0x54121e,_0x2cc158,_0x4100ee,_0x5acdb2),await _0x2cc158[_0x3137d7(0x198)]({'lgpdSendMessageAt':(0x0,moment_1[_0x3137d7(0x118)])()[_0x3137d7(0x164)](),'amountUsedBotQueues':_0x2cc158['amountUsedBotQueues']+0x1}),await _0x2cc158[_0x3137d7(0x153)]();return;};if(!(0x0,lodash_1[_0x3137d7(0x104)])(_0x2cc158[_0x3137d7(0x201)])&&(0x0,lodash_1['isNil'])(_0x2cc158[_0x3137d7(0xc5)]))return;}}}catch(_0x34a82f){Sentry[_0x3137d7(0x125)](_0x34a82f),console[_0x3137d7(0x1a6)](_0x34a82f);}const _0x11766d=_0x4400d4[_0x3137d7(0xfe)]?.[_0x3137d7(0x14e)]?.[_0x3137d7(0x20b)]?.[_0x3137d7(0x1cc)]||_0x4400d4[_0x3137d7(0xfe)]?.[_0x3137d7(0x159)]?.[_0x3137d7(0x20b)]?.[_0x3137d7(0x1cc)]||_0x4400d4['message']?.[_0x3137d7(0x221)]?.['contextInfo']?.[_0x3137d7(0x1cc)]||_0x4400d4['message']?.[_0x3137d7(0x124)]?.[_0x3137d7(0x20b)]?.['isForwarded']||_0x4400d4['message']?.[_0x3137d7(0xfb)]?.[_0x3137d7(0x20b)]?.['isForwarded'];let _0x3d59cd;_0x3d18b0?_0x3d59cd=await(0x0,exports['verifyMediaMessage'])(_0x4400d4,_0x2cc158,_0x4100ee,_0x5acdb2,_0x11766d):await(0x0,exports[_0x3137d7(0xe0)])(_0x4400d4,_0x2cc158,_0x4100ee,_0x5acdb2,![],_0x11766d);try{await _0x2cc158[_0x3137d7(0x198)]({'fromMe':_0x4400d4['key'][_0x3137d7(0x193)]});}catch(_0x14a6ef){Sentry[_0x3137d7(0x125)](_0x14a6ef),console[_0x3137d7(0x1a6)](_0x14a6ef);}let _0x3b7f49;if(_0x51f997[_0x3137d7(0x1bf)]===_0x3137d7(0x19f))_0x3b7f49=await(0x0,VerifyCurrentSchedule_1[_0x3137d7(0x118)])(_0x37150b,0x0,0x0);else _0x51f997['scheduleType']==='connection'&&(_0x3b7f49=await(0x0,VerifyCurrentSchedule_1[_0x3137d7(0x118)])(_0x37150b,0x0,_0x3fc565['id']));try{if(!_0x4400d4[_0x3137d7(0x171)]['fromMe']&&_0x51f997['scheduleType']&&(!_0x2cc158[_0x3137d7(0x181)]||_0x3fc565[_0x3137d7(0xc7)]==='enabled')){if((_0x51f997[_0x3137d7(0x1bf)]===_0x3137d7(0x19f)||_0x51f997[_0x3137d7(0x1bf)]==='connection')&&!(0x0,lodash_1[_0x3137d7(0x104)])(_0x3b7f49)&&(!_0x3b7f49||_0x3b7f49['inActivity']===![])){_0x5acdb2[_0x3137d7(0x116)]===null&&await _0x5acdb2[_0x3137d7(0x198)]({'chatbotAt':(0x0,moment_1[_0x3137d7(0x118)])()[_0x3137d7(0x164)]()});if(_0x3fc565[_0x3137d7(0x1de)]&&_0x3fc565[_0x3137d7(0x1de)]!==0x0&&_0x2cc158['amountUsedBotQueues']>=_0x3fc565[_0x3137d7(0x1de)])return;let _0x5a3821=new Date(),_0x56acd1=new Date();if(_0x5acdb2[_0x3137d7(0x116)]!==null){_0x5a3821[_0x3137d7(0x182)](_0x5acdb2[_0x3137d7(0x116)][_0x3137d7(0x13a)]()+Number(_0x3fc565[_0x3137d7(0x245)]));if(_0x5acdb2[_0x3137d7(0x116)]!==null&&_0x56acd1<_0x5a3821&&_0x3fc565['timeUseBotQueues']!=='0'&&_0x2cc158[_0x3137d7(0x1fb)]!==0x0)return;}await _0x5acdb2[_0x3137d7(0x198)]({'chatbotAt':null});if(_0x3fc565[_0x3137d7(0x174)]!==''){const _0x5dfbbe=(0x0,Mustache_1['default'])(''+_0x3fc565[_0x3137d7(0x174)],_0x2cc158),_0xb094cf=(0x0,Debounce_1[_0x3137d7(0x106)])(async()=>{const _0xaaa200=_0x3137d7;await _0x537dd0[_0xaaa200(0x251)](_0x2cc158[_0xaaa200(0x17c)][_0xaaa200(0x208)]+'@'+(_0x2cc158['isGroup']?_0xaaa200(0x23b):_0xaaa200(0x1b0)),{'text':_0x5dfbbe});},0x3e8,_0x2cc158['id']);_0xb094cf(),await _0x2cc158['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x2cc158[_0x3137d7(0x1fb)]+0x1});return;}await _0x2cc158['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x2cc158[_0x3137d7(0x1fb)]+0x1});return;}}}catch(_0x544f8f){Sentry['captureException'](_0x544f8f),console[_0x3137d7(0x1a6)](_0x544f8f);}!_0x2cc158[_0x3137d7(0x1db)]&&!_0x2cc158[_0x3137d7(0x20d)]&&!_0x1f57d8&&!_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)]&&!_0x2cc158[_0x3137d7(0x212)]&&!(0x0,lodash_1[_0x3137d7(0x104)])(_0x3fc565[_0x3137d7(0x226)])&&await handleOpenAi(_0x4400d4,_0x537dd0,_0x2cc158,_0x4100ee,_0x3d59cd);if(!_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)]&&(!_0x2cc158['isGroup']||_0x3fc565[_0x3137d7(0xc7)]===_0x3137d7(0x22b))&&!_0x2cc158[_0x3137d7(0x20d)]&&!_0x2cc158[_0x3137d7(0xde)]&&!_0x2cc158[_0x3137d7(0x127)]&&_0x3fc565[_0x3137d7(0xef)]){const _0x262c79=await(0x0,ShowQueueIntegrationService_1[_0x3137d7(0x118)])(_0x2cc158[_0x3137d7(0xef)],_0x37150b);await(0x0,exports[_0x3137d7(0x12b)])(_0x4400d4,_0x537dd0,_0x37150b,_0x262c79,_0x2cc158);return;}if(!_0x4400d4['key'][_0x3137d7(0x193)]&&(!_0x2cc158[_0x3137d7(0x181)]||_0x3fc565['groupAsTicket']===_0x3137d7(0x22b))&&_0x2cc158['queue']&&!_0x2cc158['userId']&&_0x2cc158['integrationId']&&_0x2cc158[_0x3137d7(0x1bd)]){const _0x3ce48a=await(0x0,ShowQueueIntegrationService_1['default'])(_0x2cc158[_0x3137d7(0xef)],_0x37150b);await(0x0,exports[_0x3137d7(0x12b)])(_0x4400d4,_0x537dd0,_0x37150b,_0x3ce48a,_0x2cc158);return;}!_0x2cc158[_0x3137d7(0x1db)]&&!_0x2cc158['queue']&&(!_0x2cc158['isGroup']||_0x3fc565['groupAsTicket']===_0x3137d7(0x22b))&&!_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)]&&!_0x2cc158['userId']&&_0x3fc565['queues']['length']>=0x1&&(await verifyQueue(_0x537dd0,_0x4400d4,_0x2cc158,_0x4100ee,_0x51f997),_0x5acdb2[_0x3137d7(0x116)]===null&&await _0x5acdb2[_0x3137d7(0x198)]({'chatbotAt':(0x0,moment_1['default'])()[_0x3137d7(0x164)]()}));_0x2cc158[_0x3137d7(0x1e3)]>0x0&&await _0x5acdb2[_0x3137d7(0x198)]({'queueId':_0x2cc158[_0x3137d7(0x1e3)]});if((getTypeMessage(_0x4400d4)===_0x3137d7(0x221)||getTypeMessage(_0x4400d4)===_0x3137d7(0x124))&&!_0x4400d4[_0x3137d7(0x171)][_0x3137d7(0x193)]&&(!_0x2cc158['isGroup']||_0x3fc565[_0x3137d7(0xc7)]==='enabled')&&(!_0x4100ee?.[_0x3137d7(0x18e)]||_0x51f997?.[_0x3137d7(0x236)]===_0x3137d7(0x229))){const _0x73e9e2=await _0x537dd0['sendMessage'](_0x4100ee[_0x3137d7(0x208)]+_0x3137d7(0x1ec),{'text':'â€Ž*Assistente\x20Virtual*:\x0aInfelizmente\x20nÃ£o\x20conseguimos\x20escutar\x20nem\x20enviar\x20Ã¡udios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.'},{'quoted':{'key':_0x4400d4['key'],'message':{'extendedTextMessage':_0x4400d4[_0x3137d7(0xfe)][_0x3137d7(0x14e)]}}});await(0x0,exports[_0x3137d7(0xe0)])(_0x73e9e2,_0x2cc158,_0x4100ee,_0x5acdb2);}try{if(!_0x4400d4['key'][_0x3137d7(0x193)]&&_0x51f997?.[_0x3137d7(0x1bf)]&&_0x2cc158[_0x3137d7(0x1e3)]!==null&&(!_0x2cc158[_0x3137d7(0x181)]||_0x3fc565['groupAsTicket']===_0x3137d7(0x22b))){const _0x810532=await Queue_1[_0x3137d7(0x118)][_0x3137d7(0x192)](_0x2cc158['queueId']);_0x51f997?.[_0x3137d7(0x1bf)]===_0x3137d7(0x20d)&&(_0x3b7f49=await(0x0,VerifyCurrentSchedule_1[_0x3137d7(0x118)])(_0x37150b,_0x810532['id'],0x0));if(_0x51f997?.[_0x3137d7(0x1bf)]===_0x3137d7(0x20d)&&!(0x0,lodash_1['isNil'])(_0x3b7f49)&&(!_0x3b7f49||_0x3b7f49['inActivity']===![])){const _0x168ab2=_0x810532[_0x3137d7(0x174)];if(_0x168ab2!==''){const _0x41cd70=(0x0,Mustache_1[_0x3137d7(0x118)])(''+_0x168ab2,_0x2cc158),_0x441076=(0x0,Debounce_1[_0x3137d7(0x106)])(async()=>{const _0xcbdb7f=_0x3137d7;await _0x537dd0[_0xcbdb7f(0x251)](_0x2cc158[_0xcbdb7f(0x17c)]['number']+'@'+(_0x2cc158[_0xcbdb7f(0x181)]?'g.us':_0xcbdb7f(0x1b0)),{'text':_0x41cd70});},0x3e8,_0x2cc158['id']);_0x441076(),await _0x2cc158[_0x3137d7(0x198)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x2cc158['amountUsedBotQueues']+0x1});return;}await _0x2cc158[_0x3137d7(0x198)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x2cc158[_0x3137d7(0x1fb)]+0x1});return;}}}catch(_0x4a4039){Sentry[_0x3137d7(0x125)](_0x4a4039),console[_0x3137d7(0x1a6)](_0x4a4039);}_0x2cc158['queue']&&_0x2cc158['queueId']&&!_0x4400d4['key'][_0x3137d7(0x193)]&&((!_0x2cc158[_0x3137d7(0xde)]||_0x2cc158[_0x3137d7(0x20d)]?.[_0x3137d7(0xdf)]?.[_0x3137d7(0x16f)]>0x0)&&await(0x0,ChatBotListener_1[_0x3137d7(0xf6)])(_0x2cc158[_0x3137d7(0x1e3)],_0x537dd0,_0x2cc158,_0x4100ee,_0x4400d4),await _0x2cc158[_0x3137d7(0x198)]({'sendInactiveMessage':![]})),await _0x2cc158[_0x3137d7(0x153)]();}catch(_0x8d1704){Sentry[_0x3137d7(0x125)](_0x8d1704),console[_0x3137d7(0x1a6)](_0x8d1704),logger_1['logger']['error'](_0x3137d7(0x15a)+_0x8d1704);}};exports['handleMessage']=handleMessage;const handleMsgAck=async(_0x5641fc,_0x3119a2)=>{const _0x35deb0=a627_0x530503;await new Promise(_0x34d728=>setTimeout(_0x34d728,0x1f4));const _0x3bcf2a=(0x0,socket_1['getIO'])();try{const _0x552741=await Message_1[_0x35deb0(0x118)][_0x35deb0(0x203)]({'where':{'wid':_0x5641fc['key']['id']},'include':[_0x35deb0(0x17c),{'model':Message_1['default'],'as':'quotedMsg','include':[_0x35deb0(0x17c)]}]});if(!_0x552741)return;await _0x552741['update']({'ack':_0x3119a2}),_0x3bcf2a['to'](_0x552741[_0x35deb0(0x1c3)][_0x35deb0(0x21d)]())[_0x35deb0(0x199)](_0x35deb0(0xeb)+_0x552741['companyId']+_0x35deb0(0x150),{'action':_0x35deb0(0x198),'message':_0x552741});}catch(_0x1032dd){Sentry[_0x35deb0(0x125)](_0x1032dd),logger_1[_0x35deb0(0x1f8)]['error']('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x1032dd);}},verifyRecentCampaign=async(_0x479f16,_0x20d0f2)=>{const _0x539a53=a627_0x530503;if(!isValidMsg(_0x479f16))return;if(!_0x479f16[_0x539a53(0x171)]['fromMe']){const _0x2b083b=_0x479f16['key'][_0x539a53(0x23d)]['replace'](/\D/g,''),_0x38c291=await Campaign_1[_0x539a53(0x118)][_0x539a53(0x14a)]({'where':{'companyId':_0x20d0f2,'status':_0x539a53(0x230),'confirmation':!![]}});if(_0x38c291){const _0x21cf0b=_0x38c291['map'](_0x3b51ac=>_0x3b51ac['id']),_0x1ec4af=await CampaignShipping_1['default'][_0x539a53(0x203)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x21cf0b},'number':_0x2b083b,'confirmation':null}});_0x1ec4af&&(await _0x1ec4af[_0x539a53(0x198)]({'confirmedAt':(0x0,moment_1[_0x539a53(0x118)])(),'confirmation':!![]}),await queues_1[_0x539a53(0x1e4)][_0x539a53(0x148)](_0x539a53(0x1c6),{'campaignShippingId':_0x1ec4af['id'],'campaignId':_0x1ec4af['campaignId']},{'delay':(0x0,queues_1[_0x539a53(0x1c5)])((0x0,queues_1[_0x539a53(0x250)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x1b9b6e,_0x520c96,_0x506a79)=>{const _0x3b710f=a627_0x530503;if(!isValidMsg(_0x1b9b6e))return;let _0x1621d0;_0x1621d0=await getContactMessage(_0x1b9b6e,_0x506a79);const _0x4d7a64=await verifyContact(_0x1621d0,_0x506a79,_0x520c96),_0x1c4e0a=(0x0,socket_1['getIO'])(),_0x1f4a7f=await(0x0,exports[_0x3b710f(0x194)])(_0x1b9b6e),_0x20f78a=/\u200c/['test'](_0x1f4a7f);if(_0x1b9b6e['key'][_0x3b710f(0x193)]&&_0x20f78a){const _0x5edb3a=await Message_1['default'][_0x3b710f(0x203)]({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x1b9b6e['key']['id']},{'contactId':_0x4d7a64['id']}],'companyId':_0x520c96}});if(!(0x0,lodash_1['isNull'])(_0x5edb3a)||!(0x0,lodash_1[_0x3b710f(0x104)])(_0x5edb3a)||_0x5edb3a!==null){const _0x1d5c36=await Ticket_1[_0x3b710f(0x118)][_0x3b710f(0x192)](_0x5edb3a[_0x3b710f(0x1c3)]);await _0x1d5c36[_0x3b710f(0x198)]({'status':_0x3b710f(0x13f),'amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x1c4e0a['to'](_0x3b710f(0xf5))[_0x3b710f(0x199)](_0x3b710f(0xeb)+_0x520c96+_0x3b710f(0x180),{'action':_0x3b710f(0xe8),'ticket':_0x1d5c36,'ticketId':_0x1d5c36['id']}),_0x1c4e0a['to'](_0x1d5c36[_0x3b710f(0x15b)])['to'](_0x1d5c36['id'][_0x3b710f(0x21d)]())[_0x3b710f(0x199)](_0x3b710f(0xeb)+_0x520c96+'-ticket',{'action':_0x3b710f(0x198),'ticket':_0x1d5c36,'ticketId':_0x1d5c36['id']});}}},filterMessages=_0x20b07e=>{const _0x305b9f=a627_0x530503;if(_0x20b07e[_0x305b9f(0xfe)]?.[_0x305b9f(0x12e)])return![];if([baileys_1[_0x305b9f(0xd6)][_0x305b9f(0x107)],baileys_1[_0x305b9f(0xd6)]['E2E_DEVICE_CHANGED'],baileys_1[_0x305b9f(0xd6)][_0x305b9f(0x126)],baileys_1[_0x305b9f(0xd6)][_0x305b9f(0x175)]]['includes'](_0x20b07e['messageStubType']))return![];return!![];},wbotMessageListener=(_0x47ec0d,_0x275891)=>{const _0xef132e=a627_0x530503;_0x47ec0d['ev']['on'](_0xef132e(0x1fd),async _0x130f3e=>{const _0xb80941=_0xef132e,_0x4f5719=_0x130f3e[_0xb80941(0x16c)][_0xb80941(0x100)](filterMessages)[_0xb80941(0x23a)](_0x36911f=>_0x36911f);if(!_0x4f5719)return;_0x4f5719[_0xb80941(0xd5)](async _0x2f7c81=>{const _0x9f86aa=_0xb80941,_0x20a137=await Message_1[_0x9f86aa(0x118)][_0x9f86aa(0x23f)]({'where':{'wid':_0x2f7c81[_0x9f86aa(0x171)]['id'],'companyId':_0x275891}});if(!_0x20a137){let _0x18184a=![],_0x2bc21f=await(0x0,exports[_0x9f86aa(0x194)])(_0x2f7c81);const _0xc7eb22=_0x2f7c81?.[_0x9f86aa(0x171)]?.[_0x9f86aa(0x193)];if(_0xc7eb22)_0x18184a=/\u200c/['test'](_0x2bc21f);else{if(/\u200c/[_0x9f86aa(0x227)](_0x2bc21f))_0x2bc21f=_0x2bc21f[_0x9f86aa(0x224)](/\u200c/,'');logger_1[_0x9f86aa(0x1f8)][_0x9f86aa(0x197)](_0x9f86aa(0x1ed)+_0x2bc21f);}if(!_0x18184a){await handleMessage(_0x2f7c81,_0x47ec0d,_0x275891);return;}await verifyRecentCampaign(_0x2f7c81,_0x275891),await verifyCampaignMessageAndCloseTicket(_0x2f7c81,_0x275891,_0x47ec0d);}_0x2f7c81[_0x9f86aa(0x171)][_0x9f86aa(0x23d)]?.['endsWith'](_0x9f86aa(0x13c))&&handleMsgAck(_0x2f7c81,0x2);});}),_0x47ec0d['ev']['on'](_0xef132e(0x216),_0x5a1291=>{const _0x1d3563=_0xef132e;if(_0x5a1291[_0x1d3563(0x16f)]===0x0)return;_0x5a1291[_0x1d3563(0xd5)](async _0x1515f7=>{const _0x13d16c=_0x1d3563;_0x47ec0d[_0x13d16c(0x1c1)]([_0x1515f7[_0x13d16c(0x171)]]);const _0x2fda7b={..._0x5a1291};_0x2fda7b['0']?.['update'][_0x13d16c(0x15f)]===0x1&&_0x2fda7b['0']?.[_0x13d16c(0x171)]['remoteJid']!==_0x13d16c(0xd3)&&(0x0,MarkDeleteWhatsAppMessage_1['default'])(_0x2fda7b['0']?.['key'][_0x13d16c(0x23d)],null,_0x2fda7b['0']?.[_0x13d16c(0x171)]['id'],_0x275891);let _0x55e355;_0x1515f7[_0x13d16c(0x198)]['status']===0x3&&_0x1515f7?.[_0x13d16c(0x171)]?.[_0x13d16c(0x193)]?_0x55e355=0x2:_0x55e355=_0x1515f7['update']['status'],handleMsgAck(_0x1515f7,_0x55e355);});}),_0x47ec0d['ev']['on']('groups.update',_0x32ce15=>{const _0x300dee=_0xef132e;if(_0x32ce15[_0x300dee(0x16f)]===0x0)return;_0x32ce15[_0x300dee(0xd5)](async _0xabf3f4=>{const _0xb5cbde=_0x300dee,_0x134cae=_0xabf3f4['id'][_0xb5cbde(0x224)](/\D/g,''),_0x1cf566=_0xabf3f4[_0xb5cbde(0x141)]||_0x134cae;let _0x9baef2;try{_0x9baef2=await _0x47ec0d[_0xb5cbde(0x17f)](_0xabf3f4['id'],_0xb5cbde(0x1cd));}catch(_0x232d2c){Sentry['captureException'](_0x232d2c),_0x9baef2=process[_0xb5cbde(0xd7)][_0xb5cbde(0xcd)]+_0xb5cbde(0x138);}const _0xbae671={'name':_0x1cf566,'number':_0x134cae,'isGroup':!![],'companyId':_0x275891,'remoteJid':_0xabf3f4['id'],'profilePicUrl':_0x9baef2},_0x233b05=await(0x0,CreateOrUpdateContactService_1[_0xb5cbde(0x118)])(_0xbae671);});});};exports[a627_0x530503(0x136)]=wbotMessageListener;