'use strict';const a627_0x19fe46=a627_0x11f0;function a627_0x11f0(_0x511929,_0x40add4){const _0xa4a9c0=a627_0xa4a9();return a627_0x11f0=function(_0x11f0c9,_0x17f0c3){_0x11f0c9=_0x11f0c9-0x1d8;let _0x30db93=_0xa4a9c0[_0x11f0c9];return _0x30db93;},a627_0x11f0(_0x511929,_0x40add4);}(function(_0x1fb373,_0x1d21f5){const _0x1734aa=a627_0x11f0,_0x497a43=_0x1fb373();while(!![]){try{const _0x524cf0=parseInt(_0x1734aa(0x202))/0x1*(parseInt(_0x1734aa(0x269))/0x2)+parseInt(_0x1734aa(0x2a4))/0x3+-parseInt(_0x1734aa(0x354))/0x4*(-parseInt(_0x1734aa(0x233))/0x5)+parseInt(_0x1734aa(0x2d5))/0x6+parseInt(_0x1734aa(0x328))/0x7*(parseInt(_0x1734aa(0x1f1))/0x8)+parseInt(_0x1734aa(0x36a))/0x9*(-parseInt(_0x1734aa(0x309))/0xa)+-parseInt(_0x1734aa(0x2db))/0xb*(parseInt(_0x1734aa(0x25c))/0xc);if(_0x524cf0===_0x1d21f5)break;else _0x497a43['push'](_0x497a43['shift']());}catch(_0x195b4c){_0x497a43['push'](_0x497a43['shift']());}}}(a627_0xa4a9,0xdf9db));var __createBinding=this&&this['__createBinding']||(Object[a627_0x19fe46(0x1d8)]?function(_0x521ebb,_0x55a3fd,_0xf84859,_0x3a56ee){const _0x2acf55=a627_0x19fe46;if(_0x3a56ee===undefined)_0x3a56ee=_0xf84859;var _0x41819f=Object['getOwnPropertyDescriptor'](_0x55a3fd,_0xf84859);(!_0x41819f||(_0x2acf55(0x330)in _0x41819f?!_0x55a3fd[_0x2acf55(0x357)]:_0x41819f[_0x2acf55(0x2e5)]||_0x41819f[_0x2acf55(0x33a)]))&&(_0x41819f={'enumerable':!![],'get':function(){return _0x55a3fd[_0xf84859];}}),Object[_0x2acf55(0x228)](_0x521ebb,_0x3a56ee,_0x41819f);}:function(_0x2f32e8,_0x2d45f7,_0x31e0e9,_0x22091b){if(_0x22091b===undefined)_0x22091b=_0x31e0e9;_0x2f32e8[_0x22091b]=_0x2d45f7[_0x31e0e9];}),__setModuleDefault=this&&this[a627_0x19fe46(0x2b7)]||(Object[a627_0x19fe46(0x1d8)]?function(_0x45749b,_0xf5ff53){const _0xb239ba=a627_0x19fe46;Object[_0xb239ba(0x228)](_0x45749b,_0xb239ba(0x215),{'enumerable':!![],'value':_0xf5ff53});}:function(_0x5553e3,_0x39b6d1){_0x5553e3['default']=_0x39b6d1;}),__importStar=this&&this[a627_0x19fe46(0x359)]||function(_0x1916fc){const _0x4c43e8=a627_0x19fe46;if(_0x1916fc&&_0x1916fc[_0x4c43e8(0x357)])return _0x1916fc;var _0x50680d={};if(_0x1916fc!=null){for(var _0x18f6fa in _0x1916fc)if(_0x18f6fa!==_0x4c43e8(0x215)&&Object[_0x4c43e8(0x241)][_0x4c43e8(0x303)][_0x4c43e8(0x310)](_0x1916fc,_0x18f6fa))__createBinding(_0x50680d,_0x1916fc,_0x18f6fa);}return __setModuleDefault(_0x50680d,_0x1916fc),_0x50680d;},__importDefault=this&&this[a627_0x19fe46(0x2a2)]||function(_0x4a86a7){const _0x22e209=a627_0x19fe46;return _0x4a86a7&&_0x4a86a7[_0x22e209(0x357)]?_0x4a86a7:{'default':_0x4a86a7};};Object[a627_0x19fe46(0x228)](exports,a627_0x19fe46(0x357),{'value':!![]}),exports['getTypeMessage']=exports[a627_0x19fe46(0x333)]=exports[a627_0x19fe46(0x2f3)]=exports[a627_0x19fe46(0x2d1)]=exports['handleMessageIntegration']=exports[a627_0x19fe46(0x2b1)]=exports[a627_0x19fe46(0x36c)]=exports[a627_0x19fe46(0x2b5)]=exports[a627_0x19fe46(0x271)]=exports[a627_0x19fe46(0x361)]=exports[a627_0x19fe46(0x287)]=exports[a627_0x19fe46(0x28d)]=exports[a627_0x19fe46(0x286)]=void 0x0;const path_1=__importStar(require(a627_0x19fe46(0x28c))),util_1=require(a627_0x19fe46(0x220)),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require(a627_0x19fe46(0x24d))),lodash_1=require('lodash'),baileys_1=require(a627_0x19fe46(0x292)),Contact_1=__importDefault(require(a627_0x19fe46(0x367))),Ticket_1=__importDefault(require(a627_0x19fe46(0x307))),Message_1=__importDefault(require(a627_0x19fe46(0x272))),socket_1=require(a627_0x19fe46(0x262)),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),logger_1=require(a627_0x19fe46(0x32c)),CreateOrUpdateContactService_1=__importDefault(require(a627_0x19fe46(0x323))),FindOrCreateTicketService_1=__importDefault(require('../TicketServices/FindOrCreateTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),Debounce_1=require('../../helpers/Debounce'),UpdateTicketService_1=__importDefault(require(a627_0x19fe46(0x22d))),Mustache_1=__importDefault(require(a627_0x19fe46(0x261))),UserRating_1=__importDefault(require(a627_0x19fe46(0x297))),SendWhatsAppMessage_1=__importDefault(require(a627_0x19fe46(0x2c7))),sendFacebookMessage_1=__importDefault(require(a627_0x19fe46(0x22e))),moment_1=__importDefault(require('moment')),Queue_1=__importDefault(require('../../models/Queue')),FindOrCreateATicketTrakingService_1=__importDefault(require(a627_0x19fe46(0x270))),VerifyCurrentSchedule_1=__importDefault(require(a627_0x19fe46(0x1fe))),Campaign_1=__importDefault(require('../../models/Campaign')),CampaignShipping_1=__importDefault(require(a627_0x19fe46(0x2dc))),sequelize_1=require(a627_0x19fe46(0x364)),queues_1=require('../../queues'),User_1=__importDefault(require(a627_0x19fe46(0x290))),ChatBotListener_1=require(a627_0x19fe46(0x1dd)),MarkDeleteWhatsAppMessage_1=__importDefault(require('./MarkDeleteWhatsAppMessage')),ListUserQueueServices_1=__importDefault(require(a627_0x19fe46(0x249))),cache_1=__importDefault(require(a627_0x19fe46(0x1de))),addLogs_1=require('../../helpers/addLogs'),SendWhatsAppMedia_1=__importStar(require(a627_0x19fe46(0x2c2))),ShowQueueIntegrationService_1=__importDefault(require(a627_0x19fe46(0x2f1))),CreateSessionDialogflow_1=require(a627_0x19fe46(0x308)),QueryDialogflow_1=require(a627_0x19fe46(0x1e5)),CompaniesSettings_1=__importDefault(require(a627_0x19fe46(0x1f7))),CreateLogTicketService_1=__importDefault(require(a627_0x19fe46(0x36b))),Whatsapp_1=__importDefault(require(a627_0x19fe46(0x29e))),ShowService_1=__importDefault(require(a627_0x19fe46(0x242))),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require(a627_0x19fe46(0x2b8))),microsoft_cognitiveservices_speech_sdk_1=require(a627_0x19fe46(0x370)),typebotListener_1=__importDefault(require(a627_0x19fe46(0x2ee))),os=require('os'),request=require(a627_0x19fe46(0x2d6));let ffmpegPath;if(os[a627_0x19fe46(0x283)]()===a627_0x19fe46(0x234))ffmpegPath=a627_0x19fe46(0x2d7);else os[a627_0x19fe46(0x283)]()===a627_0x19fe46(0x2a3)?ffmpegPath='/opt/homebrew/bin/ffmpeg':ffmpegPath=a627_0x19fe46(0x298);fluent_ffmpeg_1[a627_0x19fe46(0x215)][a627_0x19fe46(0x282)](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a627_0x19fe46(0x337)])(fs_1[a627_0x19fe46(0x342)]);function removeFile(_0x324080){const _0x5704e7=a627_0x19fe46;fs_2[_0x5704e7(0x215)][_0x5704e7(0x2ba)](_0x324080,_0x1fa2d4=>{if(_0x1fa2d4)throw _0x1fa2d4;});}const getTimestampMessage=_0x4f7734=>{return _0x4f7734*0x1;},multVecardGet=function(_0xdb53b1){const _0xe27c26=a627_0x19fe46;let _0x5bfe18='\x20',_0x159111=_0xdb53b1[_0xe27c26(0x205)]('\x0a')[0x2]['replace'](_0xe27c26(0x1f5),'\x0a')['replace']('N:','')[_0xe27c26(0x373)](';','')[_0xe27c26(0x373)](';','\x20')['replace'](';;','\x20')['replace']('\x0a',''),_0x5a1730=_0xdb53b1[_0xe27c26(0x205)]('\x0a')[0x4][_0xe27c26(0x20b)]('='),_0x5de946=_0xdb53b1['split']('\x0a')[0x4][_0xe27c26(0x20b)](':'),_0x1fda80=_0xdb53b1[_0xe27c26(0x205)]('\x0a')[0x4]['substring'](_0x5a1730+0x1,_0x5de946)[_0xe27c26(0x373)](';',''),_0xcb71cc=_0xdb53b1['split']('\x0a')[0x4][_0xe27c26(0x373)]('item1.TEL:','');if(_0x1fda80!=_0xe27c26(0x315))_0x5bfe18=_0x5bfe18+_0x159111+_0xe27c26(0x1e0)+_0x1fda80+''+'\x0a';else _0x5bfe18=_0x5bfe18+_0x159111+_0xe27c26(0x1e0)+_0xcb71cc+''+'\x0a';return _0x5bfe18;},contactsArrayMessageGet=_0x44be66=>{const _0x3325c7=a627_0x19fe46;let _0x2b32ad=_0x44be66['message']?.[_0x3325c7(0x1d9)]?.['contacts'],_0x2c3b6b=_0x2b32ad['map'](function(_0x416e92,_0x4911ab){const _0x31d7cf=_0x3325c7;return _0x416e92[_0x31d7cf(0x27a)];}),_0x35656a='';_0x2c3b6b['forEach'](function(_0x240f9c,_0x243367){_0x35656a+=_0x240f9c+'\x0a\x0a'+'';});let _0x56e49a=_0x35656a[_0x3325c7(0x205)]('BEGIN:');_0x56e49a[_0x3325c7(0x32b)]();let _0x32695f='';for(let _0x470c25 of _0x56e49a){_0x32695f=_0x32695f+multVecardGet(_0x470c25);}return _0x32695f;},getTypeMessage=_0x53b525=>{const _0x17e55c=a627_0x19fe46,_0x943348=(0x0,baileys_1[_0x17e55c(0x2fb)])(_0x53b525[_0x17e55c(0x2cd)]);if(_0x53b525['message']?.[_0x17e55c(0x336)])return _0x17e55c(0x336);return _0x943348;};exports['getTypeMessage']=getTypeMessage;function a627_0xa4a9(){const _0x363b23=['E2E_DEVICE_CHANGED','.mp3','89529QPjyBJ','../../models/CampaignShipping','options','length','chmodSync','medias','extendedTextMessage','env','captureException','title','writable','displayText','campaignQueue','%2C','stringValue','documentMessage','fileListId','acceptAudioMessageContact','contactId','../TypebotServices/typebotListener','destroy','assistant','../QueueIntegrationServices/ShowQueueIntegrationService','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','handleMessage','find','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','isNil','webhook','toDate','parseToMilliseconds','Erro\x20para\x20responder\x20com\x20audio:\x20','getContentType','Importando\x20Mensagem:\x20','presenceSubscribe','isNull','enableLGPD','participant','stanzaId','findAndCountAll','hasOwnProperty','NFD','Escolha\x20uma\x20opção','nps','../../models/Ticket','../QueueIntegrationServices/CreateSessionDialogflow','3213970rBbOZI','base64','lgpdLink','lgpdSendMessageAt','dialogflow','findByPk','DispatchCampaign','call','\x20]*\x20-\x20','system','conversation','protocolMessage','item1.TEL','axolotlSenderKeyDistributionMessage','Erro\x20media','addLogs','Configuration','Erro\x20ao\x20baixar\x20mídia:','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mídia\x20verifique\x20no\x20dispositivo','groupAsTicket','buttonsMessage','maxTokens',':*\x20Não\x20consegui\x20entender\x20sua\x20dúvida.','texto','responses','log','../ContactServices/CreateOrUpdateContactService','test','from','number','createReadStream','7WZOIxI','Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20já\x20não\x20esta\x20mais\x20disponível','button','shift','../../utils/logger','acceptAudioMessage','7bit','E2E_IDENTITY_CHANGED','get','getIO','status@broadcast','isValidMsg','whatsapp','mediaUrl','viewOnceMessageV2','promisify','queue','set','configurable','reactionMessage','close','\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento','disabled','name','substring','delete','writeFile','disableBot','setExtra','chat','description','map','Erro\x20ao\x20baixar\x20media','stringify','ERR_WAPP_DOWNLOAD_MEDIA','chatBotType','n8n','maxUseBotQueues','Erro\x20ao\x20deletar\x20o\x20arquivo:','downloadMediaMessage','getMinutes','emit','setMinutes','gpt-3.5-turbo','4iKgOAz','endsWith','remoteJid','__esModule','jidNormalizedUser','__importStar','instagram','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage','contactMessage','floor','ticketId','sections','rows','downloadMedia','isForwarded','Formato\x20de\x20arquivo\x20não\x20suportado:','sequelize','toFormat','amountUseBotQueuesNPS','../../models/Contact','amountUsedBotQueues','Áudio','27eixUHB','../TicketServices/CreateLogTicketService','verifyRating','senderKeyDistributionMessage','profilePictureUrl','lgpdMessage','microsoft-cognitiveservices-speech-sdk','toString','degreesLongitude','replace','ephemeralMessage','lgpdAcceptedAt','closeTicket','farewellMessage','public','create','contactsArrayMessage','companyId','speechSynthesisVoiceName','handleMessageIntegration','./ChatBotListener','../../libs/cache','reload',':\x20📞','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posição\x20na\x20fila\x20de\x20atendimento\x20é:\x20*','min','values','update','../QueueIntegrationServices/QueryDialogflow','user','forEach','*[\x20','.ogg','apiKey','timeUseBotQueues','debug','buttonsResponseMessage','findAll','findOne','liveLocationMessage','7968624ZaEBjQ','value','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','SpeechConfig',';;;','fromMe','../../models/CompaniesSettings','Validação\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','keys','parameters','closedAt','viewOnceMessage','editedMessage','../CompanyService/VerifyCurrentSchedule','quotedMessage','contentText','pending','991841oQLmjr','pop',':unreads','split','videoMessage','queryDialogFlow','isInteger','campaignId','jpegThumbnail','indexOf','filename','buttons','entries','s.whatsapp.net','inActivity','end','fileList','contact','&z=17&hl=pt-BR|','default','isGroup','createTranscription','locationMessage','fromSubscription','complationMessage','greetingMediaAttachment','enabled','WAMessageStubType','react','now','util','audio/mpeg','contextInfo','Error\x20isValidMsg','pushName','data','contacts:','-appMessage','defineProperty','toISOString','audioMessage','singleSelectReply','messages.upsert','../TicketServices/UpdateTicketService','../FacebookServices/sendFacebookMessage','next','lgpd','chatbots','‎\x20*','9012795uhXEPD','win32','voiceRegion','content','/nopicture.png','-ticket','getMessageOptions','composing','caption','whisper-1','Esta\x20mensagem\x20já\x20existe','userId','templateButtonReplyMessage','sendPresenceUpdate','prototype','../FileServices/ShowService','@c.us','OpenAIApi','voiceKey','@g.us','getTime','createDialogflowSessionWithModel','../UserQueueServices/ListUserQueueServices','FRONTEND_URL','queueId','outOfHoursMessage','@sentry/node','integrationId','includes','stickerMessage','existsSync','debounce','messages','error','readMessages','type','.wav','ratingAt','messageContextInfo','input','chatbotAt','7212VNFTMY','Error\x20handling\x20message\x20ack.\x20Err:\x20','temperature','groupMetadata','Error\x20getTypeMessage','../../helpers/Mustache','../../libs/socket','greetingMessage','company-','lgpdConsent','selectedRowId','mp3','REVOKE','2UzBmlH','Mensagem','speakTextAsync','then','sendMessage','listMessage','documentWithCaptionMessage','../TicketServices/FindOrCreateATicketTrakingService','verifyMediaMessage','../../models/Message','add','text','trim','info','urlN8N','projectName','Error\x20converting\x20file:\x20','vcard','buffer','delay','audio','No\x20result\x20from\x20synthesizer','selectedDisplayText','sair','degreesLatitude','setFfmpegPath','platform','mediaMessage','join','getBodyMessage','getQuotedMessageId','selectedButtonId','company','voice','sendGreetingMessageOneQueues','path','getQuotedMessage','voiceMessage','count','../../models/User','.mpeg','@whiskeysockets/baileys','list','createChatCompletion','prompt','fromAudioFileOutput','../../models/UserRating','/usr/bin/ffmpeg','warn','resolve','image','Menu','mimetype','../../models/Whatsapp','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','connection','messageTimestamp','__importDefault','darwin','4200459apSJLn','>>>>>>>>>>>>>>>>>>>','maxMessages','listResponseMessage','closed','g.us','status','channel','EM_ANDAMENTO','extractMessageContent','data:image/png;base64,\x20','paused','CIPHERTEXT','handleRating','Error:\x20','randomValue','useIntegration','verifyMessage','buttonText','__setModuleDefault','fluent-ffmpeg','choices','unlink','POST','\x20|\x20https://maps.google.com/maps?q=','chatBot','application/json','push','quotedMsg','body','./SendWhatsAppMedia','typebot','save','SpeechSynthesizer','imported','./SendWhatsAppMessage','slice','.txt','scheduleType','key','queues','message','normalize','logger','imageMessage','wbotMessageListener','unlinkSync','isBot','catch','9486180DKJiQH','request','C:\x5cffmpeg\x5cffmpeg.exe','messages.update'];a627_0xa4a9=function(){return _0x363b23;};return a627_0xa4a9();}const getBodyButton=_0x569b75=>{const _0x2f85d6=a627_0x19fe46;if(_0x569b75[_0x2f85d6(0x2cb)]['fromMe']&&_0x569b75[_0x2f85d6(0x2cd)][_0x2f85d6(0x31d)]?.[_0x2f85d6(0x200)]){let _0xf80b16=''+_0x569b75?.[_0x2f85d6(0x2cd)]?.[_0x2f85d6(0x31d)]?.[_0x2f85d6(0x200)];for(const _0x31e4c8 of _0x569b75[_0x2f85d6(0x2cd)]?.[_0x2f85d6(0x31d)]?.[_0x2f85d6(0x20d)]){_0xf80b16+='\x0a\x0a'+_0x31e4c8[_0x2f85d6(0x2b6)]?.[_0x2f85d6(0x2e6)];}return _0xf80b16;}if(_0x569b75['key']['fromMe']&&_0x569b75?.[_0x2f85d6(0x2cd)]?.[_0x2f85d6(0x1fc)]?.[_0x2f85d6(0x2cd)]?.['listMessage']){let _0x27ab9d=''+_0x569b75?.[_0x2f85d6(0x2cd)]?.['viewOnceMessage']?.[_0x2f85d6(0x2cd)]?.[_0x2f85d6(0x26e)]?.[_0x2f85d6(0x346)];for(const _0x5885d2 of _0x569b75['message']?.['viewOnceMessage']?.['message']?.[_0x2f85d6(0x26e)]?.[_0x2f85d6(0x35f)]){for(const _0x102a55 of _0x5885d2[_0x2f85d6(0x360)]){_0x27ab9d+='\x0a\x0a'+_0x102a55[_0x2f85d6(0x2e4)];}}return _0x27ab9d;}},getBodyList=_0x5664bd=>{const _0x483262=a627_0x19fe46;if(_0x5664bd[_0x483262(0x2cb)][_0x483262(0x1f6)]&&_0x5664bd['message'][_0x483262(0x26e)]?.['description']){let _0x3ae585=''+_0x5664bd[_0x483262(0x2cd)][_0x483262(0x26e)]?.[_0x483262(0x346)];for(const _0x31ff16 of _0x5664bd[_0x483262(0x2cd)][_0x483262(0x26e)]?.['sections']){for(const _0x579d58 of _0x31ff16[_0x483262(0x360)]){_0x3ae585+='\x0a\x0a'+_0x579d58[_0x483262(0x2e4)];}}return _0x3ae585;}if(_0x5664bd[_0x483262(0x2cb)][_0x483262(0x1f6)]&&_0x5664bd?.['message']?.[_0x483262(0x1fc)]?.[_0x483262(0x2cd)]?.[_0x483262(0x26e)]){let _0x2aba3e=''+_0x5664bd?.['message']?.[_0x483262(0x1fc)]?.[_0x483262(0x2cd)]?.[_0x483262(0x26e)]?.[_0x483262(0x346)];for(const _0x20ba1c of _0x5664bd['message']?.[_0x483262(0x1fc)]?.[_0x483262(0x2cd)]?.['listMessage']?.['sections']){for(const _0x103775 of _0x20ba1c['rows']){_0x2aba3e+='\x0a\x0a'+_0x103775[_0x483262(0x2e4)];}}return _0x2aba3e;}},msgLocation=(_0x594827,_0x30907c,_0x2b5bed)=>{const _0x3b5cee=a627_0x19fe46;if(_0x594827){var _0x4b5b99=Buffer[_0x3b5cee(0x325)](_0x594827)['toString']('base64');let _0x279441=_0x3b5cee(0x2ae)+_0x4b5b99+_0x3b5cee(0x2bc)+_0x30907c+_0x3b5cee(0x2e8)+_0x2b5bed+_0x3b5cee(0x214)+_0x30907c+',\x20'+_0x2b5bed+'\x20';return _0x279441;}},getBodyMessage=_0x21146a=>{const _0x568106=a627_0x19fe46;try{let _0x2c2d26=getTypeMessage(_0x21146a);if(_0x2c2d26===undefined)console['log'](_0x21146a);const _0x2c71b9={'conversation':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x313)],'imageMessage':_0x21146a[_0x568106(0x2cd)]?.['imageMessage']?.['caption'],'videoMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x206)]?.[_0x568106(0x23b)],'extendedTextMessage':_0x21146a?.[_0x568106(0x2cd)]?.[_0x568106(0x2e1)]?.[_0x568106(0x274)],'buttonsResponseMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x1ed)]?.[_0x568106(0x27f)],'listResponseMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x2a7)]?.[_0x568106(0x2e4)]||_0x21146a['message']?.[_0x568106(0x2a7)]?.[_0x568106(0x22b)]?.[_0x568106(0x266)],'templateButtonReplyMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x23f)]?.['selectedId'],'messageContextInfo':_0x21146a['message']?.['buttonsResponseMessage']?.[_0x568106(0x288)]||_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x2a7)]?.[_0x568106(0x2e4)],'buttonsMessage':getBodyButton(_0x21146a)||_0x21146a['message']?.[_0x568106(0x2a7)]?.[_0x568106(0x2e4)],'stickerMessage':'sticker','contactMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x35c)]?.[_0x568106(0x27a)],'contactsArrayMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x1d9)]?.['contacts']&&contactsArrayMessageGet(_0x21146a),'locationMessage':msgLocation(_0x21146a[_0x568106(0x2cd)]?.['locationMessage']?.[_0x568106(0x20a)],_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x218)]?.[_0x568106(0x281)],_0x21146a['message']?.[_0x568106(0x218)]?.['degreesLongitude']),'liveLocationMessage':'Latitude:\x20'+_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x1f0)]?.['degreesLatitude']+'\x20-\x20Longitude:\x20'+_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x1f0)]?.[_0x568106(0x372)],'documentMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x2ea)]?.[_0x568106(0x23b)],'audioMessage':_0x568106(0x369),'listMessage':getBodyList(_0x21146a)||_0x21146a['message']?.[_0x568106(0x2a7)]?.[_0x568106(0x2e4)],'viewOnceMessage':getBodyButton(_0x21146a),'reactionMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x33b)]?.[_0x568106(0x274)]||'reaction','senderKeyDistributionMessage':_0x21146a?.[_0x568106(0x2cd)]?.[_0x568106(0x36d)]?.[_0x568106(0x316)],'documentWithCaptionMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x26f)]?.[_0x568106(0x2cd)]?.[_0x568106(0x2ea)]?.[_0x568106(0x23b)],'viewOnceMessageV2':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x336)]?.[_0x568106(0x2cd)]?.[_0x568106(0x2d0)]?.[_0x568106(0x23b)],'editedMessage':_0x21146a[_0x568106(0x2cd)]?.[_0x568106(0x1fd)]?.[_0x568106(0x2cd)]?.[_0x568106(0x2e1)]?.[_0x568106(0x274)],'ephemeralMessage':_0x21146a['message']?.[_0x568106(0x374)]?.[_0x568106(0x2cd)]?.[_0x568106(0x2e1)]?.[_0x568106(0x274)]},_0x397e65=Object[_0x568106(0x1f9)](_0x2c71b9)[_0x568106(0x2f4)](_0x33883d=>_0x33883d===_0x2c2d26);return!_0x397e65&&(logger_1[_0x568106(0x2cf)]['warn']('####\x20Nao\x20achou\x20o\x20type\x20152:\x20'+_0x2c2d26+'\x0a'+JSON[_0x568106(0x349)](_0x21146a)),Sentry[_0x568106(0x344)](_0x568106(0x26a),{'BodyMsg':_0x21146a['message'],'msg':_0x21146a,'type':_0x2c2d26}),Sentry[_0x568106(0x2e3)](new Error(_0x568106(0x35b)))),_0x2c71b9[_0x2c2d26];}catch(_0x585839){Sentry[_0x568106(0x344)](_0x568106(0x260),{'msg':_0x21146a,'BodyMsg':_0x21146a[_0x568106(0x2cd)]}),Sentry['captureException'](_0x585839),console['log'](_0x585839);}};exports[a627_0x19fe46(0x286)]=getBodyMessage;const getQuotedMessage=_0x163062=>{const _0x9b21f2=a627_0x19fe46,_0x2f5de9=(0x0,baileys_1[_0x9b21f2(0x2ad)])(_0x163062[_0x9b21f2(0x2cd)])[Object[_0x9b21f2(0x1f9)](_0x163062?.['message'])[_0x9b21f2(0x1e3)]()[_0x9b21f2(0x22f)]()[_0x9b21f2(0x1f2)]];if(!_0x2f5de9?.[_0x9b21f2(0x222)]?.[_0x9b21f2(0x1ff)])return;const _0x4d9612=(0x0,baileys_1[_0x9b21f2(0x2ad)])(_0x2f5de9?.[_0x9b21f2(0x222)]?.[_0x9b21f2(0x1ff)][Object['keys'](_0x2f5de9?.[_0x9b21f2(0x222)]?.[_0x9b21f2(0x1ff)])[_0x9b21f2(0x1e3)]()[_0x9b21f2(0x22f)]()[_0x9b21f2(0x1f2)]]);return _0x4d9612;};exports[a627_0x19fe46(0x28d)]=getQuotedMessage;const getQuotedMessageId=_0x5e7653=>{const _0x40d2e1=a627_0x19fe46,_0x355a9f=(0x0,baileys_1['extractMessageContent'])(_0x5e7653['message'])[Object[_0x40d2e1(0x1f9)](_0x5e7653?.[_0x40d2e1(0x2cd)])['values']()['next']()[_0x40d2e1(0x1f2)]];let _0x12f422=_0x5e7653?.[_0x40d2e1(0x2cd)]?.[_0x40d2e1(0x33b)]?_0x5e7653?.[_0x40d2e1(0x2cd)]?.['reactionMessage']?.['key']?.['id']:'';return _0x12f422?_0x12f422:_0x355a9f?.['contextInfo']?.[_0x40d2e1(0x301)];};exports['getQuotedMessageId']=getQuotedMessageId;const getMeSocket=_0x2e6650=>{const _0x2a8951=a627_0x19fe46;return{'id':(0x0,baileys_1[_0x2a8951(0x358)])(_0x2e6650[_0x2a8951(0x1e6)]['id']),'name':_0x2e6650[_0x2a8951(0x1e6)][_0x2a8951(0x33f)]};},getSenderMessage=(_0x1bf6f8,_0x429596)=>{const _0x2391de=a627_0x19fe46,_0x10cfa5=getMeSocket(_0x429596);if(_0x1bf6f8[_0x2391de(0x2cb)][_0x2391de(0x1f6)])return _0x10cfa5['id'];const _0x1858ff=_0x1bf6f8[_0x2391de(0x300)]||_0x1bf6f8['key'][_0x2391de(0x300)]||_0x1bf6f8[_0x2391de(0x2cb)]['remoteJid']||undefined;return _0x1858ff&&(0x0,baileys_1[_0x2391de(0x358)])(_0x1858ff);},getContactMessage=async(_0x3a90ef,_0x3b8af2)=>{const _0x3ab9eb=a627_0x19fe46,_0xe313f1=_0x3a90ef[_0x3ab9eb(0x2cb)][_0x3ab9eb(0x356)][_0x3ab9eb(0x24f)]('g.us'),_0x2cd138=_0x3a90ef[_0x3ab9eb(0x2cb)]['remoteJid'][_0x3ab9eb(0x373)](/\D/g,'');return _0xe313f1?{'id':getSenderMessage(_0x3a90ef,_0x3b8af2),'name':_0x3a90ef[_0x3ab9eb(0x224)]}:{'id':_0x3a90ef[_0x3ab9eb(0x2cb)]['remoteJid'],'name':_0x3a90ef['key'][_0x3ab9eb(0x1f6)]?_0x2cd138:_0x3a90ef[_0x3ab9eb(0x224)]};},downloadMedia=async(_0x4e6ccf,_0x3a8898=null)=>{const _0x1cabda=a627_0x19fe46;let _0x2de82f;try{_0x2de82f=await(0x0,baileys_1[_0x1cabda(0x34f)])(_0x4e6ccf,_0x1cabda(0x27b),{});}catch(_0x3cee30){_0x3a8898?console[_0x1cabda(0x322)](_0x1cabda(0x329)):console[_0x1cabda(0x254)](_0x1cabda(0x31a),_0x3cee30);}let _0x3deebf=_0x4e6ccf['message']?.[_0x1cabda(0x2ea)]?.['fileName']||'';const _0x1f9e11=_0x4e6ccf[_0x1cabda(0x2cd)]?.['imageMessage']||_0x4e6ccf['message']?.[_0x1cabda(0x22a)]||_0x4e6ccf[_0x1cabda(0x2cd)]?.[_0x1cabda(0x206)]||_0x4e6ccf[_0x1cabda(0x2cd)]?.[_0x1cabda(0x250)]||_0x4e6ccf[_0x1cabda(0x2cd)]?.['documentMessage']||_0x4e6ccf['message']?.[_0x1cabda(0x26f)]?.[_0x1cabda(0x2cd)]?.[_0x1cabda(0x2ea)]||_0x4e6ccf[_0x1cabda(0x2cd)]?.[_0x1cabda(0x2e1)]?.[_0x1cabda(0x222)]?.[_0x1cabda(0x1ff)]?.[_0x1cabda(0x2d0)]||_0x4e6ccf[_0x1cabda(0x2cd)]?.[_0x1cabda(0x2e1)]?.['contextInfo']?.[_0x1cabda(0x1ff)]?.[_0x1cabda(0x206)];if(!_0x1f9e11)console[_0x1cabda(0x322)](_0x4e6ccf);if(!_0x3deebf){const _0x192677=_0x1f9e11[_0x1cabda(0x29d)]['split']('/')[0x1]['split'](';')[0x0];_0x3deebf=new Date()['getTime']()+'.'+_0x192677;}else _0x3deebf=new Date()[_0x1cabda(0x247)]()+'_'+_0x3deebf;const _0x5a7fed={'data':_0x2de82f,'mimetype':_0x1f9e11[_0x1cabda(0x29d)],'filename':_0x3deebf};return _0x5a7fed;};exports[a627_0x19fe46(0x361)]=downloadMedia;const verifyContact=async(_0x334e70,_0x1782da,_0x4fa979)=>{const _0x153824=a627_0x19fe46;let _0x393d3e;try{_0x393d3e=await _0x1782da[_0x153824(0x36e)](_0x334e70['id'],'image');}catch(_0xcb1ffb){Sentry[_0x153824(0x2e3)](_0xcb1ffb),_0x393d3e=process[_0x153824(0x2e2)][_0x153824(0x24a)]+_0x153824(0x237);}const _0x295ebb={'name':_0x334e70['name']||_0x334e70['id'][_0x153824(0x373)](/\D/g,''),'number':_0x334e70['id'][_0x153824(0x373)](/\D/g,''),'profilePicUrl':_0x393d3e,'isGroup':_0x334e70['id']['includes'](_0x153824(0x2a9)),'companyId':_0x4fa979,'remoteJid':_0x334e70['id']};_0x295ebb[_0x153824(0x216)]&&(_0x295ebb['number']=_0x334e70['id'][_0x153824(0x373)](_0x153824(0x246),''));const _0x4899ca=await(0x0,CreateOrUpdateContactService_1[_0x153824(0x215)])(_0x295ebb);return _0x4899ca;},verifyQuotedMessage=async _0x3bbcfd=>{const _0x1a0316=a627_0x19fe46;if(!_0x3bbcfd)return null;const _0x11a270=(0x0,exports[_0x1a0316(0x287)])(_0x3bbcfd);if(!_0x11a270)return null;const _0x78b35a=await Message_1['default'][_0x1a0316(0x1ef)]({'where':{'wid':_0x11a270}});if(!_0x78b35a)return null;return _0x78b35a;},verifyMediaMessage=async(_0x191f74,_0x2d75db,_0x3e84ae,_0x46e7f8,_0x1f1d08)=>{const _0xb30424=a627_0x19fe46,_0xad67a1=(0x0,socket_1['getIO'])(),_0x3df737=await verifyQuotedMessage(_0x191f74),_0x1cbc2a=_0x2d75db['companyId'];try{const _0x3f442d=await(0x0,exports[_0xb30424(0x361)])(_0x191f74,_0x2d75db?.[_0xb30424(0x2c6)]);if(!_0x3f442d&&_0x2d75db['imported']){const _0x22e96c=_0xb30424(0x31b),_0x1abaf9={'wid':_0x191f74[_0xb30424(0x2cb)]['id'],'ticketId':_0x2d75db['id'],'contactId':_0x191f74[_0xb30424(0x2cb)]['fromMe']?undefined:_0x2d75db[_0xb30424(0x2ed)],'body':_0x22e96c,'reactionMessage':_0x191f74[_0xb30424(0x2cd)]?.['reactionMessage'],'fromMe':_0x191f74['key'][_0xb30424(0x1f6)],'mediaType':getTypeMessage(_0x191f74),'read':_0x191f74['key'][_0xb30424(0x1f6)],'quotedMsgId':_0x3df737?.['id']||_0x191f74[_0xb30424(0x2cd)]?.[_0xb30424(0x33b)]?.[_0xb30424(0x2cb)]?.['id'],'ack':_0x191f74[_0xb30424(0x2aa)],'companyId':_0x1cbc2a,'remoteJid':_0x191f74[_0xb30424(0x2cb)]['remoteJid'],'participant':_0x191f74[_0xb30424(0x2cb)][_0xb30424(0x300)],'timestamp':getTimestampMessage(_0x191f74[_0xb30424(0x2a1)]),'createdAt':new Date(Math['floor'](getTimestampMessage(_0x191f74[_0xb30424(0x2a1)])*0x3e8))[_0xb30424(0x229)](),'dataJson':JSON[_0xb30424(0x349)](_0x191f74),'ticketImported':_0x2d75db[_0xb30424(0x2c6)],'isForwarded':_0x1f1d08};return await _0x2d75db[_0xb30424(0x1e4)]({'lastMessage':_0x22e96c}),logger_1[_0xb30424(0x2cf)][_0xb30424(0x254)](Error(_0xb30424(0x34a))),(0x0,CreateMessageService_1[_0xb30424(0x215)])({'messageData':_0x1abaf9,'companyId':_0x1cbc2a});}if(!_0x3f442d)throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');if(!_0x3f442d[_0xb30424(0x20c)]){const _0x5ce474=_0x3f442d['mimetype'][_0xb30424(0x205)]('/')[0x1][_0xb30424(0x205)](';')[0x0];_0x3f442d['filename']=new Date()[_0xb30424(0x247)]()+'.'+_0x5ce474;}else{const _0x112702=_0x3f442d[_0xb30424(0x20c)][_0xb30424(0x205)]('.')[_0xb30424(0x203)](),_0x2508f0=_0x3f442d[_0xb30424(0x20c)]['split']('.')[_0xb30424(0x2c8)](0x0,-0x1)[_0xb30424(0x285)]('.')['replace'](/\s/g,'_')[_0xb30424(0x2ce)](_0xb30424(0x304))['replace'](/[\u0300-\u036f]/g,'');_0x3f442d[_0xb30424(0x20c)]=_0x2508f0[_0xb30424(0x275)]()+'_'+new Date()['getTime']()+'.'+_0x112702;}try{const _0xfa0fcf=path_1['default']['resolve'](__dirname,'..','..','..','public','company'+_0x1cbc2a);!fs_2[_0xb30424(0x215)][_0xb30424(0x251)](_0xfa0fcf)&&(fs_2[_0xb30424(0x215)]['mkdirSync'](_0xfa0fcf,{'recursive':!![]}),fs_2[_0xb30424(0x215)][_0xb30424(0x2df)](_0xfa0fcf,0x1ff)),await writeFileAsync((0x0,path_1[_0xb30424(0x285)])(_0xfa0fcf,_0x3f442d[_0xb30424(0x20c)]),_0x3f442d[_0xb30424(0x225)][_0xb30424(0x371)](_0xb30424(0x30a)),_0xb30424(0x30a))[_0xb30424(0x26c)](()=>{const _0x244ede=_0xb30424;if(_0x3f442d[_0x244ede(0x29d)][_0x244ede(0x24f)](_0x244ede(0x27d))){const _0x5de832=path_1[_0x244ede(0x215)][_0x244ede(0x285)](_0xfa0fcf,_0x3f442d[_0x244ede(0x20c)]);let _0x22d534;if(_0x5de832['endsWith'](_0x244ede(0x291)))_0x22d534=_0x5de832[_0x244ede(0x373)]('.mpeg',_0x244ede(0x2da));else{if(_0x5de832[_0x244ede(0x355)](_0x244ede(0x1e9)))_0x22d534=_0x5de832['replace'](_0x244ede(0x1e9),_0x244ede(0x2da));else{console[_0x244ede(0x254)](_0x244ede(0x363),_0x5de832);return;}}return new Promise((_0x52bf02,_0x5d931c)=>{const _0x2fe94f=_0x244ede;(0x0,fluent_ffmpeg_1['default'])(_0x5de832)[_0x2fe94f(0x365)](_0x2fe94f(0x267))[_0x2fe94f(0x2c4)](_0x22d534)['on']('end',()=>{_0x52bf02();})['on'](_0x2fe94f(0x254),_0x30eeaf=>{_0x5d931c(_0x30eeaf);});});}});}catch(_0x471fa3){Sentry[_0xb30424(0x344)](_0xb30424(0x317),{'companyId':_0x1cbc2a,'ticket':_0x2d75db,'contact':_0x3e84ae,'media':_0x3f442d,'quotedMsg':_0x3df737}),Sentry[_0xb30424(0x2e3)](_0x471fa3),logger_1['logger'][_0xb30424(0x254)](_0x471fa3),console[_0xb30424(0x322)](_0x191f74);}const _0x24f3d8=(0x0,exports[_0xb30424(0x286)])(_0x191f74),_0x4078c3={'wid':_0x191f74[_0xb30424(0x2cb)]['id'],'ticketId':_0x2d75db['id'],'contactId':_0x191f74[_0xb30424(0x2cb)][_0xb30424(0x1f6)]?undefined:_0x3e84ae['id'],'body':_0x24f3d8||_0x3f442d[_0xb30424(0x20c)],'fromMe':_0x191f74[_0xb30424(0x2cb)]['fromMe'],'read':_0x191f74[_0xb30424(0x2cb)][_0xb30424(0x1f6)],'mediaUrl':_0x3f442d[_0xb30424(0x20c)],'mediaType':_0x3f442d[_0xb30424(0x29d)]['split']('/')[0x0],'quotedMsgId':_0x3df737?.['id'],'ack':_0x191f74['status'],'remoteJid':_0x191f74[_0xb30424(0x2cb)][_0xb30424(0x356)],'participant':_0x191f74[_0xb30424(0x2cb)][_0xb30424(0x300)],'dataJson':JSON['stringify'](_0x191f74),'ticketTrakingId':_0x46e7f8?.['id'],'createdAt':new Date(Math[_0xb30424(0x35d)](getTimestampMessage(_0x191f74[_0xb30424(0x2a1)])*0x3e8))[_0xb30424(0x229)](),'ticketImported':_0x2d75db[_0xb30424(0x2c6)],'isForwarded':_0x1f1d08};await _0x2d75db[_0xb30424(0x1e4)]({'lastMessage':_0x24f3d8||_0x3f442d['filename']});const _0x4ef6c7=await(0x0,CreateMessageService_1[_0xb30424(0x215)])({'messageData':_0x4078c3,'companyId':_0x1cbc2a});return!_0x191f74[_0xb30424(0x2cb)]['fromMe']&&_0x2d75db[_0xb30424(0x2aa)]==='closed'&&(await _0x2d75db[_0xb30424(0x1e4)]({'status':_0xb30424(0x201)}),await _0x2d75db[_0xb30424(0x1df)]({'include':[{'model':Queue_1['default'],'as':_0xb30424(0x338)},{'model':User_1[_0xb30424(0x215)],'as':_0xb30424(0x1e6)},{'model':Contact_1[_0xb30424(0x215)],'as':_0xb30424(0x213)},{'model':Whatsapp_1[_0xb30424(0x215)],'as':'whatsapp'}]}),_0xad67a1['to'](_0xb30424(0x2a8))[_0xb30424(0x351)]('company-'+_0x1cbc2a+_0xb30424(0x238),{'action':_0xb30424(0x341),'ticket':_0x2d75db,'ticketId':_0x2d75db['id']}),_0xad67a1['to'](_0x2d75db['status'])['to'](_0x2d75db['id']['toString']())['emit'](_0xb30424(0x264)+_0x1cbc2a+'-ticket',{'action':_0xb30424(0x1e4),'ticket':_0x2d75db,'ticketId':_0x2d75db['id']})),_0x4ef6c7;}catch(_0x48a57f){console[_0xb30424(0x322)](_0x48a57f),logger_1['logger'][_0xb30424(0x299)](_0xb30424(0x348));}};exports[a627_0x19fe46(0x271)]=verifyMediaMessage;const verifyMessage=async(_0x1830c0,_0xc561ae,_0xfb10c2,_0xa4eb75,_0x3a6e20,_0x2197fc)=>{const _0x51530f=a627_0x19fe46,_0x5d874a=(0x0,socket_1['getIO'])(),_0x3571fa=await verifyQuotedMessage(_0x1830c0),_0x40078d=(0x0,exports['getBodyMessage'])(_0x1830c0),_0x29f023=_0xc561ae['companyId'],_0x2658a0={'wid':_0x1830c0[_0x51530f(0x2cb)]['id'],'ticketId':_0xc561ae['id'],'contactId':_0x1830c0[_0x51530f(0x2cb)][_0x51530f(0x1f6)]?undefined:_0xfb10c2['id'],'body':_0x40078d,'fromMe':_0x1830c0[_0x51530f(0x2cb)]['fromMe'],'mediaType':getTypeMessage(_0x1830c0),'read':_0x1830c0[_0x51530f(0x2cb)][_0x51530f(0x1f6)],'quotedMsgId':_0x3571fa?.['id'],'ack':_0x1830c0[_0x51530f(0x2aa)],'remoteJid':_0x1830c0[_0x51530f(0x2cb)][_0x51530f(0x356)],'participant':_0x1830c0[_0x51530f(0x2cb)]['participant'],'dataJson':JSON[_0x51530f(0x349)](_0x1830c0),'ticketTrakingId':_0xa4eb75?.['id'],'isPrivate':![],'createdAt':new Date(Math[_0x51530f(0x35d)](getTimestampMessage(_0x1830c0[_0x51530f(0x2a1)])*0x3e8))[_0x51530f(0x229)](),'ticketImported':_0xc561ae[_0x51530f(0x2c6)],'isForwarded':_0x2197fc};await _0xc561ae['update']({'lastMessage':_0x40078d}),await(0x0,CreateMessageService_1[_0x51530f(0x215)])({'messageData':_0x2658a0,'companyId':_0x29f023}),!_0x1830c0[_0x51530f(0x2cb)][_0x51530f(0x1f6)]&&_0xc561ae['status']===_0x51530f(0x2a8)&&(await _0xc561ae['update']({'status':_0x51530f(0x201)}),await _0xc561ae[_0x51530f(0x1df)]({'include':[{'model':Queue_1[_0x51530f(0x215)],'as':'queue'},{'model':User_1[_0x51530f(0x215)],'as':_0x51530f(0x1e6)},{'model':Contact_1[_0x51530f(0x215)],'as':_0x51530f(0x213)},{'model':Whatsapp_1['default'],'as':_0x51530f(0x334)}]}),!_0xc561ae['imported']&&_0x5d874a['to'](_0xc561ae['status'])['to'](_0xc561ae['id']['toString']())['emit']('company-'+_0x29f023+_0x51530f(0x238),{'action':_0x51530f(0x1e4),'ticket':_0xc561ae,'ticketId':_0xc561ae['id']}));};exports[a627_0x19fe46(0x2b5)]=verifyMessage;const isValidMsg=_0x49f2c6=>{const _0x5912e7=a627_0x19fe46;if(_0x49f2c6['key']['remoteJid']===_0x5912e7(0x332))return![];try{const _0x3b0934=getTypeMessage(_0x49f2c6);if(!_0x3b0934)return;const _0x136198=_0x3b0934===_0x5912e7(0x313)||_0x3b0934==='extendedTextMessage'||_0x3b0934===_0x5912e7(0x22a)||_0x3b0934===_0x5912e7(0x206)||_0x3b0934==='imageMessage'||_0x3b0934===_0x5912e7(0x2ea)||_0x3b0934===_0x5912e7(0x250)||_0x3b0934==='buttonsResponseMessage'||_0x3b0934===_0x5912e7(0x31d)||_0x3b0934===_0x5912e7(0x259)||_0x3b0934===_0x5912e7(0x218)||_0x3b0934===_0x5912e7(0x1f0)||_0x3b0934===_0x5912e7(0x35c)||_0x3b0934===_0x5912e7(0x28e)||_0x3b0934===_0x5912e7(0x284)||_0x3b0934===_0x5912e7(0x1d9)||_0x3b0934===_0x5912e7(0x33b)||_0x3b0934===_0x5912e7(0x374)||_0x3b0934===_0x5912e7(0x314)||_0x3b0934==='listResponseMessage'||_0x3b0934===_0x5912e7(0x26e)||_0x3b0934===_0x5912e7(0x1fc)||_0x3b0934===_0x5912e7(0x26f)||_0x3b0934===_0x5912e7(0x336)||_0x3b0934===_0x5912e7(0x1fd);return!_0x136198&&(logger_1[_0x5912e7(0x2cf)][_0x5912e7(0x299)](_0x5912e7(0x2f2)+_0x3b0934+'\x0a'+JSON[_0x5912e7(0x349)](_0x49f2c6?.[_0x5912e7(0x2cd)])),Sentry[_0x5912e7(0x344)]('Mensagem',{'BodyMsg':_0x49f2c6['message'],'msg':_0x49f2c6,'msgType':_0x3b0934}),Sentry[_0x5912e7(0x2e3)](new Error('Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg'))),!!_0x136198;}catch(_0x3e2298){Sentry[_0x5912e7(0x344)](_0x5912e7(0x223),{'msg':_0x49f2c6}),Sentry[_0x5912e7(0x2e3)](_0x3e2298);}};exports[a627_0x19fe46(0x333)]=isValidMsg;const sendDialogflowAwswer=async(_0x19d1e8,_0x5dfe59,_0x4deaf6,_0x2944ac,_0x592bda,_0x5aab87,_0x308f30)=>{const _0x4d61fe=a627_0x19fe46,_0x4eb6f0=await(0x0,CreateSessionDialogflow_1[_0x4d61fe(0x248)])(_0x308f30);if(_0x4eb6f0===undefined)return;_0x19d1e8[_0x4d61fe(0x2fd)](_0x2944ac[_0x4d61fe(0x356)]),await(0x0,baileys_1[_0x4d61fe(0x27c)])(0x1f4);let _0x1a63cd=await(0x0,QueryDialogflow_1[_0x4d61fe(0x207)])(_0x4eb6f0,_0x308f30[_0x4d61fe(0x278)],_0x2944ac[_0x4d61fe(0x356)],(0x0,exports[_0x4d61fe(0x286)])(_0x4deaf6),_0x308f30['language'],_0x592bda);if(!_0x1a63cd){_0x19d1e8['sendPresenceUpdate'](_0x4d61fe(0x23a),_0x2944ac[_0x4d61fe(0x356)]);const _0x1211ef=(0x0,Mustache_1['default'])(_0x4d61fe(0x232)+_0x308f30?.['name']+_0x4d61fe(0x31f));await(0x0,baileys_1['delay'])(0x3e8),await _0x19d1e8[_0x4d61fe(0x240)](_0x4d61fe(0x2af),_0x2944ac['remoteJid']);const _0x5e7e6f=await _0x19d1e8[_0x4d61fe(0x26d)](_0x2944ac[_0x4d61fe(0x326)]+_0x4d61fe(0x243),{'text':_0x1211ef});await(0x0,exports['verifyMessage'])(_0x5e7e6f,_0x5dfe59,_0x2944ac);return;}_0x1a63cd['endConversation']&&await _0x5dfe59[_0x4d61fe(0x1e4)]({'contactId':_0x5dfe59['contact']['id']['toString'](),'useIntegration':![]});const _0x23a23d=_0x1a63cd[_0x4d61fe(0x1fa)][_0x4d61fe(0x29b)]?.[_0x4d61fe(0x2e9)]??undefined,_0x1d17fc=_0x1a63cd[_0x4d61fe(0x1fa)][_0x4d61fe(0x21e)]?.[_0x4d61fe(0x2e9)]??undefined,_0x22c195=_0x1a63cd['encodedAudio']['toString'](_0x4d61fe(0x30a))??undefined;_0x19d1e8[_0x4d61fe(0x240)]('composing',_0x2944ac[_0x4d61fe(0x356)]),await(0x0,baileys_1[_0x4d61fe(0x27c)])(0x1f4);let _0x436746;for(let _0x4dc0f4 of _0x1a63cd[_0x4d61fe(0x321)]){_0x436746=_0x4dc0f4[_0x4d61fe(0x274)][_0x4d61fe(0x274)][0x0]?_0x4dc0f4[_0x4d61fe(0x274)][_0x4d61fe(0x274)][0x0]:_0x436746;}for(let _0x126270 of _0x1a63cd[_0x4d61fe(0x321)]){_0x126270[_0x4d61fe(0x274)]&&await sendDelayedMessages(_0x19d1e8,_0x5dfe59,_0x2944ac,_0x126270[_0x4d61fe(0x274)]['text'][0x0],_0x436746,_0x22c195,_0x308f30);}};async function sendDelayedMessages(_0x1fc92e,_0x509dfe,_0x166463,_0x3053eb,_0xc81af0,_0xee2ec7,_0xe1287a){const _0x5b2af9=a627_0x19fe46,_0x2a9610=_0x509dfe[_0x5b2af9(0x1da)],_0x2130e1=await(0x0,ShowWhatsAppService_1[_0x5b2af9(0x215)])(_0x1fc92e['id'],_0x2a9610),_0x466d87=_0x2130e1[_0x5b2af9(0x377)][_0x5b2af9(0x373)](/[_*]/g,''),_0x21d51c=await _0x1fc92e[_0x5b2af9(0x26d)](_0x166463[_0x5b2af9(0x326)]+_0x5b2af9(0x243),{'text':_0x5b2af9(0x232)+_0xe1287a?.[_0x5b2af9(0x33f)]+':*\x20'+_0x3053eb});await(0x0,exports[_0x5b2af9(0x2b5)])(_0x21d51c,_0x509dfe,_0x166463);if(_0x3053eb!=_0xc81af0)await(0x0,baileys_1[_0x5b2af9(0x27c)])(0x1f4),_0x1fc92e[_0x5b2af9(0x240)](_0x5b2af9(0x23a),_0x166463[_0x5b2af9(0x356)]);else _0xee2ec7&&(_0x1fc92e['sendPresenceUpdate']('recording',_0x166463[_0x5b2af9(0x356)]),await(0x0,baileys_1[_0x5b2af9(0x27c)])(0x1f4),_0x466d87&&_0x3053eb[_0x5b2af9(0x24f)](_0x466d87)&&(await(0x0,baileys_1[_0x5b2af9(0x27c)])(0x3e8),setTimeout(async()=>{const _0x3c9ec2=_0x5b2af9;await _0x509dfe['update']({'contactId':_0x509dfe[_0x3c9ec2(0x213)]['id'][_0x3c9ec2(0x371)](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1['default'])({'ticketId':_0x509dfe['id'],'ticketData':{'status':_0x3c9ec2(0x2a8)},'companyId':_0x2a9610});},0xbb8)));}const verifyQueue=async(_0x42cf43,_0x296841,_0x405bc1,_0x246a2f,_0x32119d,_0x2a6436)=>{const _0x4e20e0=a627_0x19fe46,_0x124b7f=_0x405bc1[_0x4e20e0(0x1da)],{queues:_0x15975b,greetingMessage:_0x61e0b9,maxUseBotQueues:_0x2c4562,timeUseBotQueues:_0x336cfb}=await(0x0,ShowWhatsAppService_1[_0x4e20e0(0x215)])(_0x42cf43['id'],_0x124b7f);let _0x48a9b1=![];_0x15975b[_0x4e20e0(0x2de)]===0x1&&(_0x48a9b1=_0x15975b[0x0]?.[_0x4e20e0(0x231)][_0x4e20e0(0x2de)]>0x1);const _0x3e20d2=_0x32119d['sendQueuePosition']===_0x4e20e0(0x21c);if(_0x15975b[_0x4e20e0(0x2de)]===0x1&&!_0x48a9b1){const _0x4df07a=_0x32119d[_0x4e20e0(0x28b)]==='enabled'||![];if(!_0x296841[_0x4e20e0(0x2cb)][_0x4e20e0(0x1f6)]&&!_0x405bc1[_0x4e20e0(0x216)]&&_0x15975b[0x0][_0x4e20e0(0x24e)]){const _0x507ef7=await(0x0,ShowQueueIntegrationService_1[_0x4e20e0(0x215)])(_0x15975b[0x0][_0x4e20e0(0x24e)],_0x124b7f);await(0x0,exports[_0x4e20e0(0x1dc)])(_0x296841,_0x42cf43,_0x124b7f,_0x507ef7,_0x405bc1),await _0x405bc1[_0x4e20e0(0x1e4)]({'useIntegration':!![],'integrationId':_0x507ef7['id']});}if(_0x61e0b9[_0x4e20e0(0x2de)]>0x1&&_0x4df07a){const _0x1ff543=(0x0,Mustache_1[_0x4e20e0(0x215)])(''+_0x61e0b9,_0x405bc1);if(_0x405bc1[_0x4e20e0(0x334)][_0x4e20e0(0x21b)]!==null){const _0xb1f986=path_1['default'][_0x4e20e0(0x29a)]('public',_0x4e20e0(0x289)+_0x124b7f,_0x405bc1['whatsapp'][_0x4e20e0(0x21b)]),_0xd1d90=_0x405bc1['whatsapp'][_0x4e20e0(0x21b)],_0x3a6994=await(0x0,SendWhatsAppMedia_1[_0x4e20e0(0x239)])(_0xd1d90,_0xb1f986,String(_0x124b7f),_0x1ff543),_0x162e37=(0x0,Debounce_1[_0x4e20e0(0x252)])(async()=>{const _0x143f1a=_0x4e20e0,_0x26d0ba=await _0x42cf43[_0x143f1a(0x26d)](_0x405bc1['contact'][_0x143f1a(0x326)]+'@'+(_0x405bc1[_0x143f1a(0x216)]?_0x143f1a(0x2a9):'s.whatsapp.net'),{..._0x3a6994});await(0x0,exports[_0x143f1a(0x271)])(_0x26d0ba,_0x405bc1,_0x246a2f,_0x2a6436);},0x3e8,_0x405bc1['id']);_0x162e37();}else await _0x42cf43[_0x4e20e0(0x26d)](_0x246a2f['number']+'@'+(_0x405bc1[_0x4e20e0(0x216)]?_0x4e20e0(0x2a9):_0x4e20e0(0x20f)),{'text':_0x1ff543});}if(!(0x0,lodash_1['isNil'])(_0x15975b[0x0][_0x4e20e0(0x2eb)]))try{const _0x479acd=path_1[_0x4e20e0(0x215)][_0x4e20e0(0x29a)](__dirname,'..','..','..',_0x4e20e0(0x378)),_0x1470d2=await(0x0,ShowService_1[_0x4e20e0(0x215)])(_0x15975b[0x0]['fileListId'],_0x405bc1['companyId']),_0x1138cd=path_1[_0x4e20e0(0x215)]['resolve'](_0x479acd,'company'+_0x405bc1[_0x4e20e0(0x1da)],_0x4e20e0(0x212),String(_0x1470d2['id']));for(const [_0x4067d6,_0x42f76e]of _0x1470d2[_0x4e20e0(0x2dd)][_0x4e20e0(0x20e)]()){const _0x480e75={'fieldname':_0x4e20e0(0x2e0),'originalname':_0x42f76e[_0x4e20e0(0x28c)],'encoding':'7bit','mimetype':_0x42f76e['mediaType'],'filename':_0x42f76e[_0x4e20e0(0x28c)],'path':path_1[_0x4e20e0(0x215)][_0x4e20e0(0x29a)](_0x1138cd,_0x42f76e[_0x4e20e0(0x28c)])};await(0x0,SendWhatsAppMedia_1[_0x4e20e0(0x215)])({'media':_0x480e75,'ticket':_0x405bc1,'body':_0x42f76e[_0x4e20e0(0x33f)],'isPrivate':![],'isForwarded':![]});};}catch(_0x3f415f){logger_1[_0x4e20e0(0x2cf)]['info'](_0x3f415f);}if(_0x15975b[0x0][_0x4e20e0(0x376)]){await(0x0,UpdateTicketService_1[_0x4e20e0(0x215)])({'ticketData':{'status':'closed','queueId':_0x15975b[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});return;}else await(0x0,UpdateTicketService_1[_0x4e20e0(0x215)])({'ticketData':{'queueId':_0x15975b[0x0]['id']},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});const _0x35f4a8=await Ticket_1[_0x4e20e0(0x215)]['findAndCountAll']({'where':{'userId':null,'status':'pending','companyId':_0x124b7f,'queueId':_0x15975b[0x0]['id'],'isGroup':![]}});if(_0x3e20d2){const _0x11674f=_0x35f4a8['count']===0x0?0x1:_0x35f4a8[_0x4e20e0(0x28f)],_0x20dc54=_0x4e20e0(0x1e1)+_0x11674f+'*',_0x2a2b2e=(0x0,Mustache_1['default'])(''+_0x20dc54,_0x405bc1),_0x878e49=(0x0,Debounce_1[_0x4e20e0(0x252)])(async()=>{const _0x4aff75=_0x4e20e0;await _0x42cf43[_0x4aff75(0x26d)](_0x246a2f['number']+'@'+(_0x405bc1[_0x4aff75(0x216)]?_0x4aff75(0x2a9):_0x4aff75(0x20f)),{'text':_0x2a2b2e});},0xbb8,_0x405bc1['id']);_0x878e49();}return;}if(_0x246a2f[_0x4e20e0(0x343)])return;let _0x2a377c='';if(_0x405bc1[_0x4e20e0(0x2aa)]!==_0x4e20e0(0x230))_0x2a377c=_0x296841?.[_0x4e20e0(0x2cd)]?.[_0x4e20e0(0x1ed)]?.[_0x4e20e0(0x288)]||_0x296841?.[_0x4e20e0(0x2cd)]?.['listResponseMessage']?.[_0x4e20e0(0x22b)][_0x4e20e0(0x266)]||(0x0,exports[_0x4e20e0(0x286)])(_0x296841);else{if(!(0x0,lodash_1[_0x4e20e0(0x2f6)])(_0x405bc1['lgpdAcceptedAt']))await _0x405bc1[_0x4e20e0(0x1e4)]({'status':_0x4e20e0(0x201)});await _0x405bc1[_0x4e20e0(0x1df)]();}if(_0x2a377c['toLocaleLowerCase']()==_0x4e20e0(0x280)){const _0x1e8493={'isBot':![],'status':_0x4e20e0(0x2a8),'sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x4e20e0(0x215)])({'ticketData':_0x1e8493,'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});return;}let _0x40e413=_0x48a9b1&&_0x15975b[_0x4e20e0(0x2de)]===0x1?_0x15975b[+_0x2a377c]:_0x15975b[+_0x2a377c-0x1];if(!_0x296841[_0x4e20e0(0x2cb)][_0x4e20e0(0x1f6)]&&!_0x405bc1['isGroup']&&_0x40e413?.[_0x4e20e0(0x24e)]){const _0x490a60=await(0x0,ShowQueueIntegrationService_1[_0x4e20e0(0x215)])(_0x40e413[_0x4e20e0(0x24e)],_0x124b7f);await(0x0,exports[_0x4e20e0(0x1dc)])(_0x296841,_0x42cf43,_0x124b7f,_0x490a60,_0x405bc1),await _0x405bc1[_0x4e20e0(0x1e4)]({'useIntegration':!![],'integrationId':_0x490a60['id']});}const _0x50499b=_0x32119d?.[_0x4e20e0(0x34b)]||_0x4e20e0(0x274);let _0x17ad8d;if(_0x40e413)try{const _0x8dd92a=await(0x0,ListUserQueueServices_1[_0x4e20e0(0x215)])(_0x40e413['id']);_0x8dd92a[_0x4e20e0(0x23e)]>-0x1&&(_0x17ad8d=_0x8dd92a[_0x4e20e0(0x23e)]);}catch(_0x3f4f7a){console[_0x4e20e0(0x254)](_0x3f4f7a);}const _0x15011d=async()=>{const _0xf8f68d=_0x4e20e0;if(_0x40e413||_0x15975b[_0xf8f68d(0x2de)]===0x1&&_0x48a9b1){if(_0x15975b[_0xf8f68d(0x2de)]===0x1)_0x40e413=_0x15975b[0x0];const _0xe5c35=await Queue_1[_0xf8f68d(0x215)][_0xf8f68d(0x30e)](_0x40e413['id']);let _0x23836c;_0x32119d?.[_0xf8f68d(0x2ca)]===_0xf8f68d(0x338)&&(_0x23836c=await(0x0,VerifyCurrentSchedule_1[_0xf8f68d(0x215)])(_0x124b7f,_0xe5c35['id'],0x0));if(_0x32119d?.[_0xf8f68d(0x2ca)]===_0xf8f68d(0x338)&&!(0x0,lodash_1['isNil'])(_0x23836c)&&(!_0x23836c||_0x23836c[_0xf8f68d(0x210)]===![])&&(!_0x405bc1['isGroup']||_0x405bc1[_0xf8f68d(0x334)]?.[_0xf8f68d(0x31c)]===_0xf8f68d(0x21c))){const _0x5541c8=_0xe5c35['outOfHoursMessage'];if(_0x5541c8!==''){const _0x10bbe3=(0x0,Mustache_1['default'])(''+_0x5541c8,_0x405bc1),_0x20011a=(0x0,Debounce_1[_0xf8f68d(0x252)])(async()=>{const _0x4a4054=_0xf8f68d;await _0x42cf43[_0x4a4054(0x26d)](_0x405bc1[_0x4a4054(0x213)][_0x4a4054(0x326)]+'@'+(_0x405bc1[_0x4a4054(0x216)]?_0x4a4054(0x2a9):_0x4a4054(0x20f)),{'text':_0x10bbe3});},0x3e8,_0x405bc1['id']);_0x20011a(),await _0x405bc1[_0xf8f68d(0x1e4)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x405bc1[_0xf8f68d(0x368)]+0x1});return;}await _0x405bc1[_0xf8f68d(0x1e4)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x405bc1[_0xf8f68d(0x368)]+0x1});return;}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x40e413['id']},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});if(_0x40e413[_0xf8f68d(0x231)][_0xf8f68d(0x2de)]>0x0&&!_0x405bc1[_0xf8f68d(0x216)]){let _0x20a842='';_0x40e413[_0xf8f68d(0x231)][_0xf8f68d(0x1e7)]((_0x9cc662,_0x4f63fd)=>{const _0x3f121b=_0xf8f68d;_0x20a842+=_0x3f121b(0x1e8)+(_0x4f63fd+0x1)+_0x3f121b(0x311)+_0x9cc662[_0x3f121b(0x33f)]+'\x0a';});const _0x586a67=(0x0,Mustache_1[_0xf8f68d(0x215)])('‎\x20'+_0x40e413[_0xf8f68d(0x263)]+'\x0a\x0a'+_0x20a842+'\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento',_0x405bc1),_0xd61224=await _0x42cf43['sendMessage'](_0x246a2f[_0xf8f68d(0x326)]+'@'+(_0x405bc1[_0xf8f68d(0x216)]?'g.us':_0xf8f68d(0x20f)),{'text':_0x586a67});await(0x0,exports[_0xf8f68d(0x2b5)])(_0xd61224,_0x405bc1,_0x246a2f,_0x2a6436),_0x32119d?.['settingsUserRandom']===_0xf8f68d(0x21c)&&await(0x0,UpdateTicketService_1['default'])({'ticketData':{'userId':_0x17ad8d},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});}if(!_0x40e413[_0xf8f68d(0x231)][_0xf8f68d(0x2de)]&&_0x40e413[_0xf8f68d(0x263)]['length']!==0x0){const _0x469757=(0x0,Mustache_1[_0xf8f68d(0x215)])('‎'+_0x40e413[_0xf8f68d(0x263)],_0x405bc1),_0x2b253f=await _0x42cf43[_0xf8f68d(0x26d)](_0x246a2f['number']+'@'+(_0x405bc1[_0xf8f68d(0x216)]?_0xf8f68d(0x2a9):_0xf8f68d(0x20f)),{'text':_0x469757});await(0x0,exports[_0xf8f68d(0x2b5)])(_0x2b253f,_0x405bc1,_0x246a2f,_0x2a6436);}if(!(0x0,lodash_1[_0xf8f68d(0x2f6)])(_0x40e413[_0xf8f68d(0x2eb)]))try{const _0x51a1c6=path_1[_0xf8f68d(0x215)][_0xf8f68d(0x29a)](__dirname,'..','..','..',_0xf8f68d(0x378)),_0x2726bf=await(0x0,ShowService_1[_0xf8f68d(0x215)])(_0x40e413[_0xf8f68d(0x2eb)],_0x405bc1[_0xf8f68d(0x1da)]),_0x319c6c=path_1[_0xf8f68d(0x215)][_0xf8f68d(0x29a)](_0x51a1c6,_0xf8f68d(0x289)+_0x405bc1['companyId'],_0xf8f68d(0x212),String(_0x2726bf['id']));for(const [_0x4ee45c,_0xa99429]of _0x2726bf[_0xf8f68d(0x2dd)][_0xf8f68d(0x20e)]()){const _0xacc97d={'fieldname':_0xf8f68d(0x2e0),'originalname':_0xa99429['path'],'encoding':_0xf8f68d(0x32e),'mimetype':_0xa99429['mediaType'],'filename':_0xa99429['path'],'path':path_1[_0xf8f68d(0x215)][_0xf8f68d(0x29a)](_0x319c6c,_0xa99429['path'])};await(0x0,SendWhatsAppMedia_1[_0xf8f68d(0x215)])({'media':_0xacc97d,'ticket':_0x405bc1,'body':_0xa99429['name'],'isPrivate':![],'isForwarded':![]});};await(0x0,baileys_1[_0xf8f68d(0x27c)])(0x7d0);}catch(_0x17a564){logger_1['logger'][_0xf8f68d(0x276)](_0x17a564);}if(_0x40e413[_0xf8f68d(0x376)]){await(0x0,UpdateTicketService_1[_0xf8f68d(0x215)])({'ticketData':{'status':_0xf8f68d(0x2a8),'queueId':_0x40e413['id'],'sendFarewellMessage':![]},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f}),await(0x0,CreateLogTicketService_1[_0xf8f68d(0x215)])({'ticketId':_0x405bc1['id'],'type':_0xf8f68d(0x2a8),'queueId':_0x40e413['id']});return;}const _0x199677=await Ticket_1['default'][_0xf8f68d(0x302)]({'where':{'userId':null,'status':_0xf8f68d(0x201),'companyId':_0x124b7f,'queueId':_0x40e413['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1['default'])({'ticketId':_0x405bc1['id'],'type':_0xf8f68d(0x338),'queueId':_0x40e413['id']});if(_0x3e20d2&&!_0x40e413[_0xf8f68d(0x231)]['length']){const _0x41c10b=_0x199677[_0xf8f68d(0x28f)]===0x0?0x1:_0x199677[_0xf8f68d(0x28f)],_0x1612aa=_0xf8f68d(0x1e1)+_0x41c10b+'*',_0x26fdd8=(0x0,Mustache_1[_0xf8f68d(0x215)])(''+_0x1612aa,_0x405bc1),_0x145f97=(0x0,Debounce_1[_0xf8f68d(0x252)])(async()=>{const _0x6416b5=_0xf8f68d;await _0x42cf43[_0x6416b5(0x26d)](_0x246a2f[_0x6416b5(0x326)]+'@'+(_0x405bc1['isGroup']?_0x6416b5(0x2a9):_0x6416b5(0x20f)),{'text':_0x26fdd8});},0xbb8,_0x405bc1['id']);_0x145f97();}}else{if(_0x405bc1[_0xf8f68d(0x216)])return;if(_0x2c4562&&_0x2c4562!==0x0&&_0x405bc1[_0xf8f68d(0x368)]>=_0x2c4562)return;const _0x50be66=await(0x0,FindOrCreateATicketTrakingService_1[_0xf8f68d(0x215)])({'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});let _0x23a6eb=new Date(),_0x17ff17=new Date();if(_0x50be66[_0xf8f68d(0x25b)]!==null){_0x23a6eb[_0xf8f68d(0x352)](_0x50be66[_0xf8f68d(0x25b)][_0xf8f68d(0x350)]()+Number(_0x336cfb));if(_0x50be66['chatbotAt']!==null&&_0x17ff17<_0x23a6eb&&_0x336cfb!=='0'&&_0x405bc1[_0xf8f68d(0x368)]!==0x0)return;}await _0x50be66[_0xf8f68d(0x1e4)]({'chatbotAt':null}),_0x42cf43['presenceSubscribe'](_0x246a2f[_0xf8f68d(0x356)]);let _0x107369='';_0x42cf43[_0xf8f68d(0x240)](_0xf8f68d(0x23a),_0x246a2f[_0xf8f68d(0x356)]),_0x15975b['forEach']((_0x49d232,_0xfb0494)=>{const _0x431235=_0xf8f68d;_0x107369+=_0x431235(0x1e8)+(_0xfb0494+0x1)+_0x431235(0x311)+_0x49d232[_0x431235(0x33f)]+'\x0a';}),_0x107369+=_0xf8f68d(0x33d);const _0x1ee325=(0x0,Mustache_1[_0xf8f68d(0x215)])('‎'+_0x61e0b9+'\x0a\x0a'+_0x107369,_0x405bc1);await(0x0,CreateLogTicketService_1[_0xf8f68d(0x215)])({'ticketId':_0x405bc1['id'],'type':_0xf8f68d(0x2bd)}),await(0x0,baileys_1['delay'])(0x3e8),await _0x42cf43[_0xf8f68d(0x240)](_0xf8f68d(0x2af),_0x246a2f[_0xf8f68d(0x356)]);if(_0x405bc1[_0xf8f68d(0x334)][_0xf8f68d(0x21b)]!==null){const _0x5baf1c=path_1[_0xf8f68d(0x215)][_0xf8f68d(0x29a)](_0xf8f68d(0x378),_0xf8f68d(0x289)+_0x124b7f,_0x405bc1[_0xf8f68d(0x334)][_0xf8f68d(0x21b)]),_0xda3385=_0x405bc1['whatsapp']['greetingMediaAttachment'],_0x1420aa=await(0x0,SendWhatsAppMedia_1[_0xf8f68d(0x239)])(_0xda3385,_0x5baf1c,String(_0x124b7f),_0x1ee325),_0x42d12f=(0x0,Debounce_1[_0xf8f68d(0x252)])(async()=>{const _0x20dee9=_0xf8f68d;let _0x3e67ff=await _0x42cf43[_0x20dee9(0x26d)](_0x405bc1['contact'][_0x20dee9(0x326)]+'@'+(_0x405bc1[_0x20dee9(0x216)]?_0x20dee9(0x2a9):_0x20dee9(0x20f)),{..._0x1420aa});await(0x0,exports[_0x20dee9(0x271)])(_0x3e67ff,_0x405bc1,_0x246a2f,_0x50be66);},0x3e8,_0x405bc1['id']);_0x42d12f(),await(0x0,UpdateTicketService_1[_0xf8f68d(0x215)])({'ticketData':{'amountUsedBotQueues':_0x405bc1[_0xf8f68d(0x368)]+0x1},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});return;}else{const _0x15bc0f=(0x0,Debounce_1[_0xf8f68d(0x252)])(async()=>{const _0x3174f0=_0xf8f68d,_0x140249=await _0x42cf43[_0x3174f0(0x26d)](_0x246a2f[_0x3174f0(0x326)]+'@'+(_0x405bc1['isGroup']?_0x3174f0(0x2a9):_0x3174f0(0x20f)),{'text':_0x1ee325});(0x0,exports['verifyMessage'])(_0x140249,_0x405bc1,_0x246a2f,_0x50be66);},0x3e8,_0x405bc1['id']);await(0x0,UpdateTicketService_1[_0xf8f68d(0x215)])({'ticketData':{'amountUsedBotQueues':_0x405bc1['amountUsedBotQueues']+0x1},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f}),_0x15bc0f();}}},_0x5bd068=async()=>{const _0x77a2b=_0x4e20e0;if(_0x40e413){await(0x0,UpdateTicketService_1[_0x77a2b(0x215)])({'ticketData':{'queueId':_0x40e413['id']},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});if(_0x40e413[_0x77a2b(0x231)]['length']>0x0){const _0x43a9ba=[];_0x40e413[_0x77a2b(0x231)]['forEach']((_0x1a0e02,_0x30251c)=>{_0x43a9ba['push']({'buttonId':''+(_0x30251c+0x1),'buttonText':{'displayText':_0x1a0e02['name']},'type':0x1});});const _0x1dd941={'text':(0x0,Mustache_1[_0x77a2b(0x215)])(''+_0x40e413[_0x77a2b(0x263)],_0x405bc1),'buttons':_0x43a9ba,'headerType':0x4},_0x36c57e=await _0x42cf43[_0x77a2b(0x26d)](_0x246a2f[_0x77a2b(0x326)]+'@'+(_0x405bc1['isGroup']?'g.us':_0x77a2b(0x20f)),_0x1dd941);await(0x0,exports['verifyMessage'])(_0x36c57e,_0x405bc1,_0x246a2f,_0x2a6436);}if(!_0x40e413[_0x77a2b(0x231)]['length']){const _0x43addb=(0x0,Mustache_1[_0x77a2b(0x215)])(''+_0x40e413[_0x77a2b(0x263)],_0x405bc1),_0x5bff02=await _0x42cf43[_0x77a2b(0x26d)](_0x246a2f[_0x77a2b(0x326)]+'@'+(_0x405bc1['isGroup']?_0x77a2b(0x2a9):_0x77a2b(0x20f)),{'text':_0x43addb});await(0x0,exports['verifyMessage'])(_0x5bff02,_0x405bc1,_0x246a2f,_0x2a6436);}}else{const _0x2f2a28=[];_0x15975b[_0x77a2b(0x1e7)]((_0x276fe0,_0x3d51d5)=>{const _0x8c6675=_0x77a2b;_0x2f2a28[_0x8c6675(0x2bf)]({'buttonId':''+(_0x3d51d5+0x1),'buttonText':{'displayText':_0x276fe0[_0x8c6675(0x33f)]},'type':0x4});});const _0x5c62fa={'text':(0x0,Mustache_1[_0x77a2b(0x215)])(''+_0x61e0b9,_0x405bc1),'footer':'','buttons':_0x2f2a28,'headerType':0x4},_0x4f14b8=await _0x42cf43['sendMessage'](_0x246a2f['number']+'@'+(_0x405bc1[_0x77a2b(0x216)]?_0x77a2b(0x2a9):_0x77a2b(0x20f)),_0x5c62fa);await(0x0,exports[_0x77a2b(0x2b5)])(_0x4f14b8,_0x405bc1,_0x246a2f,_0x2a6436),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':_0x405bc1[_0x77a2b(0x368)]+0x1},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});}},_0x30d1a4=async()=>{const _0x4745a3=_0x4e20e0;if(_0x40e413){await(0x0,UpdateTicketService_1[_0x4745a3(0x215)])({'ticketData':{'queueId':_0x40e413['id']},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});if(_0x40e413['chatbots']['length']>0x0){const _0x378137=[];_0x40e413[_0x4745a3(0x231)]['forEach']((_0x351d5d,_0x52291b)=>{const _0x5eac22=_0x4745a3;_0x378137[_0x5eac22(0x2bf)]({'title':_0x351d5d[_0x5eac22(0x33f)],'rowId':''+(_0x52291b+0x1)});});const _0x516719=[{'title':_0x4745a3(0x29c),'rows':_0x378137}],_0x55b228={'text':(0x0,Mustache_1[_0x4745a3(0x215)])(''+_0x40e413[_0x4745a3(0x263)],_0x405bc1),'buttonText':_0x4745a3(0x305),'sections':_0x516719},_0x1493df=await _0x42cf43[_0x4745a3(0x26d)](_0x246a2f[_0x4745a3(0x326)]+'@'+(_0x405bc1[_0x4745a3(0x216)]?_0x4745a3(0x2a9):_0x4745a3(0x20f)),_0x55b228);await(0x0,exports['verifyMessage'])(_0x1493df,_0x405bc1,_0x246a2f,_0x2a6436);}if(!_0x40e413['chatbots'][_0x4745a3(0x2de)]){const _0x2aa0c3=(0x0,Mustache_1['default'])(''+_0x40e413['greetingMessage'],_0x405bc1),_0x49a4ad=await _0x42cf43['sendMessage'](_0x246a2f['number']+'@'+(_0x405bc1[_0x4745a3(0x216)]?_0x4745a3(0x2a9):'s.whatsapp.net'),{'text':_0x2aa0c3});await(0x0,exports[_0x4745a3(0x2b5)])(_0x49a4ad,_0x405bc1,_0x246a2f,_0x2a6436);}}else{const _0x573ff6=[];_0x15975b[_0x4745a3(0x1e7)]((_0xc3926f,_0x4e0a53)=>{const _0x33092a=_0x4745a3;_0x573ff6[_0x33092a(0x2bf)]({'title':_0xc3926f['name'],'rowId':''+(_0x4e0a53+0x1)});});const _0x39259a=[{'title':_0x4745a3(0x29c),'rows':_0x573ff6}],_0x26aa70={'text':(0x0,Mustache_1[_0x4745a3(0x215)])(''+_0x61e0b9,_0x405bc1),'buttonText':_0x4745a3(0x305),'sections':_0x39259a},_0x203973=await _0x42cf43[_0x4745a3(0x26d)](_0x246a2f[_0x4745a3(0x326)]+'@'+(_0x405bc1[_0x4745a3(0x216)]?'g.us':_0x4745a3(0x20f)),_0x26aa70);await(0x0,exports['verifyMessage'])(_0x203973,_0x405bc1,_0x246a2f,_0x2a6436),await(0x0,UpdateTicketService_1[_0x4745a3(0x215)])({'ticketData':{'amountUsedBotQueues':_0x405bc1[_0x4745a3(0x368)]+0x1},'ticketId':_0x405bc1['id'],'companyId':_0x124b7f});}};if(_0x50499b==='text')return _0x15011d();if(_0x50499b===_0x4e20e0(0x32a)&&_0x15975b[_0x4e20e0(0x2de)]>0x3)return _0x15011d();if(_0x50499b==='button'&&_0x15975b['length']<=0x3)return _0x5bd068();if(_0x50499b===_0x4e20e0(0x293))return _0x30d1a4();},verifyRating=_0x28ea41=>{const _0x9b37bd=a627_0x19fe46;if(_0x28ea41&&_0x28ea41['finishedAt']===null&&_0x28ea41[_0x9b37bd(0x1fb)]!==null&&_0x28ea41[_0x9b37bd(0x23e)]!==null&&_0x28ea41[_0x9b37bd(0x258)]===null)return!![];return![];};exports[a627_0x19fe46(0x36c)]=verifyRating;const handleRating=async(_0x31ea12,_0x2b3362,_0x538705)=>{const _0x7e5f69=a627_0x19fe46,_0x10797c=(0x0,socket_1[_0x7e5f69(0x331)])(),_0x67ed22=_0x2b3362[_0x7e5f69(0x1da)],{complationMessage:_0x4fd34f}=await(0x0,ShowWhatsAppService_1[_0x7e5f69(0x215)])(_0x2b3362['whatsappId'],_0x67ed22);let _0x35bde3=_0x31ea12;_0x31ea12<0x0&&(_0x35bde3=0x0);_0x31ea12>0xa&&(_0x35bde3=0xa);await UserRating_1[_0x7e5f69(0x215)]['create']({'ticketId':_0x538705[_0x7e5f69(0x35e)],'companyId':_0x538705[_0x7e5f69(0x1da)],'userId':_0x538705[_0x7e5f69(0x23e)],'rate':_0x35bde3});if(!(0x0,lodash_1[_0x7e5f69(0x2f6)])(_0x4fd34f)&&_0x4fd34f!==''&&!_0x2b3362['isGroup']){const _0x3476a6=(0x0,Mustache_1[_0x7e5f69(0x215)])('‎'+_0x4fd34f,_0x2b3362);if(_0x2b3362['channel']===_0x7e5f69(0x334)){const _0x285a60=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3476a6,'ticket':_0x2b3362});await(0x0,exports[_0x7e5f69(0x2b5)])(_0x285a60,_0x2b3362,_0x2b3362[_0x7e5f69(0x213)],_0x538705);}['facebook',_0x7e5f69(0x35a)]['includes'](_0x2b3362[_0x7e5f69(0x2ab)])&&await(0x0,sendFacebookMessage_1[_0x7e5f69(0x215)])({'body':_0x3476a6,'ticket':_0x2b3362});}await _0x2b3362[_0x7e5f69(0x1e4)]({'chatbot':null,'status':_0x7e5f69(0x2a8),'amountUseBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1[_0x7e5f69(0x215)])({'userId':_0x2b3362[_0x7e5f69(0x23e)],'queueId':_0x2b3362[_0x7e5f69(0x24b)],'ticketId':_0x2b3362['id'],'type':_0x7e5f69(0x2a8)}),_0x10797c['to']('open')[_0x7e5f69(0x351)](_0x7e5f69(0x264)+_0x67ed22+'-ticket',{'action':'delete','ticket':_0x2b3362,'ticketId':_0x2b3362['id']}),_0x10797c['to'](_0x2b3362['status'])['to'](_0x2b3362['id'][_0x7e5f69(0x371)]())['emit'](_0x7e5f69(0x264)+_0x67ed22+'-ticket',{'action':_0x7e5f69(0x1e4),'ticket':_0x2b3362,'ticketId':_0x2b3362['id']});};exports[a627_0x19fe46(0x2b1)]=handleRating;const sanitizeName=_0x35ebe3=>{const _0xa9e719=a627_0x19fe46;let _0x5301e2=_0x35ebe3[_0xa9e719(0x205)]('\x20')[0x0];return _0x5301e2=_0x5301e2[_0xa9e719(0x373)](/[^a-zA-Z0-9]/g,''),_0x5301e2[_0xa9e719(0x340)](0x0,0x3c);},deleteFileSync=_0x535753=>{const _0x1d1ab5=a627_0x19fe46;try{fs_2[_0x1d1ab5(0x215)][_0x1d1ab5(0x2d2)](_0x535753);}catch(_0x73a020){console[_0x1d1ab5(0x254)](_0x1d1ab5(0x34e),_0x73a020);}},convertTextToSpeechAndSaveToFile=(_0x1903e5,_0x327f9d,_0x445f42,_0x15895e,_0x4c23cc='pt-BR-FabioNeural',_0x36547a=a627_0x19fe46(0x267))=>{return new Promise((_0x2aea42,_0x1158da)=>{const _0x2a4e87=a627_0x11f0,_0x115bf2=microsoft_cognitiveservices_speech_sdk_1[_0x2a4e87(0x1f4)][_0x2a4e87(0x219)](_0x445f42,_0x15895e);_0x115bf2[_0x2a4e87(0x1db)]=_0x4c23cc;const _0x54cda9=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x2a4e87(0x296)](_0x327f9d+_0x2a4e87(0x257)),_0x1b7cb7=new microsoft_cognitiveservices_speech_sdk_1[(_0x2a4e87(0x2c5))](_0x115bf2,_0x54cda9);_0x1b7cb7[_0x2a4e87(0x26b)](_0x1903e5,_0x4bcce8=>{const _0x5df12c=_0x2a4e87;_0x4bcce8?convertWavToAnotherFormat(_0x327f9d+_0x5df12c(0x257),_0x327f9d+'.'+_0x36547a,_0x36547a)[_0x5df12c(0x26c)](_0x528859=>{_0x2aea42();})[_0x5df12c(0x2d4)](_0x311106=>{const _0x1862b1=_0x5df12c;console[_0x1862b1(0x254)](_0x311106),_0x1158da(_0x311106);}):_0x1158da(new Error(_0x5df12c(0x27e))),_0x1b7cb7[_0x5df12c(0x33c)]();},_0x258e6d=>{const _0x4220a8=_0x2a4e87;console[_0x4220a8(0x254)](_0x4220a8(0x2b2)+_0x258e6d),_0x1b7cb7[_0x4220a8(0x33c)](),_0x1158da(_0x258e6d);});});},convertWavToAnotherFormat=(_0x4328ff,_0x4381a5,_0x4d9565)=>{return new Promise((_0x477b56,_0x25b38f)=>{const _0x93a212=a627_0x11f0;(0x0,fluent_ffmpeg_1['default'])()[_0x93a212(0x25a)](_0x4328ff)[_0x93a212(0x365)](_0x4d9565)['on'](_0x93a212(0x211),()=>_0x477b56(_0x4381a5))['on'](_0x93a212(0x254),_0x37ec37=>_0x25b38f(new Error(_0x93a212(0x279)+_0x37ec37[_0x93a212(0x2cd)])))[_0x93a212(0x2c4)](_0x4381a5);});},keepOnlySpecifiedChars=_0x5c9824=>{const _0x5ad421=a627_0x19fe46;return _0x5c9824[_0x5ad421(0x373)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x59f4cd,_0x47b5e7,_0x2b1a23,_0x3d8b33,_0x50f0de)=>{const _0x32ed14=a627_0x19fe46,_0x414107=(0x0,exports[_0x32ed14(0x286)])(_0x59f4cd);if(!_0x414107)return;const {prompt:_0x204237}=await(0x0,ShowWhatsAppService_1['default'])(_0x47b5e7['id'],_0x2b1a23[_0x32ed14(0x1da)]);if(!_0x204237)return;if(_0x59f4cd['messageStubType'])return;const _0x27b91d=path_1[_0x32ed14(0x215)]['resolve'](__dirname,'..','..','..',_0x32ed14(0x378),_0x32ed14(0x289)+_0x2b1a23[_0x32ed14(0x1da)]);let _0x3438cd;const _0x13bd58=sessionsOpenAi['findIndex'](_0x5c3f7=>_0x5c3f7['id']===_0x47b5e7['id']);if(_0x13bd58===-0x1){const _0xb6c6d9=new openai_1[(_0x32ed14(0x319))]({'apiKey':_0x204237[_0x32ed14(0x1ea)]});_0x3438cd=new openai_1[(_0x32ed14(0x244))](_0xb6c6d9),_0x3438cd['id']=_0x47b5e7['id'],sessionsOpenAi[_0x32ed14(0x2bf)](_0x3438cd);}else _0x3438cd=sessionsOpenAi[_0x13bd58];const _0x38240a=await Message_1['default'][_0x32ed14(0x1ee)]({'where':{'ticketId':_0x2b1a23['id']},'order':[['createdAt','ASC']],'limit':_0x204237[_0x32ed14(0x2a6)]}),_0x27dd58='Nas\x20respostas\x20utilize\x20o\x20nome\x20'+sanitizeName(_0x3d8b33['name']||'Amigo(a)')+_0x32ed14(0x1f3)+_0x204237[_0x32ed14(0x31e)]+_0x32ed14(0x29f)+_0x204237[_0x32ed14(0x295)]+'\x0a';let _0x1ec135=[];if(_0x59f4cd[_0x32ed14(0x2cd)]?.[_0x32ed14(0x313)]||_0x59f4cd[_0x32ed14(0x2cd)]?.[_0x32ed14(0x2e1)]?.[_0x32ed14(0x274)]){_0x1ec135=[],_0x1ec135[_0x32ed14(0x2bf)]({'role':_0x32ed14(0x312),'content':_0x27dd58});for(let _0x4934d1=0x0;_0x4934d1<Math[_0x32ed14(0x1e2)](_0x204237[_0x32ed14(0x2a6)],_0x38240a[_0x32ed14(0x2de)]);_0x4934d1++){const _0x5861ba=_0x38240a[_0x4934d1];_0x5861ba['mediaType']==='chat'&&(_0x5861ba[_0x32ed14(0x1f6)]?_0x1ec135[_0x32ed14(0x2bf)]({'role':'assistant','content':_0x5861ba['body']}):_0x1ec135['push']({'role':'user','content':_0x5861ba['body']}));}_0x1ec135[_0x32ed14(0x2bf)]({'role':'user','content':_0x414107});const _0x3d9dc7=await _0x3438cd['createChatCompletion']({'model':_0x32ed14(0x353),'messages':_0x1ec135,'max_tokens':_0x204237[_0x32ed14(0x31e)],'temperature':_0x204237[_0x32ed14(0x25e)]});let _0x5ace72=_0x3d9dc7[_0x32ed14(0x225)][_0x32ed14(0x2b9)][0x0][_0x32ed14(0x2cd)]?.[_0x32ed14(0x236)];_0x5ace72?.[_0x32ed14(0x24f)](_0x32ed14(0x2f5))&&(await transferQueue(_0x204237[_0x32ed14(0x24b)],_0x2b1a23,_0x3d8b33),_0x5ace72=_0x5ace72[_0x32ed14(0x373)](_0x32ed14(0x2f5),'')[_0x32ed14(0x275)]());if(_0x204237[_0x32ed14(0x28a)]==='texto'){const _0x3fcecd=await _0x47b5e7[_0x32ed14(0x26d)](_0x59f4cd[_0x32ed14(0x2cb)]['remoteJid'],{'text':_0x5ace72});await(0x0,exports[_0x32ed14(0x2b5)])(_0x3fcecd,_0x2b1a23,_0x3d8b33);}else{const _0x1843f9=_0x2b1a23['id']+'_'+Date['now']();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x5ace72),_0x27b91d+'/'+_0x1843f9,_0x204237['voiceKey'],_0x204237[_0x32ed14(0x235)],_0x204237[_0x32ed14(0x28a)],_0x32ed14(0x267))['then'](async()=>{const _0x468f13=_0x32ed14;try{const _0x14c26d=await _0x47b5e7[_0x468f13(0x26d)](_0x59f4cd[_0x468f13(0x2cb)][_0x468f13(0x356)],{'audio':{'url':_0x27b91d+'/'+_0x1843f9+_0x468f13(0x2da)},'mimetype':_0x468f13(0x221),'ptt':!![]});await(0x0,exports['verifyMediaMessage'])(_0x14c26d,_0x2b1a23,_0x3d8b33),deleteFileSync(_0x27b91d+'/'+_0x1843f9+_0x468f13(0x2da)),deleteFileSync(_0x27b91d+'/'+_0x1843f9+_0x468f13(0x257));}catch(_0x1cc8a7){console[_0x468f13(0x322)]('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x1cc8a7);}});}}else{if(_0x59f4cd['message']?.['audioMessage']){const _0x30170c=_0x50f0de[_0x32ed14(0x335)][_0x32ed14(0x205)]('/')[_0x32ed14(0x203)](),_0x1b98e3=fs_2[_0x32ed14(0x215)][_0x32ed14(0x327)](_0x27b91d+'/'+_0x30170c),_0x4e1fce=await _0x3438cd[_0x32ed14(0x217)](_0x1b98e3,_0x32ed14(0x23c));_0x1ec135=[],_0x1ec135[_0x32ed14(0x2bf)]({'role':'system','content':_0x27dd58});for(let _0x31821b=0x0;_0x31821b<Math[_0x32ed14(0x1e2)](_0x204237[_0x32ed14(0x2a6)],_0x38240a[_0x32ed14(0x2de)]);_0x31821b++){const _0x13cf0e=_0x38240a[_0x31821b];_0x13cf0e['mediaType']===_0x32ed14(0x345)&&(_0x13cf0e[_0x32ed14(0x1f6)]?_0x1ec135[_0x32ed14(0x2bf)]({'role':_0x32ed14(0x2f0),'content':_0x13cf0e[_0x32ed14(0x2c1)]}):_0x1ec135[_0x32ed14(0x2bf)]({'role':'user','content':_0x13cf0e[_0x32ed14(0x2c1)]}));}_0x1ec135[_0x32ed14(0x2bf)]({'role':_0x32ed14(0x1e6),'content':_0x4e1fce['data'][_0x32ed14(0x274)]});const _0xd7d56=await _0x3438cd[_0x32ed14(0x294)]({'model':_0x32ed14(0x353),'messages':_0x1ec135,'max_tokens':_0x204237[_0x32ed14(0x31e)],'temperature':_0x204237['temperature']});let _0x26835b=_0xd7d56[_0x32ed14(0x225)][_0x32ed14(0x2b9)][0x0][_0x32ed14(0x2cd)]?.[_0x32ed14(0x236)];_0x26835b?.[_0x32ed14(0x24f)](_0x32ed14(0x2f5))&&(await transferQueue(_0x204237[_0x32ed14(0x24b)],_0x2b1a23,_0x3d8b33),_0x26835b=_0x26835b[_0x32ed14(0x373)](_0x32ed14(0x2f5),'')[_0x32ed14(0x275)]());if(_0x204237[_0x32ed14(0x28a)]===_0x32ed14(0x320)){const _0x35812c=await _0x47b5e7[_0x32ed14(0x26d)](_0x59f4cd[_0x32ed14(0x2cb)]['remoteJid'],{'text':_0x26835b});await(0x0,exports[_0x32ed14(0x2b5)])(_0x35812c,_0x2b1a23,_0x3d8b33);}else{const _0x14a8da=_0x2b1a23['id']+'_'+Date[_0x32ed14(0x21f)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x26835b),_0x27b91d+'/'+_0x14a8da,_0x204237[_0x32ed14(0x245)],_0x204237[_0x32ed14(0x235)],_0x204237[_0x32ed14(0x28a)],'mp3')[_0x32ed14(0x26c)](async()=>{const _0x47bc82=_0x32ed14;try{const _0x374637=await _0x47b5e7[_0x47bc82(0x26d)](_0x59f4cd['key']['remoteJid'],{'audio':{'url':_0x27b91d+'/'+_0x14a8da+_0x47bc82(0x2da)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports['verifyMediaMessage'])(_0x374637,_0x2b1a23,_0x3d8b33),deleteFileSync(_0x27b91d+'/'+_0x14a8da+'.mp3'),deleteFileSync(_0x27b91d+'/'+_0x14a8da+_0x47bc82(0x257));}catch(_0x5e68ea){console['log'](_0x47bc82(0x2fa)+_0x5e68ea);}});}}}_0x1ec135=[];},transferQueue=async(_0x38a177,_0x172101,_0x443da3)=>{const _0x3bc74b=a627_0x19fe46;await(0x0,UpdateTicketService_1[_0x3bc74b(0x215)])({'ticketData':{'queueId':_0x38a177},'ticketId':_0x172101['id'],'companyId':_0x172101[_0x3bc74b(0x1da)]});},handleMessageIntegration=async(_0x457f4b,_0x17e36b,_0x4507c7,_0x395f16,_0x462be2)=>{const _0x23be90=a627_0x19fe46,_0x1db651=getTypeMessage(_0x457f4b);if(_0x395f16['type']===_0x23be90(0x34c)||_0x395f16[_0x23be90(0x256)]===_0x23be90(0x2f7)){if(_0x395f16?.[_0x23be90(0x277)]){const _0x539fa1={'method':_0x23be90(0x2bb),'url':_0x395f16?.[_0x23be90(0x277)],'headers':{'Content-Type':_0x23be90(0x2be)},'json':_0x457f4b};try{request(_0x539fa1,function(_0x364d44,_0x23bf1a){const _0x352408=_0x23be90;if(_0x364d44)throw new Error(_0x364d44);else console[_0x352408(0x322)](_0x23bf1a[_0x352408(0x2c1)]);});}catch(_0x43764e){throw new Error(_0x43764e);}}}else{if(_0x395f16[_0x23be90(0x256)]===_0x23be90(0x30d)){let _0x3e17e2;if(_0x1db651===_0x23be90(0x22a)){let _0x4d01e4=_0x457f4b[_0x23be90(0x2a1)]+_0x23be90(0x1e9);(0x0,fs_1['readFile'])((0x0,path_1[_0x23be90(0x285)])(__dirname,'..','..','..',_0x23be90(0x378),_0x23be90(0x289)+_0x4507c7,_0x4d01e4),_0x23be90(0x30a),(_0x5ebe3,_0x517fe7)=>{const _0x16e7c1=_0x23be90;_0x3e17e2=_0x517fe7,_0x5ebe3&&logger_1['logger'][_0x16e7c1(0x254)](_0x5ebe3);});}else _0x3e17e2=undefined;const _0x16bad0=(0x0,Debounce_1[_0x23be90(0x252)])(async()=>{await sendDialogflowAwswer(_0x17e36b,_0x462be2,_0x457f4b,_0x462be2['contact'],_0x3e17e2,_0x4507c7,_0x395f16);},0x1f4,_0x462be2['id']);_0x16bad0();}else _0x395f16['type']===_0x23be90(0x2c3)&&(console[_0x23be90(0x322)]('entrou\x20no\x20typebot'),await(0x0,typebotListener_1['default'])({'wbot':_0x17e36b,'msg':_0x457f4b,'ticket':_0x462be2,'typebot':_0x395f16}));}};exports[a627_0x19fe46(0x1dc)]=handleMessageIntegration;const handleMessage=async(_0x57e068,_0x4aa730,_0x46e746,_0xda22f3=![])=>{const _0x5a0528=a627_0x19fe46;if(_0xda22f3){(0x0,addLogs_1[_0x5a0528(0x318)])({'fileName':'processImportMessagesWppId'+_0x4aa730['id']+_0x5a0528(0x2c9),'text':_0x5a0528(0x2fc)+JSON['stringify'](_0x57e068,null,0x2)+_0x5a0528(0x2a5)});let _0x282226=_0x57e068[_0x5a0528(0x2cb)]['id'],_0x2152a6=await Message_1['default'][_0x5a0528(0x1ef)]({'where':{'wid':_0x282226}});if(_0x2152a6){await new Promise(_0xe44d2e=>setTimeout(_0xe44d2e,0x96)),console[_0x5a0528(0x322)](_0x5a0528(0x23d));return;}else await new Promise(_0x305501=>setTimeout(_0x305501,parseInt(process[_0x5a0528(0x2e2)]['TIMEOUT_TO_IMPORT_MESSAGE'])||0x14a));}else await new Promise(_0x2bfad4=>setTimeout(_0x2bfad4,i*0x28a)),i++;if(!isValidMsg(_0x57e068))return;try{let _0xbc6577,_0x516ef2,_0x167c52=0x0,_0x5ed353=0x0,_0x2641a0=0x0,_0x9d78b1=(0x0,exports[_0x5a0528(0x286)])(_0x57e068);const _0x1c357b=getTypeMessage(_0x57e068);if(_0x1c357b==='protocolMessage')return;const _0x44996a=_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x22a)]||_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x2d0)]||_0x57e068[_0x5a0528(0x2cd)]?.['videoMessage']||_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x2ea)]||_0x57e068[_0x5a0528(0x2cd)][_0x5a0528(0x250)]||_0x57e068?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x374)]?.[_0x5a0528(0x2cd)]?.['imageMessage']||_0x57e068?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x374)]?.['message']?.[_0x5a0528(0x22a)]||_0x57e068?.['message']?.[_0x5a0528(0x374)]?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x206)]||_0x57e068?.['message']?.[_0x5a0528(0x374)]?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x2ea)]||_0x57e068?.[_0x5a0528(0x2cd)]?.['ephemeralMessage']?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x250)]||_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x1fc)]?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x2d0)]||_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x1fc)]?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x206)]||_0x57e068[_0x5a0528(0x2cd)]?.['ephemeralMessage']?.[_0x5a0528(0x2cd)]?.['viewOnceMessage']?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x2d0)]||_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x374)]?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x1fc)]?.['message']?.['videoMessage']||_0x57e068[_0x5a0528(0x2cd)]?.[_0x5a0528(0x26f)]?.[_0x5a0528(0x2cd)]?.[_0x5a0528(0x2ea)];if(_0x57e068[_0x5a0528(0x2cb)]['fromMe']){if(/\u200e/[_0x5a0528(0x324)](_0x9d78b1))return;if(!_0x44996a&&_0x1c357b!==_0x5a0528(0x313)&&_0x1c357b!=='extendedTextMessage'&&_0x1c357b!==_0x5a0528(0x35c)&&_0x1c357b!==_0x5a0528(0x33b)&&_0x1c357b!==_0x5a0528(0x374)&&_0x1c357b!=='protocolMessage'&&_0x1c357b!=='viewOnceMessage'&&_0x1c357b!=='editedMessage')return;_0xbc6577=await getContactMessage(_0x57e068,_0x4aa730);}else _0xbc6577=await getContactMessage(_0x57e068,_0x4aa730);const _0x3a4d4c=_0x57e068['key'][_0x5a0528(0x356)]?.[_0x5a0528(0x355)]('@g.us'),_0x3f49a8=await(0x0,ShowWhatsAppService_1[_0x5a0528(0x215)])(_0x4aa730['id'],_0x46e746);if(!_0x3f49a8['allowGroup']&&_0x3a4d4c)return;if(_0x3a4d4c){const _0xd7b49d=await _0x4aa730[_0x5a0528(0x25f)](_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x356)]),_0x4c44cd={'id':_0xd7b49d['id'],'name':_0xd7b49d['subject']};_0x516ef2=await verifyContact(_0x4c44cd,_0x4aa730,_0x46e746);}const _0x32adf4=await verifyContact(_0xbc6577,_0x4aa730,_0x46e746);let _0xc112bb=0x0,_0x5d61d6=null;if(_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)])await cache_1[_0x5a0528(0x215)][_0x5a0528(0x339)]('contacts:'+_0x32adf4['id']+_0x5a0528(0x204),'0');else{const _0x1632e6=await cache_1[_0x5a0528(0x215)][_0x5a0528(0x330)](_0x5a0528(0x226)+_0x32adf4['id']+_0x5a0528(0x204));_0xc112bb=+_0x1632e6+0x1,await cache_1[_0x5a0528(0x215)][_0x5a0528(0x339)](_0x5a0528(0x226)+_0x32adf4['id']+_0x5a0528(0x204),''+_0xc112bb);}const _0x34478e=await CompaniesSettings_1[_0x5a0528(0x215)]['findOne']({'where':{'companyId':_0x46e746}}),_0x17a4a7=_0x34478e[_0x5a0528(0x2ff)]===_0x5a0528(0x21c),{ticket:_0x4ee8c5,isCreated:_0x361c7e}=await(0x0,FindOrCreateTicketService_1[_0x5a0528(0x215)])(_0x32adf4,_0x3f49a8,_0xc112bb,_0x46e746,_0x167c52,_0x2641a0,_0x516ef2,'whatsapp',_0xda22f3,![],_0x34478e);_0x5d61d6=_0x4ee8c5;if(_0x5d61d6[_0x5a0528(0x2aa)]===_0x5a0528(0x2a8)||_0xc112bb===0x0&&_0x3f49a8[_0x5a0528(0x21a)]&&(0x0,Mustache_1[_0x5a0528(0x215)])(_0x3f49a8[_0x5a0528(0x21a)],_0x5d61d6)===_0x9d78b1)return;if(!_0x57e068[_0x5a0528(0x2cb)]['fromMe']&&_0x3f49a8?.[_0x5a0528(0x24e)]>0x0){const _0x164add=await(0x0,ShowQueueIntegrationService_1['default'])(_0x3f49a8[_0x5a0528(0x24e)],_0x46e746);await(0x0,exports[_0x5a0528(0x1dc)])(_0x57e068,_0x4aa730,_0x46e746,_0x164add,_0x5d61d6),await _0x5d61d6['update']({'useIntegration':!![],'integrationId':_0x164add['id']});}if(_0x1c357b===_0x5a0528(0x1fd)){const _0x5c80f1=_0x57e068['message']['editedMessage'][_0x5a0528(0x2cd)][_0x5a0528(0x314)][_0x5a0528(0x2cb)]['id'],_0x296360=_0x57e068[_0x5a0528(0x2cd)][_0x5a0528(0x1fd)][_0x5a0528(0x2cd)][_0x5a0528(0x314)][_0x5a0528(0x1fd)][_0x5a0528(0x313)],_0x26fc5b=(0x0,socket_1[_0x5a0528(0x331)])();try{const _0x222d46=await Message_1['default'][_0x5a0528(0x1ef)]({'where':{'wid':_0x5c80f1,'companyId':_0x46e746,'ticketId':_0x5d61d6['id']}});if(!_0x222d46)return;await _0x222d46['update']({'isEdited':!![],'body':_0x296360}),await _0x5d61d6[_0x5a0528(0x1e4)]({'lastMessage':_0x296360}),_0x26fc5b['to'](_0x222d46[_0x5a0528(0x35e)][_0x5a0528(0x371)]())[_0x5a0528(0x351)](_0x5a0528(0x264)+_0x222d46['companyId']+_0x5a0528(0x227),{'action':_0x5a0528(0x1e4),'message':_0x222d46});}catch(_0x4b8677){Sentry[_0x5a0528(0x2e3)](_0x4b8677),logger_1[_0x5a0528(0x2cf)][_0x5a0528(0x254)](_0x5a0528(0x25d)+_0x4b8677);}return;}const _0x78512a=await(0x0,FindOrCreateATicketTrakingService_1[_0x5a0528(0x215)])({'ticketId':_0x5d61d6['id'],'companyId':_0x46e746,'whatsappId':_0x3f49a8?.['id']});try{if(!_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)]){if(_0x5d61d6[_0x5a0528(0x2aa)]===_0x5a0528(0x306)&&_0x78512a!==null&&(0x0,exports[_0x5a0528(0x36c)])(_0x78512a)){_0x44996a?await(0x0,exports[_0x5a0528(0x271)])(_0x57e068,_0x5d61d6,_0x32adf4):await(0x0,exports[_0x5a0528(0x2b5)])(_0x57e068,_0x5d61d6,_0x32adf4,_0x78512a);if(!isNaN(parseFloat(_0x9d78b1))){(0x0,exports[_0x5a0528(0x2b1)])(parseFloat(_0x9d78b1),_0x5d61d6,_0x78512a),await _0x78512a[_0x5a0528(0x1e4)]({'ratingAt':(0x0,moment_1[_0x5a0528(0x215)])()[_0x5a0528(0x2f8)](),'finishedAt':(0x0,moment_1[_0x5a0528(0x215)])()[_0x5a0528(0x2f8)](),'rated':!![]});return;}else{if(_0x5d61d6[_0x5a0528(0x366)]<_0x3f49a8['maxUseBotQueuesNPS']){let _0x2aa616='‎Opção\x20inválida,\x20tente\x20novamente.\x0a';const _0x49b810=await _0x4aa730[_0x5a0528(0x26d)](_0x5d61d6[_0x5a0528(0x213)]['number']+'@'+(_0x5d61d6[_0x5a0528(0x216)]?'g.us':_0x5a0528(0x20f)),{'text':_0x2aa616});(0x0,exports['verifyMessage'])(_0x49b810,_0x5d61d6,_0x32adf4,_0x78512a),await(0x0,baileys_1[_0x5a0528(0x27c)])(0x3e8);let _0x3701c6='‎'+_0x3f49a8['ratingMessage']+'\x0a';const _0x2c46c2=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3701c6,'ticket':_0x5d61d6});await(0x0,exports[_0x5a0528(0x2b5)])(_0x2c46c2,_0x5d61d6,_0x5d61d6[_0x5a0528(0x213)]),await _0x5d61d6['update']({'amountUseBotQueuesNPS':_0x5d61d6[_0x5a0528(0x366)]+0x1});}return;}}if(_0x17a4a7&&_0x5d61d6[_0x5a0528(0x2aa)]===_0x5a0528(0x230)&&!_0xda22f3){if((0x0,lodash_1[_0x5a0528(0x2f6)])(_0x5d61d6['lgpdAcceptedAt'])&&!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x5d61d6[_0x5a0528(0x30c)])){let _0x1e48dd=parseFloat(_0x9d78b1);if(!Number['isNaN'](_0x1e48dd)&&Number[_0x5a0528(0x208)](_0x1e48dd)&&!(0x0,lodash_1['isNull'])(_0x1e48dd)&&_0x1e48dd>0x0){if(_0x1e48dd===0x1)await _0x32adf4[_0x5a0528(0x1e4)]({'lgpdAcceptedAt':(0x0,moment_1[_0x5a0528(0x215)])()['toDate']()}),await _0x5d61d6['update']({'lgpdAcceptedAt':(0x0,moment_1[_0x5a0528(0x215)])()[_0x5a0528(0x2f8)](),'amountUsedBotQueues':0x0});else{if(_0x1e48dd===0x2){if(_0x3f49a8[_0x5a0528(0x21a)]!==''&&_0x3f49a8[_0x5a0528(0x21a)]!==undefined){const _0x2e68df=await _0x4aa730['sendMessage'](_0x5d61d6[_0x5a0528(0x213)]['number']+'@'+(_0x5d61d6['isGroup']?_0x5a0528(0x2a9):'s.whatsapp.net'),{'text':'‎'+_0x3f49a8[_0x5a0528(0x21a)]});(0x0,exports[_0x5a0528(0x2b5)])(_0x2e68df,_0x5d61d6,_0x32adf4,_0x78512a);}await _0x5d61d6[_0x5a0528(0x1e4)]({'status':'closed','amountUsedBotQueues':0x0}),await _0x78512a[_0x5a0528(0x2ef)];return;}else _0x5d61d6['amountUsedBotQueues']<_0x3f49a8['maxUseBotQueues']&&_0x3f49a8[_0x5a0528(0x34d)]>0x0&&await _0x5d61d6['update']({'amountUsedBotQueues':_0x5d61d6[_0x5a0528(0x368)]+0x1,'lgpdSendMessageAt':null});}}else _0x5d61d6['amountUsedBotQueues']<_0x3f49a8[_0x5a0528(0x34d)]&&_0x3f49a8[_0x5a0528(0x34d)]>0x0&&await _0x5d61d6['update']({'amountUsedBotQueues':_0x5d61d6['amountUsedBotQueues']+0x1,'lgpdSendMessageAt':null});}if((_0x32adf4[_0x5a0528(0x375)]===null||_0x34478e?.[_0x5a0528(0x265)]===_0x5a0528(0x21c))&&!_0x32adf4[_0x5a0528(0x216)]&&(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x5d61d6['lgpdSendMessageAt'])&&_0x5d61d6[_0x5a0528(0x368)]<=_0x3f49a8['maxUseBotQueues']&&!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x34478e?.[_0x5a0528(0x36f)])){_0x44996a?await(0x0,exports[_0x5a0528(0x271)])(_0x57e068,_0x5d61d6,_0x32adf4):await(0x0,exports[_0x5a0528(0x2b5)])(_0x57e068,_0x5d61d6,_0x32adf4,_0x78512a);if(!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x34478e?.[_0x5a0528(0x36f)])&&_0x34478e['lgpdMessage']!==''){const _0x531779=(0x0,Mustache_1[_0x5a0528(0x215)])('‎'+_0x34478e?.[_0x5a0528(0x36f)],_0x5d61d6),_0x3bef95=await _0x4aa730['sendMessage'](_0x5d61d6[_0x5a0528(0x213)][_0x5a0528(0x326)]+'@'+(_0x5d61d6[_0x5a0528(0x216)]?_0x5a0528(0x2a9):_0x5a0528(0x20f)),{'text':_0x531779});(0x0,exports['verifyMessage'])(_0x3bef95,_0x5d61d6,_0x32adf4,_0x78512a);}await(0x0,baileys_1['delay'])(0x3e8);if(!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x34478e?.[_0x5a0528(0x30b)])&&_0x34478e?.[_0x5a0528(0x30b)]!==''){const _0x5de744=(0x0,Mustache_1[_0x5a0528(0x215)])('‎'+_0x34478e?.[_0x5a0528(0x30b)],_0x5d61d6),_0x573e04=await _0x4aa730[_0x5a0528(0x26d)](_0x5d61d6[_0x5a0528(0x213)][_0x5a0528(0x326)]+'@'+(_0x5d61d6[_0x5a0528(0x216)]?_0x5a0528(0x2a9):_0x5a0528(0x20f)),{'text':_0x5de744});await(0x0,exports[_0x5a0528(0x2b5)])(_0x573e04,_0x5d61d6,_0x32adf4,_0x78512a);};await(0x0,baileys_1[_0x5a0528(0x27c)])(0x3e8);const _0x2b4969=(0x0,Mustache_1[_0x5a0528(0x215)])('‎Estou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20Não',_0x5d61d6),_0x2cb488=await _0x4aa730['sendMessage'](_0x5d61d6[_0x5a0528(0x213)][_0x5a0528(0x326)]+'@'+(_0x5d61d6[_0x5a0528(0x216)]?_0x5a0528(0x2a9):_0x5a0528(0x20f)),{'text':_0x2b4969});await(0x0,exports[_0x5a0528(0x2b5)])(_0x2cb488,_0x5d61d6,_0x32adf4,_0x78512a),await _0x5d61d6[_0x5a0528(0x1e4)]({'lgpdSendMessageAt':(0x0,moment_1[_0x5a0528(0x215)])()['toDate'](),'amountUsedBotQueues':_0x5d61d6[_0x5a0528(0x368)]+0x1}),await _0x5d61d6[_0x5a0528(0x1df)]();return;};if(!(0x0,lodash_1['isNil'])(_0x5d61d6[_0x5a0528(0x30c)])&&(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x5d61d6[_0x5a0528(0x375)]))return;}}}catch(_0x38df8){Sentry['captureException'](_0x38df8),console[_0x5a0528(0x322)](_0x38df8);}const _0x2d8ce7=_0x57e068['message']?.[_0x5a0528(0x2e1)]?.[_0x5a0528(0x222)]?.[_0x5a0528(0x362)]||_0x57e068[_0x5a0528(0x2cd)]?.['imageMessage']?.[_0x5a0528(0x222)]?.[_0x5a0528(0x362)]||_0x57e068[_0x5a0528(0x2cd)]?.['audioMessage']?.['contextInfo']?.[_0x5a0528(0x362)]||_0x57e068['message']?.[_0x5a0528(0x206)]?.[_0x5a0528(0x222)]?.[_0x5a0528(0x362)]||_0x57e068[_0x5a0528(0x2cd)]?.['documentMessage']?.[_0x5a0528(0x222)]?.['isForwarded'];let _0x2c6b8d;_0x44996a?_0x2c6b8d=await(0x0,exports[_0x5a0528(0x271)])(_0x57e068,_0x5d61d6,_0x32adf4,_0x78512a,_0x2d8ce7):await(0x0,exports[_0x5a0528(0x2b5)])(_0x57e068,_0x5d61d6,_0x32adf4,_0x78512a,![],_0x2d8ce7);try{await _0x5d61d6[_0x5a0528(0x1e4)]({'fromMe':_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)]});}catch(_0x3ae7f4){Sentry[_0x5a0528(0x2e3)](_0x3ae7f4),console[_0x5a0528(0x322)](_0x3ae7f4);}let _0x479744;if(_0x34478e['scheduleType']===_0x5a0528(0x289))_0x479744=await(0x0,VerifyCurrentSchedule_1[_0x5a0528(0x215)])(_0x46e746,0x0,0x0);else _0x34478e['scheduleType']==='connection'&&(_0x479744=await(0x0,VerifyCurrentSchedule_1[_0x5a0528(0x215)])(_0x46e746,0x0,_0x3f49a8['id']));try{if(!_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)]&&_0x34478e[_0x5a0528(0x2ca)]&&(!_0x5d61d6[_0x5a0528(0x216)]||_0x3f49a8['groupAsTicket']===_0x5a0528(0x21c))){if((_0x34478e[_0x5a0528(0x2ca)]===_0x5a0528(0x289)||_0x34478e[_0x5a0528(0x2ca)]===_0x5a0528(0x2a0))&&!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x479744)&&(!_0x479744||_0x479744['inActivity']===![])){_0x78512a[_0x5a0528(0x25b)]===null&&await _0x78512a[_0x5a0528(0x1e4)]({'chatbotAt':(0x0,moment_1[_0x5a0528(0x215)])()['toDate']()});if(_0x3f49a8[_0x5a0528(0x34d)]&&_0x3f49a8[_0x5a0528(0x34d)]!==0x0&&_0x5d61d6[_0x5a0528(0x368)]>=_0x3f49a8[_0x5a0528(0x34d)])return;let _0x1ef8bf=new Date(),_0x46f69b=new Date();if(_0x78512a['chatbotAt']!==null){_0x1ef8bf[_0x5a0528(0x352)](_0x78512a[_0x5a0528(0x25b)][_0x5a0528(0x350)]()+Number(_0x3f49a8['timeUseBotQueues']));if(_0x78512a[_0x5a0528(0x25b)]!==null&&_0x46f69b<_0x1ef8bf&&_0x3f49a8[_0x5a0528(0x1eb)]!=='0'&&_0x5d61d6[_0x5a0528(0x368)]!==0x0)return;}await _0x78512a[_0x5a0528(0x1e4)]({'chatbotAt':null});if(_0x3f49a8['outOfHoursMessage']!==''){const _0x3bd8d0=(0x0,Mustache_1['default'])(''+_0x3f49a8[_0x5a0528(0x24c)],_0x5d61d6),_0x1f4143=(0x0,Debounce_1[_0x5a0528(0x252)])(async()=>{const _0x2eca41=_0x5a0528;await _0x4aa730[_0x2eca41(0x26d)](_0x5d61d6[_0x2eca41(0x213)]['number']+'@'+(_0x5d61d6[_0x2eca41(0x216)]?_0x2eca41(0x2a9):_0x2eca41(0x20f)),{'text':_0x3bd8d0});},0x3e8,_0x5d61d6['id']);_0x1f4143(),await _0x5d61d6[_0x5a0528(0x1e4)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x5d61d6['amountUsedBotQueues']+0x1});return;}await _0x5d61d6[_0x5a0528(0x1e4)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x5d61d6[_0x5a0528(0x368)]+0x1});return;}}}catch(_0x226a46){Sentry['captureException'](_0x226a46),console[_0x5a0528(0x322)](_0x226a46);}!_0x5d61d6['imported']&&!_0x5d61d6[_0x5a0528(0x338)]&&!_0x3a4d4c&&!_0x57e068['key']['fromMe']&&!_0x5d61d6[_0x5a0528(0x23e)]&&!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x3f49a8['promptId'])&&await handleOpenAi(_0x57e068,_0x4aa730,_0x5d61d6,_0x32adf4,_0x2c6b8d);if(!_0x57e068[_0x5a0528(0x2cb)]['fromMe']&&(!_0x5d61d6[_0x5a0528(0x216)]||_0x3f49a8[_0x5a0528(0x31c)]==='enabled')&&!_0x5d61d6[_0x5a0528(0x338)]&&!_0x5d61d6[_0x5a0528(0x1e6)]&&!_0x5d61d6[_0x5a0528(0x2d3)]&&_0x3f49a8[_0x5a0528(0x24e)]){const _0x5464ec=await(0x0,ShowQueueIntegrationService_1['default'])(_0x5d61d6[_0x5a0528(0x24e)],_0x46e746);await(0x0,exports[_0x5a0528(0x1dc)])(_0x57e068,_0x4aa730,_0x46e746,_0x5464ec,_0x5d61d6);return;}if(!_0x57e068[_0x5a0528(0x2cb)]['fromMe']&&(!_0x5d61d6[_0x5a0528(0x216)]||_0x3f49a8[_0x5a0528(0x31c)]==='enabled')&&_0x5d61d6[_0x5a0528(0x338)]&&!_0x5d61d6[_0x5a0528(0x23e)]&&_0x5d61d6[_0x5a0528(0x24e)]&&_0x5d61d6[_0x5a0528(0x2b4)]){const _0x9472f6=await(0x0,ShowQueueIntegrationService_1[_0x5a0528(0x215)])(_0x5d61d6[_0x5a0528(0x24e)],_0x46e746);await(0x0,exports[_0x5a0528(0x1dc)])(_0x57e068,_0x4aa730,_0x46e746,_0x9472f6,_0x5d61d6);return;}!_0x5d61d6[_0x5a0528(0x2c6)]&&!_0x5d61d6[_0x5a0528(0x338)]&&(!_0x5d61d6['isGroup']||_0x3f49a8[_0x5a0528(0x31c)]===_0x5a0528(0x21c))&&!_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)]&&!_0x5d61d6[_0x5a0528(0x23e)]&&_0x3f49a8[_0x5a0528(0x2cc)][_0x5a0528(0x2de)]>=0x1&&(await verifyQueue(_0x4aa730,_0x57e068,_0x5d61d6,_0x32adf4,_0x34478e),_0x78512a[_0x5a0528(0x25b)]===null&&await _0x78512a[_0x5a0528(0x1e4)]({'chatbotAt':(0x0,moment_1[_0x5a0528(0x215)])()[_0x5a0528(0x2f8)]()}));_0x5d61d6[_0x5a0528(0x24b)]>0x0&&await _0x78512a[_0x5a0528(0x1e4)]({'queueId':_0x5d61d6[_0x5a0528(0x24b)]});if((getTypeMessage(_0x57e068)===_0x5a0528(0x22a)||getTypeMessage(_0x57e068)===_0x5a0528(0x206))&&!_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)]&&(!_0x5d61d6[_0x5a0528(0x216)]||_0x3f49a8['groupAsTicket']===_0x5a0528(0x21c))&&(!_0x32adf4?.[_0x5a0528(0x32d)]||_0x34478e?.[_0x5a0528(0x2ec)]===_0x5a0528(0x33e))){const _0x50a4a3=await _0x4aa730[_0x5a0528(0x26d)](_0x32adf4['number']+'@c.us',{'text':'‎*Assistente\x20Virtual*:\x0aInfelizmente\x20não\x20conseguimos\x20escutar\x20nem\x20enviar\x20áudios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.'},{'quoted':{'key':_0x57e068[_0x5a0528(0x2cb)],'message':{'extendedTextMessage':_0x57e068[_0x5a0528(0x2cd)]['extendedTextMessage']}}});await(0x0,exports[_0x5a0528(0x2b5)])(_0x50a4a3,_0x5d61d6,_0x32adf4,_0x78512a);}try{if(!_0x57e068['key']['fromMe']&&_0x34478e?.[_0x5a0528(0x2ca)]&&_0x5d61d6[_0x5a0528(0x24b)]!==null&&(!_0x5d61d6['isGroup']||_0x3f49a8[_0x5a0528(0x31c)]==='enabled')){const _0x468523=await Queue_1[_0x5a0528(0x215)][_0x5a0528(0x30e)](_0x5d61d6[_0x5a0528(0x24b)]);_0x34478e?.['scheduleType']===_0x5a0528(0x338)&&(_0x479744=await(0x0,VerifyCurrentSchedule_1[_0x5a0528(0x215)])(_0x46e746,_0x468523['id'],0x0));if(_0x34478e?.[_0x5a0528(0x2ca)]===_0x5a0528(0x338)&&!(0x0,lodash_1[_0x5a0528(0x2f6)])(_0x479744)&&(!_0x479744||_0x479744[_0x5a0528(0x210)]===![])){const _0x1672f9=_0x468523[_0x5a0528(0x24c)];if(_0x1672f9!==''){const _0x3cd82c=(0x0,Mustache_1[_0x5a0528(0x215)])(''+_0x1672f9,_0x5d61d6),_0x4c05be=(0x0,Debounce_1[_0x5a0528(0x252)])(async()=>{const _0x3dfa1a=_0x5a0528;await _0x4aa730[_0x3dfa1a(0x26d)](_0x5d61d6[_0x3dfa1a(0x213)][_0x3dfa1a(0x326)]+'@'+(_0x5d61d6[_0x3dfa1a(0x216)]?'g.us':_0x3dfa1a(0x20f)),{'text':_0x3cd82c});},0x3e8,_0x5d61d6['id']);_0x4c05be(),await _0x5d61d6['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x5d61d6[_0x5a0528(0x368)]+0x1});return;}await _0x5d61d6['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x5d61d6['amountUsedBotQueues']+0x1});return;}}}catch(_0x3d2570){Sentry[_0x5a0528(0x2e3)](_0x3d2570),console[_0x5a0528(0x322)](_0x3d2570);}_0x5d61d6[_0x5a0528(0x338)]&&_0x5d61d6[_0x5a0528(0x24b)]&&!_0x57e068[_0x5a0528(0x2cb)][_0x5a0528(0x1f6)]&&((!_0x5d61d6['user']||_0x5d61d6[_0x5a0528(0x338)]?.[_0x5a0528(0x231)]?.[_0x5a0528(0x2de)]>0x0)&&await(0x0,ChatBotListener_1['sayChatbot'])(_0x5d61d6[_0x5a0528(0x24b)],_0x4aa730,_0x5d61d6,_0x32adf4,_0x57e068),await _0x5d61d6[_0x5a0528(0x1e4)]({'sendInactiveMessage':![]})),await _0x5d61d6[_0x5a0528(0x1df)]();}catch(_0x8b7b6b){Sentry[_0x5a0528(0x2e3)](_0x8b7b6b),console[_0x5a0528(0x322)](_0x8b7b6b),logger_1[_0x5a0528(0x2cf)][_0x5a0528(0x254)]('Error\x20handling\x20whatsapp\x20message:\x20Err:\x20'+_0x8b7b6b);}};exports[a627_0x19fe46(0x2f3)]=handleMessage;const handleMsgAck=async(_0x1a0262,_0x30e126)=>{const _0x1ad0f7=a627_0x19fe46;await new Promise(_0xa510bf=>setTimeout(_0xa510bf,0x1f4));const _0x180b63=(0x0,socket_1['getIO'])();try{const _0x49c32f=await Message_1[_0x1ad0f7(0x215)][_0x1ad0f7(0x1ef)]({'where':{'wid':_0x1a0262['key']['id']},'include':[_0x1ad0f7(0x213),{'model':Message_1[_0x1ad0f7(0x215)],'as':_0x1ad0f7(0x2c0),'include':[_0x1ad0f7(0x213)]}]});if(!_0x49c32f)return;await _0x49c32f[_0x1ad0f7(0x1e4)]({'ack':_0x30e126}),_0x180b63['to'](_0x49c32f[_0x1ad0f7(0x35e)][_0x1ad0f7(0x371)]())[_0x1ad0f7(0x351)](_0x1ad0f7(0x264)+_0x49c32f[_0x1ad0f7(0x1da)]+_0x1ad0f7(0x227),{'action':_0x1ad0f7(0x1e4),'message':_0x49c32f});}catch(_0x5501bc){Sentry[_0x1ad0f7(0x2e3)](_0x5501bc),logger_1[_0x1ad0f7(0x2cf)]['error'](_0x1ad0f7(0x25d)+_0x5501bc);}},verifyRecentCampaign=async(_0x3d1992,_0x437c8e)=>{const _0x17440e=a627_0x19fe46;if(!isValidMsg(_0x3d1992))return;if(!_0x3d1992['key'][_0x17440e(0x1f6)]){const _0x27c0d8=_0x3d1992[_0x17440e(0x2cb)]['remoteJid'][_0x17440e(0x373)](/\D/g,''),_0x4f6b03=await Campaign_1[_0x17440e(0x215)][_0x17440e(0x1ee)]({'where':{'companyId':_0x437c8e,'status':_0x17440e(0x2ac),'confirmation':!![]}});if(_0x4f6b03){const _0x773ee8=_0x4f6b03[_0x17440e(0x347)](_0x433917=>_0x433917['id']),_0x4dd26c=await CampaignShipping_1[_0x17440e(0x215)]['findOne']({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x773ee8},'number':_0x27c0d8,'confirmation':null}});_0x4dd26c&&(await _0x4dd26c[_0x17440e(0x1e4)]({'confirmedAt':(0x0,moment_1[_0x17440e(0x215)])(),'confirmation':!![]}),await queues_1[_0x17440e(0x2e7)][_0x17440e(0x273)](_0x17440e(0x30f),{'campaignShippingId':_0x4dd26c['id'],'campaignId':_0x4dd26c[_0x17440e(0x209)]},{'delay':(0x0,queues_1[_0x17440e(0x2f9)])((0x0,queues_1[_0x17440e(0x2b3)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x2aa5ce,_0x3929b6,_0x416b6b)=>{const _0x384967=a627_0x19fe46;if(!isValidMsg(_0x2aa5ce))return;let _0x287285;_0x287285=await getContactMessage(_0x2aa5ce,_0x416b6b);const _0x5d911e=await verifyContact(_0x287285,_0x416b6b,_0x3929b6),_0x4220af=(0x0,socket_1[_0x384967(0x331)])(),_0x4d0e00=await(0x0,exports[_0x384967(0x286)])(_0x2aa5ce),_0x4ad639=/\u200c/[_0x384967(0x324)](_0x4d0e00);if(_0x2aa5ce['key'][_0x384967(0x1f6)]&&_0x4ad639){const _0x3ac033=await Message_1[_0x384967(0x215)]['findOne']({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x2aa5ce[_0x384967(0x2cb)]['id']},{'contactId':_0x5d911e['id']}],'companyId':_0x3929b6}});if(!(0x0,lodash_1[_0x384967(0x2fe)])(_0x3ac033)||!(0x0,lodash_1[_0x384967(0x2f6)])(_0x3ac033)||_0x3ac033!==null){const _0x4e4864=await Ticket_1[_0x384967(0x215)][_0x384967(0x30e)](_0x3ac033['ticketId']);await _0x4e4864[_0x384967(0x1e4)]({'status':_0x384967(0x2a8),'amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x4220af['to']('open')[_0x384967(0x351)](_0x384967(0x264)+_0x3929b6+'-ticket',{'action':_0x384967(0x341),'ticket':_0x4e4864,'ticketId':_0x4e4864['id']}),_0x4220af['to'](_0x4e4864[_0x384967(0x2aa)])['to'](_0x4e4864['id'][_0x384967(0x371)]())[_0x384967(0x351)](_0x384967(0x264)+_0x3929b6+_0x384967(0x238),{'action':_0x384967(0x1e4),'ticket':_0x4e4864,'ticketId':_0x4e4864['id']});}}},filterMessages=_0x1a5329=>{const _0x45890c=a627_0x19fe46;if(_0x1a5329[_0x45890c(0x2cd)]?.[_0x45890c(0x314)])return![];if([baileys_1[_0x45890c(0x21d)][_0x45890c(0x268)],baileys_1['WAMessageStubType'][_0x45890c(0x2d9)],baileys_1['WAMessageStubType'][_0x45890c(0x32f)],baileys_1['WAMessageStubType'][_0x45890c(0x2b0)]][_0x45890c(0x24f)](_0x1a5329['messageStubType']))return![];return!![];},wbotMessageListener=(_0x5de7d1,_0x1849be)=>{const _0x2031b2=a627_0x19fe46;_0x5de7d1['ev']['on'](_0x2031b2(0x22c),async _0x896081=>{const _0x1c5001=_0x2031b2,_0x1a2635=_0x896081[_0x1c5001(0x253)]['filter'](filterMessages)[_0x1c5001(0x347)](_0x27cfbd=>_0x27cfbd);if(!_0x1a2635)return;_0x1a2635[_0x1c5001(0x1e7)](async _0xc1e95f=>{const _0x26dfeb=_0x1c5001,_0x50f511=await Message_1[_0x26dfeb(0x215)][_0x26dfeb(0x28f)]({'where':{'wid':_0xc1e95f['key']['id'],'companyId':_0x1849be}});if(!_0x50f511){let _0x4771b9=![],_0x32c532=await(0x0,exports['getBodyMessage'])(_0xc1e95f);const _0x5b4483=_0xc1e95f?.[_0x26dfeb(0x2cb)]?.[_0x26dfeb(0x1f6)];if(_0x5b4483)_0x4771b9=/\u200c/['test'](_0x32c532);else{if(/\u200c/['test'](_0x32c532))_0x32c532=_0x32c532['replace'](/\u200c/,'');logger_1[_0x26dfeb(0x2cf)][_0x26dfeb(0x1ec)](_0x26dfeb(0x1f8)+_0x32c532);}if(!_0x4771b9){await handleMessage(_0xc1e95f,_0x5de7d1,_0x1849be);return;}await verifyRecentCampaign(_0xc1e95f,_0x1849be),await verifyCampaignMessageAndCloseTicket(_0xc1e95f,_0x1849be,_0x5de7d1);}_0xc1e95f[_0x26dfeb(0x2cb)][_0x26dfeb(0x356)]?.['endsWith'](_0x26dfeb(0x246))&&handleMsgAck(_0xc1e95f,0x2);});}),_0x5de7d1['ev']['on'](_0x2031b2(0x2d8),_0x34174e=>{const _0x48c035=_0x2031b2;if(_0x34174e[_0x48c035(0x2de)]===0x0)return;_0x34174e[_0x48c035(0x1e7)](async _0x30cc3e=>{const _0x48ed26=_0x48c035;_0x5de7d1[_0x48ed26(0x255)]([_0x30cc3e[_0x48ed26(0x2cb)]]);const _0xb241e1={..._0x34174e};_0xb241e1['0']?.['update']['messageStubType']===0x1&&_0xb241e1['0']?.[_0x48ed26(0x2cb)]['remoteJid']!==_0x48ed26(0x332)&&(0x0,MarkDeleteWhatsAppMessage_1[_0x48ed26(0x215)])(_0xb241e1['0']?.[_0x48ed26(0x2cb)][_0x48ed26(0x356)],null,_0xb241e1['0']?.[_0x48ed26(0x2cb)]['id'],_0x1849be);let _0x1d633a;_0x30cc3e[_0x48ed26(0x1e4)][_0x48ed26(0x2aa)]===0x3&&_0x30cc3e?.[_0x48ed26(0x2cb)]?.[_0x48ed26(0x1f6)]?_0x1d633a=0x2:_0x1d633a=_0x30cc3e['update']['status'],handleMsgAck(_0x30cc3e,_0x1d633a);});}),_0x5de7d1['ev']['on']('groups.update',_0x3c8c35=>{const _0x30da78=_0x2031b2;if(_0x3c8c35['length']===0x0)return;_0x3c8c35[_0x30da78(0x1e7)](async _0x50eec5=>{const _0x5845a5=_0x30da78,_0x18f05a=_0x50eec5['id']['replace'](/\D/g,''),_0x1351ed=_0x50eec5['subject']||_0x18f05a;let _0x59684e;try{_0x59684e=await _0x5de7d1[_0x5845a5(0x36e)](_0x50eec5['id'],_0x5845a5(0x29b));}catch(_0x18c8d7){Sentry[_0x5845a5(0x2e3)](_0x18c8d7),_0x59684e=process[_0x5845a5(0x2e2)][_0x5845a5(0x24a)]+_0x5845a5(0x237);}const _0x3ca280={'name':_0x1351ed,'number':_0x18f05a,'isGroup':!![],'companyId':_0x1849be,'remoteJid':_0x50eec5['id'],'profilePicUrl':_0x59684e},_0x3f7534=await(0x0,CreateOrUpdateContactService_1[_0x5845a5(0x215)])(_0x3ca280);});});};exports[a627_0x19fe46(0x2d1)]=wbotMessageListener;