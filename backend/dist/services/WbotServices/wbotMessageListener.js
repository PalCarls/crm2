<<<<<<< HEAD
'use strict';const a616_0x151dc0=a616_0x731b;function a616_0x4ae5(){const _0x51efcb=['No\x20result\x20from\x20synthesizer','public','isNil','acceptAudioMessageContact','open','debounce','‎\x20*','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage','Arquivo\x20salvo\x20com\x20sucesso!','warn','../WhatsappService/ShowWhatsAppService','26182DLrpLX','audio/mpeg','AudioConfig','../QueueIntegrationServices/CreateSessionDialogflow','findIndex','end','amountUsedBotQueues','default','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posição\x20na\x20fila\x20de\x20atendimento\x20é:\x20*','toDate','stickerMessage','reload','Erro\x20media','responses','../../models/CampaignShipping','../../helpers/Mustache','jidNormalizedUser','next','lgpdMessage','closedAt','9uZlpFX','error','lgpdAcceptedAt','mediaUrl','conversation','queues','whatsappId','name','@sentry/node','*[\x20','resolve','voice','Menu','list','data','update','../QueueIntegrationServices/QueryDialogflow','caption','Erro\x20ao\x20baixar\x20mídia:','sendQueuePosition','normalize','%2C','body','lgpdSendMessageAt','Error\x20converting\x20file:\x20','enabled','toFormat','key','Input\x20File:','messageStubType','singleSelectReply','Erro\x20ao\x20baixar\x20media','number','toLocaleLowerCase','darwin','POST','../../models/Campaign','fileName','existsSync','createChatCompletion','find','microsoft-cognitiveservices-speech-sdk','.ogg','E2E_DEVICE_CHANGED','protocolMessage','stringValue','wbotMessageListener','shift','ERR_WAPP_DOWNLOAD_MEDIA','greetingMessage','jpegThumbnail','queueId','path','base64','set','typebot','@c.us','dialogflow','delete','isGroup','verifyMessage','mediaMessage','text','disableBot','@g.us','viewOnceMessage','forEach','groupAsTicket','includes','Configuration','temperature','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mídia\x20verifique\x20no\x20dispositivo','voiceRegion','messageTimestamp','unlink','Latitude:\x20','../TicketServices/FindOrCreateTicketService','../../libs/socket','buttons','profilePictureUrl','findOne','filename','viewOnceMessageV2','chatBot','DispatchCampaign','catch','timeUseBotQueues','../../models/Message','338824LwRXKT','substring','then','settingsUserRandom','.wav','../../libs/cache','isForwarded',':unreads','listResponseMessage','recording','mediaType','useIntegration','\x20|\x20https://maps.google.com/maps?q=','remoteJid','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','chatbots','../../models/Queue','randomValue','chat','voiceMessage','vcard','liveLocationMessage','sendPresenceUpdate','Error\x20handling\x20message\x20ack.\x20Err:\x20','mimetype','participant','sections','ephemeralMessage','configurable','subject','../../models/UserRating','slice','fileList','../QueueIntegrationServices/ShowQueueIntegrationService','status','mkdirSync','logger','Amigo(a)','REVOKE','reactionMessage','‎Estou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20Não','scheduleType','WAMessageStubType','pt-BR-FabioNeural','type','messages.update','getQuotedMessageId','speechSynthesisVoiceName','react','Escolha\x20uma\x20opção','hasOwnProperty','listMessage','channel','isNull','__esModule','processImportMessagesWppId','user','selectedDisplayText','setMinutes','maxUseBotQueuesNPS','lgpdConsent','handleMessageIntegration','.txt','composing','title','add','length','../../utils/logger','Validação\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','captureException','.mpeg','promisify','content','urlN8N','Output\x20File:','toString','lodash','groupMetadata','company-','call','complationMessage','ASC','amountUseBotQueuesNPS','emit','3107304EYZujB','findByPk','acceptAudioMessage','util','isValidMsg','indexOf','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','createDialogflowSessionWithModel','data:image/png;base64,\x20','&z=17&hl=pt-BR|','toISOString','3453975JYBJVx','lgpd','medias','../../helpers/Debounce','contextInfo','request','videoMessage','TIMEOUT_TO_IMPORT_MESSAGE','get','addLogs','\x20]*\x20-\x20','BEGIN:','editedMessage','greetingMediaAttachment','min','sticker','877870tVuYOa','sequelize','campaignQueue','description','closeTicket','contentText','getMinutes','locationMessage','fromAudioFileOutput','image','mp3','Erro\x20para\x20responder\x20com\x20audio:\x20','verifyMediaMessage','paused','setExtra','platform','unlinkSync','split','messageContextInfo','NFD','speakTextAsync','openai','FRONTEND_URL','join','imported','-ticket','now','quotedMessage','reaction','chatBotType','info',':\x20📞','\x20-\x20Longitude:\x20','assistant','pop','selectedButtonId','__setModuleDefault','contactsArrayMessage','getBodyMessage','Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20já\x20não\x20esta\x20mais\x20disponível','26HsGNUR','extractMessageContent','buffer','getIO','options','webhook','system','endConversation','__importStar','findAll','getMessageOptions','isInteger','contact','maxMessages','enableLGPD','ticketId','nps','\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento','../../models/Whatsapp','presenceSubscribe','../FileServices/ShowService','../../helpers/addLogs','handleRating','buttonsMessage','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','fileListId','Error:\x20','buttonsResponseMessage','item1.TEL','E2E_IDENTITY_CHANGED','value','Importando\x20Mensagem:\x20','CIPHERTEXT','sendMessage','findAndCountAll','/nopicture.png','fromMe','create','outOfHoursMessage','audio','campaignId','maxTokens','replace','7bit','queryDialogFlow','Áudio','366hVcwDX','button','s.whatsapp.net','../UserQueueServices/ListUserQueueServices','push','selectedRowId','SpeechSynthesizer','senderKeyDistributionMessage','env','####\x20Nao\x20achou\x20o\x20type\x20152:\x20','defineProperty','closed','imageMessage','companyId','pending','writeFile','contacts:','promptId','audioMessage','prompt','parseToMilliseconds','encodedAudio','message','templateButtonReplyMessage','readMessages','values','delay','SpeechConfig','rows','trim','axolotlSenderKeyDistributionMessage','company','EM_ANDAMENTO','stringify','integrationId','item1.TEL:','contactMessage','userId','keys','status@broadcast','g.us','map','floor','queue','Esta\x20mensagem\x20já\x20existe','degreesLongitude','application/json','verifyRating','documentMessage','prototype','documentWithCaptionMessage','input','maxUseBotQueues','close','/usr/bin/ffmpeg','finishedAt','‎*Assistente\x20Virtual*:\x0aInfelizmente\x20não\x20conseguimos\x20escutar\x20nem\x20enviar\x20áudios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.','buttonText','log','createdAt','readFile','degreesLatitude','endsWith','gpt-3.5-turbo','pushName','Erro\x20ao\x20deletar\x20o\x20arquivo:','-appMessage','save','voiceKey','5515wYFQPv','apiKey','whatsapp','contactId','getTypeMessage','../TicketServices/UpdateTicketService','chatbotAt','language','../../models/Ticket','lgpdLink','count','stanzaId','disabled','298390WAMZYu','entries','Mensagem','getTime','filter','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','parameters','texto','sendGreetingMessageOneQueues','../MessageServices/CreateMessageService',';;;','extendedTextMessage','.mp3','projectName','contacts','test','messages.upsert','inActivity'];a616_0x4ae5=function(){return _0x51efcb;};return a616_0x4ae5();}(function(_0x407a04,_0x5b7262){const _0x575aa0=a616_0x731b,_0x151146=_0x407a04();while(!![]){try{const _0x49bd49=-parseInt(_0x575aa0(0x30c))/0x1*(-parseInt(_0x575aa0(0x209))/0x2)+parseInt(_0x575aa0(0x21d))/0x3*(parseInt(_0x575aa0(0x275))/0x4)+-parseInt(_0x575aa0(0x1df))/0x5*(parseInt(_0x575aa0(0x33a))/0x6)+-parseInt(_0x575aa0(0x2e4))/0x7+-parseInt(_0x575aa0(0x2c9))/0x8+parseInt(_0x575aa0(0x2d4))/0x9+-parseInt(_0x575aa0(0x1ec))/0xa;if(_0x49bd49===_0x5b7262)break;else _0x151146['push'](_0x151146['shift']());}catch(_0x504587){_0x151146['push'](_0x151146['shift']());}}}(a616_0x4ae5,0x59ad2));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x4c8e7d,_0x413234,_0x4b9c75,_0x3d733f){const _0xf42b1=a616_0x731b;if(_0x3d733f===undefined)_0x3d733f=_0x4b9c75;var _0x336137=Object['getOwnPropertyDescriptor'](_0x413234,_0x4b9c75);(!_0x336137||(_0xf42b1(0x2dc)in _0x336137?!_0x413234[_0xf42b1(0x2ab)]:_0x336137['writable']||_0x336137[_0xf42b1(0x291)]))&&(_0x336137={'enumerable':!![],'get':function(){return _0x413234[_0x4b9c75];}}),Object[_0xf42b1(0x344)](_0x4c8e7d,_0x3d733f,_0x336137);}:function(_0x2c76bf,_0x29f755,_0x51edb7,_0x4e985b){if(_0x4e985b===undefined)_0x4e985b=_0x51edb7;_0x2c76bf[_0x4e985b]=_0x29f755[_0x51edb7];}),__setModuleDefault=this&&this[a616_0x151dc0(0x308)]||(Object['create']?function(_0x981c0f,_0x311d8b){const _0x324658=a616_0x151dc0;Object['defineProperty'](_0x981c0f,_0x324658(0x210),{'enumerable':!![],'value':_0x311d8b});}:function(_0xa17325,_0x34f8cb){const _0x5046e7=a616_0x151dc0;_0xa17325[_0x5046e7(0x210)]=_0x34f8cb;}),__importStar=this&&this[a616_0x151dc0(0x314)]||function(_0x4d01e2){const _0x982683=a616_0x151dc0;if(_0x4d01e2&&_0x4d01e2['__esModule'])return _0x4d01e2;var _0x465719={};if(_0x4d01e2!=null){for(var _0x36356b in _0x4d01e2)if(_0x36356b!==_0x982683(0x210)&&Object[_0x982683(0x36b)][_0x982683(0x2a7)][_0x982683(0x2c4)](_0x4d01e2,_0x36356b))__createBinding(_0x465719,_0x4d01e2,_0x36356b);}return __setModuleDefault(_0x465719,_0x4d01e2),_0x465719;},__importDefault=this&&this['__importDefault']||function(_0x3b488f){const _0x40a507=a616_0x151dc0;return _0x3b488f&&_0x3b488f[_0x40a507(0x2ab)]?_0x3b488f:{'default':_0x3b488f};};Object[a616_0x151dc0(0x344)](exports,a616_0x151dc0(0x2ab),{'value':!![]}),exports[a616_0x151dc0(0x1e3)]=exports['isValidMsg']=exports['handleMessage']=exports[a616_0x151dc0(0x24b)]=exports[a616_0x151dc0(0x2b2)]=exports[a616_0x151dc0(0x322)]=exports[a616_0x151dc0(0x369)]=exports[a616_0x151dc0(0x259)]=exports[a616_0x151dc0(0x2f0)]=exports[a616_0x151dc0(0x2a3)]=exports['getQuotedMessage']=exports[a616_0x151dc0(0x30a)]=void 0x0;const path_1=__importStar(require(a616_0x151dc0(0x251))),util_1=require(a616_0x151dc0(0x2cc)),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require(a616_0x151dc0(0x225))),lodash_1=require(a616_0x151dc0(0x2c1)),baileys_1=require('@whiskeysockets/baileys'),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require(a616_0x151dc0(0x1e7))),Message_1=__importDefault(require(a616_0x151dc0(0x274))),socket_1=require(a616_0x151dc0(0x26a)),CreateMessageService_1=__importDefault(require(a616_0x151dc0(0x1f5))),logger_1=require(a616_0x151dc0(0x2b8)),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),FindOrCreateTicketService_1=__importDefault(require(a616_0x151dc0(0x269))),ShowWhatsAppService_1=__importDefault(require(a616_0x151dc0(0x208))),Debounce_1=require(a616_0x151dc0(0x2d7)),UpdateTicketService_1=__importDefault(require(a616_0x151dc0(0x1e4))),Mustache_1=__importDefault(require(a616_0x151dc0(0x218))),UserRating_1=__importDefault(require(a616_0x151dc0(0x293))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),sendFacebookMessage_1=__importDefault(require('../FacebookServices/sendFacebookMessage')),moment_1=__importDefault(require('moment')),Queue_1=__importDefault(require(a616_0x151dc0(0x285))),FindOrCreateATicketTrakingService_1=__importDefault(require('../TicketServices/FindOrCreateATicketTrakingService')),VerifyCurrentSchedule_1=__importDefault(require('../CompanyService/VerifyCurrentSchedule')),Campaign_1=__importDefault(require(a616_0x151dc0(0x241))),CampaignShipping_1=__importDefault(require(a616_0x151dc0(0x217))),sequelize_1=require(a616_0x151dc0(0x2e5)),queues_1=require('../../queues'),User_1=__importDefault(require('../../models/User')),ChatBotListener_1=require('./ChatBotListener'),MarkDeleteWhatsAppMessage_1=__importDefault(require('./MarkDeleteWhatsAppMessage')),ListUserQueueServices_1=__importDefault(require(a616_0x151dc0(0x33d))),cache_1=__importDefault(require(a616_0x151dc0(0x27a))),addLogs_1=require(a616_0x151dc0(0x321)),SendWhatsAppMedia_1=__importStar(require('./SendWhatsAppMedia')),ShowQueueIntegrationService_1=__importDefault(require(a616_0x151dc0(0x296))),CreateSessionDialogflow_1=require(a616_0x151dc0(0x20c)),QueryDialogflow_1=require(a616_0x151dc0(0x22d)),CompaniesSettings_1=__importDefault(require('../../models/CompaniesSettings')),CreateLogTicketService_1=__importDefault(require('../TicketServices/CreateLogTicketService')),Whatsapp_1=__importDefault(require(a616_0x151dc0(0x31e))),ShowService_1=__importDefault(require(a616_0x151dc0(0x320))),openai_1=require(a616_0x151dc0(0x2f9)),fluent_ffmpeg_1=__importDefault(require('fluent-ffmpeg')),microsoft_cognitiveservices_speech_sdk_1=require(a616_0x151dc0(0x246)),os=require('os'),request=require(a616_0x151dc0(0x2d9));let ffmpegPath;if(os[a616_0x151dc0(0x2f3)]()==='win32')ffmpegPath='C:\x5cffmpeg\x5cffmpeg.exe';else os[a616_0x151dc0(0x2f3)]()===a616_0x151dc0(0x23f)?ffmpegPath='/opt/homebrew/bin/ffmpeg':ffmpegPath=a616_0x151dc0(0x1d0);fluent_ffmpeg_1[a616_0x151dc0(0x210)]['setFfmpegPath'](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a616_0x151dc0(0x2bc)])(fs_1[a616_0x151dc0(0x349)]);function removeFile(_0x3abe5f){const _0x182a37=a616_0x151dc0;fs_2[_0x182a37(0x210)][_0x182a37(0x267)](_0x3abe5f,_0x47df34=>{if(_0x47df34)throw _0x47df34;});}const getTimestampMessage=_0x53b8f3=>{return _0x53b8f3*0x1;},multVecardGet=function(_0x4c14ff){const _0x572c09=a616_0x151dc0;let _0x488ee2='\x20',_0x4e7d51=_0x4c14ff[_0x572c09(0x2f5)]('\x0a')[0x2]['replace'](_0x572c09(0x1f6),'\x0a')[_0x572c09(0x336)]('N:','')[_0x572c09(0x336)](';','')[_0x572c09(0x336)](';','\x20')[_0x572c09(0x336)](';;','\x20')[_0x572c09(0x336)]('\x0a',''),_0x1ba550=_0x4c14ff[_0x572c09(0x2f5)]('\x0a')[0x4][_0x572c09(0x2ce)]('='),_0x9222df=_0x4c14ff['split']('\x0a')[0x4][_0x572c09(0x2ce)](':'),_0xf16436=_0x4c14ff['split']('\x0a')[0x4]['substring'](_0x1ba550+0x1,_0x9222df)[_0x572c09(0x336)](';',''),_0x296d3a=_0x4c14ff[_0x572c09(0x2f5)]('\x0a')[0x4]['replace'](_0x572c09(0x35d),'');if(_0xf16436!=_0x572c09(0x328))_0x488ee2=_0x488ee2+_0x4e7d51+_0x572c09(0x303)+_0xf16436+''+'\x0a';else _0x488ee2=_0x488ee2+_0x4e7d51+_0x572c09(0x303)+_0x296d3a+''+'\x0a';return _0x488ee2;},contactsArrayMessageGet=_0xe7ecfb=>{const _0x44b967=a616_0x151dc0;let _0x424d96=_0xe7ecfb[_0x44b967(0x350)]?.[_0x44b967(0x309)]?.[_0x44b967(0x1fa)],_0x1c5805=_0x424d96[_0x44b967(0x363)](function(_0x3a3ab9,_0x2cc5bd){const _0x2a797c=_0x44b967;return _0x3a3ab9[_0x2a797c(0x289)];}),_0x1815ce='';_0x1c5805[_0x44b967(0x25f)](function(_0x21f765,_0x16297e){_0x1815ce+=_0x21f765+'\x0a\x0a'+'';});let _0x2222b1=_0x1815ce[_0x44b967(0x2f5)](_0x44b967(0x2df));_0x2222b1[_0x44b967(0x24c)]();let _0x371146='';for(let _0x2ab2b0 of _0x2222b1){_0x371146=_0x371146+multVecardGet(_0x2ab2b0);}return _0x371146;},getTypeMessage=_0x5b3f5d=>{const _0x11addf=a616_0x151dc0,_0x221f5a=(0x0,baileys_1['getContentType'])(_0x5b3f5d[_0x11addf(0x350)]);if(_0x5b3f5d[_0x11addf(0x350)]?.['viewOnceMessageV2'])return'viewOnceMessageV2';return _0x221f5a;};exports[a616_0x151dc0(0x1e3)]=getTypeMessage;const getBodyButton=_0x334be8=>{const _0x28712b=a616_0x151dc0;if(_0x334be8['key'][_0x28712b(0x330)]&&_0x334be8['message']['buttonsMessage']?.[_0x28712b(0x2e9)]){let _0x47bcd4=''+_0x334be8?.[_0x28712b(0x350)]?.[_0x28712b(0x323)]?.[_0x28712b(0x2e9)];for(const _0x5777d5 of _0x334be8['message']?.[_0x28712b(0x323)]?.[_0x28712b(0x26b)]){_0x47bcd4+='\x0a\x0a'+_0x5777d5[_0x28712b(0x1d3)]?.['displayText'];}return _0x47bcd4;}if(_0x334be8['key'][_0x28712b(0x330)]&&_0x334be8?.[_0x28712b(0x350)]?.[_0x28712b(0x25e)]?.[_0x28712b(0x350)]?.[_0x28712b(0x2a8)]){let _0x2b8d1e=''+_0x334be8?.[_0x28712b(0x350)]?.[_0x28712b(0x25e)]?.[_0x28712b(0x350)]?.[_0x28712b(0x2a8)]?.['description'];for(const _0x401614 of _0x334be8[_0x28712b(0x350)]?.['viewOnceMessage']?.[_0x28712b(0x350)]?.[_0x28712b(0x2a8)]?.[_0x28712b(0x28f)]){for(const _0x303d76 of _0x401614['rows']){_0x2b8d1e+='\x0a\x0a'+_0x303d76[_0x28712b(0x2b5)];}}return _0x2b8d1e;}},getBodyList=_0xe27081=>{const _0x2c4413=a616_0x151dc0;if(_0xe27081[_0x2c4413(0x238)][_0x2c4413(0x330)]&&_0xe27081[_0x2c4413(0x350)]['listMessage']?.['description']){let _0x1f3775=''+_0xe27081[_0x2c4413(0x350)][_0x2c4413(0x2a8)]?.[_0x2c4413(0x2e7)];for(const _0x4d498a of _0xe27081[_0x2c4413(0x350)][_0x2c4413(0x2a8)]?.[_0x2c4413(0x28f)]){for(const _0x539b77 of _0x4d498a[_0x2c4413(0x356)]){_0x1f3775+='\x0a\x0a'+_0x539b77[_0x2c4413(0x2b5)];}}return _0x1f3775;}if(_0xe27081[_0x2c4413(0x238)][_0x2c4413(0x330)]&&_0xe27081?.[_0x2c4413(0x350)]?.[_0x2c4413(0x25e)]?.[_0x2c4413(0x350)]?.[_0x2c4413(0x2a8)]){let _0x20a7cf=''+_0xe27081?.['message']?.['viewOnceMessage']?.[_0x2c4413(0x350)]?.[_0x2c4413(0x2a8)]?.[_0x2c4413(0x2e7)];for(const _0x13b244 of _0xe27081[_0x2c4413(0x350)]?.[_0x2c4413(0x25e)]?.['message']?.[_0x2c4413(0x2a8)]?.['sections']){for(const _0x489e8a of _0x13b244['rows']){_0x20a7cf+='\x0a\x0a'+_0x489e8a[_0x2c4413(0x2b5)];}}return _0x20a7cf;}},msgLocation=(_0x5f2ab8,_0x467acb,_0x10b1a3)=>{const _0x318407=a616_0x151dc0;if(_0x5f2ab8){var _0x1d9cd0=Buffer['from'](_0x5f2ab8)['toString'](_0x318407(0x252));let _0x3eea2b=_0x318407(0x2d1)+_0x1d9cd0+_0x318407(0x281)+_0x467acb+_0x318407(0x232)+_0x10b1a3+_0x318407(0x2d2)+_0x467acb+',\x20'+_0x10b1a3+'\x20';return _0x3eea2b;}},getBodyMessage=_0x5bded0=>{const _0x490d9e=a616_0x151dc0;try{let _0x36476c=getTypeMessage(_0x5bded0);if(_0x36476c===undefined)console['log'](_0x5bded0);const _0x5489e0={'conversation':_0x5bded0[_0x490d9e(0x350)]?.['conversation'],'imageMessage':_0x5bded0['message']?.[_0x490d9e(0x346)]?.[_0x490d9e(0x22e)],'videoMessage':_0x5bded0['message']?.[_0x490d9e(0x2da)]?.[_0x490d9e(0x22e)],'extendedTextMessage':_0x5bded0?.[_0x490d9e(0x350)]?.[_0x490d9e(0x1f7)]?.['text'],'buttonsResponseMessage':_0x5bded0[_0x490d9e(0x350)]?.['buttonsResponseMessage']?.[_0x490d9e(0x2ae)],'listResponseMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x27d)]?.['title']||_0x5bded0['message']?.[_0x490d9e(0x27d)]?.[_0x490d9e(0x23b)]?.[_0x490d9e(0x33f)],'templateButtonReplyMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x351)]?.['selectedId'],'messageContextInfo':_0x5bded0['message']?.[_0x490d9e(0x327)]?.[_0x490d9e(0x307)]||_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x27d)]?.[_0x490d9e(0x2b5)],'buttonsMessage':getBodyButton(_0x5bded0)||_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x27d)]?.[_0x490d9e(0x2b5)],'stickerMessage':_0x490d9e(0x2e3),'contactMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x35e)]?.['vcard'],'contactsArrayMessage':_0x5bded0['message']?.[_0x490d9e(0x309)]?.['contacts']&&contactsArrayMessageGet(_0x5bded0),'locationMessage':msgLocation(_0x5bded0[_0x490d9e(0x350)]?.['locationMessage']?.[_0x490d9e(0x24f)],_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x2eb)]?.[_0x490d9e(0x1d7)],_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x2eb)]?.[_0x490d9e(0x367)]),'liveLocationMessage':_0x490d9e(0x268)+_0x5bded0['message']?.[_0x490d9e(0x28a)]?.[_0x490d9e(0x1d7)]+_0x490d9e(0x304)+_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x28a)]?.[_0x490d9e(0x367)],'documentMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x36a)]?.[_0x490d9e(0x22e)],'audioMessage':_0x490d9e(0x339),'listMessage':getBodyList(_0x5bded0)||_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x27d)]?.[_0x490d9e(0x2b5)],'viewOnceMessage':getBodyButton(_0x5bded0),'reactionMessage':_0x5bded0[_0x490d9e(0x350)]?.['reactionMessage']?.[_0x490d9e(0x25b)]||_0x490d9e(0x300),'senderKeyDistributionMessage':_0x5bded0?.['message']?.[_0x490d9e(0x341)]?.[_0x490d9e(0x358)],'documentWithCaptionMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x1cc)]?.[_0x490d9e(0x350)]?.['documentMessage']?.[_0x490d9e(0x22e)],'viewOnceMessageV2':_0x5bded0['message']?.[_0x490d9e(0x26f)]?.[_0x490d9e(0x350)]?.[_0x490d9e(0x346)]?.['caption'],'editedMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x2e0)]?.[_0x490d9e(0x350)]?.[_0x490d9e(0x1f7)]?.[_0x490d9e(0x25b)],'ephemeralMessage':_0x5bded0[_0x490d9e(0x350)]?.[_0x490d9e(0x290)]?.[_0x490d9e(0x350)]?.['extendedTextMessage']?.['text']},_0x3b886b=Object['keys'](_0x5489e0)[_0x490d9e(0x245)](_0xc9bb7a=>_0xc9bb7a===_0x36476c);return!_0x3b886b&&(logger_1['logger'][_0x490d9e(0x207)](_0x490d9e(0x343)+_0x36476c+'\x0a'+JSON['stringify'](_0x5bded0)),Sentry['setExtra'](_0x490d9e(0x1ee),{'BodyMsg':_0x5bded0[_0x490d9e(0x350)],'msg':_0x5bded0,'type':_0x36476c}),Sentry[_0x490d9e(0x2ba)](new Error(_0x490d9e(0x205)))),_0x5489e0[_0x36476c];}catch(_0x192fef){Sentry[_0x490d9e(0x2f2)]('Error\x20getTypeMessage',{'msg':_0x5bded0,'BodyMsg':_0x5bded0[_0x490d9e(0x350)]}),Sentry['captureException'](_0x192fef),console[_0x490d9e(0x1d4)](_0x192fef);}};exports['getBodyMessage']=getBodyMessage;function a616_0x731b(_0x2255a2,_0x1b8351){const _0x4ae51e=a616_0x4ae5();return a616_0x731b=function(_0x731b89,_0x55df21){_0x731b89=_0x731b89-0x1cc;let _0xbad82d=_0x4ae51e[_0x731b89];return _0xbad82d;},a616_0x731b(_0x2255a2,_0x1b8351);}const getQuotedMessage=_0x301ead=>{const _0x2f5aff=a616_0x151dc0,_0x33530c=(0x0,baileys_1[_0x2f5aff(0x30d)])(_0x301ead['message'])[Object[_0x2f5aff(0x360)](_0x301ead?.[_0x2f5aff(0x350)])[_0x2f5aff(0x353)]()[_0x2f5aff(0x21a)]()['value']];if(!_0x33530c?.[_0x2f5aff(0x2d8)]?.[_0x2f5aff(0x2ff)])return;const _0x130afb=(0x0,baileys_1['extractMessageContent'])(_0x33530c?.['contextInfo']?.[_0x2f5aff(0x2ff)][Object[_0x2f5aff(0x360)](_0x33530c?.[_0x2f5aff(0x2d8)]?.[_0x2f5aff(0x2ff)])[_0x2f5aff(0x353)]()[_0x2f5aff(0x21a)]()[_0x2f5aff(0x32a)]]);return _0x130afb;};exports['getQuotedMessage']=getQuotedMessage;const getQuotedMessageId=_0x52f5db=>{const _0x20fc93=a616_0x151dc0,_0x13d11d=(0x0,baileys_1[_0x20fc93(0x30d)])(_0x52f5db[_0x20fc93(0x350)])[Object['keys'](_0x52f5db?.[_0x20fc93(0x350)])[_0x20fc93(0x353)]()['next']()[_0x20fc93(0x32a)]];let _0x1ef718=_0x52f5db?.[_0x20fc93(0x350)]?.['reactionMessage']?_0x52f5db?.[_0x20fc93(0x350)]?.['reactionMessage']?.[_0x20fc93(0x238)]?.['id']:'';return _0x1ef718?_0x1ef718:_0x13d11d?.[_0x20fc93(0x2d8)]?.[_0x20fc93(0x1ea)];};exports[a616_0x151dc0(0x2a3)]=getQuotedMessageId;const getMeSocket=_0x98d6a0=>{const _0x3bdfbc=a616_0x151dc0;return{'id':(0x0,baileys_1['jidNormalizedUser'])(_0x98d6a0['user']['id']),'name':_0x98d6a0[_0x3bdfbc(0x2ad)][_0x3bdfbc(0x224)]};},getSenderMessage=(_0x549279,_0x49e3b9)=>{const _0x30a7c9=a616_0x151dc0,_0x2ca3f9=getMeSocket(_0x49e3b9);if(_0x549279['key'][_0x30a7c9(0x330)])return _0x2ca3f9['id'];const _0x43620b=_0x549279[_0x30a7c9(0x28e)]||_0x549279[_0x30a7c9(0x238)][_0x30a7c9(0x28e)]||_0x549279[_0x30a7c9(0x238)]['remoteJid']||undefined;return _0x43620b&&(0x0,baileys_1[_0x30a7c9(0x219)])(_0x43620b);},getContactMessage=async(_0x25b236,_0x1a1717)=>{const _0x1f2161=a616_0x151dc0,_0x2f84fd=_0x25b236['key'][_0x1f2161(0x282)][_0x1f2161(0x261)]('g.us'),_0x58e802=_0x25b236['key'][_0x1f2161(0x282)][_0x1f2161(0x336)](/\D/g,'');return _0x2f84fd?{'id':getSenderMessage(_0x25b236,_0x1a1717),'name':_0x25b236[_0x1f2161(0x1da)]}:{'id':_0x25b236[_0x1f2161(0x238)][_0x1f2161(0x282)],'name':_0x25b236[_0x1f2161(0x238)][_0x1f2161(0x330)]?_0x58e802:_0x25b236['pushName']};},downloadMedia=async(_0x157752,_0x30ade3=null)=>{const _0x20a902=a616_0x151dc0;let _0x572d75;try{_0x572d75=await(0x0,baileys_1['downloadMediaMessage'])(_0x157752,_0x20a902(0x30e),{});}catch(_0x3b9911){_0x30ade3?console[_0x20a902(0x1d4)](_0x20a902(0x30b)):console[_0x20a902(0x21e)](_0x20a902(0x22f),_0x3b9911);}let _0x25dd5d=_0x157752[_0x20a902(0x350)]?.[_0x20a902(0x36a)]?.[_0x20a902(0x242)]||'';const _0x1eb1b7=_0x157752[_0x20a902(0x350)]?.[_0x20a902(0x346)]||_0x157752['message']?.['audioMessage']||_0x157752[_0x20a902(0x350)]?.[_0x20a902(0x2da)]||_0x157752[_0x20a902(0x350)]?.[_0x20a902(0x213)]||_0x157752['message']?.[_0x20a902(0x36a)]||_0x157752[_0x20a902(0x350)]?.[_0x20a902(0x1cc)]?.[_0x20a902(0x350)]?.[_0x20a902(0x36a)]||_0x157752['message']?.[_0x20a902(0x1f7)]?.[_0x20a902(0x2d8)]?.[_0x20a902(0x2ff)]?.[_0x20a902(0x346)]||_0x157752[_0x20a902(0x350)]?.[_0x20a902(0x1f7)]?.[_0x20a902(0x2d8)]?.[_0x20a902(0x2ff)]?.['videoMessage'];if(!_0x1eb1b7)console[_0x20a902(0x1d4)](_0x157752);if(!_0x25dd5d){const _0x179fea=_0x1eb1b7[_0x20a902(0x28d)][_0x20a902(0x2f5)]('/')[0x1]['split'](';')[0x0];_0x25dd5d=new Date()[_0x20a902(0x1ef)]()+'.'+_0x179fea;}else _0x25dd5d=new Date()[_0x20a902(0x1ef)]()+'_'+_0x25dd5d;const _0x344334={'data':_0x572d75,'mimetype':_0x1eb1b7[_0x20a902(0x28d)],'filename':_0x25dd5d};return _0x344334;},verifyContact=async(_0x18bcbc,_0x4740a8,_0x10811a)=>{const _0x16f627=a616_0x151dc0;let _0x467f6c;try{_0x467f6c=await _0x4740a8[_0x16f627(0x26c)](_0x18bcbc['id'],_0x16f627(0x2ed));}catch(_0x1190e2){Sentry['captureException'](_0x1190e2),_0x467f6c=process['env'][_0x16f627(0x2fa)]+_0x16f627(0x32f);}const _0x4e48cf={'name':_0x18bcbc[_0x16f627(0x224)]||_0x18bcbc['id']['replace'](/\D/g,''),'number':_0x18bcbc['id'][_0x16f627(0x336)](/\D/g,''),'profilePicUrl':_0x467f6c,'isGroup':_0x18bcbc['id'][_0x16f627(0x261)]('g.us'),'companyId':_0x10811a,'remoteJid':_0x18bcbc['id']};_0x4e48cf[_0x16f627(0x258)]&&(_0x4e48cf[_0x16f627(0x23d)]=_0x18bcbc['id'][_0x16f627(0x336)](_0x16f627(0x25d),''));const _0x4b7ca5=await(0x0,CreateOrUpdateContactService_1['default'])(_0x4e48cf);return _0x4b7ca5;},verifyQuotedMessage=async _0x1cd00d=>{const _0x1a4438=a616_0x151dc0;if(!_0x1cd00d)return null;const _0x507da9=(0x0,exports[_0x1a4438(0x2a3)])(_0x1cd00d);if(!_0x507da9)return null;const _0x73a8bd=await Message_1['default'][_0x1a4438(0x26d)]({'where':{'wid':_0x507da9}});if(!_0x73a8bd)return null;return _0x73a8bd;},verifyMediaMessage=async(_0x5e3e86,_0x2fe4e9,_0x2450d8,_0x4664be,_0x31db9d)=>{const _0x276534=a616_0x151dc0,_0x1e729=(0x0,socket_1[_0x276534(0x30f)])(),_0x569ac9=await verifyQuotedMessage(_0x5e3e86),_0x2992b7=_0x2fe4e9[_0x276534(0x347)];try{const _0x24ec4a=await downloadMedia(_0x5e3e86,_0x2fe4e9?.[_0x276534(0x2fc)]);if(!_0x24ec4a&&_0x2fe4e9[_0x276534(0x2fc)]){const _0x505bfc=_0x276534(0x264),_0x325025={'wid':_0x5e3e86[_0x276534(0x238)]['id'],'ticketId':_0x2fe4e9['id'],'contactId':_0x5e3e86['key'][_0x276534(0x330)]?undefined:_0x2fe4e9[_0x276534(0x1e2)],'body':_0x505bfc,'reactionMessage':_0x5e3e86['message']?.[_0x276534(0x29c)],'fromMe':_0x5e3e86[_0x276534(0x238)][_0x276534(0x330)],'mediaType':getTypeMessage(_0x5e3e86),'read':_0x5e3e86['key'][_0x276534(0x330)],'quotedMsgId':_0x569ac9?.['id']||_0x5e3e86[_0x276534(0x350)]?.['reactionMessage']?.[_0x276534(0x238)]?.['id'],'ack':_0x5e3e86[_0x276534(0x297)],'companyId':_0x2992b7,'remoteJid':_0x5e3e86['key'][_0x276534(0x282)],'participant':_0x5e3e86[_0x276534(0x238)][_0x276534(0x28e)],'timestamp':getTimestampMessage(_0x5e3e86['messageTimestamp']),'createdAt':new Date(Math['floor'](getTimestampMessage(_0x5e3e86[_0x276534(0x266)])*0x3e8))['toISOString'](),'dataJson':JSON[_0x276534(0x35b)](_0x5e3e86),'ticketImported':_0x2fe4e9[_0x276534(0x2fc)],'isForwarded':_0x31db9d};return await _0x2fe4e9[_0x276534(0x22c)]({'lastMessage':_0x505bfc}),logger_1[_0x276534(0x299)][_0x276534(0x21e)](Error(_0x276534(0x24d))),(0x0,CreateMessageService_1[_0x276534(0x210)])({'messageData':_0x325025,'companyId':_0x2992b7});}if(!_0x24ec4a)throw new Error(_0x276534(0x24d));if(!_0x24ec4a[_0x276534(0x26e)]){const _0x1d184d=_0x24ec4a[_0x276534(0x28d)]['split']('/')[0x1][_0x276534(0x2f5)](';')[0x0];_0x24ec4a[_0x276534(0x26e)]=new Date()[_0x276534(0x1ef)]()+'.'+_0x1d184d;}else{const _0xa42045=_0x24ec4a[_0x276534(0x26e)][_0x276534(0x2f5)]('.')[_0x276534(0x306)](),_0x2438f9=_0x24ec4a[_0x276534(0x26e)][_0x276534(0x2f5)]('.')[_0x276534(0x294)](0x0,-0x1)[_0x276534(0x2fb)]('.')[_0x276534(0x336)](/\s/g,'_')[_0x276534(0x231)](_0x276534(0x2f7))[_0x276534(0x336)](/[\u0300-\u036f]/g,'');_0x24ec4a[_0x276534(0x26e)]=_0x2438f9[_0x276534(0x357)]()+'_'+new Date()[_0x276534(0x1ef)]()+'.'+_0xa42045;}try{const _0xdf80bb=path_1[_0x276534(0x210)][_0x276534(0x227)](__dirname,'..','..','..',_0x276534(0x1ff),_0x276534(0x359)+_0x2992b7);!fs_2[_0x276534(0x210)][_0x276534(0x243)](_0xdf80bb)&&(fs_2[_0x276534(0x210)][_0x276534(0x298)](_0xdf80bb,{'recursive':!![]}),fs_2[_0x276534(0x210)]['chmodSync'](_0xdf80bb,0x1ff)),await writeFileAsync((0x0,path_1[_0x276534(0x2fb)])(_0xdf80bb,_0x24ec4a['filename']),_0x24ec4a['data'][_0x276534(0x2c0)](_0x276534(0x252)),_0x276534(0x252))[_0x276534(0x277)](()=>{const _0x3968fb=_0x276534;console['log'](_0x24ec4a[_0x3968fb(0x28d)]),console['log'](_0x3968fb(0x206));if(_0x24ec4a[_0x3968fb(0x28d)]['includes'](_0x3968fb(0x333))){const _0x4f1b6d=path_1['default'][_0x3968fb(0x2fb)](_0xdf80bb,_0x24ec4a[_0x3968fb(0x26e)]);let _0x479aa1;if(_0x4f1b6d[_0x3968fb(0x1d8)](_0x3968fb(0x2bb)))_0x479aa1=_0x4f1b6d[_0x3968fb(0x336)]('.mpeg',_0x3968fb(0x1f8));else{if(_0x4f1b6d[_0x3968fb(0x1d8)](_0x3968fb(0x247)))_0x479aa1=_0x4f1b6d[_0x3968fb(0x336)]('.ogg',_0x3968fb(0x1f8));else{console[_0x3968fb(0x21e)]('Formato\x20de\x20arquivo\x20não\x20suportado:',_0x4f1b6d);return;}}return console[_0x3968fb(0x1d4)](_0x3968fb(0x239),_0x4f1b6d),console['log'](_0x3968fb(0x2bf),_0x479aa1),new Promise((_0x12774b,_0x241a79)=>{const _0x1bb390=_0x3968fb;(0x0,fluent_ffmpeg_1[_0x1bb390(0x210)])(_0x4f1b6d)[_0x1bb390(0x237)](_0x1bb390(0x2ee))['save'](_0x479aa1)['on'](_0x1bb390(0x20e),()=>{_0x12774b();})['on'](_0x1bb390(0x21e),_0x443e5e=>{_0x241a79(_0x443e5e);});});}})['then'](()=>{const _0x426e51=_0x276534;console[_0x426e51(0x1d4)]('Conversão\x20concluída!');});}catch(_0x1b07dc){Sentry[_0x276534(0x2f2)](_0x276534(0x215),{'companyId':_0x2992b7,'ticket':_0x2fe4e9,'contact':_0x2450d8,'media':_0x24ec4a,'quotedMsg':_0x569ac9}),Sentry[_0x276534(0x2ba)](_0x1b07dc),logger_1[_0x276534(0x299)][_0x276534(0x21e)](_0x1b07dc),console[_0x276534(0x1d4)](_0x5e3e86);}const _0x5c83e6=(0x0,exports[_0x276534(0x30a)])(_0x5e3e86),_0x23ea07={'wid':_0x5e3e86[_0x276534(0x238)]['id'],'ticketId':_0x2fe4e9['id'],'contactId':_0x5e3e86['key'][_0x276534(0x330)]?undefined:_0x2450d8['id'],'body':_0x5c83e6||_0x24ec4a[_0x276534(0x26e)],'fromMe':_0x5e3e86[_0x276534(0x238)][_0x276534(0x330)],'read':_0x5e3e86[_0x276534(0x238)][_0x276534(0x330)],'mediaUrl':_0x24ec4a[_0x276534(0x26e)],'mediaType':_0x24ec4a[_0x276534(0x28d)][_0x276534(0x2f5)]('/')[0x0],'quotedMsgId':_0x569ac9?.['id'],'ack':_0x5e3e86[_0x276534(0x297)],'remoteJid':_0x5e3e86['key'][_0x276534(0x282)],'participant':_0x5e3e86['key']['participant'],'dataJson':JSON[_0x276534(0x35b)](_0x5e3e86),'ticketTrakingId':_0x4664be?.['id'],'createdAt':new Date(Math[_0x276534(0x364)](getTimestampMessage(_0x5e3e86[_0x276534(0x266)])*0x3e8))[_0x276534(0x2d3)](),'ticketImported':_0x2fe4e9[_0x276534(0x2fc)],'isForwarded':_0x31db9d};await _0x2fe4e9[_0x276534(0x22c)]({'lastMessage':_0x5c83e6||_0x24ec4a['filename']});const _0x4358fb=await(0x0,CreateMessageService_1[_0x276534(0x210)])({'messageData':_0x23ea07,'companyId':_0x2992b7});return!_0x5e3e86['key']['fromMe']&&_0x2fe4e9[_0x276534(0x297)]==='closed'&&(await _0x2fe4e9[_0x276534(0x22c)]({'status':_0x276534(0x348)}),await _0x2fe4e9['reload']({'include':[{'model':Queue_1['default'],'as':_0x276534(0x365)},{'model':User_1['default'],'as':_0x276534(0x2ad)},{'model':Contact_1[_0x276534(0x210)],'as':_0x276534(0x318)},{'model':Whatsapp_1[_0x276534(0x210)],'as':_0x276534(0x1e1)}]}),_0x1e729['to']('closed')['emit'](_0x276534(0x2c3)+_0x2992b7+_0x276534(0x2fd),{'action':'delete','ticket':_0x2fe4e9,'ticketId':_0x2fe4e9['id']}),_0x1e729['to'](_0x2fe4e9[_0x276534(0x297)])['to'](_0x2fe4e9['id']['toString']())[_0x276534(0x2c8)](_0x276534(0x2c3)+_0x2992b7+_0x276534(0x2fd),{'action':'update','ticket':_0x2fe4e9,'ticketId':_0x2fe4e9['id']})),_0x4358fb;}catch(_0x3c4093){console[_0x276534(0x1d4)](_0x3c4093),logger_1[_0x276534(0x299)][_0x276534(0x207)](_0x276534(0x23c));}};exports[a616_0x151dc0(0x2f0)]=verifyMediaMessage;const verifyMessage=async(_0x4dc19a,_0x223844,_0x1c698e,_0x3282f2,_0x58c869,_0x1f0ac3)=>{const _0x194668=a616_0x151dc0,_0x229a1f=(0x0,socket_1[_0x194668(0x30f)])(),_0x3511e9=await verifyQuotedMessage(_0x4dc19a),_0x40c68d=(0x0,exports[_0x194668(0x30a)])(_0x4dc19a),_0xb1b167=_0x223844[_0x194668(0x347)],_0x114d17={'wid':_0x4dc19a[_0x194668(0x238)]['id'],'ticketId':_0x223844['id'],'contactId':_0x4dc19a[_0x194668(0x238)]['fromMe']?undefined:_0x1c698e['id'],'body':_0x40c68d,'fromMe':_0x4dc19a['key'][_0x194668(0x330)],'mediaType':getTypeMessage(_0x4dc19a),'read':_0x4dc19a[_0x194668(0x238)][_0x194668(0x330)],'quotedMsgId':_0x3511e9?.['id'],'ack':_0x4dc19a[_0x194668(0x297)],'remoteJid':_0x4dc19a['key'][_0x194668(0x282)],'participant':_0x4dc19a[_0x194668(0x238)][_0x194668(0x28e)],'dataJson':JSON[_0x194668(0x35b)](_0x4dc19a),'ticketTrakingId':_0x3282f2?.['id'],'isPrivate':![],'createdAt':new Date(Math[_0x194668(0x364)](getTimestampMessage(_0x4dc19a['messageTimestamp'])*0x3e8))['toISOString'](),'ticketImported':_0x223844['imported'],'isForwarded':_0x1f0ac3};await _0x223844[_0x194668(0x22c)]({'lastMessage':_0x40c68d}),await(0x0,CreateMessageService_1['default'])({'messageData':_0x114d17,'companyId':_0xb1b167}),!_0x4dc19a[_0x194668(0x238)][_0x194668(0x330)]&&_0x223844[_0x194668(0x297)]==='closed'&&(await _0x223844[_0x194668(0x22c)]({'status':_0x194668(0x348)}),await _0x223844[_0x194668(0x214)]({'include':[{'model':Queue_1[_0x194668(0x210)],'as':_0x194668(0x365)},{'model':User_1[_0x194668(0x210)],'as':_0x194668(0x2ad)},{'model':Contact_1[_0x194668(0x210)],'as':_0x194668(0x318)},{'model':Whatsapp_1[_0x194668(0x210)],'as':_0x194668(0x1e1)}]}),!_0x223844[_0x194668(0x2fc)]&&_0x229a1f['to'](_0x223844['status'])['to'](_0x223844['id'][_0x194668(0x2c0)]())[_0x194668(0x2c8)](_0x194668(0x2c3)+_0xb1b167+_0x194668(0x2fd),{'action':_0x194668(0x22c),'ticket':_0x223844,'ticketId':_0x223844['id']}));};exports[a616_0x151dc0(0x259)]=verifyMessage;const isValidMsg=_0x57284b=>{const _0x2d81fd=a616_0x151dc0;if(_0x57284b[_0x2d81fd(0x238)][_0x2d81fd(0x282)]===_0x2d81fd(0x361))return![];try{const _0x33bdef=getTypeMessage(_0x57284b);if(!_0x33bdef)return;const _0x17ea95=_0x33bdef==='conversation'||_0x33bdef==='extendedTextMessage'||_0x33bdef===_0x2d81fd(0x34c)||_0x33bdef==='videoMessage'||_0x33bdef===_0x2d81fd(0x346)||_0x33bdef===_0x2d81fd(0x36a)||_0x33bdef===_0x2d81fd(0x213)||_0x33bdef===_0x2d81fd(0x327)||_0x33bdef===_0x2d81fd(0x323)||_0x33bdef===_0x2d81fd(0x2f6)||_0x33bdef===_0x2d81fd(0x2eb)||_0x33bdef===_0x2d81fd(0x28a)||_0x33bdef===_0x2d81fd(0x35e)||_0x33bdef===_0x2d81fd(0x288)||_0x33bdef===_0x2d81fd(0x25a)||_0x33bdef===_0x2d81fd(0x309)||_0x33bdef===_0x2d81fd(0x29c)||_0x33bdef==='ephemeralMessage'||_0x33bdef===_0x2d81fd(0x249)||_0x33bdef===_0x2d81fd(0x27d)||_0x33bdef===_0x2d81fd(0x2a8)||_0x33bdef===_0x2d81fd(0x25e)||_0x33bdef==='documentWithCaptionMessage'||_0x33bdef===_0x2d81fd(0x26f)||_0x33bdef===_0x2d81fd(0x2e0);return!_0x17ea95&&(logger_1[_0x2d81fd(0x299)][_0x2d81fd(0x207)]('####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20'+_0x33bdef+'\x0a'+JSON[_0x2d81fd(0x35b)](_0x57284b?.[_0x2d81fd(0x350)])),Sentry[_0x2d81fd(0x2f2)]('Mensagem',{'BodyMsg':_0x57284b[_0x2d81fd(0x350)],'msg':_0x57284b,'msgType':_0x33bdef}),Sentry[_0x2d81fd(0x2ba)](new Error(_0x2d81fd(0x1f1)))),!!_0x17ea95;}catch(_0x2b194){Sentry['setExtra']('Error\x20isValidMsg',{'msg':_0x57284b}),Sentry[_0x2d81fd(0x2ba)](_0x2b194);}};exports[a616_0x151dc0(0x2cd)]=isValidMsg;const sendDialogflowAwswer=async(_0x376dd6,_0x1f48d6,_0x25c105,_0x4f403d,_0x4240a1,_0x2770ee,_0x1a8fb9)=>{const _0x1b6a7a=a616_0x151dc0,_0x488f69=await(0x0,CreateSessionDialogflow_1[_0x1b6a7a(0x2d0)])(_0x1a8fb9);if(_0x488f69===undefined)return;_0x376dd6['presenceSubscribe'](_0x4f403d[_0x1b6a7a(0x282)]),await(0x0,baileys_1['delay'])(0x1f4);let _0x4b0f7c=await(0x0,QueryDialogflow_1[_0x1b6a7a(0x338)])(_0x488f69,_0x1a8fb9[_0x1b6a7a(0x1f9)],_0x4f403d[_0x1b6a7a(0x282)],(0x0,exports['getBodyMessage'])(_0x25c105),_0x1a8fb9[_0x1b6a7a(0x1e6)],_0x4240a1);if(!_0x4b0f7c){_0x376dd6[_0x1b6a7a(0x28b)]('composing',_0x4f403d[_0x1b6a7a(0x282)]);const _0x841d30=(0x0,Mustache_1['default'])(_0x1b6a7a(0x204)+_0x1a8fb9?.[_0x1b6a7a(0x224)]+':*\x20Não\x20consegui\x20entender\x20sua\x20dúvida.');await(0x0,baileys_1['delay'])(0x3e8),await _0x376dd6['sendPresenceUpdate'](_0x1b6a7a(0x2f1),_0x4f403d['remoteJid']);const _0x327c99=await _0x376dd6[_0x1b6a7a(0x32d)](_0x4f403d[_0x1b6a7a(0x23d)]+_0x1b6a7a(0x255),{'text':_0x841d30});await(0x0,exports[_0x1b6a7a(0x259)])(_0x327c99,_0x1f48d6,_0x4f403d);return;}_0x4b0f7c[_0x1b6a7a(0x313)]&&await _0x1f48d6['update']({'contactId':_0x1f48d6[_0x1b6a7a(0x318)]['id'][_0x1b6a7a(0x2c0)](),'useIntegration':![]});const _0x20bf0f=_0x4b0f7c[_0x1b6a7a(0x1f2)][_0x1b6a7a(0x2ed)]?.[_0x1b6a7a(0x24a)]??undefined,_0x4fc2d6=_0x4b0f7c[_0x1b6a7a(0x1f2)][_0x1b6a7a(0x2a5)]?.['stringValue']??undefined,_0x6adc3e=_0x4b0f7c[_0x1b6a7a(0x34f)][_0x1b6a7a(0x2c0)](_0x1b6a7a(0x252))??undefined;_0x376dd6['sendPresenceUpdate'](_0x1b6a7a(0x2b4),_0x4f403d[_0x1b6a7a(0x282)]),await(0x0,baileys_1['delay'])(0x1f4);let _0x566f62;for(let _0x17e8ff of _0x4b0f7c[_0x1b6a7a(0x216)]){_0x566f62=_0x17e8ff[_0x1b6a7a(0x25b)][_0x1b6a7a(0x25b)][0x0]?_0x17e8ff[_0x1b6a7a(0x25b)][_0x1b6a7a(0x25b)][0x0]:_0x566f62;}for(let _0x3ad697 of _0x4b0f7c[_0x1b6a7a(0x216)]){_0x3ad697[_0x1b6a7a(0x25b)]&&await sendDelayedMessages(_0x376dd6,_0x1f48d6,_0x4f403d,_0x3ad697[_0x1b6a7a(0x25b)]['text'][0x0],_0x566f62,_0x6adc3e,_0x1a8fb9);}};async function sendDelayedMessages(_0x4da2ec,_0x15b649,_0x5d3819,_0x52ac80,_0x5d66e9,_0xad7fd9,_0x54f813){const _0x4e2313=a616_0x151dc0,_0x17d31c=_0x15b649[_0x4e2313(0x347)],_0x48f34c=await(0x0,ShowWhatsAppService_1[_0x4e2313(0x210)])(_0x4da2ec['id'],_0x17d31c),_0x415cad=_0x48f34c['farewellMessage'][_0x4e2313(0x336)](/[_*]/g,''),_0x50bcde=await _0x4da2ec[_0x4e2313(0x32d)](_0x5d3819[_0x4e2313(0x23d)]+_0x4e2313(0x255),{'text':_0x4e2313(0x204)+_0x54f813?.[_0x4e2313(0x224)]+':*\x20'+_0x52ac80});await(0x0,exports[_0x4e2313(0x259)])(_0x50bcde,_0x15b649,_0x5d3819);if(_0x52ac80!=_0x5d66e9)await(0x0,baileys_1[_0x4e2313(0x354)])(0x1f4),_0x4da2ec[_0x4e2313(0x28b)]('composing',_0x5d3819[_0x4e2313(0x282)]);else _0xad7fd9&&(_0x4da2ec[_0x4e2313(0x28b)](_0x4e2313(0x27e),_0x5d3819[_0x4e2313(0x282)]),await(0x0,baileys_1[_0x4e2313(0x354)])(0x1f4),_0x415cad&&_0x52ac80['includes'](_0x415cad)&&(await(0x0,baileys_1[_0x4e2313(0x354)])(0x2710),setTimeout(async()=>{const _0x25c407=_0x4e2313;await _0x15b649[_0x25c407(0x22c)]({'contactId':_0x15b649['contact']['id'][_0x25c407(0x2c0)](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1['default'])({'ticketId':_0x15b649['id'],'ticketData':{'status':_0x25c407(0x345)},'companyId':_0x17d31c});},0xbb8)));}const verifyQueue=async(_0x2e4717,_0x2355d5,_0x292edb,_0x2dc261,_0x58cfb,_0x171661)=>{const _0x3df615=a616_0x151dc0,_0x127e0d=_0x292edb['companyId'],{queues:_0x321c44,greetingMessage:_0x5ebaa0,maxUseBotQueues:_0x1e1895,timeUseBotQueues:_0x1e9d4c}=await(0x0,ShowWhatsAppService_1['default'])(_0x2e4717['id'],_0x127e0d);let _0x5f44fa=![];_0x321c44[_0x3df615(0x2b7)]===0x1&&(_0x5f44fa=_0x321c44[0x0]?.[_0x3df615(0x284)][_0x3df615(0x2b7)]>0x1);const _0x3c3b8=_0x58cfb[_0x3df615(0x230)]==='enabled';if(_0x321c44[_0x3df615(0x2b7)]===0x1&&!_0x5f44fa){const _0x507538=_0x58cfb[_0x3df615(0x1f4)]===_0x3df615(0x236)||![];if(!_0x2355d5['key'][_0x3df615(0x330)]&&!_0x292edb[_0x3df615(0x258)]&&_0x321c44[0x0][_0x3df615(0x35c)]){const _0x45b44c=await(0x0,ShowQueueIntegrationService_1['default'])(_0x292edb['integrationId'],_0x127e0d);await(0x0,exports['handleMessageIntegration'])(_0x2355d5,_0x2e4717,_0x127e0d,_0x45b44c,_0x292edb),await _0x292edb['update']({'useIntegration':!![],'integrationId':_0x45b44c['id']});}if(_0x5ebaa0[_0x3df615(0x2b7)]>0x1&&_0x507538){const _0xb2bd22=(0x0,Mustache_1['default'])(''+_0x5ebaa0,_0x292edb);if(_0x292edb[_0x3df615(0x1e1)][_0x3df615(0x2e1)]!==null){const _0x52e8dc=path_1[_0x3df615(0x210)][_0x3df615(0x227)]('public',_0x3df615(0x359)+_0x127e0d,_0x292edb['whatsapp'][_0x3df615(0x2e1)]),_0xc42e88=_0x292edb['whatsapp'][_0x3df615(0x2e1)],_0x116eda=await(0x0,SendWhatsAppMedia_1[_0x3df615(0x316)])(_0xc42e88,_0x52e8dc,String(_0x127e0d),_0xb2bd22),_0x43458c=(0x0,Debounce_1[_0x3df615(0x203)])(async()=>{const _0xd9132d=_0x3df615,_0x38b503=await _0x2e4717[_0xd9132d(0x32d)](_0x292edb['contact'][_0xd9132d(0x23d)]+'@'+(_0x292edb[_0xd9132d(0x258)]?_0xd9132d(0x362):_0xd9132d(0x33c)),{..._0x116eda});await(0x0,exports[_0xd9132d(0x2f0)])(_0x38b503,_0x292edb,_0x2dc261,_0x171661);},0x3e8,_0x292edb['id']);_0x43458c();}else await _0x2e4717[_0x3df615(0x32d)](_0x2dc261[_0x3df615(0x23d)]+'@'+(_0x292edb[_0x3df615(0x258)]?_0x3df615(0x362):'s.whatsapp.net'),{'text':_0xb2bd22});}if(!(0x0,lodash_1[_0x3df615(0x200)])(_0x321c44[0x0]['fileListId']))try{const _0x555f86=path_1[_0x3df615(0x210)][_0x3df615(0x227)](__dirname,'..','..','..',_0x3df615(0x1ff)),_0x41d56c=await(0x0,ShowService_1[_0x3df615(0x210)])(_0x321c44[0x0][_0x3df615(0x325)],_0x292edb[_0x3df615(0x347)]),_0x21fa68=path_1[_0x3df615(0x210)][_0x3df615(0x227)](_0x555f86,_0x3df615(0x359)+_0x292edb[_0x3df615(0x347)],_0x3df615(0x295),String(_0x41d56c['id']));for(const [_0x111378,_0x5a6741]of _0x41d56c['options'][_0x3df615(0x1ed)]()){const _0x3f2e01={'fieldname':_0x3df615(0x2d6),'originalname':_0x5a6741[_0x3df615(0x251)],'encoding':_0x3df615(0x337),'mimetype':_0x5a6741[_0x3df615(0x27f)],'filename':_0x5a6741[_0x3df615(0x251)],'path':path_1[_0x3df615(0x210)][_0x3df615(0x227)](_0x21fa68,_0x5a6741[_0x3df615(0x251)])};await(0x0,SendWhatsAppMedia_1[_0x3df615(0x210)])({'media':_0x3f2e01,'ticket':_0x292edb,'body':_0x5a6741[_0x3df615(0x224)],'isPrivate':![],'isForwarded':![]});};}catch(_0x172b1e){logger_1[_0x3df615(0x299)][_0x3df615(0x302)](_0x172b1e);}if(_0x321c44[0x0][_0x3df615(0x2e8)]){await(0x0,UpdateTicketService_1[_0x3df615(0x210)])({'ticketData':{'status':_0x3df615(0x345),'queueId':_0x321c44[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});return;}else await(0x0,UpdateTicketService_1[_0x3df615(0x210)])({'ticketData':{'queueId':_0x321c44[0x0]['id']},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});const _0x4347b7=await Ticket_1['default']['findAndCountAll']({'where':{'userId':null,'status':_0x3df615(0x348),'companyId':_0x127e0d,'queueId':_0x321c44[0x0]['id'],'isGroup':![]}});if(_0x3c3b8){const _0x52b2ff=_0x4347b7[_0x3df615(0x1e9)]===0x0?0x1:_0x4347b7[_0x3df615(0x1e9)],_0x514ed2=_0x3df615(0x211)+_0x52b2ff+'*',_0x3a2eab=(0x0,Mustache_1['default'])(''+_0x514ed2,_0x292edb),_0x47f709=(0x0,Debounce_1[_0x3df615(0x203)])(async()=>{const _0x2bb07e=_0x3df615;await _0x2e4717[_0x2bb07e(0x32d)](_0x2dc261['number']+'@'+(_0x292edb[_0x2bb07e(0x258)]?_0x2bb07e(0x362):_0x2bb07e(0x33c)),{'text':_0x3a2eab});},0xbb8,_0x292edb['id']);_0x47f709();}return;}if(_0x2dc261[_0x3df615(0x25c)])return;let _0x55af9a='';if(_0x292edb[_0x3df615(0x297)]!==_0x3df615(0x2d5))_0x55af9a=_0x2355d5?.[_0x3df615(0x350)]?.[_0x3df615(0x327)]?.[_0x3df615(0x307)]||_0x2355d5?.[_0x3df615(0x350)]?.[_0x3df615(0x27d)]?.[_0x3df615(0x23b)][_0x3df615(0x33f)]||(0x0,exports[_0x3df615(0x30a)])(_0x2355d5);else{if(!(0x0,lodash_1[_0x3df615(0x200)])(_0x292edb[_0x3df615(0x21f)]))await _0x292edb['update']({'status':_0x3df615(0x348)});await _0x292edb[_0x3df615(0x214)]();}if(_0x55af9a[_0x3df615(0x23e)]()=='sair'){const _0x416b1b={'isBot':![],'status':_0x3df615(0x345),'sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x3df615(0x210)])({'ticketData':_0x416b1b,'ticketId':_0x292edb['id'],'companyId':_0x127e0d});return;}const _0x405285=_0x5f44fa&&_0x321c44[_0x3df615(0x2b7)]===0x1?_0x321c44[+_0x55af9a]:_0x321c44[+_0x55af9a-0x1];if(!_0x2355d5['key'][_0x3df615(0x330)]&&!_0x292edb[_0x3df615(0x258)]&&_0x405285?.[_0x3df615(0x35c)]){const _0x468762=await(0x0,ShowQueueIntegrationService_1[_0x3df615(0x210)])(_0x405285['integrationId'],_0x127e0d);await(0x0,exports[_0x3df615(0x2b2)])(_0x2355d5,_0x2e4717,_0x127e0d,_0x468762,_0x292edb),await _0x292edb[_0x3df615(0x22c)]({'useIntegration':!![],'integrationId':_0x468762['id']});}const _0x4bace7=_0x58cfb?.[_0x3df615(0x301)]||_0x3df615(0x25b);let _0x16095d;if(_0x405285)try{const _0x334011=await(0x0,ListUserQueueServices_1[_0x3df615(0x210)])(_0x405285['id']);_0x334011['userId']>-0x1&&(_0x16095d=_0x334011['userId']);}catch(_0x4bf896){console[_0x3df615(0x21e)](_0x4bf896);}const _0x1a1afe=async()=>{const _0x5ec159=_0x3df615;if(_0x405285||_0x321c44['length']===0x1&&_0x5f44fa){const _0x41a481=await Queue_1['default'][_0x5ec159(0x2ca)](_0x405285['id']);let _0x41409d;_0x58cfb?.[_0x5ec159(0x29e)]===_0x5ec159(0x365)&&(_0x41409d=await(0x0,VerifyCurrentSchedule_1[_0x5ec159(0x210)])(_0x127e0d,_0x41a481['id'],0x0));if(_0x58cfb?.[_0x5ec159(0x29e)]===_0x5ec159(0x365)&&!(0x0,lodash_1[_0x5ec159(0x200)])(_0x41409d)&&(!_0x41409d||_0x41409d[_0x5ec159(0x1fd)]===![])&&(!_0x292edb['isGroup']||_0x292edb[_0x5ec159(0x1e1)]?.['groupAsTicket']===_0x5ec159(0x236))){const _0x220aaa=_0x41a481[_0x5ec159(0x332)];if(_0x220aaa!==''){const _0x45bacc=(0x0,Mustache_1['default'])(''+_0x220aaa,_0x292edb),_0xd88227=(0x0,Debounce_1[_0x5ec159(0x203)])(async()=>{const _0x5bfe04=_0x5ec159;await _0x2e4717[_0x5bfe04(0x32d)](_0x292edb['contact'][_0x5bfe04(0x23d)]+'@'+(_0x292edb['isGroup']?'g.us':_0x5bfe04(0x33c)),{'text':_0x45bacc});},0x3e8,_0x292edb['id']);_0xd88227(),await _0x292edb['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x292edb[_0x5ec159(0x20f)]+0x1});return;}await _0x292edb[_0x5ec159(0x22c)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x292edb['amountUsedBotQueues']+0x1});return;}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x405285['id']},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});if(_0x405285['chatbots']['length']>0x0&&!_0x292edb[_0x5ec159(0x258)]){let _0x5a4fb6='';_0x405285[_0x5ec159(0x284)]['forEach']((_0xcf3420,_0x48243f)=>{const _0x1d307b=_0x5ec159;_0x5a4fb6+=_0x1d307b(0x226)+(_0x48243f+0x1)+_0x1d307b(0x2de)+_0xcf3420[_0x1d307b(0x224)]+'\x0a';});const _0x4cb556=(0x0,Mustache_1[_0x5ec159(0x210)])('‎'+_0x405285[_0x5ec159(0x24e)]+'\x0a\x0a'+_0x5a4fb6+'\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento',_0x292edb),_0x22d188=await _0x2e4717[_0x5ec159(0x32d)](_0x2dc261['number']+'@'+(_0x292edb[_0x5ec159(0x258)]?_0x5ec159(0x362):'s.whatsapp.net'),{'text':_0x4cb556});await(0x0,exports['verifyMessage'])(_0x22d188,_0x292edb,_0x2dc261,_0x171661),_0x58cfb?.[_0x5ec159(0x278)]===_0x5ec159(0x236)&&await(0x0,UpdateTicketService_1[_0x5ec159(0x210)])({'ticketData':{'userId':_0x16095d},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});}if(!_0x405285[_0x5ec159(0x284)]['length']&&_0x405285[_0x5ec159(0x24e)][_0x5ec159(0x2b7)]!==0x0){const _0x1a9e16=(0x0,Mustache_1[_0x5ec159(0x210)])('‎'+_0x405285['greetingMessage'],_0x292edb),_0x2c13fa=await _0x2e4717[_0x5ec159(0x32d)](_0x2dc261['number']+'@'+(_0x292edb[_0x5ec159(0x258)]?_0x5ec159(0x362):_0x5ec159(0x33c)),{'text':_0x1a9e16});await(0x0,exports[_0x5ec159(0x259)])(_0x2c13fa,_0x292edb,_0x2dc261,_0x171661);}if(!(0x0,lodash_1[_0x5ec159(0x200)])(_0x405285[_0x5ec159(0x325)]))try{const _0x414338=path_1[_0x5ec159(0x210)]['resolve'](__dirname,'..','..','..',_0x5ec159(0x1ff)),_0x24aa7f=await(0x0,ShowService_1['default'])(_0x405285[_0x5ec159(0x325)],_0x292edb['companyId']),_0x5e1764=path_1[_0x5ec159(0x210)]['resolve'](_0x414338,_0x5ec159(0x359)+_0x292edb[_0x5ec159(0x347)],_0x5ec159(0x295),String(_0x24aa7f['id']));for(const [_0x332491,_0x493d5f]of _0x24aa7f[_0x5ec159(0x310)][_0x5ec159(0x1ed)]()){const _0x5476aa={'fieldname':'medias','originalname':_0x493d5f[_0x5ec159(0x251)],'encoding':_0x5ec159(0x337),'mimetype':_0x493d5f[_0x5ec159(0x27f)],'filename':_0x493d5f[_0x5ec159(0x251)],'path':path_1['default']['resolve'](_0x5e1764,_0x493d5f[_0x5ec159(0x251)])};await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x5476aa,'ticket':_0x292edb,'body':_0x493d5f[_0x5ec159(0x224)],'isPrivate':![],'isForwarded':![]});};await(0x0,baileys_1[_0x5ec159(0x354)])(0x7d0);}catch(_0x59d6a4){logger_1[_0x5ec159(0x299)][_0x5ec159(0x302)](_0x59d6a4);}if(_0x405285['closeTicket']){await(0x0,UpdateTicketService_1[_0x5ec159(0x210)])({'ticketData':{'status':_0x5ec159(0x345),'queueId':_0x405285['id'],'sendFarewellMessage':![]},'ticketId':_0x292edb['id'],'companyId':_0x127e0d}),await(0x0,CreateLogTicketService_1[_0x5ec159(0x210)])({'ticketId':_0x292edb['id'],'type':_0x5ec159(0x345),'queueId':_0x405285['id']});return;}const _0x201f07=await Ticket_1[_0x5ec159(0x210)][_0x5ec159(0x32e)]({'where':{'userId':null,'status':_0x5ec159(0x348),'companyId':_0x127e0d,'queueId':_0x405285['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1[_0x5ec159(0x210)])({'ticketId':_0x292edb['id'],'type':_0x5ec159(0x365),'queueId':_0x405285['id']});if(_0x3c3b8&&!_0x405285[_0x5ec159(0x284)]['length']){const _0x2823e7=_0x201f07[_0x5ec159(0x1e9)]===0x0?0x1:_0x201f07[_0x5ec159(0x1e9)],_0x2902fd=_0x5ec159(0x211)+_0x2823e7+'*',_0x39f448=(0x0,Mustache_1[_0x5ec159(0x210)])(''+_0x2902fd,_0x292edb),_0x2dcdcc=(0x0,Debounce_1[_0x5ec159(0x203)])(async()=>{const _0x2e8415=_0x5ec159;await _0x2e4717[_0x2e8415(0x32d)](_0x2dc261['number']+'@'+(_0x292edb[_0x2e8415(0x258)]?_0x2e8415(0x362):_0x2e8415(0x33c)),{'text':_0x39f448});},0xbb8,_0x292edb['id']);_0x2dcdcc();}}else{if(_0x292edb[_0x5ec159(0x258)])return;if(_0x1e1895&&_0x1e1895!==0x0&&_0x292edb[_0x5ec159(0x20f)]>=_0x1e1895)return;const _0x1ef1ba=await(0x0,FindOrCreateATicketTrakingService_1[_0x5ec159(0x210)])({'ticketId':_0x292edb['id'],'companyId':_0x127e0d});let _0x1b7c0a=new Date(),_0x4fdabc=new Date();if(_0x1ef1ba[_0x5ec159(0x1e5)]!==null){_0x1b7c0a[_0x5ec159(0x2af)](_0x1ef1ba[_0x5ec159(0x1e5)][_0x5ec159(0x2ea)]()+Number(_0x1e9d4c));if(_0x1ef1ba[_0x5ec159(0x1e5)]!==null&&_0x4fdabc<_0x1b7c0a&&_0x1e9d4c!=='0'&&_0x292edb[_0x5ec159(0x20f)]!==0x0)return;}await _0x1ef1ba[_0x5ec159(0x22c)]({'chatbotAt':null}),_0x2e4717[_0x5ec159(0x31f)](_0x2dc261[_0x5ec159(0x282)]);let _0x21dc3b='';_0x2e4717[_0x5ec159(0x28b)](_0x5ec159(0x2b4),_0x2dc261[_0x5ec159(0x282)]),_0x321c44[_0x5ec159(0x25f)]((_0x301b04,_0x18919b)=>{const _0x27ab95=_0x5ec159;_0x21dc3b+=_0x27ab95(0x226)+(_0x18919b+0x1)+_0x27ab95(0x2de)+_0x301b04[_0x27ab95(0x224)]+'\x0a';}),_0x21dc3b+=_0x5ec159(0x31d);const _0x31dba1=(0x0,Mustache_1[_0x5ec159(0x210)])('‎'+_0x5ebaa0+'\x0a\x0a'+_0x21dc3b,_0x292edb);await(0x0,CreateLogTicketService_1[_0x5ec159(0x210)])({'ticketId':_0x292edb['id'],'type':_0x5ec159(0x270)}),await(0x0,baileys_1['delay'])(0x3e8),await _0x2e4717[_0x5ec159(0x28b)](_0x5ec159(0x2f1),_0x2dc261['remoteJid']);if(_0x292edb['whatsapp'][_0x5ec159(0x2e1)]!==null){const _0x930cc5=path_1[_0x5ec159(0x210)]['resolve'](_0x5ec159(0x1ff),'company'+_0x127e0d,_0x292edb['whatsapp'][_0x5ec159(0x2e1)]),_0x33cb52=_0x292edb['whatsapp']['greetingMediaAttachment'],_0x21f3ea=await(0x0,SendWhatsAppMedia_1[_0x5ec159(0x316)])(_0x33cb52,_0x930cc5,String(_0x127e0d),_0x31dba1),_0x215e5d=(0x0,Debounce_1[_0x5ec159(0x203)])(async()=>{const _0x4dee98=_0x5ec159;let _0x41a6e5=await _0x2e4717['sendMessage'](_0x292edb[_0x4dee98(0x318)]['number']+'@'+(_0x292edb[_0x4dee98(0x258)]?_0x4dee98(0x362):'s.whatsapp.net'),{..._0x21f3ea});await(0x0,exports[_0x4dee98(0x2f0)])(_0x41a6e5,_0x292edb,_0x2dc261,_0x1ef1ba);},0x3e8,_0x292edb['id']);_0x215e5d(),await(0x0,UpdateTicketService_1[_0x5ec159(0x210)])({'ticketData':{'amountUsedBotQueues':_0x292edb[_0x5ec159(0x20f)]+0x1},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});return;}else{const _0xf65071=(0x0,Debounce_1['debounce'])(async()=>{const _0x50b9b7=_0x5ec159,_0x49f27c=await _0x2e4717[_0x50b9b7(0x32d)](_0x2dc261[_0x50b9b7(0x23d)]+'@'+(_0x292edb[_0x50b9b7(0x258)]?_0x50b9b7(0x362):_0x50b9b7(0x33c)),{'text':_0x31dba1});(0x0,exports[_0x50b9b7(0x259)])(_0x49f27c,_0x292edb,_0x2dc261,_0x1ef1ba);},0x3e8,_0x292edb['id']);await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':_0x292edb[_0x5ec159(0x20f)]+0x1},'ticketId':_0x292edb['id'],'companyId':_0x127e0d}),_0xf65071();}}},_0x4f0bac=async()=>{const _0x4e77aa=_0x3df615;if(_0x405285){await(0x0,UpdateTicketService_1[_0x4e77aa(0x210)])({'ticketData':{'queueId':_0x405285['id']},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});if(_0x405285['chatbots']['length']>0x0){const _0x298690=[];_0x405285[_0x4e77aa(0x284)][_0x4e77aa(0x25f)]((_0x5b0878,_0x1af7ec)=>{const _0x300d59=_0x4e77aa;_0x298690[_0x300d59(0x33e)]({'buttonId':''+(_0x1af7ec+0x1),'buttonText':{'displayText':_0x5b0878['name']},'type':0x1});});const _0x7c71e2={'text':(0x0,Mustache_1['default'])(''+_0x405285[_0x4e77aa(0x24e)],_0x292edb),'buttons':_0x298690,'headerType':0x4},_0x211b08=await _0x2e4717[_0x4e77aa(0x32d)](_0x2dc261[_0x4e77aa(0x23d)]+'@'+(_0x292edb[_0x4e77aa(0x258)]?_0x4e77aa(0x362):_0x4e77aa(0x33c)),_0x7c71e2);await(0x0,exports[_0x4e77aa(0x259)])(_0x211b08,_0x292edb,_0x2dc261,_0x171661);}if(!_0x405285['chatbots']['length']){const _0x1b940d=(0x0,Mustache_1[_0x4e77aa(0x210)])(''+_0x405285[_0x4e77aa(0x24e)],_0x292edb),_0x470b74=await _0x2e4717['sendMessage'](_0x2dc261[_0x4e77aa(0x23d)]+'@'+(_0x292edb[_0x4e77aa(0x258)]?_0x4e77aa(0x362):_0x4e77aa(0x33c)),{'text':_0x1b940d});await(0x0,exports[_0x4e77aa(0x259)])(_0x470b74,_0x292edb,_0x2dc261,_0x171661);}}else{const _0xccc326=[];_0x321c44[_0x4e77aa(0x25f)]((_0x2c8dbc,_0x1b3d31)=>{const _0x2bc716=_0x4e77aa;_0xccc326['push']({'buttonId':''+(_0x1b3d31+0x1),'buttonText':{'displayText':_0x2c8dbc[_0x2bc716(0x224)]},'type':0x4});});const _0x3a15a9={'text':(0x0,Mustache_1[_0x4e77aa(0x210)])(''+_0x5ebaa0,_0x292edb),'footer':'','buttons':_0xccc326,'headerType':0x4},_0x3ce324=await _0x2e4717[_0x4e77aa(0x32d)](_0x2dc261['number']+'@'+(_0x292edb['isGroup']?_0x4e77aa(0x362):_0x4e77aa(0x33c)),_0x3a15a9);await(0x0,exports[_0x4e77aa(0x259)])(_0x3ce324,_0x292edb,_0x2dc261,_0x171661),await(0x0,UpdateTicketService_1[_0x4e77aa(0x210)])({'ticketData':{'amountUsedBotQueues':_0x292edb[_0x4e77aa(0x20f)]+0x1},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});}},_0x51fae4=async()=>{const _0x90e405=_0x3df615;if(_0x405285){await(0x0,UpdateTicketService_1[_0x90e405(0x210)])({'ticketData':{'queueId':_0x405285['id']},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});if(_0x405285[_0x90e405(0x284)]['length']>0x0){const _0x4393da=[];_0x405285[_0x90e405(0x284)]['forEach']((_0xef9405,_0x4623ad)=>{const _0x3229a5=_0x90e405;_0x4393da['push']({'title':_0xef9405[_0x3229a5(0x224)],'rowId':''+(_0x4623ad+0x1)});});const _0x1c5684=[{'title':_0x90e405(0x229),'rows':_0x4393da}],_0x1549af={'text':(0x0,Mustache_1[_0x90e405(0x210)])(''+_0x405285['greetingMessage'],_0x292edb),'buttonText':_0x90e405(0x2a6),'sections':_0x1c5684},_0x217cca=await _0x2e4717[_0x90e405(0x32d)](_0x2dc261['number']+'@'+(_0x292edb[_0x90e405(0x258)]?_0x90e405(0x362):_0x90e405(0x33c)),_0x1549af);await(0x0,exports[_0x90e405(0x259)])(_0x217cca,_0x292edb,_0x2dc261,_0x171661);}if(!_0x405285[_0x90e405(0x284)][_0x90e405(0x2b7)]){const _0x1ea94e=(0x0,Mustache_1[_0x90e405(0x210)])(''+_0x405285['greetingMessage'],_0x292edb),_0x1fe391=await _0x2e4717[_0x90e405(0x32d)](_0x2dc261[_0x90e405(0x23d)]+'@'+(_0x292edb[_0x90e405(0x258)]?'g.us':'s.whatsapp.net'),{'text':_0x1ea94e});await(0x0,exports[_0x90e405(0x259)])(_0x1fe391,_0x292edb,_0x2dc261,_0x171661);}}else{const _0x4d5e52=[];_0x321c44['forEach']((_0x41fe9a,_0x5bf6dd)=>{_0x4d5e52['push']({'title':_0x41fe9a['name'],'rowId':''+(_0x5bf6dd+0x1)});});const _0x4c1d65=[{'title':_0x90e405(0x229),'rows':_0x4d5e52}],_0x179f45={'text':(0x0,Mustache_1[_0x90e405(0x210)])(''+_0x5ebaa0,_0x292edb),'buttonText':_0x90e405(0x2a6),'sections':_0x4c1d65},_0x3d386b=await _0x2e4717[_0x90e405(0x32d)](_0x2dc261['number']+'@'+(_0x292edb[_0x90e405(0x258)]?_0x90e405(0x362):_0x90e405(0x33c)),_0x179f45);await(0x0,exports['verifyMessage'])(_0x3d386b,_0x292edb,_0x2dc261,_0x171661),await(0x0,UpdateTicketService_1[_0x90e405(0x210)])({'ticketData':{'amountUsedBotQueues':_0x292edb[_0x90e405(0x20f)]+0x1},'ticketId':_0x292edb['id'],'companyId':_0x127e0d});}};if(_0x4bace7===_0x3df615(0x25b))return _0x1a1afe();if(_0x4bace7===_0x3df615(0x33b)&&_0x321c44[_0x3df615(0x2b7)]>0x3)return _0x1a1afe();if(_0x4bace7==='button'&&_0x321c44['length']<=0x3)return _0x4f0bac();if(_0x4bace7===_0x3df615(0x22a))return _0x51fae4();},verifyRating=_0x3960e4=>{const _0x46f614=a616_0x151dc0;if(_0x3960e4&&_0x3960e4[_0x46f614(0x1d1)]===null&&_0x3960e4[_0x46f614(0x21c)]!==null&&_0x3960e4[_0x46f614(0x35f)]!==null&&_0x3960e4['ratingAt']===null)return!![];return![];};exports[a616_0x151dc0(0x369)]=verifyRating;const handleRating=async(_0x3fc58e,_0x5e27ef,_0xf5af48)=>{const _0x16e2d7=a616_0x151dc0,_0x4cb85d=(0x0,socket_1[_0x16e2d7(0x30f)])(),_0x468aa5=_0x5e27ef[_0x16e2d7(0x347)],{complationMessage:_0x2e36ea}=await(0x0,ShowWhatsAppService_1[_0x16e2d7(0x210)])(_0x5e27ef[_0x16e2d7(0x223)],_0x468aa5);let _0x3f2719=_0x3fc58e;_0x3fc58e<0x0&&(_0x3f2719=0x0);_0x3fc58e>0xa&&(_0x3f2719=0xa);await UserRating_1['default'][_0x16e2d7(0x331)]({'ticketId':_0xf5af48[_0x16e2d7(0x31b)],'companyId':_0xf5af48['companyId'],'userId':_0xf5af48[_0x16e2d7(0x35f)],'rate':_0x3f2719});if(!(0x0,lodash_1[_0x16e2d7(0x200)])(_0x2e36ea)&&_0x2e36ea!==''&&!_0x5e27ef['isGroup']){const _0x5756b1=(0x0,Mustache_1[_0x16e2d7(0x210)])('‎'+_0x2e36ea,_0x5e27ef);if(_0x5e27ef[_0x16e2d7(0x2a9)]===_0x16e2d7(0x1e1)){const _0x189b1=await(0x0,SendWhatsAppMessage_1[_0x16e2d7(0x210)])({'body':_0x5756b1,'ticket':_0x5e27ef});await(0x0,exports[_0x16e2d7(0x259)])(_0x189b1,_0x5e27ef,_0x5e27ef[_0x16e2d7(0x318)],_0xf5af48);}['facebook','instagram'][_0x16e2d7(0x261)](_0x5e27ef[_0x16e2d7(0x2a9)])&&await(0x0,sendFacebookMessage_1[_0x16e2d7(0x210)])({'body':_0x5756b1,'ticket':_0x5e27ef});}await _0x5e27ef[_0x16e2d7(0x22c)]({'chatbot':null,'status':_0x16e2d7(0x345),'amountUseBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1['default'])({'userId':_0x5e27ef['userId'],'queueId':_0x5e27ef[_0x16e2d7(0x250)],'ticketId':_0x5e27ef['id'],'type':_0x16e2d7(0x345)}),_0x4cb85d['to'](_0x16e2d7(0x202))[_0x16e2d7(0x2c8)](_0x16e2d7(0x2c3)+_0x468aa5+_0x16e2d7(0x2fd),{'action':_0x16e2d7(0x257),'ticket':_0x5e27ef,'ticketId':_0x5e27ef['id']}),_0x4cb85d['to'](_0x5e27ef[_0x16e2d7(0x297)])['to'](_0x5e27ef['id'][_0x16e2d7(0x2c0)]())['emit']('company-'+_0x468aa5+_0x16e2d7(0x2fd),{'action':'update','ticket':_0x5e27ef,'ticketId':_0x5e27ef['id']});};exports[a616_0x151dc0(0x322)]=handleRating;const sanitizeName=_0x190162=>{const _0x25428c=a616_0x151dc0;let _0x52641e=_0x190162['split']('\x20')[0x0];return _0x52641e=_0x52641e[_0x25428c(0x336)](/[^a-zA-Z0-9]/g,''),_0x52641e[_0x25428c(0x276)](0x0,0x3c);},deleteFileSync=_0x2fe793=>{const _0x2b2d90=a616_0x151dc0;try{fs_2[_0x2b2d90(0x210)][_0x2b2d90(0x2f4)](_0x2fe793);}catch(_0x22d391){console[_0x2b2d90(0x21e)](_0x2b2d90(0x1db),_0x22d391);}},convertTextToSpeechAndSaveToFile=(_0x4fec27,_0x2889ec,_0x5bc2e9,_0x1f16d5,_0x153ad4=a616_0x151dc0(0x2a0),_0x15197c=a616_0x151dc0(0x2ee))=>{return new Promise((_0x45d407,_0x1fb587)=>{const _0x5d176b=a616_0x731b,_0x263676=microsoft_cognitiveservices_speech_sdk_1[_0x5d176b(0x355)]['fromSubscription'](_0x5bc2e9,_0x1f16d5);_0x263676[_0x5d176b(0x2a4)]=_0x153ad4;const _0x1cf418=microsoft_cognitiveservices_speech_sdk_1[_0x5d176b(0x20b)][_0x5d176b(0x2ec)](_0x2889ec+_0x5d176b(0x279)),_0x2264e2=new microsoft_cognitiveservices_speech_sdk_1[(_0x5d176b(0x340))](_0x263676,_0x1cf418);_0x2264e2[_0x5d176b(0x2f8)](_0x4fec27,_0x2f4dde=>{const _0x360d2f=_0x5d176b;_0x2f4dde?convertWavToAnotherFormat(_0x2889ec+_0x360d2f(0x279),_0x2889ec+'.'+_0x15197c,_0x15197c)[_0x360d2f(0x277)](_0x4b2864=>{_0x45d407();})[_0x360d2f(0x272)](_0x4489b9=>{const _0xce7cd4=_0x360d2f;console[_0xce7cd4(0x21e)](_0x4489b9),_0x1fb587(_0x4489b9);}):_0x1fb587(new Error(_0x360d2f(0x1fe))),_0x2264e2[_0x360d2f(0x1cf)]();},_0x897093=>{const _0x1a7825=_0x5d176b;console[_0x1a7825(0x21e)](_0x1a7825(0x326)+_0x897093),_0x2264e2[_0x1a7825(0x1cf)](),_0x1fb587(_0x897093);});});},convertWavToAnotherFormat=(_0xa43b12,_0x3b45c7,_0x42918d)=>{return new Promise((_0x3fc1c3,_0x20c7f0)=>{const _0x5530f1=a616_0x731b;(0x0,fluent_ffmpeg_1['default'])()[_0x5530f1(0x1cd)](_0xa43b12)['toFormat'](_0x42918d)['on'](_0x5530f1(0x20e),()=>_0x3fc1c3(_0x3b45c7))['on'](_0x5530f1(0x21e),_0x546cb0=>_0x20c7f0(new Error(_0x5530f1(0x235)+_0x546cb0[_0x5530f1(0x350)])))[_0x5530f1(0x1dd)](_0x3b45c7);});},keepOnlySpecifiedChars=_0x3f0e4e=>{const _0x4c0e9e=a616_0x151dc0;return _0x3f0e4e[_0x4c0e9e(0x336)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x54ed3a,_0x3a7cc4,_0x40a075,_0x31048f,_0x514487)=>{const _0x5ad5ef=a616_0x151dc0,_0x32ecfe=(0x0,exports['getBodyMessage'])(_0x54ed3a);if(!_0x32ecfe)return;const {prompt:_0x162889}=await(0x0,ShowWhatsAppService_1['default'])(_0x3a7cc4['id'],_0x40a075[_0x5ad5ef(0x347)]);if(!_0x162889)return;if(_0x54ed3a['messageStubType'])return;const _0x323770=path_1[_0x5ad5ef(0x210)][_0x5ad5ef(0x227)](__dirname,'..','..','..',_0x5ad5ef(0x1ff),_0x5ad5ef(0x359)+_0x40a075[_0x5ad5ef(0x347)]);let _0x400930;const _0x246f58=sessionsOpenAi[_0x5ad5ef(0x20d)](_0x1e5c45=>_0x1e5c45['id']===_0x3a7cc4['id']);if(_0x246f58===-0x1){const _0x233d5b=new openai_1[(_0x5ad5ef(0x262))]({'apiKey':_0x162889[_0x5ad5ef(0x1e0)]});_0x400930=new openai_1['OpenAIApi'](_0x233d5b),_0x400930['id']=_0x3a7cc4['id'],sessionsOpenAi[_0x5ad5ef(0x33e)](_0x400930);}else _0x400930=sessionsOpenAi[_0x246f58];const _0x387fc4=await Message_1[_0x5ad5ef(0x210)][_0x5ad5ef(0x315)]({'where':{'ticketId':_0x40a075['id']},'order':[[_0x5ad5ef(0x1d5),_0x5ad5ef(0x2c6)]],'limit':_0x162889[_0x5ad5ef(0x319)]}),_0x461653='Nas\x20respostas\x20utilize\x20o\x20nome\x20'+sanitizeName(_0x31048f['name']||_0x5ad5ef(0x29a))+_0x5ad5ef(0x283)+_0x162889['maxTokens']+'\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20'+_0x162889[_0x5ad5ef(0x34d)]+'\x0a';let _0x5f3638=[];if(_0x54ed3a['message']?.[_0x5ad5ef(0x221)]||_0x54ed3a[_0x5ad5ef(0x350)]?.[_0x5ad5ef(0x1f7)]?.[_0x5ad5ef(0x25b)]){_0x5f3638=[],_0x5f3638[_0x5ad5ef(0x33e)]({'role':_0x5ad5ef(0x312),'content':_0x461653});for(let _0x53b0b1=0x0;_0x53b0b1<Math[_0x5ad5ef(0x2e2)](_0x162889[_0x5ad5ef(0x319)],_0x387fc4[_0x5ad5ef(0x2b7)]);_0x53b0b1++){const _0x463a25=_0x387fc4[_0x53b0b1];_0x463a25['mediaType']===_0x5ad5ef(0x287)&&(_0x463a25[_0x5ad5ef(0x330)]?_0x5f3638[_0x5ad5ef(0x33e)]({'role':_0x5ad5ef(0x305),'content':_0x463a25[_0x5ad5ef(0x233)]}):_0x5f3638[_0x5ad5ef(0x33e)]({'role':_0x5ad5ef(0x2ad),'content':_0x463a25[_0x5ad5ef(0x233)]}));}_0x5f3638[_0x5ad5ef(0x33e)]({'role':'user','content':_0x32ecfe});const _0x3379bc=await _0x400930[_0x5ad5ef(0x244)]({'model':_0x5ad5ef(0x1d9),'messages':_0x5f3638,'max_tokens':_0x162889[_0x5ad5ef(0x335)],'temperature':_0x162889[_0x5ad5ef(0x263)]});let _0xfbbf93=_0x3379bc[_0x5ad5ef(0x22b)]['choices'][0x0][_0x5ad5ef(0x350)]?.[_0x5ad5ef(0x2bd)];_0xfbbf93?.[_0x5ad5ef(0x261)](_0x5ad5ef(0x2cf))&&(await transferQueue(_0x162889[_0x5ad5ef(0x250)],_0x40a075,_0x31048f),_0xfbbf93=_0xfbbf93[_0x5ad5ef(0x336)](_0x5ad5ef(0x2cf),'')[_0x5ad5ef(0x357)]());if(_0x162889[_0x5ad5ef(0x228)]===_0x5ad5ef(0x1f3)){const _0x52d29f=await _0x3a7cc4[_0x5ad5ef(0x32d)](_0x54ed3a['key'][_0x5ad5ef(0x282)],{'text':_0xfbbf93});await(0x0,exports['verifyMessage'])(_0x52d29f,_0x40a075,_0x31048f);}else{const _0x2397b6=_0x40a075['id']+'_'+Date[_0x5ad5ef(0x2fe)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0xfbbf93),_0x323770+'/'+_0x2397b6,_0x162889[_0x5ad5ef(0x1de)],_0x162889[_0x5ad5ef(0x265)],_0x162889[_0x5ad5ef(0x228)],_0x5ad5ef(0x2ee))[_0x5ad5ef(0x277)](async()=>{const _0x56d6c1=_0x5ad5ef;try{const _0x4fc06a=await _0x3a7cc4['sendMessage'](_0x54ed3a[_0x56d6c1(0x238)][_0x56d6c1(0x282)],{'audio':{'url':_0x323770+'/'+_0x2397b6+'.mp3'},'mimetype':_0x56d6c1(0x20a),'ptt':!![]});await(0x0,exports[_0x56d6c1(0x2f0)])(_0x4fc06a,_0x40a075,_0x31048f),deleteFileSync(_0x323770+'/'+_0x2397b6+'.mp3'),deleteFileSync(_0x323770+'/'+_0x2397b6+_0x56d6c1(0x279));}catch(_0x5213be){console['log']('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x5213be);}});}}else{if(_0x54ed3a[_0x5ad5ef(0x350)]?.[_0x5ad5ef(0x34c)]){const _0x5117e1=_0x514487[_0x5ad5ef(0x220)]['split']('/')[_0x5ad5ef(0x306)](),_0x4f7332=fs_2['default']['createReadStream'](_0x323770+'/'+_0x5117e1),_0x3b32c9=await _0x400930['createTranscription'](_0x4f7332,'whisper-1');_0x5f3638=[],_0x5f3638[_0x5ad5ef(0x33e)]({'role':_0x5ad5ef(0x312),'content':_0x461653});for(let _0x218036=0x0;_0x218036<Math[_0x5ad5ef(0x2e2)](_0x162889['maxMessages'],_0x387fc4['length']);_0x218036++){const _0x466730=_0x387fc4[_0x218036];_0x466730['mediaType']===_0x5ad5ef(0x287)&&(_0x466730['fromMe']?_0x5f3638[_0x5ad5ef(0x33e)]({'role':_0x5ad5ef(0x305),'content':_0x466730[_0x5ad5ef(0x233)]}):_0x5f3638[_0x5ad5ef(0x33e)]({'role':'user','content':_0x466730[_0x5ad5ef(0x233)]}));}_0x5f3638['push']({'role':_0x5ad5ef(0x2ad),'content':_0x3b32c9[_0x5ad5ef(0x22b)][_0x5ad5ef(0x25b)]});const _0x3bcbc3=await _0x400930[_0x5ad5ef(0x244)]({'model':'gpt-3.5-turbo','messages':_0x5f3638,'max_tokens':_0x162889[_0x5ad5ef(0x335)],'temperature':_0x162889[_0x5ad5ef(0x263)]});let _0x35b25d=_0x3bcbc3['data']['choices'][0x0][_0x5ad5ef(0x350)]?.[_0x5ad5ef(0x2bd)];_0x35b25d?.['includes']('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x162889['queueId'],_0x40a075,_0x31048f),_0x35b25d=_0x35b25d['replace']('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','')[_0x5ad5ef(0x357)]());if(_0x162889['voice']===_0x5ad5ef(0x1f3)){const _0x2d7ba4=await _0x3a7cc4[_0x5ad5ef(0x32d)](_0x54ed3a[_0x5ad5ef(0x238)]['remoteJid'],{'text':_0x35b25d});await(0x0,exports['verifyMessage'])(_0x2d7ba4,_0x40a075,_0x31048f);}else{const _0x286168=_0x40a075['id']+'_'+Date[_0x5ad5ef(0x2fe)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x35b25d),_0x323770+'/'+_0x286168,_0x162889[_0x5ad5ef(0x1de)],_0x162889[_0x5ad5ef(0x265)],_0x162889[_0x5ad5ef(0x228)],_0x5ad5ef(0x2ee))['then'](async()=>{const _0x5319b7=_0x5ad5ef;try{const _0x1ef9ca=await _0x3a7cc4[_0x5319b7(0x32d)](_0x54ed3a[_0x5319b7(0x238)][_0x5319b7(0x282)],{'audio':{'url':_0x323770+'/'+_0x286168+'.mp3'},'mimetype':_0x5319b7(0x20a),'ptt':!![]});await(0x0,exports[_0x5319b7(0x2f0)])(_0x1ef9ca,_0x40a075,_0x31048f),deleteFileSync(_0x323770+'/'+_0x286168+_0x5319b7(0x1f8)),deleteFileSync(_0x323770+'/'+_0x286168+_0x5319b7(0x279));}catch(_0x542203){console[_0x5319b7(0x1d4)](_0x5319b7(0x2ef)+_0x542203);}});}}}_0x5f3638=[];},transferQueue=async(_0x2aa708,_0x28dad0,_0x5d2b01)=>{const _0x2162a3=a616_0x151dc0;await(0x0,UpdateTicketService_1[_0x2162a3(0x210)])({'ticketData':{'queueId':_0x2aa708},'ticketId':_0x28dad0['id'],'companyId':_0x28dad0[_0x2162a3(0x347)]});},handleMessageIntegration=async(_0x848fb5,_0x27bd39,_0x57c8ee,_0x3e5ec1,_0xeaa2fa)=>{const _0xc98e52=a616_0x151dc0,_0x4f5fa0=getTypeMessage(_0x848fb5);if(_0x3e5ec1[_0xc98e52(0x2a1)]==='n8n'||_0x3e5ec1[_0xc98e52(0x2a1)]===_0xc98e52(0x311)){if(_0x3e5ec1?.[_0xc98e52(0x2be)]){const _0x35ddda={'method':_0xc98e52(0x240),'url':_0x3e5ec1?.[_0xc98e52(0x2be)],'headers':{'Content-Type':_0xc98e52(0x368)},'json':_0x848fb5};try{request(_0x35ddda,function(_0x2d1170,_0x4a334d){const _0x124431=_0xc98e52;if(_0x2d1170)throw new Error(_0x2d1170);else console[_0x124431(0x1d4)](_0x4a334d['body']);});}catch(_0x38d1ff){throw new Error(_0x38d1ff);}}}else{if(_0x3e5ec1[_0xc98e52(0x2a1)]===_0xc98e52(0x256)){let _0x4e3dc1;if(_0x4f5fa0===_0xc98e52(0x34c)){let _0x1a6c92=_0x848fb5['messageTimestamp']+_0xc98e52(0x247);(0x0,fs_1[_0xc98e52(0x1d6)])((0x0,path_1[_0xc98e52(0x2fb)])(__dirname,'..','..','..','public',_0xc98e52(0x359)+_0x57c8ee,_0x1a6c92),_0xc98e52(0x252),(_0x1befee,_0x535f68)=>{_0x4e3dc1=_0x535f68,_0x1befee&&logger_1['logger']['error'](_0x1befee);});}else _0x4e3dc1=undefined;const _0x10601b=(0x0,Debounce_1[_0xc98e52(0x203)])(async()=>{const _0x345e33=_0xc98e52;await sendDialogflowAwswer(_0x27bd39,_0xeaa2fa,_0x848fb5,_0xeaa2fa[_0x345e33(0x318)],_0x4e3dc1,_0x57c8ee,_0x3e5ec1);},0x1f4,_0xeaa2fa['id']);_0x10601b();}else{if(_0x3e5ec1['type']===_0xc98e52(0x254)){}}}};exports[a616_0x151dc0(0x2b2)]=handleMessageIntegration;const handleMessage=async(_0x195cac,_0x12b813,_0x5a8970,_0x532225=![])=>{const _0x4d28ae=a616_0x151dc0;if(_0x532225){(0x0,addLogs_1[_0x4d28ae(0x2dd)])({'fileName':_0x4d28ae(0x2ac)+_0x12b813['id']+_0x4d28ae(0x2b3),'text':_0x4d28ae(0x32b)+JSON[_0x4d28ae(0x35b)](_0x195cac,null,0x2)+'>>>>>>>>>>>>>>>>>>>'});let _0x121b46=_0x195cac[_0x4d28ae(0x238)]['id'],_0x1b2963=await Message_1['default']['findOne']({'where':{'wid':_0x121b46}});if(_0x1b2963){await new Promise(_0x2e998f=>setTimeout(_0x2e998f,0x96)),console[_0x4d28ae(0x1d4)](_0x4d28ae(0x366));return;}else await new Promise(_0x17cc39=>setTimeout(_0x17cc39,parseInt(process[_0x4d28ae(0x342)][_0x4d28ae(0x2db)])||0x14a));}else await new Promise(_0x17fd3f=>setTimeout(_0x17fd3f,i*0x28a)),i++;if(!isValidMsg(_0x195cac))return;try{let _0x561192,_0x3e4440,_0x4156e7=0x0,_0x160f41=0x0,_0x57472b=0x0,_0x3f803a=(0x0,exports[_0x4d28ae(0x30a)])(_0x195cac);const _0x29aab2=getTypeMessage(_0x195cac);if(_0x29aab2===_0x4d28ae(0x249))return;const _0x56cfeb=_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x34c)]||_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x346)]||_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x2da)]||_0x195cac['message']?.[_0x4d28ae(0x36a)]||_0x195cac[_0x4d28ae(0x350)][_0x4d28ae(0x213)]||_0x195cac?.['message']?.[_0x4d28ae(0x290)]?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x346)]||_0x195cac?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x290)]?.[_0x4d28ae(0x350)]?.['audioMessage']||_0x195cac?.[_0x4d28ae(0x350)]?.['ephemeralMessage']?.['message']?.['videoMessage']||_0x195cac?.[_0x4d28ae(0x350)]?.['ephemeralMessage']?.['message']?.[_0x4d28ae(0x36a)]||_0x195cac?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x290)]?.['message']?.[_0x4d28ae(0x213)]||_0x195cac['message']?.[_0x4d28ae(0x25e)]?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x346)]||_0x195cac['message']?.[_0x4d28ae(0x25e)]?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x2da)]||_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x290)]?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x25e)]?.[_0x4d28ae(0x350)]?.['imageMessage']||_0x195cac['message']?.[_0x4d28ae(0x290)]?.['message']?.[_0x4d28ae(0x25e)]?.['message']?.['videoMessage']||_0x195cac['message']?.[_0x4d28ae(0x1cc)]?.[_0x4d28ae(0x350)]?.[_0x4d28ae(0x36a)];if(_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]){if(/\u200e/[_0x4d28ae(0x1fb)](_0x3f803a))return;if(!_0x56cfeb&&_0x29aab2!==_0x4d28ae(0x221)&&_0x29aab2!=='extendedTextMessage'&&_0x29aab2!=='contactMessage'&&_0x29aab2!==_0x4d28ae(0x29c)&&_0x29aab2!=='ephemeralMessage'&&_0x29aab2!==_0x4d28ae(0x249)&&_0x29aab2!==_0x4d28ae(0x25e)&&_0x29aab2!==_0x4d28ae(0x2e0))return;_0x561192=await getContactMessage(_0x195cac,_0x12b813);}else _0x561192=await getContactMessage(_0x195cac,_0x12b813);const _0x5467b7=_0x195cac[_0x4d28ae(0x238)]['remoteJid']?.['endsWith']('@g.us'),_0x5bc12b=await(0x0,ShowWhatsAppService_1[_0x4d28ae(0x210)])(_0x12b813['id'],_0x5a8970);if(!_0x5bc12b['allowGroup']&&_0x5467b7)return;if(_0x5467b7){const _0x745903=await _0x12b813[_0x4d28ae(0x2c2)](_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x282)]),_0x15c17a={'id':_0x745903['id'],'name':_0x745903[_0x4d28ae(0x292)]};_0x3e4440=await verifyContact(_0x15c17a,_0x12b813,_0x5a8970);}const _0x2f4a27=await verifyContact(_0x561192,_0x12b813,_0x5a8970);let _0x2478cf=0x0,_0x3a39df=null;if(_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)])await cache_1[_0x4d28ae(0x210)][_0x4d28ae(0x253)]('contacts:'+_0x2f4a27['id']+':unreads','0');else{const _0x1c2085=await cache_1[_0x4d28ae(0x210)][_0x4d28ae(0x2dc)](_0x4d28ae(0x34a)+_0x2f4a27['id']+_0x4d28ae(0x27c));_0x2478cf=+_0x1c2085+0x1,await cache_1['default'][_0x4d28ae(0x253)](_0x4d28ae(0x34a)+_0x2f4a27['id']+_0x4d28ae(0x27c),''+_0x2478cf);}const _0x3eab72=await CompaniesSettings_1[_0x4d28ae(0x210)][_0x4d28ae(0x26d)]({'where':{'companyId':_0x5a8970}}),_0x225ddb=_0x3eab72[_0x4d28ae(0x31a)]===_0x4d28ae(0x236),{ticket:_0x3de454,isCreated:_0x484586}=await(0x0,FindOrCreateTicketService_1[_0x4d28ae(0x210)])(_0x2f4a27,_0x5bc12b,_0x2478cf,_0x5a8970,_0x4156e7,_0x57472b,_0x3e4440,_0x4d28ae(0x1e1),_0x532225,![],_0x3eab72);_0x3a39df=_0x3de454;if(_0x3a39df[_0x4d28ae(0x297)]==='closed'||_0x2478cf===0x0&&_0x5bc12b[_0x4d28ae(0x2c5)]&&(0x0,Mustache_1[_0x4d28ae(0x210)])(_0x5bc12b[_0x4d28ae(0x2c5)],_0x3a39df)===_0x3f803a)return;if(!_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]&&_0x5bc12b?.[_0x4d28ae(0x35c)]>0x0){const _0x851056=await(0x0,ShowQueueIntegrationService_1[_0x4d28ae(0x210)])(_0x5bc12b[_0x4d28ae(0x35c)],_0x5a8970);await(0x0,exports[_0x4d28ae(0x2b2)])(_0x195cac,_0x12b813,_0x5a8970,_0x851056,_0x3a39df),await _0x3a39df[_0x4d28ae(0x22c)]({'useIntegration':!![],'integrationId':_0x851056['id']});}if(_0x29aab2===_0x4d28ae(0x2e0)){const _0x2b878c=_0x195cac[_0x4d28ae(0x350)][_0x4d28ae(0x2e0)]['message'][_0x4d28ae(0x249)][_0x4d28ae(0x238)]['id'],_0x5f4b18=_0x195cac[_0x4d28ae(0x350)][_0x4d28ae(0x2e0)][_0x4d28ae(0x350)][_0x4d28ae(0x249)]['editedMessage'][_0x4d28ae(0x221)],_0x2683c9=(0x0,socket_1['getIO'])();try{const _0x561415=await Message_1[_0x4d28ae(0x210)][_0x4d28ae(0x26d)]({'where':{'wid':_0x2b878c,'companyId':_0x5a8970,'ticketId':_0x3a39df['id']}});if(!_0x561415)return;await _0x561415['update']({'isEdited':!![],'body':_0x5f4b18}),await _0x3a39df[_0x4d28ae(0x22c)]({'lastMessage':_0x5f4b18}),_0x2683c9['to'](_0x561415[_0x4d28ae(0x31b)]['toString']())[_0x4d28ae(0x2c8)]('company-'+_0x561415['companyId']+'-appMessage',{'action':_0x4d28ae(0x22c),'message':_0x561415});}catch(_0x4324fa){Sentry['captureException'](_0x4324fa),logger_1[_0x4d28ae(0x299)][_0x4d28ae(0x21e)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x4324fa);}return;}const _0x40238c=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x3a39df['id'],'companyId':_0x5a8970,'whatsappId':_0x5bc12b?.['id']});try{if(!_0x195cac[_0x4d28ae(0x238)]['fromMe']){if(_0x3a39df['status']===_0x4d28ae(0x31c)&&_0x40238c!==null&&(0x0,exports[_0x4d28ae(0x369)])(_0x40238c)){_0x56cfeb?await(0x0,exports['verifyMediaMessage'])(_0x195cac,_0x3a39df,_0x2f4a27):await(0x0,exports[_0x4d28ae(0x259)])(_0x195cac,_0x3a39df,_0x2f4a27,_0x40238c);if(!isNaN(parseFloat(_0x3f803a))){(0x0,exports[_0x4d28ae(0x322)])(parseFloat(_0x3f803a),_0x3a39df,_0x40238c),await _0x40238c[_0x4d28ae(0x22c)]({'ratingAt':(0x0,moment_1[_0x4d28ae(0x210)])()[_0x4d28ae(0x212)](),'finishedAt':(0x0,moment_1[_0x4d28ae(0x210)])()[_0x4d28ae(0x212)](),'rated':!![]});return;}else{if(_0x3a39df[_0x4d28ae(0x2c7)]<_0x5bc12b[_0x4d28ae(0x2b0)]){let _0x35a179='‎Opção\x20inválida,\x20tente\x20novamente.\x0a';const _0x310915=await _0x12b813[_0x4d28ae(0x32d)](_0x3a39df[_0x4d28ae(0x318)][_0x4d28ae(0x23d)]+'@'+(_0x3a39df['isGroup']?_0x4d28ae(0x362):_0x4d28ae(0x33c)),{'text':_0x35a179});(0x0,exports['verifyMessage'])(_0x310915,_0x3a39df,_0x2f4a27,_0x40238c),await(0x0,baileys_1[_0x4d28ae(0x354)])(0x3e8);let _0x1f98ca='‎'+_0x5bc12b['ratingMessage']+'\x0a';const _0x19bbd0=await(0x0,SendWhatsAppMessage_1[_0x4d28ae(0x210)])({'body':_0x1f98ca,'ticket':_0x3a39df});await(0x0,exports['verifyMessage'])(_0x19bbd0,_0x3a39df,_0x3a39df['contact']),await _0x3a39df['update']({'amountUseBotQueuesNPS':_0x3a39df[_0x4d28ae(0x2c7)]+0x1});}return;}}if(_0x225ddb&&_0x3a39df[_0x4d28ae(0x297)]==='lgpd'&&!_0x532225){if((0x0,lodash_1['isNil'])(_0x3a39df['lgpdAcceptedAt'])&&!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x3a39df[_0x4d28ae(0x234)])){let _0x127a9a=parseFloat(_0x3f803a);if(!Number['isNaN'](_0x127a9a)&&Number[_0x4d28ae(0x317)](_0x127a9a)&&!(0x0,lodash_1[_0x4d28ae(0x2aa)])(_0x127a9a)&&_0x127a9a>0x0){if(_0x127a9a===0x1)await _0x2f4a27['update']({'lgpdAcceptedAt':(0x0,moment_1[_0x4d28ae(0x210)])()['toDate']()}),await _0x3a39df[_0x4d28ae(0x22c)]({'lgpdAcceptedAt':(0x0,moment_1['default'])()[_0x4d28ae(0x212)](),'amountUsedBotQueues':0x0});else{if(_0x127a9a===0x2){if(_0x5bc12b[_0x4d28ae(0x2c5)]!==''&&_0x5bc12b[_0x4d28ae(0x2c5)]!==undefined){const _0x53bbe9=await _0x12b813['sendMessage'](_0x3a39df[_0x4d28ae(0x318)]['number']+'@'+(_0x3a39df[_0x4d28ae(0x258)]?_0x4d28ae(0x362):'s.whatsapp.net'),{'text':'‎'+_0x5bc12b[_0x4d28ae(0x2c5)]});(0x0,exports[_0x4d28ae(0x259)])(_0x53bbe9,_0x3a39df,_0x2f4a27,_0x40238c);}await _0x3a39df[_0x4d28ae(0x22c)]({'status':_0x4d28ae(0x345),'amountUsedBotQueues':0x0}),await _0x40238c['destroy'];return;}else _0x3a39df[_0x4d28ae(0x20f)]<_0x5bc12b[_0x4d28ae(0x1ce)]&&_0x5bc12b['maxUseBotQueues']>0x0&&await _0x3a39df[_0x4d28ae(0x22c)]({'amountUsedBotQueues':_0x3a39df[_0x4d28ae(0x20f)]+0x1,'lgpdSendMessageAt':null});}}else _0x3a39df[_0x4d28ae(0x20f)]<_0x5bc12b[_0x4d28ae(0x1ce)]&&_0x5bc12b[_0x4d28ae(0x1ce)]>0x0&&await _0x3a39df['update']({'amountUsedBotQueues':_0x3a39df[_0x4d28ae(0x20f)]+0x1,'lgpdSendMessageAt':null});}if((_0x2f4a27['lgpdAcceptedAt']===null||_0x3eab72?.[_0x4d28ae(0x2b1)]===_0x4d28ae(0x236))&&!_0x2f4a27[_0x4d28ae(0x258)]&&(0x0,lodash_1[_0x4d28ae(0x200)])(_0x3a39df['lgpdSendMessageAt'])&&_0x3a39df[_0x4d28ae(0x20f)]<=_0x5bc12b[_0x4d28ae(0x1ce)]&&!(0x0,lodash_1['isNil'])(_0x3eab72?.[_0x4d28ae(0x21b)])){_0x56cfeb?await(0x0,exports[_0x4d28ae(0x2f0)])(_0x195cac,_0x3a39df,_0x2f4a27):await(0x0,exports[_0x4d28ae(0x259)])(_0x195cac,_0x3a39df,_0x2f4a27,_0x40238c);if(!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x3eab72?.[_0x4d28ae(0x21b)])&&_0x3eab72[_0x4d28ae(0x21b)]!==''){const _0xe24577=(0x0,Mustache_1[_0x4d28ae(0x210)])('‎'+_0x3eab72?.[_0x4d28ae(0x21b)],_0x3a39df),_0xdeed33=await _0x12b813[_0x4d28ae(0x32d)](_0x3a39df[_0x4d28ae(0x318)][_0x4d28ae(0x23d)]+'@'+(_0x3a39df['isGroup']?_0x4d28ae(0x362):'s.whatsapp.net'),{'text':_0xe24577});(0x0,exports[_0x4d28ae(0x259)])(_0xdeed33,_0x3a39df,_0x2f4a27,_0x40238c);}await(0x0,baileys_1[_0x4d28ae(0x354)])(0x3e8);if(!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x3eab72?.[_0x4d28ae(0x1e8)])&&_0x3eab72?.[_0x4d28ae(0x1e8)]!==''){const _0x1615c6=(0x0,Mustache_1['default'])('‎'+_0x3eab72?.[_0x4d28ae(0x1e8)],_0x3a39df),_0x18cc49=await _0x12b813[_0x4d28ae(0x32d)](_0x3a39df[_0x4d28ae(0x318)][_0x4d28ae(0x23d)]+'@'+(_0x3a39df[_0x4d28ae(0x258)]?_0x4d28ae(0x362):_0x4d28ae(0x33c)),{'text':_0x1615c6});await(0x0,exports[_0x4d28ae(0x259)])(_0x18cc49,_0x3a39df,_0x2f4a27,_0x40238c);};await(0x0,baileys_1[_0x4d28ae(0x354)])(0x3e8);const _0x4fae73=(0x0,Mustache_1[_0x4d28ae(0x210)])(_0x4d28ae(0x29d),_0x3a39df),_0x3f353b=await _0x12b813[_0x4d28ae(0x32d)](_0x3a39df[_0x4d28ae(0x318)]['number']+'@'+(_0x3a39df[_0x4d28ae(0x258)]?_0x4d28ae(0x362):_0x4d28ae(0x33c)),{'text':_0x4fae73});await(0x0,exports[_0x4d28ae(0x259)])(_0x3f353b,_0x3a39df,_0x2f4a27,_0x40238c),await _0x3a39df[_0x4d28ae(0x22c)]({'lgpdSendMessageAt':(0x0,moment_1[_0x4d28ae(0x210)])()[_0x4d28ae(0x212)](),'amountUsedBotQueues':_0x3a39df['amountUsedBotQueues']+0x1}),await _0x3a39df[_0x4d28ae(0x214)]();return;};if(!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x3a39df['lgpdSendMessageAt'])&&(0x0,lodash_1['isNil'])(_0x3a39df[_0x4d28ae(0x21f)]))return;}}}catch(_0x558667){Sentry[_0x4d28ae(0x2ba)](_0x558667),console[_0x4d28ae(0x1d4)](_0x558667);}const _0x5e048f=_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x1f7)]?.[_0x4d28ae(0x2d8)]?.[_0x4d28ae(0x27b)]||_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x346)]?.[_0x4d28ae(0x2d8)]?.[_0x4d28ae(0x27b)]||_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x34c)]?.[_0x4d28ae(0x2d8)]?.[_0x4d28ae(0x27b)]||_0x195cac[_0x4d28ae(0x350)]?.['videoMessage']?.['contextInfo']?.[_0x4d28ae(0x27b)]||_0x195cac[_0x4d28ae(0x350)]?.[_0x4d28ae(0x36a)]?.[_0x4d28ae(0x2d8)]?.[_0x4d28ae(0x27b)];let _0x3d9c07;_0x56cfeb?_0x3d9c07=await(0x0,exports['verifyMediaMessage'])(_0x195cac,_0x3a39df,_0x2f4a27,_0x40238c,_0x5e048f):await(0x0,exports['verifyMessage'])(_0x195cac,_0x3a39df,_0x2f4a27,_0x40238c,![],_0x5e048f);try{await _0x3a39df[_0x4d28ae(0x22c)]({'fromMe':_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]});}catch(_0x29f53a){Sentry[_0x4d28ae(0x2ba)](_0x29f53a),console['log'](_0x29f53a);}let _0x1ae779;if(_0x3eab72['scheduleType']==='company')_0x1ae779=await(0x0,VerifyCurrentSchedule_1[_0x4d28ae(0x210)])(_0x5a8970,0x0,0x0);else _0x3eab72[_0x4d28ae(0x29e)]==='connection'&&(_0x1ae779=await(0x0,VerifyCurrentSchedule_1[_0x4d28ae(0x210)])(_0x5a8970,0x0,_0x5bc12b['id']));try{if(!_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]&&_0x3eab72['scheduleType']&&(!_0x3a39df['isGroup']||_0x5bc12b['groupAsTicket']===_0x4d28ae(0x236))){if((_0x3eab72[_0x4d28ae(0x29e)]===_0x4d28ae(0x359)||_0x3eab72[_0x4d28ae(0x29e)]==='connection')&&!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x1ae779)&&(!_0x1ae779||_0x1ae779['inActivity']===![])){_0x40238c[_0x4d28ae(0x1e5)]===null&&await _0x40238c[_0x4d28ae(0x22c)]({'chatbotAt':(0x0,moment_1['default'])()[_0x4d28ae(0x212)]()});if(_0x5bc12b[_0x4d28ae(0x1ce)]&&_0x5bc12b['maxUseBotQueues']!==0x0&&_0x3a39df[_0x4d28ae(0x20f)]>=_0x5bc12b[_0x4d28ae(0x1ce)])return;let _0x528d25=new Date(),_0x247b6d=new Date();if(_0x40238c[_0x4d28ae(0x1e5)]!==null){_0x528d25['setMinutes'](_0x40238c[_0x4d28ae(0x1e5)][_0x4d28ae(0x2ea)]()+Number(_0x5bc12b[_0x4d28ae(0x273)]));if(_0x40238c[_0x4d28ae(0x1e5)]!==null&&_0x247b6d<_0x528d25&&_0x5bc12b[_0x4d28ae(0x273)]!=='0'&&_0x3a39df[_0x4d28ae(0x20f)]!==0x0)return;}await _0x40238c[_0x4d28ae(0x22c)]({'chatbotAt':null});if(_0x5bc12b[_0x4d28ae(0x332)]!==''){const _0x46a978=(0x0,Mustache_1[_0x4d28ae(0x210)])(''+_0x5bc12b[_0x4d28ae(0x332)],_0x3a39df),_0x42defd=(0x0,Debounce_1['debounce'])(async()=>{const _0x5b580a=_0x4d28ae;await _0x12b813[_0x5b580a(0x32d)](_0x3a39df['contact'][_0x5b580a(0x23d)]+'@'+(_0x3a39df[_0x5b580a(0x258)]?_0x5b580a(0x362):'s.whatsapp.net'),{'text':_0x46a978});},0x3e8,_0x3a39df['id']);_0x42defd(),await _0x3a39df[_0x4d28ae(0x22c)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3a39df[_0x4d28ae(0x20f)]+0x1});return;}await _0x3a39df[_0x4d28ae(0x22c)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3a39df[_0x4d28ae(0x20f)]+0x1});return;}}}catch(_0x554969){Sentry[_0x4d28ae(0x2ba)](_0x554969),console[_0x4d28ae(0x1d4)](_0x554969);}!_0x3a39df['imported']&&!_0x3a39df[_0x4d28ae(0x365)]&&!_0x5467b7&&!_0x195cac['key'][_0x4d28ae(0x330)]&&!_0x3a39df[_0x4d28ae(0x35f)]&&!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x5bc12b[_0x4d28ae(0x34b)])&&await handleOpenAi(_0x195cac,_0x12b813,_0x3a39df,_0x2f4a27,_0x3d9c07);if(!_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]&&(!_0x3a39df[_0x4d28ae(0x258)]||_0x5bc12b['groupAsTicket']===_0x4d28ae(0x236))&&_0x3a39df[_0x4d28ae(0x365)]&&_0x3a39df['integrationId']&&_0x3a39df[_0x4d28ae(0x280)]){const _0x210662=await(0x0,ShowQueueIntegrationService_1['default'])(_0x3a39df[_0x4d28ae(0x35c)],_0x5a8970);await(0x0,exports[_0x4d28ae(0x2b2)])(_0x195cac,_0x12b813,_0x5a8970,_0x210662,_0x3a39df);return;}!_0x3a39df[_0x4d28ae(0x2fc)]&&!_0x3a39df['queue']&&(!_0x3a39df['isGroup']||_0x5bc12b['groupAsTicket']==='enabled')&&!_0x195cac['key'][_0x4d28ae(0x330)]&&!_0x3a39df[_0x4d28ae(0x35f)]&&_0x5bc12b[_0x4d28ae(0x222)][_0x4d28ae(0x2b7)]>=0x1&&(await verifyQueue(_0x12b813,_0x195cac,_0x3a39df,_0x2f4a27,_0x3eab72),_0x40238c['chatbotAt']===null&&await _0x40238c['update']({'chatbotAt':(0x0,moment_1['default'])()[_0x4d28ae(0x212)]()}));_0x3a39df[_0x4d28ae(0x250)]>0x0&&await _0x40238c[_0x4d28ae(0x22c)]({'queueId':_0x3a39df[_0x4d28ae(0x250)]});if((getTypeMessage(_0x195cac)==='audioMessage'||getTypeMessage(_0x195cac)===_0x4d28ae(0x2da))&&!_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]&&(!_0x3a39df[_0x4d28ae(0x258)]||_0x5bc12b['groupAsTicket']===_0x4d28ae(0x236))&&(!_0x2f4a27?.[_0x4d28ae(0x2cb)]||_0x3eab72?.[_0x4d28ae(0x201)]===_0x4d28ae(0x1eb))){const _0x43d3a8=await _0x12b813[_0x4d28ae(0x32d)](_0x2f4a27[_0x4d28ae(0x23d)]+_0x4d28ae(0x255),{'text':_0x4d28ae(0x1d2)},{'quoted':{'key':_0x195cac['key'],'message':{'extendedTextMessage':_0x195cac['message']['extendedTextMessage']}}});await(0x0,exports[_0x4d28ae(0x259)])(_0x43d3a8,_0x3a39df,_0x2f4a27,_0x40238c);}try{if(!_0x195cac['key']['fromMe']&&_0x3eab72?.[_0x4d28ae(0x29e)]&&_0x3a39df[_0x4d28ae(0x250)]!==null&&(!_0x3a39df[_0x4d28ae(0x258)]||_0x5bc12b[_0x4d28ae(0x260)]===_0x4d28ae(0x236))){const _0x46cf68=await Queue_1['default'][_0x4d28ae(0x2ca)](_0x3a39df['queueId']);_0x3eab72?.['scheduleType']===_0x4d28ae(0x365)&&(_0x1ae779=await(0x0,VerifyCurrentSchedule_1['default'])(_0x5a8970,_0x46cf68['id'],0x0));if(_0x3eab72?.[_0x4d28ae(0x29e)]===_0x4d28ae(0x365)&&!(0x0,lodash_1[_0x4d28ae(0x200)])(_0x1ae779)&&(!_0x1ae779||_0x1ae779[_0x4d28ae(0x1fd)]===![])){const _0x2574f5=_0x46cf68[_0x4d28ae(0x332)];if(_0x2574f5!==''){const _0x4cde10=(0x0,Mustache_1[_0x4d28ae(0x210)])(''+_0x2574f5,_0x3a39df),_0x1bba0b=(0x0,Debounce_1['debounce'])(async()=>{const _0x59d6fe=_0x4d28ae;await _0x12b813[_0x59d6fe(0x32d)](_0x3a39df[_0x59d6fe(0x318)][_0x59d6fe(0x23d)]+'@'+(_0x3a39df[_0x59d6fe(0x258)]?_0x59d6fe(0x362):'s.whatsapp.net'),{'text':_0x4cde10});},0x3e8,_0x3a39df['id']);_0x1bba0b(),await _0x3a39df['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x3a39df[_0x4d28ae(0x20f)]+0x1});return;}await _0x3a39df[_0x4d28ae(0x22c)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3a39df[_0x4d28ae(0x20f)]+0x1});return;}}}catch(_0x3f9890){Sentry[_0x4d28ae(0x2ba)](_0x3f9890),console[_0x4d28ae(0x1d4)](_0x3f9890);}_0x3a39df[_0x4d28ae(0x365)]&&_0x3a39df[_0x4d28ae(0x250)]&&!_0x195cac[_0x4d28ae(0x238)][_0x4d28ae(0x330)]&&((!_0x3a39df[_0x4d28ae(0x2ad)]||_0x3a39df[_0x4d28ae(0x365)]?.['chatbots']?.[_0x4d28ae(0x2b7)]>0x0)&&await(0x0,ChatBotListener_1['sayChatbot'])(_0x3a39df[_0x4d28ae(0x250)],_0x12b813,_0x3a39df,_0x2f4a27,_0x195cac),await _0x3a39df[_0x4d28ae(0x22c)]({'sendInactiveMessage':![]})),await _0x3a39df[_0x4d28ae(0x214)]();}catch(_0x5327b7){Sentry['captureException'](_0x5327b7),console['log'](_0x5327b7),logger_1[_0x4d28ae(0x299)]['error'](_0x4d28ae(0x324)+_0x5327b7);}};exports['handleMessage']=handleMessage;const handleMsgAck=async(_0x311dfb,_0x11c3aa)=>{const _0x562aaa=a616_0x151dc0;await new Promise(_0x105150=>setTimeout(_0x105150,0x1f4));const _0x1f55ad=(0x0,socket_1[_0x562aaa(0x30f)])();try{const _0xe351e7=await Message_1[_0x562aaa(0x210)][_0x562aaa(0x26d)]({'where':{'wid':_0x311dfb[_0x562aaa(0x238)]['id']},'include':[_0x562aaa(0x318),{'model':Message_1[_0x562aaa(0x210)],'as':'quotedMsg','include':[_0x562aaa(0x318)]}]});if(!_0xe351e7)return;await _0xe351e7['update']({'ack':_0x11c3aa}),_0x1f55ad['to'](_0xe351e7[_0x562aaa(0x31b)]['toString']())[_0x562aaa(0x2c8)](_0x562aaa(0x2c3)+_0xe351e7[_0x562aaa(0x347)]+_0x562aaa(0x1dc),{'action':_0x562aaa(0x22c),'message':_0xe351e7});}catch(_0x48e860){Sentry[_0x562aaa(0x2ba)](_0x48e860),logger_1['logger']['error'](_0x562aaa(0x28c)+_0x48e860);}},verifyRecentCampaign=async(_0x4a39cd,_0x4546ae)=>{const _0x4d3503=a616_0x151dc0;if(!isValidMsg(_0x4a39cd))return;if(!_0x4a39cd[_0x4d3503(0x238)]['fromMe']){const _0xa305a2=_0x4a39cd[_0x4d3503(0x238)][_0x4d3503(0x282)][_0x4d3503(0x336)](/\D/g,''),_0x19d4a4=await Campaign_1[_0x4d3503(0x210)][_0x4d3503(0x315)]({'where':{'companyId':_0x4546ae,'status':_0x4d3503(0x35a),'confirmation':!![]}});if(_0x19d4a4){const _0x5683f7=_0x19d4a4[_0x4d3503(0x363)](_0x5b4fcb=>_0x5b4fcb['id']),_0x72f973=await CampaignShipping_1[_0x4d3503(0x210)]['findOne']({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x5683f7},'number':_0xa305a2,'confirmation':null}});_0x72f973&&(await _0x72f973['update']({'confirmedAt':(0x0,moment_1['default'])(),'confirmation':!![]}),await queues_1[_0x4d3503(0x2e6)][_0x4d3503(0x2b6)](_0x4d3503(0x271),{'campaignShippingId':_0x72f973['id'],'campaignId':_0x72f973[_0x4d3503(0x334)]},{'delay':(0x0,queues_1[_0x4d3503(0x34e)])((0x0,queues_1[_0x4d3503(0x286)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x5987d3,_0x4773e6,_0x303594)=>{const _0xb4ab7a=a616_0x151dc0;if(!isValidMsg(_0x5987d3))return;let _0x295a52;_0x295a52=await getContactMessage(_0x5987d3,_0x303594);const _0x1fdf40=await verifyContact(_0x295a52,_0x303594,_0x4773e6),_0x40f5e2=(0x0,socket_1[_0xb4ab7a(0x30f)])(),_0x61842a=await(0x0,exports[_0xb4ab7a(0x30a)])(_0x5987d3),_0x3d38fc=/\u200c/['test'](_0x61842a);if(_0x5987d3[_0xb4ab7a(0x238)][_0xb4ab7a(0x330)]&&_0x3d38fc){const _0x2abaaa=await Message_1[_0xb4ab7a(0x210)][_0xb4ab7a(0x26d)]({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x5987d3[_0xb4ab7a(0x238)]['id']},{'contactId':_0x1fdf40['id']}],'companyId':_0x4773e6}});if(!(0x0,lodash_1[_0xb4ab7a(0x2aa)])(_0x2abaaa)||!(0x0,lodash_1[_0xb4ab7a(0x200)])(_0x2abaaa)||_0x2abaaa!==null){const _0x227d78=await Ticket_1[_0xb4ab7a(0x210)]['findByPk'](_0x2abaaa[_0xb4ab7a(0x31b)]);await _0x227d78[_0xb4ab7a(0x22c)]({'status':'closed','amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x40f5e2['to']('open')[_0xb4ab7a(0x2c8)](_0xb4ab7a(0x2c3)+_0x4773e6+_0xb4ab7a(0x2fd),{'action':_0xb4ab7a(0x257),'ticket':_0x227d78,'ticketId':_0x227d78['id']}),_0x40f5e2['to'](_0x227d78[_0xb4ab7a(0x297)])['to'](_0x227d78['id'][_0xb4ab7a(0x2c0)]())['emit'](_0xb4ab7a(0x2c3)+_0x4773e6+_0xb4ab7a(0x2fd),{'action':_0xb4ab7a(0x22c),'ticket':_0x227d78,'ticketId':_0x227d78['id']});}}},filterMessages=_0x4d458d=>{const _0x23284e=a616_0x151dc0;if(_0x4d458d['message']?.[_0x23284e(0x249)])return![];if([baileys_1['WAMessageStubType'][_0x23284e(0x29b)],baileys_1[_0x23284e(0x29f)][_0x23284e(0x248)],baileys_1[_0x23284e(0x29f)][_0x23284e(0x329)],baileys_1[_0x23284e(0x29f)][_0x23284e(0x32c)]][_0x23284e(0x261)](_0x4d458d[_0x23284e(0x23a)]))return![];return!![];},wbotMessageListener=(_0x4d7ea0,_0x41d17e)=>{const _0x51b0e7=a616_0x151dc0;_0x4d7ea0['ev']['on'](_0x51b0e7(0x1fc),async _0x18eba1=>{const _0x4e767f=_0x51b0e7,_0x46c185=_0x18eba1['messages'][_0x4e767f(0x1f0)](filterMessages)[_0x4e767f(0x363)](_0x165cba=>_0x165cba);if(!_0x46c185)return;_0x46c185[_0x4e767f(0x25f)](async _0x43cdfc=>{const _0x1a53cf=_0x4e767f,_0x548863=await Message_1[_0x1a53cf(0x210)][_0x1a53cf(0x1e9)]({'where':{'wid':_0x43cdfc['key']['id'],'companyId':_0x41d17e}});if(!_0x548863){let _0x461c79=![],_0x4bab5f=await(0x0,exports[_0x1a53cf(0x30a)])(_0x43cdfc);const _0x2222ce=_0x43cdfc?.[_0x1a53cf(0x238)]?.['fromMe'];if(_0x2222ce)_0x461c79=/\u200c/['test'](_0x4bab5f);else{if(/\u200c/[_0x1a53cf(0x1fb)](_0x4bab5f))_0x4bab5f=_0x4bab5f[_0x1a53cf(0x336)](/\u200c/,'');logger_1[_0x1a53cf(0x299)]['debug'](_0x1a53cf(0x2b9)+_0x4bab5f);}if(!_0x461c79){await handleMessage(_0x43cdfc,_0x4d7ea0,_0x41d17e);return;}await verifyRecentCampaign(_0x43cdfc,_0x41d17e),await verifyCampaignMessageAndCloseTicket(_0x43cdfc,_0x41d17e,_0x4d7ea0);}_0x43cdfc['key'][_0x1a53cf(0x282)]?.['endsWith'](_0x1a53cf(0x25d))&&handleMsgAck(_0x43cdfc,0x2);});}),_0x4d7ea0['ev']['on'](_0x51b0e7(0x2a2),_0x1a4537=>{const _0x482082=_0x51b0e7;if(_0x1a4537[_0x482082(0x2b7)]===0x0)return;_0x1a4537[_0x482082(0x25f)](async _0xca33f=>{const _0x27c52d=_0x482082;_0x4d7ea0[_0x27c52d(0x352)]([_0xca33f[_0x27c52d(0x238)]]);const _0x129c82={..._0x1a4537};_0x129c82['0']?.[_0x27c52d(0x22c)]['messageStubType']===0x1&&_0x129c82['0']?.[_0x27c52d(0x238)][_0x27c52d(0x282)]!==_0x27c52d(0x361)&&(0x0,MarkDeleteWhatsAppMessage_1['default'])(_0x129c82['0']?.[_0x27c52d(0x238)]['remoteJid'],null,_0x129c82['0']?.[_0x27c52d(0x238)]['id'],_0x41d17e);let _0x57ec0f;_0xca33f[_0x27c52d(0x22c)]['status']===0x3&&_0xca33f?.[_0x27c52d(0x238)]?.['fromMe']?_0x57ec0f=0x2:_0x57ec0f=_0xca33f[_0x27c52d(0x22c)][_0x27c52d(0x297)],handleMsgAck(_0xca33f,_0x57ec0f);});}),_0x4d7ea0['ev']['on']('groups.update',_0x52afb5=>{const _0x3e3a6b=_0x51b0e7;if(_0x52afb5['length']===0x0)return;_0x52afb5[_0x3e3a6b(0x25f)](async _0x1da311=>{const _0x120253=_0x3e3a6b,_0x4eaf93=_0x1da311['id'][_0x120253(0x336)](/\D/g,''),_0x8acfa=_0x1da311['subject']||_0x4eaf93;let _0x5240c8;try{_0x5240c8=await _0x4d7ea0[_0x120253(0x26c)](_0x1da311['id'],_0x120253(0x2ed));}catch(_0x5559e0){Sentry[_0x120253(0x2ba)](_0x5559e0),_0x5240c8=process[_0x120253(0x342)][_0x120253(0x2fa)]+_0x120253(0x32f);}const _0x3a1706={'name':_0x8acfa,'number':_0x4eaf93,'isGroup':!![],'companyId':_0x41d17e,'remoteJid':_0x1da311['id'],'profilePicUrl':_0x5240c8},_0x4e1086=await(0x0,CreateOrUpdateContactService_1['default'])(_0x3a1706);});});};exports['wbotMessageListener']=wbotMessageListener;
=======
'use strict';const a615_0x5b5b25=a615_0xc8bf;(function(_0xaf85c1,_0x115c37){const _0x1138b5=a615_0xc8bf,_0x220b8b=_0xaf85c1();while(!![]){try{const _0x449b40=parseInt(_0x1138b5(0x27d))/0x1*(parseInt(_0x1138b5(0x167))/0x2)+parseInt(_0x1138b5(0x29b))/0x3*(parseInt(_0x1138b5(0x257))/0x4)+-parseInt(_0x1138b5(0x23c))/0x5+-parseInt(_0x1138b5(0x1db))/0x6*(parseInt(_0x1138b5(0x2b1))/0x7)+parseInt(_0x1138b5(0x247))/0x8*(-parseInt(_0x1138b5(0x1fe))/0x9)+-parseInt(_0x1138b5(0x2bd))/0xa+parseInt(_0x1138b5(0x23f))/0xb;if(_0x449b40===_0x115c37)break;else _0x220b8b['push'](_0x220b8b['shift']());}catch(_0x373cb2){_0x220b8b['push'](_0x220b8b['shift']());}}}(a615_0x1f9f,0xe076b));var __createBinding=this&&this[a615_0x5b5b25(0x17c)]||(Object[a615_0x5b5b25(0x1e0)]?function(_0x41740d,_0x4d3583,_0xc710d9,_0x5c9c0c){const _0x422955=a615_0x5b5b25;if(_0x5c9c0c===undefined)_0x5c9c0c=_0xc710d9;var _0x555818=Object[_0x422955(0x18d)](_0x4d3583,_0xc710d9);(!_0x555818||(_0x422955(0x232)in _0x555818?!_0x4d3583['__esModule']:_0x555818[_0x422955(0x1c1)]||_0x555818[_0x422955(0x217)]))&&(_0x555818={'enumerable':!![],'get':function(){return _0x4d3583[_0xc710d9];}}),Object[_0x422955(0x226)](_0x41740d,_0x5c9c0c,_0x555818);}:function(_0x5c04cc,_0x41eb6b,_0x3617c8,_0x28319a){if(_0x28319a===undefined)_0x28319a=_0x3617c8;_0x5c04cc[_0x28319a]=_0x41eb6b[_0x3617c8];}),__setModuleDefault=this&&this[a615_0x5b5b25(0x1b3)]||(Object[a615_0x5b5b25(0x1e0)]?function(_0x352bb2,_0x2ca365){const _0xc8a3e4=a615_0x5b5b25;Object[_0xc8a3e4(0x226)](_0x352bb2,_0xc8a3e4(0x270),{'enumerable':!![],'value':_0x2ca365});}:function(_0x444d7a,_0x454df4){_0x444d7a['default']=_0x454df4;}),__importStar=this&&this[a615_0x5b5b25(0x2a4)]||function(_0x827260){const _0xd293ff=a615_0x5b5b25;if(_0x827260&&_0x827260[_0xd293ff(0x22c)])return _0x827260;var _0x3f9df1={};if(_0x827260!=null){for(var _0x2089a7 in _0x827260)if(_0x2089a7!==_0xd293ff(0x270)&&Object['prototype']['hasOwnProperty'][_0xd293ff(0x1b0)](_0x827260,_0x2089a7))__createBinding(_0x3f9df1,_0x827260,_0x2089a7);}return __setModuleDefault(_0x3f9df1,_0x827260),_0x3f9df1;},__importDefault=this&&this[a615_0x5b5b25(0x208)]||function(_0x306a7b){const _0x33b18f=a615_0x5b5b25;return _0x306a7b&&_0x306a7b[_0x33b18f(0x22c)]?_0x306a7b:{'default':_0x306a7b};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a615_0x5b5b25(0x286)]=exports['isValidMsg']=exports[a615_0x5b5b25(0x220)]=exports[a615_0x5b5b25(0x296)]=exports['handleMessageIntegration']=exports[a615_0x5b5b25(0x237)]=exports[a615_0x5b5b25(0x18e)]=exports['verifyMessage']=exports[a615_0x5b5b25(0x149)]=exports[a615_0x5b5b25(0x2bf)]=exports[a615_0x5b5b25(0x17a)]=exports['getBodyMessage']=void 0x0;const path_1=__importStar(require(a615_0x5b5b25(0x2af))),util_1=require(a615_0x5b5b25(0x1a8)),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require('@sentry/node')),lodash_1=require('lodash'),baileys_1=require(a615_0x5b5b25(0x1a9)),Contact_1=__importDefault(require(a615_0x5b5b25(0x26a))),Ticket_1=__importDefault(require(a615_0x5b5b25(0x195))),Message_1=__importDefault(require(a615_0x5b5b25(0x294))),socket_1=require(a615_0x5b5b25(0x1d3)),CreateMessageService_1=__importDefault(require(a615_0x5b5b25(0x252))),logger_1=require(a615_0x5b5b25(0x183)),CreateOrUpdateContactService_1=__importDefault(require(a615_0x5b5b25(0x1e6))),FindOrCreateTicketService_1=__importDefault(require('../TicketServices/FindOrCreateTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),Debounce_1=require('../../helpers/Debounce'),UpdateTicketService_1=__importDefault(require(a615_0x5b5b25(0x15a))),Mustache_1=__importDefault(require('../../helpers/Mustache')),UserRating_1=__importDefault(require(a615_0x5b5b25(0x1a4))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),sendFacebookMessage_1=__importDefault(require(a615_0x5b5b25(0x2cf))),moment_1=__importDefault(require(a615_0x5b5b25(0x147))),Queue_1=__importDefault(require(a615_0x5b5b25(0x1f1))),FindOrCreateATicketTrakingService_1=__importDefault(require('../TicketServices/FindOrCreateATicketTrakingService')),VerifyCurrentSchedule_1=__importDefault(require(a615_0x5b5b25(0x2ad))),Campaign_1=__importDefault(require(a615_0x5b5b25(0x1aa))),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require(a615_0x5b5b25(0x225)),queues_1=require(a615_0x5b5b25(0x1a0)),User_1=__importDefault(require('../../models/User')),ChatBotListener_1=require(a615_0x5b5b25(0x175)),MarkDeleteWhatsAppMessage_1=__importDefault(require(a615_0x5b5b25(0x201))),ListUserQueueServices_1=__importDefault(require(a615_0x5b5b25(0x172))),cache_1=__importDefault(require(a615_0x5b5b25(0x199))),addLogs_1=require(a615_0x5b5b25(0x24c)),SendWhatsAppMedia_1=__importStar(require('./SendWhatsAppMedia')),ShowQueueIntegrationService_1=__importDefault(require(a615_0x5b5b25(0x28b))),CreateSessionDialogflow_1=require(a615_0x5b5b25(0x215)),QueryDialogflow_1=require(a615_0x5b5b25(0x186)),CompaniesSettings_1=__importDefault(require(a615_0x5b5b25(0x1e7))),CreateLogTicketService_1=__importDefault(require('../TicketServices/CreateLogTicketService')),Whatsapp_1=__importDefault(require(a615_0x5b5b25(0x164))),ShowService_1=__importDefault(require(a615_0x5b5b25(0x19f))),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require(a615_0x5b5b25(0x26e))),microsoft_cognitiveservices_speech_sdk_1=require('microsoft-cognitiveservices-speech-sdk'),os=require('os'),request=require(a615_0x5b5b25(0x21e));function a615_0x1f9f(){const _0x12123c=['contact','enabled','emit','../QueueIntegrationServices/CreateSessionDialogflow','lgpdLink','configurable','isNil','E2E_DEVICE_CHANGED','assistant','prompt','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mídia\x20verifique\x20no\x20dispositivo','isValidMsg','request',':unreads','handleMessage','jidNormalizedUser','isGroup','messageContextInfo','presenceSubscribe','sequelize','defineProperty','delete','.wav','toDate','findIndex','whatsapp','__esModule','protocolMessage','isInteger','videoMessage','getMinutes','shift','get','texto','toLocaleLowerCase','groupMetadata','promisify','handleRating','voiceRegion','s.whatsapp.net','whatsappId','win32','6472315hAGQHg','extractMessageContent','fromAudioFileOutput','27845543HGoYWZ','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posição\x20na\x20fila\x20de\x20atendimento\x20é:\x20*','remoteJid','contentText','closeTicket','description','finishedAt','.txt','1712icZhui','Erro\x20media','Error:\x20','&z=17&hl=pt-BR|','readMessages','../../helpers/addLogs',':*\x20','application/json','find','composing','recording','../MessageServices/CreateMessageService','displayText','name','facebook','button','212196pxOeIK','list','sendPresenceUpdate','TIMEOUT_TO_IMPORT_MESSAGE','>>>>>>>>>>>>>>>>>>>','WAMessageStubType','\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento','status@broadcast',';;;','REVOKE','userId','lgpdAcceptedAt','stringify','@g.us','FRONTEND_URL','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','documentMessage','\x20]*\x20-\x20','info','../../models/Contact','maxTokens','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','save','fluent-ffmpeg','buttonsResponseMessage','default','degreesLatitude','processImportMessagesWppId','title','image','Esta\x20mensagem\x20já\x20existe','ERR_WAPP_DOWNLOAD_MEDIA','endConversation','log','mkdirSync','createChatCompletion','selectedDisplayText','quotedMsg','4201mZPViW','profilePictureUrl','fromMe','vcard','verifyMessage','fileListId','quotedMessage','from','pushName','getTypeMessage','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','pt-BR-FabioNeural','voiceKey','floor','../QueueIntegrationServices/ShowQueueIntegrationService','documentWithCaptionMessage','listResponseMessage','data','Latitude:\x20','Nas\x20respostas\x20utilize\x20o\x20nome\x20','extendedTextMessage','amountUsedBotQueues','integrationId','../../models/Message','useIntegration','wbotMessageListener','outOfHoursMessage','speechSynthesisVoiceName','parameters','greetingMessage','3WTqdLc','inActivity','pending','add','temperature','Configuration','Escolha\x20uma\x20opção','user','then','__importStar','audioMessage','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','resolve','-ticket','handleMessageIntegration','entries','.mp3','maxUseBotQueuesNPS','../CompanyService/VerifyCurrentSchedule','ratingAt','path','whisper-1','2814WkbtPd','urlN8N','end','buffer','body','open','reload','Output\x20File:','.mpeg','chatbotAt','isForwarded','channel','13991510ICOelo','.ogg','getQuotedMessageId','min','Mensagem','amountUseBotQueuesNPS','endsWith','getBodyMessage','sayChatbot','count','viewOnceMessage','connection','toString','getMessageOptions','darwin','editedMessage','set','lgpdSendMessageAt','../FacebookServices/sendFacebookMessage','getIO','chmodSync','lgpdMessage','webhook','getTime','instagram','encodedAudio','options','Validação\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','keys','trim','caption','messages.update','includes','value','companyId','push','groupAsTicket','chat','moment','####\x20Nao\x20achou\x20o\x20type\x20152:\x20','verifyMediaMessage','findAndCountAll','messageTimestamp','data:image/png;base64,\x20','Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20já\x20não\x20esta\x20mais\x20disponível','sticker','paused','captureException','next','degreesLongitude','participant','split','randomValue','type','chatBotType','contacts','NFD','../TicketServices/UpdateTicketService','CIPHERTEXT','react','farewellMessage','contactId','-appMessage','OpenAIApi','nps','contactsArrayMessage','pop','../../models/Whatsapp','fromSubscription','debug','806rDFvzs','ephemeralMessage','conversation','item1.TEL:','acceptAudioMessageContact','maxMessages','replace','createReadStream','apiKey','forEach','logger','../UserQueueServices/ListUserQueueServices','lgpd','mediaType','./ChatBotListener','C:\x5cffmpeg\x5cffmpeg.exe','\x20|\x20https://maps.google.com/maps?q=','join','locationMessage','getQuotedMessage','contextInfo','__createBinding','Error\x20getTypeMessage','ratingMessage','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','map','filename','content','../../utils/logger','setExtra','queue','../QueueIntegrationServices/QueryDialogflow','indexOf','close','selectedButtonId','listMessage','unlink','length','getOwnPropertyDescriptor','verifyRating','imageMessage','key','mimetype','allowGroup','Áudio','number','../../models/Ticket','company','Error\x20handling\x20message\x20ack.\x20Err:\x20','SpeechConfig','../../libs/cache','rows','subject','now','selectedId','reactionMessage','../FileServices/ShowService','../../queues','public','values','No\x20result\x20from\x20synthesizer','../../models/UserRating','complationMessage','error','parseToMilliseconds','util','@whiskeysockets/baileys','../../models/Campaign','queryDialogFlow','base64','createdAt','status','existsSync','call','input','findOne','__setModuleDefault','campaignId','closedAt','company-','downloadMediaMessage','isNull','stickerMessage','acceptAudioMessage','messageStubType','BEGIN:','axolotlSenderKeyDistributionMessage','greetingMediaAttachment','messages.upsert','normalize','writable',':\x20📞','choices','Amigo(a)','audio/mpeg','projectName','test','g.us','\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento','filter','closed','audio','readFile','liveLocationMessage','Erro\x20ao\x20baixar\x20mídia:','enableLGPD','fileList','toISOString','../../libs/socket','imported','campaignQueue','buttons','maxUseBotQueues','7bit','contacts:','medias','9882bMOlpA','queueId','message','‎*Assistente\x20Virtual*:\x0aInfelizmente\x20não\x20conseguimos\x20escutar\x20nem\x20enviar\x20áudios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.','Menu','create','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','platform','voice','/nopicture.png','POST','../ContactServices/CreateOrUpdateContactService','../../models/CompaniesSettings','mediaMessage','delay','env','Erro\x20para\x20responder\x20com\x20audio:\x20','chatbots','warn','%2C','‎\x20*','mp3','../../models/Queue','sections','ticketId','*[\x20','gpt-3.5-turbo','@c.us','scheduleType','buttonText','stringValue','system','contactMessage','findByPk',':*\x20Não\x20consegui\x20entender\x20sua\x20dúvida.','99WyGyHJ','setMinutes','viewOnceMessageV2','./MarkDeleteWhatsAppMessage','debounce','buttonsMessage','update','substring','typebot','responses','__importDefault','Erro\x20ao\x20deletar\x20o\x20arquivo:','mediaUrl','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage','text','chatBot','sair','sendMessage','settingsUserRandom','Formato\x20de\x20arquivo\x20não\x20suportado:'];a615_0x1f9f=function(){return _0x12123c;};return a615_0x1f9f();}let ffmpegPath;if(os['platform']()===a615_0x5b5b25(0x23b))ffmpegPath=a615_0x5b5b25(0x176);else os[a615_0x5b5b25(0x1e2)]()===a615_0x5b5b25(0x2cb)?ffmpegPath='/opt/homebrew/bin/ffmpeg':ffmpegPath='/usr/bin/ffmpeg';fluent_ffmpeg_1[a615_0x5b5b25(0x270)]['setFfmpegPath'](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a615_0x5b5b25(0x236)])(fs_1['writeFile']);function removeFile(_0x32f1b0){const _0x479cb7=a615_0x5b5b25;fs_2[_0x479cb7(0x270)][_0x479cb7(0x18b)](_0x32f1b0,_0x152c94=>{if(_0x152c94)throw _0x152c94;});}const getTimestampMessage=_0x1418d6=>{return _0x1418d6*0x1;},multVecardGet=function(_0x8c4de8){const _0x23c185=a615_0x5b5b25;let _0x8729b7='\x20',_0x522834=_0x8c4de8['split']('\x0a')[0x2]['replace'](_0x23c185(0x25f),'\x0a')[_0x23c185(0x16d)]('N:','')['replace'](';','')[_0x23c185(0x16d)](';','\x20')['replace'](';;','\x20')[_0x23c185(0x16d)]('\x0a',''),_0x476149=_0x8c4de8[_0x23c185(0x154)]('\x0a')[0x4]['indexOf']('='),_0x55ab6b=_0x8c4de8[_0x23c185(0x154)]('\x0a')[0x4][_0x23c185(0x187)](':'),_0x549dc9=_0x8c4de8['split']('\x0a')[0x4][_0x23c185(0x205)](_0x476149+0x1,_0x55ab6b)[_0x23c185(0x16d)](';',''),_0x50708a=_0x8c4de8[_0x23c185(0x154)]('\x0a')[0x4]['replace'](_0x23c185(0x16a),'');if(_0x549dc9!='item1.TEL')_0x8729b7=_0x8729b7+_0x522834+_0x23c185(0x1c2)+_0x549dc9+''+'\x0a';else _0x8729b7=_0x8729b7+_0x522834+':\x20📞'+_0x50708a+''+'\x0a';return _0x8729b7;},contactsArrayMessageGet=_0x26a05f=>{const _0x2ba854=a615_0x5b5b25;let _0x1e4136=_0x26a05f['message']?.[_0x2ba854(0x162)]?.[_0x2ba854(0x158)],_0x599cc7=_0x1e4136['map'](function(_0x5406f8,_0xfc78c9){const _0x405df4=_0x2ba854;return _0x5406f8[_0x405df4(0x280)];}),_0x558aaf='';_0x599cc7['forEach'](function(_0x4384e9,_0x1efb5d){_0x558aaf+=_0x4384e9+'\x0a\x0a'+'';});let _0x43151d=_0x558aaf[_0x2ba854(0x154)](_0x2ba854(0x1bc));_0x43151d[_0x2ba854(0x231)]();let _0x4b3ad8='';for(let _0x2c0814 of _0x43151d){_0x4b3ad8=_0x4b3ad8+multVecardGet(_0x2c0814);}return _0x4b3ad8;},getTypeMessage=_0x1d9fb2=>{const _0x6243f0=a615_0x5b5b25,_0x2e20d1=(0x0,baileys_1['getContentType'])(_0x1d9fb2[_0x6243f0(0x1dd)]);if(_0x1d9fb2[_0x6243f0(0x1dd)]?.[_0x6243f0(0x200)])return _0x6243f0(0x200);return _0x2e20d1;};exports[a615_0x5b5b25(0x286)]=getTypeMessage;const getBodyButton=_0x2f139c=>{const _0x3b35f0=a615_0x5b5b25;if(_0x2f139c[_0x3b35f0(0x190)][_0x3b35f0(0x27f)]&&_0x2f139c[_0x3b35f0(0x1dd)][_0x3b35f0(0x203)]?.[_0x3b35f0(0x242)]){let _0xcf104f=''+_0x2f139c?.['message']?.[_0x3b35f0(0x203)]?.['contentText'];for(const _0x31a265 of _0x2f139c[_0x3b35f0(0x1dd)]?.['buttonsMessage']?.[_0x3b35f0(0x1d6)]){_0xcf104f+='\x0a\x0a'+_0x31a265[_0x3b35f0(0x1f8)]?.[_0x3b35f0(0x253)];}return _0xcf104f;}if(_0x2f139c[_0x3b35f0(0x190)][_0x3b35f0(0x27f)]&&_0x2f139c?.['message']?.[_0x3b35f0(0x2c7)]?.['message']?.[_0x3b35f0(0x18a)]){let _0x1d06c1=''+_0x2f139c?.[_0x3b35f0(0x1dd)]?.['viewOnceMessage']?.['message']?.[_0x3b35f0(0x18a)]?.[_0x3b35f0(0x244)];for(const _0x443074 of _0x2f139c[_0x3b35f0(0x1dd)]?.[_0x3b35f0(0x2c7)]?.[_0x3b35f0(0x1dd)]?.[_0x3b35f0(0x18a)]?.[_0x3b35f0(0x1f2)]){for(const _0x330a66 of _0x443074['rows']){_0x1d06c1+='\x0a\x0a'+_0x330a66['title'];}}return _0x1d06c1;}},getBodyList=_0x44fd41=>{const _0x2c9f5e=a615_0x5b5b25;if(_0x44fd41[_0x2c9f5e(0x190)]['fromMe']&&_0x44fd41['message'][_0x2c9f5e(0x18a)]?.[_0x2c9f5e(0x244)]){let _0x4e25c9=''+_0x44fd41[_0x2c9f5e(0x1dd)]['listMessage']?.[_0x2c9f5e(0x244)];for(const _0x114cb2 of _0x44fd41[_0x2c9f5e(0x1dd)]['listMessage']?.[_0x2c9f5e(0x1f2)]){for(const _0x30ec32 of _0x114cb2[_0x2c9f5e(0x19a)]){_0x4e25c9+='\x0a\x0a'+_0x30ec32[_0x2c9f5e(0x273)];}}return _0x4e25c9;}if(_0x44fd41[_0x2c9f5e(0x190)][_0x2c9f5e(0x27f)]&&_0x44fd41?.[_0x2c9f5e(0x1dd)]?.['viewOnceMessage']?.[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x18a)]){let _0x12aa23=''+_0x44fd41?.[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x2c7)]?.[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x18a)]?.[_0x2c9f5e(0x244)];for(const _0x5df9b0 of _0x44fd41[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x2c7)]?.[_0x2c9f5e(0x1dd)]?.['listMessage']?.['sections']){for(const _0x37d488 of _0x5df9b0[_0x2c9f5e(0x19a)]){_0x12aa23+='\x0a\x0a'+_0x37d488[_0x2c9f5e(0x273)];}}return _0x12aa23;}},msgLocation=(_0x361f7c,_0x492710,_0xa5b41c)=>{const _0x51793d=a615_0x5b5b25;if(_0x361f7c){var _0x169aa8=Buffer[_0x51793d(0x284)](_0x361f7c)['toString'](_0x51793d(0x1ac));let _0x2c4a24=_0x51793d(0x14c)+_0x169aa8+_0x51793d(0x177)+_0x492710+_0x51793d(0x1ee)+_0xa5b41c+_0x51793d(0x24a)+_0x492710+',\x20'+_0xa5b41c+'\x20';return _0x2c4a24;}},getBodyMessage=_0x3de033=>{const _0x17c6de=a615_0x5b5b25;try{let _0x2f0bb0=getTypeMessage(_0x3de033);if(_0x2f0bb0===undefined)console[_0x17c6de(0x278)](_0x3de033);const _0x35ccbf={'conversation':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x169)],'imageMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x18f)]?.[_0x17c6de(0x2db)],'videoMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x22f)]?.[_0x17c6de(0x2db)],'extendedTextMessage':_0x3de033?.['message']?.[_0x17c6de(0x291)]?.[_0x17c6de(0x20c)],'buttonsResponseMessage':_0x3de033['message']?.[_0x17c6de(0x26f)]?.[_0x17c6de(0x27b)],'listResponseMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x28d)]?.[_0x17c6de(0x273)]||_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x28d)]?.['singleSelectReply']?.['selectedRowId'],'templateButtonReplyMessage':_0x3de033[_0x17c6de(0x1dd)]?.['templateButtonReplyMessage']?.[_0x17c6de(0x19d)],'messageContextInfo':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x26f)]?.[_0x17c6de(0x189)]||_0x3de033['message']?.['listResponseMessage']?.[_0x17c6de(0x273)],'buttonsMessage':getBodyButton(_0x3de033)||_0x3de033['message']?.[_0x17c6de(0x28d)]?.['title'],'stickerMessage':_0x17c6de(0x14e),'contactMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x1fb)]?.[_0x17c6de(0x280)],'contactsArrayMessage':_0x3de033[_0x17c6de(0x1dd)]?.['contactsArrayMessage']?.[_0x17c6de(0x158)]&&contactsArrayMessageGet(_0x3de033),'locationMessage':msgLocation(_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x179)]?.['jpegThumbnail'],_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x179)]?.[_0x17c6de(0x271)],_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x179)]?.['degreesLongitude']),'liveLocationMessage':_0x17c6de(0x28f)+_0x3de033['message']?.[_0x17c6de(0x1ce)]?.[_0x17c6de(0x271)]+'\x20-\x20Longitude:\x20'+_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x1ce)]?.[_0x17c6de(0x152)],'documentMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x267)]?.[_0x17c6de(0x2db)],'audioMessage':_0x17c6de(0x193),'listMessage':getBodyList(_0x3de033)||_0x3de033[_0x17c6de(0x1dd)]?.['listResponseMessage']?.[_0x17c6de(0x273)],'viewOnceMessage':getBodyButton(_0x3de033),'reactionMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x19e)]?.[_0x17c6de(0x20c)]||'reaction','senderKeyDistributionMessage':_0x3de033?.['message']?.['senderKeyDistributionMessage']?.[_0x17c6de(0x1bd)],'documentWithCaptionMessage':_0x3de033[_0x17c6de(0x1dd)]?.['documentWithCaptionMessage']?.['message']?.[_0x17c6de(0x267)]?.['caption'],'viewOnceMessageV2':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x200)]?.[_0x17c6de(0x1dd)]?.['imageMessage']?.[_0x17c6de(0x2db)],'editedMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x2cc)]?.[_0x17c6de(0x1dd)]?.['extendedTextMessage']?.[_0x17c6de(0x20c)],'ephemeralMessage':_0x3de033[_0x17c6de(0x1dd)]?.['ephemeralMessage']?.[_0x17c6de(0x1dd)]?.[_0x17c6de(0x291)]?.['text']},_0x334b64=Object['keys'](_0x35ccbf)[_0x17c6de(0x24f)](_0x2306f7=>_0x2306f7===_0x2f0bb0);return!_0x334b64&&(logger_1['logger']['warn'](_0x17c6de(0x148)+_0x2f0bb0+'\x0a'+JSON['stringify'](_0x3de033)),Sentry[_0x17c6de(0x184)](_0x17c6de(0x2c1),{'BodyMsg':_0x3de033[_0x17c6de(0x1dd)],'msg':_0x3de033,'type':_0x2f0bb0}),Sentry[_0x17c6de(0x150)](new Error(_0x17c6de(0x20b)))),_0x35ccbf[_0x2f0bb0];}catch(_0x439977){Sentry[_0x17c6de(0x184)](_0x17c6de(0x17d),{'msg':_0x3de033,'BodyMsg':_0x3de033[_0x17c6de(0x1dd)]}),Sentry[_0x17c6de(0x150)](_0x439977),console[_0x17c6de(0x278)](_0x439977);}};exports[a615_0x5b5b25(0x2c4)]=getBodyMessage;const getQuotedMessage=_0x48c1db=>{const _0x4d0727=a615_0x5b5b25,_0x197469=(0x0,baileys_1[_0x4d0727(0x23d)])(_0x48c1db[_0x4d0727(0x1dd)])[Object[_0x4d0727(0x2d9)](_0x48c1db?.[_0x4d0727(0x1dd)])[_0x4d0727(0x1a2)]()[_0x4d0727(0x151)]()[_0x4d0727(0x2de)]];if(!_0x197469?.[_0x4d0727(0x17b)]?.['quotedMessage'])return;const _0x207aff=(0x0,baileys_1[_0x4d0727(0x23d)])(_0x197469?.[_0x4d0727(0x17b)]?.[_0x4d0727(0x283)][Object[_0x4d0727(0x2d9)](_0x197469?.[_0x4d0727(0x17b)]?.['quotedMessage'])[_0x4d0727(0x1a2)]()[_0x4d0727(0x151)]()['value']]);return _0x207aff;};exports[a615_0x5b5b25(0x17a)]=getQuotedMessage;function a615_0xc8bf(_0x4a1278,_0x1001f4){const _0x1f9f5f=a615_0x1f9f();return a615_0xc8bf=function(_0xc8bf99,_0x127432){_0xc8bf99=_0xc8bf99-0x146;let _0x444e70=_0x1f9f5f[_0xc8bf99];return _0x444e70;},a615_0xc8bf(_0x4a1278,_0x1001f4);}const getQuotedMessageId=_0x4a2f4e=>{const _0x595390=a615_0x5b5b25,_0x1c73d5=(0x0,baileys_1['extractMessageContent'])(_0x4a2f4e[_0x595390(0x1dd)])[Object[_0x595390(0x2d9)](_0x4a2f4e?.['message'])[_0x595390(0x1a2)]()[_0x595390(0x151)]()[_0x595390(0x2de)]];let _0x4f8d25=_0x4a2f4e?.[_0x595390(0x1dd)]?.[_0x595390(0x19e)]?_0x4a2f4e?.[_0x595390(0x1dd)]?.[_0x595390(0x19e)]?.[_0x595390(0x190)]?.['id']:'';return _0x4f8d25?_0x4f8d25:_0x1c73d5?.[_0x595390(0x17b)]?.['stanzaId'];};exports['getQuotedMessageId']=getQuotedMessageId;const getMeSocket=_0x19d060=>{const _0x54925a=a615_0x5b5b25;return{'id':(0x0,baileys_1[_0x54925a(0x221)])(_0x19d060[_0x54925a(0x2a2)]['id']),'name':_0x19d060['user'][_0x54925a(0x254)]};},getSenderMessage=(_0xc5b381,_0x151662)=>{const _0x5d6cd2=a615_0x5b5b25,_0x9a7591=getMeSocket(_0x151662);if(_0xc5b381[_0x5d6cd2(0x190)][_0x5d6cd2(0x27f)])return _0x9a7591['id'];const _0x37d470=_0xc5b381['participant']||_0xc5b381[_0x5d6cd2(0x190)][_0x5d6cd2(0x153)]||_0xc5b381[_0x5d6cd2(0x190)][_0x5d6cd2(0x241)]||undefined;return _0x37d470&&(0x0,baileys_1[_0x5d6cd2(0x221)])(_0x37d470);},getContactMessage=async(_0x7b3ee5,_0x55bbd2)=>{const _0x30fa5d=a615_0x5b5b25,_0x3bd7eb=_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x241)][_0x30fa5d(0x2dd)](_0x30fa5d(0x1c8)),_0xb1304d=_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x241)][_0x30fa5d(0x16d)](/\D/g,'');return _0x3bd7eb?{'id':getSenderMessage(_0x7b3ee5,_0x55bbd2),'name':_0x7b3ee5[_0x30fa5d(0x285)]}:{'id':_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x241)],'name':_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x27f)]?_0xb1304d:_0x7b3ee5[_0x30fa5d(0x285)]};},downloadMedia=async(_0x1a09af,_0x4b02e7=null)=>{const _0x21d8c8=a615_0x5b5b25;let _0x14e145;try{_0x14e145=await(0x0,baileys_1[_0x21d8c8(0x1b7)])(_0x1a09af,_0x21d8c8(0x2b4),{});}catch(_0x7418a4){_0x4b02e7?console[_0x21d8c8(0x278)](_0x21d8c8(0x14d)):console[_0x21d8c8(0x1a6)](_0x21d8c8(0x1cf),_0x7418a4);}let _0x521aa1=_0x1a09af['message']?.['documentMessage']?.['fileName']||'';const _0x207d0c=_0x1a09af[_0x21d8c8(0x1dd)]?.['imageMessage']||_0x1a09af[_0x21d8c8(0x1dd)]?.['audioMessage']||_0x1a09af[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x22f)]||_0x1a09af[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x1b9)]||_0x1a09af['message']?.[_0x21d8c8(0x267)]||_0x1a09af[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x28c)]?.[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x267)]||_0x1a09af['message']?.[_0x21d8c8(0x291)]?.[_0x21d8c8(0x17b)]?.[_0x21d8c8(0x283)]?.[_0x21d8c8(0x18f)]||_0x1a09af[_0x21d8c8(0x1dd)]?.['extendedTextMessage']?.[_0x21d8c8(0x17b)]?.['quotedMessage']?.[_0x21d8c8(0x22f)];if(!_0x207d0c)console[_0x21d8c8(0x278)](_0x1a09af);if(!_0x521aa1){const _0x592e92=_0x207d0c[_0x21d8c8(0x191)][_0x21d8c8(0x154)]('/')[0x1][_0x21d8c8(0x154)](';')[0x0];_0x521aa1=new Date()[_0x21d8c8(0x2d4)]()+'.'+_0x592e92;}else _0x521aa1=new Date()['getTime']()+'_'+_0x521aa1;const _0x492e21={'data':_0x14e145,'mimetype':_0x207d0c['mimetype'],'filename':_0x521aa1};return _0x492e21;},verifyContact=async(_0x15c17a,_0x4fc105,_0x139144)=>{const _0x444a10=a615_0x5b5b25;let _0x316a6d;try{_0x316a6d=await _0x4fc105[_0x444a10(0x27e)](_0x15c17a['id'],_0x444a10(0x274));}catch(_0x570a6d){Sentry[_0x444a10(0x150)](_0x570a6d),_0x316a6d=process[_0x444a10(0x1ea)][_0x444a10(0x265)]+_0x444a10(0x1e4);}const _0x9b3741={'name':_0x15c17a[_0x444a10(0x254)]||_0x15c17a['id'][_0x444a10(0x16d)](/\D/g,''),'number':_0x15c17a['id'][_0x444a10(0x16d)](/\D/g,''),'profilePicUrl':_0x316a6d,'isGroup':_0x15c17a['id'][_0x444a10(0x2dd)]('g.us'),'companyId':_0x139144,'remoteJid':_0x15c17a['id']};_0x9b3741['isGroup']&&(_0x9b3741[_0x444a10(0x194)]=_0x15c17a['id'][_0x444a10(0x16d)]('@g.us',''));const _0x36cceb=await(0x0,CreateOrUpdateContactService_1[_0x444a10(0x270)])(_0x9b3741);return _0x36cceb;},verifyQuotedMessage=async _0x275352=>{const _0x5baf51=a615_0x5b5b25;if(!_0x275352)return null;const _0x244a55=(0x0,exports['getQuotedMessageId'])(_0x275352);if(!_0x244a55)return null;const _0x4032a3=await Message_1['default'][_0x5baf51(0x1b2)]({'where':{'wid':_0x244a55}});if(!_0x4032a3)return null;return _0x4032a3;},verifyMediaMessage=async(_0x16cdce,_0x195770,_0x328e49,_0x54d8a7,_0x3dc8d7)=>{const _0x29f17c=a615_0x5b5b25,_0x28c0e0=(0x0,socket_1['getIO'])(),_0x32485e=await verifyQuotedMessage(_0x16cdce),_0x341c1d=_0x195770['companyId'];try{const _0x31b96a=await downloadMedia(_0x16cdce,_0x195770?.[_0x29f17c(0x1d4)]);if(!_0x31b96a&&_0x195770['imported']){const _0x51460b=_0x29f17c(0x21c),_0x289e93={'wid':_0x16cdce[_0x29f17c(0x190)]['id'],'ticketId':_0x195770['id'],'contactId':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x27f)]?undefined:_0x195770[_0x29f17c(0x15e)],'body':_0x51460b,'reactionMessage':_0x16cdce['message']?.['reactionMessage'],'fromMe':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x27f)],'mediaType':getTypeMessage(_0x16cdce),'read':_0x16cdce[_0x29f17c(0x190)]['fromMe'],'quotedMsgId':_0x32485e?.['id']||_0x16cdce[_0x29f17c(0x1dd)]?.[_0x29f17c(0x19e)]?.[_0x29f17c(0x190)]?.['id'],'ack':_0x16cdce[_0x29f17c(0x1ae)],'companyId':_0x341c1d,'remoteJid':_0x16cdce[_0x29f17c(0x190)]['remoteJid'],'participant':_0x16cdce[_0x29f17c(0x190)]['participant'],'timestamp':getTimestampMessage(_0x16cdce['messageTimestamp']),'createdAt':new Date(Math[_0x29f17c(0x28a)](getTimestampMessage(_0x16cdce[_0x29f17c(0x14b)])*0x3e8))[_0x29f17c(0x1d2)](),'dataJson':JSON[_0x29f17c(0x263)](_0x16cdce),'ticketImported':_0x195770['imported'],'isForwarded':_0x3dc8d7};return await _0x195770[_0x29f17c(0x204)]({'lastMessage':_0x51460b}),logger_1[_0x29f17c(0x171)][_0x29f17c(0x1a6)](Error(_0x29f17c(0x276))),(0x0,CreateMessageService_1[_0x29f17c(0x270)])({'messageData':_0x289e93,'companyId':_0x341c1d});}if(!_0x31b96a)throw new Error(_0x29f17c(0x276));if(!_0x31b96a[_0x29f17c(0x181)]){const _0x395b72=_0x31b96a[_0x29f17c(0x191)][_0x29f17c(0x154)]('/')[0x1][_0x29f17c(0x154)](';')[0x0];_0x31b96a[_0x29f17c(0x181)]=new Date()[_0x29f17c(0x2d4)]()+'.'+_0x395b72;}else{const _0x4a3b56=_0x31b96a[_0x29f17c(0x181)][_0x29f17c(0x154)]('.')[_0x29f17c(0x163)](),_0xe16dfd=_0x31b96a['filename'][_0x29f17c(0x154)]('.')['slice'](0x0,-0x1)[_0x29f17c(0x178)]('.')[_0x29f17c(0x16d)](/\s/g,'_')[_0x29f17c(0x1c0)](_0x29f17c(0x159))[_0x29f17c(0x16d)](/[\u0300-\u036f]/g,'');_0x31b96a[_0x29f17c(0x181)]=_0xe16dfd[_0x29f17c(0x2da)]()+'_'+new Date()[_0x29f17c(0x2d4)]()+'.'+_0x4a3b56;}try{const _0x1d40d6=path_1[_0x29f17c(0x270)][_0x29f17c(0x2a7)](__dirname,'..','..','..',_0x29f17c(0x1a1),_0x29f17c(0x196)+_0x341c1d);!fs_2[_0x29f17c(0x270)][_0x29f17c(0x1af)](_0x1d40d6)&&(fs_2['default'][_0x29f17c(0x279)](_0x1d40d6,{'recursive':!![]}),fs_2[_0x29f17c(0x270)][_0x29f17c(0x2d1)](_0x1d40d6,0x1ff)),await writeFileAsync((0x0,path_1['join'])(_0x1d40d6,_0x31b96a['filename']),_0x31b96a[_0x29f17c(0x28e)]['toString'](_0x29f17c(0x1ac)),_0x29f17c(0x1ac))[_0x29f17c(0x2a3)](()=>{const _0x3c83dd=_0x29f17c;console['log'](_0x31b96a[_0x3c83dd(0x191)]),console[_0x3c83dd(0x278)]('Arquivo\x20salvo\x20com\x20sucesso!');if(_0x31b96a[_0x3c83dd(0x191)][_0x3c83dd(0x2dd)](_0x3c83dd(0x1cc))){const _0x281e90=path_1[_0x3c83dd(0x270)]['join'](_0x1d40d6,_0x31b96a[_0x3c83dd(0x181)]);let _0x459f2f;if(_0x281e90[_0x3c83dd(0x2c3)](_0x3c83dd(0x2b9)))_0x459f2f=_0x281e90['replace'](_0x3c83dd(0x2b9),_0x3c83dd(0x2ab));else{if(_0x281e90['endsWith']('.ogg'))_0x459f2f=_0x281e90[_0x3c83dd(0x16d)](_0x3c83dd(0x2be),_0x3c83dd(0x2ab));else{console[_0x3c83dd(0x1a6)](_0x3c83dd(0x211),_0x281e90);return;}}return console[_0x3c83dd(0x278)]('Input\x20File:',_0x281e90),console[_0x3c83dd(0x278)](_0x3c83dd(0x2b8),_0x459f2f),new Promise((_0x5d2387,_0x70b4d0)=>{const _0x44a08b=_0x3c83dd;(0x0,fluent_ffmpeg_1[_0x44a08b(0x270)])(_0x281e90)['toFormat'](_0x44a08b(0x1f0))['save'](_0x459f2f)['on'](_0x44a08b(0x2b3),()=>{_0x5d2387();})['on'](_0x44a08b(0x1a6),_0x3c828c=>{_0x70b4d0(_0x3c828c);});});}})['then'](()=>{console['log']('Conversão\x20concluída!');});}catch(_0x28f93a){Sentry[_0x29f17c(0x184)](_0x29f17c(0x248),{'companyId':_0x341c1d,'ticket':_0x195770,'contact':_0x328e49,'media':_0x31b96a,'quotedMsg':_0x32485e}),Sentry[_0x29f17c(0x150)](_0x28f93a),logger_1[_0x29f17c(0x171)][_0x29f17c(0x1a6)](_0x28f93a),console['log'](_0x16cdce);}const _0x1bea2b=(0x0,exports['getBodyMessage'])(_0x16cdce),_0x351fb6={'wid':_0x16cdce['key']['id'],'ticketId':_0x195770['id'],'contactId':_0x16cdce['key']['fromMe']?undefined:_0x328e49['id'],'body':_0x1bea2b||_0x31b96a[_0x29f17c(0x181)],'fromMe':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x27f)],'read':_0x16cdce['key'][_0x29f17c(0x27f)],'mediaUrl':_0x31b96a['filename'],'mediaType':_0x31b96a[_0x29f17c(0x191)][_0x29f17c(0x154)]('/')[0x0],'quotedMsgId':_0x32485e?.['id'],'ack':_0x16cdce['status'],'remoteJid':_0x16cdce[_0x29f17c(0x190)]['remoteJid'],'participant':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x153)],'dataJson':JSON['stringify'](_0x16cdce),'ticketTrakingId':_0x54d8a7?.['id'],'createdAt':new Date(Math['floor'](getTimestampMessage(_0x16cdce[_0x29f17c(0x14b)])*0x3e8))[_0x29f17c(0x1d2)](),'ticketImported':_0x195770[_0x29f17c(0x1d4)],'isForwarded':_0x3dc8d7};await _0x195770['update']({'lastMessage':_0x1bea2b||_0x31b96a[_0x29f17c(0x181)]});const _0xeb1942=await(0x0,CreateMessageService_1['default'])({'messageData':_0x351fb6,'companyId':_0x341c1d});return!_0x16cdce[_0x29f17c(0x190)]['fromMe']&&_0x195770[_0x29f17c(0x1ae)]===_0x29f17c(0x1cb)&&(await _0x195770[_0x29f17c(0x204)]({'status':_0x29f17c(0x29d)}),await _0x195770[_0x29f17c(0x2b7)]({'include':[{'model':Queue_1[_0x29f17c(0x270)],'as':_0x29f17c(0x185)},{'model':User_1['default'],'as':'user'},{'model':Contact_1[_0x29f17c(0x270)],'as':_0x29f17c(0x212)},{'model':Whatsapp_1['default'],'as':_0x29f17c(0x22b)}]}),_0x28c0e0['to'](_0x29f17c(0x1cb))[_0x29f17c(0x214)]('company-'+_0x341c1d+_0x29f17c(0x2a8),{'action':_0x29f17c(0x227),'ticket':_0x195770,'ticketId':_0x195770['id']}),_0x28c0e0['to'](_0x195770[_0x29f17c(0x1ae)])['to'](_0x195770['id'][_0x29f17c(0x2c9)]())[_0x29f17c(0x214)](_0x29f17c(0x1b6)+_0x341c1d+_0x29f17c(0x2a8),{'action':_0x29f17c(0x204),'ticket':_0x195770,'ticketId':_0x195770['id']})),_0xeb1942;}catch(_0x4494b2){console[_0x29f17c(0x278)](_0x4494b2),logger_1[_0x29f17c(0x171)][_0x29f17c(0x1ed)]('Erro\x20ao\x20baixar\x20media');}};exports[a615_0x5b5b25(0x149)]=verifyMediaMessage;const verifyMessage=async(_0x26d5f6,_0x5f19eb,_0x3e3755,_0x3987e,_0x3331ee,_0xa363d7)=>{const _0x4a66c4=a615_0x5b5b25,_0xf40fdf=(0x0,socket_1[_0x4a66c4(0x2d0)])(),_0xe198c1=await verifyQuotedMessage(_0x26d5f6),_0x7b8797=(0x0,exports['getBodyMessage'])(_0x26d5f6),_0x2d0162=_0x5f19eb[_0x4a66c4(0x2df)],_0x2ebed1={'wid':_0x26d5f6[_0x4a66c4(0x190)]['id'],'ticketId':_0x5f19eb['id'],'contactId':_0x26d5f6[_0x4a66c4(0x190)]['fromMe']?undefined:_0x3e3755['id'],'body':_0x7b8797,'fromMe':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x27f)],'mediaType':getTypeMessage(_0x26d5f6),'read':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x27f)],'quotedMsgId':_0xe198c1?.['id'],'ack':_0x26d5f6[_0x4a66c4(0x1ae)],'remoteJid':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x241)],'participant':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x153)],'dataJson':JSON[_0x4a66c4(0x263)](_0x26d5f6),'ticketTrakingId':_0x3987e?.['id'],'isPrivate':![],'createdAt':new Date(Math[_0x4a66c4(0x28a)](getTimestampMessage(_0x26d5f6['messageTimestamp'])*0x3e8))[_0x4a66c4(0x1d2)](),'ticketImported':_0x5f19eb[_0x4a66c4(0x1d4)],'isForwarded':_0xa363d7};await _0x5f19eb[_0x4a66c4(0x204)]({'lastMessage':_0x7b8797}),await(0x0,CreateMessageService_1['default'])({'messageData':_0x2ebed1,'companyId':_0x2d0162}),!_0x26d5f6['key'][_0x4a66c4(0x27f)]&&_0x5f19eb[_0x4a66c4(0x1ae)]==='closed'&&(await _0x5f19eb['update']({'status':_0x4a66c4(0x29d)}),await _0x5f19eb[_0x4a66c4(0x2b7)]({'include':[{'model':Queue_1['default'],'as':_0x4a66c4(0x185)},{'model':User_1[_0x4a66c4(0x270)],'as':'user'},{'model':Contact_1[_0x4a66c4(0x270)],'as':_0x4a66c4(0x212)},{'model':Whatsapp_1['default'],'as':_0x4a66c4(0x22b)}]}),!_0x5f19eb[_0x4a66c4(0x1d4)]&&_0xf40fdf['to'](_0x5f19eb[_0x4a66c4(0x1ae)])['to'](_0x5f19eb['id'][_0x4a66c4(0x2c9)]())[_0x4a66c4(0x214)](_0x4a66c4(0x1b6)+_0x2d0162+_0x4a66c4(0x2a8),{'action':_0x4a66c4(0x204),'ticket':_0x5f19eb,'ticketId':_0x5f19eb['id']}));};exports[a615_0x5b5b25(0x281)]=verifyMessage;const isValidMsg=_0x49d0c6=>{const _0x51dcf1=a615_0x5b5b25;if(_0x49d0c6[_0x51dcf1(0x190)][_0x51dcf1(0x241)]===_0x51dcf1(0x25e))return![];try{const _0xb30001=getTypeMessage(_0x49d0c6);if(!_0xb30001)return;const _0x2b6b76=_0xb30001===_0x51dcf1(0x169)||_0xb30001===_0x51dcf1(0x291)||_0xb30001===_0x51dcf1(0x2a5)||_0xb30001===_0x51dcf1(0x22f)||_0xb30001==='imageMessage'||_0xb30001===_0x51dcf1(0x267)||_0xb30001===_0x51dcf1(0x1b9)||_0xb30001===_0x51dcf1(0x26f)||_0xb30001===_0x51dcf1(0x203)||_0xb30001===_0x51dcf1(0x223)||_0xb30001===_0x51dcf1(0x179)||_0xb30001==='liveLocationMessage'||_0xb30001===_0x51dcf1(0x1fb)||_0xb30001==='voiceMessage'||_0xb30001===_0x51dcf1(0x1e8)||_0xb30001===_0x51dcf1(0x162)||_0xb30001==='reactionMessage'||_0xb30001===_0x51dcf1(0x168)||_0xb30001==='protocolMessage'||_0xb30001==='listResponseMessage'||_0xb30001===_0x51dcf1(0x18a)||_0xb30001===_0x51dcf1(0x2c7)||_0xb30001===_0x51dcf1(0x28c)||_0xb30001===_0x51dcf1(0x200)||_0xb30001===_0x51dcf1(0x2cc);return!_0x2b6b76&&(logger_1[_0x51dcf1(0x171)][_0x51dcf1(0x1ed)](_0x51dcf1(0x1e1)+_0xb30001+'\x0a'+JSON['stringify'](_0x49d0c6?.['message'])),Sentry[_0x51dcf1(0x184)](_0x51dcf1(0x2c1),{'BodyMsg':_0x49d0c6['message'],'msg':_0x49d0c6,'msgType':_0xb30001}),Sentry[_0x51dcf1(0x150)](new Error(_0x51dcf1(0x26c)))),!!_0x2b6b76;}catch(_0x5c93d5){Sentry[_0x51dcf1(0x184)]('Error\x20isValidMsg',{'msg':_0x49d0c6}),Sentry[_0x51dcf1(0x150)](_0x5c93d5);}};exports[a615_0x5b5b25(0x21d)]=isValidMsg;const sendDialogflowAwswer=async(_0x32716c,_0x409f13,_0x221e05,_0x32314f,_0x1784a7,_0xc09621,_0x30626f)=>{const _0xa5656e=a615_0x5b5b25,_0x202727=await(0x0,CreateSessionDialogflow_1['createDialogflowSessionWithModel'])(_0x30626f);if(_0x202727===undefined)return;_0x32716c[_0xa5656e(0x224)](_0x32314f['remoteJid']),await(0x0,baileys_1['delay'])(0x1f4);let _0x3fff19=await(0x0,QueryDialogflow_1[_0xa5656e(0x1ab)])(_0x202727,_0x30626f[_0xa5656e(0x1c6)],_0x32314f[_0xa5656e(0x241)],(0x0,exports[_0xa5656e(0x2c4)])(_0x221e05),_0x30626f['language'],_0x1784a7);if(!_0x3fff19){_0x32716c[_0xa5656e(0x259)](_0xa5656e(0x250),_0x32314f['remoteJid']);const _0x442aab=(0x0,Mustache_1[_0xa5656e(0x270)])(_0xa5656e(0x1ef)+_0x30626f?.[_0xa5656e(0x254)]+_0xa5656e(0x1fd));await(0x0,baileys_1[_0xa5656e(0x1e9)])(0x3e8),await _0x32716c[_0xa5656e(0x259)](_0xa5656e(0x14f),_0x32314f['remoteJid']);const _0xfb0cb=await _0x32716c[_0xa5656e(0x20f)](_0x32314f[_0xa5656e(0x194)]+_0xa5656e(0x1f6),{'text':_0x442aab});await(0x0,exports[_0xa5656e(0x281)])(_0xfb0cb,_0x409f13,_0x32314f);return;}_0x3fff19[_0xa5656e(0x277)]&&await _0x409f13[_0xa5656e(0x204)]({'contactId':_0x409f13[_0xa5656e(0x212)]['id'][_0xa5656e(0x2c9)](),'useIntegration':![]});const _0x59ba6a=_0x3fff19[_0xa5656e(0x299)][_0xa5656e(0x274)]?.['stringValue']??undefined,_0x2996cb=_0x3fff19['parameters'][_0xa5656e(0x15c)]?.[_0xa5656e(0x1f9)]??undefined,_0x58bc29=_0x3fff19[_0xa5656e(0x2d6)]['toString']('base64')??undefined;_0x32716c[_0xa5656e(0x259)](_0xa5656e(0x250),_0x32314f[_0xa5656e(0x241)]),await(0x0,baileys_1[_0xa5656e(0x1e9)])(0x1f4);let _0x25b07c;for(let _0x13e7c2 of _0x3fff19['responses']){_0x25b07c=_0x13e7c2[_0xa5656e(0x20c)][_0xa5656e(0x20c)][0x0]?_0x13e7c2['text'][_0xa5656e(0x20c)][0x0]:_0x25b07c;}for(let _0xd7762f of _0x3fff19[_0xa5656e(0x207)]){_0xd7762f[_0xa5656e(0x20c)]&&await sendDelayedMessages(_0x32716c,_0x409f13,_0x32314f,_0xd7762f[_0xa5656e(0x20c)][_0xa5656e(0x20c)][0x0],_0x25b07c,_0x58bc29,_0x30626f);}};async function sendDelayedMessages(_0x5aceb4,_0x396ef0,_0x25d434,_0x54ad57,_0x39ca17,_0xa47a8d,_0x28540b){const _0x31a11f=a615_0x5b5b25,_0x12a0bb=_0x396ef0['companyId'],_0xe72dab=await(0x0,ShowWhatsAppService_1[_0x31a11f(0x270)])(_0x5aceb4['id'],_0x12a0bb),_0x1ca4d9=_0xe72dab[_0x31a11f(0x15d)][_0x31a11f(0x16d)](/[_*]/g,''),_0x4f8de9=await _0x5aceb4[_0x31a11f(0x20f)](_0x25d434[_0x31a11f(0x194)]+_0x31a11f(0x1f6),{'text':_0x31a11f(0x1ef)+_0x28540b?.['name']+_0x31a11f(0x24d)+_0x54ad57});await(0x0,exports[_0x31a11f(0x281)])(_0x4f8de9,_0x396ef0,_0x25d434);if(_0x54ad57!=_0x39ca17)await(0x0,baileys_1[_0x31a11f(0x1e9)])(0x1f4),_0x5aceb4[_0x31a11f(0x259)](_0x31a11f(0x250),_0x25d434[_0x31a11f(0x241)]);else _0xa47a8d&&(_0x5aceb4[_0x31a11f(0x259)](_0x31a11f(0x251),_0x25d434[_0x31a11f(0x241)]),await(0x0,baileys_1[_0x31a11f(0x1e9)])(0x1f4),_0x1ca4d9&&_0x54ad57[_0x31a11f(0x2dd)](_0x1ca4d9)&&(await(0x0,baileys_1[_0x31a11f(0x1e9)])(0x2710),setTimeout(async()=>{const _0x18ccb6=_0x31a11f;await _0x396ef0['update']({'contactId':_0x396ef0[_0x18ccb6(0x212)]['id']['toString'](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1[_0x18ccb6(0x270)])({'ticketId':_0x396ef0['id'],'ticketData':{'status':'closed'},'companyId':_0x12a0bb});},0xbb8)));}const verifyQueue=async(_0x1a0426,_0x2d9da4,_0x11f676,_0x118a38,_0x328f17,_0x175837)=>{const _0x551899=a615_0x5b5b25,_0x374727=_0x11f676[_0x551899(0x2df)],{queues:_0x106cf3,greetingMessage:_0x42b3d7,maxUseBotQueues:_0x7e1a1a,timeUseBotQueues:_0x2945f6}=await(0x0,ShowWhatsAppService_1[_0x551899(0x270)])(_0x1a0426['id'],_0x374727);let _0xe164a7=![];_0x106cf3[_0x551899(0x18c)]===0x1&&(_0xe164a7=_0x106cf3[0x0]?.[_0x551899(0x1ec)][_0x551899(0x18c)]>0x1);const _0x806a25=_0x328f17['sendQueuePosition']===_0x551899(0x213);if(_0x106cf3[_0x551899(0x18c)]===0x1&&!_0xe164a7){const _0x273e07=_0x328f17['sendGreetingMessageOneQueues']===_0x551899(0x213)||![];if(!_0x2d9da4[_0x551899(0x190)]['fromMe']&&!_0x11f676[_0x551899(0x222)]&&_0x106cf3[0x0][_0x551899(0x293)]){const _0x1e5f01=await(0x0,ShowQueueIntegrationService_1[_0x551899(0x270)])(_0x11f676[_0x551899(0x293)],_0x374727);await(0x0,exports[_0x551899(0x2a9)])(_0x2d9da4,_0x1a0426,_0x374727,_0x1e5f01,_0x11f676),await _0x11f676[_0x551899(0x204)]({'useIntegration':!![],'integrationId':_0x1e5f01['id']});}if(_0x42b3d7['length']>0x1&&_0x273e07){const _0x472d08=(0x0,Mustache_1['default'])(''+_0x42b3d7,_0x11f676);if(_0x11f676[_0x551899(0x22b)]['greetingMediaAttachment']!==null){const _0xa55106=path_1[_0x551899(0x270)][_0x551899(0x2a7)](_0x551899(0x1a1),_0x551899(0x196)+_0x374727,_0x11f676[_0x551899(0x22b)][_0x551899(0x1be)]),_0x2c023f=_0x11f676['whatsapp'][_0x551899(0x1be)],_0x62e49d=await(0x0,SendWhatsAppMedia_1[_0x551899(0x2ca)])(_0x2c023f,_0xa55106,String(_0x374727),_0x472d08),_0x4a09cb=(0x0,Debounce_1['debounce'])(async()=>{const _0x566e62=_0x551899,_0x4554de=await _0x1a0426['sendMessage'](_0x11f676[_0x566e62(0x212)][_0x566e62(0x194)]+'@'+(_0x11f676[_0x566e62(0x222)]?'g.us':_0x566e62(0x239)),{..._0x62e49d});await(0x0,exports[_0x566e62(0x149)])(_0x4554de,_0x11f676,_0x118a38,_0x175837);},0x3e8,_0x11f676['id']);_0x4a09cb();}else await _0x1a0426['sendMessage'](_0x118a38[_0x551899(0x194)]+'@'+(_0x11f676[_0x551899(0x222)]?'g.us':_0x551899(0x239)),{'text':_0x472d08});}if(!(0x0,lodash_1[_0x551899(0x218)])(_0x106cf3[0x0][_0x551899(0x282)]))try{const _0x5cdccf=path_1[_0x551899(0x270)][_0x551899(0x2a7)](__dirname,'..','..','..',_0x551899(0x1a1)),_0x396435=await(0x0,ShowService_1['default'])(_0x106cf3[0x0][_0x551899(0x282)],_0x11f676['companyId']),_0x4384bf=path_1['default'][_0x551899(0x2a7)](_0x5cdccf,_0x551899(0x196)+_0x11f676[_0x551899(0x2df)],_0x551899(0x1d1),String(_0x396435['id']));for(const [_0x40d609,_0x563957]of _0x396435[_0x551899(0x2d7)][_0x551899(0x2aa)]()){const _0x4d5883={'fieldname':'medias','originalname':_0x563957['path'],'encoding':_0x551899(0x1d8),'mimetype':_0x563957['mediaType'],'filename':_0x563957['path'],'path':path_1['default'][_0x551899(0x2a7)](_0x4384bf,_0x563957[_0x551899(0x2af)])};await(0x0,SendWhatsAppMedia_1[_0x551899(0x270)])({'media':_0x4d5883,'ticket':_0x11f676,'body':_0x563957[_0x551899(0x254)],'isPrivate':![],'isForwarded':![]});};}catch(_0x2df1e0){logger_1['logger'][_0x551899(0x269)](_0x2df1e0);}if(_0x106cf3[0x0][_0x551899(0x243)]){await(0x0,UpdateTicketService_1[_0x551899(0x270)])({'ticketData':{'status':_0x551899(0x1cb),'queueId':_0x106cf3[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x11f676['id'],'companyId':_0x374727});return;}else await(0x0,UpdateTicketService_1[_0x551899(0x270)])({'ticketData':{'queueId':_0x106cf3[0x0]['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});const _0x219d39=await Ticket_1[_0x551899(0x270)][_0x551899(0x14a)]({'where':{'userId':null,'status':_0x551899(0x29d),'companyId':_0x374727,'queueId':_0x106cf3[0x0]['id'],'isGroup':![]}});if(_0x806a25){const _0x518762=_0x219d39[_0x551899(0x2c6)]===0x0?0x1:_0x219d39['count'],_0x1edcd8=_0x551899(0x240)+_0x518762+'*',_0x5afa9a=(0x0,Mustache_1[_0x551899(0x270)])(''+_0x1edcd8,_0x11f676),_0x4d1450=(0x0,Debounce_1[_0x551899(0x202)])(async()=>{const _0x3c4936=_0x551899;await _0x1a0426[_0x3c4936(0x20f)](_0x118a38[_0x3c4936(0x194)]+'@'+(_0x11f676[_0x3c4936(0x222)]?_0x3c4936(0x1c8):_0x3c4936(0x239)),{'text':_0x5afa9a});},0xbb8,_0x11f676['id']);_0x4d1450();}return;}if(_0x118a38['disableBot'])return;let _0x3f8fe8='';if(_0x11f676[_0x551899(0x1ae)]!=='lgpd')_0x3f8fe8=_0x2d9da4?.[_0x551899(0x1dd)]?.[_0x551899(0x26f)]?.[_0x551899(0x189)]||_0x2d9da4?.[_0x551899(0x1dd)]?.[_0x551899(0x28d)]?.['singleSelectReply']['selectedRowId']||(0x0,exports['getBodyMessage'])(_0x2d9da4);else{if(!(0x0,lodash_1[_0x551899(0x218)])(_0x11f676[_0x551899(0x262)]))await _0x11f676[_0x551899(0x204)]({'status':_0x551899(0x29d)});await _0x11f676[_0x551899(0x2b7)]();}if(_0x3f8fe8[_0x551899(0x234)]()==_0x551899(0x20e)){const _0xf9f6cc={'isBot':![],'status':_0x551899(0x1cb),'sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x551899(0x270)])({'ticketData':_0xf9f6cc,'ticketId':_0x11f676['id'],'companyId':_0x374727});return;}const _0x111532=_0xe164a7&&_0x106cf3['length']===0x1?_0x106cf3[+_0x3f8fe8]:_0x106cf3[+_0x3f8fe8-0x1];if(!_0x2d9da4['key'][_0x551899(0x27f)]&&!_0x11f676['isGroup']&&_0x111532?.[_0x551899(0x293)]){const _0x22c850=await(0x0,ShowQueueIntegrationService_1[_0x551899(0x270)])(_0x111532['integrationId'],_0x374727);await(0x0,exports[_0x551899(0x2a9)])(_0x2d9da4,_0x1a0426,_0x374727,_0x22c850,_0x11f676),await _0x11f676[_0x551899(0x204)]({'useIntegration':!![],'integrationId':_0x22c850['id']});}const _0x2a6563=_0x328f17?.[_0x551899(0x157)]||_0x551899(0x20c);let _0x301968;if(_0x111532)try{const _0x400321=await(0x0,ListUserQueueServices_1[_0x551899(0x270)])(_0x111532['id']);_0x400321[_0x551899(0x261)]>-0x1&&(_0x301968=_0x400321[_0x551899(0x261)]);}catch(_0x7a7fd6){console['error'](_0x7a7fd6);}const _0x41c5f2=async()=>{const _0x809ef3=_0x551899;if(_0x111532||_0x106cf3['length']===0x1&&_0xe164a7){const _0x44017a=await Queue_1['default']['findByPk'](_0x111532['id']);let _0x4e3f67;_0x328f17?.[_0x809ef3(0x1f7)]==='queue'&&(_0x4e3f67=await(0x0,VerifyCurrentSchedule_1[_0x809ef3(0x270)])(_0x374727,_0x44017a['id'],0x0));if(_0x328f17?.[_0x809ef3(0x1f7)]==='queue'&&!(0x0,lodash_1[_0x809ef3(0x218)])(_0x4e3f67)&&(!_0x4e3f67||_0x4e3f67[_0x809ef3(0x29c)]===![])&&(!_0x11f676['isGroup']||_0x11f676[_0x809ef3(0x22b)]?.[_0x809ef3(0x2e1)]==='enabled')){const _0x5898bc=_0x44017a[_0x809ef3(0x297)];if(_0x5898bc!==''){const _0x44d2dc=(0x0,Mustache_1[_0x809ef3(0x270)])(''+_0x5898bc,_0x11f676),_0x360fc6=(0x0,Debounce_1['debounce'])(async()=>{const _0x5cd109=_0x809ef3;await _0x1a0426[_0x5cd109(0x20f)](_0x11f676['contact'][_0x5cd109(0x194)]+'@'+(_0x11f676['isGroup']?'g.us':'s.whatsapp.net'),{'text':_0x44d2dc});},0x3e8,_0x11f676['id']);_0x360fc6(),await _0x11f676[_0x809ef3(0x204)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1});return;}await _0x11f676['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1});return;}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x111532['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});if(_0x111532[_0x809ef3(0x1ec)][_0x809ef3(0x18c)]>0x0&&!_0x11f676[_0x809ef3(0x222)]){let _0x3feee7='';_0x111532[_0x809ef3(0x1ec)][_0x809ef3(0x170)]((_0x4f7686,_0x5ef4f7)=>{const _0x23cc53=_0x809ef3;_0x3feee7+=_0x23cc53(0x1f4)+(_0x5ef4f7+0x1)+_0x23cc53(0x268)+_0x4f7686['name']+'\x0a';});const _0x2c49b3=(0x0,Mustache_1['default'])('‎'+_0x111532['greetingMessage']+'\x0a\x0a'+_0x3feee7+_0x809ef3(0x1c9),_0x11f676),_0x4c5873=await _0x1a0426['sendMessage'](_0x118a38[_0x809ef3(0x194)]+'@'+(_0x11f676[_0x809ef3(0x222)]?'g.us':_0x809ef3(0x239)),{'text':_0x2c49b3});await(0x0,exports['verifyMessage'])(_0x4c5873,_0x11f676,_0x118a38,_0x175837),_0x328f17?.[_0x809ef3(0x210)]==='enabled'&&await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'userId':_0x301968},'ticketId':_0x11f676['id'],'companyId':_0x374727});}if(!_0x111532[_0x809ef3(0x1ec)][_0x809ef3(0x18c)]&&_0x111532[_0x809ef3(0x29a)][_0x809ef3(0x18c)]!==0x0){const _0x4dd8c5=(0x0,Mustache_1['default'])('‎'+_0x111532['greetingMessage'],_0x11f676),_0x2d7ed5=await _0x1a0426[_0x809ef3(0x20f)](_0x118a38[_0x809ef3(0x194)]+'@'+(_0x11f676['isGroup']?'g.us':_0x809ef3(0x239)),{'text':_0x4dd8c5});await(0x0,exports['verifyMessage'])(_0x2d7ed5,_0x11f676,_0x118a38,_0x175837);}if(!(0x0,lodash_1['isNil'])(_0x111532['fileListId']))try{const _0x4c4c4d=path_1[_0x809ef3(0x270)][_0x809ef3(0x2a7)](__dirname,'..','..','..',_0x809ef3(0x1a1)),_0x2b4c51=await(0x0,ShowService_1[_0x809ef3(0x270)])(_0x111532[_0x809ef3(0x282)],_0x11f676[_0x809ef3(0x2df)]),_0x24acfa=path_1[_0x809ef3(0x270)][_0x809ef3(0x2a7)](_0x4c4c4d,'company'+_0x11f676[_0x809ef3(0x2df)],'fileList',String(_0x2b4c51['id']));for(const [_0x5ae410,_0x3f6c03]of _0x2b4c51[_0x809ef3(0x2d7)][_0x809ef3(0x2aa)]()){const _0x565cd6={'fieldname':_0x809ef3(0x1da),'originalname':_0x3f6c03[_0x809ef3(0x2af)],'encoding':_0x809ef3(0x1d8),'mimetype':_0x3f6c03[_0x809ef3(0x174)],'filename':_0x3f6c03[_0x809ef3(0x2af)],'path':path_1[_0x809ef3(0x270)][_0x809ef3(0x2a7)](_0x24acfa,_0x3f6c03['path'])};await(0x0,SendWhatsAppMedia_1[_0x809ef3(0x270)])({'media':_0x565cd6,'ticket':_0x11f676,'body':_0x3f6c03[_0x809ef3(0x254)],'isPrivate':![],'isForwarded':![]});};await(0x0,baileys_1[_0x809ef3(0x1e9)])(0x7d0);}catch(_0x4ac980){logger_1[_0x809ef3(0x171)][_0x809ef3(0x269)](_0x4ac980);}if(_0x111532['closeTicket']){await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'status':_0x809ef3(0x1cb),'queueId':_0x111532['id'],'sendFarewellMessage':![]},'ticketId':_0x11f676['id'],'companyId':_0x374727}),await(0x0,CreateLogTicketService_1[_0x809ef3(0x270)])({'ticketId':_0x11f676['id'],'type':_0x809ef3(0x1cb),'queueId':_0x111532['id']});return;}const _0x150338=await Ticket_1[_0x809ef3(0x270)][_0x809ef3(0x14a)]({'where':{'userId':null,'status':'pending','companyId':_0x374727,'queueId':_0x111532['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1[_0x809ef3(0x270)])({'ticketId':_0x11f676['id'],'type':_0x809ef3(0x185),'queueId':_0x111532['id']});if(_0x806a25&&!_0x111532[_0x809ef3(0x1ec)]['length']){const _0x97e7e1=_0x150338[_0x809ef3(0x2c6)]===0x0?0x1:_0x150338['count'],_0x5bbecf=_0x809ef3(0x240)+_0x97e7e1+'*',_0x26143f=(0x0,Mustache_1[_0x809ef3(0x270)])(''+_0x5bbecf,_0x11f676),_0x584cc2=(0x0,Debounce_1[_0x809ef3(0x202)])(async()=>{const _0x101023=_0x809ef3;await _0x1a0426[_0x101023(0x20f)](_0x118a38[_0x101023(0x194)]+'@'+(_0x11f676[_0x101023(0x222)]?_0x101023(0x1c8):'s.whatsapp.net'),{'text':_0x26143f});},0xbb8,_0x11f676['id']);_0x584cc2();}}else{if(_0x11f676[_0x809ef3(0x222)])return;if(_0x7e1a1a&&_0x7e1a1a!==0x0&&_0x11f676[_0x809ef3(0x292)]>=_0x7e1a1a)return;const _0x18d447=await(0x0,FindOrCreateATicketTrakingService_1[_0x809ef3(0x270)])({'ticketId':_0x11f676['id'],'companyId':_0x374727});let _0x3dbe49=new Date(),_0x25e31a=new Date();if(_0x18d447[_0x809ef3(0x2ba)]!==null){_0x3dbe49[_0x809ef3(0x1ff)](_0x18d447[_0x809ef3(0x2ba)]['getMinutes']()+Number(_0x2945f6));if(_0x18d447[_0x809ef3(0x2ba)]!==null&&_0x25e31a<_0x3dbe49&&_0x2945f6!=='0'&&_0x11f676['amountUsedBotQueues']!==0x0)return;}await _0x18d447[_0x809ef3(0x204)]({'chatbotAt':null}),_0x1a0426[_0x809ef3(0x224)](_0x118a38['remoteJid']);let _0x4728b6='';_0x1a0426[_0x809ef3(0x259)](_0x809ef3(0x250),_0x118a38[_0x809ef3(0x241)]),_0x106cf3[_0x809ef3(0x170)]((_0x534430,_0x1af98b)=>{const _0x56b5b1=_0x809ef3;_0x4728b6+=_0x56b5b1(0x1f4)+(_0x1af98b+0x1)+_0x56b5b1(0x268)+_0x534430[_0x56b5b1(0x254)]+'\x0a';}),_0x4728b6+=_0x809ef3(0x25d);const _0x3b243b=(0x0,Mustache_1[_0x809ef3(0x270)])('‎'+_0x42b3d7+'\x0a\x0a'+_0x4728b6,_0x11f676);await(0x0,CreateLogTicketService_1['default'])({'ticketId':_0x11f676['id'],'type':_0x809ef3(0x20d)}),await(0x0,baileys_1[_0x809ef3(0x1e9)])(0x3e8),await _0x1a0426['sendPresenceUpdate']('paused',_0x118a38[_0x809ef3(0x241)]);if(_0x11f676[_0x809ef3(0x22b)][_0x809ef3(0x1be)]!==null){const _0x4f0a3e=path_1['default'][_0x809ef3(0x2a7)](_0x809ef3(0x1a1),_0x809ef3(0x196)+_0x374727,_0x11f676[_0x809ef3(0x22b)]['greetingMediaAttachment']),_0x91f63f=_0x11f676[_0x809ef3(0x22b)]['greetingMediaAttachment'],_0x32ca39=await(0x0,SendWhatsAppMedia_1[_0x809ef3(0x2ca)])(_0x91f63f,_0x4f0a3e,String(_0x374727),_0x3b243b),_0x4697be=(0x0,Debounce_1[_0x809ef3(0x202)])(async()=>{const _0x41ddf6=_0x809ef3;let _0xdecc57=await _0x1a0426[_0x41ddf6(0x20f)](_0x11f676[_0x41ddf6(0x212)][_0x41ddf6(0x194)]+'@'+(_0x11f676['isGroup']?_0x41ddf6(0x1c8):_0x41ddf6(0x239)),{..._0x32ca39});await(0x0,exports['verifyMediaMessage'])(_0xdecc57,_0x11f676,_0x118a38,_0x18d447);},0x3e8,_0x11f676['id']);_0x4697be(),await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727});return;}else{const _0x118e01=(0x0,Debounce_1[_0x809ef3(0x202)])(async()=>{const _0x27ee0c=_0x809ef3,_0x2608b1=await _0x1a0426['sendMessage'](_0x118a38[_0x27ee0c(0x194)]+'@'+(_0x11f676[_0x27ee0c(0x222)]?_0x27ee0c(0x1c8):'s.whatsapp.net'),{'text':_0x3b243b});(0x0,exports['verifyMessage'])(_0x2608b1,_0x11f676,_0x118a38,_0x18d447);},0x3e8,_0x11f676['id']);await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727}),_0x118e01();}}},_0x2feba3=async()=>{const _0x18d090=_0x551899;if(_0x111532){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x111532['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});if(_0x111532[_0x18d090(0x1ec)][_0x18d090(0x18c)]>0x0){const _0x491c9c=[];_0x111532[_0x18d090(0x1ec)][_0x18d090(0x170)]((_0xc5a018,_0x131f77)=>{const _0x5482f2=_0x18d090;_0x491c9c[_0x5482f2(0x2e0)]({'buttonId':''+(_0x131f77+0x1),'buttonText':{'displayText':_0xc5a018[_0x5482f2(0x254)]},'type':0x1});});const _0xd07248={'text':(0x0,Mustache_1[_0x18d090(0x270)])(''+_0x111532[_0x18d090(0x29a)],_0x11f676),'buttons':_0x491c9c,'headerType':0x4},_0x568899=await _0x1a0426[_0x18d090(0x20f)](_0x118a38[_0x18d090(0x194)]+'@'+(_0x11f676[_0x18d090(0x222)]?'g.us':_0x18d090(0x239)),_0xd07248);await(0x0,exports['verifyMessage'])(_0x568899,_0x11f676,_0x118a38,_0x175837);}if(!_0x111532['chatbots'][_0x18d090(0x18c)]){const _0xf40f30=(0x0,Mustache_1[_0x18d090(0x270)])(''+_0x111532[_0x18d090(0x29a)],_0x11f676),_0x207951=await _0x1a0426['sendMessage'](_0x118a38[_0x18d090(0x194)]+'@'+(_0x11f676[_0x18d090(0x222)]?_0x18d090(0x1c8):_0x18d090(0x239)),{'text':_0xf40f30});await(0x0,exports[_0x18d090(0x281)])(_0x207951,_0x11f676,_0x118a38,_0x175837);}}else{const _0x5dd1d3=[];_0x106cf3[_0x18d090(0x170)]((_0x243266,_0x341556)=>{const _0x31f839=_0x18d090;_0x5dd1d3['push']({'buttonId':''+(_0x341556+0x1),'buttonText':{'displayText':_0x243266[_0x31f839(0x254)]},'type':0x4});});const _0x2a1175={'text':(0x0,Mustache_1[_0x18d090(0x270)])(''+_0x42b3d7,_0x11f676),'footer':'','buttons':_0x5dd1d3,'headerType':0x4},_0x430382=await _0x1a0426[_0x18d090(0x20f)](_0x118a38[_0x18d090(0x194)]+'@'+(_0x11f676[_0x18d090(0x222)]?_0x18d090(0x1c8):_0x18d090(0x239)),_0x2a1175);await(0x0,exports[_0x18d090(0x281)])(_0x430382,_0x11f676,_0x118a38,_0x175837),await(0x0,UpdateTicketService_1[_0x18d090(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676[_0x18d090(0x292)]+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727});}},_0x29aea8=async()=>{const _0x1250f4=_0x551899;if(_0x111532){await(0x0,UpdateTicketService_1[_0x1250f4(0x270)])({'ticketData':{'queueId':_0x111532['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});if(_0x111532[_0x1250f4(0x1ec)]['length']>0x0){const _0x1c1faa=[];_0x111532[_0x1250f4(0x1ec)]['forEach']((_0x5cf505,_0xa82ee2)=>{const _0x34f2ed=_0x1250f4;_0x1c1faa[_0x34f2ed(0x2e0)]({'title':_0x5cf505[_0x34f2ed(0x254)],'rowId':''+(_0xa82ee2+0x1)});});const _0x1cdef8=[{'title':_0x1250f4(0x1df),'rows':_0x1c1faa}],_0x274607={'text':(0x0,Mustache_1[_0x1250f4(0x270)])(''+_0x111532[_0x1250f4(0x29a)],_0x11f676),'buttonText':'Escolha\x20uma\x20opção','sections':_0x1cdef8},_0x379462=await _0x1a0426[_0x1250f4(0x20f)](_0x118a38[_0x1250f4(0x194)]+'@'+(_0x11f676[_0x1250f4(0x222)]?_0x1250f4(0x1c8):'s.whatsapp.net'),_0x274607);await(0x0,exports[_0x1250f4(0x281)])(_0x379462,_0x11f676,_0x118a38,_0x175837);}if(!_0x111532[_0x1250f4(0x1ec)][_0x1250f4(0x18c)]){const _0x746f48=(0x0,Mustache_1[_0x1250f4(0x270)])(''+_0x111532[_0x1250f4(0x29a)],_0x11f676),_0x5a60bb=await _0x1a0426[_0x1250f4(0x20f)](_0x118a38[_0x1250f4(0x194)]+'@'+(_0x11f676[_0x1250f4(0x222)]?_0x1250f4(0x1c8):_0x1250f4(0x239)),{'text':_0x746f48});await(0x0,exports[_0x1250f4(0x281)])(_0x5a60bb,_0x11f676,_0x118a38,_0x175837);}}else{const _0x591610=[];_0x106cf3[_0x1250f4(0x170)]((_0x1d70bd,_0x1e0ace)=>{const _0x3a764d=_0x1250f4;_0x591610[_0x3a764d(0x2e0)]({'title':_0x1d70bd['name'],'rowId':''+(_0x1e0ace+0x1)});});const _0x46d1a0=[{'title':_0x1250f4(0x1df),'rows':_0x591610}],_0xe899dd={'text':(0x0,Mustache_1[_0x1250f4(0x270)])(''+_0x42b3d7,_0x11f676),'buttonText':_0x1250f4(0x2a1),'sections':_0x46d1a0},_0x40e40e=await _0x1a0426[_0x1250f4(0x20f)](_0x118a38[_0x1250f4(0x194)]+'@'+(_0x11f676[_0x1250f4(0x222)]?_0x1250f4(0x1c8):'s.whatsapp.net'),_0xe899dd);await(0x0,exports[_0x1250f4(0x281)])(_0x40e40e,_0x11f676,_0x118a38,_0x175837),await(0x0,UpdateTicketService_1[_0x1250f4(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676['amountUsedBotQueues']+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727});}};if(_0x2a6563==='text')return _0x41c5f2();if(_0x2a6563==='button'&&_0x106cf3['length']>0x3)return _0x41c5f2();if(_0x2a6563===_0x551899(0x256)&&_0x106cf3[_0x551899(0x18c)]<=0x3)return _0x2feba3();if(_0x2a6563===_0x551899(0x258))return _0x29aea8();},verifyRating=_0x5223c7=>{const _0x2b1eda=a615_0x5b5b25;if(_0x5223c7&&_0x5223c7[_0x2b1eda(0x245)]===null&&_0x5223c7[_0x2b1eda(0x1b5)]!==null&&_0x5223c7[_0x2b1eda(0x261)]!==null&&_0x5223c7[_0x2b1eda(0x2ae)]===null)return!![];return![];};exports[a615_0x5b5b25(0x18e)]=verifyRating;const handleRating=async(_0x30cf33,_0x5d1966,_0x4626c1)=>{const _0x3fb56c=a615_0x5b5b25,_0x892c1=(0x0,socket_1['getIO'])(),_0x103bac=_0x5d1966['companyId'],{complationMessage:_0x5a59bb}=await(0x0,ShowWhatsAppService_1[_0x3fb56c(0x270)])(_0x5d1966[_0x3fb56c(0x23a)],_0x103bac);let _0xce6178=_0x30cf33;_0x30cf33<0x0&&(_0xce6178=0x0);_0x30cf33>0xa&&(_0xce6178=0xa);await UserRating_1[_0x3fb56c(0x270)][_0x3fb56c(0x1e0)]({'ticketId':_0x4626c1['ticketId'],'companyId':_0x4626c1[_0x3fb56c(0x2df)],'userId':_0x4626c1['userId'],'rate':_0xce6178});if(!(0x0,lodash_1[_0x3fb56c(0x218)])(_0x5a59bb)&&_0x5a59bb!==''&&!_0x5d1966[_0x3fb56c(0x222)]){const _0x29dbf6=(0x0,Mustache_1[_0x3fb56c(0x270)])('‎'+_0x5a59bb,_0x5d1966);if(_0x5d1966[_0x3fb56c(0x2bc)]===_0x3fb56c(0x22b)){const _0x4f3331=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x29dbf6,'ticket':_0x5d1966});await(0x0,exports[_0x3fb56c(0x281)])(_0x4f3331,_0x5d1966,_0x5d1966['contact'],_0x4626c1);}[_0x3fb56c(0x255),_0x3fb56c(0x2d5)][_0x3fb56c(0x2dd)](_0x5d1966[_0x3fb56c(0x2bc)])&&await(0x0,sendFacebookMessage_1['default'])({'body':_0x29dbf6,'ticket':_0x5d1966});}await _0x5d1966[_0x3fb56c(0x204)]({'chatbot':null,'status':_0x3fb56c(0x1cb),'amountUseBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1[_0x3fb56c(0x270)])({'userId':_0x5d1966[_0x3fb56c(0x261)],'queueId':_0x5d1966[_0x3fb56c(0x1dc)],'ticketId':_0x5d1966['id'],'type':_0x3fb56c(0x1cb)}),_0x892c1['to'](_0x3fb56c(0x2b6))['emit']('company-'+_0x103bac+_0x3fb56c(0x2a8),{'action':_0x3fb56c(0x227),'ticket':_0x5d1966,'ticketId':_0x5d1966['id']}),_0x892c1['to'](_0x5d1966[_0x3fb56c(0x1ae)])['to'](_0x5d1966['id'][_0x3fb56c(0x2c9)]())['emit']('company-'+_0x103bac+_0x3fb56c(0x2a8),{'action':_0x3fb56c(0x204),'ticket':_0x5d1966,'ticketId':_0x5d1966['id']});};exports[a615_0x5b5b25(0x237)]=handleRating;const sanitizeName=_0x377e29=>{const _0x33277e=a615_0x5b5b25;let _0x183ca3=_0x377e29[_0x33277e(0x154)]('\x20')[0x0];return _0x183ca3=_0x183ca3[_0x33277e(0x16d)](/[^a-zA-Z0-9]/g,''),_0x183ca3[_0x33277e(0x205)](0x0,0x3c);},deleteFileSync=_0x5bafdd=>{const _0x5a2cb3=a615_0x5b5b25;try{fs_2[_0x5a2cb3(0x270)]['unlinkSync'](_0x5bafdd);}catch(_0x16abc9){console[_0x5a2cb3(0x1a6)](_0x5a2cb3(0x209),_0x16abc9);}},convertTextToSpeechAndSaveToFile=(_0x485fb2,_0x28ecb5,_0x383679,_0x399d76,_0x2c41d9=a615_0x5b5b25(0x288),_0xf2a5ec='mp3')=>{return new Promise((_0x3ef0bf,_0x507350)=>{const _0x52d086=a615_0xc8bf,_0x489db4=microsoft_cognitiveservices_speech_sdk_1[_0x52d086(0x198)][_0x52d086(0x165)](_0x383679,_0x399d76);_0x489db4[_0x52d086(0x298)]=_0x2c41d9;const _0x19c657=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x52d086(0x23e)](_0x28ecb5+'.wav'),_0x5e1973=new microsoft_cognitiveservices_speech_sdk_1['SpeechSynthesizer'](_0x489db4,_0x19c657);_0x5e1973['speakTextAsync'](_0x485fb2,_0x1f8b45=>{const _0x282ffd=_0x52d086;_0x1f8b45?convertWavToAnotherFormat(_0x28ecb5+'.wav',_0x28ecb5+'.'+_0xf2a5ec,_0xf2a5ec)[_0x282ffd(0x2a3)](_0x1f8f3d=>{_0x3ef0bf();})['catch'](_0x44bc7d=>{console['error'](_0x44bc7d),_0x507350(_0x44bc7d);}):_0x507350(new Error(_0x282ffd(0x1a3))),_0x5e1973[_0x282ffd(0x188)]();},_0x415966=>{const _0xbff79d=_0x52d086;console[_0xbff79d(0x1a6)](_0xbff79d(0x249)+_0x415966),_0x5e1973[_0xbff79d(0x188)](),_0x507350(_0x415966);});});},convertWavToAnotherFormat=(_0x13e70d,_0x457c02,_0x4523f7)=>{return new Promise((_0xbc3ede,_0x52f401)=>{const _0x56e10a=a615_0xc8bf;(0x0,fluent_ffmpeg_1[_0x56e10a(0x270)])()[_0x56e10a(0x1b1)](_0x13e70d)['toFormat'](_0x4523f7)['on'](_0x56e10a(0x2b3),()=>_0xbc3ede(_0x457c02))['on']('error',_0x1c3e2b=>_0x52f401(new Error('Error\x20converting\x20file:\x20'+_0x1c3e2b['message'])))[_0x56e10a(0x26d)](_0x457c02);});},keepOnlySpecifiedChars=_0x3c4186=>{const _0x1d86c3=a615_0x5b5b25;return _0x3c4186[_0x1d86c3(0x16d)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x135fb2,_0x449a41,_0x59b17a,_0x113556,_0x2f49b9)=>{const _0x25af6f=a615_0x5b5b25,_0x24c463=(0x0,exports[_0x25af6f(0x2c4)])(_0x135fb2);if(!_0x24c463)return;const {prompt:_0x2db8f3}=await(0x0,ShowWhatsAppService_1['default'])(_0x449a41['id'],_0x59b17a[_0x25af6f(0x2df)]);if(!_0x2db8f3)return;if(_0x135fb2[_0x25af6f(0x1bb)])return;const _0x301c6e=path_1['default']['resolve'](__dirname,'..','..','..',_0x25af6f(0x1a1),'company'+_0x59b17a[_0x25af6f(0x2df)]);let _0x3e5326;const _0x5a5670=sessionsOpenAi[_0x25af6f(0x22a)](_0x25a939=>_0x25a939['id']===_0x449a41['id']);if(_0x5a5670===-0x1){const _0xeb4f07=new openai_1[(_0x25af6f(0x2a0))]({'apiKey':_0x2db8f3[_0x25af6f(0x16f)]});_0x3e5326=new openai_1[(_0x25af6f(0x160))](_0xeb4f07),_0x3e5326['id']=_0x449a41['id'],sessionsOpenAi[_0x25af6f(0x2e0)](_0x3e5326);}else _0x3e5326=sessionsOpenAi[_0x5a5670];const _0xf422b0=await Message_1[_0x25af6f(0x270)]['findAll']({'where':{'ticketId':_0x59b17a['id']},'order':[[_0x25af6f(0x1ad),'ASC']],'limit':_0x2db8f3[_0x25af6f(0x16c)]}),_0x56ec64=_0x25af6f(0x290)+sanitizeName(_0x113556['name']||_0x25af6f(0x1c4))+_0x25af6f(0x266)+_0x2db8f3[_0x25af6f(0x26b)]+_0x25af6f(0x17f)+_0x2db8f3[_0x25af6f(0x21b)]+'\x0a';let _0x33b7e9=[];if(_0x135fb2[_0x25af6f(0x1dd)]?.[_0x25af6f(0x169)]||_0x135fb2[_0x25af6f(0x1dd)]?.[_0x25af6f(0x291)]?.['text']){_0x33b7e9=[],_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x1fa),'content':_0x56ec64});for(let _0x28919f=0x0;_0x28919f<Math['min'](_0x2db8f3[_0x25af6f(0x16c)],_0xf422b0['length']);_0x28919f++){const _0x29ba1c=_0xf422b0[_0x28919f];_0x29ba1c['mediaType']===_0x25af6f(0x146)&&(_0x29ba1c[_0x25af6f(0x27f)]?_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x21a),'content':_0x29ba1c[_0x25af6f(0x2b5)]}):_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x2a2),'content':_0x29ba1c['body']}));}_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x2a2),'content':_0x24c463});const _0xb4c5e4=await _0x3e5326[_0x25af6f(0x27a)]({'model':_0x25af6f(0x1f5),'messages':_0x33b7e9,'max_tokens':_0x2db8f3[_0x25af6f(0x26b)],'temperature':_0x2db8f3[_0x25af6f(0x29f)]});let _0x8dadf6=_0xb4c5e4[_0x25af6f(0x28e)][_0x25af6f(0x1c3)][0x0][_0x25af6f(0x1dd)]?.[_0x25af6f(0x182)];_0x8dadf6?.[_0x25af6f(0x2dd)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x2db8f3[_0x25af6f(0x1dc)],_0x59b17a,_0x113556),_0x8dadf6=_0x8dadf6[_0x25af6f(0x16d)](_0x25af6f(0x287),'')['trim']());if(_0x2db8f3[_0x25af6f(0x1e3)]===_0x25af6f(0x233)){const _0x319fc9=await _0x449a41[_0x25af6f(0x20f)](_0x135fb2[_0x25af6f(0x190)][_0x25af6f(0x241)],{'text':_0x8dadf6});await(0x0,exports['verifyMessage'])(_0x319fc9,_0x59b17a,_0x113556);}else{const _0x194f8f=_0x59b17a['id']+'_'+Date[_0x25af6f(0x19c)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x8dadf6),_0x301c6e+'/'+_0x194f8f,_0x2db8f3[_0x25af6f(0x289)],_0x2db8f3[_0x25af6f(0x238)],_0x2db8f3[_0x25af6f(0x1e3)],'mp3')[_0x25af6f(0x2a3)](async()=>{const _0x3bd5ae=_0x25af6f;try{const _0x2420f1=await _0x449a41[_0x3bd5ae(0x20f)](_0x135fb2[_0x3bd5ae(0x190)][_0x3bd5ae(0x241)],{'audio':{'url':_0x301c6e+'/'+_0x194f8f+'.mp3'},'mimetype':_0x3bd5ae(0x1c5),'ptt':!![]});await(0x0,exports[_0x3bd5ae(0x149)])(_0x2420f1,_0x59b17a,_0x113556),deleteFileSync(_0x301c6e+'/'+_0x194f8f+'.mp3'),deleteFileSync(_0x301c6e+'/'+_0x194f8f+_0x3bd5ae(0x228));}catch(_0x208faf){console['log'](_0x3bd5ae(0x1eb)+_0x208faf);}});}}else{if(_0x135fb2[_0x25af6f(0x1dd)]?.[_0x25af6f(0x2a5)]){const _0x57dc3c=_0x2f49b9[_0x25af6f(0x20a)]['split']('/')[_0x25af6f(0x163)](),_0x10d38c=fs_2[_0x25af6f(0x270)][_0x25af6f(0x16e)](_0x301c6e+'/'+_0x57dc3c),_0x910cac=await _0x3e5326['createTranscription'](_0x10d38c,_0x25af6f(0x2b0));_0x33b7e9=[],_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x1fa),'content':_0x56ec64});for(let _0x248010=0x0;_0x248010<Math[_0x25af6f(0x2c0)](_0x2db8f3[_0x25af6f(0x16c)],_0xf422b0[_0x25af6f(0x18c)]);_0x248010++){const _0x1f85bf=_0xf422b0[_0x248010];_0x1f85bf[_0x25af6f(0x174)]===_0x25af6f(0x146)&&(_0x1f85bf[_0x25af6f(0x27f)]?_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x21a),'content':_0x1f85bf[_0x25af6f(0x2b5)]}):_0x33b7e9['push']({'role':_0x25af6f(0x2a2),'content':_0x1f85bf[_0x25af6f(0x2b5)]}));}_0x33b7e9['push']({'role':_0x25af6f(0x2a2),'content':_0x910cac['data'][_0x25af6f(0x20c)]});const _0xa22443=await _0x3e5326[_0x25af6f(0x27a)]({'model':_0x25af6f(0x1f5),'messages':_0x33b7e9,'max_tokens':_0x2db8f3['maxTokens'],'temperature':_0x2db8f3[_0x25af6f(0x29f)]});let _0x83c00=_0xa22443['data'][_0x25af6f(0x1c3)][0x0]['message']?.[_0x25af6f(0x182)];_0x83c00?.[_0x25af6f(0x2dd)](_0x25af6f(0x287))&&(await transferQueue(_0x2db8f3[_0x25af6f(0x1dc)],_0x59b17a,_0x113556),_0x83c00=_0x83c00[_0x25af6f(0x16d)](_0x25af6f(0x287),'')[_0x25af6f(0x2da)]());if(_0x2db8f3[_0x25af6f(0x1e3)]===_0x25af6f(0x233)){const _0x378f8a=await _0x449a41[_0x25af6f(0x20f)](_0x135fb2['key']['remoteJid'],{'text':_0x83c00});await(0x0,exports['verifyMessage'])(_0x378f8a,_0x59b17a,_0x113556);}else{const _0x56ac1f=_0x59b17a['id']+'_'+Date[_0x25af6f(0x19c)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x83c00),_0x301c6e+'/'+_0x56ac1f,_0x2db8f3[_0x25af6f(0x289)],_0x2db8f3['voiceRegion'],_0x2db8f3[_0x25af6f(0x1e3)],_0x25af6f(0x1f0))[_0x25af6f(0x2a3)](async()=>{const _0x9124c5=_0x25af6f;try{const _0x3f871e=await _0x449a41[_0x9124c5(0x20f)](_0x135fb2[_0x9124c5(0x190)][_0x9124c5(0x241)],{'audio':{'url':_0x301c6e+'/'+_0x56ac1f+_0x9124c5(0x2ab)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports[_0x9124c5(0x149)])(_0x3f871e,_0x59b17a,_0x113556),deleteFileSync(_0x301c6e+'/'+_0x56ac1f+_0x9124c5(0x2ab)),deleteFileSync(_0x301c6e+'/'+_0x56ac1f+'.wav');}catch(_0x3fd1f7){console[_0x9124c5(0x278)](_0x9124c5(0x1eb)+_0x3fd1f7);}});}}}_0x33b7e9=[];},transferQueue=async(_0x3f8015,_0x31288c,_0xb568b1)=>{const _0x2a649c=a615_0x5b5b25;await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x3f8015},'ticketId':_0x31288c['id'],'companyId':_0x31288c[_0x2a649c(0x2df)]});},handleMessageIntegration=async(_0x365199,_0x806ca2,_0x1de10d,_0x3f6ca7,_0x9f0027)=>{const _0xa10f9e=a615_0x5b5b25,_0x485071=getTypeMessage(_0x365199);if(_0x3f6ca7['type']==='n8n'||_0x3f6ca7[_0xa10f9e(0x156)]===_0xa10f9e(0x2d3)){if(_0x3f6ca7?.[_0xa10f9e(0x2b2)]){const _0x5590e3={'method':_0xa10f9e(0x1e5),'url':_0x3f6ca7?.[_0xa10f9e(0x2b2)],'headers':{'Content-Type':_0xa10f9e(0x24e)},'json':_0x365199};try{request(_0x5590e3,function(_0x1d56a3,_0x3a69a7){const _0x197e6f=_0xa10f9e;if(_0x1d56a3)throw new Error(_0x1d56a3);else console[_0x197e6f(0x278)](_0x3a69a7[_0x197e6f(0x2b5)]);});}catch(_0x3e7f3b){throw new Error(_0x3e7f3b);}}}else{if(_0x3f6ca7[_0xa10f9e(0x156)]==='dialogflow'){let _0x432aa5;if(_0x485071===_0xa10f9e(0x2a5)){let _0xc09689=_0x365199[_0xa10f9e(0x14b)]+'.ogg';(0x0,fs_1[_0xa10f9e(0x1cd)])((0x0,path_1[_0xa10f9e(0x178)])(__dirname,'..','..','..',_0xa10f9e(0x1a1),'company'+_0x1de10d,_0xc09689),_0xa10f9e(0x1ac),(_0x38832e,_0x4fb78a)=>{const _0x19a8f0=_0xa10f9e;_0x432aa5=_0x4fb78a,_0x38832e&&logger_1['logger'][_0x19a8f0(0x1a6)](_0x38832e);});}else _0x432aa5=undefined;const _0x486ccb=(0x0,Debounce_1[_0xa10f9e(0x202)])(async()=>{await sendDialogflowAwswer(_0x806ca2,_0x9f0027,_0x365199,_0x9f0027['contact'],_0x432aa5,_0x1de10d,_0x3f6ca7);},0x1f4,_0x9f0027['id']);_0x486ccb();}else{if(_0x3f6ca7[_0xa10f9e(0x156)]===_0xa10f9e(0x206)){}}}};exports[a615_0x5b5b25(0x2a9)]=handleMessageIntegration;const handleMessage=async(_0x4b1a00,_0x57d497,_0x3e5aa2,_0x84a3cf=![])=>{const _0x889edd=a615_0x5b5b25;if(_0x84a3cf){(0x0,addLogs_1['addLogs'])({'fileName':_0x889edd(0x272)+_0x57d497['id']+_0x889edd(0x246),'text':'Importando\x20Mensagem:\x20'+JSON[_0x889edd(0x263)](_0x4b1a00,null,0x2)+_0x889edd(0x25b)});let _0x319acc=_0x4b1a00[_0x889edd(0x190)]['id'],_0x339c05=await Message_1[_0x889edd(0x270)][_0x889edd(0x1b2)]({'where':{'wid':_0x319acc}});if(_0x339c05){await new Promise(_0xb96b36=>setTimeout(_0xb96b36,0x96)),console[_0x889edd(0x278)](_0x889edd(0x275));return;}else await new Promise(_0x2ae0c9=>setTimeout(_0x2ae0c9,parseInt(process[_0x889edd(0x1ea)][_0x889edd(0x25a)])||0x14a));}else await new Promise(_0x2b211a=>setTimeout(_0x2b211a,i*0x28a)),i++;if(!isValidMsg(_0x4b1a00))return;try{let _0x3d42c4,_0x420ad2,_0x1b2599=0x0,_0x4ca97c=0x0,_0x462452=0x0,_0x4eb3d6=(0x0,exports[_0x889edd(0x2c4)])(_0x4b1a00);const _0x403728=getTypeMessage(_0x4b1a00);if(_0x403728==='protocolMessage')return;const _0x32bf00=_0x4b1a00['message']?.[_0x889edd(0x2a5)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x18f)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x22f)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x267)]||_0x4b1a00[_0x889edd(0x1dd)][_0x889edd(0x1b9)]||_0x4b1a00?.[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.['message']?.[_0x889edd(0x18f)]||_0x4b1a00?.[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.[_0x889edd(0x1dd)]?.['audioMessage']||_0x4b1a00?.[_0x889edd(0x1dd)]?.['ephemeralMessage']?.[_0x889edd(0x1dd)]?.[_0x889edd(0x22f)]||_0x4b1a00?.[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.['message']?.[_0x889edd(0x267)]||_0x4b1a00?.['message']?.[_0x889edd(0x168)]?.[_0x889edd(0x1dd)]?.[_0x889edd(0x1b9)]||_0x4b1a00[_0x889edd(0x1dd)]?.['viewOnceMessage']?.['message']?.[_0x889edd(0x18f)]||_0x4b1a00[_0x889edd(0x1dd)]?.['viewOnceMessage']?.[_0x889edd(0x1dd)]?.['videoMessage']||_0x4b1a00['message']?.['ephemeralMessage']?.[_0x889edd(0x1dd)]?.[_0x889edd(0x2c7)]?.[_0x889edd(0x1dd)]?.['imageMessage']||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.[_0x889edd(0x1dd)]?.[_0x889edd(0x2c7)]?.[_0x889edd(0x1dd)]?.[_0x889edd(0x22f)]||_0x4b1a00[_0x889edd(0x1dd)]?.['documentWithCaptionMessage']?.[_0x889edd(0x1dd)]?.[_0x889edd(0x267)];if(_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]){if(/\u200e/['test'](_0x4eb3d6))return;if(!_0x32bf00&&_0x403728!==_0x889edd(0x169)&&_0x403728!=='extendedTextMessage'&&_0x403728!=='contactMessage'&&_0x403728!==_0x889edd(0x19e)&&_0x403728!==_0x889edd(0x168)&&_0x403728!==_0x889edd(0x22d)&&_0x403728!=='viewOnceMessage'&&_0x403728!==_0x889edd(0x2cc))return;_0x3d42c4=await getContactMessage(_0x4b1a00,_0x57d497);}else _0x3d42c4=await getContactMessage(_0x4b1a00,_0x57d497);const _0xb582a2=_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x241)]?.['endsWith'](_0x889edd(0x264)),_0x4254e7=await(0x0,ShowWhatsAppService_1[_0x889edd(0x270)])(_0x57d497['id'],_0x3e5aa2);if(!_0x4254e7[_0x889edd(0x192)]&&_0xb582a2)return;if(_0xb582a2){const _0x543b80=await _0x57d497[_0x889edd(0x235)](_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x241)]),_0x1a5ddc={'id':_0x543b80['id'],'name':_0x543b80['subject']};_0x420ad2=await verifyContact(_0x1a5ddc,_0x57d497,_0x3e5aa2);}const _0x50df2d=await verifyContact(_0x3d42c4,_0x57d497,_0x3e5aa2);let _0x26046a=0x0,_0x3f27b7=null;if(_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)])await cache_1['default'][_0x889edd(0x2cd)](_0x889edd(0x1d9)+_0x50df2d['id']+_0x889edd(0x21f),'0');else{const _0x2ffa90=await cache_1[_0x889edd(0x270)][_0x889edd(0x232)](_0x889edd(0x1d9)+_0x50df2d['id']+':unreads');_0x26046a=+_0x2ffa90+0x1,await cache_1[_0x889edd(0x270)]['set'](_0x889edd(0x1d9)+_0x50df2d['id']+_0x889edd(0x21f),''+_0x26046a);}const _0x2269a2=await CompaniesSettings_1['default'][_0x889edd(0x1b2)]({'where':{'companyId':_0x3e5aa2}}),_0x862f35=_0x2269a2[_0x889edd(0x1d0)]===_0x889edd(0x213),{ticket:_0x1406d7,isCreated:_0x25527a}=await(0x0,FindOrCreateTicketService_1[_0x889edd(0x270)])(_0x50df2d,_0x4254e7,_0x26046a,_0x3e5aa2,_0x1b2599,_0x462452,_0x420ad2,_0x889edd(0x22b),_0x84a3cf,![],_0x2269a2);_0x3f27b7=_0x1406d7;if(_0x3f27b7[_0x889edd(0x1ae)]===_0x889edd(0x1cb)||_0x26046a===0x0&&_0x4254e7[_0x889edd(0x1a5)]&&(0x0,Mustache_1[_0x889edd(0x270)])(_0x4254e7[_0x889edd(0x1a5)],_0x3f27b7)===_0x4eb3d6)return;if(!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]&&_0x4254e7?.['integrationId']>0x0){const _0x1e2366=await(0x0,ShowQueueIntegrationService_1['default'])(_0x4254e7[_0x889edd(0x293)],_0x3e5aa2);await(0x0,exports['handleMessageIntegration'])(_0x4b1a00,_0x57d497,_0x3e5aa2,_0x1e2366,_0x3f27b7),await _0x3f27b7['update']({'useIntegration':!![],'integrationId':_0x1e2366['id']});}if(_0x403728===_0x889edd(0x2cc)){const _0x3b6042=_0x4b1a00[_0x889edd(0x1dd)]['editedMessage'][_0x889edd(0x1dd)][_0x889edd(0x22d)][_0x889edd(0x190)]['id'],_0xb31b0f=_0x4b1a00[_0x889edd(0x1dd)][_0x889edd(0x2cc)][_0x889edd(0x1dd)][_0x889edd(0x22d)][_0x889edd(0x2cc)]['conversation'],_0x413af4=(0x0,socket_1[_0x889edd(0x2d0)])();try{const _0x3ba3c3=await Message_1[_0x889edd(0x270)][_0x889edd(0x1b2)]({'where':{'wid':_0x3b6042,'companyId':_0x3e5aa2,'ticketId':_0x3f27b7['id']}});if(!_0x3ba3c3)return;await _0x3ba3c3[_0x889edd(0x204)]({'isEdited':!![],'body':_0xb31b0f}),await _0x3f27b7[_0x889edd(0x204)]({'lastMessage':_0xb31b0f}),_0x413af4['to'](_0x3ba3c3['ticketId']['toString']())['emit']('company-'+_0x3ba3c3[_0x889edd(0x2df)]+_0x889edd(0x15f),{'action':'update','message':_0x3ba3c3});}catch(_0x4ebd27){Sentry[_0x889edd(0x150)](_0x4ebd27),logger_1[_0x889edd(0x171)][_0x889edd(0x1a6)](_0x889edd(0x197)+_0x4ebd27);}return;}const _0x33a249=await(0x0,FindOrCreateATicketTrakingService_1[_0x889edd(0x270)])({'ticketId':_0x3f27b7['id'],'companyId':_0x3e5aa2,'whatsappId':_0x4254e7?.['id']});try{if(!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]){if(_0x3f27b7[_0x889edd(0x1ae)]===_0x889edd(0x161)&&_0x33a249!==null&&(0x0,exports[_0x889edd(0x18e)])(_0x33a249)){_0x32bf00?await(0x0,exports[_0x889edd(0x149)])(_0x4b1a00,_0x3f27b7,_0x50df2d):await(0x0,exports[_0x889edd(0x281)])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249);if(!isNaN(parseFloat(_0x4eb3d6))){(0x0,exports[_0x889edd(0x237)])(parseFloat(_0x4eb3d6),_0x3f27b7,_0x33a249),await _0x33a249[_0x889edd(0x204)]({'ratingAt':(0x0,moment_1[_0x889edd(0x270)])()['toDate'](),'finishedAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)](),'rated':!![]});return;}else{if(_0x3f27b7[_0x889edd(0x2c2)]<_0x4254e7[_0x889edd(0x2ac)]){let _0x4505bc='‎Opção\x20inválida,\x20tente\x20novamente.\x0a';const _0xcb5f99=await _0x57d497[_0x889edd(0x20f)](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7[_0x889edd(0x222)]?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':_0x4505bc});(0x0,exports['verifyMessage'])(_0xcb5f99,_0x3f27b7,_0x50df2d,_0x33a249),await(0x0,baileys_1['delay'])(0x3e8);let _0x3aab90='‎'+_0x4254e7[_0x889edd(0x17e)]+'\x0a';const _0x257b9c=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3aab90,'ticket':_0x3f27b7});await(0x0,exports[_0x889edd(0x281)])(_0x257b9c,_0x3f27b7,_0x3f27b7[_0x889edd(0x212)]),await _0x3f27b7[_0x889edd(0x204)]({'amountUseBotQueuesNPS':_0x3f27b7[_0x889edd(0x2c2)]+0x1});}return;}}if(_0x862f35&&_0x3f27b7[_0x889edd(0x1ae)]===_0x889edd(0x173)&&!_0x84a3cf){if((0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x262)])&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x2ce)])){let _0x5e8e90=parseFloat(_0x4eb3d6);if(!Number['isNaN'](_0x5e8e90)&&Number[_0x889edd(0x22e)](_0x5e8e90)&&!(0x0,lodash_1[_0x889edd(0x1b8)])(_0x5e8e90)&&_0x5e8e90>0x0){if(_0x5e8e90===0x1)await _0x50df2d[_0x889edd(0x204)]({'lgpdAcceptedAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)]()}),await _0x3f27b7[_0x889edd(0x204)]({'lgpdAcceptedAt':(0x0,moment_1['default'])()[_0x889edd(0x229)](),'amountUsedBotQueues':0x0});else{if(_0x5e8e90===0x2){if(_0x4254e7['complationMessage']!==''&&_0x4254e7[_0x889edd(0x1a5)]!==undefined){const _0x5ca873=await _0x57d497['sendMessage'](_0x3f27b7[_0x889edd(0x212)]['number']+'@'+(_0x3f27b7['isGroup']?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':'‎'+_0x4254e7[_0x889edd(0x1a5)]});(0x0,exports[_0x889edd(0x281)])(_0x5ca873,_0x3f27b7,_0x50df2d,_0x33a249);}await _0x3f27b7['update']({'status':_0x889edd(0x1cb),'amountUsedBotQueues':0x0}),await _0x33a249['destroy'];return;}else _0x3f27b7[_0x889edd(0x292)]<_0x4254e7[_0x889edd(0x1d7)]&&_0x4254e7[_0x889edd(0x1d7)]>0x0&&await _0x3f27b7[_0x889edd(0x204)]({'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1,'lgpdSendMessageAt':null});}}else _0x3f27b7[_0x889edd(0x292)]<_0x4254e7[_0x889edd(0x1d7)]&&_0x4254e7[_0x889edd(0x1d7)]>0x0&&await _0x3f27b7['update']({'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1,'lgpdSendMessageAt':null});}if((_0x50df2d['lgpdAcceptedAt']===null||_0x2269a2?.['lgpdConsent']===_0x889edd(0x213))&&!_0x50df2d['isGroup']&&(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7['lgpdSendMessageAt'])&&_0x3f27b7[_0x889edd(0x292)]<=_0x4254e7['maxUseBotQueues']&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x2269a2?.[_0x889edd(0x2d2)])){_0x32bf00?await(0x0,exports[_0x889edd(0x149)])(_0x4b1a00,_0x3f27b7,_0x50df2d):await(0x0,exports[_0x889edd(0x281)])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249);if(!(0x0,lodash_1['isNil'])(_0x2269a2?.[_0x889edd(0x2d2)])&&_0x2269a2[_0x889edd(0x2d2)]!==''){const _0x2f49e8=(0x0,Mustache_1[_0x889edd(0x270)])('‎'+_0x2269a2?.[_0x889edd(0x2d2)],_0x3f27b7),_0x31abea=await _0x57d497[_0x889edd(0x20f)](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7[_0x889edd(0x222)]?_0x889edd(0x1c8):'s.whatsapp.net'),{'text':_0x2f49e8});(0x0,exports[_0x889edd(0x281)])(_0x31abea,_0x3f27b7,_0x50df2d,_0x33a249);}await(0x0,baileys_1[_0x889edd(0x1e9)])(0x3e8);if(!(0x0,lodash_1[_0x889edd(0x218)])(_0x2269a2?.[_0x889edd(0x216)])&&_0x2269a2?.['lgpdLink']!==''){const _0x1303d7=(0x0,Mustache_1[_0x889edd(0x270)])('‎'+_0x2269a2?.[_0x889edd(0x216)],_0x3f27b7),_0x1f6f5f=await _0x57d497[_0x889edd(0x20f)](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7['isGroup']?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':_0x1303d7});await(0x0,exports[_0x889edd(0x281)])(_0x1f6f5f,_0x3f27b7,_0x50df2d,_0x33a249);};await(0x0,baileys_1[_0x889edd(0x1e9)])(0x3e8);const _0x3fabc4=(0x0,Mustache_1[_0x889edd(0x270)])('‎Estou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20Não',_0x3f27b7),_0x3688e0=await _0x57d497['sendMessage'](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7[_0x889edd(0x222)]?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':_0x3fabc4});await(0x0,exports[_0x889edd(0x281)])(_0x3688e0,_0x3f27b7,_0x50df2d,_0x33a249),await _0x3f27b7[_0x889edd(0x204)]({'lgpdSendMessageAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)](),'amountUsedBotQueues':_0x3f27b7['amountUsedBotQueues']+0x1}),await _0x3f27b7[_0x889edd(0x2b7)]();return;};if(!(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x2ce)])&&(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x262)]))return;}}}catch(_0x49bff4){Sentry[_0x889edd(0x150)](_0x49bff4),console[_0x889edd(0x278)](_0x49bff4);}const _0x3a60f4=_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x291)]?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x18f)]?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)]||_0x4b1a00[_0x889edd(0x1dd)]?.['audioMessage']?.[_0x889edd(0x17b)]?.['isForwarded']||_0x4b1a00[_0x889edd(0x1dd)]?.['videoMessage']?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x267)]?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)];let _0x595eb8;_0x32bf00?_0x595eb8=await(0x0,exports[_0x889edd(0x149)])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249,_0x3a60f4):await(0x0,exports['verifyMessage'])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249,![],_0x3a60f4);try{await _0x3f27b7[_0x889edd(0x204)]({'fromMe':_0x4b1a00['key']['fromMe']});}catch(_0x3856d3){Sentry[_0x889edd(0x150)](_0x3856d3),console[_0x889edd(0x278)](_0x3856d3);}let _0x33bc78;if(_0x2269a2['scheduleType']===_0x889edd(0x196))_0x33bc78=await(0x0,VerifyCurrentSchedule_1[_0x889edd(0x270)])(_0x3e5aa2,0x0,0x0);else _0x2269a2['scheduleType']==='connection'&&(_0x33bc78=await(0x0,VerifyCurrentSchedule_1[_0x889edd(0x270)])(_0x3e5aa2,0x0,_0x4254e7['id']));try{if(!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&_0x2269a2[_0x889edd(0x1f7)]&&(!_0x3f27b7['isGroup']||_0x4254e7['groupAsTicket']===_0x889edd(0x213))){if((_0x2269a2[_0x889edd(0x1f7)]==='company'||_0x2269a2[_0x889edd(0x1f7)]===_0x889edd(0x2c8))&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x33bc78)&&(!_0x33bc78||_0x33bc78[_0x889edd(0x29c)]===![])){_0x33a249['chatbotAt']===null&&await _0x33a249[_0x889edd(0x204)]({'chatbotAt':(0x0,moment_1['default'])()[_0x889edd(0x229)]()});if(_0x4254e7[_0x889edd(0x1d7)]&&_0x4254e7['maxUseBotQueues']!==0x0&&_0x3f27b7['amountUsedBotQueues']>=_0x4254e7[_0x889edd(0x1d7)])return;let _0x486774=new Date(),_0x33dbc9=new Date();if(_0x33a249[_0x889edd(0x2ba)]!==null){_0x486774['setMinutes'](_0x33a249[_0x889edd(0x2ba)][_0x889edd(0x230)]()+Number(_0x4254e7['timeUseBotQueues']));if(_0x33a249[_0x889edd(0x2ba)]!==null&&_0x33dbc9<_0x486774&&_0x4254e7['timeUseBotQueues']!=='0'&&_0x3f27b7['amountUsedBotQueues']!==0x0)return;}await _0x33a249[_0x889edd(0x204)]({'chatbotAt':null});if(_0x4254e7[_0x889edd(0x297)]!==''){const _0x3dea57=(0x0,Mustache_1[_0x889edd(0x270)])(''+_0x4254e7['outOfHoursMessage'],_0x3f27b7),_0x84c6ec=(0x0,Debounce_1[_0x889edd(0x202)])(async()=>{const _0x296d53=_0x889edd;await _0x57d497['sendMessage'](_0x3f27b7[_0x296d53(0x212)]['number']+'@'+(_0x3f27b7[_0x296d53(0x222)]?_0x296d53(0x1c8):_0x296d53(0x239)),{'text':_0x3dea57});},0x3e8,_0x3f27b7['id']);_0x84c6ec(),await _0x3f27b7[_0x889edd(0x204)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1});return;}await _0x3f27b7['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7['amountUsedBotQueues']+0x1});return;}}}catch(_0x5206b2){Sentry['captureException'](_0x5206b2),console[_0x889edd(0x278)](_0x5206b2);}!_0x3f27b7[_0x889edd(0x1d4)]&&!_0x3f27b7[_0x889edd(0x185)]&&!_0xb582a2&&!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&!_0x3f27b7[_0x889edd(0x261)]&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x4254e7['promptId'])&&await handleOpenAi(_0x4b1a00,_0x57d497,_0x3f27b7,_0x50df2d,_0x595eb8);if(!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]==='enabled')&&_0x3f27b7['queue']&&_0x3f27b7[_0x889edd(0x293)]&&_0x3f27b7[_0x889edd(0x295)]){const _0x2e9c5a=await(0x0,ShowQueueIntegrationService_1[_0x889edd(0x270)])(_0x3f27b7[_0x889edd(0x293)],_0x3e5aa2);await(0x0,exports[_0x889edd(0x2a9)])(_0x4b1a00,_0x57d497,_0x3e5aa2,_0x2e9c5a,_0x3f27b7);return;}!_0x3f27b7[_0x889edd(0x1d4)]&&!_0x3f27b7[_0x889edd(0x185)]&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]===_0x889edd(0x213))&&!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&!_0x3f27b7['userId']&&_0x4254e7['queues'][_0x889edd(0x18c)]>=0x1&&(await verifyQueue(_0x57d497,_0x4b1a00,_0x3f27b7,_0x50df2d,_0x2269a2),_0x33a249[_0x889edd(0x2ba)]===null&&await _0x33a249[_0x889edd(0x204)]({'chatbotAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)]()}));_0x3f27b7[_0x889edd(0x1dc)]>0x0&&await _0x33a249[_0x889edd(0x204)]({'queueId':_0x3f27b7['queueId']});if((getTypeMessage(_0x4b1a00)==='audioMessage'||getTypeMessage(_0x4b1a00)==='videoMessage')&&!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]===_0x889edd(0x213))&&(!_0x50df2d?.[_0x889edd(0x1ba)]||_0x2269a2?.[_0x889edd(0x16b)]==='disabled')){const _0x3225b6=await _0x57d497[_0x889edd(0x20f)](_0x50df2d[_0x889edd(0x194)]+'@c.us',{'text':_0x889edd(0x1de)},{'quoted':{'key':_0x4b1a00[_0x889edd(0x190)],'message':{'extendedTextMessage':_0x4b1a00[_0x889edd(0x1dd)][_0x889edd(0x291)]}}});await(0x0,exports[_0x889edd(0x281)])(_0x3225b6,_0x3f27b7,_0x50df2d,_0x33a249);}try{if(!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]&&_0x2269a2?.[_0x889edd(0x1f7)]&&_0x3f27b7[_0x889edd(0x1dc)]!==null&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]===_0x889edd(0x213))){const _0x3e4048=await Queue_1[_0x889edd(0x270)][_0x889edd(0x1fc)](_0x3f27b7['queueId']);_0x2269a2?.[_0x889edd(0x1f7)]===_0x889edd(0x185)&&(_0x33bc78=await(0x0,VerifyCurrentSchedule_1[_0x889edd(0x270)])(_0x3e5aa2,_0x3e4048['id'],0x0));if(_0x2269a2?.['scheduleType']===_0x889edd(0x185)&&!(0x0,lodash_1['isNil'])(_0x33bc78)&&(!_0x33bc78||_0x33bc78[_0x889edd(0x29c)]===![])){const _0x4a896b=_0x3e4048['outOfHoursMessage'];if(_0x4a896b!==''){const _0x3f109e=(0x0,Mustache_1[_0x889edd(0x270)])(''+_0x4a896b,_0x3f27b7),_0x1dc7f7=(0x0,Debounce_1[_0x889edd(0x202)])(async()=>{const _0x368231=_0x889edd;await _0x57d497[_0x368231(0x20f)](_0x3f27b7[_0x368231(0x212)][_0x368231(0x194)]+'@'+(_0x3f27b7[_0x368231(0x222)]?_0x368231(0x1c8):_0x368231(0x239)),{'text':_0x3f109e});},0x3e8,_0x3f27b7['id']);_0x1dc7f7(),await _0x3f27b7[_0x889edd(0x204)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7['amountUsedBotQueues']+0x1});return;}await _0x3f27b7['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1});return;}}}catch(_0x1837c3){Sentry[_0x889edd(0x150)](_0x1837c3),console[_0x889edd(0x278)](_0x1837c3);}_0x3f27b7[_0x889edd(0x185)]&&_0x3f27b7[_0x889edd(0x1dc)]&&!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]&&((!_0x3f27b7[_0x889edd(0x2a2)]||_0x3f27b7[_0x889edd(0x185)]?.[_0x889edd(0x1ec)]?.[_0x889edd(0x18c)]>0x0)&&await(0x0,ChatBotListener_1[_0x889edd(0x2c5)])(_0x3f27b7['queueId'],_0x57d497,_0x3f27b7,_0x50df2d,_0x4b1a00),await _0x3f27b7['update']({'sendInactiveMessage':![]})),await _0x3f27b7[_0x889edd(0x2b7)]();}catch(_0x4dafad){Sentry[_0x889edd(0x150)](_0x4dafad),console[_0x889edd(0x278)](_0x4dafad),logger_1[_0x889edd(0x171)][_0x889edd(0x1a6)](_0x889edd(0x2a6)+_0x4dafad);}};exports['handleMessage']=handleMessage;const handleMsgAck=async(_0xdb2a75,_0x1a179b)=>{const _0x57648c=a615_0x5b5b25;await new Promise(_0x2d4cf2=>setTimeout(_0x2d4cf2,0x1f4));const _0x6fa379=(0x0,socket_1['getIO'])();try{const _0xb6533d=await Message_1[_0x57648c(0x270)][_0x57648c(0x1b2)]({'where':{'wid':_0xdb2a75[_0x57648c(0x190)]['id']},'include':[_0x57648c(0x212),{'model':Message_1[_0x57648c(0x270)],'as':_0x57648c(0x27c),'include':[_0x57648c(0x212)]}]});if(!_0xb6533d)return;await _0xb6533d['update']({'ack':_0x1a179b}),_0x6fa379['to'](_0xb6533d[_0x57648c(0x1f3)][_0x57648c(0x2c9)]())[_0x57648c(0x214)](_0x57648c(0x1b6)+_0xb6533d[_0x57648c(0x2df)]+_0x57648c(0x15f),{'action':_0x57648c(0x204),'message':_0xb6533d});}catch(_0x7ceb9a){Sentry[_0x57648c(0x150)](_0x7ceb9a),logger_1['logger'][_0x57648c(0x1a6)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x7ceb9a);}},verifyRecentCampaign=async(_0x347671,_0x11a39d)=>{const _0x14707c=a615_0x5b5b25;if(!isValidMsg(_0x347671))return;if(!_0x347671[_0x14707c(0x190)][_0x14707c(0x27f)]){const _0x2b8128=_0x347671[_0x14707c(0x190)]['remoteJid']['replace'](/\D/g,''),_0x332239=await Campaign_1[_0x14707c(0x270)]['findAll']({'where':{'companyId':_0x11a39d,'status':'EM_ANDAMENTO','confirmation':!![]}});if(_0x332239){const _0x2734c1=_0x332239[_0x14707c(0x180)](_0x1e4839=>_0x1e4839['id']),_0x368188=await CampaignShipping_1['default']['findOne']({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x2734c1},'number':_0x2b8128,'confirmation':null}});_0x368188&&(await _0x368188['update']({'confirmedAt':(0x0,moment_1[_0x14707c(0x270)])(),'confirmation':!![]}),await queues_1[_0x14707c(0x1d5)][_0x14707c(0x29e)]('DispatchCampaign',{'campaignShippingId':_0x368188['id'],'campaignId':_0x368188[_0x14707c(0x1b4)]},{'delay':(0x0,queues_1[_0x14707c(0x1a7)])((0x0,queues_1[_0x14707c(0x155)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x2e0703,_0x5b898a,_0x443d0a)=>{const _0x110d6b=a615_0x5b5b25;if(!isValidMsg(_0x2e0703))return;let _0x4db260;_0x4db260=await getContactMessage(_0x2e0703,_0x443d0a);const _0x4ea4f1=await verifyContact(_0x4db260,_0x443d0a,_0x5b898a),_0x2bc3a5=(0x0,socket_1[_0x110d6b(0x2d0)])(),_0x43ef3a=await(0x0,exports['getBodyMessage'])(_0x2e0703),_0x3ca01c=/\u200c/[_0x110d6b(0x1c7)](_0x43ef3a);if(_0x2e0703[_0x110d6b(0x190)][_0x110d6b(0x27f)]&&_0x3ca01c){const _0x254917=await Message_1[_0x110d6b(0x270)][_0x110d6b(0x1b2)]({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x2e0703['key']['id']},{'contactId':_0x4ea4f1['id']}],'companyId':_0x5b898a}});if(!(0x0,lodash_1[_0x110d6b(0x1b8)])(_0x254917)||!(0x0,lodash_1[_0x110d6b(0x218)])(_0x254917)||_0x254917!==null){const _0x435e50=await Ticket_1[_0x110d6b(0x270)]['findByPk'](_0x254917[_0x110d6b(0x1f3)]);await _0x435e50[_0x110d6b(0x204)]({'status':_0x110d6b(0x1cb),'amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x2bc3a5['to'](_0x110d6b(0x2b6))[_0x110d6b(0x214)]('company-'+_0x5b898a+_0x110d6b(0x2a8),{'action':_0x110d6b(0x227),'ticket':_0x435e50,'ticketId':_0x435e50['id']}),_0x2bc3a5['to'](_0x435e50[_0x110d6b(0x1ae)])['to'](_0x435e50['id'][_0x110d6b(0x2c9)]())['emit']('company-'+_0x5b898a+_0x110d6b(0x2a8),{'action':_0x110d6b(0x204),'ticket':_0x435e50,'ticketId':_0x435e50['id']});}}},filterMessages=_0x411266=>{const _0x1666aa=a615_0x5b5b25;if(_0x411266['message']?.['protocolMessage'])return![];if([baileys_1['WAMessageStubType'][_0x1666aa(0x260)],baileys_1[_0x1666aa(0x25c)][_0x1666aa(0x219)],baileys_1[_0x1666aa(0x25c)]['E2E_IDENTITY_CHANGED'],baileys_1[_0x1666aa(0x25c)][_0x1666aa(0x15b)]][_0x1666aa(0x2dd)](_0x411266[_0x1666aa(0x1bb)]))return![];return!![];},wbotMessageListener=(_0x5086fa,_0x527498)=>{const _0x5ca89f=a615_0x5b5b25;_0x5086fa['ev']['on'](_0x5ca89f(0x1bf),async _0x430e9f=>{const _0x58b445=_0x5ca89f,_0x4b7ef1=_0x430e9f['messages'][_0x58b445(0x1ca)](filterMessages)[_0x58b445(0x180)](_0x3879ee=>_0x3879ee);if(!_0x4b7ef1)return;_0x4b7ef1[_0x58b445(0x170)](async _0x57895e=>{const _0x4da81d=_0x58b445,_0x1a6e5f=await Message_1[_0x4da81d(0x270)][_0x4da81d(0x2c6)]({'where':{'wid':_0x57895e[_0x4da81d(0x190)]['id'],'companyId':_0x527498}});if(!_0x1a6e5f){let _0x5b5e9e=![],_0x3f92a7=await(0x0,exports[_0x4da81d(0x2c4)])(_0x57895e);const _0x4af016=_0x57895e?.[_0x4da81d(0x190)]?.[_0x4da81d(0x27f)];if(_0x4af016)_0x5b5e9e=/\u200c/[_0x4da81d(0x1c7)](_0x3f92a7);else{if(/\u200c/[_0x4da81d(0x1c7)](_0x3f92a7))_0x3f92a7=_0x3f92a7[_0x4da81d(0x16d)](/\u200c/,'');logger_1['logger'][_0x4da81d(0x166)](_0x4da81d(0x2d8)+_0x3f92a7);}if(!_0x5b5e9e){await handleMessage(_0x57895e,_0x5086fa,_0x527498);return;}await verifyRecentCampaign(_0x57895e,_0x527498),await verifyCampaignMessageAndCloseTicket(_0x57895e,_0x527498,_0x5086fa);}_0x57895e[_0x4da81d(0x190)][_0x4da81d(0x241)]?.[_0x4da81d(0x2c3)](_0x4da81d(0x264))&&handleMsgAck(_0x57895e,0x2);});}),_0x5086fa['ev']['on'](_0x5ca89f(0x2dc),_0x501044=>{const _0x1f489c=_0x5ca89f;if(_0x501044['length']===0x0)return;_0x501044[_0x1f489c(0x170)](async _0x57c73f=>{const _0x4b215c=_0x1f489c;_0x5086fa[_0x4b215c(0x24b)]([_0x57c73f[_0x4b215c(0x190)]]);const _0x162c56={..._0x501044};_0x162c56['0']?.[_0x4b215c(0x204)][_0x4b215c(0x1bb)]===0x1&&_0x162c56['0']?.['key'][_0x4b215c(0x241)]!=='status@broadcast'&&(0x0,MarkDeleteWhatsAppMessage_1['default'])(_0x162c56['0']?.[_0x4b215c(0x190)][_0x4b215c(0x241)],null,_0x162c56['0']?.[_0x4b215c(0x190)]['id'],_0x527498);let _0x1fe28d;_0x57c73f['update']['status']===0x3&&_0x57c73f?.[_0x4b215c(0x190)]?.[_0x4b215c(0x27f)]?_0x1fe28d=0x2:_0x1fe28d=_0x57c73f['update'][_0x4b215c(0x1ae)],handleMsgAck(_0x57c73f,_0x1fe28d);});}),_0x5086fa['ev']['on']('groups.update',_0x5425fa=>{const _0x48055f=_0x5ca89f;if(_0x5425fa[_0x48055f(0x18c)]===0x0)return;_0x5425fa[_0x48055f(0x170)](async _0x352fe8=>{const _0x6d8283=_0x48055f,_0x30f371=_0x352fe8['id']['replace'](/\D/g,''),_0x101ba4=_0x352fe8[_0x6d8283(0x19b)]||_0x30f371;let _0x35c671;try{_0x35c671=await _0x5086fa[_0x6d8283(0x27e)](_0x352fe8['id'],_0x6d8283(0x274));}catch(_0x8c2773){Sentry['captureException'](_0x8c2773),_0x35c671=process['env'][_0x6d8283(0x265)]+_0x6d8283(0x1e4);}const _0x2b14f8={'name':_0x101ba4,'number':_0x30f371,'isGroup':!![],'companyId':_0x527498,'remoteJid':_0x352fe8['id'],'profilePicUrl':_0x35c671},_0x47e5d4=await(0x0,CreateOrUpdateContactService_1['default'])(_0x2b14f8);});});};exports[a615_0x5b5b25(0x296)]=wbotMessageListener;
>>>>>>> ab722bfbcf394d74dd0b99a984c0dcf6ffbcff7f
