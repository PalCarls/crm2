'use strict';const a615_0x5b5b25=a615_0xc8bf;(function(_0xaf85c1,_0x115c37){const _0x1138b5=a615_0xc8bf,_0x220b8b=_0xaf85c1();while(!![]){try{const _0x449b40=parseInt(_0x1138b5(0x27d))/0x1*(parseInt(_0x1138b5(0x167))/0x2)+parseInt(_0x1138b5(0x29b))/0x3*(parseInt(_0x1138b5(0x257))/0x4)+-parseInt(_0x1138b5(0x23c))/0x5+-parseInt(_0x1138b5(0x1db))/0x6*(parseInt(_0x1138b5(0x2b1))/0x7)+parseInt(_0x1138b5(0x247))/0x8*(-parseInt(_0x1138b5(0x1fe))/0x9)+-parseInt(_0x1138b5(0x2bd))/0xa+parseInt(_0x1138b5(0x23f))/0xb;if(_0x449b40===_0x115c37)break;else _0x220b8b['push'](_0x220b8b['shift']());}catch(_0x373cb2){_0x220b8b['push'](_0x220b8b['shift']());}}}(a615_0x1f9f,0xe076b));var __createBinding=this&&this[a615_0x5b5b25(0x17c)]||(Object[a615_0x5b5b25(0x1e0)]?function(_0x41740d,_0x4d3583,_0xc710d9,_0x5c9c0c){const _0x422955=a615_0x5b5b25;if(_0x5c9c0c===undefined)_0x5c9c0c=_0xc710d9;var _0x555818=Object[_0x422955(0x18d)](_0x4d3583,_0xc710d9);(!_0x555818||(_0x422955(0x232)in _0x555818?!_0x4d3583['__esModule']:_0x555818[_0x422955(0x1c1)]||_0x555818[_0x422955(0x217)]))&&(_0x555818={'enumerable':!![],'get':function(){return _0x4d3583[_0xc710d9];}}),Object[_0x422955(0x226)](_0x41740d,_0x5c9c0c,_0x555818);}:function(_0x5c04cc,_0x41eb6b,_0x3617c8,_0x28319a){if(_0x28319a===undefined)_0x28319a=_0x3617c8;_0x5c04cc[_0x28319a]=_0x41eb6b[_0x3617c8];}),__setModuleDefault=this&&this[a615_0x5b5b25(0x1b3)]||(Object[a615_0x5b5b25(0x1e0)]?function(_0x352bb2,_0x2ca365){const _0xc8a3e4=a615_0x5b5b25;Object[_0xc8a3e4(0x226)](_0x352bb2,_0xc8a3e4(0x270),{'enumerable':!![],'value':_0x2ca365});}:function(_0x444d7a,_0x454df4){_0x444d7a['default']=_0x454df4;}),__importStar=this&&this[a615_0x5b5b25(0x2a4)]||function(_0x827260){const _0xd293ff=a615_0x5b5b25;if(_0x827260&&_0x827260[_0xd293ff(0x22c)])return _0x827260;var _0x3f9df1={};if(_0x827260!=null){for(var _0x2089a7 in _0x827260)if(_0x2089a7!==_0xd293ff(0x270)&&Object['prototype']['hasOwnProperty'][_0xd293ff(0x1b0)](_0x827260,_0x2089a7))__createBinding(_0x3f9df1,_0x827260,_0x2089a7);}return __setModuleDefault(_0x3f9df1,_0x827260),_0x3f9df1;},__importDefault=this&&this[a615_0x5b5b25(0x208)]||function(_0x306a7b){const _0x33b18f=a615_0x5b5b25;return _0x306a7b&&_0x306a7b[_0x33b18f(0x22c)]?_0x306a7b:{'default':_0x306a7b};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a615_0x5b5b25(0x286)]=exports['isValidMsg']=exports[a615_0x5b5b25(0x220)]=exports[a615_0x5b5b25(0x296)]=exports['handleMessageIntegration']=exports[a615_0x5b5b25(0x237)]=exports[a615_0x5b5b25(0x18e)]=exports['verifyMessage']=exports[a615_0x5b5b25(0x149)]=exports[a615_0x5b5b25(0x2bf)]=exports[a615_0x5b5b25(0x17a)]=exports['getBodyMessage']=void 0x0;const path_1=__importStar(require(a615_0x5b5b25(0x2af))),util_1=require(a615_0x5b5b25(0x1a8)),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require('@sentry/node')),lodash_1=require('lodash'),baileys_1=require(a615_0x5b5b25(0x1a9)),Contact_1=__importDefault(require(a615_0x5b5b25(0x26a))),Ticket_1=__importDefault(require(a615_0x5b5b25(0x195))),Message_1=__importDefault(require(a615_0x5b5b25(0x294))),socket_1=require(a615_0x5b5b25(0x1d3)),CreateMessageService_1=__importDefault(require(a615_0x5b5b25(0x252))),logger_1=require(a615_0x5b5b25(0x183)),CreateOrUpdateContactService_1=__importDefault(require(a615_0x5b5b25(0x1e6))),FindOrCreateTicketService_1=__importDefault(require('../TicketServices/FindOrCreateTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),Debounce_1=require('../../helpers/Debounce'),UpdateTicketService_1=__importDefault(require(a615_0x5b5b25(0x15a))),Mustache_1=__importDefault(require('../../helpers/Mustache')),UserRating_1=__importDefault(require(a615_0x5b5b25(0x1a4))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),sendFacebookMessage_1=__importDefault(require(a615_0x5b5b25(0x2cf))),moment_1=__importDefault(require(a615_0x5b5b25(0x147))),Queue_1=__importDefault(require(a615_0x5b5b25(0x1f1))),FindOrCreateATicketTrakingService_1=__importDefault(require('../TicketServices/FindOrCreateATicketTrakingService')),VerifyCurrentSchedule_1=__importDefault(require(a615_0x5b5b25(0x2ad))),Campaign_1=__importDefault(require(a615_0x5b5b25(0x1aa))),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require(a615_0x5b5b25(0x225)),queues_1=require(a615_0x5b5b25(0x1a0)),User_1=__importDefault(require('../../models/User')),ChatBotListener_1=require(a615_0x5b5b25(0x175)),MarkDeleteWhatsAppMessage_1=__importDefault(require(a615_0x5b5b25(0x201))),ListUserQueueServices_1=__importDefault(require(a615_0x5b5b25(0x172))),cache_1=__importDefault(require(a615_0x5b5b25(0x199))),addLogs_1=require(a615_0x5b5b25(0x24c)),SendWhatsAppMedia_1=__importStar(require('./SendWhatsAppMedia')),ShowQueueIntegrationService_1=__importDefault(require(a615_0x5b5b25(0x28b))),CreateSessionDialogflow_1=require(a615_0x5b5b25(0x215)),QueryDialogflow_1=require(a615_0x5b5b25(0x186)),CompaniesSettings_1=__importDefault(require(a615_0x5b5b25(0x1e7))),CreateLogTicketService_1=__importDefault(require('../TicketServices/CreateLogTicketService')),Whatsapp_1=__importDefault(require(a615_0x5b5b25(0x164))),ShowService_1=__importDefault(require(a615_0x5b5b25(0x19f))),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require(a615_0x5b5b25(0x26e))),microsoft_cognitiveservices_speech_sdk_1=require('microsoft-cognitiveservices-speech-sdk'),os=require('os'),request=require(a615_0x5b5b25(0x21e));function a615_0x1f9f(){const _0x12123c=['contact','enabled','emit','../QueueIntegrationServices/CreateSessionDialogflow','lgpdLink','configurable','isNil','E2E_DEVICE_CHANGED','assistant','prompt','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mídia\x20verifique\x20no\x20dispositivo','isValidMsg','request',':unreads','handleMessage','jidNormalizedUser','isGroup','messageContextInfo','presenceSubscribe','sequelize','defineProperty','delete','.wav','toDate','findIndex','whatsapp','__esModule','protocolMessage','isInteger','videoMessage','getMinutes','shift','get','texto','toLocaleLowerCase','groupMetadata','promisify','handleRating','voiceRegion','s.whatsapp.net','whatsappId','win32','6472315hAGQHg','extractMessageContent','fromAudioFileOutput','27845543HGoYWZ','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posição\x20na\x20fila\x20de\x20atendimento\x20é:\x20*','remoteJid','contentText','closeTicket','description','finishedAt','.txt','1712icZhui','Erro\x20media','Error:\x20','&z=17&hl=pt-BR|','readMessages','../../helpers/addLogs',':*\x20','application/json','find','composing','recording','../MessageServices/CreateMessageService','displayText','name','facebook','button','212196pxOeIK','list','sendPresenceUpdate','TIMEOUT_TO_IMPORT_MESSAGE','>>>>>>>>>>>>>>>>>>>','WAMessageStubType','\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento','status@broadcast',';;;','REVOKE','userId','lgpdAcceptedAt','stringify','@g.us','FRONTEND_URL','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','documentMessage','\x20]*\x20-\x20','info','../../models/Contact','maxTokens','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','save','fluent-ffmpeg','buttonsResponseMessage','default','degreesLatitude','processImportMessagesWppId','title','image','Esta\x20mensagem\x20já\x20existe','ERR_WAPP_DOWNLOAD_MEDIA','endConversation','log','mkdirSync','createChatCompletion','selectedDisplayText','quotedMsg','4201mZPViW','profilePictureUrl','fromMe','vcard','verifyMessage','fileListId','quotedMessage','from','pushName','getTypeMessage','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','pt-BR-FabioNeural','voiceKey','floor','../QueueIntegrationServices/ShowQueueIntegrationService','documentWithCaptionMessage','listResponseMessage','data','Latitude:\x20','Nas\x20respostas\x20utilize\x20o\x20nome\x20','extendedTextMessage','amountUsedBotQueues','integrationId','../../models/Message','useIntegration','wbotMessageListener','outOfHoursMessage','speechSynthesisVoiceName','parameters','greetingMessage','3WTqdLc','inActivity','pending','add','temperature','Configuration','Escolha\x20uma\x20opção','user','then','__importStar','audioMessage','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','resolve','-ticket','handleMessageIntegration','entries','.mp3','maxUseBotQueuesNPS','../CompanyService/VerifyCurrentSchedule','ratingAt','path','whisper-1','2814WkbtPd','urlN8N','end','buffer','body','open','reload','Output\x20File:','.mpeg','chatbotAt','isForwarded','channel','13991510ICOelo','.ogg','getQuotedMessageId','min','Mensagem','amountUseBotQueuesNPS','endsWith','getBodyMessage','sayChatbot','count','viewOnceMessage','connection','toString','getMessageOptions','darwin','editedMessage','set','lgpdSendMessageAt','../FacebookServices/sendFacebookMessage','getIO','chmodSync','lgpdMessage','webhook','getTime','instagram','encodedAudio','options','Validação\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','keys','trim','caption','messages.update','includes','value','companyId','push','groupAsTicket','chat','moment','####\x20Nao\x20achou\x20o\x20type\x20152:\x20','verifyMediaMessage','findAndCountAll','messageTimestamp','data:image/png;base64,\x20','Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20já\x20não\x20esta\x20mais\x20disponível','sticker','paused','captureException','next','degreesLongitude','participant','split','randomValue','type','chatBotType','contacts','NFD','../TicketServices/UpdateTicketService','CIPHERTEXT','react','farewellMessage','contactId','-appMessage','OpenAIApi','nps','contactsArrayMessage','pop','../../models/Whatsapp','fromSubscription','debug','806rDFvzs','ephemeralMessage','conversation','item1.TEL:','acceptAudioMessageContact','maxMessages','replace','createReadStream','apiKey','forEach','logger','../UserQueueServices/ListUserQueueServices','lgpd','mediaType','./ChatBotListener','C:\x5cffmpeg\x5cffmpeg.exe','\x20|\x20https://maps.google.com/maps?q=','join','locationMessage','getQuotedMessage','contextInfo','__createBinding','Error\x20getTypeMessage','ratingMessage','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','map','filename','content','../../utils/logger','setExtra','queue','../QueueIntegrationServices/QueryDialogflow','indexOf','close','selectedButtonId','listMessage','unlink','length','getOwnPropertyDescriptor','verifyRating','imageMessage','key','mimetype','allowGroup','Áudio','number','../../models/Ticket','company','Error\x20handling\x20message\x20ack.\x20Err:\x20','SpeechConfig','../../libs/cache','rows','subject','now','selectedId','reactionMessage','../FileServices/ShowService','../../queues','public','values','No\x20result\x20from\x20synthesizer','../../models/UserRating','complationMessage','error','parseToMilliseconds','util','@whiskeysockets/baileys','../../models/Campaign','queryDialogFlow','base64','createdAt','status','existsSync','call','input','findOne','__setModuleDefault','campaignId','closedAt','company-','downloadMediaMessage','isNull','stickerMessage','acceptAudioMessage','messageStubType','BEGIN:','axolotlSenderKeyDistributionMessage','greetingMediaAttachment','messages.upsert','normalize','writable',':\x20📞','choices','Amigo(a)','audio/mpeg','projectName','test','g.us','\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento','filter','closed','audio','readFile','liveLocationMessage','Erro\x20ao\x20baixar\x20mídia:','enableLGPD','fileList','toISOString','../../libs/socket','imported','campaignQueue','buttons','maxUseBotQueues','7bit','contacts:','medias','9882bMOlpA','queueId','message','‎*Assistente\x20Virtual*:\x0aInfelizmente\x20não\x20conseguimos\x20escutar\x20nem\x20enviar\x20áudios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.','Menu','create','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','platform','voice','/nopicture.png','POST','../ContactServices/CreateOrUpdateContactService','../../models/CompaniesSettings','mediaMessage','delay','env','Erro\x20para\x20responder\x20com\x20audio:\x20','chatbots','warn','%2C','‎\x20*','mp3','../../models/Queue','sections','ticketId','*[\x20','gpt-3.5-turbo','@c.us','scheduleType','buttonText','stringValue','system','contactMessage','findByPk',':*\x20Não\x20consegui\x20entender\x20sua\x20dúvida.','99WyGyHJ','setMinutes','viewOnceMessageV2','./MarkDeleteWhatsAppMessage','debounce','buttonsMessage','update','substring','typebot','responses','__importDefault','Erro\x20ao\x20deletar\x20o\x20arquivo:','mediaUrl','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage','text','chatBot','sair','sendMessage','settingsUserRandom','Formato\x20de\x20arquivo\x20não\x20suportado:'];a615_0x1f9f=function(){return _0x12123c;};return a615_0x1f9f();}let ffmpegPath;if(os['platform']()===a615_0x5b5b25(0x23b))ffmpegPath=a615_0x5b5b25(0x176);else os[a615_0x5b5b25(0x1e2)]()===a615_0x5b5b25(0x2cb)?ffmpegPath='/opt/homebrew/bin/ffmpeg':ffmpegPath='/usr/bin/ffmpeg';fluent_ffmpeg_1[a615_0x5b5b25(0x270)]['setFfmpegPath'](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a615_0x5b5b25(0x236)])(fs_1['writeFile']);function removeFile(_0x32f1b0){const _0x479cb7=a615_0x5b5b25;fs_2[_0x479cb7(0x270)][_0x479cb7(0x18b)](_0x32f1b0,_0x152c94=>{if(_0x152c94)throw _0x152c94;});}const getTimestampMessage=_0x1418d6=>{return _0x1418d6*0x1;},multVecardGet=function(_0x8c4de8){const _0x23c185=a615_0x5b5b25;let _0x8729b7='\x20',_0x522834=_0x8c4de8['split']('\x0a')[0x2]['replace'](_0x23c185(0x25f),'\x0a')[_0x23c185(0x16d)]('N:','')['replace'](';','')[_0x23c185(0x16d)](';','\x20')['replace'](';;','\x20')[_0x23c185(0x16d)]('\x0a',''),_0x476149=_0x8c4de8[_0x23c185(0x154)]('\x0a')[0x4]['indexOf']('='),_0x55ab6b=_0x8c4de8[_0x23c185(0x154)]('\x0a')[0x4][_0x23c185(0x187)](':'),_0x549dc9=_0x8c4de8['split']('\x0a')[0x4][_0x23c185(0x205)](_0x476149+0x1,_0x55ab6b)[_0x23c185(0x16d)](';',''),_0x50708a=_0x8c4de8[_0x23c185(0x154)]('\x0a')[0x4]['replace'](_0x23c185(0x16a),'');if(_0x549dc9!='item1.TEL')_0x8729b7=_0x8729b7+_0x522834+_0x23c185(0x1c2)+_0x549dc9+''+'\x0a';else _0x8729b7=_0x8729b7+_0x522834+':\x20📞'+_0x50708a+''+'\x0a';return _0x8729b7;},contactsArrayMessageGet=_0x26a05f=>{const _0x2ba854=a615_0x5b5b25;let _0x1e4136=_0x26a05f['message']?.[_0x2ba854(0x162)]?.[_0x2ba854(0x158)],_0x599cc7=_0x1e4136['map'](function(_0x5406f8,_0xfc78c9){const _0x405df4=_0x2ba854;return _0x5406f8[_0x405df4(0x280)];}),_0x558aaf='';_0x599cc7['forEach'](function(_0x4384e9,_0x1efb5d){_0x558aaf+=_0x4384e9+'\x0a\x0a'+'';});let _0x43151d=_0x558aaf[_0x2ba854(0x154)](_0x2ba854(0x1bc));_0x43151d[_0x2ba854(0x231)]();let _0x4b3ad8='';for(let _0x2c0814 of _0x43151d){_0x4b3ad8=_0x4b3ad8+multVecardGet(_0x2c0814);}return _0x4b3ad8;},getTypeMessage=_0x1d9fb2=>{const _0x6243f0=a615_0x5b5b25,_0x2e20d1=(0x0,baileys_1['getContentType'])(_0x1d9fb2[_0x6243f0(0x1dd)]);if(_0x1d9fb2[_0x6243f0(0x1dd)]?.[_0x6243f0(0x200)])return _0x6243f0(0x200);return _0x2e20d1;};exports[a615_0x5b5b25(0x286)]=getTypeMessage;const getBodyButton=_0x2f139c=>{const _0x3b35f0=a615_0x5b5b25;if(_0x2f139c[_0x3b35f0(0x190)][_0x3b35f0(0x27f)]&&_0x2f139c[_0x3b35f0(0x1dd)][_0x3b35f0(0x203)]?.[_0x3b35f0(0x242)]){let _0xcf104f=''+_0x2f139c?.['message']?.[_0x3b35f0(0x203)]?.['contentText'];for(const _0x31a265 of _0x2f139c[_0x3b35f0(0x1dd)]?.['buttonsMessage']?.[_0x3b35f0(0x1d6)]){_0xcf104f+='\x0a\x0a'+_0x31a265[_0x3b35f0(0x1f8)]?.[_0x3b35f0(0x253)];}return _0xcf104f;}if(_0x2f139c[_0x3b35f0(0x190)][_0x3b35f0(0x27f)]&&_0x2f139c?.['message']?.[_0x3b35f0(0x2c7)]?.['message']?.[_0x3b35f0(0x18a)]){let _0x1d06c1=''+_0x2f139c?.[_0x3b35f0(0x1dd)]?.['viewOnceMessage']?.['message']?.[_0x3b35f0(0x18a)]?.[_0x3b35f0(0x244)];for(const _0x443074 of _0x2f139c[_0x3b35f0(0x1dd)]?.[_0x3b35f0(0x2c7)]?.[_0x3b35f0(0x1dd)]?.[_0x3b35f0(0x18a)]?.[_0x3b35f0(0x1f2)]){for(const _0x330a66 of _0x443074['rows']){_0x1d06c1+='\x0a\x0a'+_0x330a66['title'];}}return _0x1d06c1;}},getBodyList=_0x44fd41=>{const _0x2c9f5e=a615_0x5b5b25;if(_0x44fd41[_0x2c9f5e(0x190)]['fromMe']&&_0x44fd41['message'][_0x2c9f5e(0x18a)]?.[_0x2c9f5e(0x244)]){let _0x4e25c9=''+_0x44fd41[_0x2c9f5e(0x1dd)]['listMessage']?.[_0x2c9f5e(0x244)];for(const _0x114cb2 of _0x44fd41[_0x2c9f5e(0x1dd)]['listMessage']?.[_0x2c9f5e(0x1f2)]){for(const _0x30ec32 of _0x114cb2[_0x2c9f5e(0x19a)]){_0x4e25c9+='\x0a\x0a'+_0x30ec32[_0x2c9f5e(0x273)];}}return _0x4e25c9;}if(_0x44fd41[_0x2c9f5e(0x190)][_0x2c9f5e(0x27f)]&&_0x44fd41?.[_0x2c9f5e(0x1dd)]?.['viewOnceMessage']?.[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x18a)]){let _0x12aa23=''+_0x44fd41?.[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x2c7)]?.[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x18a)]?.[_0x2c9f5e(0x244)];for(const _0x5df9b0 of _0x44fd41[_0x2c9f5e(0x1dd)]?.[_0x2c9f5e(0x2c7)]?.[_0x2c9f5e(0x1dd)]?.['listMessage']?.['sections']){for(const _0x37d488 of _0x5df9b0[_0x2c9f5e(0x19a)]){_0x12aa23+='\x0a\x0a'+_0x37d488[_0x2c9f5e(0x273)];}}return _0x12aa23;}},msgLocation=(_0x361f7c,_0x492710,_0xa5b41c)=>{const _0x51793d=a615_0x5b5b25;if(_0x361f7c){var _0x169aa8=Buffer[_0x51793d(0x284)](_0x361f7c)['toString'](_0x51793d(0x1ac));let _0x2c4a24=_0x51793d(0x14c)+_0x169aa8+_0x51793d(0x177)+_0x492710+_0x51793d(0x1ee)+_0xa5b41c+_0x51793d(0x24a)+_0x492710+',\x20'+_0xa5b41c+'\x20';return _0x2c4a24;}},getBodyMessage=_0x3de033=>{const _0x17c6de=a615_0x5b5b25;try{let _0x2f0bb0=getTypeMessage(_0x3de033);if(_0x2f0bb0===undefined)console[_0x17c6de(0x278)](_0x3de033);const _0x35ccbf={'conversation':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x169)],'imageMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x18f)]?.[_0x17c6de(0x2db)],'videoMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x22f)]?.[_0x17c6de(0x2db)],'extendedTextMessage':_0x3de033?.['message']?.[_0x17c6de(0x291)]?.[_0x17c6de(0x20c)],'buttonsResponseMessage':_0x3de033['message']?.[_0x17c6de(0x26f)]?.[_0x17c6de(0x27b)],'listResponseMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x28d)]?.[_0x17c6de(0x273)]||_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x28d)]?.['singleSelectReply']?.['selectedRowId'],'templateButtonReplyMessage':_0x3de033[_0x17c6de(0x1dd)]?.['templateButtonReplyMessage']?.[_0x17c6de(0x19d)],'messageContextInfo':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x26f)]?.[_0x17c6de(0x189)]||_0x3de033['message']?.['listResponseMessage']?.[_0x17c6de(0x273)],'buttonsMessage':getBodyButton(_0x3de033)||_0x3de033['message']?.[_0x17c6de(0x28d)]?.['title'],'stickerMessage':_0x17c6de(0x14e),'contactMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x1fb)]?.[_0x17c6de(0x280)],'contactsArrayMessage':_0x3de033[_0x17c6de(0x1dd)]?.['contactsArrayMessage']?.[_0x17c6de(0x158)]&&contactsArrayMessageGet(_0x3de033),'locationMessage':msgLocation(_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x179)]?.['jpegThumbnail'],_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x179)]?.[_0x17c6de(0x271)],_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x179)]?.['degreesLongitude']),'liveLocationMessage':_0x17c6de(0x28f)+_0x3de033['message']?.[_0x17c6de(0x1ce)]?.[_0x17c6de(0x271)]+'\x20-\x20Longitude:\x20'+_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x1ce)]?.[_0x17c6de(0x152)],'documentMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x267)]?.[_0x17c6de(0x2db)],'audioMessage':_0x17c6de(0x193),'listMessage':getBodyList(_0x3de033)||_0x3de033[_0x17c6de(0x1dd)]?.['listResponseMessage']?.[_0x17c6de(0x273)],'viewOnceMessage':getBodyButton(_0x3de033),'reactionMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x19e)]?.[_0x17c6de(0x20c)]||'reaction','senderKeyDistributionMessage':_0x3de033?.['message']?.['senderKeyDistributionMessage']?.[_0x17c6de(0x1bd)],'documentWithCaptionMessage':_0x3de033[_0x17c6de(0x1dd)]?.['documentWithCaptionMessage']?.['message']?.[_0x17c6de(0x267)]?.['caption'],'viewOnceMessageV2':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x200)]?.[_0x17c6de(0x1dd)]?.['imageMessage']?.[_0x17c6de(0x2db)],'editedMessage':_0x3de033[_0x17c6de(0x1dd)]?.[_0x17c6de(0x2cc)]?.[_0x17c6de(0x1dd)]?.['extendedTextMessage']?.[_0x17c6de(0x20c)],'ephemeralMessage':_0x3de033[_0x17c6de(0x1dd)]?.['ephemeralMessage']?.[_0x17c6de(0x1dd)]?.[_0x17c6de(0x291)]?.['text']},_0x334b64=Object['keys'](_0x35ccbf)[_0x17c6de(0x24f)](_0x2306f7=>_0x2306f7===_0x2f0bb0);return!_0x334b64&&(logger_1['logger']['warn'](_0x17c6de(0x148)+_0x2f0bb0+'\x0a'+JSON['stringify'](_0x3de033)),Sentry[_0x17c6de(0x184)](_0x17c6de(0x2c1),{'BodyMsg':_0x3de033[_0x17c6de(0x1dd)],'msg':_0x3de033,'type':_0x2f0bb0}),Sentry[_0x17c6de(0x150)](new Error(_0x17c6de(0x20b)))),_0x35ccbf[_0x2f0bb0];}catch(_0x439977){Sentry[_0x17c6de(0x184)](_0x17c6de(0x17d),{'msg':_0x3de033,'BodyMsg':_0x3de033[_0x17c6de(0x1dd)]}),Sentry[_0x17c6de(0x150)](_0x439977),console[_0x17c6de(0x278)](_0x439977);}};exports[a615_0x5b5b25(0x2c4)]=getBodyMessage;const getQuotedMessage=_0x48c1db=>{const _0x4d0727=a615_0x5b5b25,_0x197469=(0x0,baileys_1[_0x4d0727(0x23d)])(_0x48c1db[_0x4d0727(0x1dd)])[Object[_0x4d0727(0x2d9)](_0x48c1db?.[_0x4d0727(0x1dd)])[_0x4d0727(0x1a2)]()[_0x4d0727(0x151)]()[_0x4d0727(0x2de)]];if(!_0x197469?.[_0x4d0727(0x17b)]?.['quotedMessage'])return;const _0x207aff=(0x0,baileys_1[_0x4d0727(0x23d)])(_0x197469?.[_0x4d0727(0x17b)]?.[_0x4d0727(0x283)][Object[_0x4d0727(0x2d9)](_0x197469?.[_0x4d0727(0x17b)]?.['quotedMessage'])[_0x4d0727(0x1a2)]()[_0x4d0727(0x151)]()['value']]);return _0x207aff;};exports[a615_0x5b5b25(0x17a)]=getQuotedMessage;function a615_0xc8bf(_0x4a1278,_0x1001f4){const _0x1f9f5f=a615_0x1f9f();return a615_0xc8bf=function(_0xc8bf99,_0x127432){_0xc8bf99=_0xc8bf99-0x146;let _0x444e70=_0x1f9f5f[_0xc8bf99];return _0x444e70;},a615_0xc8bf(_0x4a1278,_0x1001f4);}const getQuotedMessageId=_0x4a2f4e=>{const _0x595390=a615_0x5b5b25,_0x1c73d5=(0x0,baileys_1['extractMessageContent'])(_0x4a2f4e[_0x595390(0x1dd)])[Object[_0x595390(0x2d9)](_0x4a2f4e?.['message'])[_0x595390(0x1a2)]()[_0x595390(0x151)]()[_0x595390(0x2de)]];let _0x4f8d25=_0x4a2f4e?.[_0x595390(0x1dd)]?.[_0x595390(0x19e)]?_0x4a2f4e?.[_0x595390(0x1dd)]?.[_0x595390(0x19e)]?.[_0x595390(0x190)]?.['id']:'';return _0x4f8d25?_0x4f8d25:_0x1c73d5?.[_0x595390(0x17b)]?.['stanzaId'];};exports['getQuotedMessageId']=getQuotedMessageId;const getMeSocket=_0x19d060=>{const _0x54925a=a615_0x5b5b25;return{'id':(0x0,baileys_1[_0x54925a(0x221)])(_0x19d060[_0x54925a(0x2a2)]['id']),'name':_0x19d060['user'][_0x54925a(0x254)]};},getSenderMessage=(_0xc5b381,_0x151662)=>{const _0x5d6cd2=a615_0x5b5b25,_0x9a7591=getMeSocket(_0x151662);if(_0xc5b381[_0x5d6cd2(0x190)][_0x5d6cd2(0x27f)])return _0x9a7591['id'];const _0x37d470=_0xc5b381['participant']||_0xc5b381[_0x5d6cd2(0x190)][_0x5d6cd2(0x153)]||_0xc5b381[_0x5d6cd2(0x190)][_0x5d6cd2(0x241)]||undefined;return _0x37d470&&(0x0,baileys_1[_0x5d6cd2(0x221)])(_0x37d470);},getContactMessage=async(_0x7b3ee5,_0x55bbd2)=>{const _0x30fa5d=a615_0x5b5b25,_0x3bd7eb=_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x241)][_0x30fa5d(0x2dd)](_0x30fa5d(0x1c8)),_0xb1304d=_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x241)][_0x30fa5d(0x16d)](/\D/g,'');return _0x3bd7eb?{'id':getSenderMessage(_0x7b3ee5,_0x55bbd2),'name':_0x7b3ee5[_0x30fa5d(0x285)]}:{'id':_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x241)],'name':_0x7b3ee5[_0x30fa5d(0x190)][_0x30fa5d(0x27f)]?_0xb1304d:_0x7b3ee5[_0x30fa5d(0x285)]};},downloadMedia=async(_0x1a09af,_0x4b02e7=null)=>{const _0x21d8c8=a615_0x5b5b25;let _0x14e145;try{_0x14e145=await(0x0,baileys_1[_0x21d8c8(0x1b7)])(_0x1a09af,_0x21d8c8(0x2b4),{});}catch(_0x7418a4){_0x4b02e7?console[_0x21d8c8(0x278)](_0x21d8c8(0x14d)):console[_0x21d8c8(0x1a6)](_0x21d8c8(0x1cf),_0x7418a4);}let _0x521aa1=_0x1a09af['message']?.['documentMessage']?.['fileName']||'';const _0x207d0c=_0x1a09af[_0x21d8c8(0x1dd)]?.['imageMessage']||_0x1a09af[_0x21d8c8(0x1dd)]?.['audioMessage']||_0x1a09af[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x22f)]||_0x1a09af[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x1b9)]||_0x1a09af['message']?.[_0x21d8c8(0x267)]||_0x1a09af[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x28c)]?.[_0x21d8c8(0x1dd)]?.[_0x21d8c8(0x267)]||_0x1a09af['message']?.[_0x21d8c8(0x291)]?.[_0x21d8c8(0x17b)]?.[_0x21d8c8(0x283)]?.[_0x21d8c8(0x18f)]||_0x1a09af[_0x21d8c8(0x1dd)]?.['extendedTextMessage']?.[_0x21d8c8(0x17b)]?.['quotedMessage']?.[_0x21d8c8(0x22f)];if(!_0x207d0c)console[_0x21d8c8(0x278)](_0x1a09af);if(!_0x521aa1){const _0x592e92=_0x207d0c[_0x21d8c8(0x191)][_0x21d8c8(0x154)]('/')[0x1][_0x21d8c8(0x154)](';')[0x0];_0x521aa1=new Date()[_0x21d8c8(0x2d4)]()+'.'+_0x592e92;}else _0x521aa1=new Date()['getTime']()+'_'+_0x521aa1;const _0x492e21={'data':_0x14e145,'mimetype':_0x207d0c['mimetype'],'filename':_0x521aa1};return _0x492e21;},verifyContact=async(_0x15c17a,_0x4fc105,_0x139144)=>{const _0x444a10=a615_0x5b5b25;let _0x316a6d;try{_0x316a6d=await _0x4fc105[_0x444a10(0x27e)](_0x15c17a['id'],_0x444a10(0x274));}catch(_0x570a6d){Sentry[_0x444a10(0x150)](_0x570a6d),_0x316a6d=process[_0x444a10(0x1ea)][_0x444a10(0x265)]+_0x444a10(0x1e4);}const _0x9b3741={'name':_0x15c17a[_0x444a10(0x254)]||_0x15c17a['id'][_0x444a10(0x16d)](/\D/g,''),'number':_0x15c17a['id'][_0x444a10(0x16d)](/\D/g,''),'profilePicUrl':_0x316a6d,'isGroup':_0x15c17a['id'][_0x444a10(0x2dd)]('g.us'),'companyId':_0x139144,'remoteJid':_0x15c17a['id']};_0x9b3741['isGroup']&&(_0x9b3741[_0x444a10(0x194)]=_0x15c17a['id'][_0x444a10(0x16d)]('@g.us',''));const _0x36cceb=await(0x0,CreateOrUpdateContactService_1[_0x444a10(0x270)])(_0x9b3741);return _0x36cceb;},verifyQuotedMessage=async _0x275352=>{const _0x5baf51=a615_0x5b5b25;if(!_0x275352)return null;const _0x244a55=(0x0,exports['getQuotedMessageId'])(_0x275352);if(!_0x244a55)return null;const _0x4032a3=await Message_1['default'][_0x5baf51(0x1b2)]({'where':{'wid':_0x244a55}});if(!_0x4032a3)return null;return _0x4032a3;},verifyMediaMessage=async(_0x16cdce,_0x195770,_0x328e49,_0x54d8a7,_0x3dc8d7)=>{const _0x29f17c=a615_0x5b5b25,_0x28c0e0=(0x0,socket_1['getIO'])(),_0x32485e=await verifyQuotedMessage(_0x16cdce),_0x341c1d=_0x195770['companyId'];try{const _0x31b96a=await downloadMedia(_0x16cdce,_0x195770?.[_0x29f17c(0x1d4)]);if(!_0x31b96a&&_0x195770['imported']){const _0x51460b=_0x29f17c(0x21c),_0x289e93={'wid':_0x16cdce[_0x29f17c(0x190)]['id'],'ticketId':_0x195770['id'],'contactId':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x27f)]?undefined:_0x195770[_0x29f17c(0x15e)],'body':_0x51460b,'reactionMessage':_0x16cdce['message']?.['reactionMessage'],'fromMe':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x27f)],'mediaType':getTypeMessage(_0x16cdce),'read':_0x16cdce[_0x29f17c(0x190)]['fromMe'],'quotedMsgId':_0x32485e?.['id']||_0x16cdce[_0x29f17c(0x1dd)]?.[_0x29f17c(0x19e)]?.[_0x29f17c(0x190)]?.['id'],'ack':_0x16cdce[_0x29f17c(0x1ae)],'companyId':_0x341c1d,'remoteJid':_0x16cdce[_0x29f17c(0x190)]['remoteJid'],'participant':_0x16cdce[_0x29f17c(0x190)]['participant'],'timestamp':getTimestampMessage(_0x16cdce['messageTimestamp']),'createdAt':new Date(Math[_0x29f17c(0x28a)](getTimestampMessage(_0x16cdce[_0x29f17c(0x14b)])*0x3e8))[_0x29f17c(0x1d2)](),'dataJson':JSON[_0x29f17c(0x263)](_0x16cdce),'ticketImported':_0x195770['imported'],'isForwarded':_0x3dc8d7};return await _0x195770[_0x29f17c(0x204)]({'lastMessage':_0x51460b}),logger_1[_0x29f17c(0x171)][_0x29f17c(0x1a6)](Error(_0x29f17c(0x276))),(0x0,CreateMessageService_1[_0x29f17c(0x270)])({'messageData':_0x289e93,'companyId':_0x341c1d});}if(!_0x31b96a)throw new Error(_0x29f17c(0x276));if(!_0x31b96a[_0x29f17c(0x181)]){const _0x395b72=_0x31b96a[_0x29f17c(0x191)][_0x29f17c(0x154)]('/')[0x1][_0x29f17c(0x154)](';')[0x0];_0x31b96a[_0x29f17c(0x181)]=new Date()[_0x29f17c(0x2d4)]()+'.'+_0x395b72;}else{const _0x4a3b56=_0x31b96a[_0x29f17c(0x181)][_0x29f17c(0x154)]('.')[_0x29f17c(0x163)](),_0xe16dfd=_0x31b96a['filename'][_0x29f17c(0x154)]('.')['slice'](0x0,-0x1)[_0x29f17c(0x178)]('.')[_0x29f17c(0x16d)](/\s/g,'_')[_0x29f17c(0x1c0)](_0x29f17c(0x159))[_0x29f17c(0x16d)](/[\u0300-\u036f]/g,'');_0x31b96a[_0x29f17c(0x181)]=_0xe16dfd[_0x29f17c(0x2da)]()+'_'+new Date()[_0x29f17c(0x2d4)]()+'.'+_0x4a3b56;}try{const _0x1d40d6=path_1[_0x29f17c(0x270)][_0x29f17c(0x2a7)](__dirname,'..','..','..',_0x29f17c(0x1a1),_0x29f17c(0x196)+_0x341c1d);!fs_2[_0x29f17c(0x270)][_0x29f17c(0x1af)](_0x1d40d6)&&(fs_2['default'][_0x29f17c(0x279)](_0x1d40d6,{'recursive':!![]}),fs_2[_0x29f17c(0x270)][_0x29f17c(0x2d1)](_0x1d40d6,0x1ff)),await writeFileAsync((0x0,path_1['join'])(_0x1d40d6,_0x31b96a['filename']),_0x31b96a[_0x29f17c(0x28e)]['toString'](_0x29f17c(0x1ac)),_0x29f17c(0x1ac))[_0x29f17c(0x2a3)](()=>{const _0x3c83dd=_0x29f17c;console['log'](_0x31b96a[_0x3c83dd(0x191)]),console[_0x3c83dd(0x278)]('Arquivo\x20salvo\x20com\x20sucesso!');if(_0x31b96a[_0x3c83dd(0x191)][_0x3c83dd(0x2dd)](_0x3c83dd(0x1cc))){const _0x281e90=path_1[_0x3c83dd(0x270)]['join'](_0x1d40d6,_0x31b96a[_0x3c83dd(0x181)]);let _0x459f2f;if(_0x281e90[_0x3c83dd(0x2c3)](_0x3c83dd(0x2b9)))_0x459f2f=_0x281e90['replace'](_0x3c83dd(0x2b9),_0x3c83dd(0x2ab));else{if(_0x281e90['endsWith']('.ogg'))_0x459f2f=_0x281e90[_0x3c83dd(0x16d)](_0x3c83dd(0x2be),_0x3c83dd(0x2ab));else{console[_0x3c83dd(0x1a6)](_0x3c83dd(0x211),_0x281e90);return;}}return console[_0x3c83dd(0x278)]('Input\x20File:',_0x281e90),console[_0x3c83dd(0x278)](_0x3c83dd(0x2b8),_0x459f2f),new Promise((_0x5d2387,_0x70b4d0)=>{const _0x44a08b=_0x3c83dd;(0x0,fluent_ffmpeg_1[_0x44a08b(0x270)])(_0x281e90)['toFormat'](_0x44a08b(0x1f0))['save'](_0x459f2f)['on'](_0x44a08b(0x2b3),()=>{_0x5d2387();})['on'](_0x44a08b(0x1a6),_0x3c828c=>{_0x70b4d0(_0x3c828c);});});}})['then'](()=>{console['log']('Conversão\x20concluída!');});}catch(_0x28f93a){Sentry[_0x29f17c(0x184)](_0x29f17c(0x248),{'companyId':_0x341c1d,'ticket':_0x195770,'contact':_0x328e49,'media':_0x31b96a,'quotedMsg':_0x32485e}),Sentry[_0x29f17c(0x150)](_0x28f93a),logger_1[_0x29f17c(0x171)][_0x29f17c(0x1a6)](_0x28f93a),console['log'](_0x16cdce);}const _0x1bea2b=(0x0,exports['getBodyMessage'])(_0x16cdce),_0x351fb6={'wid':_0x16cdce['key']['id'],'ticketId':_0x195770['id'],'contactId':_0x16cdce['key']['fromMe']?undefined:_0x328e49['id'],'body':_0x1bea2b||_0x31b96a[_0x29f17c(0x181)],'fromMe':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x27f)],'read':_0x16cdce['key'][_0x29f17c(0x27f)],'mediaUrl':_0x31b96a['filename'],'mediaType':_0x31b96a[_0x29f17c(0x191)][_0x29f17c(0x154)]('/')[0x0],'quotedMsgId':_0x32485e?.['id'],'ack':_0x16cdce['status'],'remoteJid':_0x16cdce[_0x29f17c(0x190)]['remoteJid'],'participant':_0x16cdce[_0x29f17c(0x190)][_0x29f17c(0x153)],'dataJson':JSON['stringify'](_0x16cdce),'ticketTrakingId':_0x54d8a7?.['id'],'createdAt':new Date(Math['floor'](getTimestampMessage(_0x16cdce[_0x29f17c(0x14b)])*0x3e8))[_0x29f17c(0x1d2)](),'ticketImported':_0x195770[_0x29f17c(0x1d4)],'isForwarded':_0x3dc8d7};await _0x195770['update']({'lastMessage':_0x1bea2b||_0x31b96a[_0x29f17c(0x181)]});const _0xeb1942=await(0x0,CreateMessageService_1['default'])({'messageData':_0x351fb6,'companyId':_0x341c1d});return!_0x16cdce[_0x29f17c(0x190)]['fromMe']&&_0x195770[_0x29f17c(0x1ae)]===_0x29f17c(0x1cb)&&(await _0x195770[_0x29f17c(0x204)]({'status':_0x29f17c(0x29d)}),await _0x195770[_0x29f17c(0x2b7)]({'include':[{'model':Queue_1[_0x29f17c(0x270)],'as':_0x29f17c(0x185)},{'model':User_1['default'],'as':'user'},{'model':Contact_1[_0x29f17c(0x270)],'as':_0x29f17c(0x212)},{'model':Whatsapp_1['default'],'as':_0x29f17c(0x22b)}]}),_0x28c0e0['to'](_0x29f17c(0x1cb))[_0x29f17c(0x214)]('company-'+_0x341c1d+_0x29f17c(0x2a8),{'action':_0x29f17c(0x227),'ticket':_0x195770,'ticketId':_0x195770['id']}),_0x28c0e0['to'](_0x195770[_0x29f17c(0x1ae)])['to'](_0x195770['id'][_0x29f17c(0x2c9)]())[_0x29f17c(0x214)](_0x29f17c(0x1b6)+_0x341c1d+_0x29f17c(0x2a8),{'action':_0x29f17c(0x204),'ticket':_0x195770,'ticketId':_0x195770['id']})),_0xeb1942;}catch(_0x4494b2){console[_0x29f17c(0x278)](_0x4494b2),logger_1[_0x29f17c(0x171)][_0x29f17c(0x1ed)]('Erro\x20ao\x20baixar\x20media');}};exports[a615_0x5b5b25(0x149)]=verifyMediaMessage;const verifyMessage=async(_0x26d5f6,_0x5f19eb,_0x3e3755,_0x3987e,_0x3331ee,_0xa363d7)=>{const _0x4a66c4=a615_0x5b5b25,_0xf40fdf=(0x0,socket_1[_0x4a66c4(0x2d0)])(),_0xe198c1=await verifyQuotedMessage(_0x26d5f6),_0x7b8797=(0x0,exports['getBodyMessage'])(_0x26d5f6),_0x2d0162=_0x5f19eb[_0x4a66c4(0x2df)],_0x2ebed1={'wid':_0x26d5f6[_0x4a66c4(0x190)]['id'],'ticketId':_0x5f19eb['id'],'contactId':_0x26d5f6[_0x4a66c4(0x190)]['fromMe']?undefined:_0x3e3755['id'],'body':_0x7b8797,'fromMe':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x27f)],'mediaType':getTypeMessage(_0x26d5f6),'read':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x27f)],'quotedMsgId':_0xe198c1?.['id'],'ack':_0x26d5f6[_0x4a66c4(0x1ae)],'remoteJid':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x241)],'participant':_0x26d5f6[_0x4a66c4(0x190)][_0x4a66c4(0x153)],'dataJson':JSON[_0x4a66c4(0x263)](_0x26d5f6),'ticketTrakingId':_0x3987e?.['id'],'isPrivate':![],'createdAt':new Date(Math[_0x4a66c4(0x28a)](getTimestampMessage(_0x26d5f6['messageTimestamp'])*0x3e8))[_0x4a66c4(0x1d2)](),'ticketImported':_0x5f19eb[_0x4a66c4(0x1d4)],'isForwarded':_0xa363d7};await _0x5f19eb[_0x4a66c4(0x204)]({'lastMessage':_0x7b8797}),await(0x0,CreateMessageService_1['default'])({'messageData':_0x2ebed1,'companyId':_0x2d0162}),!_0x26d5f6['key'][_0x4a66c4(0x27f)]&&_0x5f19eb[_0x4a66c4(0x1ae)]==='closed'&&(await _0x5f19eb['update']({'status':_0x4a66c4(0x29d)}),await _0x5f19eb[_0x4a66c4(0x2b7)]({'include':[{'model':Queue_1['default'],'as':_0x4a66c4(0x185)},{'model':User_1[_0x4a66c4(0x270)],'as':'user'},{'model':Contact_1[_0x4a66c4(0x270)],'as':_0x4a66c4(0x212)},{'model':Whatsapp_1['default'],'as':_0x4a66c4(0x22b)}]}),!_0x5f19eb[_0x4a66c4(0x1d4)]&&_0xf40fdf['to'](_0x5f19eb[_0x4a66c4(0x1ae)])['to'](_0x5f19eb['id'][_0x4a66c4(0x2c9)]())[_0x4a66c4(0x214)](_0x4a66c4(0x1b6)+_0x2d0162+_0x4a66c4(0x2a8),{'action':_0x4a66c4(0x204),'ticket':_0x5f19eb,'ticketId':_0x5f19eb['id']}));};exports[a615_0x5b5b25(0x281)]=verifyMessage;const isValidMsg=_0x49d0c6=>{const _0x51dcf1=a615_0x5b5b25;if(_0x49d0c6[_0x51dcf1(0x190)][_0x51dcf1(0x241)]===_0x51dcf1(0x25e))return![];try{const _0xb30001=getTypeMessage(_0x49d0c6);if(!_0xb30001)return;const _0x2b6b76=_0xb30001===_0x51dcf1(0x169)||_0xb30001===_0x51dcf1(0x291)||_0xb30001===_0x51dcf1(0x2a5)||_0xb30001===_0x51dcf1(0x22f)||_0xb30001==='imageMessage'||_0xb30001===_0x51dcf1(0x267)||_0xb30001===_0x51dcf1(0x1b9)||_0xb30001===_0x51dcf1(0x26f)||_0xb30001===_0x51dcf1(0x203)||_0xb30001===_0x51dcf1(0x223)||_0xb30001===_0x51dcf1(0x179)||_0xb30001==='liveLocationMessage'||_0xb30001===_0x51dcf1(0x1fb)||_0xb30001==='voiceMessage'||_0xb30001===_0x51dcf1(0x1e8)||_0xb30001===_0x51dcf1(0x162)||_0xb30001==='reactionMessage'||_0xb30001===_0x51dcf1(0x168)||_0xb30001==='protocolMessage'||_0xb30001==='listResponseMessage'||_0xb30001===_0x51dcf1(0x18a)||_0xb30001===_0x51dcf1(0x2c7)||_0xb30001===_0x51dcf1(0x28c)||_0xb30001===_0x51dcf1(0x200)||_0xb30001===_0x51dcf1(0x2cc);return!_0x2b6b76&&(logger_1[_0x51dcf1(0x171)][_0x51dcf1(0x1ed)](_0x51dcf1(0x1e1)+_0xb30001+'\x0a'+JSON['stringify'](_0x49d0c6?.['message'])),Sentry[_0x51dcf1(0x184)](_0x51dcf1(0x2c1),{'BodyMsg':_0x49d0c6['message'],'msg':_0x49d0c6,'msgType':_0xb30001}),Sentry[_0x51dcf1(0x150)](new Error(_0x51dcf1(0x26c)))),!!_0x2b6b76;}catch(_0x5c93d5){Sentry[_0x51dcf1(0x184)]('Error\x20isValidMsg',{'msg':_0x49d0c6}),Sentry[_0x51dcf1(0x150)](_0x5c93d5);}};exports[a615_0x5b5b25(0x21d)]=isValidMsg;const sendDialogflowAwswer=async(_0x32716c,_0x409f13,_0x221e05,_0x32314f,_0x1784a7,_0xc09621,_0x30626f)=>{const _0xa5656e=a615_0x5b5b25,_0x202727=await(0x0,CreateSessionDialogflow_1['createDialogflowSessionWithModel'])(_0x30626f);if(_0x202727===undefined)return;_0x32716c[_0xa5656e(0x224)](_0x32314f['remoteJid']),await(0x0,baileys_1['delay'])(0x1f4);let _0x3fff19=await(0x0,QueryDialogflow_1[_0xa5656e(0x1ab)])(_0x202727,_0x30626f[_0xa5656e(0x1c6)],_0x32314f[_0xa5656e(0x241)],(0x0,exports[_0xa5656e(0x2c4)])(_0x221e05),_0x30626f['language'],_0x1784a7);if(!_0x3fff19){_0x32716c[_0xa5656e(0x259)](_0xa5656e(0x250),_0x32314f['remoteJid']);const _0x442aab=(0x0,Mustache_1[_0xa5656e(0x270)])(_0xa5656e(0x1ef)+_0x30626f?.[_0xa5656e(0x254)]+_0xa5656e(0x1fd));await(0x0,baileys_1[_0xa5656e(0x1e9)])(0x3e8),await _0x32716c[_0xa5656e(0x259)](_0xa5656e(0x14f),_0x32314f['remoteJid']);const _0xfb0cb=await _0x32716c[_0xa5656e(0x20f)](_0x32314f[_0xa5656e(0x194)]+_0xa5656e(0x1f6),{'text':_0x442aab});await(0x0,exports[_0xa5656e(0x281)])(_0xfb0cb,_0x409f13,_0x32314f);return;}_0x3fff19[_0xa5656e(0x277)]&&await _0x409f13[_0xa5656e(0x204)]({'contactId':_0x409f13[_0xa5656e(0x212)]['id'][_0xa5656e(0x2c9)](),'useIntegration':![]});const _0x59ba6a=_0x3fff19[_0xa5656e(0x299)][_0xa5656e(0x274)]?.['stringValue']??undefined,_0x2996cb=_0x3fff19['parameters'][_0xa5656e(0x15c)]?.[_0xa5656e(0x1f9)]??undefined,_0x58bc29=_0x3fff19[_0xa5656e(0x2d6)]['toString']('base64')??undefined;_0x32716c[_0xa5656e(0x259)](_0xa5656e(0x250),_0x32314f[_0xa5656e(0x241)]),await(0x0,baileys_1[_0xa5656e(0x1e9)])(0x1f4);let _0x25b07c;for(let _0x13e7c2 of _0x3fff19['responses']){_0x25b07c=_0x13e7c2[_0xa5656e(0x20c)][_0xa5656e(0x20c)][0x0]?_0x13e7c2['text'][_0xa5656e(0x20c)][0x0]:_0x25b07c;}for(let _0xd7762f of _0x3fff19[_0xa5656e(0x207)]){_0xd7762f[_0xa5656e(0x20c)]&&await sendDelayedMessages(_0x32716c,_0x409f13,_0x32314f,_0xd7762f[_0xa5656e(0x20c)][_0xa5656e(0x20c)][0x0],_0x25b07c,_0x58bc29,_0x30626f);}};async function sendDelayedMessages(_0x5aceb4,_0x396ef0,_0x25d434,_0x54ad57,_0x39ca17,_0xa47a8d,_0x28540b){const _0x31a11f=a615_0x5b5b25,_0x12a0bb=_0x396ef0['companyId'],_0xe72dab=await(0x0,ShowWhatsAppService_1[_0x31a11f(0x270)])(_0x5aceb4['id'],_0x12a0bb),_0x1ca4d9=_0xe72dab[_0x31a11f(0x15d)][_0x31a11f(0x16d)](/[_*]/g,''),_0x4f8de9=await _0x5aceb4[_0x31a11f(0x20f)](_0x25d434[_0x31a11f(0x194)]+_0x31a11f(0x1f6),{'text':_0x31a11f(0x1ef)+_0x28540b?.['name']+_0x31a11f(0x24d)+_0x54ad57});await(0x0,exports[_0x31a11f(0x281)])(_0x4f8de9,_0x396ef0,_0x25d434);if(_0x54ad57!=_0x39ca17)await(0x0,baileys_1[_0x31a11f(0x1e9)])(0x1f4),_0x5aceb4[_0x31a11f(0x259)](_0x31a11f(0x250),_0x25d434[_0x31a11f(0x241)]);else _0xa47a8d&&(_0x5aceb4[_0x31a11f(0x259)](_0x31a11f(0x251),_0x25d434[_0x31a11f(0x241)]),await(0x0,baileys_1[_0x31a11f(0x1e9)])(0x1f4),_0x1ca4d9&&_0x54ad57[_0x31a11f(0x2dd)](_0x1ca4d9)&&(await(0x0,baileys_1[_0x31a11f(0x1e9)])(0x2710),setTimeout(async()=>{const _0x18ccb6=_0x31a11f;await _0x396ef0['update']({'contactId':_0x396ef0[_0x18ccb6(0x212)]['id']['toString'](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1[_0x18ccb6(0x270)])({'ticketId':_0x396ef0['id'],'ticketData':{'status':'closed'},'companyId':_0x12a0bb});},0xbb8)));}const verifyQueue=async(_0x1a0426,_0x2d9da4,_0x11f676,_0x118a38,_0x328f17,_0x175837)=>{const _0x551899=a615_0x5b5b25,_0x374727=_0x11f676[_0x551899(0x2df)],{queues:_0x106cf3,greetingMessage:_0x42b3d7,maxUseBotQueues:_0x7e1a1a,timeUseBotQueues:_0x2945f6}=await(0x0,ShowWhatsAppService_1[_0x551899(0x270)])(_0x1a0426['id'],_0x374727);let _0xe164a7=![];_0x106cf3[_0x551899(0x18c)]===0x1&&(_0xe164a7=_0x106cf3[0x0]?.[_0x551899(0x1ec)][_0x551899(0x18c)]>0x1);const _0x806a25=_0x328f17['sendQueuePosition']===_0x551899(0x213);if(_0x106cf3[_0x551899(0x18c)]===0x1&&!_0xe164a7){const _0x273e07=_0x328f17['sendGreetingMessageOneQueues']===_0x551899(0x213)||![];if(!_0x2d9da4[_0x551899(0x190)]['fromMe']&&!_0x11f676[_0x551899(0x222)]&&_0x106cf3[0x0][_0x551899(0x293)]){const _0x1e5f01=await(0x0,ShowQueueIntegrationService_1[_0x551899(0x270)])(_0x11f676[_0x551899(0x293)],_0x374727);await(0x0,exports[_0x551899(0x2a9)])(_0x2d9da4,_0x1a0426,_0x374727,_0x1e5f01,_0x11f676),await _0x11f676[_0x551899(0x204)]({'useIntegration':!![],'integrationId':_0x1e5f01['id']});}if(_0x42b3d7['length']>0x1&&_0x273e07){const _0x472d08=(0x0,Mustache_1['default'])(''+_0x42b3d7,_0x11f676);if(_0x11f676[_0x551899(0x22b)]['greetingMediaAttachment']!==null){const _0xa55106=path_1[_0x551899(0x270)][_0x551899(0x2a7)](_0x551899(0x1a1),_0x551899(0x196)+_0x374727,_0x11f676[_0x551899(0x22b)][_0x551899(0x1be)]),_0x2c023f=_0x11f676['whatsapp'][_0x551899(0x1be)],_0x62e49d=await(0x0,SendWhatsAppMedia_1[_0x551899(0x2ca)])(_0x2c023f,_0xa55106,String(_0x374727),_0x472d08),_0x4a09cb=(0x0,Debounce_1['debounce'])(async()=>{const _0x566e62=_0x551899,_0x4554de=await _0x1a0426['sendMessage'](_0x11f676[_0x566e62(0x212)][_0x566e62(0x194)]+'@'+(_0x11f676[_0x566e62(0x222)]?'g.us':_0x566e62(0x239)),{..._0x62e49d});await(0x0,exports[_0x566e62(0x149)])(_0x4554de,_0x11f676,_0x118a38,_0x175837);},0x3e8,_0x11f676['id']);_0x4a09cb();}else await _0x1a0426['sendMessage'](_0x118a38[_0x551899(0x194)]+'@'+(_0x11f676[_0x551899(0x222)]?'g.us':_0x551899(0x239)),{'text':_0x472d08});}if(!(0x0,lodash_1[_0x551899(0x218)])(_0x106cf3[0x0][_0x551899(0x282)]))try{const _0x5cdccf=path_1[_0x551899(0x270)][_0x551899(0x2a7)](__dirname,'..','..','..',_0x551899(0x1a1)),_0x396435=await(0x0,ShowService_1['default'])(_0x106cf3[0x0][_0x551899(0x282)],_0x11f676['companyId']),_0x4384bf=path_1['default'][_0x551899(0x2a7)](_0x5cdccf,_0x551899(0x196)+_0x11f676[_0x551899(0x2df)],_0x551899(0x1d1),String(_0x396435['id']));for(const [_0x40d609,_0x563957]of _0x396435[_0x551899(0x2d7)][_0x551899(0x2aa)]()){const _0x4d5883={'fieldname':'medias','originalname':_0x563957['path'],'encoding':_0x551899(0x1d8),'mimetype':_0x563957['mediaType'],'filename':_0x563957['path'],'path':path_1['default'][_0x551899(0x2a7)](_0x4384bf,_0x563957[_0x551899(0x2af)])};await(0x0,SendWhatsAppMedia_1[_0x551899(0x270)])({'media':_0x4d5883,'ticket':_0x11f676,'body':_0x563957[_0x551899(0x254)],'isPrivate':![],'isForwarded':![]});};}catch(_0x2df1e0){logger_1['logger'][_0x551899(0x269)](_0x2df1e0);}if(_0x106cf3[0x0][_0x551899(0x243)]){await(0x0,UpdateTicketService_1[_0x551899(0x270)])({'ticketData':{'status':_0x551899(0x1cb),'queueId':_0x106cf3[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x11f676['id'],'companyId':_0x374727});return;}else await(0x0,UpdateTicketService_1[_0x551899(0x270)])({'ticketData':{'queueId':_0x106cf3[0x0]['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});const _0x219d39=await Ticket_1[_0x551899(0x270)][_0x551899(0x14a)]({'where':{'userId':null,'status':_0x551899(0x29d),'companyId':_0x374727,'queueId':_0x106cf3[0x0]['id'],'isGroup':![]}});if(_0x806a25){const _0x518762=_0x219d39[_0x551899(0x2c6)]===0x0?0x1:_0x219d39['count'],_0x1edcd8=_0x551899(0x240)+_0x518762+'*',_0x5afa9a=(0x0,Mustache_1[_0x551899(0x270)])(''+_0x1edcd8,_0x11f676),_0x4d1450=(0x0,Debounce_1[_0x551899(0x202)])(async()=>{const _0x3c4936=_0x551899;await _0x1a0426[_0x3c4936(0x20f)](_0x118a38[_0x3c4936(0x194)]+'@'+(_0x11f676[_0x3c4936(0x222)]?_0x3c4936(0x1c8):_0x3c4936(0x239)),{'text':_0x5afa9a});},0xbb8,_0x11f676['id']);_0x4d1450();}return;}if(_0x118a38['disableBot'])return;let _0x3f8fe8='';if(_0x11f676[_0x551899(0x1ae)]!=='lgpd')_0x3f8fe8=_0x2d9da4?.[_0x551899(0x1dd)]?.[_0x551899(0x26f)]?.[_0x551899(0x189)]||_0x2d9da4?.[_0x551899(0x1dd)]?.[_0x551899(0x28d)]?.['singleSelectReply']['selectedRowId']||(0x0,exports['getBodyMessage'])(_0x2d9da4);else{if(!(0x0,lodash_1[_0x551899(0x218)])(_0x11f676[_0x551899(0x262)]))await _0x11f676[_0x551899(0x204)]({'status':_0x551899(0x29d)});await _0x11f676[_0x551899(0x2b7)]();}if(_0x3f8fe8[_0x551899(0x234)]()==_0x551899(0x20e)){const _0xf9f6cc={'isBot':![],'status':_0x551899(0x1cb),'sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x551899(0x270)])({'ticketData':_0xf9f6cc,'ticketId':_0x11f676['id'],'companyId':_0x374727});return;}const _0x111532=_0xe164a7&&_0x106cf3['length']===0x1?_0x106cf3[+_0x3f8fe8]:_0x106cf3[+_0x3f8fe8-0x1];if(!_0x2d9da4['key'][_0x551899(0x27f)]&&!_0x11f676['isGroup']&&_0x111532?.[_0x551899(0x293)]){const _0x22c850=await(0x0,ShowQueueIntegrationService_1[_0x551899(0x270)])(_0x111532['integrationId'],_0x374727);await(0x0,exports[_0x551899(0x2a9)])(_0x2d9da4,_0x1a0426,_0x374727,_0x22c850,_0x11f676),await _0x11f676[_0x551899(0x204)]({'useIntegration':!![],'integrationId':_0x22c850['id']});}const _0x2a6563=_0x328f17?.[_0x551899(0x157)]||_0x551899(0x20c);let _0x301968;if(_0x111532)try{const _0x400321=await(0x0,ListUserQueueServices_1[_0x551899(0x270)])(_0x111532['id']);_0x400321[_0x551899(0x261)]>-0x1&&(_0x301968=_0x400321[_0x551899(0x261)]);}catch(_0x7a7fd6){console['error'](_0x7a7fd6);}const _0x41c5f2=async()=>{const _0x809ef3=_0x551899;if(_0x111532||_0x106cf3['length']===0x1&&_0xe164a7){const _0x44017a=await Queue_1['default']['findByPk'](_0x111532['id']);let _0x4e3f67;_0x328f17?.[_0x809ef3(0x1f7)]==='queue'&&(_0x4e3f67=await(0x0,VerifyCurrentSchedule_1[_0x809ef3(0x270)])(_0x374727,_0x44017a['id'],0x0));if(_0x328f17?.[_0x809ef3(0x1f7)]==='queue'&&!(0x0,lodash_1[_0x809ef3(0x218)])(_0x4e3f67)&&(!_0x4e3f67||_0x4e3f67[_0x809ef3(0x29c)]===![])&&(!_0x11f676['isGroup']||_0x11f676[_0x809ef3(0x22b)]?.[_0x809ef3(0x2e1)]==='enabled')){const _0x5898bc=_0x44017a[_0x809ef3(0x297)];if(_0x5898bc!==''){const _0x44d2dc=(0x0,Mustache_1[_0x809ef3(0x270)])(''+_0x5898bc,_0x11f676),_0x360fc6=(0x0,Debounce_1['debounce'])(async()=>{const _0x5cd109=_0x809ef3;await _0x1a0426[_0x5cd109(0x20f)](_0x11f676['contact'][_0x5cd109(0x194)]+'@'+(_0x11f676['isGroup']?'g.us':'s.whatsapp.net'),{'text':_0x44d2dc});},0x3e8,_0x11f676['id']);_0x360fc6(),await _0x11f676[_0x809ef3(0x204)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1});return;}await _0x11f676['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1});return;}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x111532['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});if(_0x111532[_0x809ef3(0x1ec)][_0x809ef3(0x18c)]>0x0&&!_0x11f676[_0x809ef3(0x222)]){let _0x3feee7='';_0x111532[_0x809ef3(0x1ec)][_0x809ef3(0x170)]((_0x4f7686,_0x5ef4f7)=>{const _0x23cc53=_0x809ef3;_0x3feee7+=_0x23cc53(0x1f4)+(_0x5ef4f7+0x1)+_0x23cc53(0x268)+_0x4f7686['name']+'\x0a';});const _0x2c49b3=(0x0,Mustache_1['default'])('‎'+_0x111532['greetingMessage']+'\x0a\x0a'+_0x3feee7+_0x809ef3(0x1c9),_0x11f676),_0x4c5873=await _0x1a0426['sendMessage'](_0x118a38[_0x809ef3(0x194)]+'@'+(_0x11f676[_0x809ef3(0x222)]?'g.us':_0x809ef3(0x239)),{'text':_0x2c49b3});await(0x0,exports['verifyMessage'])(_0x4c5873,_0x11f676,_0x118a38,_0x175837),_0x328f17?.[_0x809ef3(0x210)]==='enabled'&&await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'userId':_0x301968},'ticketId':_0x11f676['id'],'companyId':_0x374727});}if(!_0x111532[_0x809ef3(0x1ec)][_0x809ef3(0x18c)]&&_0x111532[_0x809ef3(0x29a)][_0x809ef3(0x18c)]!==0x0){const _0x4dd8c5=(0x0,Mustache_1['default'])('‎'+_0x111532['greetingMessage'],_0x11f676),_0x2d7ed5=await _0x1a0426[_0x809ef3(0x20f)](_0x118a38[_0x809ef3(0x194)]+'@'+(_0x11f676['isGroup']?'g.us':_0x809ef3(0x239)),{'text':_0x4dd8c5});await(0x0,exports['verifyMessage'])(_0x2d7ed5,_0x11f676,_0x118a38,_0x175837);}if(!(0x0,lodash_1['isNil'])(_0x111532['fileListId']))try{const _0x4c4c4d=path_1[_0x809ef3(0x270)][_0x809ef3(0x2a7)](__dirname,'..','..','..',_0x809ef3(0x1a1)),_0x2b4c51=await(0x0,ShowService_1[_0x809ef3(0x270)])(_0x111532[_0x809ef3(0x282)],_0x11f676[_0x809ef3(0x2df)]),_0x24acfa=path_1[_0x809ef3(0x270)][_0x809ef3(0x2a7)](_0x4c4c4d,'company'+_0x11f676[_0x809ef3(0x2df)],'fileList',String(_0x2b4c51['id']));for(const [_0x5ae410,_0x3f6c03]of _0x2b4c51[_0x809ef3(0x2d7)][_0x809ef3(0x2aa)]()){const _0x565cd6={'fieldname':_0x809ef3(0x1da),'originalname':_0x3f6c03[_0x809ef3(0x2af)],'encoding':_0x809ef3(0x1d8),'mimetype':_0x3f6c03[_0x809ef3(0x174)],'filename':_0x3f6c03[_0x809ef3(0x2af)],'path':path_1[_0x809ef3(0x270)][_0x809ef3(0x2a7)](_0x24acfa,_0x3f6c03['path'])};await(0x0,SendWhatsAppMedia_1[_0x809ef3(0x270)])({'media':_0x565cd6,'ticket':_0x11f676,'body':_0x3f6c03[_0x809ef3(0x254)],'isPrivate':![],'isForwarded':![]});};await(0x0,baileys_1[_0x809ef3(0x1e9)])(0x7d0);}catch(_0x4ac980){logger_1[_0x809ef3(0x171)][_0x809ef3(0x269)](_0x4ac980);}if(_0x111532['closeTicket']){await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'status':_0x809ef3(0x1cb),'queueId':_0x111532['id'],'sendFarewellMessage':![]},'ticketId':_0x11f676['id'],'companyId':_0x374727}),await(0x0,CreateLogTicketService_1[_0x809ef3(0x270)])({'ticketId':_0x11f676['id'],'type':_0x809ef3(0x1cb),'queueId':_0x111532['id']});return;}const _0x150338=await Ticket_1[_0x809ef3(0x270)][_0x809ef3(0x14a)]({'where':{'userId':null,'status':'pending','companyId':_0x374727,'queueId':_0x111532['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1[_0x809ef3(0x270)])({'ticketId':_0x11f676['id'],'type':_0x809ef3(0x185),'queueId':_0x111532['id']});if(_0x806a25&&!_0x111532[_0x809ef3(0x1ec)]['length']){const _0x97e7e1=_0x150338[_0x809ef3(0x2c6)]===0x0?0x1:_0x150338['count'],_0x5bbecf=_0x809ef3(0x240)+_0x97e7e1+'*',_0x26143f=(0x0,Mustache_1[_0x809ef3(0x270)])(''+_0x5bbecf,_0x11f676),_0x584cc2=(0x0,Debounce_1[_0x809ef3(0x202)])(async()=>{const _0x101023=_0x809ef3;await _0x1a0426[_0x101023(0x20f)](_0x118a38[_0x101023(0x194)]+'@'+(_0x11f676[_0x101023(0x222)]?_0x101023(0x1c8):'s.whatsapp.net'),{'text':_0x26143f});},0xbb8,_0x11f676['id']);_0x584cc2();}}else{if(_0x11f676[_0x809ef3(0x222)])return;if(_0x7e1a1a&&_0x7e1a1a!==0x0&&_0x11f676[_0x809ef3(0x292)]>=_0x7e1a1a)return;const _0x18d447=await(0x0,FindOrCreateATicketTrakingService_1[_0x809ef3(0x270)])({'ticketId':_0x11f676['id'],'companyId':_0x374727});let _0x3dbe49=new Date(),_0x25e31a=new Date();if(_0x18d447[_0x809ef3(0x2ba)]!==null){_0x3dbe49[_0x809ef3(0x1ff)](_0x18d447[_0x809ef3(0x2ba)]['getMinutes']()+Number(_0x2945f6));if(_0x18d447[_0x809ef3(0x2ba)]!==null&&_0x25e31a<_0x3dbe49&&_0x2945f6!=='0'&&_0x11f676['amountUsedBotQueues']!==0x0)return;}await _0x18d447[_0x809ef3(0x204)]({'chatbotAt':null}),_0x1a0426[_0x809ef3(0x224)](_0x118a38['remoteJid']);let _0x4728b6='';_0x1a0426[_0x809ef3(0x259)](_0x809ef3(0x250),_0x118a38[_0x809ef3(0x241)]),_0x106cf3[_0x809ef3(0x170)]((_0x534430,_0x1af98b)=>{const _0x56b5b1=_0x809ef3;_0x4728b6+=_0x56b5b1(0x1f4)+(_0x1af98b+0x1)+_0x56b5b1(0x268)+_0x534430[_0x56b5b1(0x254)]+'\x0a';}),_0x4728b6+=_0x809ef3(0x25d);const _0x3b243b=(0x0,Mustache_1[_0x809ef3(0x270)])('‎'+_0x42b3d7+'\x0a\x0a'+_0x4728b6,_0x11f676);await(0x0,CreateLogTicketService_1['default'])({'ticketId':_0x11f676['id'],'type':_0x809ef3(0x20d)}),await(0x0,baileys_1[_0x809ef3(0x1e9)])(0x3e8),await _0x1a0426['sendPresenceUpdate']('paused',_0x118a38[_0x809ef3(0x241)]);if(_0x11f676[_0x809ef3(0x22b)][_0x809ef3(0x1be)]!==null){const _0x4f0a3e=path_1['default'][_0x809ef3(0x2a7)](_0x809ef3(0x1a1),_0x809ef3(0x196)+_0x374727,_0x11f676[_0x809ef3(0x22b)]['greetingMediaAttachment']),_0x91f63f=_0x11f676[_0x809ef3(0x22b)]['greetingMediaAttachment'],_0x32ca39=await(0x0,SendWhatsAppMedia_1[_0x809ef3(0x2ca)])(_0x91f63f,_0x4f0a3e,String(_0x374727),_0x3b243b),_0x4697be=(0x0,Debounce_1[_0x809ef3(0x202)])(async()=>{const _0x41ddf6=_0x809ef3;let _0xdecc57=await _0x1a0426[_0x41ddf6(0x20f)](_0x11f676[_0x41ddf6(0x212)][_0x41ddf6(0x194)]+'@'+(_0x11f676['isGroup']?_0x41ddf6(0x1c8):_0x41ddf6(0x239)),{..._0x32ca39});await(0x0,exports['verifyMediaMessage'])(_0xdecc57,_0x11f676,_0x118a38,_0x18d447);},0x3e8,_0x11f676['id']);_0x4697be(),await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727});return;}else{const _0x118e01=(0x0,Debounce_1[_0x809ef3(0x202)])(async()=>{const _0x27ee0c=_0x809ef3,_0x2608b1=await _0x1a0426['sendMessage'](_0x118a38[_0x27ee0c(0x194)]+'@'+(_0x11f676[_0x27ee0c(0x222)]?_0x27ee0c(0x1c8):'s.whatsapp.net'),{'text':_0x3b243b});(0x0,exports['verifyMessage'])(_0x2608b1,_0x11f676,_0x118a38,_0x18d447);},0x3e8,_0x11f676['id']);await(0x0,UpdateTicketService_1[_0x809ef3(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676[_0x809ef3(0x292)]+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727}),_0x118e01();}}},_0x2feba3=async()=>{const _0x18d090=_0x551899;if(_0x111532){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x111532['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});if(_0x111532[_0x18d090(0x1ec)][_0x18d090(0x18c)]>0x0){const _0x491c9c=[];_0x111532[_0x18d090(0x1ec)][_0x18d090(0x170)]((_0xc5a018,_0x131f77)=>{const _0x5482f2=_0x18d090;_0x491c9c[_0x5482f2(0x2e0)]({'buttonId':''+(_0x131f77+0x1),'buttonText':{'displayText':_0xc5a018[_0x5482f2(0x254)]},'type':0x1});});const _0xd07248={'text':(0x0,Mustache_1[_0x18d090(0x270)])(''+_0x111532[_0x18d090(0x29a)],_0x11f676),'buttons':_0x491c9c,'headerType':0x4},_0x568899=await _0x1a0426[_0x18d090(0x20f)](_0x118a38[_0x18d090(0x194)]+'@'+(_0x11f676[_0x18d090(0x222)]?'g.us':_0x18d090(0x239)),_0xd07248);await(0x0,exports['verifyMessage'])(_0x568899,_0x11f676,_0x118a38,_0x175837);}if(!_0x111532['chatbots'][_0x18d090(0x18c)]){const _0xf40f30=(0x0,Mustache_1[_0x18d090(0x270)])(''+_0x111532[_0x18d090(0x29a)],_0x11f676),_0x207951=await _0x1a0426['sendMessage'](_0x118a38[_0x18d090(0x194)]+'@'+(_0x11f676[_0x18d090(0x222)]?_0x18d090(0x1c8):_0x18d090(0x239)),{'text':_0xf40f30});await(0x0,exports[_0x18d090(0x281)])(_0x207951,_0x11f676,_0x118a38,_0x175837);}}else{const _0x5dd1d3=[];_0x106cf3[_0x18d090(0x170)]((_0x243266,_0x341556)=>{const _0x31f839=_0x18d090;_0x5dd1d3['push']({'buttonId':''+(_0x341556+0x1),'buttonText':{'displayText':_0x243266[_0x31f839(0x254)]},'type':0x4});});const _0x2a1175={'text':(0x0,Mustache_1[_0x18d090(0x270)])(''+_0x42b3d7,_0x11f676),'footer':'','buttons':_0x5dd1d3,'headerType':0x4},_0x430382=await _0x1a0426[_0x18d090(0x20f)](_0x118a38[_0x18d090(0x194)]+'@'+(_0x11f676[_0x18d090(0x222)]?_0x18d090(0x1c8):_0x18d090(0x239)),_0x2a1175);await(0x0,exports[_0x18d090(0x281)])(_0x430382,_0x11f676,_0x118a38,_0x175837),await(0x0,UpdateTicketService_1[_0x18d090(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676[_0x18d090(0x292)]+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727});}},_0x29aea8=async()=>{const _0x1250f4=_0x551899;if(_0x111532){await(0x0,UpdateTicketService_1[_0x1250f4(0x270)])({'ticketData':{'queueId':_0x111532['id']},'ticketId':_0x11f676['id'],'companyId':_0x374727});if(_0x111532[_0x1250f4(0x1ec)]['length']>0x0){const _0x1c1faa=[];_0x111532[_0x1250f4(0x1ec)]['forEach']((_0x5cf505,_0xa82ee2)=>{const _0x34f2ed=_0x1250f4;_0x1c1faa[_0x34f2ed(0x2e0)]({'title':_0x5cf505[_0x34f2ed(0x254)],'rowId':''+(_0xa82ee2+0x1)});});const _0x1cdef8=[{'title':_0x1250f4(0x1df),'rows':_0x1c1faa}],_0x274607={'text':(0x0,Mustache_1[_0x1250f4(0x270)])(''+_0x111532[_0x1250f4(0x29a)],_0x11f676),'buttonText':'Escolha\x20uma\x20opção','sections':_0x1cdef8},_0x379462=await _0x1a0426[_0x1250f4(0x20f)](_0x118a38[_0x1250f4(0x194)]+'@'+(_0x11f676[_0x1250f4(0x222)]?_0x1250f4(0x1c8):'s.whatsapp.net'),_0x274607);await(0x0,exports[_0x1250f4(0x281)])(_0x379462,_0x11f676,_0x118a38,_0x175837);}if(!_0x111532[_0x1250f4(0x1ec)][_0x1250f4(0x18c)]){const _0x746f48=(0x0,Mustache_1[_0x1250f4(0x270)])(''+_0x111532[_0x1250f4(0x29a)],_0x11f676),_0x5a60bb=await _0x1a0426[_0x1250f4(0x20f)](_0x118a38[_0x1250f4(0x194)]+'@'+(_0x11f676[_0x1250f4(0x222)]?_0x1250f4(0x1c8):_0x1250f4(0x239)),{'text':_0x746f48});await(0x0,exports[_0x1250f4(0x281)])(_0x5a60bb,_0x11f676,_0x118a38,_0x175837);}}else{const _0x591610=[];_0x106cf3[_0x1250f4(0x170)]((_0x1d70bd,_0x1e0ace)=>{const _0x3a764d=_0x1250f4;_0x591610[_0x3a764d(0x2e0)]({'title':_0x1d70bd['name'],'rowId':''+(_0x1e0ace+0x1)});});const _0x46d1a0=[{'title':_0x1250f4(0x1df),'rows':_0x591610}],_0xe899dd={'text':(0x0,Mustache_1[_0x1250f4(0x270)])(''+_0x42b3d7,_0x11f676),'buttonText':_0x1250f4(0x2a1),'sections':_0x46d1a0},_0x40e40e=await _0x1a0426[_0x1250f4(0x20f)](_0x118a38[_0x1250f4(0x194)]+'@'+(_0x11f676[_0x1250f4(0x222)]?_0x1250f4(0x1c8):'s.whatsapp.net'),_0xe899dd);await(0x0,exports[_0x1250f4(0x281)])(_0x40e40e,_0x11f676,_0x118a38,_0x175837),await(0x0,UpdateTicketService_1[_0x1250f4(0x270)])({'ticketData':{'amountUsedBotQueues':_0x11f676['amountUsedBotQueues']+0x1},'ticketId':_0x11f676['id'],'companyId':_0x374727});}};if(_0x2a6563==='text')return _0x41c5f2();if(_0x2a6563==='button'&&_0x106cf3['length']>0x3)return _0x41c5f2();if(_0x2a6563===_0x551899(0x256)&&_0x106cf3[_0x551899(0x18c)]<=0x3)return _0x2feba3();if(_0x2a6563===_0x551899(0x258))return _0x29aea8();},verifyRating=_0x5223c7=>{const _0x2b1eda=a615_0x5b5b25;if(_0x5223c7&&_0x5223c7[_0x2b1eda(0x245)]===null&&_0x5223c7[_0x2b1eda(0x1b5)]!==null&&_0x5223c7[_0x2b1eda(0x261)]!==null&&_0x5223c7[_0x2b1eda(0x2ae)]===null)return!![];return![];};exports[a615_0x5b5b25(0x18e)]=verifyRating;const handleRating=async(_0x30cf33,_0x5d1966,_0x4626c1)=>{const _0x3fb56c=a615_0x5b5b25,_0x892c1=(0x0,socket_1['getIO'])(),_0x103bac=_0x5d1966['companyId'],{complationMessage:_0x5a59bb}=await(0x0,ShowWhatsAppService_1[_0x3fb56c(0x270)])(_0x5d1966[_0x3fb56c(0x23a)],_0x103bac);let _0xce6178=_0x30cf33;_0x30cf33<0x0&&(_0xce6178=0x0);_0x30cf33>0xa&&(_0xce6178=0xa);await UserRating_1[_0x3fb56c(0x270)][_0x3fb56c(0x1e0)]({'ticketId':_0x4626c1['ticketId'],'companyId':_0x4626c1[_0x3fb56c(0x2df)],'userId':_0x4626c1['userId'],'rate':_0xce6178});if(!(0x0,lodash_1[_0x3fb56c(0x218)])(_0x5a59bb)&&_0x5a59bb!==''&&!_0x5d1966[_0x3fb56c(0x222)]){const _0x29dbf6=(0x0,Mustache_1[_0x3fb56c(0x270)])('‎'+_0x5a59bb,_0x5d1966);if(_0x5d1966[_0x3fb56c(0x2bc)]===_0x3fb56c(0x22b)){const _0x4f3331=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x29dbf6,'ticket':_0x5d1966});await(0x0,exports[_0x3fb56c(0x281)])(_0x4f3331,_0x5d1966,_0x5d1966['contact'],_0x4626c1);}[_0x3fb56c(0x255),_0x3fb56c(0x2d5)][_0x3fb56c(0x2dd)](_0x5d1966[_0x3fb56c(0x2bc)])&&await(0x0,sendFacebookMessage_1['default'])({'body':_0x29dbf6,'ticket':_0x5d1966});}await _0x5d1966[_0x3fb56c(0x204)]({'chatbot':null,'status':_0x3fb56c(0x1cb),'amountUseBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1[_0x3fb56c(0x270)])({'userId':_0x5d1966[_0x3fb56c(0x261)],'queueId':_0x5d1966[_0x3fb56c(0x1dc)],'ticketId':_0x5d1966['id'],'type':_0x3fb56c(0x1cb)}),_0x892c1['to'](_0x3fb56c(0x2b6))['emit']('company-'+_0x103bac+_0x3fb56c(0x2a8),{'action':_0x3fb56c(0x227),'ticket':_0x5d1966,'ticketId':_0x5d1966['id']}),_0x892c1['to'](_0x5d1966[_0x3fb56c(0x1ae)])['to'](_0x5d1966['id'][_0x3fb56c(0x2c9)]())['emit']('company-'+_0x103bac+_0x3fb56c(0x2a8),{'action':_0x3fb56c(0x204),'ticket':_0x5d1966,'ticketId':_0x5d1966['id']});};exports[a615_0x5b5b25(0x237)]=handleRating;const sanitizeName=_0x377e29=>{const _0x33277e=a615_0x5b5b25;let _0x183ca3=_0x377e29[_0x33277e(0x154)]('\x20')[0x0];return _0x183ca3=_0x183ca3[_0x33277e(0x16d)](/[^a-zA-Z0-9]/g,''),_0x183ca3[_0x33277e(0x205)](0x0,0x3c);},deleteFileSync=_0x5bafdd=>{const _0x5a2cb3=a615_0x5b5b25;try{fs_2[_0x5a2cb3(0x270)]['unlinkSync'](_0x5bafdd);}catch(_0x16abc9){console[_0x5a2cb3(0x1a6)](_0x5a2cb3(0x209),_0x16abc9);}},convertTextToSpeechAndSaveToFile=(_0x485fb2,_0x28ecb5,_0x383679,_0x399d76,_0x2c41d9=a615_0x5b5b25(0x288),_0xf2a5ec='mp3')=>{return new Promise((_0x3ef0bf,_0x507350)=>{const _0x52d086=a615_0xc8bf,_0x489db4=microsoft_cognitiveservices_speech_sdk_1[_0x52d086(0x198)][_0x52d086(0x165)](_0x383679,_0x399d76);_0x489db4[_0x52d086(0x298)]=_0x2c41d9;const _0x19c657=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x52d086(0x23e)](_0x28ecb5+'.wav'),_0x5e1973=new microsoft_cognitiveservices_speech_sdk_1['SpeechSynthesizer'](_0x489db4,_0x19c657);_0x5e1973['speakTextAsync'](_0x485fb2,_0x1f8b45=>{const _0x282ffd=_0x52d086;_0x1f8b45?convertWavToAnotherFormat(_0x28ecb5+'.wav',_0x28ecb5+'.'+_0xf2a5ec,_0xf2a5ec)[_0x282ffd(0x2a3)](_0x1f8f3d=>{_0x3ef0bf();})['catch'](_0x44bc7d=>{console['error'](_0x44bc7d),_0x507350(_0x44bc7d);}):_0x507350(new Error(_0x282ffd(0x1a3))),_0x5e1973[_0x282ffd(0x188)]();},_0x415966=>{const _0xbff79d=_0x52d086;console[_0xbff79d(0x1a6)](_0xbff79d(0x249)+_0x415966),_0x5e1973[_0xbff79d(0x188)](),_0x507350(_0x415966);});});},convertWavToAnotherFormat=(_0x13e70d,_0x457c02,_0x4523f7)=>{return new Promise((_0xbc3ede,_0x52f401)=>{const _0x56e10a=a615_0xc8bf;(0x0,fluent_ffmpeg_1[_0x56e10a(0x270)])()[_0x56e10a(0x1b1)](_0x13e70d)['toFormat'](_0x4523f7)['on'](_0x56e10a(0x2b3),()=>_0xbc3ede(_0x457c02))['on']('error',_0x1c3e2b=>_0x52f401(new Error('Error\x20converting\x20file:\x20'+_0x1c3e2b['message'])))[_0x56e10a(0x26d)](_0x457c02);});},keepOnlySpecifiedChars=_0x3c4186=>{const _0x1d86c3=a615_0x5b5b25;return _0x3c4186[_0x1d86c3(0x16d)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x135fb2,_0x449a41,_0x59b17a,_0x113556,_0x2f49b9)=>{const _0x25af6f=a615_0x5b5b25,_0x24c463=(0x0,exports[_0x25af6f(0x2c4)])(_0x135fb2);if(!_0x24c463)return;const {prompt:_0x2db8f3}=await(0x0,ShowWhatsAppService_1['default'])(_0x449a41['id'],_0x59b17a[_0x25af6f(0x2df)]);if(!_0x2db8f3)return;if(_0x135fb2[_0x25af6f(0x1bb)])return;const _0x301c6e=path_1['default']['resolve'](__dirname,'..','..','..',_0x25af6f(0x1a1),'company'+_0x59b17a[_0x25af6f(0x2df)]);let _0x3e5326;const _0x5a5670=sessionsOpenAi[_0x25af6f(0x22a)](_0x25a939=>_0x25a939['id']===_0x449a41['id']);if(_0x5a5670===-0x1){const _0xeb4f07=new openai_1[(_0x25af6f(0x2a0))]({'apiKey':_0x2db8f3[_0x25af6f(0x16f)]});_0x3e5326=new openai_1[(_0x25af6f(0x160))](_0xeb4f07),_0x3e5326['id']=_0x449a41['id'],sessionsOpenAi[_0x25af6f(0x2e0)](_0x3e5326);}else _0x3e5326=sessionsOpenAi[_0x5a5670];const _0xf422b0=await Message_1[_0x25af6f(0x270)]['findAll']({'where':{'ticketId':_0x59b17a['id']},'order':[[_0x25af6f(0x1ad),'ASC']],'limit':_0x2db8f3[_0x25af6f(0x16c)]}),_0x56ec64=_0x25af6f(0x290)+sanitizeName(_0x113556['name']||_0x25af6f(0x1c4))+_0x25af6f(0x266)+_0x2db8f3[_0x25af6f(0x26b)]+_0x25af6f(0x17f)+_0x2db8f3[_0x25af6f(0x21b)]+'\x0a';let _0x33b7e9=[];if(_0x135fb2[_0x25af6f(0x1dd)]?.[_0x25af6f(0x169)]||_0x135fb2[_0x25af6f(0x1dd)]?.[_0x25af6f(0x291)]?.['text']){_0x33b7e9=[],_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x1fa),'content':_0x56ec64});for(let _0x28919f=0x0;_0x28919f<Math['min'](_0x2db8f3[_0x25af6f(0x16c)],_0xf422b0['length']);_0x28919f++){const _0x29ba1c=_0xf422b0[_0x28919f];_0x29ba1c['mediaType']===_0x25af6f(0x146)&&(_0x29ba1c[_0x25af6f(0x27f)]?_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x21a),'content':_0x29ba1c[_0x25af6f(0x2b5)]}):_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x2a2),'content':_0x29ba1c['body']}));}_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x2a2),'content':_0x24c463});const _0xb4c5e4=await _0x3e5326[_0x25af6f(0x27a)]({'model':_0x25af6f(0x1f5),'messages':_0x33b7e9,'max_tokens':_0x2db8f3[_0x25af6f(0x26b)],'temperature':_0x2db8f3[_0x25af6f(0x29f)]});let _0x8dadf6=_0xb4c5e4[_0x25af6f(0x28e)][_0x25af6f(0x1c3)][0x0][_0x25af6f(0x1dd)]?.[_0x25af6f(0x182)];_0x8dadf6?.[_0x25af6f(0x2dd)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x2db8f3[_0x25af6f(0x1dc)],_0x59b17a,_0x113556),_0x8dadf6=_0x8dadf6[_0x25af6f(0x16d)](_0x25af6f(0x287),'')['trim']());if(_0x2db8f3[_0x25af6f(0x1e3)]===_0x25af6f(0x233)){const _0x319fc9=await _0x449a41[_0x25af6f(0x20f)](_0x135fb2[_0x25af6f(0x190)][_0x25af6f(0x241)],{'text':_0x8dadf6});await(0x0,exports['verifyMessage'])(_0x319fc9,_0x59b17a,_0x113556);}else{const _0x194f8f=_0x59b17a['id']+'_'+Date[_0x25af6f(0x19c)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x8dadf6),_0x301c6e+'/'+_0x194f8f,_0x2db8f3[_0x25af6f(0x289)],_0x2db8f3[_0x25af6f(0x238)],_0x2db8f3[_0x25af6f(0x1e3)],'mp3')[_0x25af6f(0x2a3)](async()=>{const _0x3bd5ae=_0x25af6f;try{const _0x2420f1=await _0x449a41[_0x3bd5ae(0x20f)](_0x135fb2[_0x3bd5ae(0x190)][_0x3bd5ae(0x241)],{'audio':{'url':_0x301c6e+'/'+_0x194f8f+'.mp3'},'mimetype':_0x3bd5ae(0x1c5),'ptt':!![]});await(0x0,exports[_0x3bd5ae(0x149)])(_0x2420f1,_0x59b17a,_0x113556),deleteFileSync(_0x301c6e+'/'+_0x194f8f+'.mp3'),deleteFileSync(_0x301c6e+'/'+_0x194f8f+_0x3bd5ae(0x228));}catch(_0x208faf){console['log'](_0x3bd5ae(0x1eb)+_0x208faf);}});}}else{if(_0x135fb2[_0x25af6f(0x1dd)]?.[_0x25af6f(0x2a5)]){const _0x57dc3c=_0x2f49b9[_0x25af6f(0x20a)]['split']('/')[_0x25af6f(0x163)](),_0x10d38c=fs_2[_0x25af6f(0x270)][_0x25af6f(0x16e)](_0x301c6e+'/'+_0x57dc3c),_0x910cac=await _0x3e5326['createTranscription'](_0x10d38c,_0x25af6f(0x2b0));_0x33b7e9=[],_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x1fa),'content':_0x56ec64});for(let _0x248010=0x0;_0x248010<Math[_0x25af6f(0x2c0)](_0x2db8f3[_0x25af6f(0x16c)],_0xf422b0[_0x25af6f(0x18c)]);_0x248010++){const _0x1f85bf=_0xf422b0[_0x248010];_0x1f85bf[_0x25af6f(0x174)]===_0x25af6f(0x146)&&(_0x1f85bf[_0x25af6f(0x27f)]?_0x33b7e9[_0x25af6f(0x2e0)]({'role':_0x25af6f(0x21a),'content':_0x1f85bf[_0x25af6f(0x2b5)]}):_0x33b7e9['push']({'role':_0x25af6f(0x2a2),'content':_0x1f85bf[_0x25af6f(0x2b5)]}));}_0x33b7e9['push']({'role':_0x25af6f(0x2a2),'content':_0x910cac['data'][_0x25af6f(0x20c)]});const _0xa22443=await _0x3e5326[_0x25af6f(0x27a)]({'model':_0x25af6f(0x1f5),'messages':_0x33b7e9,'max_tokens':_0x2db8f3['maxTokens'],'temperature':_0x2db8f3[_0x25af6f(0x29f)]});let _0x83c00=_0xa22443['data'][_0x25af6f(0x1c3)][0x0]['message']?.[_0x25af6f(0x182)];_0x83c00?.[_0x25af6f(0x2dd)](_0x25af6f(0x287))&&(await transferQueue(_0x2db8f3[_0x25af6f(0x1dc)],_0x59b17a,_0x113556),_0x83c00=_0x83c00[_0x25af6f(0x16d)](_0x25af6f(0x287),'')[_0x25af6f(0x2da)]());if(_0x2db8f3[_0x25af6f(0x1e3)]===_0x25af6f(0x233)){const _0x378f8a=await _0x449a41[_0x25af6f(0x20f)](_0x135fb2['key']['remoteJid'],{'text':_0x83c00});await(0x0,exports['verifyMessage'])(_0x378f8a,_0x59b17a,_0x113556);}else{const _0x56ac1f=_0x59b17a['id']+'_'+Date[_0x25af6f(0x19c)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x83c00),_0x301c6e+'/'+_0x56ac1f,_0x2db8f3[_0x25af6f(0x289)],_0x2db8f3['voiceRegion'],_0x2db8f3[_0x25af6f(0x1e3)],_0x25af6f(0x1f0))[_0x25af6f(0x2a3)](async()=>{const _0x9124c5=_0x25af6f;try{const _0x3f871e=await _0x449a41[_0x9124c5(0x20f)](_0x135fb2[_0x9124c5(0x190)][_0x9124c5(0x241)],{'audio':{'url':_0x301c6e+'/'+_0x56ac1f+_0x9124c5(0x2ab)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports[_0x9124c5(0x149)])(_0x3f871e,_0x59b17a,_0x113556),deleteFileSync(_0x301c6e+'/'+_0x56ac1f+_0x9124c5(0x2ab)),deleteFileSync(_0x301c6e+'/'+_0x56ac1f+'.wav');}catch(_0x3fd1f7){console[_0x9124c5(0x278)](_0x9124c5(0x1eb)+_0x3fd1f7);}});}}}_0x33b7e9=[];},transferQueue=async(_0x3f8015,_0x31288c,_0xb568b1)=>{const _0x2a649c=a615_0x5b5b25;await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x3f8015},'ticketId':_0x31288c['id'],'companyId':_0x31288c[_0x2a649c(0x2df)]});},handleMessageIntegration=async(_0x365199,_0x806ca2,_0x1de10d,_0x3f6ca7,_0x9f0027)=>{const _0xa10f9e=a615_0x5b5b25,_0x485071=getTypeMessage(_0x365199);if(_0x3f6ca7['type']==='n8n'||_0x3f6ca7[_0xa10f9e(0x156)]===_0xa10f9e(0x2d3)){if(_0x3f6ca7?.[_0xa10f9e(0x2b2)]){const _0x5590e3={'method':_0xa10f9e(0x1e5),'url':_0x3f6ca7?.[_0xa10f9e(0x2b2)],'headers':{'Content-Type':_0xa10f9e(0x24e)},'json':_0x365199};try{request(_0x5590e3,function(_0x1d56a3,_0x3a69a7){const _0x197e6f=_0xa10f9e;if(_0x1d56a3)throw new Error(_0x1d56a3);else console[_0x197e6f(0x278)](_0x3a69a7[_0x197e6f(0x2b5)]);});}catch(_0x3e7f3b){throw new Error(_0x3e7f3b);}}}else{if(_0x3f6ca7[_0xa10f9e(0x156)]==='dialogflow'){let _0x432aa5;if(_0x485071===_0xa10f9e(0x2a5)){let _0xc09689=_0x365199[_0xa10f9e(0x14b)]+'.ogg';(0x0,fs_1[_0xa10f9e(0x1cd)])((0x0,path_1[_0xa10f9e(0x178)])(__dirname,'..','..','..',_0xa10f9e(0x1a1),'company'+_0x1de10d,_0xc09689),_0xa10f9e(0x1ac),(_0x38832e,_0x4fb78a)=>{const _0x19a8f0=_0xa10f9e;_0x432aa5=_0x4fb78a,_0x38832e&&logger_1['logger'][_0x19a8f0(0x1a6)](_0x38832e);});}else _0x432aa5=undefined;const _0x486ccb=(0x0,Debounce_1[_0xa10f9e(0x202)])(async()=>{await sendDialogflowAwswer(_0x806ca2,_0x9f0027,_0x365199,_0x9f0027['contact'],_0x432aa5,_0x1de10d,_0x3f6ca7);},0x1f4,_0x9f0027['id']);_0x486ccb();}else{if(_0x3f6ca7[_0xa10f9e(0x156)]===_0xa10f9e(0x206)){}}}};exports[a615_0x5b5b25(0x2a9)]=handleMessageIntegration;const handleMessage=async(_0x4b1a00,_0x57d497,_0x3e5aa2,_0x84a3cf=![])=>{const _0x889edd=a615_0x5b5b25;if(_0x84a3cf){(0x0,addLogs_1['addLogs'])({'fileName':_0x889edd(0x272)+_0x57d497['id']+_0x889edd(0x246),'text':'Importando\x20Mensagem:\x20'+JSON[_0x889edd(0x263)](_0x4b1a00,null,0x2)+_0x889edd(0x25b)});let _0x319acc=_0x4b1a00[_0x889edd(0x190)]['id'],_0x339c05=await Message_1[_0x889edd(0x270)][_0x889edd(0x1b2)]({'where':{'wid':_0x319acc}});if(_0x339c05){await new Promise(_0xb96b36=>setTimeout(_0xb96b36,0x96)),console[_0x889edd(0x278)](_0x889edd(0x275));return;}else await new Promise(_0x2ae0c9=>setTimeout(_0x2ae0c9,parseInt(process[_0x889edd(0x1ea)][_0x889edd(0x25a)])||0x14a));}else await new Promise(_0x2b211a=>setTimeout(_0x2b211a,i*0x28a)),i++;if(!isValidMsg(_0x4b1a00))return;try{let _0x3d42c4,_0x420ad2,_0x1b2599=0x0,_0x4ca97c=0x0,_0x462452=0x0,_0x4eb3d6=(0x0,exports[_0x889edd(0x2c4)])(_0x4b1a00);const _0x403728=getTypeMessage(_0x4b1a00);if(_0x403728==='protocolMessage')return;const _0x32bf00=_0x4b1a00['message']?.[_0x889edd(0x2a5)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x18f)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x22f)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x267)]||_0x4b1a00[_0x889edd(0x1dd)][_0x889edd(0x1b9)]||_0x4b1a00?.[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.['message']?.[_0x889edd(0x18f)]||_0x4b1a00?.[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.[_0x889edd(0x1dd)]?.['audioMessage']||_0x4b1a00?.[_0x889edd(0x1dd)]?.['ephemeralMessage']?.[_0x889edd(0x1dd)]?.[_0x889edd(0x22f)]||_0x4b1a00?.[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.['message']?.[_0x889edd(0x267)]||_0x4b1a00?.['message']?.[_0x889edd(0x168)]?.[_0x889edd(0x1dd)]?.[_0x889edd(0x1b9)]||_0x4b1a00[_0x889edd(0x1dd)]?.['viewOnceMessage']?.['message']?.[_0x889edd(0x18f)]||_0x4b1a00[_0x889edd(0x1dd)]?.['viewOnceMessage']?.[_0x889edd(0x1dd)]?.['videoMessage']||_0x4b1a00['message']?.['ephemeralMessage']?.[_0x889edd(0x1dd)]?.[_0x889edd(0x2c7)]?.[_0x889edd(0x1dd)]?.['imageMessage']||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x168)]?.[_0x889edd(0x1dd)]?.[_0x889edd(0x2c7)]?.[_0x889edd(0x1dd)]?.[_0x889edd(0x22f)]||_0x4b1a00[_0x889edd(0x1dd)]?.['documentWithCaptionMessage']?.[_0x889edd(0x1dd)]?.[_0x889edd(0x267)];if(_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]){if(/\u200e/['test'](_0x4eb3d6))return;if(!_0x32bf00&&_0x403728!==_0x889edd(0x169)&&_0x403728!=='extendedTextMessage'&&_0x403728!=='contactMessage'&&_0x403728!==_0x889edd(0x19e)&&_0x403728!==_0x889edd(0x168)&&_0x403728!==_0x889edd(0x22d)&&_0x403728!=='viewOnceMessage'&&_0x403728!==_0x889edd(0x2cc))return;_0x3d42c4=await getContactMessage(_0x4b1a00,_0x57d497);}else _0x3d42c4=await getContactMessage(_0x4b1a00,_0x57d497);const _0xb582a2=_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x241)]?.['endsWith'](_0x889edd(0x264)),_0x4254e7=await(0x0,ShowWhatsAppService_1[_0x889edd(0x270)])(_0x57d497['id'],_0x3e5aa2);if(!_0x4254e7[_0x889edd(0x192)]&&_0xb582a2)return;if(_0xb582a2){const _0x543b80=await _0x57d497[_0x889edd(0x235)](_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x241)]),_0x1a5ddc={'id':_0x543b80['id'],'name':_0x543b80['subject']};_0x420ad2=await verifyContact(_0x1a5ddc,_0x57d497,_0x3e5aa2);}const _0x50df2d=await verifyContact(_0x3d42c4,_0x57d497,_0x3e5aa2);let _0x26046a=0x0,_0x3f27b7=null;if(_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)])await cache_1['default'][_0x889edd(0x2cd)](_0x889edd(0x1d9)+_0x50df2d['id']+_0x889edd(0x21f),'0');else{const _0x2ffa90=await cache_1[_0x889edd(0x270)][_0x889edd(0x232)](_0x889edd(0x1d9)+_0x50df2d['id']+':unreads');_0x26046a=+_0x2ffa90+0x1,await cache_1[_0x889edd(0x270)]['set'](_0x889edd(0x1d9)+_0x50df2d['id']+_0x889edd(0x21f),''+_0x26046a);}const _0x2269a2=await CompaniesSettings_1['default'][_0x889edd(0x1b2)]({'where':{'companyId':_0x3e5aa2}}),_0x862f35=_0x2269a2[_0x889edd(0x1d0)]===_0x889edd(0x213),{ticket:_0x1406d7,isCreated:_0x25527a}=await(0x0,FindOrCreateTicketService_1[_0x889edd(0x270)])(_0x50df2d,_0x4254e7,_0x26046a,_0x3e5aa2,_0x1b2599,_0x462452,_0x420ad2,_0x889edd(0x22b),_0x84a3cf,![],_0x2269a2);_0x3f27b7=_0x1406d7;if(_0x3f27b7[_0x889edd(0x1ae)]===_0x889edd(0x1cb)||_0x26046a===0x0&&_0x4254e7[_0x889edd(0x1a5)]&&(0x0,Mustache_1[_0x889edd(0x270)])(_0x4254e7[_0x889edd(0x1a5)],_0x3f27b7)===_0x4eb3d6)return;if(!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]&&_0x4254e7?.['integrationId']>0x0){const _0x1e2366=await(0x0,ShowQueueIntegrationService_1['default'])(_0x4254e7[_0x889edd(0x293)],_0x3e5aa2);await(0x0,exports['handleMessageIntegration'])(_0x4b1a00,_0x57d497,_0x3e5aa2,_0x1e2366,_0x3f27b7),await _0x3f27b7['update']({'useIntegration':!![],'integrationId':_0x1e2366['id']});}if(_0x403728===_0x889edd(0x2cc)){const _0x3b6042=_0x4b1a00[_0x889edd(0x1dd)]['editedMessage'][_0x889edd(0x1dd)][_0x889edd(0x22d)][_0x889edd(0x190)]['id'],_0xb31b0f=_0x4b1a00[_0x889edd(0x1dd)][_0x889edd(0x2cc)][_0x889edd(0x1dd)][_0x889edd(0x22d)][_0x889edd(0x2cc)]['conversation'],_0x413af4=(0x0,socket_1[_0x889edd(0x2d0)])();try{const _0x3ba3c3=await Message_1[_0x889edd(0x270)][_0x889edd(0x1b2)]({'where':{'wid':_0x3b6042,'companyId':_0x3e5aa2,'ticketId':_0x3f27b7['id']}});if(!_0x3ba3c3)return;await _0x3ba3c3[_0x889edd(0x204)]({'isEdited':!![],'body':_0xb31b0f}),await _0x3f27b7[_0x889edd(0x204)]({'lastMessage':_0xb31b0f}),_0x413af4['to'](_0x3ba3c3['ticketId']['toString']())['emit']('company-'+_0x3ba3c3[_0x889edd(0x2df)]+_0x889edd(0x15f),{'action':'update','message':_0x3ba3c3});}catch(_0x4ebd27){Sentry[_0x889edd(0x150)](_0x4ebd27),logger_1[_0x889edd(0x171)][_0x889edd(0x1a6)](_0x889edd(0x197)+_0x4ebd27);}return;}const _0x33a249=await(0x0,FindOrCreateATicketTrakingService_1[_0x889edd(0x270)])({'ticketId':_0x3f27b7['id'],'companyId':_0x3e5aa2,'whatsappId':_0x4254e7?.['id']});try{if(!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]){if(_0x3f27b7[_0x889edd(0x1ae)]===_0x889edd(0x161)&&_0x33a249!==null&&(0x0,exports[_0x889edd(0x18e)])(_0x33a249)){_0x32bf00?await(0x0,exports[_0x889edd(0x149)])(_0x4b1a00,_0x3f27b7,_0x50df2d):await(0x0,exports[_0x889edd(0x281)])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249);if(!isNaN(parseFloat(_0x4eb3d6))){(0x0,exports[_0x889edd(0x237)])(parseFloat(_0x4eb3d6),_0x3f27b7,_0x33a249),await _0x33a249[_0x889edd(0x204)]({'ratingAt':(0x0,moment_1[_0x889edd(0x270)])()['toDate'](),'finishedAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)](),'rated':!![]});return;}else{if(_0x3f27b7[_0x889edd(0x2c2)]<_0x4254e7[_0x889edd(0x2ac)]){let _0x4505bc='‎Opção\x20inválida,\x20tente\x20novamente.\x0a';const _0xcb5f99=await _0x57d497[_0x889edd(0x20f)](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7[_0x889edd(0x222)]?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':_0x4505bc});(0x0,exports['verifyMessage'])(_0xcb5f99,_0x3f27b7,_0x50df2d,_0x33a249),await(0x0,baileys_1['delay'])(0x3e8);let _0x3aab90='‎'+_0x4254e7[_0x889edd(0x17e)]+'\x0a';const _0x257b9c=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3aab90,'ticket':_0x3f27b7});await(0x0,exports[_0x889edd(0x281)])(_0x257b9c,_0x3f27b7,_0x3f27b7[_0x889edd(0x212)]),await _0x3f27b7[_0x889edd(0x204)]({'amountUseBotQueuesNPS':_0x3f27b7[_0x889edd(0x2c2)]+0x1});}return;}}if(_0x862f35&&_0x3f27b7[_0x889edd(0x1ae)]===_0x889edd(0x173)&&!_0x84a3cf){if((0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x262)])&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x2ce)])){let _0x5e8e90=parseFloat(_0x4eb3d6);if(!Number['isNaN'](_0x5e8e90)&&Number[_0x889edd(0x22e)](_0x5e8e90)&&!(0x0,lodash_1[_0x889edd(0x1b8)])(_0x5e8e90)&&_0x5e8e90>0x0){if(_0x5e8e90===0x1)await _0x50df2d[_0x889edd(0x204)]({'lgpdAcceptedAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)]()}),await _0x3f27b7[_0x889edd(0x204)]({'lgpdAcceptedAt':(0x0,moment_1['default'])()[_0x889edd(0x229)](),'amountUsedBotQueues':0x0});else{if(_0x5e8e90===0x2){if(_0x4254e7['complationMessage']!==''&&_0x4254e7[_0x889edd(0x1a5)]!==undefined){const _0x5ca873=await _0x57d497['sendMessage'](_0x3f27b7[_0x889edd(0x212)]['number']+'@'+(_0x3f27b7['isGroup']?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':'‎'+_0x4254e7[_0x889edd(0x1a5)]});(0x0,exports[_0x889edd(0x281)])(_0x5ca873,_0x3f27b7,_0x50df2d,_0x33a249);}await _0x3f27b7['update']({'status':_0x889edd(0x1cb),'amountUsedBotQueues':0x0}),await _0x33a249['destroy'];return;}else _0x3f27b7[_0x889edd(0x292)]<_0x4254e7[_0x889edd(0x1d7)]&&_0x4254e7[_0x889edd(0x1d7)]>0x0&&await _0x3f27b7[_0x889edd(0x204)]({'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1,'lgpdSendMessageAt':null});}}else _0x3f27b7[_0x889edd(0x292)]<_0x4254e7[_0x889edd(0x1d7)]&&_0x4254e7[_0x889edd(0x1d7)]>0x0&&await _0x3f27b7['update']({'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1,'lgpdSendMessageAt':null});}if((_0x50df2d['lgpdAcceptedAt']===null||_0x2269a2?.['lgpdConsent']===_0x889edd(0x213))&&!_0x50df2d['isGroup']&&(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7['lgpdSendMessageAt'])&&_0x3f27b7[_0x889edd(0x292)]<=_0x4254e7['maxUseBotQueues']&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x2269a2?.[_0x889edd(0x2d2)])){_0x32bf00?await(0x0,exports[_0x889edd(0x149)])(_0x4b1a00,_0x3f27b7,_0x50df2d):await(0x0,exports[_0x889edd(0x281)])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249);if(!(0x0,lodash_1['isNil'])(_0x2269a2?.[_0x889edd(0x2d2)])&&_0x2269a2[_0x889edd(0x2d2)]!==''){const _0x2f49e8=(0x0,Mustache_1[_0x889edd(0x270)])('‎'+_0x2269a2?.[_0x889edd(0x2d2)],_0x3f27b7),_0x31abea=await _0x57d497[_0x889edd(0x20f)](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7[_0x889edd(0x222)]?_0x889edd(0x1c8):'s.whatsapp.net'),{'text':_0x2f49e8});(0x0,exports[_0x889edd(0x281)])(_0x31abea,_0x3f27b7,_0x50df2d,_0x33a249);}await(0x0,baileys_1[_0x889edd(0x1e9)])(0x3e8);if(!(0x0,lodash_1[_0x889edd(0x218)])(_0x2269a2?.[_0x889edd(0x216)])&&_0x2269a2?.['lgpdLink']!==''){const _0x1303d7=(0x0,Mustache_1[_0x889edd(0x270)])('‎'+_0x2269a2?.[_0x889edd(0x216)],_0x3f27b7),_0x1f6f5f=await _0x57d497[_0x889edd(0x20f)](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7['isGroup']?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':_0x1303d7});await(0x0,exports[_0x889edd(0x281)])(_0x1f6f5f,_0x3f27b7,_0x50df2d,_0x33a249);};await(0x0,baileys_1[_0x889edd(0x1e9)])(0x3e8);const _0x3fabc4=(0x0,Mustache_1[_0x889edd(0x270)])('‎Estou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20Não',_0x3f27b7),_0x3688e0=await _0x57d497['sendMessage'](_0x3f27b7[_0x889edd(0x212)][_0x889edd(0x194)]+'@'+(_0x3f27b7[_0x889edd(0x222)]?_0x889edd(0x1c8):_0x889edd(0x239)),{'text':_0x3fabc4});await(0x0,exports[_0x889edd(0x281)])(_0x3688e0,_0x3f27b7,_0x50df2d,_0x33a249),await _0x3f27b7[_0x889edd(0x204)]({'lgpdSendMessageAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)](),'amountUsedBotQueues':_0x3f27b7['amountUsedBotQueues']+0x1}),await _0x3f27b7[_0x889edd(0x2b7)]();return;};if(!(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x2ce)])&&(0x0,lodash_1[_0x889edd(0x218)])(_0x3f27b7[_0x889edd(0x262)]))return;}}}catch(_0x49bff4){Sentry[_0x889edd(0x150)](_0x49bff4),console[_0x889edd(0x278)](_0x49bff4);}const _0x3a60f4=_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x291)]?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x18f)]?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)]||_0x4b1a00[_0x889edd(0x1dd)]?.['audioMessage']?.[_0x889edd(0x17b)]?.['isForwarded']||_0x4b1a00[_0x889edd(0x1dd)]?.['videoMessage']?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)]||_0x4b1a00[_0x889edd(0x1dd)]?.[_0x889edd(0x267)]?.[_0x889edd(0x17b)]?.[_0x889edd(0x2bb)];let _0x595eb8;_0x32bf00?_0x595eb8=await(0x0,exports[_0x889edd(0x149)])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249,_0x3a60f4):await(0x0,exports['verifyMessage'])(_0x4b1a00,_0x3f27b7,_0x50df2d,_0x33a249,![],_0x3a60f4);try{await _0x3f27b7[_0x889edd(0x204)]({'fromMe':_0x4b1a00['key']['fromMe']});}catch(_0x3856d3){Sentry[_0x889edd(0x150)](_0x3856d3),console[_0x889edd(0x278)](_0x3856d3);}let _0x33bc78;if(_0x2269a2['scheduleType']===_0x889edd(0x196))_0x33bc78=await(0x0,VerifyCurrentSchedule_1[_0x889edd(0x270)])(_0x3e5aa2,0x0,0x0);else _0x2269a2['scheduleType']==='connection'&&(_0x33bc78=await(0x0,VerifyCurrentSchedule_1[_0x889edd(0x270)])(_0x3e5aa2,0x0,_0x4254e7['id']));try{if(!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&_0x2269a2[_0x889edd(0x1f7)]&&(!_0x3f27b7['isGroup']||_0x4254e7['groupAsTicket']===_0x889edd(0x213))){if((_0x2269a2[_0x889edd(0x1f7)]==='company'||_0x2269a2[_0x889edd(0x1f7)]===_0x889edd(0x2c8))&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x33bc78)&&(!_0x33bc78||_0x33bc78[_0x889edd(0x29c)]===![])){_0x33a249['chatbotAt']===null&&await _0x33a249[_0x889edd(0x204)]({'chatbotAt':(0x0,moment_1['default'])()[_0x889edd(0x229)]()});if(_0x4254e7[_0x889edd(0x1d7)]&&_0x4254e7['maxUseBotQueues']!==0x0&&_0x3f27b7['amountUsedBotQueues']>=_0x4254e7[_0x889edd(0x1d7)])return;let _0x486774=new Date(),_0x33dbc9=new Date();if(_0x33a249[_0x889edd(0x2ba)]!==null){_0x486774['setMinutes'](_0x33a249[_0x889edd(0x2ba)][_0x889edd(0x230)]()+Number(_0x4254e7['timeUseBotQueues']));if(_0x33a249[_0x889edd(0x2ba)]!==null&&_0x33dbc9<_0x486774&&_0x4254e7['timeUseBotQueues']!=='0'&&_0x3f27b7['amountUsedBotQueues']!==0x0)return;}await _0x33a249[_0x889edd(0x204)]({'chatbotAt':null});if(_0x4254e7[_0x889edd(0x297)]!==''){const _0x3dea57=(0x0,Mustache_1[_0x889edd(0x270)])(''+_0x4254e7['outOfHoursMessage'],_0x3f27b7),_0x84c6ec=(0x0,Debounce_1[_0x889edd(0x202)])(async()=>{const _0x296d53=_0x889edd;await _0x57d497['sendMessage'](_0x3f27b7[_0x296d53(0x212)]['number']+'@'+(_0x3f27b7[_0x296d53(0x222)]?_0x296d53(0x1c8):_0x296d53(0x239)),{'text':_0x3dea57});},0x3e8,_0x3f27b7['id']);_0x84c6ec(),await _0x3f27b7[_0x889edd(0x204)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1});return;}await _0x3f27b7['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7['amountUsedBotQueues']+0x1});return;}}}catch(_0x5206b2){Sentry['captureException'](_0x5206b2),console[_0x889edd(0x278)](_0x5206b2);}!_0x3f27b7[_0x889edd(0x1d4)]&&!_0x3f27b7[_0x889edd(0x185)]&&!_0xb582a2&&!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&!_0x3f27b7[_0x889edd(0x261)]&&!(0x0,lodash_1[_0x889edd(0x218)])(_0x4254e7['promptId'])&&await handleOpenAi(_0x4b1a00,_0x57d497,_0x3f27b7,_0x50df2d,_0x595eb8);if(!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]==='enabled')&&_0x3f27b7['queue']&&_0x3f27b7[_0x889edd(0x293)]&&_0x3f27b7[_0x889edd(0x295)]){const _0x2e9c5a=await(0x0,ShowQueueIntegrationService_1[_0x889edd(0x270)])(_0x3f27b7[_0x889edd(0x293)],_0x3e5aa2);await(0x0,exports[_0x889edd(0x2a9)])(_0x4b1a00,_0x57d497,_0x3e5aa2,_0x2e9c5a,_0x3f27b7);return;}!_0x3f27b7[_0x889edd(0x1d4)]&&!_0x3f27b7[_0x889edd(0x185)]&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]===_0x889edd(0x213))&&!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&!_0x3f27b7['userId']&&_0x4254e7['queues'][_0x889edd(0x18c)]>=0x1&&(await verifyQueue(_0x57d497,_0x4b1a00,_0x3f27b7,_0x50df2d,_0x2269a2),_0x33a249[_0x889edd(0x2ba)]===null&&await _0x33a249[_0x889edd(0x204)]({'chatbotAt':(0x0,moment_1[_0x889edd(0x270)])()[_0x889edd(0x229)]()}));_0x3f27b7[_0x889edd(0x1dc)]>0x0&&await _0x33a249[_0x889edd(0x204)]({'queueId':_0x3f27b7['queueId']});if((getTypeMessage(_0x4b1a00)==='audioMessage'||getTypeMessage(_0x4b1a00)==='videoMessage')&&!_0x4b1a00[_0x889edd(0x190)]['fromMe']&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]===_0x889edd(0x213))&&(!_0x50df2d?.[_0x889edd(0x1ba)]||_0x2269a2?.[_0x889edd(0x16b)]==='disabled')){const _0x3225b6=await _0x57d497[_0x889edd(0x20f)](_0x50df2d[_0x889edd(0x194)]+'@c.us',{'text':_0x889edd(0x1de)},{'quoted':{'key':_0x4b1a00[_0x889edd(0x190)],'message':{'extendedTextMessage':_0x4b1a00[_0x889edd(0x1dd)][_0x889edd(0x291)]}}});await(0x0,exports[_0x889edd(0x281)])(_0x3225b6,_0x3f27b7,_0x50df2d,_0x33a249);}try{if(!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]&&_0x2269a2?.[_0x889edd(0x1f7)]&&_0x3f27b7[_0x889edd(0x1dc)]!==null&&(!_0x3f27b7[_0x889edd(0x222)]||_0x4254e7[_0x889edd(0x2e1)]===_0x889edd(0x213))){const _0x3e4048=await Queue_1[_0x889edd(0x270)][_0x889edd(0x1fc)](_0x3f27b7['queueId']);_0x2269a2?.[_0x889edd(0x1f7)]===_0x889edd(0x185)&&(_0x33bc78=await(0x0,VerifyCurrentSchedule_1[_0x889edd(0x270)])(_0x3e5aa2,_0x3e4048['id'],0x0));if(_0x2269a2?.['scheduleType']===_0x889edd(0x185)&&!(0x0,lodash_1['isNil'])(_0x33bc78)&&(!_0x33bc78||_0x33bc78[_0x889edd(0x29c)]===![])){const _0x4a896b=_0x3e4048['outOfHoursMessage'];if(_0x4a896b!==''){const _0x3f109e=(0x0,Mustache_1[_0x889edd(0x270)])(''+_0x4a896b,_0x3f27b7),_0x1dc7f7=(0x0,Debounce_1[_0x889edd(0x202)])(async()=>{const _0x368231=_0x889edd;await _0x57d497[_0x368231(0x20f)](_0x3f27b7[_0x368231(0x212)][_0x368231(0x194)]+'@'+(_0x3f27b7[_0x368231(0x222)]?_0x368231(0x1c8):_0x368231(0x239)),{'text':_0x3f109e});},0x3e8,_0x3f27b7['id']);_0x1dc7f7(),await _0x3f27b7[_0x889edd(0x204)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7['amountUsedBotQueues']+0x1});return;}await _0x3f27b7['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x3f27b7[_0x889edd(0x292)]+0x1});return;}}}catch(_0x1837c3){Sentry[_0x889edd(0x150)](_0x1837c3),console[_0x889edd(0x278)](_0x1837c3);}_0x3f27b7[_0x889edd(0x185)]&&_0x3f27b7[_0x889edd(0x1dc)]&&!_0x4b1a00[_0x889edd(0x190)][_0x889edd(0x27f)]&&((!_0x3f27b7[_0x889edd(0x2a2)]||_0x3f27b7[_0x889edd(0x185)]?.[_0x889edd(0x1ec)]?.[_0x889edd(0x18c)]>0x0)&&await(0x0,ChatBotListener_1[_0x889edd(0x2c5)])(_0x3f27b7['queueId'],_0x57d497,_0x3f27b7,_0x50df2d,_0x4b1a00),await _0x3f27b7['update']({'sendInactiveMessage':![]})),await _0x3f27b7[_0x889edd(0x2b7)]();}catch(_0x4dafad){Sentry[_0x889edd(0x150)](_0x4dafad),console[_0x889edd(0x278)](_0x4dafad),logger_1[_0x889edd(0x171)][_0x889edd(0x1a6)](_0x889edd(0x2a6)+_0x4dafad);}};exports['handleMessage']=handleMessage;const handleMsgAck=async(_0xdb2a75,_0x1a179b)=>{const _0x57648c=a615_0x5b5b25;await new Promise(_0x2d4cf2=>setTimeout(_0x2d4cf2,0x1f4));const _0x6fa379=(0x0,socket_1['getIO'])();try{const _0xb6533d=await Message_1[_0x57648c(0x270)][_0x57648c(0x1b2)]({'where':{'wid':_0xdb2a75[_0x57648c(0x190)]['id']},'include':[_0x57648c(0x212),{'model':Message_1[_0x57648c(0x270)],'as':_0x57648c(0x27c),'include':[_0x57648c(0x212)]}]});if(!_0xb6533d)return;await _0xb6533d['update']({'ack':_0x1a179b}),_0x6fa379['to'](_0xb6533d[_0x57648c(0x1f3)][_0x57648c(0x2c9)]())[_0x57648c(0x214)](_0x57648c(0x1b6)+_0xb6533d[_0x57648c(0x2df)]+_0x57648c(0x15f),{'action':_0x57648c(0x204),'message':_0xb6533d});}catch(_0x7ceb9a){Sentry[_0x57648c(0x150)](_0x7ceb9a),logger_1['logger'][_0x57648c(0x1a6)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x7ceb9a);}},verifyRecentCampaign=async(_0x347671,_0x11a39d)=>{const _0x14707c=a615_0x5b5b25;if(!isValidMsg(_0x347671))return;if(!_0x347671[_0x14707c(0x190)][_0x14707c(0x27f)]){const _0x2b8128=_0x347671[_0x14707c(0x190)]['remoteJid']['replace'](/\D/g,''),_0x332239=await Campaign_1[_0x14707c(0x270)]['findAll']({'where':{'companyId':_0x11a39d,'status':'EM_ANDAMENTO','confirmation':!![]}});if(_0x332239){const _0x2734c1=_0x332239[_0x14707c(0x180)](_0x1e4839=>_0x1e4839['id']),_0x368188=await CampaignShipping_1['default']['findOne']({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x2734c1},'number':_0x2b8128,'confirmation':null}});_0x368188&&(await _0x368188['update']({'confirmedAt':(0x0,moment_1[_0x14707c(0x270)])(),'confirmation':!![]}),await queues_1[_0x14707c(0x1d5)][_0x14707c(0x29e)]('DispatchCampaign',{'campaignShippingId':_0x368188['id'],'campaignId':_0x368188[_0x14707c(0x1b4)]},{'delay':(0x0,queues_1[_0x14707c(0x1a7)])((0x0,queues_1[_0x14707c(0x155)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x2e0703,_0x5b898a,_0x443d0a)=>{const _0x110d6b=a615_0x5b5b25;if(!isValidMsg(_0x2e0703))return;let _0x4db260;_0x4db260=await getContactMessage(_0x2e0703,_0x443d0a);const _0x4ea4f1=await verifyContact(_0x4db260,_0x443d0a,_0x5b898a),_0x2bc3a5=(0x0,socket_1[_0x110d6b(0x2d0)])(),_0x43ef3a=await(0x0,exports['getBodyMessage'])(_0x2e0703),_0x3ca01c=/\u200c/[_0x110d6b(0x1c7)](_0x43ef3a);if(_0x2e0703[_0x110d6b(0x190)][_0x110d6b(0x27f)]&&_0x3ca01c){const _0x254917=await Message_1[_0x110d6b(0x270)][_0x110d6b(0x1b2)]({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x2e0703['key']['id']},{'contactId':_0x4ea4f1['id']}],'companyId':_0x5b898a}});if(!(0x0,lodash_1[_0x110d6b(0x1b8)])(_0x254917)||!(0x0,lodash_1[_0x110d6b(0x218)])(_0x254917)||_0x254917!==null){const _0x435e50=await Ticket_1[_0x110d6b(0x270)]['findByPk'](_0x254917[_0x110d6b(0x1f3)]);await _0x435e50[_0x110d6b(0x204)]({'status':_0x110d6b(0x1cb),'amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x2bc3a5['to'](_0x110d6b(0x2b6))[_0x110d6b(0x214)]('company-'+_0x5b898a+_0x110d6b(0x2a8),{'action':_0x110d6b(0x227),'ticket':_0x435e50,'ticketId':_0x435e50['id']}),_0x2bc3a5['to'](_0x435e50[_0x110d6b(0x1ae)])['to'](_0x435e50['id'][_0x110d6b(0x2c9)]())['emit']('company-'+_0x5b898a+_0x110d6b(0x2a8),{'action':_0x110d6b(0x204),'ticket':_0x435e50,'ticketId':_0x435e50['id']});}}},filterMessages=_0x411266=>{const _0x1666aa=a615_0x5b5b25;if(_0x411266['message']?.['protocolMessage'])return![];if([baileys_1['WAMessageStubType'][_0x1666aa(0x260)],baileys_1[_0x1666aa(0x25c)][_0x1666aa(0x219)],baileys_1[_0x1666aa(0x25c)]['E2E_IDENTITY_CHANGED'],baileys_1[_0x1666aa(0x25c)][_0x1666aa(0x15b)]][_0x1666aa(0x2dd)](_0x411266[_0x1666aa(0x1bb)]))return![];return!![];},wbotMessageListener=(_0x5086fa,_0x527498)=>{const _0x5ca89f=a615_0x5b5b25;_0x5086fa['ev']['on'](_0x5ca89f(0x1bf),async _0x430e9f=>{const _0x58b445=_0x5ca89f,_0x4b7ef1=_0x430e9f['messages'][_0x58b445(0x1ca)](filterMessages)[_0x58b445(0x180)](_0x3879ee=>_0x3879ee);if(!_0x4b7ef1)return;_0x4b7ef1[_0x58b445(0x170)](async _0x57895e=>{const _0x4da81d=_0x58b445,_0x1a6e5f=await Message_1[_0x4da81d(0x270)][_0x4da81d(0x2c6)]({'where':{'wid':_0x57895e[_0x4da81d(0x190)]['id'],'companyId':_0x527498}});if(!_0x1a6e5f){let _0x5b5e9e=![],_0x3f92a7=await(0x0,exports[_0x4da81d(0x2c4)])(_0x57895e);const _0x4af016=_0x57895e?.[_0x4da81d(0x190)]?.[_0x4da81d(0x27f)];if(_0x4af016)_0x5b5e9e=/\u200c/[_0x4da81d(0x1c7)](_0x3f92a7);else{if(/\u200c/[_0x4da81d(0x1c7)](_0x3f92a7))_0x3f92a7=_0x3f92a7[_0x4da81d(0x16d)](/\u200c/,'');logger_1['logger'][_0x4da81d(0x166)](_0x4da81d(0x2d8)+_0x3f92a7);}if(!_0x5b5e9e){await handleMessage(_0x57895e,_0x5086fa,_0x527498);return;}await verifyRecentCampaign(_0x57895e,_0x527498),await verifyCampaignMessageAndCloseTicket(_0x57895e,_0x527498,_0x5086fa);}_0x57895e[_0x4da81d(0x190)][_0x4da81d(0x241)]?.[_0x4da81d(0x2c3)](_0x4da81d(0x264))&&handleMsgAck(_0x57895e,0x2);});}),_0x5086fa['ev']['on'](_0x5ca89f(0x2dc),_0x501044=>{const _0x1f489c=_0x5ca89f;if(_0x501044['length']===0x0)return;_0x501044[_0x1f489c(0x170)](async _0x57c73f=>{const _0x4b215c=_0x1f489c;_0x5086fa[_0x4b215c(0x24b)]([_0x57c73f[_0x4b215c(0x190)]]);const _0x162c56={..._0x501044};_0x162c56['0']?.[_0x4b215c(0x204)][_0x4b215c(0x1bb)]===0x1&&_0x162c56['0']?.['key'][_0x4b215c(0x241)]!=='status@broadcast'&&(0x0,MarkDeleteWhatsAppMessage_1['default'])(_0x162c56['0']?.[_0x4b215c(0x190)][_0x4b215c(0x241)],null,_0x162c56['0']?.[_0x4b215c(0x190)]['id'],_0x527498);let _0x1fe28d;_0x57c73f['update']['status']===0x3&&_0x57c73f?.[_0x4b215c(0x190)]?.[_0x4b215c(0x27f)]?_0x1fe28d=0x2:_0x1fe28d=_0x57c73f['update'][_0x4b215c(0x1ae)],handleMsgAck(_0x57c73f,_0x1fe28d);});}),_0x5086fa['ev']['on']('groups.update',_0x5425fa=>{const _0x48055f=_0x5ca89f;if(_0x5425fa[_0x48055f(0x18c)]===0x0)return;_0x5425fa[_0x48055f(0x170)](async _0x352fe8=>{const _0x6d8283=_0x48055f,_0x30f371=_0x352fe8['id']['replace'](/\D/g,''),_0x101ba4=_0x352fe8[_0x6d8283(0x19b)]||_0x30f371;let _0x35c671;try{_0x35c671=await _0x5086fa[_0x6d8283(0x27e)](_0x352fe8['id'],_0x6d8283(0x274));}catch(_0x8c2773){Sentry['captureException'](_0x8c2773),_0x35c671=process['env'][_0x6d8283(0x265)]+_0x6d8283(0x1e4);}const _0x2b14f8={'name':_0x101ba4,'number':_0x30f371,'isGroup':!![],'companyId':_0x527498,'remoteJid':_0x352fe8['id'],'profilePicUrl':_0x35c671},_0x47e5d4=await(0x0,CreateOrUpdateContactService_1['default'])(_0x2b14f8);});});};exports[a615_0x5b5b25(0x296)]=wbotMessageListener;