'use strict';const a627_0x2ed45c=a627_0x4baf;(function(_0x432259,_0x22e8c3){const _0x1a3869=a627_0x4baf,_0x4337cb=_0x432259();while(!![]){try{const _0x146ec0=-parseInt(_0x1a3869(0x165))/0x1+parseInt(_0x1a3869(0x219))/0x2*(parseInt(_0x1a3869(0x2e7))/0x3)+parseInt(_0x1a3869(0x21c))/0x4*(-parseInt(_0x1a3869(0x2d8))/0x5)+-parseInt(_0x1a3869(0x1ae))/0x6*(parseInt(_0x1a3869(0x260))/0x7)+parseInt(_0x1a3869(0x285))/0x8*(parseInt(_0x1a3869(0x243))/0x9)+parseInt(_0x1a3869(0x1b7))/0xa+parseInt(_0x1a3869(0x25b))/0xb*(-parseInt(_0x1a3869(0x2c3))/0xc);if(_0x146ec0===_0x22e8c3)break;else _0x4337cb['push'](_0x4337cb['shift']());}catch(_0x33b62d){_0x4337cb['push'](_0x4337cb['shift']());}}}(a627_0x5c88,0x3ef90));var __createBinding=this&&this['__createBinding']||(Object[a627_0x2ed45c(0x19e)]?function(_0x24401c,_0x507966,_0x26a298,_0x1f07ea){const _0xfd582e=a627_0x2ed45c;if(_0x1f07ea===undefined)_0x1f07ea=_0x26a298;var _0x53fffa=Object['getOwnPropertyDescriptor'](_0x507966,_0x26a298);(!_0x53fffa||(_0xfd582e(0x287)in _0x53fffa?!_0x507966[_0xfd582e(0x2f0)]:_0x53fffa[_0xfd582e(0x257)]||_0x53fffa[_0xfd582e(0x188)]))&&(_0x53fffa={'enumerable':!![],'get':function(){return _0x507966[_0x26a298];}}),Object[_0xfd582e(0x1b2)](_0x24401c,_0x1f07ea,_0x53fffa);}:function(_0x1cb015,_0x3c321c,_0x4c5480,_0x1a2729){if(_0x1a2729===undefined)_0x1a2729=_0x4c5480;_0x1cb015[_0x1a2729]=_0x3c321c[_0x4c5480];}),__setModuleDefault=this&&this[a627_0x2ed45c(0x193)]||(Object[a627_0x2ed45c(0x19e)]?function(_0x269054,_0x57dd93){const _0x5af273=a627_0x2ed45c;Object[_0x5af273(0x1b2)](_0x269054,_0x5af273(0x20f),{'enumerable':!![],'value':_0x57dd93});}:function(_0x4be2ae,_0x3c03db){const _0x357552=a627_0x2ed45c;_0x4be2ae[_0x357552(0x20f)]=_0x3c03db;}),__importStar=this&&this[a627_0x2ed45c(0x2b8)]||function(_0x4c839f){const _0x2b5785=a627_0x2ed45c;if(_0x4c839f&&_0x4c839f[_0x2b5785(0x2f0)])return _0x4c839f;var _0x1875c8={};if(_0x4c839f!=null){for(var _0x54c5a3 in _0x4c839f)if(_0x54c5a3!==_0x2b5785(0x20f)&&Object['prototype'][_0x2b5785(0x1d4)]['call'](_0x4c839f,_0x54c5a3))__createBinding(_0x1875c8,_0x4c839f,_0x54c5a3);}return __setModuleDefault(_0x1875c8,_0x4c839f),_0x1875c8;},__importDefault=this&&this[a627_0x2ed45c(0x2cf)]||function(_0x4139de){const _0x310d23=a627_0x2ed45c;return _0x4139de&&_0x4139de[_0x310d23(0x2f0)]?_0x4139de:{'default':_0x4139de};};Object[a627_0x2ed45c(0x1b2)](exports,'__esModule',{'value':!![]}),exports[a627_0x2ed45c(0x26a)]=exports[a627_0x2ed45c(0x26d)]=exports[a627_0x2ed45c(0x25c)]=exports['wbotMessageListener']=exports[a627_0x2ed45c(0x258)]=exports[a627_0x2ed45c(0x17d)]=exports['verifyRating']=exports[a627_0x2ed45c(0x2ec)]=exports[a627_0x2ed45c(0x2e3)]=exports[a627_0x2ed45c(0x189)]=exports[a627_0x2ed45c(0x279)]=exports[a627_0x2ed45c(0x170)]=exports[a627_0x2ed45c(0x2a8)]=void 0x0;const path_1=__importStar(require('path')),util_1=require('util'),fs_1=require('fs'),fs_2=__importDefault(require('fs')),Sentry=__importStar(require('@sentry/node')),lodash_1=require(a627_0x2ed45c(0x1ff)),baileys_1=require('@whiskeysockets/baileys'),Contact_1=__importDefault(require(a627_0x2ed45c(0x1c9))),Ticket_1=__importDefault(require(a627_0x2ed45c(0x15f))),Message_1=__importDefault(require('../../models/Message')),socket_1=require('../../libs/socket'),CreateMessageService_1=__importDefault(require(a627_0x2ed45c(0x2d0))),logger_1=require(a627_0x2ed45c(0x24b)),CreateOrUpdateContactService_1=__importDefault(require(a627_0x2ed45c(0x2b6))),FindOrCreateTicketService_1=__importDefault(require(a627_0x2ed45c(0x2b0))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),Debounce_1=require('../../helpers/Debounce'),UpdateTicketService_1=__importDefault(require(a627_0x2ed45c(0x299))),Mustache_1=__importDefault(require('../../helpers/Mustache')),UserRating_1=__importDefault(require(a627_0x2ed45c(0x23f))),SendWhatsAppMessage_1=__importDefault(require(a627_0x2ed45c(0x17e))),sendFacebookMessage_1=__importDefault(require(a627_0x2ed45c(0x228))),moment_1=__importDefault(require(a627_0x2ed45c(0x2c6))),Queue_1=__importDefault(require(a627_0x2ed45c(0x1ed))),FindOrCreateATicketTrakingService_1=__importDefault(require('../TicketServices/FindOrCreateATicketTrakingService')),VerifyCurrentSchedule_1=__importDefault(require('../CompanyService/VerifyCurrentSchedule')),Campaign_1=__importDefault(require('../../models/Campaign')),CampaignShipping_1=__importDefault(require(a627_0x2ed45c(0x28a))),sequelize_1=require(a627_0x2ed45c(0x1f3)),queues_1=require('../../queues'),User_1=__importDefault(require(a627_0x2ed45c(0x277))),ChatBotListener_1=require(a627_0x2ed45c(0x2c5)),MarkDeleteWhatsAppMessage_1=__importDefault(require('./MarkDeleteWhatsAppMessage')),ListUserQueueServices_1=__importDefault(require(a627_0x2ed45c(0x2ee))),cache_1=__importDefault(require(a627_0x2ed45c(0x1a2))),addLogs_1=require(a627_0x2ed45c(0x1bb)),SendWhatsAppMedia_1=__importStar(require(a627_0x2ed45c(0x1df))),ShowQueueIntegrationService_1=__importDefault(require('../QueueIntegrationServices/ShowQueueIntegrationService')),CreateSessionDialogflow_1=require(a627_0x2ed45c(0x1d2)),QueryDialogflow_1=require('../QueueIntegrationServices/QueryDialogflow'),CompaniesSettings_1=__importDefault(require('../../models/CompaniesSettings')),CreateLogTicketService_1=__importDefault(require(a627_0x2ed45c(0x237))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),ShowService_1=__importDefault(require(a627_0x2ed45c(0x22d))),openai_1=require(a627_0x2ed45c(0x26b)),fluent_ffmpeg_1=__importDefault(require('fluent-ffmpeg')),microsoft_cognitiveservices_speech_sdk_1=require(a627_0x2ed45c(0x293)),typebotListener_1=__importDefault(require(a627_0x2ed45c(0x1aa))),os=require('os'),request=require(a627_0x2ed45c(0x20b));let ffmpegPath;if(os[a627_0x2ed45c(0x251)]()==='win32')ffmpegPath=a627_0x2ed45c(0x2dd);else os['platform']()===a627_0x2ed45c(0x2c7)?ffmpegPath=a627_0x2ed45c(0x2a9):ffmpegPath=a627_0x2ed45c(0x267);fluent_ffmpeg_1[a627_0x2ed45c(0x20f)]['setFfmpegPath'](ffmpegPath);let i=0x0;setInterval(()=>{i=0x0;},0x1388);const sessionsOpenAi=[],writeFileAsync=(0x0,util_1[a627_0x2ed45c(0x19a)])(fs_1[a627_0x2ed45c(0x164)]);function removeFile(_0x5c2da9){const _0xa70de2=a627_0x2ed45c;fs_2[_0xa70de2(0x20f)][_0xa70de2(0x2c2)](_0x5c2da9,_0x3ccf58=>{if(_0x3ccf58)throw _0x3ccf58;});}const getTimestampMessage=_0x27f856=>{return _0x27f856*0x1;},multVecardGet=function(_0x11d2dd){const _0x3649ee=a627_0x2ed45c;let _0x5d93ae='\x20',_0xe0252f=_0x11d2dd['split']('\x0a')[0x2][_0x3649ee(0x269)](_0x3649ee(0x23e),'\x0a')['replace']('N:','')[_0x3649ee(0x269)](';','')['replace'](';','\x20')[_0x3649ee(0x269)](';;','\x20')[_0x3649ee(0x269)]('\x0a',''),_0x52947d=_0x11d2dd[_0x3649ee(0x282)]('\x0a')[0x4][_0x3649ee(0x23c)]('='),_0x2dfcf5=_0x11d2dd[_0x3649ee(0x282)]('\x0a')[0x4][_0x3649ee(0x23c)](':'),_0x2f1786=_0x11d2dd['split']('\x0a')[0x4]['substring'](_0x52947d+0x1,_0x2dfcf5)[_0x3649ee(0x269)](';',''),_0x464a8e=_0x11d2dd[_0x3649ee(0x282)]('\x0a')[0x4][_0x3649ee(0x269)](_0x3649ee(0x185),'');if(_0x2f1786!=_0x3649ee(0x2ca))_0x5d93ae=_0x5d93ae+_0xe0252f+':\x20📞'+_0x2f1786+''+'\x0a';else _0x5d93ae=_0x5d93ae+_0xe0252f+_0x3649ee(0x1e0)+_0x464a8e+''+'\x0a';return _0x5d93ae;},contactsArrayMessageGet=_0x3bb5bb=>{const _0x36aa6b=a627_0x2ed45c;let _0x447511=_0x3bb5bb[_0x36aa6b(0x27d)]?.[_0x36aa6b(0x221)]?.[_0x36aa6b(0x2d4)],_0x10ad06=_0x447511[_0x36aa6b(0x222)](function(_0x36e217,_0x43cd7a){const _0x265b2b=_0x36aa6b;return _0x36e217[_0x265b2b(0x20a)];}),_0x292c0e='';_0x10ad06[_0x36aa6b(0x283)](function(_0x5a7552,_0x157926){_0x292c0e+=_0x5a7552+'\x0a\x0a'+'';});let _0x51ad27=_0x292c0e[_0x36aa6b(0x282)](_0x36aa6b(0x1cb));_0x51ad27[_0x36aa6b(0x249)]();let _0x2e95ba='';for(let _0x389304 of _0x51ad27){_0x2e95ba=_0x2e95ba+multVecardGet(_0x389304);}return _0x2e95ba;},getTypeMessage=_0x316063=>{const _0x495fff=a627_0x2ed45c,_0x40eea0=(0x0,baileys_1[_0x495fff(0x229)])(_0x316063[_0x495fff(0x27d)]);if(_0x316063['message']?.[_0x495fff(0x197)])return'viewOnceMessageV2';return _0x40eea0;};exports['getTypeMessage']=getTypeMessage;function a627_0x4baf(_0x39f082,_0x435c3e){const _0x5c8874=a627_0x5c88();return a627_0x4baf=function(_0x4baf0c,_0x1dc5bb){_0x4baf0c=_0x4baf0c-0x158;let _0x7cce50=_0x5c8874[_0x4baf0c];return _0x7cce50;},a627_0x4baf(_0x39f082,_0x435c3e);}const getBodyButton=_0x875b7d=>{const _0x160f56=a627_0x2ed45c;if(_0x875b7d[_0x160f56(0x2ce)]['fromMe']&&_0x875b7d[_0x160f56(0x27d)]['buttonsMessage']?.['contentText']){let _0x1db64e=''+_0x875b7d?.[_0x160f56(0x27d)]?.['buttonsMessage']?.['contentText'];for(const _0x3a9723 of _0x875b7d['message']?.[_0x160f56(0x24a)]?.[_0x160f56(0x2ed)]){_0x1db64e+='\x0a\x0a'+_0x3a9723['buttonText']?.['displayText'];}return _0x1db64e;}if(_0x875b7d['key'][_0x160f56(0x270)]&&_0x875b7d?.[_0x160f56(0x27d)]?.['viewOnceMessage']?.['message']?.[_0x160f56(0x1a9)]){let _0x100e01=''+_0x875b7d?.[_0x160f56(0x27d)]?.['viewOnceMessage']?.[_0x160f56(0x27d)]?.[_0x160f56(0x1a9)]?.[_0x160f56(0x21f)];for(const _0x11757d of _0x875b7d[_0x160f56(0x27d)]?.[_0x160f56(0x195)]?.[_0x160f56(0x27d)]?.[_0x160f56(0x1a9)]?.[_0x160f56(0x209)]){for(const _0x455dc3 of _0x11757d[_0x160f56(0x1ad)]){_0x100e01+='\x0a\x0a'+_0x455dc3['title'];}}return _0x100e01;}},getBodyList=_0x2e79a3=>{const _0xefc726=a627_0x2ed45c;if(_0x2e79a3[_0xefc726(0x2ce)][_0xefc726(0x270)]&&_0x2e79a3[_0xefc726(0x27d)]['listMessage']?.['description']){let _0x5a0d3e=''+_0x2e79a3[_0xefc726(0x27d)][_0xefc726(0x1a9)]?.[_0xefc726(0x21f)];for(const _0x33b0ff of _0x2e79a3[_0xefc726(0x27d)][_0xefc726(0x1a9)]?.[_0xefc726(0x209)]){for(const _0x34049e of _0x33b0ff[_0xefc726(0x1ad)]){_0x5a0d3e+='\x0a\x0a'+_0x34049e[_0xefc726(0x1d9)];}}return _0x5a0d3e;}if(_0x2e79a3[_0xefc726(0x2ce)]['fromMe']&&_0x2e79a3?.[_0xefc726(0x27d)]?.['viewOnceMessage']?.['message']?.[_0xefc726(0x1a9)]){let _0x357dfb=''+_0x2e79a3?.['message']?.[_0xefc726(0x195)]?.['message']?.[_0xefc726(0x1a9)]?.[_0xefc726(0x21f)];for(const _0x1b80c1 of _0x2e79a3[_0xefc726(0x27d)]?.[_0xefc726(0x195)]?.['message']?.[_0xefc726(0x1a9)]?.[_0xefc726(0x209)]){for(const _0x110294 of _0x1b80c1[_0xefc726(0x1ad)]){_0x357dfb+='\x0a\x0a'+_0x110294['title'];}}return _0x357dfb;}},msgLocation=(_0x424281,_0x5d1d14,_0x557835)=>{const _0x1bce33=a627_0x2ed45c;if(_0x424281){var _0x54c009=Buffer[_0x1bce33(0x204)](_0x424281)[_0x1bce33(0x21b)]('base64');let _0xf56bdd='data:image/png;base64,\x20'+_0x54c009+_0x1bce33(0x266)+_0x5d1d14+_0x1bce33(0x275)+_0x557835+_0x1bce33(0x16a)+_0x5d1d14+',\x20'+_0x557835+'\x20';return _0xf56bdd;}},getBodyMessage=_0x27c3f1=>{const _0x23438c=a627_0x2ed45c;try{let _0x29826d=getTypeMessage(_0x27c3f1);if(_0x29826d===undefined)console[_0x23438c(0x1ab)](_0x27c3f1);const _0x5a25e6={'conversation':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x1a8)],'imageMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x206)]?.[_0x23438c(0x217)],'videoMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x296)]?.[_0x23438c(0x217)],'extendedTextMessage':_0x27c3f1?.[_0x23438c(0x27d)]?.[_0x23438c(0x1a6)]?.[_0x23438c(0x2bc)],'buttonsResponseMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x19f)]?.[_0x23438c(0x27b)],'listResponseMessage':_0x27c3f1[_0x23438c(0x27d)]?.['listResponseMessage']?.['title']||_0x27c3f1['message']?.['listResponseMessage']?.['singleSelectReply']?.['selectedRowId'],'templateButtonReplyMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x27a)]?.[_0x23438c(0x16c)],'messageContextInfo':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x19f)]?.['selectedButtonId']||_0x27c3f1[_0x23438c(0x27d)]?.['listResponseMessage']?.[_0x23438c(0x1d9)],'buttonsMessage':getBodyButton(_0x27c3f1)||_0x27c3f1[_0x23438c(0x27d)]?.['listResponseMessage']?.[_0x23438c(0x1d9)],'stickerMessage':'sticker','contactMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x17f)]?.[_0x23438c(0x20a)],'contactsArrayMessage':_0x27c3f1['message']?.[_0x23438c(0x221)]?.['contacts']&&contactsArrayMessageGet(_0x27c3f1),'locationMessage':msgLocation(_0x27c3f1['message']?.[_0x23438c(0x163)]?.[_0x23438c(0x2a5)],_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x163)]?.[_0x23438c(0x183)],_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x163)]?.[_0x23438c(0x158)]),'liveLocationMessage':_0x23438c(0x160)+_0x27c3f1[_0x23438c(0x27d)]?.['liveLocationMessage']?.[_0x23438c(0x183)]+_0x23438c(0x2df)+_0x27c3f1[_0x23438c(0x27d)]?.['liveLocationMessage']?.[_0x23438c(0x158)],'documentMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x1e7)]?.[_0x23438c(0x217)],'audioMessage':_0x23438c(0x1c1),'listMessage':getBodyList(_0x27c3f1)||_0x27c3f1[_0x23438c(0x27d)]?.['listResponseMessage']?.[_0x23438c(0x1d9)],'viewOnceMessage':getBodyButton(_0x27c3f1),'reactionMessage':_0x27c3f1[_0x23438c(0x27d)]?.['reactionMessage']?.['text']||_0x23438c(0x261),'senderKeyDistributionMessage':_0x27c3f1?.[_0x23438c(0x27d)]?.['senderKeyDistributionMessage']?.[_0x23438c(0x234)],'documentWithCaptionMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x2ae)]?.[_0x23438c(0x27d)]?.[_0x23438c(0x1e7)]?.[_0x23438c(0x217)],'viewOnceMessageV2':_0x27c3f1[_0x23438c(0x27d)]?.['viewOnceMessageV2']?.[_0x23438c(0x27d)]?.[_0x23438c(0x206)]?.[_0x23438c(0x217)],'editedMessage':_0x27c3f1[_0x23438c(0x27d)]?.[_0x23438c(0x1e2)]?.[_0x23438c(0x27d)]?.[_0x23438c(0x1a6)]?.[_0x23438c(0x2bc)],'ephemeralMessage':_0x27c3f1['message']?.[_0x23438c(0x252)]?.['message']?.[_0x23438c(0x1a6)]?.[_0x23438c(0x2bc)]},_0x400ccc=Object['keys'](_0x5a25e6)['find'](_0x3850f3=>_0x3850f3===_0x29826d);return!_0x400ccc&&(logger_1['logger'][_0x23438c(0x288)]('####\x20Nao\x20achou\x20o\x20type\x20152:\x20'+_0x29826d+'\x0a'+JSON[_0x23438c(0x207)](_0x27c3f1)),Sentry[_0x23438c(0x18e)](_0x23438c(0x190),{'BodyMsg':_0x27c3f1[_0x23438c(0x27d)],'msg':_0x27c3f1,'type':_0x29826d}),Sentry[_0x23438c(0x1ea)](new Error(_0x23438c(0x191)))),_0x5a25e6[_0x29826d];}catch(_0x3efe9a){Sentry[_0x23438c(0x18e)]('Error\x20getTypeMessage',{'msg':_0x27c3f1,'BodyMsg':_0x27c3f1['message']}),Sentry[_0x23438c(0x1ea)](_0x3efe9a),console[_0x23438c(0x1ab)](_0x3efe9a);}};exports[a627_0x2ed45c(0x2a8)]=getBodyMessage;const getQuotedMessage=_0x259b71=>{const _0xa2ada5=a627_0x2ed45c,_0x4a6b95=(0x0,baileys_1['extractMessageContent'])(_0x259b71[_0xa2ada5(0x27d)])[Object[_0xa2ada5(0x1f6)](_0x259b71?.[_0xa2ada5(0x27d)])[_0xa2ada5(0x21d)]()['next']()[_0xa2ada5(0x1c4)]];if(!_0x4a6b95?.['contextInfo']?.[_0xa2ada5(0x1f5)])return;const _0x4e37a2=(0x0,baileys_1[_0xa2ada5(0x29b)])(_0x4a6b95?.[_0xa2ada5(0x231)]?.['quotedMessage'][Object['keys'](_0x4a6b95?.['contextInfo']?.['quotedMessage'])[_0xa2ada5(0x21d)]()[_0xa2ada5(0x273)]()[_0xa2ada5(0x1c4)]]);return _0x4e37a2;};exports[a627_0x2ed45c(0x170)]=getQuotedMessage;const getQuotedMessageId=_0x5651f8=>{const _0x2ea7a8=a627_0x2ed45c,_0x3a8d04=(0x0,baileys_1['extractMessageContent'])(_0x5651f8[_0x2ea7a8(0x27d)])[Object[_0x2ea7a8(0x1f6)](_0x5651f8?.[_0x2ea7a8(0x27d)])[_0x2ea7a8(0x21d)]()[_0x2ea7a8(0x273)]()['value']];let _0x4c98a1=_0x5651f8?.[_0x2ea7a8(0x27d)]?.['reactionMessage']?_0x5651f8?.[_0x2ea7a8(0x27d)]?.[_0x2ea7a8(0x2e4)]?.[_0x2ea7a8(0x2ce)]?.['id']:'';return _0x4c98a1?_0x4c98a1:_0x3a8d04?.['contextInfo']?.[_0x2ea7a8(0x276)];};exports[a627_0x2ed45c(0x279)]=getQuotedMessageId;const getMeSocket=_0x1ed8f0=>{const _0x4925e5=a627_0x2ed45c;return{'id':(0x0,baileys_1['jidNormalizedUser'])(_0x1ed8f0[_0x4925e5(0x218)]['id']),'name':_0x1ed8f0[_0x4925e5(0x218)][_0x4925e5(0x2be)]};},getSenderMessage=(_0x57b516,_0x5b8211)=>{const _0x3ab16e=a627_0x2ed45c,_0x547621=getMeSocket(_0x5b8211);if(_0x57b516['key'][_0x3ab16e(0x270)])return _0x547621['id'];const _0x237260=_0x57b516[_0x3ab16e(0x264)]||_0x57b516[_0x3ab16e(0x2ce)][_0x3ab16e(0x264)]||_0x57b516[_0x3ab16e(0x2ce)][_0x3ab16e(0x166)]||undefined;return _0x237260&&(0x0,baileys_1[_0x3ab16e(0x224)])(_0x237260);},getContactMessage=async(_0x2c1b4a,_0x54f0ce)=>{const _0x1102eb=a627_0x2ed45c,_0x845113=_0x2c1b4a['key'][_0x1102eb(0x166)]['includes']('g.us'),_0x15e866=_0x2c1b4a[_0x1102eb(0x2ce)][_0x1102eb(0x166)][_0x1102eb(0x269)](/\D/g,'');return _0x845113?{'id':getSenderMessage(_0x2c1b4a,_0x54f0ce),'name':_0x2c1b4a[_0x1102eb(0x1c8)]}:{'id':_0x2c1b4a['key'][_0x1102eb(0x166)],'name':_0x2c1b4a[_0x1102eb(0x2ce)][_0x1102eb(0x270)]?_0x15e866:_0x2c1b4a[_0x1102eb(0x1c8)]};},downloadMedia=async(_0x43ac1d,_0x4be856=null)=>{const _0x1301b3=a627_0x2ed45c;let _0x1edf0b;try{_0x1edf0b=await(0x0,baileys_1[_0x1301b3(0x286)])(_0x43ac1d,_0x1301b3(0x220),{});}catch(_0x283a4d){_0x4be856?console[_0x1301b3(0x1ab)]('Falha\x20ao\x20fazer\x20o\x20download\x20de\x20uma\x20mensagem\x20importada,\x20provavelmente\x20a\x20mensagem\x20já\x20não\x20esta\x20mais\x20disponível'):console[_0x1301b3(0x19d)](_0x1301b3(0x216),_0x283a4d);}let _0x20fc25=_0x43ac1d[_0x1301b3(0x27d)]?.['documentMessage']?.[_0x1301b3(0x199)]||'';const _0x5ca1be=_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x206)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x159)]||_0x43ac1d['message']?.[_0x1301b3(0x296)]||_0x43ac1d['message']?.[_0x1301b3(0x2da)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x1e7)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x2ae)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x1e7)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x1a6)]?.[_0x1301b3(0x231)]?.[_0x1301b3(0x1f5)]?.['imageMessage']||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x1a6)]?.[_0x1301b3(0x231)]?.[_0x1301b3(0x1f5)]?.[_0x1301b3(0x296)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x252)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x159)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x252)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x1e7)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x252)]?.[_0x1301b3(0x27d)]?.['videoMessage']||_0x43ac1d?.['message']?.[_0x1301b3(0x252)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x2da)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x195)]?.[_0x1301b3(0x27d)]?.['imageMessage']||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x195)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x296)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x252)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x195)]?.[_0x1301b3(0x27d)]?.['imageMessage']||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x252)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x195)]?.['message']?.[_0x1301b3(0x296)]||_0x43ac1d[_0x1301b3(0x27d)]?.[_0x1301b3(0x2ae)]?.[_0x1301b3(0x27d)]?.[_0x1301b3(0x1e7)];if(!_0x5ca1be)console['log'](_0x43ac1d);if(!_0x20fc25){const _0x3aec9b=_0x5ca1be['mimetype'][_0x1301b3(0x282)]('/')[0x1]['split'](';')[0x0];_0x20fc25=new Date()['getTime']()+'.'+_0x3aec9b;}else _0x20fc25=new Date()[_0x1301b3(0x2a2)]()+'_'+_0x20fc25;const _0x2e5e6b={'data':_0x1edf0b,'mimetype':_0x5ca1be[_0x1301b3(0x1a5)],'filename':_0x20fc25};return _0x2e5e6b;};exports[a627_0x2ed45c(0x189)]=downloadMedia;const verifyContact=async(_0x48be4d,_0xf26f8f,_0x2f8475)=>{const _0x38a3fa=a627_0x2ed45c;let _0x21f7d3;try{_0x21f7d3=await _0xf26f8f[_0x38a3fa(0x1f9)](_0x48be4d['id'],'image');}catch(_0x30db63){Sentry['captureException'](_0x30db63),_0x21f7d3=process[_0x38a3fa(0x2d9)][_0x38a3fa(0x1de)]+_0x38a3fa(0x180);}const _0x558eb3={'name':_0x48be4d[_0x38a3fa(0x2be)]||_0x48be4d['id'][_0x38a3fa(0x269)](/\D/g,''),'number':_0x48be4d['id']['replace'](/\D/g,''),'profilePicUrl':_0x21f7d3,'isGroup':_0x48be4d['id']['includes'](_0x38a3fa(0x2d2)),'companyId':_0x2f8475,'remoteJid':_0x48be4d['id']};_0x558eb3[_0x38a3fa(0x268)]&&(_0x558eb3['number']=_0x48be4d['id'][_0x38a3fa(0x269)](_0x38a3fa(0x194),''));const _0x2fbfb3=await(0x0,CreateOrUpdateContactService_1[_0x38a3fa(0x20f)])(_0x558eb3);return _0x2fbfb3;},verifyQuotedMessage=async _0x4bf1a2=>{const _0x4821a3=a627_0x2ed45c;if(!_0x4bf1a2)return null;const _0x287dfb=(0x0,exports[_0x4821a3(0x279)])(_0x4bf1a2);if(!_0x287dfb)return null;const _0x27126c=await Message_1[_0x4821a3(0x20f)]['findOne']({'where':{'wid':_0x287dfb}});if(!_0x27126c)return null;return _0x27126c;},verifyMediaMessage=async(_0x2dcd77,_0x279022,_0x2935c8,_0x3f0d19,_0x821526)=>{const _0x263611=a627_0x2ed45c,_0x29b4e8=(0x0,socket_1[_0x263611(0x179)])(),_0x500dbb=await verifyQuotedMessage(_0x2dcd77),_0x16210c=_0x279022['companyId'];try{const _0x49afee=await(0x0,exports[_0x263611(0x189)])(_0x2dcd77,_0x279022?.[_0x263611(0x2a6)]);if(!_0x49afee&&_0x279022[_0x263611(0x2a6)]){const _0x3add11=_0x263611(0x23b),_0x3a118a={'wid':_0x2dcd77[_0x263611(0x2ce)]['id'],'ticketId':_0x279022['id'],'contactId':_0x2dcd77[_0x263611(0x2ce)]['fromMe']?undefined:_0x279022[_0x263611(0x1e3)],'body':_0x3add11,'reactionMessage':_0x2dcd77[_0x263611(0x27d)]?.[_0x263611(0x2e4)],'fromMe':_0x2dcd77['key'][_0x263611(0x270)],'mediaType':getTypeMessage(_0x2dcd77),'read':_0x2dcd77['key'][_0x263611(0x270)],'quotedMsgId':_0x500dbb?.['id']||_0x2dcd77[_0x263611(0x27d)]?.[_0x263611(0x2e4)]?.[_0x263611(0x2ce)]?.['id'],'ack':_0x2dcd77['status'],'companyId':_0x16210c,'remoteJid':_0x2dcd77[_0x263611(0x2ce)][_0x263611(0x166)],'participant':_0x2dcd77[_0x263611(0x2ce)][_0x263611(0x264)],'timestamp':getTimestampMessage(_0x2dcd77['messageTimestamp']),'createdAt':new Date(Math[_0x263611(0x242)](getTimestampMessage(_0x2dcd77['messageTimestamp'])*0x3e8))[_0x263611(0x1a3)](),'dataJson':JSON['stringify'](_0x2dcd77),'ticketImported':_0x279022[_0x263611(0x2a6)],'isForwarded':_0x821526};return await _0x279022['update']({'lastMessage':_0x3add11}),logger_1[_0x263611(0x1e9)]['error'](Error(_0x263611(0x26f))),(0x0,CreateMessageService_1[_0x263611(0x20f)])({'messageData':_0x3a118a,'companyId':_0x16210c});}if(!_0x49afee)throw new Error(_0x263611(0x26f));if(!_0x49afee[_0x263611(0x1d3)]){const _0x3d6ebb=_0x49afee[_0x263611(0x1a5)][_0x263611(0x282)]('/')[0x1][_0x263611(0x282)](';')[0x0];_0x49afee['filename']=new Date()['getTime']()+'.'+_0x3d6ebb;}else{const _0x20f70a=_0x49afee[_0x263611(0x1d3)][_0x263611(0x282)]('.')[_0x263611(0x244)](),_0xae40ad=_0x49afee[_0x263611(0x1d3)][_0x263611(0x282)]('.')[_0x263611(0x1ef)](0x0,-0x1)[_0x263611(0x1ba)]('.')[_0x263611(0x269)](/\s/g,'_')[_0x263611(0x280)](_0x263611(0x15b))['replace'](/[\u0300-\u036f]/g,'');_0x49afee[_0x263611(0x1d3)]=_0xae40ad[_0x263611(0x290)]()+'_'+new Date()['getTime']()+'.'+_0x20f70a;}try{const _0x48b3a2=path_1[_0x263611(0x20f)][_0x263611(0x2aa)](__dirname,'..','..','..','public',_0x263611(0x274)+_0x16210c);!fs_2[_0x263611(0x20f)][_0x263611(0x1f0)](_0x48b3a2)&&(fs_2['default'][_0x263611(0x1b3)](_0x48b3a2,{'recursive':!![]}),fs_2[_0x263611(0x20f)][_0x263611(0x256)](_0x48b3a2,0x1ff)),await writeFileAsync((0x0,path_1['join'])(_0x48b3a2,_0x49afee['filename']),_0x49afee['data'][_0x263611(0x21b)](_0x263611(0x21e)),_0x263611(0x21e))[_0x263611(0x1b1)](()=>{const _0x3392fc=_0x263611;if(_0x49afee[_0x3392fc(0x1a5)][_0x3392fc(0x2a1)](_0x3392fc(0x2e1))){const _0x3b6599=path_1['default'][_0x3392fc(0x1ba)](_0x48b3a2,_0x49afee['filename']);let _0x6bcf84;if(_0x3b6599['endsWith']('.mpeg'))_0x6bcf84=_0x3b6599['replace'](_0x3392fc(0x17b),_0x3392fc(0x2e0));else{if(_0x3b6599[_0x3392fc(0x238)](_0x3392fc(0x2e8)))_0x6bcf84=_0x3b6599[_0x3392fc(0x269)](_0x3392fc(0x2e8),_0x3392fc(0x2e0));else{console[_0x3392fc(0x19d)](_0x3392fc(0x171),_0x3b6599);return;}}return new Promise((_0x3e9b30,_0x1531c0)=>{const _0x1838e5=_0x3392fc;(0x0,fluent_ffmpeg_1[_0x1838e5(0x20f)])(_0x3b6599)['toFormat'](_0x1838e5(0x2ba))[_0x1838e5(0x284)](_0x6bcf84)['on'](_0x1838e5(0x1b0),()=>{_0x3e9b30();})['on'](_0x1838e5(0x19d),_0x139628=>{_0x1531c0(_0x139628);});});}});}catch(_0x58b1c8){Sentry['setExtra'](_0x263611(0x196),{'companyId':_0x16210c,'ticket':_0x279022,'contact':_0x2935c8,'media':_0x49afee,'quotedMsg':_0x500dbb}),Sentry[_0x263611(0x1ea)](_0x58b1c8),logger_1['logger'][_0x263611(0x19d)](_0x58b1c8),console['log'](_0x2dcd77);}const _0x2ddc45=(0x0,exports[_0x263611(0x2a8)])(_0x2dcd77),_0x3a8da8={'wid':_0x2dcd77[_0x263611(0x2ce)]['id'],'ticketId':_0x279022['id'],'contactId':_0x2dcd77['key'][_0x263611(0x270)]?undefined:_0x2935c8['id'],'body':_0x2ddc45||_0x49afee[_0x263611(0x1d3)],'fromMe':_0x2dcd77['key']['fromMe'],'read':_0x2dcd77[_0x263611(0x2ce)][_0x263611(0x270)],'mediaUrl':_0x49afee[_0x263611(0x1d3)],'mediaType':_0x49afee[_0x263611(0x1a5)][_0x263611(0x282)]('/')[0x0],'quotedMsgId':_0x500dbb?.['id'],'ack':_0x2dcd77[_0x263611(0x2db)],'remoteJid':_0x2dcd77[_0x263611(0x2ce)][_0x263611(0x166)],'participant':_0x2dcd77[_0x263611(0x2ce)]['participant'],'dataJson':JSON[_0x263611(0x207)](_0x2dcd77),'ticketTrakingId':_0x3f0d19?.['id'],'createdAt':new Date(Math['floor'](getTimestampMessage(_0x2dcd77[_0x263611(0x227)])*0x3e8))[_0x263611(0x1a3)](),'ticketImported':_0x279022['imported'],'isForwarded':_0x821526};await _0x279022[_0x263611(0x1f8)]({'lastMessage':_0x2ddc45||_0x49afee[_0x263611(0x1d3)]});const _0x3e6f48=await(0x0,CreateMessageService_1['default'])({'messageData':_0x3a8da8,'companyId':_0x16210c});return!_0x2dcd77[_0x263611(0x2ce)][_0x263611(0x270)]&&_0x279022[_0x263611(0x2db)]===_0x263611(0x25d)&&(await _0x279022[_0x263611(0x1f8)]({'status':'pending'}),await _0x279022['reload']({'include':[{'model':Queue_1[_0x263611(0x20f)],'as':_0x263611(0x1af)},{'model':User_1['default'],'as':_0x263611(0x218)},{'model':Contact_1[_0x263611(0x20f)],'as':_0x263611(0x1b4)},{'model':Whatsapp_1[_0x263611(0x20f)],'as':_0x263611(0x1dd)}]}),_0x29b4e8['to'](_0x263611(0x25d))[_0x263611(0x23d)]('company-'+_0x16210c+'-ticket',{'action':_0x263611(0x1cd),'ticket':_0x279022,'ticketId':_0x279022['id']}),_0x29b4e8['to'](_0x279022[_0x263611(0x2db)])['to'](_0x279022['id']['toString']())[_0x263611(0x23d)](_0x263611(0x1db)+_0x16210c+_0x263611(0x25f),{'action':_0x263611(0x1f8),'ticket':_0x279022,'ticketId':_0x279022['id']})),_0x3e6f48;}catch(_0x30f192){console[_0x263611(0x1ab)](_0x30f192),logger_1[_0x263611(0x1e9)][_0x263611(0x288)](_0x263611(0x253));}};exports['verifyMediaMessage']=verifyMediaMessage;const verifyMessage=async(_0x2cef32,_0x468337,_0x59224a,_0xf88edc,_0x29ff25,_0x495424)=>{const _0x5e010e=a627_0x2ed45c,_0x4a5273=(0x0,socket_1[_0x5e010e(0x179)])(),_0x215bb2=await verifyQuotedMessage(_0x2cef32),_0x1c6025=(0x0,exports[_0x5e010e(0x2a8)])(_0x2cef32),_0x3701e1=_0x468337[_0x5e010e(0x172)],_0x2049c3={'wid':_0x2cef32[_0x5e010e(0x2ce)]['id'],'ticketId':_0x468337['id'],'contactId':_0x2cef32['key'][_0x5e010e(0x270)]?undefined:_0x59224a['id'],'body':_0x1c6025,'fromMe':_0x2cef32[_0x5e010e(0x2ce)][_0x5e010e(0x270)],'mediaType':getTypeMessage(_0x2cef32),'read':_0x2cef32[_0x5e010e(0x2ce)][_0x5e010e(0x270)],'quotedMsgId':_0x215bb2?.['id'],'ack':_0x2cef32[_0x5e010e(0x2db)],'remoteJid':_0x2cef32[_0x5e010e(0x2ce)]['remoteJid'],'participant':_0x2cef32[_0x5e010e(0x2ce)][_0x5e010e(0x264)],'dataJson':JSON[_0x5e010e(0x207)](_0x2cef32),'ticketTrakingId':_0xf88edc?.['id'],'isPrivate':![],'createdAt':new Date(Math['floor'](getTimestampMessage(_0x2cef32['messageTimestamp'])*0x3e8))['toISOString'](),'ticketImported':_0x468337[_0x5e010e(0x2a6)],'isForwarded':_0x495424};await _0x468337[_0x5e010e(0x1f8)]({'lastMessage':_0x1c6025}),await(0x0,CreateMessageService_1[_0x5e010e(0x20f)])({'messageData':_0x2049c3,'companyId':_0x3701e1}),!_0x2cef32[_0x5e010e(0x2ce)]['fromMe']&&_0x468337[_0x5e010e(0x2db)]===_0x5e010e(0x25d)&&(await _0x468337[_0x5e010e(0x1f8)]({'status':_0x5e010e(0x162)}),await _0x468337[_0x5e010e(0x28f)]({'include':[{'model':Queue_1[_0x5e010e(0x20f)],'as':_0x5e010e(0x1af)},{'model':User_1[_0x5e010e(0x20f)],'as':'user'},{'model':Contact_1['default'],'as':_0x5e010e(0x1b4)},{'model':Whatsapp_1[_0x5e010e(0x20f)],'as':_0x5e010e(0x1dd)}]}),!_0x468337['imported']&&_0x4a5273['to'](_0x468337[_0x5e010e(0x2db)])['to'](_0x468337['id'][_0x5e010e(0x21b)]())[_0x5e010e(0x23d)](_0x5e010e(0x1db)+_0x3701e1+_0x5e010e(0x25f),{'action':_0x5e010e(0x1f8),'ticket':_0x468337,'ticketId':_0x468337['id']}));};exports['verifyMessage']=verifyMessage;const isValidMsg=_0x12c8a9=>{const _0x4b31e2=a627_0x2ed45c;if(_0x12c8a9[_0x4b31e2(0x2ce)][_0x4b31e2(0x166)]==='status@broadcast')return![];try{const _0xc538b3=getTypeMessage(_0x12c8a9);if(!_0xc538b3)return;const _0x191f87=_0xc538b3===_0x4b31e2(0x1a8)||_0xc538b3===_0x4b31e2(0x1a6)||_0xc538b3==='audioMessage'||_0xc538b3===_0x4b31e2(0x296)||_0xc538b3===_0x4b31e2(0x206)||_0xc538b3===_0x4b31e2(0x1e7)||_0xc538b3===_0x4b31e2(0x2da)||_0xc538b3===_0x4b31e2(0x19f)||_0xc538b3===_0x4b31e2(0x24a)||_0xc538b3===_0x4b31e2(0x239)||_0xc538b3===_0x4b31e2(0x163)||_0xc538b3==='liveLocationMessage'||_0xc538b3===_0x4b31e2(0x17f)||_0xc538b3==='voiceMessage'||_0xc538b3===_0x4b31e2(0x20e)||_0xc538b3==='contactsArrayMessage'||_0xc538b3===_0x4b31e2(0x2e4)||_0xc538b3===_0x4b31e2(0x252)||_0xc538b3===_0x4b31e2(0x2ad)||_0xc538b3==='listResponseMessage'||_0xc538b3===_0x4b31e2(0x1a9)||_0xc538b3===_0x4b31e2(0x195)||_0xc538b3===_0x4b31e2(0x2ae)||_0xc538b3===_0x4b31e2(0x197)||_0xc538b3===_0x4b31e2(0x1e2);return!_0x191f87&&(logger_1[_0x4b31e2(0x1e9)][_0x4b31e2(0x288)]('####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20'+_0xc538b3+'\x0a'+JSON['stringify'](_0x12c8a9?.[_0x4b31e2(0x27d)])),Sentry[_0x4b31e2(0x18e)](_0x4b31e2(0x190),{'BodyMsg':_0x12c8a9[_0x4b31e2(0x27d)],'msg':_0x12c8a9,'msgType':_0xc538b3}),Sentry[_0x4b31e2(0x1ea)](new Error(_0x4b31e2(0x1bf)))),!!_0x191f87;}catch(_0xdc4dae){Sentry[_0x4b31e2(0x18e)]('Error\x20isValidMsg',{'msg':_0x12c8a9}),Sentry['captureException'](_0xdc4dae);}};exports[a627_0x2ed45c(0x26d)]=isValidMsg;const sendDialogflowAwswer=async(_0x188896,_0x1ccd71,_0x5d3556,_0x3a7ae6,_0x859f12,_0x21e1ef,_0x459386)=>{const _0x222b02=a627_0x2ed45c,_0x1e0b61=await(0x0,CreateSessionDialogflow_1[_0x222b02(0x1be)])(_0x459386);if(_0x1e0b61===undefined)return;_0x188896[_0x222b02(0x20c)](_0x3a7ae6[_0x222b02(0x166)]),await(0x0,baileys_1['delay'])(0x1f4);let _0x4171bc=await(0x0,QueryDialogflow_1[_0x222b02(0x2b9)])(_0x1e0b61,_0x459386[_0x222b02(0x1c3)],_0x3a7ae6[_0x222b02(0x166)],(0x0,exports[_0x222b02(0x2a8)])(_0x5d3556),_0x459386[_0x222b02(0x1b8)],_0x859f12);if(!_0x4171bc){_0x188896['sendPresenceUpdate']('composing',_0x3a7ae6['remoteJid']);const _0x58be4d=(0x0,Mustache_1[_0x222b02(0x20f)])(_0x222b02(0x17a)+_0x459386?.[_0x222b02(0x2be)]+_0x222b02(0x1fc));await(0x0,baileys_1[_0x222b02(0x18c)])(0x3e8),await _0x188896[_0x222b02(0x202)](_0x222b02(0x240),_0x3a7ae6[_0x222b02(0x166)]);const _0x535669=await _0x188896[_0x222b02(0x2ab)](_0x3a7ae6[_0x222b02(0x1cc)]+_0x222b02(0x27c),{'text':_0x58be4d});await(0x0,exports[_0x222b02(0x2ec)])(_0x535669,_0x1ccd71,_0x3a7ae6);return;}_0x4171bc[_0x222b02(0x1b6)]&&await _0x1ccd71[_0x222b02(0x1f8)]({'contactId':_0x1ccd71[_0x222b02(0x1b4)]['id']['toString'](),'useIntegration':![]});const _0x83af90=_0x4171bc[_0x222b02(0x2e5)][_0x222b02(0x186)]?.[_0x222b02(0x295)]??undefined,_0xd2eb6b=_0x4171bc[_0x222b02(0x2e5)]['react']?.[_0x222b02(0x295)]??undefined,_0xb0aeda=_0x4171bc[_0x222b02(0x2af)][_0x222b02(0x21b)]('base64')??undefined;_0x188896[_0x222b02(0x202)](_0x222b02(0x1fb),_0x3a7ae6[_0x222b02(0x166)]),await(0x0,baileys_1[_0x222b02(0x18c)])(0x1f4);let _0x48baf1;for(let _0x266814 of _0x4171bc[_0x222b02(0x187)]){_0x48baf1=_0x266814[_0x222b02(0x2bc)][_0x222b02(0x2bc)][0x0]?_0x266814[_0x222b02(0x2bc)][_0x222b02(0x2bc)][0x0]:_0x48baf1;}for(let _0x3504b1 of _0x4171bc[_0x222b02(0x187)]){_0x3504b1[_0x222b02(0x2bc)]&&await sendDelayedMessages(_0x188896,_0x1ccd71,_0x3a7ae6,_0x3504b1[_0x222b02(0x2bc)][_0x222b02(0x2bc)][0x0],_0x48baf1,_0xb0aeda,_0x459386);}};async function sendDelayedMessages(_0x31bd86,_0x5b4c35,_0x150b32,_0xb923b8,_0x19b59b,_0x9ac7f8,_0x173d44){const _0x17b64c=a627_0x2ed45c,_0xeb26a5=_0x5b4c35['companyId'],_0x4c8188=await(0x0,ShowWhatsAppService_1[_0x17b64c(0x20f)])(_0x31bd86['id'],_0xeb26a5),_0x1bc404=_0x4c8188[_0x17b64c(0x247)][_0x17b64c(0x269)](/[_*]/g,''),_0x3510c4=await _0x31bd86['sendMessage'](_0x150b32[_0x17b64c(0x1cc)]+_0x17b64c(0x27c),{'text':'‎\x20*'+_0x173d44?.[_0x17b64c(0x2be)]+_0x17b64c(0x15e)+_0xb923b8});await(0x0,exports[_0x17b64c(0x2ec)])(_0x3510c4,_0x5b4c35,_0x150b32);if(_0xb923b8!=_0x19b59b)await(0x0,baileys_1[_0x17b64c(0x18c)])(0x1f4),_0x31bd86['sendPresenceUpdate'](_0x17b64c(0x1fb),_0x150b32[_0x17b64c(0x166)]);else _0x9ac7f8&&(_0x31bd86[_0x17b64c(0x202)](_0x17b64c(0x18a),_0x150b32[_0x17b64c(0x166)]),await(0x0,baileys_1[_0x17b64c(0x18c)])(0x1f4),_0x1bc404&&_0xb923b8[_0x17b64c(0x2a1)](_0x1bc404)&&(await(0x0,baileys_1['delay'])(0x3e8),setTimeout(async()=>{const _0x4d42bf=_0x17b64c;await _0x5b4c35[_0x4d42bf(0x1f8)]({'contactId':_0x5b4c35[_0x4d42bf(0x1b4)]['id'][_0x4d42bf(0x21b)](),'useIntegration':!![]}),await(0x0,UpdateTicketService_1[_0x4d42bf(0x20f)])({'ticketId':_0x5b4c35['id'],'ticketData':{'status':_0x4d42bf(0x25d)},'companyId':_0xeb26a5});},0xbb8)));}const verifyQueue=async(_0x5db2ed,_0x151349,_0x2058e9,_0x1374c0,_0x5a68b,_0x4fb951)=>{const _0x83631a=a627_0x2ed45c,_0x9c4a6e=_0x2058e9['companyId'],{queues:_0x3259ec,greetingMessage:_0x184be1,maxUseBotQueues:_0x176efb,timeUseBotQueues:_0x1f216c}=await(0x0,ShowWhatsAppService_1[_0x83631a(0x20f)])(_0x5db2ed['id'],_0x9c4a6e);let _0x3762a6=![];_0x3259ec[_0x83631a(0x2cd)]===0x1&&(_0x3762a6=_0x3259ec[0x0]?.[_0x83631a(0x1ec)][_0x83631a(0x2cd)]>0x1);const _0xd0d03b=_0x5a68b[_0x83631a(0x2b7)]===_0x83631a(0x1c0);if(_0x3259ec[_0x83631a(0x2cd)]===0x1&&!_0x3762a6){const _0x2bf767=_0x5a68b[_0x83631a(0x23a)]===_0x83631a(0x1c0)||![];if(!_0x151349['key'][_0x83631a(0x270)]&&!_0x2058e9['isGroup']&&_0x3259ec[0x0][_0x83631a(0x1b5)]){const _0x1c3e09=await(0x0,ShowQueueIntegrationService_1[_0x83631a(0x20f)])(_0x3259ec[0x0][_0x83631a(0x1b5)],_0x9c4a6e);await(0x0,exports['handleMessageIntegration'])(_0x151349,_0x5db2ed,_0x9c4a6e,_0x1c3e09,_0x2058e9),await _0x2058e9[_0x83631a(0x1f8)]({'useIntegration':!![],'integrationId':_0x1c3e09['id']});}if(_0x184be1[_0x83631a(0x2cd)]>0x1&&_0x2bf767){const _0x94f57e=(0x0,Mustache_1[_0x83631a(0x20f)])(''+_0x184be1,_0x2058e9);if(_0x2058e9[_0x83631a(0x1dd)]['greetingMediaAttachment']!==null){const _0x5555f7=path_1[_0x83631a(0x20f)]['resolve'](_0x83631a(0x262),_0x83631a(0x274)+_0x9c4a6e,_0x2058e9['whatsapp'][_0x83631a(0x22c)]),_0x3aab8a=_0x2058e9[_0x83631a(0x1dd)]['greetingMediaAttachment'],_0x31d237=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x3aab8a,_0x5555f7,String(_0x9c4a6e),_0x94f57e),_0x3b2c3a=(0x0,Debounce_1['debounce'])(async()=>{const _0x423823=_0x83631a,_0x85d423=await _0x5db2ed[_0x423823(0x2ab)](_0x2058e9['contact'][_0x423823(0x1cc)]+'@'+(_0x2058e9['isGroup']?_0x423823(0x2d2):_0x423823(0x1eb)),{..._0x31d237});await(0x0,exports[_0x423823(0x2e3)])(_0x85d423,_0x2058e9,_0x1374c0,_0x4fb951);},0x3e8,_0x2058e9['id']);_0x3b2c3a();}else await _0x5db2ed['sendMessage'](_0x1374c0['number']+'@'+(_0x2058e9[_0x83631a(0x268)]?_0x83631a(0x2d2):_0x83631a(0x1eb)),{'text':_0x94f57e});}if(!(0x0,lodash_1[_0x83631a(0x28d)])(_0x3259ec[0x0][_0x83631a(0x271)]))try{const _0x2af837=path_1[_0x83631a(0x20f)][_0x83631a(0x2aa)](__dirname,'..','..','..',_0x83631a(0x262)),_0x4a7599=await(0x0,ShowService_1['default'])(_0x3259ec[0x0][_0x83631a(0x271)],_0x2058e9[_0x83631a(0x172)]),_0x2a7422=path_1['default'][_0x83631a(0x2aa)](_0x2af837,_0x83631a(0x274)+_0x2058e9['companyId'],_0x83631a(0x28c),String(_0x4a7599['id']));for(const [_0x21c56,_0x214574]of _0x4a7599['options'][_0x83631a(0x1f4)]()){const _0x2f0be4={'fieldname':_0x83631a(0x291),'originalname':_0x214574[_0x83631a(0x1da)],'encoding':_0x83631a(0x15a),'mimetype':_0x214574[_0x83631a(0x1e1)],'filename':_0x214574[_0x83631a(0x1da)],'path':path_1[_0x83631a(0x20f)][_0x83631a(0x2aa)](_0x2a7422,_0x214574[_0x83631a(0x1da)])};await(0x0,SendWhatsAppMedia_1[_0x83631a(0x20f)])({'media':_0x2f0be4,'ticket':_0x2058e9,'body':_0x214574[_0x83631a(0x2be)],'isPrivate':![],'isForwarded':![]});};}catch(_0x4e555e){logger_1[_0x83631a(0x1e9)][_0x83631a(0x1f2)](_0x4e555e);}if(_0x3259ec[0x0]['closeTicket']){await(0x0,UpdateTicketService_1[_0x83631a(0x20f)])({'ticketData':{'status':_0x83631a(0x25d),'queueId':_0x3259ec[0x0]['id'],'sendFarewellMessage':![]},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});return;}else await(0x0,UpdateTicketService_1[_0x83631a(0x20f)])({'ticketData':{'queueId':_0x3259ec[0x0]['id']},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});const _0x5a0918=await Ticket_1[_0x83631a(0x20f)][_0x83631a(0x184)]({'where':{'userId':null,'status':_0x83631a(0x162),'companyId':_0x9c4a6e,'queueId':_0x3259ec[0x0]['id'],'isGroup':![]}});if(_0xd0d03b){const _0xf50fcf=_0x5a0918[_0x83631a(0x2e9)]===0x0?0x1:_0x5a0918[_0x83631a(0x2e9)],_0x5e93b0=_0x83631a(0x233)+_0xf50fcf+'*',_0x5d7c4e=(0x0,Mustache_1[_0x83631a(0x20f)])(''+_0x5e93b0,_0x2058e9),_0x56719b=(0x0,Debounce_1['debounce'])(async()=>{const _0x210fb3=_0x83631a;await _0x5db2ed[_0x210fb3(0x2ab)](_0x1374c0[_0x210fb3(0x1cc)]+'@'+(_0x2058e9[_0x210fb3(0x268)]?_0x210fb3(0x2d2):_0x210fb3(0x1eb)),{'text':_0x5d7c4e});},0xbb8,_0x2058e9['id']);_0x56719b();}return;}if(_0x1374c0[_0x83631a(0x2de)])return;let _0x53c587='';if(_0x2058e9[_0x83631a(0x2db)]!=='lgpd')_0x53c587=_0x151349?.[_0x83631a(0x27d)]?.[_0x83631a(0x19f)]?.['selectedButtonId']||_0x151349?.[_0x83631a(0x27d)]?.[_0x83631a(0x2a3)]?.[_0x83631a(0x226)]['selectedRowId']||(0x0,exports[_0x83631a(0x2a8)])(_0x151349);else{if(!(0x0,lodash_1[_0x83631a(0x28d)])(_0x2058e9['lgpdAcceptedAt']))await _0x2058e9[_0x83631a(0x1f8)]({'status':'pending'});await _0x2058e9[_0x83631a(0x28f)]();}if(_0x53c587[_0x83631a(0x255)]()==_0x83631a(0x168)){const _0x4c6e0f={'isBot':![],'status':_0x83631a(0x25d),'sendFarewellMessage':!![],'maxUseBotQueues':0x0};await(0x0,UpdateTicketService_1[_0x83631a(0x20f)])({'ticketData':_0x4c6e0f,'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});return;}let _0x478798=_0x3762a6&&_0x3259ec[_0x83631a(0x2cd)]===0x1?_0x3259ec[+_0x53c587]:_0x3259ec[+_0x53c587-0x1];if(!_0x151349[_0x83631a(0x2ce)][_0x83631a(0x270)]&&!_0x2058e9[_0x83631a(0x268)]&&_0x478798?.[_0x83631a(0x1b5)]){const _0x1793c0=await(0x0,ShowQueueIntegrationService_1['default'])(_0x478798[_0x83631a(0x1b5)],_0x9c4a6e);await(0x0,exports[_0x83631a(0x258)])(_0x151349,_0x5db2ed,_0x9c4a6e,_0x1793c0,_0x2058e9),await _0x2058e9[_0x83631a(0x1f8)]({'useIntegration':!![],'integrationId':_0x1793c0['id']});}const _0x7e4adf=_0x5a68b?.[_0x83631a(0x1c6)]||_0x83631a(0x2bc);let _0x3c2c9e;if(_0x478798)try{const _0x4aa266=await(0x0,ListUserQueueServices_1[_0x83631a(0x20f)])(_0x478798['id']);_0x4aa266['userId']>-0x1&&(_0x3c2c9e=_0x4aa266[_0x83631a(0x1fa)]);}catch(_0x10a2cf){console[_0x83631a(0x19d)](_0x10a2cf);}const _0x510962=async()=>{const _0x1ed73e=_0x83631a;if(_0x478798||_0x3259ec[_0x1ed73e(0x2cd)]===0x1&&_0x3762a6){if(_0x3259ec[_0x1ed73e(0x2cd)]===0x1)_0x478798=_0x3259ec[0x0];const _0x47e663=await Queue_1[_0x1ed73e(0x20f)][_0x1ed73e(0x25a)](_0x478798['id']);let _0xc67e3a;_0x5a68b?.[_0x1ed73e(0x2d6)]===_0x1ed73e(0x1af)&&(_0xc67e3a=await(0x0,VerifyCurrentSchedule_1[_0x1ed73e(0x20f)])(_0x9c4a6e,_0x47e663['id'],0x0));if(_0x5a68b?.[_0x1ed73e(0x2d6)]===_0x1ed73e(0x1af)&&!(0x0,lodash_1[_0x1ed73e(0x28d)])(_0xc67e3a)&&(!_0xc67e3a||_0xc67e3a[_0x1ed73e(0x24d)]===![])&&(!_0x2058e9[_0x1ed73e(0x268)]||_0x2058e9[_0x1ed73e(0x1dd)]?.[_0x1ed73e(0x214)]===_0x1ed73e(0x1c0))){const _0x5bc96b=_0x47e663[_0x1ed73e(0x1e5)];if(_0x5bc96b!==''){const _0x1fbc6e=(0x0,Mustache_1['default'])(''+_0x5bc96b,_0x2058e9),_0x3c61db=(0x0,Debounce_1[_0x1ed73e(0x1a4)])(async()=>{const _0x41c7f8=_0x1ed73e;await _0x5db2ed[_0x41c7f8(0x2ab)](_0x2058e9['contact'][_0x41c7f8(0x1cc)]+'@'+(_0x2058e9[_0x41c7f8(0x268)]?'g.us':_0x41c7f8(0x1eb)),{'text':_0x1fbc6e});},0x3e8,_0x2058e9['id']);_0x3c61db(),await _0x2058e9['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x2058e9[_0x1ed73e(0x2b2)]+0x1});return;}await _0x2058e9['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x2058e9[_0x1ed73e(0x2b2)]+0x1});return;}await(0x0,UpdateTicketService_1[_0x1ed73e(0x20f)])({'ticketData':{'amountUsedBotQueues':0x0,'queueId':_0x478798['id']},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});if(_0x478798[_0x1ed73e(0x1ec)][_0x1ed73e(0x2cd)]>0x0&&!_0x2058e9[_0x1ed73e(0x268)]){let _0x53d783='';_0x478798[_0x1ed73e(0x1ec)][_0x1ed73e(0x283)]((_0x143047,_0x50e106)=>{const _0x2f526d=_0x1ed73e;_0x53d783+='*[\x20'+(_0x50e106+0x1)+'\x20]*\x20-\x20'+_0x143047[_0x2f526d(0x2be)]+'\x0a';});const _0x470d4a=(0x0,Mustache_1[_0x1ed73e(0x20f)])('‎\x20'+_0x478798['greetingMessage']+'\x0a\x0a'+_0x53d783+_0x1ed73e(0x200),_0x2058e9),_0xdc331a=await _0x5db2ed[_0x1ed73e(0x2ab)](_0x1374c0[_0x1ed73e(0x1cc)]+'@'+(_0x2058e9[_0x1ed73e(0x268)]?_0x1ed73e(0x2d2):_0x1ed73e(0x1eb)),{'text':_0x470d4a});await(0x0,exports[_0x1ed73e(0x2ec)])(_0xdc331a,_0x2058e9,_0x1374c0,_0x4fb951),_0x5a68b?.[_0x1ed73e(0x169)]===_0x1ed73e(0x1c0)&&await(0x0,UpdateTicketService_1['default'])({'ticketData':{'userId':_0x3c2c9e},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});}if(!_0x478798[_0x1ed73e(0x1ec)][_0x1ed73e(0x2cd)]&&_0x478798[_0x1ed73e(0x272)][_0x1ed73e(0x2cd)]!==0x0){const _0x4e8e09=(0x0,Mustache_1['default'])('‎'+_0x478798[_0x1ed73e(0x272)],_0x2058e9),_0x1f0ff9=await _0x5db2ed[_0x1ed73e(0x2ab)](_0x1374c0[_0x1ed73e(0x1cc)]+'@'+(_0x2058e9[_0x1ed73e(0x268)]?_0x1ed73e(0x2d2):_0x1ed73e(0x1eb)),{'text':_0x4e8e09});await(0x0,exports[_0x1ed73e(0x2ec)])(_0x1f0ff9,_0x2058e9,_0x1374c0,_0x4fb951);}if(!(0x0,lodash_1[_0x1ed73e(0x28d)])(_0x478798[_0x1ed73e(0x271)]))try{const _0x5e71e3=path_1[_0x1ed73e(0x20f)][_0x1ed73e(0x2aa)](__dirname,'..','..','..',_0x1ed73e(0x262)),_0x26eb02=await(0x0,ShowService_1[_0x1ed73e(0x20f)])(_0x478798[_0x1ed73e(0x271)],_0x2058e9[_0x1ed73e(0x172)]),_0x547e1f=path_1[_0x1ed73e(0x20f)][_0x1ed73e(0x2aa)](_0x5e71e3,_0x1ed73e(0x274)+_0x2058e9[_0x1ed73e(0x172)],_0x1ed73e(0x28c),String(_0x26eb02['id']));for(const [_0x91c77e,_0x1b9279]of _0x26eb02['options'][_0x1ed73e(0x1f4)]()){const _0x15f21d={'fieldname':_0x1ed73e(0x291),'originalname':_0x1b9279[_0x1ed73e(0x1da)],'encoding':_0x1ed73e(0x15a),'mimetype':_0x1b9279[_0x1ed73e(0x1e1)],'filename':_0x1b9279[_0x1ed73e(0x1da)],'path':path_1[_0x1ed73e(0x20f)][_0x1ed73e(0x2aa)](_0x547e1f,_0x1b9279['path'])};await(0x0,SendWhatsAppMedia_1[_0x1ed73e(0x20f)])({'media':_0x15f21d,'ticket':_0x2058e9,'body':_0x1b9279[_0x1ed73e(0x2be)],'isPrivate':![],'isForwarded':![]});};await(0x0,baileys_1['delay'])(0x7d0);}catch(_0x2768bb){logger_1['logger'][_0x1ed73e(0x1f2)](_0x2768bb);}if(_0x478798[_0x1ed73e(0x292)]){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x1ed73e(0x25d),'queueId':_0x478798['id'],'sendFarewellMessage':![]},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e}),await(0x0,CreateLogTicketService_1[_0x1ed73e(0x20f)])({'ticketId':_0x2058e9['id'],'type':_0x1ed73e(0x25d),'queueId':_0x478798['id']});return;}const _0xd609e=await Ticket_1['default'][_0x1ed73e(0x184)]({'where':{'userId':null,'status':'pending','companyId':_0x9c4a6e,'queueId':_0x478798['id'],'isGroup':![]}});await(0x0,CreateLogTicketService_1[_0x1ed73e(0x20f)])({'ticketId':_0x2058e9['id'],'type':_0x1ed73e(0x1af),'queueId':_0x478798['id']});if(_0xd0d03b&&!_0x478798[_0x1ed73e(0x1ec)]['length']){const _0xe67452=_0xd609e[_0x1ed73e(0x2e9)]===0x0?0x1:_0xd609e['count'],_0x71050a=_0x1ed73e(0x233)+_0xe67452+'*',_0x4d18a8=(0x0,Mustache_1[_0x1ed73e(0x20f)])(''+_0x71050a,_0x2058e9),_0x13eb3d=(0x0,Debounce_1[_0x1ed73e(0x1a4)])(async()=>{const _0x22647f=_0x1ed73e;await _0x5db2ed['sendMessage'](_0x1374c0[_0x22647f(0x1cc)]+'@'+(_0x2058e9[_0x22647f(0x268)]?'g.us':'s.whatsapp.net'),{'text':_0x4d18a8});},0xbb8,_0x2058e9['id']);_0x13eb3d();}}else{if(_0x2058e9['isGroup'])return;if(_0x176efb&&_0x176efb!==0x0&&_0x2058e9[_0x1ed73e(0x2b2)]>=_0x176efb)return;const _0x192c01=await(0x0,FindOrCreateATicketTrakingService_1[_0x1ed73e(0x20f)])({'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});let _0x31d50f=new Date(),_0x590627=new Date();if(_0x192c01[_0x1ed73e(0x297)]!==null){_0x31d50f[_0x1ed73e(0x2ef)](_0x192c01[_0x1ed73e(0x297)]['getMinutes']()+Number(_0x1f216c));if(_0x192c01[_0x1ed73e(0x297)]!==null&&_0x590627<_0x31d50f&&_0x1f216c!=='0'&&_0x2058e9[_0x1ed73e(0x2b2)]!==0x0)return;}await _0x192c01['update']({'chatbotAt':null}),_0x5db2ed[_0x1ed73e(0x20c)](_0x1374c0[_0x1ed73e(0x166)]);let _0x3f93fd='';_0x5db2ed[_0x1ed73e(0x202)]('composing',_0x1374c0[_0x1ed73e(0x166)]),_0x3259ec[_0x1ed73e(0x283)]((_0x1fec9b,_0x2569a6)=>{const _0x2b1f64=_0x1ed73e;_0x3f93fd+=_0x2b1f64(0x2d1)+(_0x2569a6+0x1)+_0x2b1f64(0x22a)+_0x1fec9b[_0x2b1f64(0x2be)]+'\x0a';}),_0x3f93fd+=_0x1ed73e(0x18b);const _0x134424=(0x0,Mustache_1[_0x1ed73e(0x20f)])('‎'+_0x184be1+'\x0a\x0a'+_0x3f93fd,_0x2058e9);await(0x0,CreateLogTicketService_1[_0x1ed73e(0x20f)])({'ticketId':_0x2058e9['id'],'type':_0x1ed73e(0x29c)}),await(0x0,baileys_1[_0x1ed73e(0x18c)])(0x3e8),await _0x5db2ed[_0x1ed73e(0x202)](_0x1ed73e(0x240),_0x1374c0[_0x1ed73e(0x166)]);if(_0x2058e9[_0x1ed73e(0x1dd)][_0x1ed73e(0x22c)]!==null){const _0x2fcb83=path_1[_0x1ed73e(0x20f)][_0x1ed73e(0x2aa)](_0x1ed73e(0x262),_0x1ed73e(0x274)+_0x9c4a6e,_0x2058e9[_0x1ed73e(0x1dd)]['greetingMediaAttachment']),_0x50a4ff=_0x2058e9[_0x1ed73e(0x1dd)][_0x1ed73e(0x22c)],_0x6058c5=await(0x0,SendWhatsAppMedia_1[_0x1ed73e(0x18d)])(_0x50a4ff,_0x2fcb83,String(_0x9c4a6e),_0x134424),_0x3f61c2=(0x0,Debounce_1[_0x1ed73e(0x1a4)])(async()=>{const _0x33b20f=_0x1ed73e;let _0x1265a5=await _0x5db2ed[_0x33b20f(0x2ab)](_0x2058e9['contact'][_0x33b20f(0x1cc)]+'@'+(_0x2058e9[_0x33b20f(0x268)]?_0x33b20f(0x2d2):_0x33b20f(0x1eb)),{..._0x6058c5});await(0x0,exports['verifyMediaMessage'])(_0x1265a5,_0x2058e9,_0x1374c0,_0x192c01);},0x3e8,_0x2058e9['id']);_0x3f61c2(),await(0x0,UpdateTicketService_1[_0x1ed73e(0x20f)])({'ticketData':{'amountUsedBotQueues':_0x2058e9[_0x1ed73e(0x2b2)]+0x1},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});return;}else{const _0x2727ca=(0x0,Debounce_1['debounce'])(async()=>{const _0xacdc8b=_0x1ed73e,_0xa5f278=await _0x5db2ed[_0xacdc8b(0x2ab)](_0x1374c0[_0xacdc8b(0x1cc)]+'@'+(_0x2058e9['isGroup']?_0xacdc8b(0x2d2):_0xacdc8b(0x1eb)),{'text':_0x134424});(0x0,exports[_0xacdc8b(0x2ec)])(_0xa5f278,_0x2058e9,_0x1374c0,_0x192c01);},0x3e8,_0x2058e9['id']);await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':_0x2058e9['amountUsedBotQueues']+0x1},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e}),_0x2727ca();}}},_0x26e0fc=async()=>{const _0xd962c1=_0x83631a;if(_0x478798){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x478798['id']},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});if(_0x478798[_0xd962c1(0x1ec)][_0xd962c1(0x2cd)]>0x0){const _0x5cdf29=[];_0x478798[_0xd962c1(0x1ec)][_0xd962c1(0x283)]((_0x562427,_0x4f99f9)=>{const _0x2fc447=_0xd962c1;_0x5cdf29[_0x2fc447(0x29f)]({'buttonId':''+(_0x4f99f9+0x1),'buttonText':{'displayText':_0x562427['name']},'type':0x1});});const _0x47c540={'text':(0x0,Mustache_1[_0xd962c1(0x20f)])(''+_0x478798[_0xd962c1(0x272)],_0x2058e9),'buttons':_0x5cdf29,'headerType':0x4},_0x2afa60=await _0x5db2ed[_0xd962c1(0x2ab)](_0x1374c0[_0xd962c1(0x1cc)]+'@'+(_0x2058e9[_0xd962c1(0x268)]?_0xd962c1(0x2d2):'s.whatsapp.net'),_0x47c540);await(0x0,exports[_0xd962c1(0x2ec)])(_0x2afa60,_0x2058e9,_0x1374c0,_0x4fb951);}if(!_0x478798['chatbots'][_0xd962c1(0x2cd)]){const _0x3204e8=(0x0,Mustache_1['default'])(''+_0x478798['greetingMessage'],_0x2058e9),_0x584750=await _0x5db2ed[_0xd962c1(0x2ab)](_0x1374c0['number']+'@'+(_0x2058e9[_0xd962c1(0x268)]?_0xd962c1(0x2d2):_0xd962c1(0x1eb)),{'text':_0x3204e8});await(0x0,exports[_0xd962c1(0x2ec)])(_0x584750,_0x2058e9,_0x1374c0,_0x4fb951);}}else{const _0x16ca28=[];_0x3259ec[_0xd962c1(0x283)]((_0x332a5b,_0xb17b6a)=>{const _0x397980=_0xd962c1;_0x16ca28[_0x397980(0x29f)]({'buttonId':''+(_0xb17b6a+0x1),'buttonText':{'displayText':_0x332a5b['name']},'type':0x4});});const _0x309ee7={'text':(0x0,Mustache_1['default'])(''+_0x184be1,_0x2058e9),'footer':'','buttons':_0x16ca28,'headerType':0x4},_0x3bf453=await _0x5db2ed['sendMessage'](_0x1374c0[_0xd962c1(0x1cc)]+'@'+(_0x2058e9[_0xd962c1(0x268)]?_0xd962c1(0x2d2):_0xd962c1(0x1eb)),_0x309ee7);await(0x0,exports[_0xd962c1(0x2ec)])(_0x3bf453,_0x2058e9,_0x1374c0,_0x4fb951),await(0x0,UpdateTicketService_1[_0xd962c1(0x20f)])({'ticketData':{'amountUsedBotQueues':_0x2058e9[_0xd962c1(0x2b2)]+0x1},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});}},_0x273245=async()=>{const _0x986199=_0x83631a;if(_0x478798){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x478798['id']},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});if(_0x478798[_0x986199(0x1ec)][_0x986199(0x2cd)]>0x0){const _0x293e12=[];_0x478798['chatbots']['forEach']((_0x461b42,_0x4f2b9f)=>{const _0x4d61b6=_0x986199;_0x293e12[_0x4d61b6(0x29f)]({'title':_0x461b42[_0x4d61b6(0x2be)],'rowId':''+(_0x4f2b9f+0x1)});});const _0x7a72af=[{'title':_0x986199(0x1e4),'rows':_0x293e12}],_0xa9d1bd={'text':(0x0,Mustache_1[_0x986199(0x20f)])(''+_0x478798[_0x986199(0x272)],_0x2058e9),'buttonText':'Escolha\x20uma\x20opção','sections':_0x7a72af},_0x21a972=await _0x5db2ed[_0x986199(0x2ab)](_0x1374c0[_0x986199(0x1cc)]+'@'+(_0x2058e9[_0x986199(0x268)]?_0x986199(0x2d2):'s.whatsapp.net'),_0xa9d1bd);await(0x0,exports['verifyMessage'])(_0x21a972,_0x2058e9,_0x1374c0,_0x4fb951);}if(!_0x478798[_0x986199(0x1ec)][_0x986199(0x2cd)]){const _0x7b82d1=(0x0,Mustache_1[_0x986199(0x20f)])(''+_0x478798[_0x986199(0x272)],_0x2058e9),_0x414dcf=await _0x5db2ed[_0x986199(0x2ab)](_0x1374c0[_0x986199(0x1cc)]+'@'+(_0x2058e9[_0x986199(0x268)]?_0x986199(0x2d2):'s.whatsapp.net'),{'text':_0x7b82d1});await(0x0,exports[_0x986199(0x2ec)])(_0x414dcf,_0x2058e9,_0x1374c0,_0x4fb951);}}else{const _0x264347=[];_0x3259ec['forEach']((_0xb3f820,_0x4e9ccb)=>{const _0x5cef15=_0x986199;_0x264347[_0x5cef15(0x29f)]({'title':_0xb3f820[_0x5cef15(0x2be)],'rowId':''+(_0x4e9ccb+0x1)});});const _0xbba1b3=[{'title':'Menu','rows':_0x264347}],_0x5ed40a={'text':(0x0,Mustache_1[_0x986199(0x20f)])(''+_0x184be1,_0x2058e9),'buttonText':_0x986199(0x281),'sections':_0xbba1b3},_0x1ed945=await _0x5db2ed['sendMessage'](_0x1374c0[_0x986199(0x1cc)]+'@'+(_0x2058e9[_0x986199(0x268)]?'g.us':_0x986199(0x1eb)),_0x5ed40a);await(0x0,exports[_0x986199(0x2ec)])(_0x1ed945,_0x2058e9,_0x1374c0,_0x4fb951),await(0x0,UpdateTicketService_1[_0x986199(0x20f)])({'ticketData':{'amountUsedBotQueues':_0x2058e9[_0x986199(0x2b2)]+0x1},'ticketId':_0x2058e9['id'],'companyId':_0x9c4a6e});}};if(_0x7e4adf==='text')return _0x510962();if(_0x7e4adf===_0x83631a(0x2ea)&&_0x3259ec[_0x83631a(0x2cd)]>0x3)return _0x510962();if(_0x7e4adf==='button'&&_0x3259ec[_0x83631a(0x2cd)]<=0x3)return _0x26e0fc();if(_0x7e4adf==='list')return _0x273245();},verifyRating=_0x5730ba=>{const _0x25e024=a627_0x2ed45c;if(_0x5730ba&&_0x5730ba[_0x25e024(0x294)]===null&&_0x5730ba['closedAt']!==null&&_0x5730ba[_0x25e024(0x1fa)]!==null&&_0x5730ba[_0x25e024(0x245)]===null)return!![];return![];};exports[a627_0x2ed45c(0x201)]=verifyRating;const handleRating=async(_0x111b6d,_0x1db5a0,_0x23b732)=>{const _0x468c1c=a627_0x2ed45c,_0x306f84=(0x0,socket_1[_0x468c1c(0x179)])(),_0x1f5cda=_0x1db5a0[_0x468c1c(0x172)],{complationMessage:_0x4ceac8}=await(0x0,ShowWhatsAppService_1[_0x468c1c(0x20f)])(_0x1db5a0[_0x468c1c(0x246)],_0x1f5cda);let _0x5391cc=_0x111b6d;_0x111b6d<0x0&&(_0x5391cc=0x0);_0x111b6d>0xa&&(_0x5391cc=0xa);await UserRating_1[_0x468c1c(0x20f)][_0x468c1c(0x19e)]({'ticketId':_0x23b732['ticketId'],'companyId':_0x23b732[_0x468c1c(0x172)],'userId':_0x23b732[_0x468c1c(0x1fa)],'rate':_0x5391cc});if(!(0x0,lodash_1[_0x468c1c(0x28d)])(_0x4ceac8)&&_0x4ceac8!==''&&!_0x1db5a0[_0x468c1c(0x268)]){const _0x541602=(0x0,Mustache_1[_0x468c1c(0x20f)])('‎'+_0x4ceac8,_0x1db5a0);if(_0x1db5a0[_0x468c1c(0x2cb)]===_0x468c1c(0x1dd)){const _0x415ace=await(0x0,SendWhatsAppMessage_1[_0x468c1c(0x20f)])({'body':_0x541602,'ticket':_0x1db5a0});await(0x0,exports[_0x468c1c(0x2ec)])(_0x415ace,_0x1db5a0,_0x1db5a0['contact'],_0x23b732);}['facebook',_0x468c1c(0x1d5)][_0x468c1c(0x2a1)](_0x1db5a0[_0x468c1c(0x2cb)])&&await(0x0,sendFacebookMessage_1['default'])({'body':_0x541602,'ticket':_0x1db5a0});}await _0x1db5a0[_0x468c1c(0x1f8)]({'chatbot':null,'status':_0x468c1c(0x25d),'amountUseBotQueuesNPS':0x0}),await(0x0,CreateLogTicketService_1['default'])({'userId':_0x1db5a0[_0x468c1c(0x1fa)],'queueId':_0x1db5a0[_0x468c1c(0x205)],'ticketId':_0x1db5a0['id'],'type':_0x468c1c(0x25d)}),_0x306f84['to'](_0x468c1c(0x15d))[_0x468c1c(0x23d)](_0x468c1c(0x1db)+_0x1f5cda+_0x468c1c(0x25f),{'action':_0x468c1c(0x1cd),'ticket':_0x1db5a0,'ticketId':_0x1db5a0['id']}),_0x306f84['to'](_0x1db5a0[_0x468c1c(0x2db)])['to'](_0x1db5a0['id'][_0x468c1c(0x21b)]())[_0x468c1c(0x23d)](_0x468c1c(0x1db)+_0x1f5cda+_0x468c1c(0x25f),{'action':_0x468c1c(0x1f8),'ticket':_0x1db5a0,'ticketId':_0x1db5a0['id']});};exports[a627_0x2ed45c(0x17d)]=handleRating;const sanitizeName=_0x529ab1=>{const _0x114294=a627_0x2ed45c;let _0x20d4eb=_0x529ab1[_0x114294(0x282)]('\x20')[0x0];return _0x20d4eb=_0x20d4eb[_0x114294(0x269)](/[^a-zA-Z0-9]/g,''),_0x20d4eb[_0x114294(0x241)](0x0,0x3c);},deleteFileSync=_0xd905dd=>{const _0x355647=a627_0x2ed45c;try{fs_2[_0x355647(0x20f)][_0x355647(0x223)](_0xd905dd);}catch(_0x322e07){console[_0x355647(0x19d)](_0x355647(0x2a0),_0x322e07);}},convertTextToSpeechAndSaveToFile=(_0x28939d,_0x154290,_0xd544d4,_0x2e7e94,_0x5c2f96='pt-BR-FabioNeural',_0x508b15='mp3')=>{return new Promise((_0x3f644c,_0xa72808)=>{const _0x27aaa5=a627_0x4baf,_0x10f402=microsoft_cognitiveservices_speech_sdk_1[_0x27aaa5(0x1ce)]['fromSubscription'](_0xd544d4,_0x2e7e94);_0x10f402[_0x27aaa5(0x177)]=_0x5c2f96;const _0x11c7ae=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x27aaa5(0x254)](_0x154290+_0x27aaa5(0x225)),_0x543cb6=new microsoft_cognitiveservices_speech_sdk_1[(_0x27aaa5(0x2bb))](_0x10f402,_0x11c7ae);_0x543cb6[_0x27aaa5(0x1b9)](_0x28939d,_0x54befe=>{const _0xf5d20c=_0x27aaa5;_0x54befe?convertWavToAnotherFormat(_0x154290+_0xf5d20c(0x225),_0x154290+'.'+_0x508b15,_0x508b15)['then'](_0x56bca2=>{_0x3f644c();})['catch'](_0x7ed309=>{console['error'](_0x7ed309),_0xa72808(_0x7ed309);}):_0xa72808(new Error(_0xf5d20c(0x27e))),_0x543cb6['close']();},_0x2b4010=>{const _0x470452=_0x27aaa5;console[_0x470452(0x19d)](_0x470452(0x2e6)+_0x2b4010),_0x543cb6['close'](),_0xa72808(_0x2b4010);});});},convertWavToAnotherFormat=(_0x2ecfca,_0x133584,_0x2f5e49)=>{return new Promise((_0x1a9b36,_0x1d5669)=>{const _0x2520e2=a627_0x4baf;(0x0,fluent_ffmpeg_1[_0x2520e2(0x20f)])()[_0x2520e2(0x161)](_0x2ecfca)[_0x2520e2(0x215)](_0x2f5e49)['on']('end',()=>_0x1a9b36(_0x133584))['on']('error',_0x3dcb16=>_0x1d5669(new Error(_0x2520e2(0x19b)+_0x3dcb16[_0x2520e2(0x27d)])))[_0x2520e2(0x284)](_0x133584);});},keepOnlySpecifiedChars=_0x53b8ac=>{const _0x384da9=a627_0x2ed45c;return _0x53b8ac[_0x384da9(0x269)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x3855d9,_0x75db34,_0x5f2daa,_0x4efcce,_0x39405d)=>{const _0x15e032=a627_0x2ed45c,_0xfcbce4=(0x0,exports['getBodyMessage'])(_0x3855d9);if(!_0xfcbce4)return;const {prompt:_0x460d5e}=await(0x0,ShowWhatsAppService_1[_0x15e032(0x20f)])(_0x75db34['id'],_0x5f2daa[_0x15e032(0x172)]);if(!_0x460d5e)return;if(_0x3855d9[_0x15e032(0x278)])return;const _0x23ef3f=path_1[_0x15e032(0x20f)][_0x15e032(0x2aa)](__dirname,'..','..','..',_0x15e032(0x262),_0x15e032(0x274)+_0x5f2daa[_0x15e032(0x172)]);let _0x24d8af;const _0x97ee8c=sessionsOpenAi[_0x15e032(0x213)](_0x4cc83f=>_0x4cc83f['id']===_0x75db34['id']);if(_0x97ee8c===-0x1){const _0x3e22ad=new openai_1[(_0x15e032(0x2cc))]({'apiKey':_0x460d5e[_0x15e032(0x2a4)]});_0x24d8af=new openai_1[(_0x15e032(0x1a7))](_0x3e22ad),_0x24d8af['id']=_0x75db34['id'],sessionsOpenAi[_0x15e032(0x29f)](_0x24d8af);}else _0x24d8af=sessionsOpenAi[_0x97ee8c];const _0x23d773=await Message_1[_0x15e032(0x20f)][_0x15e032(0x2d5)]({'where':{'ticketId':_0x5f2daa['id']},'order':[['createdAt','ASC']],'limit':_0x460d5e['maxMessages']}),_0x51b3b1='Nas\x20respostas\x20utilize\x20o\x20nome\x20'+sanitizeName(_0x4efcce[_0x15e032(0x2be)]||_0x15e032(0x1e8))+'\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20'+_0x460d5e[_0x15e032(0x1f7)]+_0x15e032(0x20d)+_0x460d5e['prompt']+'\x0a';let _0x41b6a1=[];if(_0x3855d9[_0x15e032(0x27d)]?.[_0x15e032(0x1a8)]||_0x3855d9[_0x15e032(0x27d)]?.['extendedTextMessage']?.[_0x15e032(0x2bc)]){_0x41b6a1=[],_0x41b6a1[_0x15e032(0x29f)]({'role':_0x15e032(0x211),'content':_0x51b3b1});for(let _0x477412=0x0;_0x477412<Math[_0x15e032(0x167)](_0x460d5e['maxMessages'],_0x23d773[_0x15e032(0x2cd)]);_0x477412++){const _0x3393fb=_0x23d773[_0x477412];_0x3393fb[_0x15e032(0x1e1)]==='chat'&&(_0x3393fb[_0x15e032(0x270)]?_0x41b6a1['push']({'role':_0x15e032(0x1d6),'content':_0x3393fb[_0x15e032(0x2ac)]}):_0x41b6a1[_0x15e032(0x29f)]({'role':_0x15e032(0x218),'content':_0x3393fb['body']}));}_0x41b6a1[_0x15e032(0x29f)]({'role':'user','content':_0xfcbce4});const _0x36cb74=await _0x24d8af[_0x15e032(0x2b3)]({'model':_0x15e032(0x248),'messages':_0x41b6a1,'max_tokens':_0x460d5e[_0x15e032(0x1f7)],'temperature':_0x460d5e['temperature']});let _0x2b669a=_0x36cb74[_0x15e032(0x289)][_0x15e032(0x1d1)][0x0]['message']?.[_0x15e032(0x29e)];_0x2b669a?.[_0x15e032(0x2a1)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x460d5e[_0x15e032(0x205)],_0x5f2daa,_0x4efcce),_0x2b669a=_0x2b669a[_0x15e032(0x269)](_0x15e032(0x2d3),'')[_0x15e032(0x290)]());if(_0x460d5e['voice']===_0x15e032(0x208)){const _0x2a24ff=await _0x75db34[_0x15e032(0x2ab)](_0x3855d9['key'][_0x15e032(0x166)],{'text':_0x2b669a});await(0x0,exports[_0x15e032(0x2ec)])(_0x2a24ff,_0x5f2daa,_0x4efcce);}else{const _0x564e48=_0x5f2daa['id']+'_'+Date['now']();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x2b669a),_0x23ef3f+'/'+_0x564e48,_0x460d5e[_0x15e032(0x2c4)],_0x460d5e['voiceRegion'],_0x460d5e[_0x15e032(0x178)],_0x15e032(0x2ba))[_0x15e032(0x1b1)](async()=>{const _0x527092=_0x15e032;try{const _0x1d2f1d=await _0x75db34[_0x527092(0x2ab)](_0x3855d9[_0x527092(0x2ce)]['remoteJid'],{'audio':{'url':_0x23ef3f+'/'+_0x564e48+_0x527092(0x2e0)},'mimetype':'audio/mpeg','ptt':!![]});await(0x0,exports['verifyMediaMessage'])(_0x1d2f1d,_0x5f2daa,_0x4efcce),deleteFileSync(_0x23ef3f+'/'+_0x564e48+_0x527092(0x2e0)),deleteFileSync(_0x23ef3f+'/'+_0x564e48+'.wav');}catch(_0x30afdd){console[_0x527092(0x1ab)](_0x527092(0x250)+_0x30afdd);}});}}else{if(_0x3855d9[_0x15e032(0x27d)]?.['audioMessage']){const _0x1feb64=_0x39405d[_0x15e032(0x2c1)][_0x15e032(0x282)]('/')['pop'](),_0x3385ca=fs_2[_0x15e032(0x20f)]['createReadStream'](_0x23ef3f+'/'+_0x1feb64),_0x2e8c09=await _0x24d8af['createTranscription'](_0x3385ca,_0x15e032(0x212));_0x41b6a1=[],_0x41b6a1[_0x15e032(0x29f)]({'role':'system','content':_0x51b3b1});for(let _0x31ff63=0x0;_0x31ff63<Math[_0x15e032(0x167)](_0x460d5e['maxMessages'],_0x23d773[_0x15e032(0x2cd)]);_0x31ff63++){const _0x311380=_0x23d773[_0x31ff63];_0x311380['mediaType']===_0x15e032(0x24f)&&(_0x311380[_0x15e032(0x270)]?_0x41b6a1['push']({'role':'assistant','content':_0x311380[_0x15e032(0x2ac)]}):_0x41b6a1[_0x15e032(0x29f)]({'role':_0x15e032(0x218),'content':_0x311380[_0x15e032(0x2ac)]}));}_0x41b6a1[_0x15e032(0x29f)]({'role':_0x15e032(0x218),'content':_0x2e8c09['data']['text']});const _0x4aea13=await _0x24d8af['createChatCompletion']({'model':_0x15e032(0x248),'messages':_0x41b6a1,'max_tokens':_0x460d5e[_0x15e032(0x1f7)],'temperature':_0x460d5e['temperature']});let _0x1d42d4=_0x4aea13['data']['choices'][0x0][_0x15e032(0x27d)]?.[_0x15e032(0x29e)];_0x1d42d4?.[_0x15e032(0x2a1)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x460d5e[_0x15e032(0x205)],_0x5f2daa,_0x4efcce),_0x1d42d4=_0x1d42d4[_0x15e032(0x269)](_0x15e032(0x2d3),'')[_0x15e032(0x290)]());if(_0x460d5e[_0x15e032(0x178)]===_0x15e032(0x208)){const _0x421066=await _0x75db34[_0x15e032(0x2ab)](_0x3855d9[_0x15e032(0x2ce)][_0x15e032(0x166)],{'text':_0x1d42d4});await(0x0,exports[_0x15e032(0x2ec)])(_0x421066,_0x5f2daa,_0x4efcce);}else{const _0x9c0054=_0x5f2daa['id']+'_'+Date[_0x15e032(0x2b5)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x1d42d4),_0x23ef3f+'/'+_0x9c0054,_0x460d5e[_0x15e032(0x2c4)],_0x460d5e['voiceRegion'],_0x460d5e[_0x15e032(0x178)],_0x15e032(0x2ba))[_0x15e032(0x1b1)](async()=>{const _0x2b1fb7=_0x15e032;try{const _0x296bb2=await _0x75db34['sendMessage'](_0x3855d9['key'][_0x2b1fb7(0x166)],{'audio':{'url':_0x23ef3f+'/'+_0x9c0054+'.mp3'},'mimetype':_0x2b1fb7(0x2c8),'ptt':!![]});await(0x0,exports['verifyMediaMessage'])(_0x296bb2,_0x5f2daa,_0x4efcce),deleteFileSync(_0x23ef3f+'/'+_0x9c0054+_0x2b1fb7(0x2e0)),deleteFileSync(_0x23ef3f+'/'+_0x9c0054+_0x2b1fb7(0x225));}catch(_0x2ca6ce){console[_0x2b1fb7(0x1ab)](_0x2b1fb7(0x250)+_0x2ca6ce);}});}}}_0x41b6a1=[];},transferQueue=async(_0x35538e,_0x2e5213,_0x41dda3)=>{const _0x4c826d=a627_0x2ed45c;await(0x0,UpdateTicketService_1[_0x4c826d(0x20f)])({'ticketData':{'queueId':_0x35538e},'ticketId':_0x2e5213['id'],'companyId':_0x2e5213['companyId']});},handleMessageIntegration=async(_0x72dcab,_0x5dd4bd,_0x40465f,_0x46679e,_0x39b368)=>{const _0x1b8785=a627_0x2ed45c,_0x104a92=getTypeMessage(_0x72dcab);if(_0x46679e[_0x1b8785(0x2e2)]===_0x1b8785(0x29d)||_0x46679e[_0x1b8785(0x2e2)]==='webhook'){if(_0x46679e?.[_0x1b8785(0x1a1)]){const _0x480d5e={'method':_0x1b8785(0x1c5),'url':_0x46679e?.['urlN8N'],'headers':{'Content-Type':_0x1b8785(0x1d7)},'json':_0x72dcab};try{request(_0x480d5e,function(_0x18088d,_0x2c1dd3){const _0x58c721=_0x1b8785;if(_0x18088d)throw new Error(_0x18088d);else console['log'](_0x2c1dd3[_0x58c721(0x2ac)]);});}catch(_0x11f166){throw new Error(_0x11f166);}}}else{if(_0x46679e['type']===_0x1b8785(0x298)){let _0xcd143;if(_0x104a92===_0x1b8785(0x159)){let _0xd0d6ba=_0x72dcab['messageTimestamp']+'.ogg';(0x0,fs_1['readFile'])((0x0,path_1[_0x1b8785(0x1ba)])(__dirname,'..','..','..',_0x1b8785(0x262),_0x1b8785(0x274)+_0x40465f,_0xd0d6ba),_0x1b8785(0x21e),(_0x19d3fb,_0x16e463)=>{const _0x1b4d83=_0x1b8785;_0xcd143=_0x16e463,_0x19d3fb&&logger_1[_0x1b4d83(0x1e9)][_0x1b4d83(0x19d)](_0x19d3fb);});}else _0xcd143=undefined;const _0x4633bf=(0x0,Debounce_1[_0x1b8785(0x1a4)])(async()=>{await sendDialogflowAwswer(_0x5dd4bd,_0x39b368,_0x72dcab,_0x39b368['contact'],_0xcd143,_0x40465f,_0x46679e);},0x1f4,_0x39b368['id']);_0x4633bf();}else _0x46679e[_0x1b8785(0x2e2)]===_0x1b8785(0x1c7)&&(console[_0x1b8785(0x1ab)](_0x1b8785(0x18f)),await(0x0,typebotListener_1['default'])({'wbot':_0x5dd4bd,'msg':_0x72dcab,'ticket':_0x39b368,'typebot':_0x46679e}));}};exports['handleMessageIntegration']=handleMessageIntegration;const handleMessage=async(_0x57cbdf,_0x2fe7a2,_0x42843c,_0x2ef3e1=![])=>{const _0x14d954=a627_0x2ed45c;if(_0x2ef3e1){(0x0,addLogs_1['addLogs'])({'fileName':_0x14d954(0x1bc)+_0x2fe7a2['id']+_0x14d954(0x236),'text':_0x14d954(0x21a)+JSON[_0x14d954(0x207)](_0x57cbdf,null,0x2)+'>>>>>>>>>>>>>>>>>>>'});let _0x3cc416=_0x57cbdf[_0x14d954(0x2ce)]['id'],_0x26d9d4=await Message_1[_0x14d954(0x20f)][_0x14d954(0x263)]({'where':{'wid':_0x3cc416}});if(_0x26d9d4){await new Promise(_0x3dca5f=>setTimeout(_0x3dca5f,0x96)),console['log'](_0x14d954(0x174));return;}else await new Promise(_0x54ad11=>setTimeout(_0x54ad11,parseInt(process[_0x14d954(0x2d9)]['TIMEOUT_TO_IMPORT_MESSAGE'])||0x14a));}else await new Promise(_0x34021d=>setTimeout(_0x34021d,i*0x28a)),i++;if(!isValidMsg(_0x57cbdf))return;try{let _0x16e9f8,_0x53d647,_0x176be5=0x0,_0x253688=0x0,_0x2b7760=0x0,_0x181234=(0x0,exports[_0x14d954(0x2a8)])(_0x57cbdf);const _0x15e0fe=getTypeMessage(_0x57cbdf);if(_0x15e0fe===_0x14d954(0x2ad))return;const _0x3ef65d=_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x159)]||_0x57cbdf['message']?.[_0x14d954(0x206)]||_0x57cbdf[_0x14d954(0x27d)]?.['videoMessage']||_0x57cbdf['message']?.['documentMessage']||_0x57cbdf['message'][_0x14d954(0x2da)]||_0x57cbdf?.[_0x14d954(0x27d)]?.[_0x14d954(0x252)]?.['message']?.[_0x14d954(0x206)]||_0x57cbdf?.[_0x14d954(0x27d)]?.[_0x14d954(0x252)]?.[_0x14d954(0x27d)]?.[_0x14d954(0x159)]||_0x57cbdf?.[_0x14d954(0x27d)]?.['ephemeralMessage']?.[_0x14d954(0x27d)]?.[_0x14d954(0x296)]||_0x57cbdf?.[_0x14d954(0x27d)]?.[_0x14d954(0x252)]?.[_0x14d954(0x27d)]?.[_0x14d954(0x1e7)]||_0x57cbdf?.[_0x14d954(0x27d)]?.[_0x14d954(0x252)]?.['message']?.['stickerMessage']||_0x57cbdf[_0x14d954(0x27d)]?.['viewOnceMessage']?.[_0x14d954(0x27d)]?.[_0x14d954(0x206)]||_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x195)]?.['message']?.['videoMessage']||_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x252)]?.[_0x14d954(0x27d)]?.[_0x14d954(0x195)]?.[_0x14d954(0x27d)]?.[_0x14d954(0x206)]||_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x252)]?.[_0x14d954(0x27d)]?.[_0x14d954(0x195)]?.[_0x14d954(0x27d)]?.[_0x14d954(0x296)]||_0x57cbdf['message']?.[_0x14d954(0x2ae)]?.['message']?.['documentMessage'];if(_0x57cbdf['key'][_0x14d954(0x270)]){if(/\u200e/['test'](_0x181234))return;if(!_0x3ef65d&&_0x15e0fe!==_0x14d954(0x1a8)&&_0x15e0fe!==_0x14d954(0x1a6)&&_0x15e0fe!==_0x14d954(0x17f)&&_0x15e0fe!==_0x14d954(0x2e4)&&_0x15e0fe!=='ephemeralMessage'&&_0x15e0fe!=='protocolMessage'&&_0x15e0fe!==_0x14d954(0x195)&&_0x15e0fe!==_0x14d954(0x1e2))return;_0x16e9f8=await getContactMessage(_0x57cbdf,_0x2fe7a2);}else _0x16e9f8=await getContactMessage(_0x57cbdf,_0x2fe7a2);const _0x2351d1=_0x57cbdf[_0x14d954(0x2ce)][_0x14d954(0x166)]?.[_0x14d954(0x238)](_0x14d954(0x194)),_0x26e671=await(0x0,ShowWhatsAppService_1['default'])(_0x2fe7a2['id'],_0x42843c);if(!_0x26e671['allowGroup']&&_0x2351d1)return;if(_0x2351d1){const _0x47d96f=await _0x2fe7a2[_0x14d954(0x17c)](_0x57cbdf[_0x14d954(0x2ce)]['remoteJid']),_0x8c63ad={'id':_0x47d96f['id'],'name':_0x47d96f[_0x14d954(0x16b)]};_0x53d647=await verifyContact(_0x8c63ad,_0x2fe7a2,_0x42843c);}const _0x5b203e=await verifyContact(_0x16e9f8,_0x2fe7a2,_0x42843c);let _0x467b62=0x0,_0x415b87=null;if(_0x57cbdf['key'][_0x14d954(0x270)])await cache_1['default'][_0x14d954(0x19c)](_0x14d954(0x15c)+_0x5b203e['id']+_0x14d954(0x16f),'0');else{const _0x413aee=await cache_1[_0x14d954(0x20f)][_0x14d954(0x287)](_0x14d954(0x15c)+_0x5b203e['id']+_0x14d954(0x16f));_0x467b62=+_0x413aee+0x1,await cache_1[_0x14d954(0x20f)]['set'](_0x14d954(0x15c)+_0x5b203e['id']+_0x14d954(0x16f),''+_0x467b62);}const _0xb77292=await CompaniesSettings_1[_0x14d954(0x20f)][_0x14d954(0x263)]({'where':{'companyId':_0x42843c}}),_0xb6f6a5=_0xb77292[_0x14d954(0x2b4)]===_0x14d954(0x1c0),{ticket:_0x1cfecf,isCreated:_0x10514f}=await(0x0,FindOrCreateTicketService_1[_0x14d954(0x20f)])(_0x5b203e,_0x26e671,_0x467b62,_0x42843c,_0x176be5,_0x2b7760,_0x53d647,_0x14d954(0x1dd),_0x2ef3e1,![],_0xb77292);_0x415b87=_0x1cfecf;if(_0x415b87[_0x14d954(0x2db)]===_0x14d954(0x25d)||_0x467b62===0x0&&_0x26e671[_0x14d954(0x259)]&&(0x0,Mustache_1[_0x14d954(0x20f)])(_0x26e671[_0x14d954(0x259)],_0x415b87)===_0x181234)return;if(!_0x57cbdf[_0x14d954(0x2ce)][_0x14d954(0x270)]&&_0x26e671?.['integrationId']>0x0){const _0x1b723c=await(0x0,ShowQueueIntegrationService_1[_0x14d954(0x20f)])(_0x26e671[_0x14d954(0x1b5)],_0x42843c);await(0x0,exports[_0x14d954(0x258)])(_0x57cbdf,_0x2fe7a2,_0x42843c,_0x1b723c,_0x415b87),await _0x415b87[_0x14d954(0x1f8)]({'useIntegration':!![],'integrationId':_0x1b723c['id']});}if(_0x15e0fe===_0x14d954(0x1e2)){const _0x2063c9=_0x57cbdf[_0x14d954(0x27d)]['editedMessage']['message']['protocolMessage'][_0x14d954(0x2ce)]['id'],_0x4c0b37=_0x57cbdf['message'][_0x14d954(0x1e2)][_0x14d954(0x27d)]['protocolMessage'][_0x14d954(0x1e2)][_0x14d954(0x1a8)],_0x5e1635=(0x0,socket_1[_0x14d954(0x179)])();try{const _0x39b965=await Message_1[_0x14d954(0x20f)][_0x14d954(0x263)]({'where':{'wid':_0x2063c9,'companyId':_0x42843c,'ticketId':_0x415b87['id']}});if(!_0x39b965)return;await _0x39b965[_0x14d954(0x1f8)]({'isEdited':!![],'body':_0x4c0b37}),await _0x415b87['update']({'lastMessage':_0x4c0b37}),_0x5e1635['to'](_0x39b965[_0x14d954(0x26e)][_0x14d954(0x21b)]())[_0x14d954(0x23d)](_0x14d954(0x1db)+_0x39b965[_0x14d954(0x172)]+'-appMessage',{'action':_0x14d954(0x1f8),'message':_0x39b965});}catch(_0x47688c){Sentry['captureException'](_0x47688c),logger_1[_0x14d954(0x1e9)][_0x14d954(0x19d)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x47688c);}return;}const _0x238ef0=await(0x0,FindOrCreateATicketTrakingService_1[_0x14d954(0x20f)])({'ticketId':_0x415b87['id'],'companyId':_0x42843c,'whatsappId':_0x26e671?.['id']});try{if(!_0x57cbdf[_0x14d954(0x2ce)][_0x14d954(0x270)]){if(_0x415b87[_0x14d954(0x2db)]===_0x14d954(0x16e)&&_0x238ef0!==null&&(0x0,exports[_0x14d954(0x201)])(_0x238ef0)){_0x3ef65d?await(0x0,exports[_0x14d954(0x2e3)])(_0x57cbdf,_0x415b87,_0x5b203e):await(0x0,exports['verifyMessage'])(_0x57cbdf,_0x415b87,_0x5b203e,_0x238ef0);if(!isNaN(parseFloat(_0x181234))){(0x0,exports[_0x14d954(0x17d)])(parseFloat(_0x181234),_0x415b87,_0x238ef0),await _0x238ef0[_0x14d954(0x1f8)]({'ratingAt':(0x0,moment_1['default'])()[_0x14d954(0x25e)](),'finishedAt':(0x0,moment_1[_0x14d954(0x20f)])()[_0x14d954(0x25e)](),'rated':!![]});return;}else{if(_0x415b87[_0x14d954(0x1fe)]<_0x26e671[_0x14d954(0x2b1)]){let _0x1115c3=_0x14d954(0x2eb);const _0x129e70=await _0x2fe7a2[_0x14d954(0x2ab)](_0x415b87[_0x14d954(0x1b4)][_0x14d954(0x1cc)]+'@'+(_0x415b87['isGroup']?_0x14d954(0x2d2):_0x14d954(0x1eb)),{'text':_0x1115c3});(0x0,exports[_0x14d954(0x2ec)])(_0x129e70,_0x415b87,_0x5b203e,_0x238ef0),await(0x0,baileys_1[_0x14d954(0x18c)])(0x3e8);let _0x1c3c54='‎'+_0x26e671[_0x14d954(0x198)]+'\x0a';const _0x5b856f=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x1c3c54,'ticket':_0x415b87});await(0x0,exports[_0x14d954(0x2ec)])(_0x5b856f,_0x415b87,_0x415b87[_0x14d954(0x1b4)]),await _0x415b87['update']({'amountUseBotQueuesNPS':_0x415b87[_0x14d954(0x1fe)]+0x1});}return;}}if(_0xb6f6a5&&_0x415b87[_0x14d954(0x2db)]===_0x14d954(0x203)&&!_0x2ef3e1){if((0x0,lodash_1[_0x14d954(0x28d)])(_0x415b87[_0x14d954(0x2f1)])&&!(0x0,lodash_1['isNil'])(_0x415b87[_0x14d954(0x1e6)])){let _0x4664a6=parseFloat(_0x181234);if(!Number[_0x14d954(0x1fd)](_0x4664a6)&&Number['isInteger'](_0x4664a6)&&!(0x0,lodash_1[_0x14d954(0x22b)])(_0x4664a6)&&_0x4664a6>0x0){if(_0x4664a6===0x1)await _0x5b203e['update']({'lgpdAcceptedAt':(0x0,moment_1[_0x14d954(0x20f)])()[_0x14d954(0x25e)]()}),await _0x415b87[_0x14d954(0x1f8)]({'lgpdAcceptedAt':(0x0,moment_1[_0x14d954(0x20f)])()['toDate'](),'amountUsedBotQueues':0x0});else{if(_0x4664a6===0x2){if(_0x26e671[_0x14d954(0x259)]!==''&&_0x26e671['complationMessage']!==undefined){const _0x42cb9d=await _0x2fe7a2[_0x14d954(0x2ab)](_0x415b87[_0x14d954(0x1b4)][_0x14d954(0x1cc)]+'@'+(_0x415b87[_0x14d954(0x268)]?'g.us':_0x14d954(0x1eb)),{'text':'‎'+_0x26e671['complationMessage']});(0x0,exports[_0x14d954(0x2ec)])(_0x42cb9d,_0x415b87,_0x5b203e,_0x238ef0);}await _0x415b87[_0x14d954(0x1f8)]({'status':'closed','amountUsedBotQueues':0x0}),await _0x238ef0[_0x14d954(0x29a)];return;}else _0x415b87['amountUsedBotQueues']<_0x26e671[_0x14d954(0x1bd)]&&_0x26e671['maxUseBotQueues']>0x0&&await _0x415b87[_0x14d954(0x1f8)]({'amountUsedBotQueues':_0x415b87[_0x14d954(0x2b2)]+0x1,'lgpdSendMessageAt':null});}}else _0x415b87[_0x14d954(0x2b2)]<_0x26e671['maxUseBotQueues']&&_0x26e671[_0x14d954(0x1bd)]>0x0&&await _0x415b87['update']({'amountUsedBotQueues':_0x415b87[_0x14d954(0x2b2)]+0x1,'lgpdSendMessageAt':null});}if((_0x5b203e[_0x14d954(0x2f1)]===null||_0xb77292?.[_0x14d954(0x1ca)]==='enabled')&&!_0x5b203e['isGroup']&&(0x0,lodash_1[_0x14d954(0x28d)])(_0x415b87[_0x14d954(0x1e6)])&&_0x415b87[_0x14d954(0x2b2)]<=_0x26e671['maxUseBotQueues']&&!(0x0,lodash_1['isNil'])(_0xb77292?.[_0x14d954(0x192)])){_0x3ef65d?await(0x0,exports['verifyMediaMessage'])(_0x57cbdf,_0x415b87,_0x5b203e):await(0x0,exports[_0x14d954(0x2ec)])(_0x57cbdf,_0x415b87,_0x5b203e,_0x238ef0);if(!(0x0,lodash_1['isNil'])(_0xb77292?.[_0x14d954(0x192)])&&_0xb77292['lgpdMessage']!==''){const _0x4c6026=(0x0,Mustache_1[_0x14d954(0x20f)])('‎'+_0xb77292?.[_0x14d954(0x192)],_0x415b87),_0x55cd89=await _0x2fe7a2['sendMessage'](_0x415b87[_0x14d954(0x1b4)][_0x14d954(0x1cc)]+'@'+(_0x415b87[_0x14d954(0x268)]?_0x14d954(0x2d2):'s.whatsapp.net'),{'text':_0x4c6026});(0x0,exports['verifyMessage'])(_0x55cd89,_0x415b87,_0x5b203e,_0x238ef0);}await(0x0,baileys_1['delay'])(0x3e8);if(!(0x0,lodash_1[_0x14d954(0x28d)])(_0xb77292?.[_0x14d954(0x2dc)])&&_0xb77292?.[_0x14d954(0x2dc)]!==''){const _0x42b318=(0x0,Mustache_1[_0x14d954(0x20f)])('‎'+_0xb77292?.['lgpdLink'],_0x415b87),_0x210e77=await _0x2fe7a2['sendMessage'](_0x415b87[_0x14d954(0x1b4)][_0x14d954(0x1cc)]+'@'+(_0x415b87[_0x14d954(0x268)]?_0x14d954(0x2d2):_0x14d954(0x1eb)),{'text':_0x42b318});await(0x0,exports[_0x14d954(0x2ec)])(_0x210e77,_0x415b87,_0x5b203e,_0x238ef0);};await(0x0,baileys_1['delay'])(0x3e8);const _0x5b5782=(0x0,Mustache_1[_0x14d954(0x20f)])(_0x14d954(0x16d),_0x415b87),_0x31b835=await _0x2fe7a2[_0x14d954(0x2ab)](_0x415b87[_0x14d954(0x1b4)][_0x14d954(0x1cc)]+'@'+(_0x415b87[_0x14d954(0x268)]?_0x14d954(0x2d2):'s.whatsapp.net'),{'text':_0x5b5782});await(0x0,exports[_0x14d954(0x2ec)])(_0x31b835,_0x415b87,_0x5b203e,_0x238ef0),await _0x415b87[_0x14d954(0x1f8)]({'lgpdSendMessageAt':(0x0,moment_1['default'])()[_0x14d954(0x25e)](),'amountUsedBotQueues':_0x415b87['amountUsedBotQueues']+0x1}),await _0x415b87[_0x14d954(0x28f)]();return;};if(!(0x0,lodash_1['isNil'])(_0x415b87[_0x14d954(0x1e6)])&&(0x0,lodash_1[_0x14d954(0x28d)])(_0x415b87[_0x14d954(0x2f1)]))return;}}}catch(_0x44698b){Sentry['captureException'](_0x44698b),console['log'](_0x44698b);}const _0x566d42=_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x1a6)]?.[_0x14d954(0x231)]?.[_0x14d954(0x27f)]||_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x206)]?.[_0x14d954(0x231)]?.[_0x14d954(0x27f)]||_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x159)]?.[_0x14d954(0x231)]?.[_0x14d954(0x27f)]||_0x57cbdf[_0x14d954(0x27d)]?.[_0x14d954(0x296)]?.[_0x14d954(0x231)]?.['isForwarded']||_0x57cbdf[_0x14d954(0x27d)]?.['documentMessage']?.['contextInfo']?.[_0x14d954(0x27f)];let _0x3bb54f;_0x3ef65d?_0x3bb54f=await(0x0,exports[_0x14d954(0x2e3)])(_0x57cbdf,_0x415b87,_0x5b203e,_0x238ef0,_0x566d42):await(0x0,exports['verifyMessage'])(_0x57cbdf,_0x415b87,_0x5b203e,_0x238ef0,![],_0x566d42);try{await _0x415b87[_0x14d954(0x1f8)]({'fromMe':_0x57cbdf[_0x14d954(0x2ce)]['fromMe']});}catch(_0x2a8f33){Sentry[_0x14d954(0x1ea)](_0x2a8f33),console[_0x14d954(0x1ab)](_0x2a8f33);}let _0x1ebf03;if(_0xb77292[_0x14d954(0x2d6)]===_0x14d954(0x274))_0x1ebf03=await(0x0,VerifyCurrentSchedule_1['default'])(_0x42843c,0x0,0x0);else _0xb77292['scheduleType']==='connection'&&(_0x1ebf03=await(0x0,VerifyCurrentSchedule_1['default'])(_0x42843c,0x0,_0x26e671['id']));try{if(!_0x57cbdf['key'][_0x14d954(0x270)]&&_0xb77292[_0x14d954(0x2d6)]&&(!_0x415b87[_0x14d954(0x268)]||_0x26e671['groupAsTicket']===_0x14d954(0x1c0))){if((_0xb77292['scheduleType']===_0x14d954(0x274)||_0xb77292[_0x14d954(0x2d6)]===_0x14d954(0x1c2))&&!(0x0,lodash_1['isNil'])(_0x1ebf03)&&(!_0x1ebf03||_0x1ebf03['inActivity']===![])){_0x238ef0[_0x14d954(0x297)]===null&&await _0x238ef0[_0x14d954(0x1f8)]({'chatbotAt':(0x0,moment_1['default'])()[_0x14d954(0x25e)]()});if(_0x26e671[_0x14d954(0x1bd)]&&_0x26e671[_0x14d954(0x1bd)]!==0x0&&_0x415b87[_0x14d954(0x2b2)]>=_0x26e671['maxUseBotQueues'])return;let _0x19fd5c=new Date(),_0x6fe99b=new Date();if(_0x238ef0[_0x14d954(0x297)]!==null){_0x19fd5c[_0x14d954(0x2ef)](_0x238ef0[_0x14d954(0x297)][_0x14d954(0x2bd)]()+Number(_0x26e671[_0x14d954(0x2c0)]));if(_0x238ef0['chatbotAt']!==null&&_0x6fe99b<_0x19fd5c&&_0x26e671[_0x14d954(0x2c0)]!=='0'&&_0x415b87[_0x14d954(0x2b2)]!==0x0)return;}await _0x238ef0[_0x14d954(0x1f8)]({'chatbotAt':null});if(_0x26e671[_0x14d954(0x1e5)]!==''){const _0x3eb9d5=(0x0,Mustache_1[_0x14d954(0x20f)])(''+_0x26e671[_0x14d954(0x1e5)],_0x415b87),_0x418614=(0x0,Debounce_1[_0x14d954(0x1a4)])(async()=>{const _0x5f74ef=_0x14d954;await _0x2fe7a2[_0x5f74ef(0x2ab)](_0x415b87[_0x5f74ef(0x1b4)][_0x5f74ef(0x1cc)]+'@'+(_0x415b87[_0x5f74ef(0x268)]?_0x5f74ef(0x2d2):'s.whatsapp.net'),{'text':_0x3eb9d5});},0x3e8,_0x415b87['id']);_0x418614(),await _0x415b87['update']({'isOutOfHour':!![],'amountUsedBotQueues':_0x415b87['amountUsedBotQueues']+0x1});return;}await _0x415b87[_0x14d954(0x1f8)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x415b87[_0x14d954(0x2b2)]+0x1});return;}}}catch(_0x430c7c){Sentry[_0x14d954(0x1ea)](_0x430c7c),console[_0x14d954(0x1ab)](_0x430c7c);}!_0x415b87[_0x14d954(0x2a6)]&&!_0x415b87[_0x14d954(0x1af)]&&!_0x2351d1&&!_0x57cbdf[_0x14d954(0x2ce)][_0x14d954(0x270)]&&!_0x415b87[_0x14d954(0x1fa)]&&!(0x0,lodash_1['isNil'])(_0x26e671[_0x14d954(0x1dc)])&&await handleOpenAi(_0x57cbdf,_0x2fe7a2,_0x415b87,_0x5b203e,_0x3bb54f);if(!_0x57cbdf[_0x14d954(0x2ce)][_0x14d954(0x270)]&&(!_0x415b87[_0x14d954(0x268)]||_0x26e671[_0x14d954(0x214)]===_0x14d954(0x1c0))&&!_0x415b87[_0x14d954(0x1af)]&&!_0x415b87[_0x14d954(0x218)]&&!_0x415b87[_0x14d954(0x182)]&&_0x26e671[_0x14d954(0x1b5)]){const _0x4d865a=await(0x0,ShowQueueIntegrationService_1[_0x14d954(0x20f)])(_0x415b87[_0x14d954(0x1b5)],_0x42843c);await(0x0,exports[_0x14d954(0x258)])(_0x57cbdf,_0x2fe7a2,_0x42843c,_0x4d865a,_0x415b87);return;}if(!_0x57cbdf[_0x14d954(0x2ce)]['fromMe']&&(!_0x415b87['isGroup']||_0x26e671['groupAsTicket']==='enabled')&&_0x415b87[_0x14d954(0x1af)]&&!_0x415b87[_0x14d954(0x1fa)]&&_0x415b87['integrationId']&&_0x415b87[_0x14d954(0x265)]){const _0x28ba7b=await(0x0,ShowQueueIntegrationService_1[_0x14d954(0x20f)])(_0x415b87[_0x14d954(0x1b5)],_0x42843c);await(0x0,exports['handleMessageIntegration'])(_0x57cbdf,_0x2fe7a2,_0x42843c,_0x28ba7b,_0x415b87);return;}!_0x415b87['imported']&&!_0x415b87['queue']&&(!_0x415b87[_0x14d954(0x268)]||_0x26e671[_0x14d954(0x214)]===_0x14d954(0x1c0))&&!_0x57cbdf['key'][_0x14d954(0x270)]&&!_0x415b87[_0x14d954(0x1fa)]&&_0x26e671[_0x14d954(0x26c)][_0x14d954(0x2cd)]>=0x1&&(await verifyQueue(_0x2fe7a2,_0x57cbdf,_0x415b87,_0x5b203e,_0xb77292),_0x238ef0[_0x14d954(0x297)]===null&&await _0x238ef0['update']({'chatbotAt':(0x0,moment_1[_0x14d954(0x20f)])()[_0x14d954(0x25e)]()}));_0x415b87[_0x14d954(0x205)]>0x0&&await _0x238ef0[_0x14d954(0x1f8)]({'queueId':_0x415b87[_0x14d954(0x205)]});if((getTypeMessage(_0x57cbdf)===_0x14d954(0x159)||getTypeMessage(_0x57cbdf)==='videoMessage')&&!_0x57cbdf[_0x14d954(0x2ce)]['fromMe']&&(!_0x415b87[_0x14d954(0x268)]||_0x26e671[_0x14d954(0x214)]==='enabled')&&(!_0x5b203e?.[_0x14d954(0x1cf)]||_0xb77292?.[_0x14d954(0x2a7)]===_0x14d954(0x2bf))){const _0x264aa4=await _0x2fe7a2[_0x14d954(0x2ab)](_0x5b203e[_0x14d954(0x1cc)]+_0x14d954(0x27c),{'text':_0x14d954(0x181)},{'quoted':{'key':_0x57cbdf[_0x14d954(0x2ce)],'message':{'extendedTextMessage':_0x57cbdf['message'][_0x14d954(0x1a6)]}}});await(0x0,exports[_0x14d954(0x2ec)])(_0x264aa4,_0x415b87,_0x5b203e,_0x238ef0);}try{if(!_0x57cbdf['key'][_0x14d954(0x270)]&&_0xb77292?.['scheduleType']&&_0x415b87[_0x14d954(0x205)]!==null&&(!_0x415b87[_0x14d954(0x268)]||_0x26e671[_0x14d954(0x214)]===_0x14d954(0x1c0))){const _0x17883f=await Queue_1[_0x14d954(0x20f)][_0x14d954(0x25a)](_0x415b87[_0x14d954(0x205)]);_0xb77292?.['scheduleType']===_0x14d954(0x1af)&&(_0x1ebf03=await(0x0,VerifyCurrentSchedule_1[_0x14d954(0x20f)])(_0x42843c,_0x17883f['id'],0x0));if(_0xb77292?.[_0x14d954(0x2d6)]===_0x14d954(0x1af)&&!(0x0,lodash_1[_0x14d954(0x28d)])(_0x1ebf03)&&(!_0x1ebf03||_0x1ebf03['inActivity']===![])){const _0x416aa7=_0x17883f[_0x14d954(0x1e5)];if(_0x416aa7!==''){const _0x16f01f=(0x0,Mustache_1['default'])(''+_0x416aa7,_0x415b87),_0xa807a9=(0x0,Debounce_1[_0x14d954(0x1a4)])(async()=>{const _0x94e934=_0x14d954;await _0x2fe7a2[_0x94e934(0x2ab)](_0x415b87[_0x94e934(0x1b4)][_0x94e934(0x1cc)]+'@'+(_0x415b87[_0x94e934(0x268)]?_0x94e934(0x2d2):'s.whatsapp.net'),{'text':_0x16f01f});},0x3e8,_0x415b87['id']);_0xa807a9(),await _0x415b87[_0x14d954(0x1f8)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x415b87['amountUsedBotQueues']+0x1});return;}await _0x415b87[_0x14d954(0x1f8)]({'isOutOfHour':!![],'amountUsedBotQueues':_0x415b87['amountUsedBotQueues']+0x1});return;}}}catch(_0x560945){Sentry['captureException'](_0x560945),console[_0x14d954(0x1ab)](_0x560945);}_0x415b87['queue']&&_0x415b87[_0x14d954(0x205)]&&!_0x57cbdf[_0x14d954(0x2ce)][_0x14d954(0x270)]&&((!_0x415b87[_0x14d954(0x218)]||_0x415b87[_0x14d954(0x1af)]?.['chatbots']?.['length']>0x0)&&await(0x0,ChatBotListener_1[_0x14d954(0x2f2)])(_0x415b87[_0x14d954(0x205)],_0x2fe7a2,_0x415b87,_0x5b203e,_0x57cbdf),await _0x415b87[_0x14d954(0x1f8)]({'sendInactiveMessage':![]})),await _0x415b87[_0x14d954(0x28f)]();}catch(_0x28281b){Sentry[_0x14d954(0x1ea)](_0x28281b),console[_0x14d954(0x1ab)](_0x28281b),logger_1['logger']['error'](_0x14d954(0x22f)+_0x28281b);}};exports[a627_0x2ed45c(0x25c)]=handleMessage;const handleMsgAck=async(_0x14318a,_0xce0265)=>{const _0x25b34c=a627_0x2ed45c;await new Promise(_0x244fa0=>setTimeout(_0x244fa0,0x1f4));const _0x3d7dc4=(0x0,socket_1[_0x25b34c(0x179)])();try{const _0x102dad=await Message_1['default'][_0x25b34c(0x263)]({'where':{'wid':_0x14318a[_0x25b34c(0x2ce)]['id']},'include':[_0x25b34c(0x1b4),{'model':Message_1[_0x25b34c(0x20f)],'as':_0x25b34c(0x2d7),'include':['contact']}]});if(!_0x102dad)return;await _0x102dad[_0x25b34c(0x1f8)]({'ack':_0xce0265}),_0x3d7dc4['to'](_0x102dad[_0x25b34c(0x26e)]['toString']())['emit']('company-'+_0x102dad['companyId']+_0x25b34c(0x176),{'action':_0x25b34c(0x1f8),'message':_0x102dad});}catch(_0x4de727){Sentry[_0x25b34c(0x1ea)](_0x4de727),logger_1[_0x25b34c(0x1e9)][_0x25b34c(0x19d)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x4de727);}},verifyRecentCampaign=async(_0x3eefac,_0x4399cd)=>{const _0x466128=a627_0x2ed45c;if(!isValidMsg(_0x3eefac))return;if(!_0x3eefac[_0x466128(0x2ce)][_0x466128(0x270)]){const _0x2053b9=_0x3eefac['key'][_0x466128(0x166)][_0x466128(0x269)](/\D/g,''),_0x3ead2d=await Campaign_1[_0x466128(0x20f)]['findAll']({'where':{'companyId':_0x4399cd,'status':'EM_ANDAMENTO','confirmation':!![]}});if(_0x3ead2d){const _0x4116a0=_0x3ead2d['map'](_0x29c69a=>_0x29c69a['id']),_0x3a367b=await CampaignShipping_1[_0x466128(0x20f)][_0x466128(0x263)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x4116a0},'number':_0x2053b9,'confirmation':null}});_0x3a367b&&(await _0x3a367b['update']({'confirmedAt':(0x0,moment_1['default'])(),'confirmation':!![]}),await queues_1[_0x466128(0x175)]['add'](_0x466128(0x232),{'campaignShippingId':_0x3a367b['id'],'campaignId':_0x3a367b[_0x466128(0x28b)]},{'delay':(0x0,queues_1[_0x466128(0x1d0)])((0x0,queues_1[_0x466128(0x28e)])(0x0,0xa))}));}}},verifyCampaignMessageAndCloseTicket=async(_0x59369f,_0xe8482e,_0x4628e7)=>{const _0x4c7db7=a627_0x2ed45c;if(!isValidMsg(_0x59369f))return;let _0x598615;_0x598615=await getContactMessage(_0x59369f,_0x4628e7);const _0x35d4e4=await verifyContact(_0x598615,_0x4628e7,_0xe8482e),_0x4fac75=(0x0,socket_1[_0x4c7db7(0x179)])(),_0x1a3094=await(0x0,exports['getBodyMessage'])(_0x59369f),_0x4ce6cf=/\u200c/[_0x4c7db7(0x173)](_0x1a3094);if(_0x59369f['key'][_0x4c7db7(0x270)]&&_0x4ce6cf){const _0x1877d8=await Message_1[_0x4c7db7(0x20f)][_0x4c7db7(0x263)]({'where':{[sequelize_1['Op']['or']]:[{'wid':_0x59369f[_0x4c7db7(0x2ce)]['id']},{'contactId':_0x35d4e4['id']}],'companyId':_0xe8482e}});if(!(0x0,lodash_1[_0x4c7db7(0x22b)])(_0x1877d8)||!(0x0,lodash_1[_0x4c7db7(0x28d)])(_0x1877d8)||_0x1877d8!==null){const _0x4a1e45=await Ticket_1[_0x4c7db7(0x20f)][_0x4c7db7(0x25a)](_0x1877d8[_0x4c7db7(0x26e)]);await _0x4a1e45[_0x4c7db7(0x1f8)]({'status':_0x4c7db7(0x25d),'amountUsedBotQueues':0x0,'amountUseOutOfHours':0x0}),_0x4fac75['to'](_0x4c7db7(0x15d))[_0x4c7db7(0x23d)](_0x4c7db7(0x1db)+_0xe8482e+_0x4c7db7(0x25f),{'action':_0x4c7db7(0x1cd),'ticket':_0x4a1e45,'ticketId':_0x4a1e45['id']}),_0x4fac75['to'](_0x4a1e45[_0x4c7db7(0x2db)])['to'](_0x4a1e45['id'][_0x4c7db7(0x21b)]())[_0x4c7db7(0x23d)](_0x4c7db7(0x1db)+_0xe8482e+_0x4c7db7(0x25f),{'action':_0x4c7db7(0x1f8),'ticket':_0x4a1e45,'ticketId':_0x4a1e45['id']});}}},filterMessages=_0x13e07b=>{const _0x49c51c=a627_0x2ed45c;if(_0x13e07b['message']?.[_0x49c51c(0x2ad)])return![];if([baileys_1[_0x49c51c(0x1ee)][_0x49c51c(0x24c)],baileys_1['WAMessageStubType']['E2E_DEVICE_CHANGED'],baileys_1['WAMessageStubType'][_0x49c51c(0x210)],baileys_1[_0x49c51c(0x1ee)][_0x49c51c(0x2c9)]][_0x49c51c(0x2a1)](_0x13e07b[_0x49c51c(0x278)]))return![];return!![];},wbotMessageListener=(_0x3fc2bf,_0x35d1e8)=>{const _0x146beb=a627_0x2ed45c;_0x3fc2bf['ev']['on'](_0x146beb(0x1d8),async _0x4d4870=>{const _0x3fbbde=_0x146beb,_0x3009c6=_0x4d4870[_0x3fbbde(0x230)]['filter'](filterMessages)['map'](_0x550eef=>_0x550eef);if(!_0x3009c6)return;_0x3009c6[_0x3fbbde(0x283)](async _0xa12dce=>{const _0x138790=_0x3fbbde,_0x523aec=await Message_1[_0x138790(0x20f)]['count']({'where':{'wid':_0xa12dce['key']['id'],'companyId':_0x35d1e8}});if(!_0x523aec){let _0x13767e=![],_0x2398b2=await(0x0,exports[_0x138790(0x2a8)])(_0xa12dce);const _0x23710e=_0xa12dce?.[_0x138790(0x2ce)]?.[_0x138790(0x270)];if(_0x23710e)_0x13767e=/\u200c/[_0x138790(0x173)](_0x2398b2);else{if(/\u200c/[_0x138790(0x173)](_0x2398b2))_0x2398b2=_0x2398b2[_0x138790(0x269)](/\u200c/,'');logger_1[_0x138790(0x1e9)][_0x138790(0x1f1)](_0x138790(0x235)+_0x2398b2);}if(!_0x13767e){await handleMessage(_0xa12dce,_0x3fc2bf,_0x35d1e8);return;}await verifyRecentCampaign(_0xa12dce,_0x35d1e8),await verifyCampaignMessageAndCloseTicket(_0xa12dce,_0x35d1e8,_0x3fc2bf);}_0xa12dce['key'][_0x138790(0x166)]?.[_0x138790(0x238)](_0x138790(0x194))&&handleMsgAck(_0xa12dce,0x2);});}),_0x3fc2bf['ev']['on'](_0x146beb(0x1a0),_0x4d714c=>{const _0xf569a5=_0x146beb;if(_0x4d714c[_0xf569a5(0x2cd)]===0x0)return;_0x4d714c[_0xf569a5(0x283)](async _0x4a0ee6=>{const _0x1f4a4a=_0xf569a5;_0x3fc2bf[_0x1f4a4a(0x22e)]([_0x4a0ee6[_0x1f4a4a(0x2ce)]]);const _0x290fe6={..._0x4d714c};_0x290fe6['0']?.[_0x1f4a4a(0x1f8)][_0x1f4a4a(0x278)]===0x1&&_0x290fe6['0']?.[_0x1f4a4a(0x2ce)][_0x1f4a4a(0x166)]!=='status@broadcast'&&(0x0,MarkDeleteWhatsAppMessage_1[_0x1f4a4a(0x20f)])(_0x290fe6['0']?.[_0x1f4a4a(0x2ce)][_0x1f4a4a(0x166)],null,_0x290fe6['0']?.[_0x1f4a4a(0x2ce)]['id'],_0x35d1e8);let _0x4ea40b;_0x4a0ee6['update'][_0x1f4a4a(0x2db)]===0x3&&_0x4a0ee6?.[_0x1f4a4a(0x2ce)]?.[_0x1f4a4a(0x270)]?_0x4ea40b=0x2:_0x4ea40b=_0x4a0ee6['update'][_0x1f4a4a(0x2db)],handleMsgAck(_0x4a0ee6,_0x4ea40b);});}),_0x3fc2bf['ev']['on'](_0x146beb(0x24e),_0x5ccdee=>{if(_0x5ccdee['length']===0x0)return;_0x5ccdee['forEach'](async _0x5f1288=>{const _0x9858fa=a627_0x4baf,_0x18b5d0=_0x5f1288['id'][_0x9858fa(0x269)](/\D/g,''),_0x529cc3=_0x5f1288[_0x9858fa(0x16b)]||_0x18b5d0;let _0x3c6ac6;try{_0x3c6ac6=await _0x3fc2bf[_0x9858fa(0x1f9)](_0x5f1288['id'],_0x9858fa(0x186));}catch(_0x36a0ea){Sentry['captureException'](_0x36a0ea),_0x3c6ac6=process[_0x9858fa(0x2d9)]['FRONTEND_URL']+_0x9858fa(0x180);}const _0x5551e4={'name':_0x529cc3,'number':_0x18b5d0,'isGroup':!![],'companyId':_0x35d1e8,'remoteJid':_0x5f1288['id'],'profilePicUrl':_0x3c6ac6},_0x5d7ec8=await(0x0,CreateOrUpdateContactService_1[_0x9858fa(0x20f)])(_0x5551e4);});});};function a627_0x5c88(){const _0x48d081=['%2C','stanzaId','../../models/User','messageStubType','getQuotedMessageId','templateButtonReplyMessage','selectedDisplayText','@c.us','message','No\x20result\x20from\x20synthesizer','isForwarded','normalize','Escolha\x20uma\x20opção','split','forEach','save','601416lESzSV','downloadMediaMessage','get','warn','data','../../models/CampaignShipping','campaignId','fileList','isNil','randomValue','reload','trim','medias','closeTicket','microsoft-cognitiveservices-speech-sdk','finishedAt','stringValue','videoMessage','chatbotAt','dialogflow','../TicketServices/UpdateTicketService','destroy','extractMessageContent','chatBot','n8n','content','push','Erro\x20ao\x20deletar\x20o\x20arquivo:','includes','getTime','listResponseMessage','apiKey','jpegThumbnail','imported','acceptAudioMessageContact','getBodyMessage','/opt/homebrew/bin/ffmpeg','resolve','sendMessage','body','protocolMessage','documentWithCaptionMessage','encodedAudio','../TicketServices/FindOrCreateTicketService','maxUseBotQueuesNPS','amountUsedBotQueues','createChatCompletion','enableLGPD','now','../ContactServices/CreateOrUpdateContactService','sendQueuePosition','__importStar','queryDialogFlow','mp3','SpeechSynthesizer','text','getMinutes','name','disabled','timeUseBotQueues','mediaUrl','unlink','12jEzXLD','voiceKey','./ChatBotListener','moment','darwin','audio/mpeg','CIPHERTEXT','item1.TEL','channel','Configuration','length','key','__importDefault','../MessageServices/CreateMessageService','*[\x20','g.us','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','contacts','findAll','scheduleType','quotedMsg','7835NiOZVh','env','stickerMessage','status','lgpdLink','C:\x5cffmpeg\x5cffmpeg.exe','disableBot','\x20-\x20Longitude:\x20','.mp3','audio','type','verifyMediaMessage','reactionMessage','parameters','Error:\x20','670740XTJqgJ','.ogg','count','button','‎Opção\x20inválida,\x20tente\x20novamente.\x0a','verifyMessage','buttons','../UserQueueServices/ListUserQueueServices','setMinutes','__esModule','lgpdAcceptedAt','sayChatbot','degreesLongitude','audioMessage','7bit','NFD','contacts:','open',':*\x20','../../models/Ticket','Latitude:\x20','input','pending','locationMessage','writeFile','54511qvjxrF','remoteJid','min','sair','settingsUserRandom','&z=17&hl=pt-BR|','subject','selectedId','‎Estou\x20ciente\x20sobre\x20o\x20tratamento\x20dos\x20meus\x20dados\x20pessoais.\x20\x0a\x0a*[1]*\x20Sim\x0a*[2]*\x20Não','nps',':unreads','getQuotedMessage','Formato\x20de\x20arquivo\x20não\x20suportado:','companyId','test','Esta\x20mensagem\x20já\x20existe','campaignQueue','-appMessage','speechSynthesisVoiceName','voice','getIO','‎\x20*','.mpeg','groupMetadata','handleRating','./SendWhatsAppMessage','contactMessage','/nopicture.png','‎*Assistente\x20Virtual*:\x0aInfelizmente\x20não\x20conseguimos\x20escutar\x20nem\x20enviar\x20áudios\x20por\x20este\x20canal\x20de\x20atendimento,\x20por\x20favor,\x20envie\x20uma\x20mensagem\x20de\x20*texto*.','isBot','degreesLatitude','findAndCountAll','item1.TEL:','image','responses','configurable','downloadMedia','recording','\x0a*[\x20Sair\x20]*\x20-\x20Encerrar\x20atendimento','delay','getMessageOptions','setExtra','entrou\x20no\x20typebot','Mensagem','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20getTypeMessage','lgpdMessage','__setModuleDefault','@g.us','viewOnceMessage','Erro\x20media','viewOnceMessageV2','ratingMessage','fileName','promisify','Error\x20converting\x20file:\x20','set','error','create','buttonsResponseMessage','messages.update','urlN8N','../../libs/cache','toISOString','debounce','mimetype','extendedTextMessage','OpenAIApi','conversation','listMessage','../TypebotServices/typebotListener','log','wbotMessageListener','rows','96YrmIsi','queue','end','then','defineProperty','mkdirSync','contact','integrationId','endConversation','1986310jYmZWl','language','speakTextAsync','join','../../helpers/addLogs','processImportMessagesWppId','maxUseBotQueues','createDialogflowSessionWithModel','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','enabled','Áudio','connection','projectName','value','POST','chatBotType','typebot','pushName','../../models/Contact','lgpdConsent','BEGIN:','number','delete','SpeechConfig','acceptAudioMessage','parseToMilliseconds','choices','../QueueIntegrationServices/CreateSessionDialogflow','filename','hasOwnProperty','instagram','assistant','application/json','messages.upsert','title','path','company-','promptId','whatsapp','FRONTEND_URL','./SendWhatsAppMedia',':\x20📞','mediaType','editedMessage','contactId','Menu','outOfHoursMessage','lgpdSendMessageAt','documentMessage','Amigo(a)','logger','captureException','s.whatsapp.net','chatbots','../../models/Queue','WAMessageStubType','slice','existsSync','debug','info','sequelize','entries','quotedMessage','keys','maxTokens','update','profilePictureUrl','userId','composing',':*\x20Não\x20consegui\x20entender\x20sua\x20dúvida.','isNaN','amountUseBotQueuesNPS','lodash','\x0a*[\x20#\x20]*\x20Voltar\x20para\x20o\x20menu\x20principal\x0a*[\x20Sair\x20]*\x20Encerrar\x20atendimento','verifyRating','sendPresenceUpdate','lgpd','from','queueId','imageMessage','stringify','texto','sections','vcard','request','presenceSubscribe','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','mediaMessage','default','E2E_IDENTITY_CHANGED','system','whisper-1','findIndex','groupAsTicket','toFormat','Erro\x20ao\x20baixar\x20mídia:','caption','user','4YAKWKo','Importando\x20Mensagem:\x20','toString','956ESfoZB','values','base64','description','buffer','contactsArrayMessage','map','unlinkSync','jidNormalizedUser','.wav','singleSelectReply','messageTimestamp','../FacebookServices/sendFacebookMessage','getContentType','\x20]*\x20-\x20','isNull','greetingMediaAttachment','../FileServices/ShowService','readMessages','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','messages','contextInfo','DispatchCampaign','*Assistente\x20Virtual:*\x0a{{ms}}\x20*{{name}}*,\x20sua\x20posição\x20na\x20fila\x20de\x20atendimento\x20é:\x20*','axolotlSenderKeyDistributionMessage','Validação\x20de\x20mensagem\x20de\x20campanha\x20enviada\x20por\x20terceiros:\x20','.txt','../TicketServices/CreateLogTicketService','endsWith','messageContextInfo','sendGreetingMessageOneQueues','*System:*\x20\x0aFalha\x20no\x20download\x20da\x20mídia\x20verifique\x20no\x20dispositivo','indexOf','emit',';;;','../../models/UserRating','paused','substring','floor','54hvrgcu','pop','ratingAt','whatsappId','farewellMessage','gpt-3.5-turbo','shift','buttonsMessage','../../utils/logger','REVOKE','inActivity','groups.update','chat','Erro\x20para\x20responder\x20com\x20audio:\x20','platform','ephemeralMessage','Erro\x20ao\x20baixar\x20media','fromAudioFileOutput','toLocaleLowerCase','chmodSync','writable','handleMessageIntegration','complationMessage','findByPk','3032359TLqrtg','handleMessage','closed','toDate','-ticket','58723NAGkmQ','reaction','public','findOne','participant','useIntegration','\x20|\x20https://maps.google.com/maps?q=','/usr/bin/ffmpeg','isGroup','replace','getTypeMessage','openai','queues','isValidMsg','ticketId','ERR_WAPP_DOWNLOAD_MEDIA','fromMe','fileListId','greetingMessage','next','company'];a627_0x5c88=function(){return _0x48d081;};return a627_0x5c88();}exports[a627_0x2ed45c(0x1ac)]=wbotMessageListener;