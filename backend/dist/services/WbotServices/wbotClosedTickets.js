'use strict';const a552_0x17413c=a552_0x1e1d;(function(_0x37f376,_0x2aa9cd){const _0x571c5a=a552_0x1e1d,_0x12405b=_0x37f376();while(!![]){try{const _0x4b2e84=parseInt(_0x571c5a(0x16a))/0x1*(parseInt(_0x571c5a(0x177))/0x2)+parseInt(_0x571c5a(0x155))/0x3+parseInt(_0x571c5a(0x178))/0x4*(-parseInt(_0x571c5a(0x17c))/0x5)+parseInt(_0x571c5a(0x176))/0x6*(-parseInt(_0x571c5a(0x158))/0x7)+parseInt(_0x571c5a(0x156))/0x8*(parseInt(_0x571c5a(0x16c))/0x9)+-parseInt(_0x571c5a(0x16d))/0xa*(-parseInt(_0x571c5a(0x15b))/0xb)+parseInt(_0x571c5a(0x172))/0xc*(-parseInt(_0x571c5a(0x181))/0xd);if(_0x4b2e84===_0x2aa9cd)break;else _0x12405b['push'](_0x12405b['shift']());}catch(_0x103580){_0x12405b['push'](_0x12405b['shift']());}}}(a552_0x598d,0xe665d));var __importDefault=this&&this[a552_0x17413c(0x168)]||function(_0x52671e){const _0x528c29=a552_0x17413c;return _0x52671e&&_0x52671e[_0x528c29(0x170)]?_0x52671e:{'default':_0x52671e};};Object['defineProperty'](exports,a552_0x17413c(0x170),{'value':!![]}),exports[a552_0x17413c(0x164)]=void 0x0;function a552_0x598d(){const _0x315572=['findOne','verifyMessage','company','ClosedAllOpenTickets','../../libs/socket','userId','log','__importDefault','moment','77534bSHvfj','findAndCountAll','1727757wnlqzr','30nbTKaC','sendInactiveMessage','../../models/Whatsapp','__esModule','-ticket','4974804vmOFxC','contact','sequelize','open','374970AGQVYG','8ZoaAPV','356bporMw','isGroup','delete','setMinutes','36670PXhJAp','updatedAt','DESC','./wbotMessageListener','closed','13AyoVPa','fromMe','../../models/TicketTraking','getMinutes','emit','toDate','default','3502971tXaCAx','16QwkPAV','getIO','7pBlKCg','whatsappId','status','776446qBaxQC','../../helpers/Mustache','update','./SendWhatsAppMessage','../../models/Ticket','forEach'];a552_0x598d=function(){return _0x315572;};return a552_0x598d();}function a552_0x1e1d(_0x244d52,_0x2237fb){const _0x598d6e=a552_0x598d();return a552_0x1e1d=function(_0x1e1d3f,_0x4e38a8){_0x1e1d3f=_0x1e1d3f-0x150;let _0x317d30=_0x598d6e[_0x1e1d3f];return _0x317d30;},a552_0x1e1d(_0x244d52,_0x2237fb);}const sequelize_1=require(a552_0x17413c(0x174)),Ticket_1=__importDefault(require(a552_0x17413c(0x15f))),Whatsapp_1=__importDefault(require(a552_0x17413c(0x16f))),socket_1=require(a552_0x17413c(0x165)),Mustache_1=__importDefault(require(a552_0x17413c(0x15c))),SendWhatsAppMessage_1=__importDefault(require(a552_0x17413c(0x15e))),moment_1=__importDefault(require(a552_0x17413c(0x169))),ShowTicketService_1=__importDefault(require('../TicketServices/ShowTicketService')),wbotMessageListener_1=require(a552_0x17413c(0x17f)),TicketTraking_1=__importDefault(require(a552_0x17413c(0x150))),ClosedAllOpenTickets=async _0x5a94fb=>{const _0x5dcc58=a552_0x17413c,_0x11bb93=async(_0x2f680c,_0x192696,_0x4c389c)=>{const _0x5bc648=a552_0x1e1d;if(_0x192696==='nps')await _0x2f680c[_0x5bc648(0x15d)]({'status':'closed','lastMessage':_0x4c389c,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x192696===_0x5bc648(0x175)?await _0x2f680c[_0x5bc648(0x15d)]({'status':_0x5bc648(0x180),'lastMessage':_0x4c389c,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x2f680c[_0x5bc648(0x15d)]({'status':'closed','unreadMessages':0x0});},_0x18abce=(0x0,socket_1[_0x5dcc58(0x157)])();try{const {rows:_0x1227bb}=await Ticket_1['default'][_0x5dcc58(0x16b)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x5dcc58(0x175),'nps']},'companyId':_0x5a94fb},'order':[[_0x5dcc58(0x17d),_0x5dcc58(0x17e)]]});_0x1227bb[_0x5dcc58(0x160)](async _0x19aff1=>{const _0x3be753=_0x5dcc58,_0x86a16c=await(0x0,ShowTicketService_1[_0x3be753(0x154)])(_0x19aff1['id'],_0x5a94fb),_0x17383a=await Whatsapp_1[_0x3be753(0x154)]['findByPk'](_0x86a16c?.['whatsappId']),_0x6dcbbe=await TicketTraking_1['default'][_0x3be753(0x161)]({'where':{'ticketId':_0x19aff1['id'],'finishedAt':null}});if(!_0x17383a)return;let {timeInactiveMessage:_0x5216db,expiresInactiveMessage:_0x59a1c1,inactiveMessage:_0x53e4f4,expiresTicket:_0x496391,expiresTicketNPS:_0x3e22c5,whenExpiresTicket:_0x10b383,complationMessage:_0x1d2153}=_0x17383a;if(_0x3e22c5&&_0x3e22c5!==''&&_0x3e22c5!=='0'&&Number(_0x3e22c5)>0x0){const _0x179749=new Date();_0x179749[_0x3be753(0x17b)](_0x179749['getMinutes']()-Number(_0x3e22c5));if(_0x19aff1[_0x3be753(0x15a)]==='nps'){const _0x2fc68d=new Date(_0x86a16c[_0x3be753(0x17d)]);if(_0x2fc68d<_0x179749){_0x11bb93(_0x86a16c,_0x86a16c['status'],'');const _0x3125f4=(0x0,Mustache_1[_0x3be753(0x154)])('‎'+_0x1d2153,_0x86a16c);if(_0x1d2153!==''&&_0x1d2153!==undefined){const _0x4ade88=await(0x0,SendWhatsAppMessage_1[_0x3be753(0x154)])({'body':_0x3125f4,'ticket':_0x86a16c});await(0x0,wbotMessageListener_1[_0x3be753(0x162)])(_0x4ade88,_0x86a16c,_0x86a16c['contact']);}await _0x6dcbbe['update']({'finishedAt':(0x0,moment_1[_0x3be753(0x154)])()[_0x3be753(0x153)](),'closedAt':(0x0,moment_1['default'])()[_0x3be753(0x153)](),'whatsappId':_0x19aff1[_0x3be753(0x159)],'userId':_0x19aff1[_0x3be753(0x166)]}),_0x18abce['to'](_0x3be753(0x175))[_0x3be753(0x152)]('company'+_0x5a94fb+_0x3be753(0x171),{'action':_0x3be753(0x17a),'ticket':_0x86a16c,'ticketId':_0x86a16c['id']});}}}if(_0x496391&&_0x496391!==''&&_0x496391!=='0'&&Number(_0x496391)>0x0){const _0x409c0c=(0x0,Mustache_1['default'])('‎'+_0x59a1c1,_0x86a16c),_0x4a7517=new Date();_0x4a7517['setHours'](_0x4a7517['getHours']()-Number(_0x496391));_0x5216db&&_0x5216db!==''&&_0x5216db!==null&&_0x5216db!=='0'&&Number(_0x5216db)>0x0&&_0x4a7517[_0x3be753(0x17b)](_0x4a7517[_0x3be753(0x151)]()-Number(_0x5216db));if(_0x86a16c[_0x3be753(0x15a)]==='open'&&!_0x86a16c[_0x3be753(0x179)]){const _0x4f0d2a=new Date(_0x86a16c[_0x3be753(0x17d)]);if(_0x4f0d2a<_0x4a7517&&(_0x10b383==='0'||_0x10b383==='1'&&_0x86a16c[_0x3be753(0x182)])){_0x11bb93(_0x86a16c,_0x86a16c[_0x3be753(0x15a)],_0x409c0c);if(_0x59a1c1!==''&&_0x59a1c1!==undefined){const _0x3ae607=await(0x0,SendWhatsAppMessage_1[_0x3be753(0x154)])({'body':_0x409c0c,'ticket':_0x86a16c});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x3ae607,_0x86a16c,_0x86a16c[_0x3be753(0x173)]);}await _0x6dcbbe['update']({'finishedAt':(0x0,moment_1[_0x3be753(0x154)])()['toDate'](),'closedAt':(0x0,moment_1[_0x3be753(0x154)])()[_0x3be753(0x153)](),'whatsappId':_0x19aff1[_0x3be753(0x159)],'userId':_0x19aff1[_0x3be753(0x166)]}),_0x18abce['to'](_0x3be753(0x175))[_0x3be753(0x152)](_0x3be753(0x163)+_0x5a94fb+_0x3be753(0x171),{'action':_0x3be753(0x17a),'ticket':_0x86a16c,'ticketId':_0x86a16c['id']});}}}if(_0x5216db&&_0x5216db!==''&&_0x5216db!=='0'&&Number(_0x5216db)>0x0){const _0x3f9f71=(0x0,Mustache_1[_0x3be753(0x154)])('‎'+_0x53e4f4,_0x86a16c),_0x2abbb8=new Date();_0x2abbb8['setMinutes'](_0x2abbb8[_0x3be753(0x151)]()-Number(_0x5216db));if(_0x86a16c['status']===_0x3be753(0x175)&&!_0x86a16c[_0x3be753(0x179)]){const _0x2e219c=new Date(_0x86a16c[_0x3be753(0x17d)]);if(_0x2e219c<_0x2abbb8&&!_0x86a16c[_0x3be753(0x16e)]&&(_0x10b383==='0'||_0x10b383==='1'&&_0x86a16c[_0x3be753(0x182)])){const _0x1558f4=await(0x0,SendWhatsAppMessage_1[_0x3be753(0x154)])({'body':_0x3f9f71,'ticket':_0x86a16c});await(0x0,wbotMessageListener_1[_0x3be753(0x162)])(_0x1558f4,_0x86a16c,_0x86a16c[_0x3be753(0x173)]),await _0x86a16c[_0x3be753(0x15d)]({'sendInactiveMessage':!![]}),_0x18abce['to'](_0x3be753(0x175))[_0x3be753(0x152)](_0x3be753(0x163)+_0x5a94fb+_0x3be753(0x171),{'action':'delete','ticket':_0x86a16c,'ticketId':_0x86a16c['id']});}}}});}catch(_0x44b4f7){console[_0x5dcc58(0x167)]('e',_0x44b4f7);}};exports['ClosedAllOpenTickets']=ClosedAllOpenTickets;