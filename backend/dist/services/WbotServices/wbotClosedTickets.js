'use strict';const a573_0x4526ea=a573_0x3127;(function(_0x2a43b5,_0x310676){const _0x1466c5=a573_0x3127,_0x8008dc=_0x2a43b5();while(!![]){try{const _0xb2cbda=-parseInt(_0x1466c5(0x169))/0x1+parseInt(_0x1466c5(0x178))/0x2*(parseInt(_0x1466c5(0x15c))/0x3)+parseInt(_0x1466c5(0x157))/0x4+parseInt(_0x1466c5(0x17d))/0x5+-parseInt(_0x1466c5(0x160))/0x6*(parseInt(_0x1466c5(0x153))/0x7)+-parseInt(_0x1466c5(0x16e))/0x8+-parseInt(_0x1466c5(0x174))/0x9;if(_0xb2cbda===_0x310676)break;else _0x8008dc['push'](_0x8008dc['shift']());}catch(_0x444010){_0x8008dc['push'](_0x8008dc['shift']());}}}(a573_0x4072,0xcc439));var __importDefault=this&&this['__importDefault']||function(_0x13fe23){const _0xfa8865=a573_0x3127;return _0x13fe23&&_0x13fe23[_0xfa8865(0x15f)]?_0x13fe23:{'default':_0x13fe23};};Object[a573_0x4526ea(0x176)](exports,a573_0x4526ea(0x15f),{'value':!![]}),exports[a573_0x4526ea(0x155)]=void 0x0;function a573_0x4072(){const _0x550d4a=['setMinutes','emit','94607KPeuwC','open','sequelize','findOne','whatsappId','3628320itvvlV','toDate','autoClose','../../models/Whatsapp','getIO','../../models/TicketTraking','3465126sKegZh','./wbotMessageListener','defineProperty','findAndCountAll','2qjkxah','sendInactiveMessage','default','updatedAt','-ticket','3056040wKkXmg','log','forEach','fromMe','closed','contact','update','7KrhNpK','nps','ClosedAllOpenTickets','delete','1103136ubwnbJ','status','getMinutes','./SendWhatsAppMessage','findByPk','3599301KtTPfd','DESC','userId','__esModule','1901598TUnlcM','company-','../../libs/socket','verifyMessage','../TicketServices/ShowTicketService','../../helpers/Mustache','isGroup'];a573_0x4072=function(){return _0x550d4a;};return a573_0x4072();}function a573_0x3127(_0x21ee3a,_0x3ecff2){const _0x4072e7=a573_0x4072();return a573_0x3127=function(_0x312796,_0x258301){_0x312796=_0x312796-0x152;let _0x590a9d=_0x4072e7[_0x312796];return _0x590a9d;},a573_0x3127(_0x21ee3a,_0x3ecff2);}const sequelize_1=require(a573_0x4526ea(0x16b)),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require(a573_0x4526ea(0x171))),socket_1=require(a573_0x4526ea(0x162)),Mustache_1=__importDefault(require(a573_0x4526ea(0x165))),SendWhatsAppMessage_1=__importDefault(require(a573_0x4526ea(0x15a))),moment_1=__importDefault(require('moment')),ShowTicketService_1=__importDefault(require(a573_0x4526ea(0x164))),wbotMessageListener_1=require(a573_0x4526ea(0x175)),TicketTraking_1=__importDefault(require(a573_0x4526ea(0x173))),CreateLogTicketService_1=__importDefault(require('../TicketServices/CreateLogTicketService')),ClosedAllOpenTickets=async _0x26062e=>{const _0x389659=a573_0x4526ea,_0x255b2a=async(_0x5b0aba,_0x3d0921,_0xb1749)=>{const _0x2e3d39=a573_0x3127;if(_0x3d0921===_0x2e3d39(0x154))await _0x5b0aba[_0x2e3d39(0x152)]({'status':_0x2e3d39(0x181),'lastMessage':_0xb1749,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x3d0921==='open'?await _0x5b0aba[_0x2e3d39(0x152)]({'status':_0x2e3d39(0x181),'lastMessage':_0xb1749,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x5b0aba[_0x2e3d39(0x152)]({'status':_0x2e3d39(0x181),'unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0x2e3d39(0x17a)])({'userId':_0x5b0aba['userId']||null,'queueId':_0x5b0aba['queueId']||null,'ticketId':_0x5b0aba['id'],'type':_0x2e3d39(0x170)});},_0x243146=(0x0,socket_1[_0x389659(0x172)])();try{const {rows:_0x204040}=await Ticket_1[_0x389659(0x17a)][_0x389659(0x177)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x389659(0x16a),_0x389659(0x154)]},'companyId':_0x26062e},'order':[['updatedAt',_0x389659(0x15d)]]});_0x204040[_0x389659(0x17f)](async _0x4812e1=>{const _0x409f15=_0x389659,_0x5586ba=await(0x0,ShowTicketService_1[_0x409f15(0x17a)])(_0x4812e1['id'],_0x26062e),_0x301afa=await Whatsapp_1[_0x409f15(0x17a)][_0x409f15(0x15b)](_0x5586ba?.[_0x409f15(0x16d)]),_0x434995=await TicketTraking_1[_0x409f15(0x17a)][_0x409f15(0x16c)]({'where':{'ticketId':_0x4812e1['id'],'finishedAt':null}});if(!_0x301afa)return;let {timeInactiveMessage:_0x49acb6,expiresInactiveMessage:_0x5db64c,inactiveMessage:_0x5d8a22,expiresTicket:_0x1646de,expiresTicketNPS:_0x2d068f,whenExpiresTicket:_0x30e79b,complationMessage:_0x29811c}=_0x301afa;if(_0x2d068f&&_0x2d068f!==''&&_0x2d068f!=='0'&&Number(_0x2d068f)>0x0){const _0x32b920=new Date();_0x32b920['setMinutes'](_0x32b920[_0x409f15(0x159)]()-Number(_0x2d068f));if(_0x4812e1[_0x409f15(0x158)]===_0x409f15(0x154)){const _0x406e92=new Date(_0x5586ba[_0x409f15(0x17b)]);if(_0x406e92<_0x32b920){_0x255b2a(_0x5586ba,_0x5586ba[_0x409f15(0x158)],'');const _0x159d9c=(0x0,Mustache_1[_0x409f15(0x17a)])('‎'+_0x29811c,_0x5586ba);if(_0x29811c!==''&&_0x29811c!==undefined){const _0x46203d=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x159d9c,'ticket':_0x5586ba});await(0x0,wbotMessageListener_1[_0x409f15(0x163)])(_0x46203d,_0x5586ba,_0x5586ba['contact']);}await _0x434995[_0x409f15(0x152)]({'finishedAt':(0x0,moment_1[_0x409f15(0x17a)])()[_0x409f15(0x16f)](),'closedAt':(0x0,moment_1[_0x409f15(0x17a)])()[_0x409f15(0x16f)](),'whatsappId':_0x4812e1['whatsappId'],'userId':_0x4812e1[_0x409f15(0x15e)]}),_0x243146['to'](_0x409f15(0x16a))[_0x409f15(0x168)](_0x409f15(0x161)+_0x26062e+_0x409f15(0x17c),{'action':_0x409f15(0x156),'ticket':_0x5586ba,'ticketId':_0x5586ba['id']});}}}if(_0x1646de&&_0x1646de!==''&&_0x1646de!=='0'&&Number(_0x1646de)>0x0){const _0x484df8=(0x0,Mustache_1[_0x409f15(0x17a)])('‎'+_0x5db64c,_0x5586ba),_0x2c6c70=new Date();_0x2c6c70[_0x409f15(0x167)](_0x2c6c70['getMinutes']()-Number(_0x1646de));_0x49acb6&&_0x49acb6!==''&&_0x49acb6!==null&&_0x49acb6!=='0'&&Number(_0x49acb6)>0x0&&_0x2c6c70[_0x409f15(0x167)](_0x2c6c70['getMinutes']()-Number(_0x49acb6));if(_0x5586ba[_0x409f15(0x158)]===_0x409f15(0x16a)&&!_0x5586ba[_0x409f15(0x166)]){const _0x43da92=new Date(_0x5586ba['updatedAt']);if(_0x43da92<_0x2c6c70&&(_0x30e79b==='0'||_0x30e79b==='1'&&_0x5586ba[_0x409f15(0x180)])){_0x255b2a(_0x5586ba,_0x5586ba[_0x409f15(0x158)],_0x484df8);if(_0x5db64c!==''&&_0x5db64c!==undefined){const _0x25ecfc=await(0x0,SendWhatsAppMessage_1[_0x409f15(0x17a)])({'body':_0x484df8,'ticket':_0x5586ba});await(0x0,wbotMessageListener_1[_0x409f15(0x163)])(_0x25ecfc,_0x5586ba,_0x5586ba[_0x409f15(0x182)]);}await _0x434995[_0x409f15(0x152)]({'finishedAt':(0x0,moment_1['default'])()['toDate'](),'closedAt':(0x0,moment_1[_0x409f15(0x17a)])()[_0x409f15(0x16f)](),'whatsappId':_0x4812e1['whatsappId'],'userId':_0x4812e1[_0x409f15(0x15e)]}),_0x243146['to'](_0x409f15(0x16a))[_0x409f15(0x168)](_0x409f15(0x161)+_0x26062e+_0x409f15(0x17c),{'action':_0x409f15(0x156),'ticket':_0x5586ba,'ticketId':_0x5586ba['id']});}}}if(_0x49acb6&&_0x49acb6!==''&&_0x49acb6!=='0'&&Number(_0x49acb6)>0x0){const _0x2d5e34=(0x0,Mustache_1[_0x409f15(0x17a)])('‎'+_0x5d8a22,_0x5586ba),_0x5279ee=new Date();_0x5279ee['setMinutes'](_0x5279ee['getMinutes']()-Number(_0x49acb6));if(_0x5586ba[_0x409f15(0x158)]===_0x409f15(0x16a)&&!_0x5586ba[_0x409f15(0x166)]){const _0x3667c2=new Date(_0x5586ba[_0x409f15(0x17b)]);if(_0x3667c2<_0x5279ee&&!_0x5586ba[_0x409f15(0x179)]&&(_0x30e79b==='0'||_0x30e79b==='1'&&_0x5586ba['fromMe'])){const _0x24eac2=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x2d5e34,'ticket':_0x5586ba});await(0x0,wbotMessageListener_1[_0x409f15(0x163)])(_0x24eac2,_0x5586ba,_0x5586ba[_0x409f15(0x182)]),await _0x5586ba['update']({'sendInactiveMessage':!![]}),_0x243146['to'](_0x409f15(0x16a))['emit'](_0x409f15(0x161)+_0x26062e+_0x409f15(0x17c),{'action':_0x409f15(0x156),'ticket':_0x5586ba,'ticketId':_0x5586ba['id']});}}}});}catch(_0x5ed2cf){console[_0x389659(0x17e)]('e',_0x5ed2cf);}};exports[a573_0x4526ea(0x155)]=ClosedAllOpenTickets;