'use strict';const a626_0x5a6ca3=a626_0x1944;(function(_0x44573e,_0x24bc16){const _0x24e5a2=a626_0x1944,_0xaa7804=_0x44573e();while(!![]){try{const _0x257fe5=parseInt(_0x24e5a2(0x189))/0x1+parseInt(_0x24e5a2(0x18c))/0x2+parseInt(_0x24e5a2(0x187))/0x3+parseInt(_0x24e5a2(0x188))/0x4*(parseInt(_0x24e5a2(0x1a8))/0x5)+-parseInt(_0x24e5a2(0x19c))/0x6*(parseInt(_0x24e5a2(0x191))/0x7)+-parseInt(_0x24e5a2(0x182))/0x8*(-parseInt(_0x24e5a2(0x190))/0x9)+-parseInt(_0x24e5a2(0x19a))/0xa;if(_0x257fe5===_0x24bc16)break;else _0xaa7804['push'](_0xaa7804['shift']());}catch(_0x1e2bfb){_0xaa7804['push'](_0xaa7804['shift']());}}}(a626_0x2d64,0x41e21));function a626_0x2d64(){const _0x367d94=['../../helpers/Mustache','setMinutes','findAndCountAll','findByPk','196085nRKPLB','../../models/TicketTraking','ClosedAllOpenTickets','forEach','whatsappId','../TicketServices/CreateLogTicketService','nps','../../libs/socket','default','emit','__esModule','status','-ticket','isGroup','8juKXoM','queueId','closed','delete','update','183165CtyXlQ','4sLlvTk','256819XsAnrz','DESC','toDate','761364XmSvDf','log','../../models/Whatsapp','getMinutes','2498229MgyEsl','925694uxXLHF','./SendWhatsAppMessage','sendInactiveMessage','moment','verifyMessage','getIO','../../models/Ticket','company-','../TicketServices/ShowTicketService','6132550ZiMWai','fromMe','6VbciDj','userId','./wbotMessageListener','findOne','updatedAt','defineProperty','open','contact'];a626_0x2d64=function(){return _0x367d94;};return a626_0x2d64();}var __importDefault=this&&this['__importDefault']||function(_0x213a92){const _0x110dcf=a626_0x1944;return _0x213a92&&_0x213a92[_0x110dcf(0x1b2)]?_0x213a92:{'default':_0x213a92};};function a626_0x1944(_0x58879d,_0x187243){const _0x2d64a1=a626_0x2d64();return a626_0x1944=function(_0x194487,_0x1f2267){_0x194487=_0x194487-0x180;let _0x266d60=_0x2d64a1[_0x194487];return _0x266d60;},a626_0x1944(_0x58879d,_0x187243);}Object[a626_0x5a6ca3(0x1a1)](exports,'__esModule',{'value':!![]}),exports[a626_0x5a6ca3(0x1aa)]=void 0x0;const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require(a626_0x5a6ca3(0x197))),Whatsapp_1=__importDefault(require(a626_0x5a6ca3(0x18e))),socket_1=require(a626_0x5a6ca3(0x1af)),Mustache_1=__importDefault(require(a626_0x5a6ca3(0x1a4))),SendWhatsAppMessage_1=__importDefault(require(a626_0x5a6ca3(0x192))),moment_1=__importDefault(require(a626_0x5a6ca3(0x194))),ShowTicketService_1=__importDefault(require(a626_0x5a6ca3(0x199))),wbotMessageListener_1=require(a626_0x5a6ca3(0x19e)),TicketTraking_1=__importDefault(require(a626_0x5a6ca3(0x1a9))),CreateLogTicketService_1=__importDefault(require(a626_0x5a6ca3(0x1ad))),ClosedAllOpenTickets=async _0x2b5e8e=>{const _0x5005f0=a626_0x5a6ca3,_0x547e0d=async(_0x183651,_0x310c7f,_0x4327d9)=>{const _0xa55f4d=a626_0x1944;if(_0x310c7f===_0xa55f4d(0x1ae))await _0x183651[_0xa55f4d(0x186)]({'status':_0xa55f4d(0x184),'lastMessage':_0x4327d9,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x310c7f===_0xa55f4d(0x1a2)?await _0x183651[_0xa55f4d(0x186)]({'status':'closed','lastMessage':_0x4327d9,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x183651[_0xa55f4d(0x186)]({'status':_0xa55f4d(0x184),'unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0xa55f4d(0x1b0)])({'userId':_0x183651[_0xa55f4d(0x19d)]||null,'queueId':_0x183651[_0xa55f4d(0x183)]||null,'ticketId':_0x183651['id'],'type':'autoClose'});},_0x4b4d5c=(0x0,socket_1[_0x5005f0(0x196)])();try{const {rows:_0x2e9d98}=await Ticket_1['default'][_0x5005f0(0x1a6)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x5005f0(0x1a2),_0x5005f0(0x1ae)]},'companyId':_0x2b5e8e},'order':[[_0x5005f0(0x1a0),_0x5005f0(0x18a)]]});_0x2e9d98[_0x5005f0(0x1ab)](async _0x366c8a=>{const _0x3d9d24=_0x5005f0,_0x15b4ac=await(0x0,ShowTicketService_1[_0x3d9d24(0x1b0)])(_0x366c8a['id'],_0x2b5e8e),_0x28fee4=await Whatsapp_1['default'][_0x3d9d24(0x1a7)](_0x15b4ac?.[_0x3d9d24(0x1ac)]),_0x3f2cfc=await TicketTraking_1[_0x3d9d24(0x1b0)][_0x3d9d24(0x19f)]({'where':{'ticketId':_0x366c8a['id'],'finishedAt':null}});if(!_0x28fee4)return;let {timeInactiveMessage:_0x2d859c,expiresInactiveMessage:_0x830129,inactiveMessage:_0x4f9fa1,expiresTicket:_0x62de14,expiresTicketNPS:_0x44715f,whenExpiresTicket:_0x584ed2,complationMessage:_0x505099}=_0x28fee4;if(_0x44715f&&_0x44715f!==''&&_0x44715f!=='0'&&Number(_0x44715f)>0x0){const _0x5d544e=new Date();_0x5d544e[_0x3d9d24(0x1a5)](_0x5d544e[_0x3d9d24(0x18f)]()-Number(_0x44715f));if(_0x366c8a[_0x3d9d24(0x1b3)]===_0x3d9d24(0x1ae)){const _0x37b91b=new Date(_0x15b4ac[_0x3d9d24(0x1a0)]);if(_0x37b91b<_0x5d544e){_0x547e0d(_0x15b4ac,_0x15b4ac['status'],'');const _0x53b54a=(0x0,Mustache_1[_0x3d9d24(0x1b0)])('‎'+_0x505099,_0x15b4ac);if(_0x505099!==''&&_0x505099!==undefined){const _0x42b4f2=await(0x0,SendWhatsAppMessage_1[_0x3d9d24(0x1b0)])({'body':_0x53b54a,'ticket':_0x15b4ac});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x42b4f2,_0x15b4ac,_0x15b4ac[_0x3d9d24(0x1a3)]);}await _0x3f2cfc[_0x3d9d24(0x186)]({'finishedAt':(0x0,moment_1[_0x3d9d24(0x1b0)])()[_0x3d9d24(0x18b)](),'closedAt':(0x0,moment_1['default'])()[_0x3d9d24(0x18b)](),'whatsappId':_0x366c8a[_0x3d9d24(0x1ac)],'userId':_0x366c8a[_0x3d9d24(0x19d)]}),_0x4b4d5c['to'](_0x3d9d24(0x1a2))[_0x3d9d24(0x1b1)](_0x3d9d24(0x198)+_0x2b5e8e+_0x3d9d24(0x180),{'action':_0x3d9d24(0x185),'ticketId':_0x15b4ac['id']});}}}if(_0x62de14&&_0x62de14!==''&&_0x62de14!=='0'&&Number(_0x62de14)>0x0){const _0x58ce9d=(0x0,Mustache_1[_0x3d9d24(0x1b0)])('‎'+_0x830129,_0x15b4ac),_0x4a1489=new Date();_0x4a1489[_0x3d9d24(0x1a5)](_0x4a1489[_0x3d9d24(0x18f)]()-Number(_0x62de14));_0x2d859c&&_0x2d859c!==''&&_0x2d859c!==null&&_0x2d859c!=='0'&&Number(_0x2d859c)>0x0&&_0x4a1489[_0x3d9d24(0x1a5)](_0x4a1489[_0x3d9d24(0x18f)]()-Number(_0x2d859c));if(_0x15b4ac[_0x3d9d24(0x1b3)]===_0x3d9d24(0x1a2)&&!_0x15b4ac[_0x3d9d24(0x181)]){const _0x4373b8=new Date(_0x15b4ac['updatedAt']);if(_0x4373b8<_0x4a1489&&(_0x584ed2==='0'||_0x584ed2==='1'&&_0x15b4ac[_0x3d9d24(0x19b)])){_0x547e0d(_0x15b4ac,_0x15b4ac['status'],_0x58ce9d);if(_0x830129!==''&&_0x830129!==undefined){const _0x52f76f=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x58ce9d,'ticket':_0x15b4ac});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x52f76f,_0x15b4ac,_0x15b4ac[_0x3d9d24(0x1a3)]);}await _0x3f2cfc['update']({'finishedAt':(0x0,moment_1[_0x3d9d24(0x1b0)])()['toDate'](),'closedAt':(0x0,moment_1[_0x3d9d24(0x1b0)])()[_0x3d9d24(0x18b)](),'whatsappId':_0x366c8a[_0x3d9d24(0x1ac)],'userId':_0x366c8a[_0x3d9d24(0x19d)]}),_0x4b4d5c['to']('open')[_0x3d9d24(0x1b1)](_0x3d9d24(0x198)+_0x2b5e8e+_0x3d9d24(0x180),{'action':_0x3d9d24(0x185),'ticketId':_0x15b4ac['id']});}}}if(_0x2d859c&&_0x2d859c!==''&&_0x2d859c!=='0'&&Number(_0x2d859c)>0x0){const _0x300dbb=(0x0,Mustache_1[_0x3d9d24(0x1b0)])('‎'+_0x4f9fa1,_0x15b4ac),_0x2cbadd=new Date();_0x2cbadd[_0x3d9d24(0x1a5)](_0x2cbadd[_0x3d9d24(0x18f)]()-Number(_0x2d859c));if(_0x15b4ac[_0x3d9d24(0x1b3)]===_0x3d9d24(0x1a2)&&!_0x15b4ac['isGroup']){const _0x53f975=new Date(_0x15b4ac['updatedAt']);if(_0x53f975<_0x2cbadd&&!_0x15b4ac[_0x3d9d24(0x193)]&&(_0x584ed2==='0'||_0x584ed2==='1'&&_0x15b4ac[_0x3d9d24(0x19b)])){const _0x1d2010=await(0x0,SendWhatsAppMessage_1[_0x3d9d24(0x1b0)])({'body':_0x300dbb,'ticket':_0x15b4ac});await(0x0,wbotMessageListener_1[_0x3d9d24(0x195)])(_0x1d2010,_0x15b4ac,_0x15b4ac[_0x3d9d24(0x1a3)]),await _0x15b4ac[_0x3d9d24(0x186)]({'sendInactiveMessage':!![]}),_0x4b4d5c['to'](_0x3d9d24(0x1a2))[_0x3d9d24(0x1b1)](_0x3d9d24(0x198)+_0x2b5e8e+_0x3d9d24(0x180),{'action':_0x3d9d24(0x185),'ticket':_0x15b4ac,'ticketId':_0x15b4ac['id']});}}}});}catch(_0x161515){console[_0x5005f0(0x18d)]('e',_0x161515);}};exports[a626_0x5a6ca3(0x1aa)]=ClosedAllOpenTickets;