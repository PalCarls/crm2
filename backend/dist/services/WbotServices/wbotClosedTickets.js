'use strict';const a626_0x993930=a626_0x2453;(function(_0xa893fb,_0x5b6b87){const _0x5d97b4=a626_0x2453,_0x3c5ce0=_0xa893fb();while(!![]){try{const _0x1efbca=-parseInt(_0x5d97b4(0x16e))/0x1+parseInt(_0x5d97b4(0x15e))/0x2+parseInt(_0x5d97b4(0x157))/0x3*(-parseInt(_0x5d97b4(0x168))/0x4)+parseInt(_0x5d97b4(0x174))/0x5*(parseInt(_0x5d97b4(0x15a))/0x6)+-parseInt(_0x5d97b4(0x14c))/0x7*(parseInt(_0x5d97b4(0x15b))/0x8)+parseInt(_0x5d97b4(0x153))/0x9+parseInt(_0x5d97b4(0x14f))/0xa;if(_0x1efbca===_0x5b6b87)break;else _0x3c5ce0['push'](_0x3c5ce0['shift']());}catch(_0x21886f){_0x3c5ce0['push'](_0x3c5ce0['shift']());}}}(a626_0x59db,0xaa455));var __importDefault=this&&this[a626_0x993930(0x164)]||function(_0x355367){const _0x4cafcf=a626_0x993930;return _0x355367&&_0x355367[_0x4cafcf(0x16f)]?_0x355367:{'default':_0x355367};};function a626_0x59db(){const _0x26252b=['../TicketServices/ShowTicketService','company-','7569260GMiiKK','autoClose','getIO','updatedAt','12265101mapRjY','./SendWhatsAppMessage','getMinutes','defineProperty','39ljVAtr','toDate','emit','10422nLieBQ','128iFAnoJ','contact','delete','885602GMxlDc','update','fromMe','findByPk','sequelize','forEach','__importDefault','./wbotMessageListener','sendInactiveMessage','moment','360076xnMdwW','log','queueId','isGroup','default','whatsappId','762266PeMNHW','__esModule','../../libs/socket','verifyMessage','findAndCountAll','nps','570ZJHBdD','userId','open','-ticket','closed','setMinutes','../../models/TicketTraking','status','ClosedAllOpenTickets','../TicketServices/CreateLogTicketService','57134shHuqI'];a626_0x59db=function(){return _0x26252b;};return a626_0x59db();}Object[a626_0x993930(0x156)](exports,a626_0x993930(0x16f),{'value':!![]}),exports[a626_0x993930(0x14a)]=void 0x0;const sequelize_1=require(a626_0x993930(0x162)),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),socket_1=require(a626_0x993930(0x170)),Mustache_1=__importDefault(require('../../helpers/Mustache')),SendWhatsAppMessage_1=__importDefault(require(a626_0x993930(0x154))),moment_1=__importDefault(require(a626_0x993930(0x167))),ShowTicketService_1=__importDefault(require(a626_0x993930(0x14d))),wbotMessageListener_1=require(a626_0x993930(0x165)),TicketTraking_1=__importDefault(require(a626_0x993930(0x148))),CreateLogTicketService_1=__importDefault(require(a626_0x993930(0x14b))),ClosedAllOpenTickets=async _0x42333a=>{const _0x3b7d85=a626_0x993930,_0x38bd13=async(_0x2f4434,_0x5ed264,_0x888680)=>{const _0x241cc5=a626_0x2453;if(_0x5ed264===_0x241cc5(0x173))await _0x2f4434[_0x241cc5(0x15f)]({'status':_0x241cc5(0x146),'lastMessage':_0x888680,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x5ed264===_0x241cc5(0x144)?await _0x2f4434['update']({'status':'closed','lastMessage':_0x888680,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x2f4434[_0x241cc5(0x15f)]({'status':'closed','unreadMessages':0x0});await(0x0,CreateLogTicketService_1['default'])({'userId':_0x2f4434[_0x241cc5(0x143)]||null,'queueId':_0x2f4434[_0x241cc5(0x16a)]||null,'ticketId':_0x2f4434['id'],'type':_0x241cc5(0x150)});},_0x5d708d=(0x0,socket_1[_0x3b7d85(0x151)])();try{const {rows:_0x484589}=await Ticket_1[_0x3b7d85(0x16c)][_0x3b7d85(0x172)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x3b7d85(0x144),'nps']},'companyId':_0x42333a},'order':[[_0x3b7d85(0x152),'DESC']]});_0x484589[_0x3b7d85(0x163)](async _0x348809=>{const _0x1ce58f=_0x3b7d85,_0xb7fec4=await(0x0,ShowTicketService_1[_0x1ce58f(0x16c)])(_0x348809['id'],_0x42333a),_0x51c0f5=await Whatsapp_1[_0x1ce58f(0x16c)][_0x1ce58f(0x161)](_0xb7fec4?.[_0x1ce58f(0x16d)]),_0x240d06=await TicketTraking_1['default']['findOne']({'where':{'ticketId':_0x348809['id'],'finishedAt':null}});if(!_0x51c0f5)return;let {timeInactiveMessage:_0x4d5d8d,expiresInactiveMessage:_0x2c25d9,inactiveMessage:_0x124e79,expiresTicket:_0x2fae25,expiresTicketNPS:_0x1e96b5,whenExpiresTicket:_0x18a904,complationMessage:_0x2eca63}=_0x51c0f5;if(_0x1e96b5&&_0x1e96b5!==''&&_0x1e96b5!=='0'&&Number(_0x1e96b5)>0x0){const _0x599570=new Date();_0x599570[_0x1ce58f(0x147)](_0x599570[_0x1ce58f(0x155)]()-Number(_0x1e96b5));if(_0x348809[_0x1ce58f(0x149)]==='nps'){const _0x2a6877=new Date(_0xb7fec4['updatedAt']);if(_0x2a6877<_0x599570){_0x38bd13(_0xb7fec4,_0xb7fec4['status'],'');const _0x48e787=(0x0,Mustache_1['default'])('‎'+_0x2eca63,_0xb7fec4);if(_0x2eca63!==''&&_0x2eca63!==undefined){const _0x2566b6=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x48e787,'ticket':_0xb7fec4});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x2566b6,_0xb7fec4,_0xb7fec4[_0x1ce58f(0x15c)]);}await _0x240d06[_0x1ce58f(0x15f)]({'finishedAt':(0x0,moment_1[_0x1ce58f(0x16c)])()[_0x1ce58f(0x158)](),'closedAt':(0x0,moment_1[_0x1ce58f(0x16c)])()['toDate'](),'whatsappId':_0x348809[_0x1ce58f(0x16d)],'userId':_0x348809['userId']}),_0x5d708d['to'](_0x1ce58f(0x144))[_0x1ce58f(0x159)](_0x1ce58f(0x14e)+_0x42333a+_0x1ce58f(0x145),{'action':_0x1ce58f(0x15d),'ticketId':_0xb7fec4['id']});}}}if(_0x2fae25&&_0x2fae25!==''&&_0x2fae25!=='0'&&Number(_0x2fae25)>0x0){const _0x51e000=(0x0,Mustache_1[_0x1ce58f(0x16c)])('‎'+_0x2c25d9,_0xb7fec4),_0x3f59bb=new Date();_0x3f59bb[_0x1ce58f(0x147)](_0x3f59bb[_0x1ce58f(0x155)]()-Number(_0x2fae25));_0x4d5d8d&&_0x4d5d8d!==''&&_0x4d5d8d!==null&&_0x4d5d8d!=='0'&&Number(_0x4d5d8d)>0x0&&_0x3f59bb[_0x1ce58f(0x147)](_0x3f59bb[_0x1ce58f(0x155)]()-Number(_0x4d5d8d));if(_0xb7fec4[_0x1ce58f(0x149)]===_0x1ce58f(0x144)&&!_0xb7fec4[_0x1ce58f(0x16b)]){const _0x208dee=new Date(_0xb7fec4[_0x1ce58f(0x152)]);if(_0x208dee<_0x3f59bb&&(_0x18a904==='0'||_0x18a904==='1'&&_0xb7fec4[_0x1ce58f(0x160)])){_0x38bd13(_0xb7fec4,_0xb7fec4[_0x1ce58f(0x149)],_0x51e000);if(_0x2c25d9!==''&&_0x2c25d9!==undefined){const _0x4185f3=await(0x0,SendWhatsAppMessage_1[_0x1ce58f(0x16c)])({'body':_0x51e000,'ticket':_0xb7fec4});await(0x0,wbotMessageListener_1[_0x1ce58f(0x171)])(_0x4185f3,_0xb7fec4,_0xb7fec4[_0x1ce58f(0x15c)]);}await _0x240d06['update']({'finishedAt':(0x0,moment_1[_0x1ce58f(0x16c)])()[_0x1ce58f(0x158)](),'closedAt':(0x0,moment_1[_0x1ce58f(0x16c)])()['toDate'](),'whatsappId':_0x348809['whatsappId'],'userId':_0x348809[_0x1ce58f(0x143)]}),_0x5d708d['to']('open')[_0x1ce58f(0x159)](_0x1ce58f(0x14e)+_0x42333a+_0x1ce58f(0x145),{'action':_0x1ce58f(0x15d),'ticketId':_0xb7fec4['id']});}}}if(_0x4d5d8d&&_0x4d5d8d!==''&&_0x4d5d8d!=='0'&&Number(_0x4d5d8d)>0x0){const _0x334f85=(0x0,Mustache_1[_0x1ce58f(0x16c)])('‎'+_0x124e79,_0xb7fec4),_0x8625bf=new Date();_0x8625bf[_0x1ce58f(0x147)](_0x8625bf[_0x1ce58f(0x155)]()-Number(_0x4d5d8d));if(_0xb7fec4[_0x1ce58f(0x149)]==='open'&&!_0xb7fec4['isGroup']){const _0x348469=new Date(_0xb7fec4[_0x1ce58f(0x152)]);if(_0x348469<_0x8625bf&&!_0xb7fec4[_0x1ce58f(0x166)]&&(_0x18a904==='0'||_0x18a904==='1'&&_0xb7fec4[_0x1ce58f(0x160)])){const _0x23311e=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x334f85,'ticket':_0xb7fec4});await(0x0,wbotMessageListener_1[_0x1ce58f(0x171)])(_0x23311e,_0xb7fec4,_0xb7fec4[_0x1ce58f(0x15c)]),await _0xb7fec4[_0x1ce58f(0x15f)]({'sendInactiveMessage':!![]}),_0x5d708d['to'](_0x1ce58f(0x144))['emit'](_0x1ce58f(0x14e)+_0x42333a+_0x1ce58f(0x145),{'action':'delete','ticket':_0xb7fec4,'ticketId':_0xb7fec4['id']});}}}});}catch(_0xdb8f3d){console[_0x3b7d85(0x169)]('e',_0xdb8f3d);}};function a626_0x2453(_0x2a7e1c,_0x255559){const _0x59db96=a626_0x59db();return a626_0x2453=function(_0x2453b3,_0x5efb54){_0x2453b3=_0x2453b3-0x143;let _0x3bae79=_0x59db96[_0x2453b3];return _0x3bae79;},a626_0x2453(_0x2a7e1c,_0x255559);}exports['ClosedAllOpenTickets']=ClosedAllOpenTickets;