'use strict';const a626_0x497d9f=a626_0x24dd;(function(_0x342856,_0x237c9e){const _0x242658=a626_0x24dd,_0xfef507=_0x342856();while(!![]){try{const _0xe4b379=parseInt(_0x242658(0x1f2))/0x1+-parseInt(_0x242658(0x215))/0x2*(-parseInt(_0x242658(0x20c))/0x3)+-parseInt(_0x242658(0x1f1))/0x4*(-parseInt(_0x242658(0x20f))/0x5)+parseInt(_0x242658(0x1f5))/0x6+-parseInt(_0x242658(0x1ed))/0x7+-parseInt(_0x242658(0x203))/0x8+parseInt(_0x242658(0x210))/0x9*(-parseInt(_0x242658(0x207))/0xa);if(_0xe4b379===_0x237c9e)break;else _0xfef507['push'](_0xfef507['shift']());}catch(_0x43e8e7){_0xfef507['push'](_0xfef507['shift']());}}}(a626_0x5c96,0x8ad7a));function a626_0x5c96(){const _0x2f4361=['300145KYRjde','3411OMMuWV','-ticket','toDate','update','whatsappId','6356QcdSor','verifyMessage','DESC','delete','./wbotMessageListener','findByPk','updatedAt','3029971TSjiWP','../../models/Whatsapp','nps','status','8LGdDWs','527280WNDbkZ','forEach','open','6238836lrzBbo','getIO','../TicketServices/ShowTicketService','__esModule','default','company-','autoClose','contact','../../libs/socket','../TicketServices/CreateLogTicketService','setMinutes','__importDefault','ClosedAllOpenTickets','userId','4709392MIPPeF','findOne','../../models/TicketTraking','findAndCountAll','8930CQvCWE','sendInactiveMessage','isGroup','queueId','../../helpers/Mustache','228XzYBMr','getMinutes','fromMe'];a626_0x5c96=function(){return _0x2f4361;};return a626_0x5c96();}var __importDefault=this&&this[a626_0x497d9f(0x200)]||function(_0x511e2f){const _0x102de6=a626_0x497d9f;return _0x511e2f&&_0x511e2f[_0x102de6(0x1f8)]?_0x511e2f:{'default':_0x511e2f};};Object['defineProperty'](exports,a626_0x497d9f(0x1f8),{'value':!![]}),exports[a626_0x497d9f(0x201)]=void 0x0;const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require(a626_0x497d9f(0x1ee))),socket_1=require(a626_0x497d9f(0x1fd)),Mustache_1=__importDefault(require(a626_0x497d9f(0x20b))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require('moment')),ShowTicketService_1=__importDefault(require(a626_0x497d9f(0x1f7))),wbotMessageListener_1=require(a626_0x497d9f(0x1ea)),TicketTraking_1=__importDefault(require(a626_0x497d9f(0x205))),CreateLogTicketService_1=__importDefault(require(a626_0x497d9f(0x1fe))),ClosedAllOpenTickets=async _0x3cd72c=>{const _0x58f05b=a626_0x497d9f,_0x5633e4=async(_0x12d2b9,_0xcfed8b,_0x56a0d0)=>{const _0xf664c5=a626_0x24dd;if(_0xcfed8b===_0xf664c5(0x1ef))await _0x12d2b9[_0xf664c5(0x213)]({'status':'closed','lastMessage':_0x56a0d0,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0xcfed8b===_0xf664c5(0x1f4)?await _0x12d2b9[_0xf664c5(0x213)]({'status':'closed','lastMessage':_0x56a0d0,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x12d2b9[_0xf664c5(0x213)]({'status':'closed','unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0xf664c5(0x1f9)])({'userId':_0x12d2b9['userId']||null,'queueId':_0x12d2b9[_0xf664c5(0x20a)]||null,'ticketId':_0x12d2b9['id'],'type':_0xf664c5(0x1fb)});},_0xd53c8=(0x0,socket_1[_0x58f05b(0x1f6)])();try{const {rows:_0x12a33b}=await Ticket_1[_0x58f05b(0x1f9)][_0x58f05b(0x206)]({'where':{'status':{[sequelize_1['Op']['in']]:['open',_0x58f05b(0x1ef)]},'companyId':_0x3cd72c},'order':[['updatedAt',_0x58f05b(0x1e8)]]});_0x12a33b[_0x58f05b(0x1f3)](async _0x5278cd=>{const _0x345451=_0x58f05b,_0x1376e3=await(0x0,ShowTicketService_1[_0x345451(0x1f9)])(_0x5278cd['id'],_0x3cd72c),_0x2dcadd=await Whatsapp_1['default'][_0x345451(0x1eb)](_0x1376e3?.[_0x345451(0x214)]),_0xae9fe5=await TicketTraking_1[_0x345451(0x1f9)][_0x345451(0x204)]({'where':{'ticketId':_0x5278cd['id'],'finishedAt':null}});if(!_0x2dcadd)return;let {timeInactiveMessage:_0x5b6cb8,expiresInactiveMessage:_0x1286ff,inactiveMessage:_0x15c00a,expiresTicket:_0x15835b,expiresTicketNPS:_0x158703,whenExpiresTicket:_0x1cde58,complationMessage:_0x30ffa2}=_0x2dcadd;if(_0x158703&&_0x158703!==''&&_0x158703!=='0'&&Number(_0x158703)>0x0){const _0x47ad40=new Date();_0x47ad40[_0x345451(0x1ff)](_0x47ad40[_0x345451(0x20d)]()-Number(_0x158703));if(_0x5278cd[_0x345451(0x1f0)]===_0x345451(0x1ef)){const _0x3c8594=new Date(_0x1376e3['updatedAt']);if(_0x3c8594<_0x47ad40){_0x5633e4(_0x1376e3,_0x1376e3['status'],'');const _0x1af1d6=(0x0,Mustache_1[_0x345451(0x1f9)])('‎'+_0x30ffa2,_0x1376e3);if(_0x30ffa2!==''&&_0x30ffa2!==undefined){const _0x383a8f=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x1af1d6,'ticket':_0x1376e3});await(0x0,wbotMessageListener_1[_0x345451(0x216)])(_0x383a8f,_0x1376e3,_0x1376e3['contact']);}await _0xae9fe5[_0x345451(0x213)]({'finishedAt':(0x0,moment_1[_0x345451(0x1f9)])()[_0x345451(0x212)](),'closedAt':(0x0,moment_1[_0x345451(0x1f9)])()[_0x345451(0x212)](),'whatsappId':_0x5278cd[_0x345451(0x214)],'userId':_0x5278cd['userId']}),_0xd53c8['to'](_0x345451(0x1f4))['emit'](_0x345451(0x1fa)+_0x3cd72c+_0x345451(0x211),{'action':'delete','ticketId':_0x1376e3['id']});}}}if(_0x15835b&&_0x15835b!==''&&_0x15835b!=='0'&&Number(_0x15835b)>0x0){const _0x54d8d0=(0x0,Mustache_1['default'])('‎'+_0x1286ff,_0x1376e3),_0x2946f8=new Date();_0x2946f8[_0x345451(0x1ff)](_0x2946f8[_0x345451(0x20d)]()-Number(_0x15835b));_0x5b6cb8&&_0x5b6cb8!==''&&_0x5b6cb8!==null&&_0x5b6cb8!=='0'&&Number(_0x5b6cb8)>0x0&&_0x2946f8[_0x345451(0x1ff)](_0x2946f8[_0x345451(0x20d)]()-Number(_0x5b6cb8));if(_0x1376e3[_0x345451(0x1f0)]==='open'&&!_0x1376e3[_0x345451(0x209)]){const _0x1ac857=new Date(_0x1376e3['updatedAt']);if(_0x1ac857<_0x2946f8&&(_0x1cde58==='0'||_0x1cde58==='1'&&_0x1376e3[_0x345451(0x20e)])){_0x5633e4(_0x1376e3,_0x1376e3['status'],_0x54d8d0);if(_0x1286ff!==''&&_0x1286ff!==undefined){const _0x429dae=await(0x0,SendWhatsAppMessage_1[_0x345451(0x1f9)])({'body':_0x54d8d0,'ticket':_0x1376e3});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x429dae,_0x1376e3,_0x1376e3['contact']);}await _0xae9fe5['update']({'finishedAt':(0x0,moment_1[_0x345451(0x1f9)])()[_0x345451(0x212)](),'closedAt':(0x0,moment_1['default'])()[_0x345451(0x212)](),'whatsappId':_0x5278cd['whatsappId'],'userId':_0x5278cd[_0x345451(0x202)]}),_0xd53c8['to'](_0x345451(0x1f4))['emit'](_0x345451(0x1fa)+_0x3cd72c+_0x345451(0x211),{'action':_0x345451(0x1e9),'ticketId':_0x1376e3['id']});}}}if(_0x5b6cb8&&_0x5b6cb8!==''&&_0x5b6cb8!=='0'&&Number(_0x5b6cb8)>0x0){const _0x345649=(0x0,Mustache_1[_0x345451(0x1f9)])('‎'+_0x15c00a,_0x1376e3),_0x18836a=new Date();_0x18836a[_0x345451(0x1ff)](_0x18836a[_0x345451(0x20d)]()-Number(_0x5b6cb8));if(_0x1376e3['status']===_0x345451(0x1f4)&&!_0x1376e3['isGroup']){const _0xdbad75=new Date(_0x1376e3[_0x345451(0x1ec)]);if(_0xdbad75<_0x18836a&&!_0x1376e3[_0x345451(0x208)]&&(_0x1cde58==='0'||_0x1cde58==='1'&&_0x1376e3[_0x345451(0x20e)])){const _0x207bb4=await(0x0,SendWhatsAppMessage_1[_0x345451(0x1f9)])({'body':_0x345649,'ticket':_0x1376e3});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x207bb4,_0x1376e3,_0x1376e3[_0x345451(0x1fc)]),await _0x1376e3['update']({'sendInactiveMessage':!![]}),_0xd53c8['to'](_0x345451(0x1f4))['emit'](_0x345451(0x1fa)+_0x3cd72c+_0x345451(0x211),{'action':_0x345451(0x1e9),'ticket':_0x1376e3,'ticketId':_0x1376e3['id']});}}}});}catch(_0x4a890b){console['log']('e',_0x4a890b);}};function a626_0x24dd(_0x441d3d,_0x3832d9){const _0x5c96e9=a626_0x5c96();return a626_0x24dd=function(_0x24dd55,_0x36fbe9){_0x24dd55=_0x24dd55-0x1e8;let _0x4c86df=_0x5c96e9[_0x24dd55];return _0x4c86df;},a626_0x24dd(_0x441d3d,_0x3832d9);}exports[a626_0x497d9f(0x201)]=ClosedAllOpenTickets;