'use strict';const a515_0x95c3d8=a515_0x110b;(function(_0x1fef85,_0x1fb109){const _0x1ff434=a515_0x110b,_0x201472=_0x1fef85();while(!![]){try{const _0x2955f9=-parseInt(_0x1ff434(0x20d))/0x1+parseInt(_0x1ff434(0x207))/0x2+parseInt(_0x1ff434(0x1f5))/0x3+parseInt(_0x1ff434(0x20f))/0x4+parseInt(_0x1ff434(0x202))/0x5+-parseInt(_0x1ff434(0x1f0))/0x6*(parseInt(_0x1ff434(0x217))/0x7)+-parseInt(_0x1ff434(0x1fe))/0x8;if(_0x2955f9===_0x1fb109)break;else _0x201472['push'](_0x201472['shift']());}catch(_0x277dd7){_0x201472['push'](_0x201472['shift']());}}}(a515_0x3564,0xcf06f));var __importDefault=this&&this['__importDefault']||function(_0x1f39ed){const _0x455e36=a515_0x110b;return _0x1f39ed&&_0x1f39ed[_0x455e36(0x201)]?_0x1f39ed:{'default':_0x1f39ed};};Object[a515_0x95c3d8(0x20b)](exports,a515_0x95c3d8(0x201),{'value':!![]}),exports['ClosedAllOpenTickets']=void 0x0;const sequelize_1=require(a515_0x95c3d8(0x1f7)),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require(a515_0x95c3d8(0x21a))),socket_1=require(a515_0x95c3d8(0x200)),Mustache_1=__importDefault(require(a515_0x95c3d8(0x205))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require(a515_0x95c3d8(0x20e))),ShowTicketService_1=__importDefault(require('../TicketServices/ShowTicketService')),wbotMessageListener_1=require(a515_0x95c3d8(0x209)),TicketTraking_1=__importDefault(require(a515_0x95c3d8(0x1f2))),ClosedAllOpenTickets=async _0x51712a=>{const _0x2f74dd=a515_0x95c3d8,_0x1e1842=async(_0x143212,_0x4ba4d3,_0x429c07)=>{const _0x4312d5=a515_0x110b;if(_0x4ba4d3===_0x4312d5(0x20c))await _0x143212[_0x4312d5(0x1f8)]({'status':_0x4312d5(0x214),'lastMessage':_0x429c07,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x4ba4d3===_0x4312d5(0x1f3)?await _0x143212[_0x4312d5(0x1f8)]({'status':'closed','lastMessage':_0x429c07,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x143212[_0x4312d5(0x1f8)]({'status':_0x4312d5(0x214),'unreadMessages':0x0});},_0x112240=(0x0,socket_1[_0x2f74dd(0x1f4)])();try{const {rows:_0x1e90dd}=await Ticket_1[_0x2f74dd(0x219)][_0x2f74dd(0x203)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x2f74dd(0x1f3),_0x2f74dd(0x20c)]},'companyId':_0x51712a},'order':[['updatedAt','DESC']]});_0x1e90dd[_0x2f74dd(0x1fa)](async _0x36dc0f=>{const _0x2837d2=_0x2f74dd,_0x38c875=await(0x0,ShowTicketService_1[_0x2837d2(0x219)])(_0x36dc0f['id'],_0x51712a),_0x15b587=await Whatsapp_1[_0x2837d2(0x219)]['findByPk'](_0x38c875?.[_0x2837d2(0x1fc)]),_0x5b76b0=await TicketTraking_1['default'][_0x2837d2(0x210)]({'where':{'ticketId':_0x36dc0f['id'],'finishedAt':null}});let {timeInactiveMessage:_0xc5cf07,expiresInactiveMessage:_0x17cd6e,inactiveMessage:_0x25dac2,expiresTicket:_0x16dc52,expiresTicketNPS:_0x1f535b,whenExpiresTicket:_0x149413,complationMessage:_0x56ab8e}=_0x15b587;if(_0x1f535b&&_0x1f535b!==''&&_0x1f535b!=='0'&&Number(_0x1f535b)>0x0){const _0x2cb0ab=new Date();_0x2cb0ab[_0x2837d2(0x1f1)](_0x2cb0ab[_0x2837d2(0x212)]()-Number(_0x1f535b));if(_0x36dc0f[_0x2837d2(0x1f9)]===_0x2837d2(0x20c)){const _0x4ef1c4=new Date(_0x38c875[_0x2837d2(0x1fb)]);if(_0x4ef1c4<_0x2cb0ab){_0x1e1842(_0x38c875,_0x38c875[_0x2837d2(0x1f9)],'');const _0x36285b=(0x0,Mustache_1[_0x2837d2(0x219)])('‎'+_0x56ab8e,_0x38c875);if(_0x56ab8e!==''&&_0x56ab8e!==undefined){const _0x1e3ac6=await(0x0,SendWhatsAppMessage_1[_0x2837d2(0x219)])({'body':_0x36285b,'ticket':_0x38c875});await(0x0,wbotMessageListener_1[_0x2837d2(0x216)])(_0x1e3ac6,_0x38c875,_0x38c875[_0x2837d2(0x21b)]);}await _0x5b76b0[_0x2837d2(0x1f8)]({'finishedAt':(0x0,moment_1[_0x2837d2(0x219)])()[_0x2837d2(0x215)](),'closedAt':(0x0,moment_1[_0x2837d2(0x219)])()[_0x2837d2(0x215)](),'whatsappId':_0x36dc0f[_0x2837d2(0x1fc)],'userId':_0x36dc0f['userId']}),_0x112240['to'](_0x2837d2(0x1f3))['emit'](_0x2837d2(0x206),{'action':_0x2837d2(0x20a),'ticket':_0x38c875,'ticketId':_0x38c875['id']});}}}if(_0x16dc52&&_0x16dc52!==''&&_0x16dc52!=='0'&&Number(_0x16dc52)>0x0){const _0x4bdef6=(0x0,Mustache_1[_0x2837d2(0x219)])('‎'+_0x17cd6e,_0x38c875),_0x434b23=new Date();_0x434b23[_0x2837d2(0x1f6)](_0x434b23[_0x2837d2(0x213)]()-Number(_0x16dc52));_0xc5cf07&&_0xc5cf07!==''&&_0xc5cf07!==null&&_0xc5cf07!=='0'&&Number(_0xc5cf07)>0x0&&_0x434b23[_0x2837d2(0x1f1)](_0x434b23[_0x2837d2(0x212)]()-Number(_0xc5cf07));if(_0x38c875[_0x2837d2(0x1f9)]===_0x2837d2(0x1f3)&&!_0x38c875['isGroup']){const _0x227481=new Date(_0x38c875[_0x2837d2(0x1fb)]);if(_0x227481<_0x434b23&&(_0x149413==='0'||_0x149413==='1'&&_0x38c875[_0x2837d2(0x1fd)])){_0x1e1842(_0x38c875,_0x38c875['status'],_0x4bdef6);if(_0x17cd6e!==''&&_0x17cd6e!==undefined){const _0x55c576=await(0x0,SendWhatsAppMessage_1[_0x2837d2(0x219)])({'body':_0x4bdef6,'ticket':_0x38c875});await(0x0,wbotMessageListener_1[_0x2837d2(0x216)])(_0x55c576,_0x38c875,_0x38c875[_0x2837d2(0x21b)]);}await _0x5b76b0[_0x2837d2(0x1f8)]({'finishedAt':(0x0,moment_1[_0x2837d2(0x219)])()[_0x2837d2(0x215)](),'closedAt':(0x0,moment_1[_0x2837d2(0x219)])()[_0x2837d2(0x215)](),'whatsappId':_0x36dc0f['whatsappId'],'userId':_0x36dc0f[_0x2837d2(0x204)]}),_0x112240['to'](_0x2837d2(0x1f3))['emit']('ticket',{'action':_0x2837d2(0x20a),'ticket':_0x38c875,'ticketId':_0x38c875['id']});}}}if(_0xc5cf07&&_0xc5cf07!==''&&_0xc5cf07!=='0'&&Number(_0xc5cf07)>0x0){const _0x25c05d=(0x0,Mustache_1['default'])('‎'+_0x25dac2,_0x38c875),_0x3703dd=new Date();_0x3703dd[_0x2837d2(0x1f1)](_0x3703dd['getMinutes']()-Number(_0xc5cf07));if(_0x38c875['status']===_0x2837d2(0x1f3)&&!_0x38c875[_0x2837d2(0x1ff)]){const _0x5285af=new Date(_0x38c875[_0x2837d2(0x1fb)]);if(_0x5285af<_0x3703dd&&!_0x38c875[_0x2837d2(0x208)]&&(_0x149413==='0'||_0x149413==='1'&&_0x38c875[_0x2837d2(0x1fd)])){const _0x3d79f4=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x25c05d,'ticket':_0x38c875});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x3d79f4,_0x38c875,_0x38c875[_0x2837d2(0x21b)]),await _0x38c875[_0x2837d2(0x1f8)]({'sendInactiveMessage':!![]}),_0x112240['to'](_0x2837d2(0x1f3))['emit'](_0x2837d2(0x206),{'action':_0x2837d2(0x20a),'ticket':_0x38c875,'ticketId':_0x38c875['id']});}}}});}catch(_0x3a39cf){console[_0x2f74dd(0x218)]('e',_0x3a39cf);}};function a515_0x110b(_0x5d1b95,_0x3c37af){const _0x356473=a515_0x3564();return a515_0x110b=function(_0x110bcd,_0xbc3db4){_0x110bcd=_0x110bcd-0x1f0;let _0x124f11=_0x356473[_0x110bcd];return _0x124f11;},a515_0x110b(_0x5d1b95,_0x3c37af);}function a515_0x3564(){const _0xc5a574=['fromMe','662168kTPqyA','isGroup','../../libs/socket','__esModule','226005zdemTK','findAndCountAll','userId','../../helpers/Mustache','ticket','62036PLqZyt','sendInactiveMessage','./wbotMessageListener','delete','defineProperty','nps','795224ngRVeB','moment','3174188rBKtue','findOne','ClosedAllOpenTickets','getMinutes','getHours','closed','toDate','verifyMessage','7EItMFr','log','default','../../models/Whatsapp','contact','2217450bEADpx','setMinutes','../../models/TicketTraking','open','getIO','3677361AhrIIq','setHours','sequelize','update','status','forEach','updatedAt','whatsappId'];a515_0x3564=function(){return _0xc5a574;};return a515_0x3564();}exports[a515_0x95c3d8(0x211)]=ClosedAllOpenTickets;