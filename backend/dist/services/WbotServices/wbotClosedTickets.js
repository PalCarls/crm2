'use strict';const a568_0x17e87e=a568_0xbc16;(function(_0x508153,_0x43ec55){const _0x3ee113=a568_0xbc16,_0x7206cc=_0x508153();while(!![]){try{const _0x14d9be=-parseInt(_0x3ee113(0x1d1))/0x1+-parseInt(_0x3ee113(0x1ec))/0x2*(parseInt(_0x3ee113(0x1f0))/0x3)+-parseInt(_0x3ee113(0x1ce))/0x4+-parseInt(_0x3ee113(0x1f1))/0x5+parseInt(_0x3ee113(0x1d6))/0x6+-parseInt(_0x3ee113(0x1e6))/0x7+-parseInt(_0x3ee113(0x1d0))/0x8*(-parseInt(_0x3ee113(0x1d3))/0x9);if(_0x14d9be===_0x43ec55)break;else _0x7206cc['push'](_0x7206cc['shift']());}catch(_0x12b344){_0x7206cc['push'](_0x7206cc['shift']());}}}(a568_0x5b8f,0xea459));var __importDefault=this&&this[a568_0x17e87e(0x1ee)]||function(_0x3cd2ff){const _0x35aa19=a568_0x17e87e;return _0x3cd2ff&&_0x3cd2ff[_0x35aa19(0x1d9)]?_0x3cd2ff:{'default':_0x3cd2ff};};Object[a568_0x17e87e(0x1e0)](exports,a568_0x17e87e(0x1d9),{'value':!![]}),exports[a568_0x17e87e(0x1c8)]=void 0x0;function a568_0xbc16(_0x2153b6,_0x23646d){const _0x5b8f21=a568_0x5b8f();return a568_0xbc16=function(_0xbc1603,_0x3aafff){_0xbc1603=_0xbc1603-0x1c5;let _0x410bfd=_0x5b8f21[_0xbc1603];return _0x410bfd;},a568_0xbc16(_0x2153b6,_0x23646d);}const sequelize_1=require(a568_0x17e87e(0x1d4)),Ticket_1=__importDefault(require(a568_0x17e87e(0x1ed))),Whatsapp_1=__importDefault(require(a568_0x17e87e(0x1dd))),socket_1=require(a568_0x17e87e(0x1e5)),Mustache_1=__importDefault(require(a568_0x17e87e(0x1eb))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require('moment')),ShowTicketService_1=__importDefault(require(a568_0x17e87e(0x1c9))),wbotMessageListener_1=require(a568_0x17e87e(0x1e2)),TicketTraking_1=__importDefault(require(a568_0x17e87e(0x1db))),CreateLogTicketService_1=__importDefault(require(a568_0x17e87e(0x1d5))),ClosedAllOpenTickets=async _0x25614c=>{const _0x5f4d95=a568_0x17e87e,_0x29357d=async(_0x2de621,_0x1d94d9,_0xfaa915)=>{const _0x22dfe5=a568_0xbc16;if(_0x1d94d9===_0x22dfe5(0x1e9))await _0x2de621['update']({'status':'closed','lastMessage':_0xfaa915,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x1d94d9==='open'?await _0x2de621[_0x22dfe5(0x1ea)]({'status':'closed','lastMessage':_0xfaa915,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x2de621[_0x22dfe5(0x1ea)]({'status':_0x22dfe5(0x1c7),'unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0x22dfe5(0x1df)])({'userId':_0x2de621[_0x22dfe5(0x1da)]||null,'queueId':_0x2de621[_0x22dfe5(0x1f3)]||null,'ticketId':_0x2de621['id'],'type':'autoClose'});},_0x281701=(0x0,socket_1[_0x5f4d95(0x1cc)])();try{const {rows:_0x38d6b9}=await Ticket_1[_0x5f4d95(0x1df)][_0x5f4d95(0x1e3)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x5f4d95(0x1e1),_0x5f4d95(0x1e9)]},'companyId':_0x25614c},'order':[['updatedAt','DESC']]});_0x38d6b9[_0x5f4d95(0x1de)](async _0xc4811=>{const _0x4abec5=_0x5f4d95,_0x3fa261=await(0x0,ShowTicketService_1['default'])(_0xc4811['id'],_0x25614c),_0x30ea03=await Whatsapp_1[_0x4abec5(0x1df)]['findByPk'](_0x3fa261?.[_0x4abec5(0x1cd)]),_0x622b00=await TicketTraking_1[_0x4abec5(0x1df)]['findOne']({'where':{'ticketId':_0xc4811['id'],'finishedAt':null}});if(!_0x30ea03)return;let {timeInactiveMessage:_0xe9d0d,expiresInactiveMessage:_0x18da30,inactiveMessage:_0x1d96e9,expiresTicket:_0x2a4e3b,expiresTicketNPS:_0x207993,whenExpiresTicket:_0x1bc9b9,complationMessage:_0x649e9}=_0x30ea03;if(_0x207993&&_0x207993!==''&&_0x207993!=='0'&&Number(_0x207993)>0x0){const _0x2a7e1f=new Date();_0x2a7e1f[_0x4abec5(0x1d7)](_0x2a7e1f['getMinutes']()-Number(_0x207993));if(_0xc4811['status']===_0x4abec5(0x1e9)){const _0x5533b5=new Date(_0x3fa261['updatedAt']);if(_0x5533b5<_0x2a7e1f){_0x29357d(_0x3fa261,_0x3fa261['status'],'');const _0x129bd3=(0x0,Mustache_1['default'])('‎'+_0x649e9,_0x3fa261);if(_0x649e9!==''&&_0x649e9!==undefined){const _0x207925=await(0x0,SendWhatsAppMessage_1[_0x4abec5(0x1df)])({'body':_0x129bd3,'ticket':_0x3fa261});await(0x0,wbotMessageListener_1[_0x4abec5(0x1ef)])(_0x207925,_0x3fa261,_0x3fa261['contact']);}await _0x622b00['update']({'finishedAt':(0x0,moment_1[_0x4abec5(0x1df)])()['toDate'](),'closedAt':(0x0,moment_1[_0x4abec5(0x1df)])()['toDate'](),'whatsappId':_0xc4811[_0x4abec5(0x1cd)],'userId':_0xc4811[_0x4abec5(0x1da)]}),_0x281701['to'](_0x4abec5(0x1e1))[_0x4abec5(0x1ca)](_0x4abec5(0x1e7)+_0x25614c+_0x4abec5(0x1d8),{'action':'delete','ticket':_0x3fa261,'ticketId':_0x3fa261['id']});}}}if(_0x2a4e3b&&_0x2a4e3b!==''&&_0x2a4e3b!=='0'&&Number(_0x2a4e3b)>0x0){const _0x128fd7=(0x0,Mustache_1[_0x4abec5(0x1df)])('‎'+_0x18da30,_0x3fa261),_0x1dc9f1=new Date();_0x1dc9f1['setHours'](_0x1dc9f1[_0x4abec5(0x1f2)]()-Number(_0x2a4e3b));_0xe9d0d&&_0xe9d0d!==''&&_0xe9d0d!==null&&_0xe9d0d!=='0'&&Number(_0xe9d0d)>0x0&&_0x1dc9f1[_0x4abec5(0x1d7)](_0x1dc9f1[_0x4abec5(0x1e4)]()-Number(_0xe9d0d));if(_0x3fa261[_0x4abec5(0x1c5)]===_0x4abec5(0x1e1)&&!_0x3fa261[_0x4abec5(0x1cf)]){const _0x2e991f=new Date(_0x3fa261['updatedAt']);if(_0x2e991f<_0x1dc9f1&&(_0x1bc9b9==='0'||_0x1bc9b9==='1'&&_0x3fa261[_0x4abec5(0x1dc)])){_0x29357d(_0x3fa261,_0x3fa261['status'],_0x128fd7);if(_0x18da30!==''&&_0x18da30!==undefined){const _0x5edbea=await(0x0,SendWhatsAppMessage_1[_0x4abec5(0x1df)])({'body':_0x128fd7,'ticket':_0x3fa261});await(0x0,wbotMessageListener_1[_0x4abec5(0x1ef)])(_0x5edbea,_0x3fa261,_0x3fa261['contact']);}await _0x622b00[_0x4abec5(0x1ea)]({'finishedAt':(0x0,moment_1[_0x4abec5(0x1df)])()[_0x4abec5(0x1d2)](),'closedAt':(0x0,moment_1[_0x4abec5(0x1df)])()['toDate'](),'whatsappId':_0xc4811[_0x4abec5(0x1cd)],'userId':_0xc4811[_0x4abec5(0x1da)]}),_0x281701['to'](_0x4abec5(0x1e1))[_0x4abec5(0x1ca)]('company-'+_0x25614c+_0x4abec5(0x1d8),{'action':_0x4abec5(0x1cb),'ticket':_0x3fa261,'ticketId':_0x3fa261['id']});}}}if(_0xe9d0d&&_0xe9d0d!==''&&_0xe9d0d!=='0'&&Number(_0xe9d0d)>0x0){const _0x5edcdc=(0x0,Mustache_1['default'])('‎'+_0x1d96e9,_0x3fa261),_0x2bead3=new Date();_0x2bead3[_0x4abec5(0x1d7)](_0x2bead3['getMinutes']()-Number(_0xe9d0d));if(_0x3fa261[_0x4abec5(0x1c5)]===_0x4abec5(0x1e1)&&!_0x3fa261['isGroup']){const _0x3bc848=new Date(_0x3fa261[_0x4abec5(0x1f4)]);if(_0x3bc848<_0x2bead3&&!_0x3fa261['sendInactiveMessage']&&(_0x1bc9b9==='0'||_0x1bc9b9==='1'&&_0x3fa261[_0x4abec5(0x1dc)])){const _0xb23c1b=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x5edcdc,'ticket':_0x3fa261});await(0x0,wbotMessageListener_1[_0x4abec5(0x1ef)])(_0xb23c1b,_0x3fa261,_0x3fa261[_0x4abec5(0x1e8)]),await _0x3fa261[_0x4abec5(0x1ea)]({'sendInactiveMessage':!![]}),_0x281701['to'](_0x4abec5(0x1e1))['emit']('company-'+_0x25614c+'-ticket',{'action':_0x4abec5(0x1cb),'ticket':_0x3fa261,'ticketId':_0x3fa261['id']});}}}});}catch(_0x32066a){console[_0x5f4d95(0x1c6)]('e',_0x32066a);}};function a568_0x5b8f(){const _0x491abd=['__esModule','userId','../../models/TicketTraking','fromMe','../../models/Whatsapp','forEach','default','defineProperty','open','./wbotMessageListener','findAndCountAll','getMinutes','../../libs/socket','6088992xcHnwW','company-','contact','nps','update','../../helpers/Mustache','2uImODc','../../models/Ticket','__importDefault','verifyMessage','2570901wDAsUm','2884855kGZENK','getHours','queueId','updatedAt','status','log','closed','ClosedAllOpenTickets','../TicketServices/ShowTicketService','emit','delete','getIO','whatsappId','4389244dBWPek','isGroup','24oDkDkf','985652HsioCA','toDate','13003794NtFagc','sequelize','../TicketServices/CreateLogTicketService','6070416PpiKKq','setMinutes','-ticket'];a568_0x5b8f=function(){return _0x491abd;};return a568_0x5b8f();}exports[a568_0x17e87e(0x1c8)]=ClosedAllOpenTickets;