'use strict';const a614_0x25191b=a614_0x53ae;(function(_0x3f13a4,_0x1379b5){const _0x3a4bd9=a614_0x53ae,_0x4903e2=_0x3f13a4();while(!![]){try{const _0x3db41e=-parseInt(_0x3a4bd9(0x1aa))/0x1*(-parseInt(_0x3a4bd9(0x1b3))/0x2)+-parseInt(_0x3a4bd9(0x1b7))/0x3*(-parseInt(_0x3a4bd9(0x1ac))/0x4)+parseInt(_0x3a4bd9(0x1a7))/0x5*(parseInt(_0x3a4bd9(0x1a1))/0x6)+-parseInt(_0x3a4bd9(0x1a4))/0x7+parseInt(_0x3a4bd9(0x1ba))/0x8+parseInt(_0x3a4bd9(0x1c1))/0x9*(-parseInt(_0x3a4bd9(0x1a2))/0xa)+-parseInt(_0x3a4bd9(0x1b6))/0xb*(parseInt(_0x3a4bd9(0x1b1))/0xc);if(_0x3db41e===_0x1379b5)break;else _0x4903e2['push'](_0x4903e2['shift']());}catch(_0x44d658){_0x4903e2['push'](_0x4903e2['shift']());}}}(a614_0x5e4e,0xc49b0));function a614_0x5e4e(){const _0x233d00=['userId','2uMWlIK','nps','default','8173PCwhIS','1913919dpQMCo','delete','findOne','10233560QYMuul','../TicketServices/ShowTicketService','sendInactiveMessage','log','emit','contact','fromMe','9WMVSJJ','DESC','./wbotMessageListener','whatsappId','../../models/Whatsapp','moment','company-','setMinutes','status','__esModule','getIO','../../models/Ticket','updatedAt','queueId','verifyMessage','toDate','30SaLwLI','14060260MLDehM','./SendWhatsAppMessage','8201326ZXDUET','ClosedAllOpenTickets','isGroup','1080325nzkEPi','closed','getMinutes','293579PQBeQW','open','8pdyuIe','-ticket','update','../../models/TicketTraking','sequelize','8820QPFZfD'];a614_0x5e4e=function(){return _0x233d00;};return a614_0x5e4e();}var __importDefault=this&&this['__importDefault']||function(_0x29d223){const _0x6e7968=a614_0x53ae;return _0x29d223&&_0x29d223[_0x6e7968(0x19a)]?_0x29d223:{'default':_0x29d223};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a614_0x25191b(0x1a5)]=void 0x0;const sequelize_1=require(a614_0x25191b(0x1b0)),Ticket_1=__importDefault(require(a614_0x25191b(0x19c))),Whatsapp_1=__importDefault(require(a614_0x25191b(0x1c5))),socket_1=require('../../libs/socket'),Mustache_1=__importDefault(require('../../helpers/Mustache')),SendWhatsAppMessage_1=__importDefault(require(a614_0x25191b(0x1a3))),moment_1=__importDefault(require(a614_0x25191b(0x1c6))),ShowTicketService_1=__importDefault(require(a614_0x25191b(0x1bb))),wbotMessageListener_1=require(a614_0x25191b(0x1c3)),TicketTraking_1=__importDefault(require(a614_0x25191b(0x1af))),CreateLogTicketService_1=__importDefault(require('../TicketServices/CreateLogTicketService')),ClosedAllOpenTickets=async _0x2bb617=>{const _0x41fe4a=a614_0x25191b,_0x488427=async(_0x34e138,_0x11fcf2,_0x526f23)=>{const _0x47c1c5=a614_0x53ae;if(_0x11fcf2===_0x47c1c5(0x1b4))await _0x34e138['update']({'status':_0x47c1c5(0x1a8),'lastMessage':_0x526f23,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x11fcf2===_0x47c1c5(0x1ab)?await _0x34e138[_0x47c1c5(0x1ae)]({'status':_0x47c1c5(0x1a8),'lastMessage':_0x526f23,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x34e138[_0x47c1c5(0x1ae)]({'status':_0x47c1c5(0x1a8),'unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0x47c1c5(0x1b5)])({'userId':_0x34e138[_0x47c1c5(0x1b2)]||null,'queueId':_0x34e138[_0x47c1c5(0x19e)]||null,'ticketId':_0x34e138['id'],'type':'autoClose'});},_0x37efe4=(0x0,socket_1[_0x41fe4a(0x19b)])();try{const {rows:_0x102eb7}=await Ticket_1[_0x41fe4a(0x1b5)]['findAndCountAll']({'where':{'status':{[sequelize_1['Op']['in']]:[_0x41fe4a(0x1ab),_0x41fe4a(0x1b4)]},'companyId':_0x2bb617},'order':[[_0x41fe4a(0x19d),_0x41fe4a(0x1c2)]]});_0x102eb7['forEach'](async _0x4f4ae1=>{const _0x3302d0=_0x41fe4a,_0x3d5b7d=await(0x0,ShowTicketService_1['default'])(_0x4f4ae1['id'],_0x2bb617),_0x4f4f54=await Whatsapp_1[_0x3302d0(0x1b5)]['findByPk'](_0x3d5b7d?.[_0x3302d0(0x1c4)]),_0x21a61a=await TicketTraking_1[_0x3302d0(0x1b5)][_0x3302d0(0x1b9)]({'where':{'ticketId':_0x4f4ae1['id'],'finishedAt':null}});if(!_0x4f4f54)return;let {timeInactiveMessage:_0x2cb9cd,expiresInactiveMessage:_0x404e43,inactiveMessage:_0x2a72b5,expiresTicket:_0x284da4,expiresTicketNPS:_0x5540b6,whenExpiresTicket:_0x305fa8,complationMessage:_0x276956}=_0x4f4f54;if(_0x5540b6&&_0x5540b6!==''&&_0x5540b6!=='0'&&Number(_0x5540b6)>0x0){const _0x10b6b4=new Date();_0x10b6b4['setMinutes'](_0x10b6b4['getMinutes']()-Number(_0x5540b6));if(_0x4f4ae1[_0x3302d0(0x199)]===_0x3302d0(0x1b4)){const _0x2b808d=new Date(_0x3d5b7d[_0x3302d0(0x19d)]);if(_0x2b808d<_0x10b6b4){_0x488427(_0x3d5b7d,_0x3d5b7d['status'],'');const _0x2d9f5f=(0x0,Mustache_1[_0x3302d0(0x1b5)])('‎'+_0x276956,_0x3d5b7d);if(_0x276956!==''&&_0x276956!==undefined){const _0x2a3205=await(0x0,SendWhatsAppMessage_1[_0x3302d0(0x1b5)])({'body':_0x2d9f5f,'ticket':_0x3d5b7d});await(0x0,wbotMessageListener_1[_0x3302d0(0x19f)])(_0x2a3205,_0x3d5b7d,_0x3d5b7d['contact']);}await _0x21a61a['update']({'finishedAt':(0x0,moment_1[_0x3302d0(0x1b5)])()['toDate'](),'closedAt':(0x0,moment_1[_0x3302d0(0x1b5)])()[_0x3302d0(0x1a0)](),'whatsappId':_0x4f4ae1[_0x3302d0(0x1c4)],'userId':_0x4f4ae1[_0x3302d0(0x1b2)]}),_0x37efe4['to'](_0x3302d0(0x1ab))[_0x3302d0(0x1be)](_0x3302d0(0x197)+_0x2bb617+_0x3302d0(0x1ad),{'action':_0x3302d0(0x1b8),'ticketId':_0x3d5b7d['id']});}}}if(_0x284da4&&_0x284da4!==''&&_0x284da4!=='0'&&Number(_0x284da4)>0x0){const _0xc8ed39=(0x0,Mustache_1[_0x3302d0(0x1b5)])('‎'+_0x404e43,_0x3d5b7d),_0x53a06c=new Date();_0x53a06c[_0x3302d0(0x198)](_0x53a06c[_0x3302d0(0x1a9)]()-Number(_0x284da4));_0x2cb9cd&&_0x2cb9cd!==''&&_0x2cb9cd!==null&&_0x2cb9cd!=='0'&&Number(_0x2cb9cd)>0x0&&_0x53a06c[_0x3302d0(0x198)](_0x53a06c[_0x3302d0(0x1a9)]()-Number(_0x2cb9cd));if(_0x3d5b7d[_0x3302d0(0x199)]==='open'&&!_0x3d5b7d[_0x3302d0(0x1a6)]){const _0x1f2d63=new Date(_0x3d5b7d['updatedAt']);if(_0x1f2d63<_0x53a06c&&(_0x305fa8==='0'||_0x305fa8==='1'&&_0x3d5b7d[_0x3302d0(0x1c0)])){_0x488427(_0x3d5b7d,_0x3d5b7d['status'],_0xc8ed39);if(_0x404e43!==''&&_0x404e43!==undefined){const _0x54c62f=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0xc8ed39,'ticket':_0x3d5b7d});await(0x0,wbotMessageListener_1[_0x3302d0(0x19f)])(_0x54c62f,_0x3d5b7d,_0x3d5b7d[_0x3302d0(0x1bf)]);}await _0x21a61a[_0x3302d0(0x1ae)]({'finishedAt':(0x0,moment_1[_0x3302d0(0x1b5)])()['toDate'](),'closedAt':(0x0,moment_1['default'])()[_0x3302d0(0x1a0)](),'whatsappId':_0x4f4ae1[_0x3302d0(0x1c4)],'userId':_0x4f4ae1[_0x3302d0(0x1b2)]}),_0x37efe4['to'](_0x3302d0(0x1ab))[_0x3302d0(0x1be)]('company-'+_0x2bb617+_0x3302d0(0x1ad),{'action':'delete','ticketId':_0x3d5b7d['id']});}}}if(_0x2cb9cd&&_0x2cb9cd!==''&&_0x2cb9cd!=='0'&&Number(_0x2cb9cd)>0x0){const _0x355080=(0x0,Mustache_1[_0x3302d0(0x1b5)])('‎'+_0x2a72b5,_0x3d5b7d),_0x27d2f4=new Date();_0x27d2f4[_0x3302d0(0x198)](_0x27d2f4[_0x3302d0(0x1a9)]()-Number(_0x2cb9cd));if(_0x3d5b7d[_0x3302d0(0x199)]===_0x3302d0(0x1ab)&&!_0x3d5b7d['isGroup']){const _0x491062=new Date(_0x3d5b7d[_0x3302d0(0x19d)]);if(_0x491062<_0x27d2f4&&!_0x3d5b7d[_0x3302d0(0x1bc)]&&(_0x305fa8==='0'||_0x305fa8==='1'&&_0x3d5b7d[_0x3302d0(0x1c0)])){const _0x195444=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x355080,'ticket':_0x3d5b7d});await(0x0,wbotMessageListener_1[_0x3302d0(0x19f)])(_0x195444,_0x3d5b7d,_0x3d5b7d['contact']),await _0x3d5b7d['update']({'sendInactiveMessage':!![]}),_0x37efe4['to'](_0x3302d0(0x1ab))[_0x3302d0(0x1be)]('company-'+_0x2bb617+'-ticket',{'action':_0x3302d0(0x1b8),'ticket':_0x3d5b7d,'ticketId':_0x3d5b7d['id']});}}}});}catch(_0xf5ea70){console[_0x41fe4a(0x1bd)]('e',_0xf5ea70);}};function a614_0x53ae(_0x5ebe08,_0x22df9a){const _0x5e4e51=a614_0x5e4e();return a614_0x53ae=function(_0x53ae54,_0x1a5b5d){_0x53ae54=_0x53ae54-0x197;let _0xeca7fe=_0x5e4e51[_0x53ae54];return _0xeca7fe;},a614_0x53ae(_0x5ebe08,_0x22df9a);}exports[a614_0x25191b(0x1a5)]=ClosedAllOpenTickets;