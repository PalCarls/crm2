'use strict';const a551_0x412267=a551_0x3e26;(function(_0x5b6c2b,_0x480542){const _0x4f7e42=a551_0x3e26,_0x200dfb=_0x5b6c2b();while(!![]){try{const _0x594658=-parseInt(_0x4f7e42(0x8c))/0x1*(-parseInt(_0x4f7e42(0xa6))/0x2)+parseInt(_0x4f7e42(0xa5))/0x3+parseInt(_0x4f7e42(0x81))/0x4*(-parseInt(_0x4f7e42(0xa2))/0x5)+-parseInt(_0x4f7e42(0x7e))/0x6*(-parseInt(_0x4f7e42(0x82))/0x7)+parseInt(_0x4f7e42(0x8b))/0x8+parseInt(_0x4f7e42(0x84))/0x9*(parseInt(_0x4f7e42(0xaa))/0xa)+-parseInt(_0x4f7e42(0x97))/0xb;if(_0x594658===_0x480542)break;else _0x200dfb['push'](_0x200dfb['shift']());}catch(_0x5a975d){_0x200dfb['push'](_0x200dfb['shift']());}}}(a551_0xd4e3,0x90980));var __importDefault=this&&this['__importDefault']||function(_0xdc67a5){const _0xffeb2a=a551_0x3e26;return _0xdc67a5&&_0xdc67a5[_0xffeb2a(0xa9)]?_0xdc67a5:{'default':_0xdc67a5};};Object['defineProperty'](exports,a551_0x412267(0xa9),{'value':!![]}),exports[a551_0x412267(0x95)]=void 0x0;const sequelize_1=require(a551_0x412267(0xa0)),Ticket_1=__importDefault(require(a551_0x412267(0x8e))),Whatsapp_1=__importDefault(require(a551_0x412267(0x99))),socket_1=require('../../libs/socket'),Mustache_1=__importDefault(require(a551_0x412267(0xa7))),SendWhatsAppMessage_1=__importDefault(require(a551_0x412267(0x90))),moment_1=__importDefault(require(a551_0x412267(0xa8))),ShowTicketService_1=__importDefault(require('../TicketServices/ShowTicketService')),wbotMessageListener_1=require('./wbotMessageListener'),TicketTraking_1=__importDefault(require('../../models/TicketTraking')),ClosedAllOpenTickets=async _0x14304a=>{const _0x4905f9=a551_0x412267,_0x1911ab=async(_0x42c14d,_0x381f69,_0xf8d2e1)=>{const _0x3d8db6=a551_0x3e26;if(_0x381f69===_0x3d8db6(0x96))await _0x42c14d[_0x3d8db6(0x8a)]({'status':'closed','lastMessage':_0xf8d2e1,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x381f69===_0x3d8db6(0x98)?await _0x42c14d[_0x3d8db6(0x8a)]({'status':_0x3d8db6(0x94),'lastMessage':_0xf8d2e1,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x42c14d[_0x3d8db6(0x8a)]({'status':_0x3d8db6(0x94),'unreadMessages':0x0});},_0x14a8ce=(0x0,socket_1[_0x4905f9(0x86)])();try{const {rows:_0x5195b0}=await Ticket_1[_0x4905f9(0x85)][_0x4905f9(0x92)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x4905f9(0x98),_0x4905f9(0x96)]},'companyId':_0x14304a},'order':[[_0x4905f9(0xa3),_0x4905f9(0x9e)]]});_0x5195b0['forEach'](async _0x4bdb3a=>{const _0x33c6b2=_0x4905f9,_0x24039a=await(0x0,ShowTicketService_1[_0x33c6b2(0x85)])(_0x4bdb3a['id'],_0x14304a),_0xa5faad=await Whatsapp_1[_0x33c6b2(0x85)]['findByPk'](_0x24039a?.[_0x33c6b2(0xa4)]),_0x5281cb=await TicketTraking_1[_0x33c6b2(0x85)][_0x33c6b2(0x88)]({'where':{'ticketId':_0x4bdb3a['id'],'finishedAt':null}});if(!_0xa5faad)return;let {timeInactiveMessage:_0x406aad,expiresInactiveMessage:_0x4006de,inactiveMessage:_0x52e146,expiresTicket:_0x2cae07,expiresTicketNPS:_0x2f96ff,whenExpiresTicket:_0x359f07,complationMessage:_0x1ef960}=_0xa5faad;if(_0x2f96ff&&_0x2f96ff!==''&&_0x2f96ff!=='0'&&Number(_0x2f96ff)>0x0){const _0x5f5979=new Date();_0x5f5979[_0x33c6b2(0x8f)](_0x5f5979['getMinutes']()-Number(_0x2f96ff));if(_0x4bdb3a[_0x33c6b2(0x9f)]==='nps'){const _0x108bac=new Date(_0x24039a['updatedAt']);if(_0x108bac<_0x5f5979){_0x1911ab(_0x24039a,_0x24039a[_0x33c6b2(0x9f)],'');const _0x9533f9=(0x0,Mustache_1[_0x33c6b2(0x85)])('‎'+_0x1ef960,_0x24039a);if(_0x1ef960!==''&&_0x1ef960!==undefined){const _0x30c011=await(0x0,SendWhatsAppMessage_1[_0x33c6b2(0x85)])({'body':_0x9533f9,'ticket':_0x24039a});await(0x0,wbotMessageListener_1[_0x33c6b2(0x9d)])(_0x30c011,_0x24039a,_0x24039a[_0x33c6b2(0x80)]);}await _0x5281cb[_0x33c6b2(0x8a)]({'finishedAt':(0x0,moment_1[_0x33c6b2(0x85)])()['toDate'](),'closedAt':(0x0,moment_1['default'])()[_0x33c6b2(0x7d)](),'whatsappId':_0x4bdb3a[_0x33c6b2(0xa4)],'userId':_0x4bdb3a['userId']}),_0x14a8ce['to'](_0x33c6b2(0x98))[_0x33c6b2(0x9a)]('company'+_0x14304a+'-ticket',{'action':'delete','ticket':_0x24039a,'ticketId':_0x24039a['id']});}}}if(_0x2cae07&&_0x2cae07!==''&&_0x2cae07!=='0'&&Number(_0x2cae07)>0x0){const _0x23c295=(0x0,Mustache_1[_0x33c6b2(0x85)])('‎'+_0x4006de,_0x24039a),_0x580a6d=new Date();_0x580a6d[_0x33c6b2(0xa1)](_0x580a6d[_0x33c6b2(0x8d)]()-Number(_0x2cae07));_0x406aad&&_0x406aad!==''&&_0x406aad!==null&&_0x406aad!=='0'&&Number(_0x406aad)>0x0&&_0x580a6d[_0x33c6b2(0x8f)](_0x580a6d['getMinutes']()-Number(_0x406aad));if(_0x24039a[_0x33c6b2(0x9f)]===_0x33c6b2(0x98)&&!_0x24039a[_0x33c6b2(0x93)]){const _0x2f358c=new Date(_0x24039a['updatedAt']);if(_0x2f358c<_0x580a6d&&(_0x359f07==='0'||_0x359f07==='1'&&_0x24039a[_0x33c6b2(0x9b)])){_0x1911ab(_0x24039a,_0x24039a[_0x33c6b2(0x9f)],_0x23c295);if(_0x4006de!==''&&_0x4006de!==undefined){const _0x5ddca2=await(0x0,SendWhatsAppMessage_1[_0x33c6b2(0x85)])({'body':_0x23c295,'ticket':_0x24039a});await(0x0,wbotMessageListener_1[_0x33c6b2(0x9d)])(_0x5ddca2,_0x24039a,_0x24039a[_0x33c6b2(0x80)]);}await _0x5281cb[_0x33c6b2(0x8a)]({'finishedAt':(0x0,moment_1['default'])()[_0x33c6b2(0x7d)](),'closedAt':(0x0,moment_1[_0x33c6b2(0x85)])()[_0x33c6b2(0x7d)](),'whatsappId':_0x4bdb3a[_0x33c6b2(0xa4)],'userId':_0x4bdb3a[_0x33c6b2(0x9c)]}),_0x14a8ce['to'](_0x33c6b2(0x98))[_0x33c6b2(0x9a)](_0x33c6b2(0x89)+_0x14304a+_0x33c6b2(0x87),{'action':_0x33c6b2(0x7f),'ticket':_0x24039a,'ticketId':_0x24039a['id']});}}}if(_0x406aad&&_0x406aad!==''&&_0x406aad!=='0'&&Number(_0x406aad)>0x0){const _0x59793c=(0x0,Mustache_1['default'])('‎'+_0x52e146,_0x24039a),_0x214c90=new Date();_0x214c90[_0x33c6b2(0x8f)](_0x214c90[_0x33c6b2(0x83)]()-Number(_0x406aad));if(_0x24039a[_0x33c6b2(0x9f)]===_0x33c6b2(0x98)&&!_0x24039a[_0x33c6b2(0x93)]){const _0x392590=new Date(_0x24039a['updatedAt']);if(_0x392590<_0x214c90&&!_0x24039a['sendInactiveMessage']&&(_0x359f07==='0'||_0x359f07==='1'&&_0x24039a[_0x33c6b2(0x9b)])){const _0x54b97d=await(0x0,SendWhatsAppMessage_1[_0x33c6b2(0x85)])({'body':_0x59793c,'ticket':_0x24039a});await(0x0,wbotMessageListener_1[_0x33c6b2(0x9d)])(_0x54b97d,_0x24039a,_0x24039a['contact']),await _0x24039a[_0x33c6b2(0x8a)]({'sendInactiveMessage':!![]}),_0x14a8ce['to'](_0x33c6b2(0x98))[_0x33c6b2(0x9a)](_0x33c6b2(0x89)+_0x14304a+_0x33c6b2(0x87),{'action':_0x33c6b2(0x7f),'ticket':_0x24039a,'ticketId':_0x24039a['id']});}}}});}catch(_0x32fabe){console[_0x4905f9(0x91)]('e',_0x32fabe);}};function a551_0x3e26(_0x203363,_0x3610){const _0xd4e35b=a551_0xd4e3();return a551_0x3e26=function(_0x3e2620,_0x4cc9cb){_0x3e2620=_0x3e2620-0x7d;let _0x3a6cf8=_0xd4e35b[_0x3e2620];return _0x3a6cf8;},a551_0x3e26(_0x203363,_0x3610);}function a551_0xd4e3(){const _0x32b4b7=['../../helpers/Mustache','moment','__esModule','11525610GNGAjr','toDate','6CkSGNw','delete','contact','68qJsxFA','2773001uZgegH','getMinutes','9tfiHjZ','default','getIO','-ticket','findOne','company','update','22744nqpaPD','1359KmkmeU','getHours','../../models/Ticket','setMinutes','./SendWhatsAppMessage','log','findAndCountAll','isGroup','closed','ClosedAllOpenTickets','nps','28993514cVOwCk','open','../../models/Whatsapp','emit','fromMe','userId','verifyMessage','DESC','status','sequelize','setHours','53875HYVccw','updatedAt','whatsappId','2508993pDlpjI','1506uEvKzZ'];a551_0xd4e3=function(){return _0x32b4b7;};return a551_0xd4e3();}exports[a551_0x412267(0x95)]=ClosedAllOpenTickets;