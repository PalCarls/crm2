'use strict';const a568_0x59fc2e=a568_0x2f63;function a568_0x2f63(_0x4be0db,_0x203c05){const _0x276cd8=a568_0x276c();return a568_0x2f63=function(_0x2f6353,_0x5641d1){_0x2f6353=_0x2f6353-0x170;let _0x195aef=_0x276cd8[_0x2f6353];return _0x195aef;},a568_0x2f63(_0x4be0db,_0x203c05);}(function(_0x422c17,_0x37f8e2){const _0x134f80=a568_0x2f63,_0x47e781=_0x422c17();while(!![]){try{const _0x2470d2=-parseInt(_0x134f80(0x195))/0x1*(-parseInt(_0x134f80(0x198))/0x2)+parseInt(_0x134f80(0x18c))/0x3+parseInt(_0x134f80(0x18f))/0x4*(-parseInt(_0x134f80(0x178))/0x5)+parseInt(_0x134f80(0x191))/0x6+-parseInt(_0x134f80(0x177))/0x7+-parseInt(_0x134f80(0x18a))/0x8*(-parseInt(_0x134f80(0x193))/0x9)+-parseInt(_0x134f80(0x17d))/0xa;if(_0x2470d2===_0x37f8e2)break;else _0x47e781['push'](_0x47e781['shift']());}catch(_0xdcfb91){_0x47e781['push'](_0x47e781['shift']());}}}(a568_0x276c,0xd43c2));function a568_0x276c(){const _0x19c373=['../TicketServices/CreateLogTicketService','-ticket','updatedAt','../TicketServices/ShowTicketService','verifyMessage','isGroup','emit','forEach','queueId','contact','ClosedAllOpenTickets','findByPk','2497320hghsSj','64045iszfgL','fromMe','../../models/Whatsapp','getIO','delete','3281500YkntkM','findOne','log','getHours','toDate','whatsappId','../../models/TicketTraking','update','getMinutes','defineProperty','closed','default','open','2984ViktvK','moment','2248800KkgTRO','../../helpers/Mustache','nps','356nsfwPR','./wbotMessageListener','6504060jgsDOG','autoClose','10539MryOXr','__importDefault','6836GuTYNH','setMinutes','__esModule','124rLuWjj','company-','findAndCountAll','userId','sendInactiveMessage','status'];a568_0x276c=function(){return _0x19c373;};return a568_0x276c();}var __importDefault=this&&this[a568_0x59fc2e(0x194)]||function(_0x3cbc60){const _0x5def2b=a568_0x59fc2e;return _0x3cbc60&&_0x3cbc60[_0x5def2b(0x197)]?_0x3cbc60:{'default':_0x3cbc60};};Object[a568_0x59fc2e(0x186)](exports,a568_0x59fc2e(0x197),{'value':!![]}),exports['ClosedAllOpenTickets']=void 0x0;const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require(a568_0x59fc2e(0x17a))),socket_1=require('../../libs/socket'),Mustache_1=__importDefault(require(a568_0x59fc2e(0x18d))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require(a568_0x59fc2e(0x18b))),ShowTicketService_1=__importDefault(require(a568_0x59fc2e(0x1a1))),wbotMessageListener_1=require(a568_0x59fc2e(0x190)),TicketTraking_1=__importDefault(require(a568_0x59fc2e(0x183))),CreateLogTicketService_1=__importDefault(require(a568_0x59fc2e(0x19e))),ClosedAllOpenTickets=async _0x1b8a1d=>{const _0x41bfae=a568_0x59fc2e,_0x26bfc8=async(_0x59f2f8,_0x3d3b5f,_0x17e8be)=>{const _0x29a838=a568_0x2f63;if(_0x3d3b5f===_0x29a838(0x18e))await _0x59f2f8[_0x29a838(0x184)]({'status':_0x29a838(0x187),'lastMessage':_0x17e8be,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x3d3b5f===_0x29a838(0x189)?await _0x59f2f8[_0x29a838(0x184)]({'status':_0x29a838(0x187),'lastMessage':_0x17e8be,'unreadMessages':0x0,'amountUseBotQueues':0x0}):await _0x59f2f8[_0x29a838(0x184)]({'status':_0x29a838(0x187),'unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0x29a838(0x188)])({'userId':_0x59f2f8[_0x29a838(0x19b)]||null,'queueId':_0x59f2f8[_0x29a838(0x173)]||null,'ticketId':_0x59f2f8['id'],'type':_0x29a838(0x192)});},_0x5a2dbb=(0x0,socket_1[_0x41bfae(0x17b)])();try{const {rows:_0x7dfc7d}=await Ticket_1[_0x41bfae(0x188)][_0x41bfae(0x19a)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x41bfae(0x189),_0x41bfae(0x18e)]},'companyId':_0x1b8a1d},'order':[['updatedAt','DESC']]});_0x7dfc7d[_0x41bfae(0x172)](async _0x47784e=>{const _0x5cb6af=_0x41bfae,_0x82398=await(0x0,ShowTicketService_1[_0x5cb6af(0x188)])(_0x47784e['id'],_0x1b8a1d),_0x156ee0=await Whatsapp_1[_0x5cb6af(0x188)][_0x5cb6af(0x176)](_0x82398?.[_0x5cb6af(0x182)]),_0x4078d3=await TicketTraking_1['default'][_0x5cb6af(0x17e)]({'where':{'ticketId':_0x47784e['id'],'finishedAt':null}});if(!_0x156ee0)return;let {timeInactiveMessage:_0x35edb1,expiresInactiveMessage:_0x247990,inactiveMessage:_0x230b77,expiresTicket:_0xf9a0ff,expiresTicketNPS:_0x3f3a06,whenExpiresTicket:_0x44cbb8,complationMessage:_0x3f68fa}=_0x156ee0;if(_0x3f3a06&&_0x3f3a06!==''&&_0x3f3a06!=='0'&&Number(_0x3f3a06)>0x0){const _0xca9961=new Date();_0xca9961[_0x5cb6af(0x196)](_0xca9961['getMinutes']()-Number(_0x3f3a06));if(_0x47784e[_0x5cb6af(0x19d)]===_0x5cb6af(0x18e)){const _0x5d7e18=new Date(_0x82398[_0x5cb6af(0x1a0)]);if(_0x5d7e18<_0xca9961){_0x26bfc8(_0x82398,_0x82398[_0x5cb6af(0x19d)],'');const _0x3763d=(0x0,Mustache_1['default'])('‎'+_0x3f68fa,_0x82398);if(_0x3f68fa!==''&&_0x3f68fa!==undefined){const _0x49b6ec=await(0x0,SendWhatsAppMessage_1[_0x5cb6af(0x188)])({'body':_0x3763d,'ticket':_0x82398});await(0x0,wbotMessageListener_1[_0x5cb6af(0x1a2)])(_0x49b6ec,_0x82398,_0x82398['contact']);}await _0x4078d3[_0x5cb6af(0x184)]({'finishedAt':(0x0,moment_1['default'])()[_0x5cb6af(0x181)](),'closedAt':(0x0,moment_1[_0x5cb6af(0x188)])()[_0x5cb6af(0x181)](),'whatsappId':_0x47784e[_0x5cb6af(0x182)],'userId':_0x47784e[_0x5cb6af(0x19b)]}),_0x5a2dbb['to'](_0x5cb6af(0x189))[_0x5cb6af(0x171)]('company-'+_0x1b8a1d+_0x5cb6af(0x19f),{'action':'delete','ticket':_0x82398,'ticketId':_0x82398['id']});}}}if(_0xf9a0ff&&_0xf9a0ff!==''&&_0xf9a0ff!=='0'&&Number(_0xf9a0ff)>0x0){const _0xe22f5d=(0x0,Mustache_1[_0x5cb6af(0x188)])('‎'+_0x247990,_0x82398),_0x3e5468=new Date();_0x3e5468['setHours'](_0x3e5468[_0x5cb6af(0x180)]()-Number(_0xf9a0ff));_0x35edb1&&_0x35edb1!==''&&_0x35edb1!==null&&_0x35edb1!=='0'&&Number(_0x35edb1)>0x0&&_0x3e5468['setMinutes'](_0x3e5468[_0x5cb6af(0x185)]()-Number(_0x35edb1));if(_0x82398['status']===_0x5cb6af(0x189)&&!_0x82398[_0x5cb6af(0x170)]){const _0x51bc03=new Date(_0x82398[_0x5cb6af(0x1a0)]);if(_0x51bc03<_0x3e5468&&(_0x44cbb8==='0'||_0x44cbb8==='1'&&_0x82398[_0x5cb6af(0x179)])){_0x26bfc8(_0x82398,_0x82398[_0x5cb6af(0x19d)],_0xe22f5d);if(_0x247990!==''&&_0x247990!==undefined){const _0x5f2e5a=await(0x0,SendWhatsAppMessage_1[_0x5cb6af(0x188)])({'body':_0xe22f5d,'ticket':_0x82398});await(0x0,wbotMessageListener_1[_0x5cb6af(0x1a2)])(_0x5f2e5a,_0x82398,_0x82398[_0x5cb6af(0x174)]);}await _0x4078d3[_0x5cb6af(0x184)]({'finishedAt':(0x0,moment_1[_0x5cb6af(0x188)])()[_0x5cb6af(0x181)](),'closedAt':(0x0,moment_1['default'])()['toDate'](),'whatsappId':_0x47784e[_0x5cb6af(0x182)],'userId':_0x47784e[_0x5cb6af(0x19b)]}),_0x5a2dbb['to'](_0x5cb6af(0x189))[_0x5cb6af(0x171)](_0x5cb6af(0x199)+_0x1b8a1d+_0x5cb6af(0x19f),{'action':_0x5cb6af(0x17c),'ticket':_0x82398,'ticketId':_0x82398['id']});}}}if(_0x35edb1&&_0x35edb1!==''&&_0x35edb1!=='0'&&Number(_0x35edb1)>0x0){const _0x5b7ed3=(0x0,Mustache_1[_0x5cb6af(0x188)])('‎'+_0x230b77,_0x82398),_0x1920af=new Date();_0x1920af[_0x5cb6af(0x196)](_0x1920af[_0x5cb6af(0x185)]()-Number(_0x35edb1));if(_0x82398[_0x5cb6af(0x19d)]===_0x5cb6af(0x189)&&!_0x82398[_0x5cb6af(0x170)]){const _0x15caaa=new Date(_0x82398[_0x5cb6af(0x1a0)]);if(_0x15caaa<_0x1920af&&!_0x82398[_0x5cb6af(0x19c)]&&(_0x44cbb8==='0'||_0x44cbb8==='1'&&_0x82398[_0x5cb6af(0x179)])){const _0x459fdd=await(0x0,SendWhatsAppMessage_1[_0x5cb6af(0x188)])({'body':_0x5b7ed3,'ticket':_0x82398});await(0x0,wbotMessageListener_1[_0x5cb6af(0x1a2)])(_0x459fdd,_0x82398,_0x82398[_0x5cb6af(0x174)]),await _0x82398[_0x5cb6af(0x184)]({'sendInactiveMessage':!![]}),_0x5a2dbb['to'](_0x5cb6af(0x189))[_0x5cb6af(0x171)](_0x5cb6af(0x199)+_0x1b8a1d+_0x5cb6af(0x19f),{'action':_0x5cb6af(0x17c),'ticket':_0x82398,'ticketId':_0x82398['id']});}}}});}catch(_0x3d1ec2){console[_0x41bfae(0x17f)]('e',_0x3d1ec2);}};exports[a568_0x59fc2e(0x175)]=ClosedAllOpenTickets;