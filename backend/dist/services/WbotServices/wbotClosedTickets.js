'use strict';const a634_0x212841=a634_0x366f;(function(_0x58f064,_0x28b823){const _0x3f7324=a634_0x366f,_0x5aa10e=_0x58f064();while(!![]){try{const _0x3e914e=-parseInt(_0x3f7324(0x101))/0x1*(parseInt(_0x3f7324(0xf7))/0x2)+parseInt(_0x3f7324(0xe3))/0x3+-parseInt(_0x3f7324(0xea))/0x4*(parseInt(_0x3f7324(0x107))/0x5)+parseInt(_0x3f7324(0xf3))/0x6+-parseInt(_0x3f7324(0xe6))/0x7*(parseInt(_0x3f7324(0x102))/0x8)+parseInt(_0x3f7324(0xe5))/0x9+parseInt(_0x3f7324(0xe2))/0xa*(-parseInt(_0x3f7324(0xe1))/0xb);if(_0x3e914e===_0x28b823)break;else _0x5aa10e['push'](_0x5aa10e['shift']());}catch(_0xc6c26c){_0x5aa10e['push'](_0x5aa10e['shift']());}}}(a634_0x2464,0x6a18b));function a634_0x366f(_0x1ed124,_0x3d4185){const _0x2464e8=a634_0x2464();return a634_0x366f=function(_0x366fed,_0x5c9c0d){_0x366fed=_0x366fed-0xd6;let _0x47fcc6=_0x2464e8[_0x366fed];return _0x47fcc6;},a634_0x366f(_0x1ed124,_0x3d4185);}function a634_0x2464(){const _0x5d7b60=['1582TkkCxY','../TicketServices/CreateLogTicketService','forEach','getIO','updatedAt','company-','../../libs/socket','sendInactiveMessage','emit','ClosedAllOpenTickets','239QUXSgx','1395144RFtjwo','fromMe','__importDefault','delete','autoClose','10yAnGkD','getMinutes','findOne','../TicketServices/ShowTicketService','nps','log','-ticket','status','default','verifyMessage','isGroup','closed','968NNsUSE','112910xMzXWe','1129716wHMpkx','../../helpers/Mustache','7093125gtJDbO','14PNppKl','whatsappId','./wbotMessageListener','queueId','107036yegFDs','findByPk','toDate','update','./SendWhatsAppMessage','open','__esModule','contact','../../models/Ticket','5129010aFwNUm','setMinutes','sequelize','userId'];a634_0x2464=function(){return _0x5d7b60;};return a634_0x2464();}var __importDefault=this&&this[a634_0x212841(0x104)]||function(_0x46a165){const _0x5088f1=a634_0x212841;return _0x46a165&&_0x46a165[_0x5088f1(0xf0)]?_0x46a165:{'default':_0x46a165};};Object['defineProperty'](exports,a634_0x212841(0xf0),{'value':!![]}),exports[a634_0x212841(0x100)]=void 0x0;const sequelize_1=require(a634_0x212841(0xf5)),Ticket_1=__importDefault(require(a634_0x212841(0xf2))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),socket_1=require(a634_0x212841(0xfd)),Mustache_1=__importDefault(require(a634_0x212841(0xe4))),SendWhatsAppMessage_1=__importDefault(require(a634_0x212841(0xee))),moment_1=__importDefault(require('moment')),ShowTicketService_1=__importDefault(require(a634_0x212841(0xd8))),wbotMessageListener_1=require(a634_0x212841(0xe8)),TicketTraking_1=__importDefault(require('../../models/TicketTraking')),CreateLogTicketService_1=__importDefault(require(a634_0x212841(0xf8))),ClosedAllOpenTickets=async _0xae7a17=>{const _0x370c34=a634_0x212841,_0x41854b=async(_0xeef3dd,_0x54d8bc,_0x540a2b)=>{const _0xd5b57f=a634_0x366f;if(_0x54d8bc===_0xd5b57f(0xd9))await _0xeef3dd[_0xd5b57f(0xed)]({'status':_0xd5b57f(0xe0),'lastMessage':_0x540a2b,'unreadMessages':0x0,'amountUsedBotQueues':0x0});else _0x54d8bc==='open'?await _0xeef3dd[_0xd5b57f(0xed)]({'status':_0xd5b57f(0xe0),'lastMessage':_0x540a2b,'unreadMessages':0x0,'amountUsedBotQueues':0x0}):await _0xeef3dd[_0xd5b57f(0xed)]({'status':_0xd5b57f(0xe0),'unreadMessages':0x0});await(0x0,CreateLogTicketService_1[_0xd5b57f(0xdd)])({'userId':_0xeef3dd[_0xd5b57f(0xf6)]||null,'queueId':_0xeef3dd[_0xd5b57f(0xe9)]||null,'ticketId':_0xeef3dd['id'],'type':_0xd5b57f(0x106)});},_0x58a647=(0x0,socket_1[_0x370c34(0xfa)])();try{const {rows:_0x35fbb3}=await Ticket_1[_0x370c34(0xdd)]['findAndCountAll']({'where':{'status':{[sequelize_1['Op']['in']]:[_0x370c34(0xef),_0x370c34(0xd9)]},'companyId':_0xae7a17},'order':[[_0x370c34(0xfb),'DESC']]});_0x35fbb3[_0x370c34(0xf9)](async _0x38363a=>{const _0x11a367=_0x370c34,_0xf8dd52=await(0x0,ShowTicketService_1[_0x11a367(0xdd)])(_0x38363a['id'],_0xae7a17),_0x5f58f2=await Whatsapp_1[_0x11a367(0xdd)][_0x11a367(0xeb)](_0xf8dd52?.[_0x11a367(0xe7)]),_0x1c88bf=await TicketTraking_1['default'][_0x11a367(0xd7)]({'where':{'ticketId':_0x38363a['id'],'finishedAt':null}});if(!_0x5f58f2)return;let {timeInactiveMessage:_0x1d8100,expiresInactiveMessage:_0x27d364,inactiveMessage:_0x11c7ab,expiresTicket:_0x5e4afe,expiresTicketNPS:_0x5a384d,whenExpiresTicket:_0x43fab5,complationMessage:_0x220cdd}=_0x5f58f2;if(_0x5a384d&&_0x5a384d!==''&&_0x5a384d!=='0'&&Number(_0x5a384d)>0x0){const _0x2498af=new Date();_0x2498af[_0x11a367(0xf4)](_0x2498af[_0x11a367(0xd6)]()-Number(_0x5a384d));if(_0x38363a[_0x11a367(0xdc)]===_0x11a367(0xd9)){const _0xd2ad3d=new Date(_0xf8dd52['updatedAt']);if(_0xd2ad3d<_0x2498af){_0x41854b(_0xf8dd52,_0xf8dd52[_0x11a367(0xdc)],'');const _0x1c8b56=(0x0,Mustache_1[_0x11a367(0xdd)])('‎'+_0x220cdd,_0xf8dd52);if(_0x220cdd!==''&&_0x220cdd!==undefined){const _0xe00a16=await(0x0,SendWhatsAppMessage_1[_0x11a367(0xdd)])({'body':_0x1c8b56,'ticket':_0xf8dd52});await(0x0,wbotMessageListener_1['verifyMessage'])(_0xe00a16,_0xf8dd52,_0xf8dd52[_0x11a367(0xf1)]);}await _0x1c88bf[_0x11a367(0xed)]({'finishedAt':(0x0,moment_1[_0x11a367(0xdd)])()[_0x11a367(0xec)](),'closedAt':(0x0,moment_1[_0x11a367(0xdd)])()['toDate'](),'whatsappId':_0x38363a[_0x11a367(0xe7)],'userId':_0x38363a[_0x11a367(0xf6)]}),_0x58a647['to'](_0x11a367(0xef))[_0x11a367(0xff)](_0x11a367(0xfc)+_0xae7a17+_0x11a367(0xdb),{'action':_0x11a367(0x105),'ticketId':_0xf8dd52['id']});}}}if(_0x5e4afe&&_0x5e4afe!==''&&_0x5e4afe!=='0'&&Number(_0x5e4afe)>0x0){const _0xd5147f=(0x0,Mustache_1['default'])('‎'+_0x27d364,_0xf8dd52),_0x59099b=new Date();_0x59099b['setMinutes'](_0x59099b[_0x11a367(0xd6)]()-Number(_0x5e4afe));_0x1d8100&&_0x1d8100!==''&&_0x1d8100!==null&&_0x1d8100!=='0'&&Number(_0x1d8100)>0x0&&_0x59099b['setMinutes'](_0x59099b[_0x11a367(0xd6)]()-Number(_0x1d8100));if(_0xf8dd52[_0x11a367(0xdc)]==='open'&&!_0xf8dd52['isGroup']){const _0x208c59=new Date(_0xf8dd52['updatedAt']);if(_0x208c59<_0x59099b&&(_0x43fab5==='0'||_0x43fab5==='1'&&_0xf8dd52[_0x11a367(0x103)])){_0x41854b(_0xf8dd52,_0xf8dd52[_0x11a367(0xdc)],_0xd5147f);if(_0x27d364!==''&&_0x27d364!==undefined){const _0x3ae2cc=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0xd5147f,'ticket':_0xf8dd52});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x3ae2cc,_0xf8dd52,_0xf8dd52[_0x11a367(0xf1)]);}await _0x1c88bf['update']({'finishedAt':(0x0,moment_1[_0x11a367(0xdd)])()[_0x11a367(0xec)](),'closedAt':(0x0,moment_1[_0x11a367(0xdd)])()[_0x11a367(0xec)](),'whatsappId':_0x38363a[_0x11a367(0xe7)],'userId':_0x38363a[_0x11a367(0xf6)]}),_0x58a647['to']('open')['emit'](_0x11a367(0xfc)+_0xae7a17+_0x11a367(0xdb),{'action':_0x11a367(0x105),'ticketId':_0xf8dd52['id']});}}}if(_0x1d8100&&_0x1d8100!==''&&_0x1d8100!=='0'&&Number(_0x1d8100)>0x0){const _0x5635b2=(0x0,Mustache_1[_0x11a367(0xdd)])('‎'+_0x11c7ab,_0xf8dd52),_0x4879d1=new Date();_0x4879d1[_0x11a367(0xf4)](_0x4879d1[_0x11a367(0xd6)]()-Number(_0x1d8100));if(_0xf8dd52[_0x11a367(0xdc)]===_0x11a367(0xef)&&!_0xf8dd52[_0x11a367(0xdf)]){const _0x3a4586=new Date(_0xf8dd52[_0x11a367(0xfb)]);if(_0x3a4586<_0x4879d1&&!_0xf8dd52[_0x11a367(0xfe)]&&(_0x43fab5==='0'||_0x43fab5==='1'&&_0xf8dd52[_0x11a367(0x103)])){const _0x30c65d=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x5635b2,'ticket':_0xf8dd52});await(0x0,wbotMessageListener_1[_0x11a367(0xde)])(_0x30c65d,_0xf8dd52,_0xf8dd52['contact']),await _0xf8dd52[_0x11a367(0xed)]({'sendInactiveMessage':!![]}),_0x58a647['to'](_0x11a367(0xef))[_0x11a367(0xff)]('company-'+_0xae7a17+_0x11a367(0xdb),{'action':_0x11a367(0x105),'ticket':_0xf8dd52,'ticketId':_0xf8dd52['id']});}}}});}catch(_0x44988d){console[_0x370c34(0xda)]('e',_0x44988d);}};exports[a634_0x212841(0x100)]=ClosedAllOpenTickets;