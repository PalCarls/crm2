'use strict';function a620_0xc2eb(){const _0x40e18b=['\x20\x0a\x20\x20\x20\x20','.txt','moment','companyId','low','default','has','length','../../libs/socket','1253254bkLXQW','../../helpers/addLogs','set','../../models/Whatsapp','handleMessage','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','processImportMessagesWppId','importMessages-','__esModule','refresh','update','closed','getTime','DD/MM/YY\x20HH:mm:ss','date-fns','sequelize','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','defineProperty','closeTicketsImported','push','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','26896903NHMndo','../../errors/AppError','renderButtonCloseTickets','sort','importOldMessages','../../models/Ticket','\x20de\x20','format','addLogs','ERR_NOT_MESSAGE_TO_IMPORT','dataMessages','27736eZJRED','closedTicketsPostImported','1470687LOqCgC','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','2611YnmNDT','__importDefault','emit','getIO','14130yMQtQY','17586TlBiFB','messageTimestamp','../../libs/wbot','520BmYAAB','DD/MM/YYYY\x20HH:mm:ss','5335782JpJrAd','whatsapps','../WbotServices/wbotMessageListener','importRecentMessages','getWbot','2rRSMqR','findByPk','\x0aMensagem\x20','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','6770wjOhKq'];a620_0xc2eb=function(){return _0x40e18b;};return a620_0xc2eb();}const a620_0x1819f=a620_0x11c9;(function(_0x33b1cd,_0x165747){const _0x4ab38b=a620_0x11c9,_0x341e7f=_0x33b1cd();while(!![]){try{const _0x39654c=parseInt(_0x4ab38b(0xc0))/0x1*(-parseInt(_0x4ab38b(0xb2))/0x2)+parseInt(_0x4ab38b(0xe2))/0x3+-parseInt(_0x4ab38b(0xec))/0x4*(-parseInt(_0x4ab38b(0xe8))/0x5)+parseInt(_0x4ab38b(0xad))/0x6+-parseInt(_0x4ab38b(0xe4))/0x7*(-parseInt(_0x4ab38b(0xe0))/0x8)+-parseInt(_0x4ab38b(0xe9))/0x9*(-parseInt(_0x4ab38b(0xb6))/0xa)+-parseInt(_0x4ab38b(0xd5))/0xb;if(_0x39654c===_0x165747)break;else _0x341e7f['push'](_0x341e7f['shift']());}catch(_0x4cfe2c){_0x341e7f['push'](_0x341e7f['shift']());}}}(a620_0xc2eb,0xa23d0));var __importDefault=this&&this[a620_0x1819f(0xe5)]||function(_0x44fddd){const _0x32f7a0=a620_0x1819f;return _0x44fddd&&_0x44fddd[_0x32f7a0(0xc8)]?_0x44fddd:{'default':_0x44fddd};};Object[a620_0x1819f(0xd1)](exports,a620_0x1819f(0xc8),{'value':!![]}),exports[a620_0x1819f(0xd2)]=void 0x0;const AppError_1=__importDefault(require(a620_0x1819f(0xd6))),Whatsapp_1=__importDefault(require(a620_0x1819f(0xc3))),socket_1=require(a620_0x1819f(0xbf)),Ticket_1=__importDefault(require(a620_0x1819f(0xda))),sequelize_1=require(a620_0x1819f(0xcf)),date_fns_1=require(a620_0x1819f(0xce)),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require(a620_0x1819f(0xeb)),wbotMessageListener_1=require(a620_0x1819f(0xaf)),moment_1=__importDefault(require(a620_0x1819f(0xb9))),addLogs_1=require(a620_0x1819f(0xc1)),closeTicketsImported=async _0x49b029=>{const _0x180d7e=a620_0x1819f,_0x2ee5ba=await Ticket_1['default']['findAll']({'where':{'status':'pending','whatsappId':_0x49b029,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1['add'])(new Date(),{'hours':+0x5})}}});for(const _0x185333 of _0x2ee5ba){await new Promise(_0x4eba4c=>setTimeout(_0x4eba4c,0x14a)),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x180d7e(0xcb)},'ticketId':_0x185333['id'],'companyId':_0x185333[_0x180d7e(0xba)]});}let _0x4b65ad=await Whatsapp_1[_0x180d7e(0xbc)][_0x180d7e(0xb3)](_0x49b029);_0x4b65ad[_0x180d7e(0xca)]({'statusImportMessages':null});const _0x5b0c13=(0x0,socket_1['getIO'])();_0x5b0c13['emit'](_0x180d7e(0xc7)+_0x4b65ad['companyId'],{'action':_0x180d7e(0xc9)});};exports[a620_0x1819f(0xd2)]=closeTicketsImported;function a620_0x11c9(_0x3bc3b1,_0x1beca0){const _0xc2eba3=a620_0xc2eb();return a620_0x11c9=function(_0x11c943,_0x4aa5ed){_0x11c943=_0x11c943-0xad;let _0x59209f=_0xc2eba3[_0x11c943];return _0x59209f;},a620_0x11c9(_0x3bc3b1,_0x1beca0);}function sortByMessageTimestamp(_0x187525,_0x3d64f9){const _0x1b5dc0=a620_0x1819f;return _0x3d64f9['messageTimestamp']-_0x187525[_0x1b5dc0(0xea)];}function cleaner(_0x3dade7){const _0x2cd0cc=a620_0x1819f,_0x27ef42=new Map(),_0x1eefd6=[];for(const _0xbd8e3 of _0x3dade7){const _0x1fca1f=_0xbd8e3['key']['id'];!_0x27ef42[_0x2cd0cc(0xbd)](_0x1fca1f)&&(_0x27ef42[_0x2cd0cc(0xc2)](_0x1fca1f,!![]),_0x1eefd6[_0x2cd0cc(0xd3)](_0xbd8e3));}return _0x1eefd6[_0x2cd0cc(0xd8)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x52b131=>{const _0x15bb55=a620_0x1819f;let _0x5a7533=await Whatsapp_1[_0x15bb55(0xbc)][_0x15bb55(0xb3)](_0x52b131);const _0x35f73b=(0x0,wbot_1[_0x15bb55(0xb1)])(_0x5a7533['id']);try{const _0x41cdb2=(0x0,socket_1[_0x15bb55(0xe7)])(),_0x37b0cd=cleaner(wbot_1['dataMessages'][_0x52b131]);let _0x4bc945=new Date(_0x5a7533[_0x15bb55(0xd9)])[_0x15bb55(0xcc)](),_0x54a23a=new Date(_0x5a7533[_0x15bb55(0xb0)])[_0x15bb55(0xcc)]();(0x0,addLogs_1[_0x15bb55(0xdd)])({'fileName':_0x15bb55(0xc6)+_0x52b131+_0x15bb55(0xb8),'forceNewFile':!![],'text':_0x15bb55(0xe3)+_0x5a7533['name']+_0x15bb55(0xb5)+_0x5a7533['id']+_0x15bb55(0xd4)+(0x0,moment_1[_0x15bb55(0xbc)])()[_0x15bb55(0xdc)](_0x15bb55(0xed))+_0x15bb55(0xd0)+(0x0,moment_1[_0x15bb55(0xbc)])(_0x4bc945)['format'](_0x15bb55(0xed))+_0x15bb55(0xc5)+(0x0,moment_1[_0x15bb55(0xbc)])(_0x54a23a)[_0x15bb55(0xdc)](_0x15bb55(0xed))+_0x15bb55(0xb7)});const _0x39945b=_0x37b0cd[_0x15bb55(0xbe)];let _0x1dcca6=0x0;while(_0x1dcca6<_0x39945b){try{const _0x1af465=_0x37b0cd[_0x1dcca6];(0x0,addLogs_1[_0x15bb55(0xdd)])({'fileName':_0x15bb55(0xc6)+_0x52b131+_0x15bb55(0xb8),'text':_0x15bb55(0xb4)+(_0x1dcca6+0x1)+_0x15bb55(0xdb)+_0x39945b+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'}),await(0x0,wbotMessageListener_1[_0x15bb55(0xc4)])(_0x1af465,_0x35f73b,_0x5a7533[_0x15bb55(0xba)],!![]);if(_0x1dcca6%0x2===0x0){const _0x53279f=Math['floor'](_0x1af465[_0x15bb55(0xea)][_0x15bb55(0xbb)]*0x3e8);_0x41cdb2['emit']('importMessages-'+_0x5a7533[_0x15bb55(0xba)],{'action':_0x15bb55(0xca),'status':{'this':_0x1dcca6+0x1,'all':_0x39945b,'date':(0x0,moment_1[_0x15bb55(0xbc)])(_0x53279f)[_0x15bb55(0xdc)](_0x15bb55(0xcd))}});}_0x1dcca6+0x1===_0x39945b&&(wbot_1[_0x15bb55(0xdf)][_0x52b131]=[],_0x5a7533['closedTicketsPostImported']&&await(0x0,exports[_0x15bb55(0xd2)])(_0x52b131),await _0x5a7533[_0x15bb55(0xca)]({'statusImportMessages':_0x5a7533[_0x15bb55(0xe1)]?null:_0x15bb55(0xd7),'importOldMessages':null,'importRecentMessages':null}),_0x41cdb2[_0x15bb55(0xe6)](_0x15bb55(0xc7)+_0x5a7533['companyId'],{'action':_0x15bb55(0xc9)}));}catch(_0x180244){}_0x1dcca6++;}}catch(_0x3ef553){throw new AppError_1[(_0x15bb55(0xbc))](_0x15bb55(0xde),0x193);}return _0x15bb55(0xae);};exports['default']=ImportWhatsAppMessageService;