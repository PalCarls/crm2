'use strict';const a558_0xb7ce4=a558_0x383e;(function(_0x530695,_0x15850c){const _0x1e9962=a558_0x383e,_0x22c586=_0x530695();while(!![]){try{const _0x189bb4=parseInt(_0x1e9962(0xab))/0x1+parseInt(_0x1e9962(0xb4))/0x2+parseInt(_0x1e9962(0xa5))/0x3+-parseInt(_0x1e9962(0xb7))/0x4+parseInt(_0x1e9962(0x90))/0x5*(-parseInt(_0x1e9962(0xb1))/0x6)+-parseInt(_0x1e9962(0x99))/0x7*(-parseInt(_0x1e9962(0x97))/0x8)+parseInt(_0x1e9962(0x9c))/0x9;if(_0x189bb4===_0x15850c)break;else _0x22c586['push'](_0x22c586['shift']());}catch(_0x40dc5e){_0x22c586['push'](_0x22c586['shift']());}}}(a558_0x3e19,0x2f79f));var __importDefault=this&&this[a558_0xb7ce4(0xb5)]||function(_0x273ff6){const _0x2bead2=a558_0xb7ce4;return _0x273ff6&&_0x273ff6[_0x2bead2(0xba)]?_0x273ff6:{'default':_0x273ff6};};function a558_0x3e19(){const _0x4aef09=['\x0aMensagem\x20','key','__esModule','renderButtonCloseTickets','closeTicketsImported','has','messageTimestamp','emit','closed','default','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','name','.txt','defineProperty','closedTicketsPostImported','addLogs','set','floor','low','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','../../models/Whatsapp','processImportMessagesWppId','7760CUWIkr','sort','getTime','push','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','../../helpers/addLogs','DD/MM/YY\x20HH:mm:ss','136yAqWGi','findAll','91819lQmpCC','getIO','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','747810AgxBSw','\x20\x0a\x20\x20\x20\x20','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','DD/MM/YYYY\x20HH:mm:ss','format','pending','importOldMessages','refresh','../../models/Ticket','68661oBkjUz','date-fns','add','../WbotServices/wbotMessageListener','handleMessage','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','133688YtTKit','findByPk','length','dataMessages','companyId','moment','612bgsBlz','update','../../errors/AppError','391736PhaFkr','__importDefault','whatsapps','1223020UgQYlM'];a558_0x3e19=function(){return _0x4aef09;};return a558_0x3e19();}Object[a558_0xb7ce4(0x87)](exports,a558_0xb7ce4(0xba),{'value':!![]}),exports['closeTicketsImported']=void 0x0;const AppError_1=__importDefault(require(a558_0xb7ce4(0xb3))),Whatsapp_1=__importDefault(require(a558_0xb7ce4(0x8e))),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(a558_0xb7ce4(0xa4))),sequelize_1=require('sequelize'),date_fns_1=require(a558_0xb7ce4(0xa6)),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require('../../libs/wbot'),wbotMessageListener_1=require(a558_0xb7ce4(0xa8)),moment_1=__importDefault(require(a558_0xb7ce4(0xb0))),addLogs_1=require(a558_0xb7ce4(0x95)),closeTicketsImported=async _0x46dbd0=>{const _0x369b19=a558_0xb7ce4,_0xc2a5c=await Ticket_1[_0x369b19(0x83)][_0x369b19(0x98)]({'where':{'status':_0x369b19(0xa1),'whatsappId':_0x46dbd0,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x369b19(0xa7)])(new Date(),{'hours':+0x5})}}});for(const _0x2f3c01 of _0xc2a5c){await new Promise(_0x26950f=>setTimeout(_0x26950f,0x14a)),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x369b19(0x82)},'ticketId':_0x2f3c01['id'],'companyId':_0x2f3c01['companyId']});}let _0x1620e0=await Whatsapp_1[_0x369b19(0x83)][_0x369b19(0xac)](_0x46dbd0);_0x1620e0['update']({'statusImportMessages':null});const _0x3cefd4=(0x0,socket_1[_0x369b19(0x9a)])();_0x3cefd4[_0x369b19(0xbf)]('importMessages-'+_0x1620e0[_0x369b19(0xaf)],{'action':_0x369b19(0xa3)});};exports['closeTicketsImported']=closeTicketsImported;function sortByMessageTimestamp(_0xdabf27,_0x4a3166){const _0x5f20f9=a558_0xb7ce4;return _0x4a3166[_0x5f20f9(0xbe)]-_0xdabf27[_0x5f20f9(0xbe)];}function a558_0x383e(_0x11ba84,_0x5bf19f){const _0x3e19cb=a558_0x3e19();return a558_0x383e=function(_0x383e21,_0x4de6b8){_0x383e21=_0x383e21-0x82;let _0x2681f3=_0x3e19cb[_0x383e21];return _0x2681f3;},a558_0x383e(_0x11ba84,_0x5bf19f);}function cleaner(_0x334106){const _0x274557=a558_0xb7ce4,_0x1ac47b=new Map(),_0x3a7f7c=[];for(const _0x2d6e99 of _0x334106){const _0x444f40=_0x2d6e99[_0x274557(0xb9)]['id'];!_0x1ac47b[_0x274557(0xbd)](_0x444f40)&&(_0x1ac47b[_0x274557(0x8a)](_0x444f40,!![]),_0x3a7f7c[_0x274557(0x93)](_0x2d6e99));}return _0x3a7f7c[_0x274557(0x91)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x172dac=>{const _0x44be68=a558_0xb7ce4;let _0x386f8a=await Whatsapp_1['default'][_0x44be68(0xac)](_0x172dac);const _0x6169c5=(0x0,wbot_1['getWbot'])(_0x386f8a['id']);try{const _0x271e34=(0x0,socket_1[_0x44be68(0x9a)])(),_0x5d6ccd=cleaner(wbot_1[_0x44be68(0xae)][_0x172dac]);let _0x478c56=new Date(_0x386f8a[_0x44be68(0xa2)])[_0x44be68(0x92)](),_0x143751=new Date(_0x386f8a['importRecentMessages'])[_0x44be68(0x92)]();(0x0,addLogs_1[_0x44be68(0x89)])({'fileName':_0x44be68(0x8f)+_0x172dac+_0x44be68(0x86),'forceNewFile':!![],'text':_0x44be68(0x8d)+_0x386f8a[_0x44be68(0x85)]+_0x44be68(0x94)+_0x386f8a['id']+_0x44be68(0x84)+(0x0,moment_1[_0x44be68(0x83)])()[_0x44be68(0xa0)]('DD/MM/YYYY\x20HH:mm:ss')+_0x44be68(0xaa)+(0x0,moment_1[_0x44be68(0x83)])(_0x478c56)[_0x44be68(0xa0)](_0x44be68(0x9f))+_0x44be68(0x9e)+(0x0,moment_1['default'])(_0x143751)[_0x44be68(0xa0)](_0x44be68(0x9f))+_0x44be68(0x9d)});const _0x472c53=_0x5d6ccd[_0x44be68(0xad)];let _0x5d68b5=0x0;while(_0x5d68b5<_0x472c53){try{const _0x5e9028=_0x5d6ccd[_0x5d68b5];(0x0,addLogs_1[_0x44be68(0x89)])({'fileName':_0x44be68(0x8f)+_0x172dac+_0x44be68(0x86),'text':_0x44be68(0xb8)+(_0x5d68b5+0x1)+'\x20de\x20'+_0x472c53+_0x44be68(0x9b)}),await(0x0,wbotMessageListener_1[_0x44be68(0xa9)])(_0x5e9028,_0x6169c5,_0x386f8a[_0x44be68(0xaf)],!![]);if(_0x5d68b5%0x2===0x0){const _0x136f55=Math[_0x44be68(0x8b)](_0x5e9028[_0x44be68(0xbe)][_0x44be68(0x8c)]*0x3e8);_0x271e34['emit']('importMessages-'+_0x386f8a[_0x44be68(0xaf)],{'action':_0x44be68(0xb2),'status':{'this':_0x5d68b5+0x1,'all':_0x472c53,'date':(0x0,moment_1[_0x44be68(0x83)])(_0x136f55)[_0x44be68(0xa0)](_0x44be68(0x96))}});}_0x5d68b5+0x1===_0x472c53&&(wbot_1[_0x44be68(0xae)][_0x172dac]=[],_0x386f8a[_0x44be68(0x88)]&&await(0x0,exports[_0x44be68(0xbc)])(_0x172dac),await _0x386f8a[_0x44be68(0xb2)]({'statusImportMessages':_0x386f8a['closedTicketsPostImported']?null:_0x44be68(0xbb),'importOldMessages':null,'importRecentMessages':null}),_0x271e34['emit']('importMessages-'+_0x386f8a['companyId'],{'action':_0x44be68(0xa3)}));}catch(_0x47c2aa){}_0x5d68b5++;}}catch(_0x45f2a6){throw new AppError_1[(_0x44be68(0x83))]('ERR_NOT_MESSAGE_TO_IMPORT',0x193);}return _0x44be68(0xb6);};exports[a558_0xb7ce4(0x83)]=ImportWhatsAppMessageService;