'use strict';const a557_0x4f9333=a557_0x1144;function a557_0x1144(_0x4c01f3,_0x38f082){const _0xf4bdbf=a557_0xf4bd();return a557_0x1144=function(_0x1144af,_0x212d3a){_0x1144af=_0x1144af-0x17d;let _0x338667=_0xf4bdbf[_0x1144af];return _0x338667;},a557_0x1144(_0x4c01f3,_0x38f082);}(function(_0x133a39,_0x568cc0){const _0x38f474=a557_0x1144,_0x22ddd4=_0x133a39();while(!![]){try{const _0x2165ab=parseInt(_0x38f474(0x1b1))/0x1*(parseInt(_0x38f474(0x1a0))/0x2)+-parseInt(_0x38f474(0x18f))/0x3*(-parseInt(_0x38f474(0x1b3))/0x4)+-parseInt(_0x38f474(0x1a6))/0x5*(-parseInt(_0x38f474(0x18d))/0x6)+-parseInt(_0x38f474(0x1ac))/0x7+-parseInt(_0x38f474(0x19f))/0x8*(parseInt(_0x38f474(0x187))/0x9)+parseInt(_0x38f474(0x1a5))/0xa*(-parseInt(_0x38f474(0x17d))/0xb)+parseInt(_0x38f474(0x193))/0xc;if(_0x2165ab===_0x568cc0)break;else _0x22ddd4['push'](_0x22ddd4['shift']());}catch(_0x247560){_0x22ddd4['push'](_0x22ddd4['shift']());}}}(a557_0xf4bd,0x7909e));var __importDefault=this&&this['__importDefault']||function(_0x2177c6){const _0x509b4f=a557_0x1144;return _0x2177c6&&_0x2177c6[_0x509b4f(0x188)]?_0x2177c6:{'default':_0x2177c6};};Object[a557_0x4f9333(0x182)](exports,a557_0x4f9333(0x188),{'value':!![]}),exports['closeTicketsImported']=void 0x0;const AppError_1=__importDefault(require(a557_0x4f9333(0x189))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),socket_1=require(a557_0x4f9333(0x1b4)),Ticket_1=__importDefault(require(a557_0x4f9333(0x183))),sequelize_1=require('sequelize'),date_fns_1=require('date-fns'),UpdateTicketService_1=__importDefault(require(a557_0x4f9333(0x1af))),wbot_1=require(a557_0x4f9333(0x17f)),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),moment_1=__importDefault(require(a557_0x4f9333(0x18e))),addLogs_1=require(a557_0x4f9333(0x1a2)),closeTicketsImported=async _0x4d355d=>{const _0xb9be31=a557_0x4f9333,_0x5cea87=await Ticket_1[_0xb9be31(0x1a9)]['findAll']({'where':{'status':_0xb9be31(0x1a4),'whatsappId':_0x4d355d,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0xb9be31(0x181)])(new Date(),{'hours':+0x5})}}});for(const _0x168a89 of _0x5cea87){await new Promise(_0x21169b=>setTimeout(_0x21169b,0x14a)),await(0x0,UpdateTicketService_1[_0xb9be31(0x1a9)])({'ticketData':{'status':_0xb9be31(0x18b)},'ticketId':_0x168a89['id'],'companyId':_0x168a89['companyId']});}let _0x3b7ab3=await Whatsapp_1[_0xb9be31(0x1a9)][_0xb9be31(0x191)](_0x4d355d);_0x3b7ab3['update']({'statusImportMessages':null});const _0x27cb6c=(0x0,socket_1[_0xb9be31(0x1ae)])();_0x27cb6c[_0xb9be31(0x1a1)](_0xb9be31(0x197)+_0x3b7ab3['companyId'],{'action':'refresh'});};exports[a557_0x4f9333(0x1b5)]=closeTicketsImported;function sortByMessageTimestamp(_0x5ac46b,_0x48b8b4){const _0x5c2e5f=a557_0x4f9333;return _0x48b8b4['messageTimestamp']-_0x5ac46b[_0x5c2e5f(0x195)];}function cleaner(_0x3d824e){const _0x3a1dba=a557_0x4f9333,_0x20d48b=new Map(),_0x2000bc=[];for(const _0x22849a of _0x3d824e){const _0x3879c1=_0x22849a['key']['id'];!_0x20d48b[_0x3a1dba(0x184)](_0x3879c1)&&(_0x20d48b['set'](_0x3879c1,!![]),_0x2000bc[_0x3a1dba(0x1a8)](_0x22849a));}return _0x2000bc['sort'](sortByMessageTimestamp);}function a557_0xf4bd(){const _0x3ebb91=['messageTimestamp','\x20de\x20','importMessages-','dataMessages','update','whatsapps','processImportMessagesWppId','DD/MM/YYYY\x20HH:mm:ss','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','companyId','4344EiDVzg','2poLqJb','emit','../../helpers/addLogs','floor','pending','20cKOeOj','430ZUykam','\x0aMensagem\x20','push','default','handleMessage','format','2586675fwpEXD','refresh','getIO','../TicketServices/UpdateTicketService','length','267753qwQRlP','renderButtonCloseTickets','192496HrYrgR','../../libs/socket','closeTicketsImported','ERR_NOT_MESSAGE_TO_IMPORT','1298297dWPkXV','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','../../libs/wbot','DD/MM/YY\x20HH:mm:ss','add','defineProperty','../../models/Ticket','has','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','\x20\x0a\x20\x20\x20\x20','16299LRXsxr','__esModule','../../errors/AppError','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','closed','getWbot','52464QPdQbE','moment','39DwmEif','addLogs','findByPk','.txt','5272524fyuvEl','closedTicketsPostImported'];a557_0xf4bd=function(){return _0x3ebb91;};return a557_0xf4bd();}const ImportWhatsAppMessageService=async _0x3fbfc4=>{const _0x54618e=a557_0x4f9333;let _0x4afef1=await Whatsapp_1[_0x54618e(0x1a9)]['findByPk'](_0x3fbfc4);const _0x4c6027=(0x0,wbot_1[_0x54618e(0x18c)])(_0x4afef1['id']);try{const _0xdc62d7=(0x0,socket_1[_0x54618e(0x1ae)])(),_0x544459=cleaner(wbot_1[_0x54618e(0x198)][_0x3fbfc4]);let _0xe17988=new Date(_0x4afef1['importOldMessages'])['getTime'](),_0x331bff=new Date(_0x4afef1['importRecentMessages'])['getTime']();(0x0,addLogs_1['addLogs'])({'fileName':_0x54618e(0x19b)+_0x3fbfc4+_0x54618e(0x192),'forceNewFile':!![],'text':_0x54618e(0x17e)+_0x4afef1['name']+_0x54618e(0x185)+_0x4afef1['id']+'\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20'+(0x0,moment_1[_0x54618e(0x1a9)])()[_0x54618e(0x1ab)](_0x54618e(0x19c))+_0x54618e(0x18a)+(0x0,moment_1[_0x54618e(0x1a9)])(_0xe17988)[_0x54618e(0x1ab)]('DD/MM/YYYY\x20HH:mm:ss')+'\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20'+(0x0,moment_1[_0x54618e(0x1a9)])(_0x331bff)[_0x54618e(0x1ab)](_0x54618e(0x19c))+_0x54618e(0x186)});const _0x53e58e=_0x544459[_0x54618e(0x1b0)];let _0x580d26=0x0;while(_0x580d26<_0x53e58e){try{const _0x5271d8=_0x544459[_0x580d26];(0x0,addLogs_1[_0x54618e(0x190)])({'fileName':_0x54618e(0x19b)+_0x3fbfc4+_0x54618e(0x192),'text':_0x54618e(0x1a7)+(_0x580d26+0x1)+_0x54618e(0x196)+_0x53e58e+_0x54618e(0x19d)}),await(0x0,wbotMessageListener_1[_0x54618e(0x1aa)])(_0x5271d8,_0x4c6027,_0x4afef1[_0x54618e(0x19e)],!![]);if(_0x580d26%0x2===0x0){const _0x108992=Math[_0x54618e(0x1a3)](_0x5271d8[_0x54618e(0x195)]['low']*0x3e8);_0xdc62d7[_0x54618e(0x1a1)](_0x54618e(0x197)+_0x4afef1[_0x54618e(0x19e)],{'action':_0x54618e(0x199),'status':{'this':_0x580d26+0x1,'all':_0x53e58e,'date':(0x0,moment_1[_0x54618e(0x1a9)])(_0x108992)[_0x54618e(0x1ab)](_0x54618e(0x180))}});}_0x580d26+0x1===_0x53e58e&&(wbot_1[_0x54618e(0x198)][_0x3fbfc4]=[],_0x4afef1[_0x54618e(0x194)]&&await(0x0,exports[_0x54618e(0x1b5)])(_0x3fbfc4),await _0x4afef1[_0x54618e(0x199)]({'statusImportMessages':_0x4afef1['closedTicketsPostImported']?null:_0x54618e(0x1b2),'importOldMessages':null,'importRecentMessages':null}),_0xdc62d7[_0x54618e(0x1a1)](_0x54618e(0x197)+_0x4afef1[_0x54618e(0x19e)],{'action':_0x54618e(0x1ad)}));}catch(_0x1014a4){}_0x580d26++;}}catch(_0x34ee09){throw new AppError_1['default'](_0x54618e(0x1b6),0x193);}return _0x54618e(0x19a);};exports[a557_0x4f9333(0x1a9)]=ImportWhatsAppMessageService;