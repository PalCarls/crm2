'use strict';function a579_0xb30f(){const _0x27f7fc=['set','\x0aMensagem\x20','../../libs/socket','closeTicketsImported','../TicketServices/UpdateTicketService','getTime','ERR_NOT_MESSAGE_TO_IMPORT','119754EVwcfR','__esModule','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','key','processImportMessagesWppId','renderButtonCloseTickets','format','100131mFMmjP','companyId','sequelize','whatsapps','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','132QZQHVr','DD/MM/YYYY\x20HH:mm:ss','add','date-fns','.txt','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','emit','pending','8WWTQxV','closedTicketsPostImported','moment','findAll','refresh','has','dataMessages','../../models/Whatsapp','addLogs','../../helpers/addLogs','findByPk','../../libs/wbot','floor','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','../WbotServices/wbotMessageListener','9GQmVRW','importOldMessages','17135DPOYhK','messageTimestamp','importMessages-','\x20\x0a\x20\x20\x20\x20','1000335pBgeam','push','\x20de\x20','getIO','closed','low','402520mzmEHN','2017870BtzwOF','update','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','../../models/Ticket','default','handleMessage','642228pHErLP'];a579_0xb30f=function(){return _0x27f7fc;};return a579_0xb30f();}const a579_0x327382=a579_0x3124;(function(_0xc2ff27,_0x141579){const _0x57ecd7=a579_0x3124,_0x546e54=_0xc2ff27();while(!![]){try{const _0x2c091b=-parseInt(_0x57ecd7(0xae))/0x1+-parseInt(_0x57ecd7(0xc2))/0x2*(-parseInt(_0x57ecd7(0xb5))/0x3)+parseInt(_0x57ecd7(0xa6))/0x4+parseInt(_0x57ecd7(0xd3))/0x5*(-parseInt(_0x57ecd7(0xba))/0x6)+-parseInt(_0x57ecd7(0xd7))/0x7+-parseInt(_0x57ecd7(0x9f))/0x8+parseInt(_0x57ecd7(0xd1))/0x9*(parseInt(_0x57ecd7(0xa0))/0xa);if(_0x2c091b===_0x141579)break;else _0x546e54['push'](_0x546e54['shift']());}catch(_0x2f1bbf){_0x546e54['push'](_0x546e54['shift']());}}}(a579_0xb30f,0x1a3dc));function a579_0x3124(_0x307511,_0x1911bd){const _0xb30fe8=a579_0xb30f();return a579_0x3124=function(_0x312447,_0x266487){_0x312447=_0x312447-0x9e;let _0x2b214e=_0xb30fe8[_0x312447];return _0x2b214e;},a579_0x3124(_0x307511,_0x1911bd);}var __importDefault=this&&this['__importDefault']||function(_0x27b938){const _0x1a0784=a579_0x3124;return _0x27b938&&_0x27b938[_0x1a0784(0xaf)]?_0x27b938:{'default':_0x27b938};};Object['defineProperty'](exports,a579_0x327382(0xaf),{'value':!![]}),exports[a579_0x327382(0xaa)]=void 0x0;const AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a579_0x327382(0xc9))),socket_1=require(a579_0x327382(0xa9)),Ticket_1=__importDefault(require(a579_0x327382(0xa3))),sequelize_1=require(a579_0x327382(0xb7)),date_fns_1=require(a579_0x327382(0xbd)),UpdateTicketService_1=__importDefault(require(a579_0x327382(0xab))),wbot_1=require(a579_0x327382(0xcd)),wbotMessageListener_1=require(a579_0x327382(0xd0)),moment_1=__importDefault(require(a579_0x327382(0xc4))),addLogs_1=require(a579_0x327382(0xcb)),closeTicketsImported=async _0x26a092=>{const _0x525c53=a579_0x327382,_0x44f6a3=await Ticket_1[_0x525c53(0xa4)][_0x525c53(0xc5)]({'where':{'status':_0x525c53(0xc1),'whatsappId':_0x26a092,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x525c53(0xbc)])(new Date(),{'hours':+0x5})}}});for(const _0x2d7c56 of _0x44f6a3){await new Promise(_0xfdbff7=>setTimeout(_0xfdbff7,0x14a)),await(0x0,UpdateTicketService_1[_0x525c53(0xa4)])({'ticketData':{'status':_0x525c53(0xdb)},'ticketId':_0x2d7c56['id'],'companyId':_0x2d7c56['companyId']});}let _0x4eeb0c=await Whatsapp_1[_0x525c53(0xa4)][_0x525c53(0xcc)](_0x26a092);_0x4eeb0c[_0x525c53(0xa1)]({'statusImportMessages':null});const _0x4ec224=(0x0,socket_1['getIO'])();_0x4ec224[_0x525c53(0xc0)](_0x525c53(0xd5)+_0x4eeb0c[_0x525c53(0xb6)],{'action':_0x525c53(0xc6)});};exports[a579_0x327382(0xaa)]=closeTicketsImported;function sortByMessageTimestamp(_0x5da433,_0x576d74){const _0x491ad4=a579_0x327382;return _0x576d74[_0x491ad4(0xd4)]-_0x5da433[_0x491ad4(0xd4)];}function cleaner(_0x2e6983){const _0x1619f4=a579_0x327382,_0x41a958=new Map(),_0x30df38=[];for(const _0x5a8ad3 of _0x2e6983){const _0x3356f4=_0x5a8ad3[_0x1619f4(0xb1)]['id'];!_0x41a958[_0x1619f4(0xc7)](_0x3356f4)&&(_0x41a958[_0x1619f4(0xa7)](_0x3356f4,!![]),_0x30df38[_0x1619f4(0xd8)](_0x5a8ad3));}return _0x30df38['sort'](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x40656b=>{const _0x25a665=a579_0x327382;let _0x471916=await Whatsapp_1[_0x25a665(0xa4)][_0x25a665(0xcc)](_0x40656b);const _0x506c69=(0x0,wbot_1['getWbot'])(_0x471916['id']);try{const _0x34af53=(0x0,socket_1[_0x25a665(0xda)])(),_0x416e5b=cleaner(wbot_1[_0x25a665(0xc8)][_0x40656b]);let _0x3fca43=new Date(_0x471916[_0x25a665(0xd2)])[_0x25a665(0xac)](),_0x3e20d2=new Date(_0x471916['importRecentMessages'])[_0x25a665(0xac)]();(0x0,addLogs_1[_0x25a665(0xca)])({'fileName':_0x25a665(0xb2)+_0x40656b+_0x25a665(0xbe),'forceNewFile':!![],'text':_0x25a665(0xb9)+_0x471916['name']+'\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20'+_0x471916['id']+_0x25a665(0xcf)+(0x0,moment_1[_0x25a665(0xa4)])()[_0x25a665(0xb4)](_0x25a665(0xbb))+_0x25a665(0xb0)+(0x0,moment_1['default'])(_0x3fca43)[_0x25a665(0xb4)](_0x25a665(0xbb))+_0x25a665(0xa2)+(0x0,moment_1[_0x25a665(0xa4)])(_0x3e20d2)[_0x25a665(0xb4)](_0x25a665(0xbb))+_0x25a665(0xd6)});const _0x1220f2=_0x416e5b['length'];let _0x5cdd11=0x0;while(_0x5cdd11<_0x1220f2){try{const _0x3c7ae4=_0x416e5b[_0x5cdd11];(0x0,addLogs_1[_0x25a665(0xca)])({'fileName':_0x25a665(0xb2)+_0x40656b+_0x25a665(0xbe),'text':_0x25a665(0xa8)+(_0x5cdd11+0x1)+_0x25a665(0xd9)+_0x1220f2+_0x25a665(0xbf)}),await(0x0,wbotMessageListener_1[_0x25a665(0xa5)])(_0x3c7ae4,_0x506c69,_0x471916[_0x25a665(0xb6)],!![]);if(_0x5cdd11%0x2===0x0){const _0x167633=Math[_0x25a665(0xce)](_0x3c7ae4[_0x25a665(0xd4)][_0x25a665(0x9e)]*0x3e8);_0x34af53['emit'](_0x25a665(0xd5)+_0x471916['companyId'],{'action':_0x25a665(0xa1),'status':{'this':_0x5cdd11+0x1,'all':_0x1220f2,'date':(0x0,moment_1[_0x25a665(0xa4)])(_0x167633)[_0x25a665(0xb4)]('DD/MM/YY\x20HH:mm:ss')}});}_0x5cdd11+0x1===_0x1220f2&&(wbot_1[_0x25a665(0xc8)][_0x40656b]=[],_0x471916[_0x25a665(0xc3)]&&await(0x0,exports[_0x25a665(0xaa)])(_0x40656b),await _0x471916[_0x25a665(0xa1)]({'statusImportMessages':_0x471916[_0x25a665(0xc3)]?null:_0x25a665(0xb3),'importOldMessages':null,'importRecentMessages':null}),_0x34af53[_0x25a665(0xc0)](_0x25a665(0xd5)+_0x471916[_0x25a665(0xb6)],{'action':_0x25a665(0xc6)}));}catch(_0x3b6052){}_0x5cdd11++;}}catch(_0x10ad7a){throw new AppError_1['default'](_0x25a665(0xad),0x193);}return _0x25a665(0xb8);};exports[a579_0x327382(0xa4)]=ImportWhatsAppMessageService;