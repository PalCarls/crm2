'use strict';const a574_0x3e0a91=a574_0x24b2;(function(_0xa2a443,_0x3a052d){const _0x4c6657=a574_0x24b2,_0x4d9b61=_0xa2a443();while(!![]){try{const _0x2ed3c4=-parseInt(_0x4c6657(0xe3))/0x1*(-parseInt(_0x4c6657(0xc4))/0x2)+parseInt(_0x4c6657(0xbd))/0x3+-parseInt(_0x4c6657(0xd3))/0x4*(parseInt(_0x4c6657(0xd5))/0x5)+parseInt(_0x4c6657(0xc9))/0x6+-parseInt(_0x4c6657(0xcc))/0x7*(-parseInt(_0x4c6657(0xe2))/0x8)+parseInt(_0x4c6657(0xb5))/0x9+parseInt(_0x4c6657(0xd7))/0xa*(-parseInt(_0x4c6657(0xd4))/0xb);if(_0x2ed3c4===_0x3a052d)break;else _0x4d9b61['push'](_0x4d9b61['shift']());}catch(_0x116368){_0x4d9b61['push'](_0x4d9b61['shift']());}}}(a574_0x14d6,0x7f6d8));var __importDefault=this&&this['__importDefault']||function(_0xb423c9){return _0xb423c9&&_0xb423c9['__esModule']?_0xb423c9:{'default':_0xb423c9};};function a574_0x24b2(_0x47db60,_0x594dee){const _0x14d606=a574_0x14d6();return a574_0x24b2=function(_0x24b289,_0x175761){_0x24b289=_0x24b289-0xab;let _0x4e14e9=_0x14d606[_0x24b289];return _0x4e14e9;},a574_0x24b2(_0x47db60,_0x594dee);}Object[a574_0x3e0a91(0xac)](exports,a574_0x3e0a91(0xae),{'value':!![]}),exports[a574_0x3e0a91(0xe1)]=void 0x0;const AppError_1=__importDefault(require(a574_0x3e0a91(0xbe))),Whatsapp_1=__importDefault(require(a574_0x3e0a91(0xb8))),socket_1=require(a574_0x3e0a91(0xdb)),Ticket_1=__importDefault(require(a574_0x3e0a91(0xdc))),sequelize_1=require('sequelize'),date_fns_1=require(a574_0x3e0a91(0xb6)),UpdateTicketService_1=__importDefault(require(a574_0x3e0a91(0xc5))),wbot_1=require(a574_0x3e0a91(0xd9)),wbotMessageListener_1=require(a574_0x3e0a91(0xce)),moment_1=__importDefault(require('moment')),addLogs_1=require(a574_0x3e0a91(0xb1)),closeTicketsImported=async _0x4131d7=>{const _0x32bd76=a574_0x3e0a91,_0x28e054=await Ticket_1['default']['findAll']({'where':{'status':_0x32bd76(0xc8),'whatsappId':_0x4131d7,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x32bd76(0xdf)])(new Date(),{'hours':+0x5})}}});for(const _0x497659 of _0x28e054){await new Promise(_0x4ca81c=>setTimeout(_0x4ca81c,0x14a)),await(0x0,UpdateTicketService_1[_0x32bd76(0xad)])({'ticketData':{'status':'closed'},'ticketId':_0x497659['id'],'companyId':_0x497659[_0x32bd76(0xca)]});}let _0x1ab6bd=await Whatsapp_1[_0x32bd76(0xad)]['findByPk'](_0x4131d7);_0x1ab6bd[_0x32bd76(0xb9)]({'statusImportMessages':null});const _0x257780=(0x0,socket_1[_0x32bd76(0xd8)])();_0x257780[_0x32bd76(0xe0)]('importMessages-'+_0x1ab6bd[_0x32bd76(0xca)],{'action':_0x32bd76(0xb4)});};exports[a574_0x3e0a91(0xe1)]=closeTicketsImported;function sortByMessageTimestamp(_0x313aed,_0x5cbdf3){const _0x4c3f80=a574_0x3e0a91;return _0x5cbdf3[_0x4c3f80(0xd6)]-_0x313aed[_0x4c3f80(0xd6)];}function cleaner(_0x104a01){const _0x478397=a574_0x3e0a91,_0x4d5277=new Map(),_0x29c576=[];for(const _0x595147 of _0x104a01){const _0x11f52c=_0x595147['key']['id'];!_0x4d5277[_0x478397(0xe5)](_0x11f52c)&&(_0x4d5277[_0x478397(0xbf)](_0x11f52c,!![]),_0x29c576['push'](_0x595147));}return _0x29c576[_0x478397(0xaf)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x1e43c7=>{const _0x44f2f9=a574_0x3e0a91;let _0x45c5e3=await Whatsapp_1[_0x44f2f9(0xad)][_0x44f2f9(0xc7)](_0x1e43c7);const _0xbea74e=(0x0,wbot_1[_0x44f2f9(0xc3)])(_0x45c5e3['id']);try{const _0x5123b3=(0x0,socket_1['getIO'])(),_0x446073=cleaner(wbot_1[_0x44f2f9(0xcb)][_0x1e43c7]);let _0x43441d=new Date(_0x45c5e3[_0x44f2f9(0xb2)])[_0x44f2f9(0xc1)](),_0x4c4278=new Date(_0x45c5e3[_0x44f2f9(0xde)])[_0x44f2f9(0xc1)]();(0x0,addLogs_1['addLogs'])({'fileName':'processImportMessagesWppId'+_0x1e43c7+_0x44f2f9(0xbb),'forceNewFile':!![],'text':_0x44f2f9(0xda)+_0x45c5e3['name']+_0x44f2f9(0xba)+_0x45c5e3['id']+'\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20'+(0x0,moment_1[_0x44f2f9(0xad)])()[_0x44f2f9(0xcf)](_0x44f2f9(0xd2))+_0x44f2f9(0xb7)+(0x0,moment_1[_0x44f2f9(0xad)])(_0x43441d)[_0x44f2f9(0xcf)](_0x44f2f9(0xd2))+_0x44f2f9(0xe4)+(0x0,moment_1[_0x44f2f9(0xad)])(_0x4c4278)['format'](_0x44f2f9(0xd2))+'\x20\x0a\x20\x20\x20\x20'});const _0x477113=_0x446073[_0x44f2f9(0xb0)];let _0x5806fe=0x0;while(_0x5806fe<_0x477113){try{const _0x3237fc=_0x446073[_0x5806fe];(0x0,addLogs_1['addLogs'])({'fileName':_0x44f2f9(0xcd)+_0x1e43c7+_0x44f2f9(0xbb),'text':_0x44f2f9(0xd1)+(_0x5806fe+0x1)+'\x20de\x20'+_0x477113+_0x44f2f9(0xc6)}),await(0x0,wbotMessageListener_1['handleMessage'])(_0x3237fc,_0xbea74e,_0x45c5e3[_0x44f2f9(0xca)],!![]);if(_0x5806fe%0x2===0x0){const _0x1419e7=Math[_0x44f2f9(0xb3)](_0x3237fc[_0x44f2f9(0xd6)][_0x44f2f9(0xc0)]*0x3e8);_0x5123b3[_0x44f2f9(0xe0)](_0x44f2f9(0xc2)+_0x45c5e3[_0x44f2f9(0xca)],{'action':'update','status':{'this':_0x5806fe+0x1,'all':_0x477113,'date':(0x0,moment_1[_0x44f2f9(0xad)])(_0x1419e7)[_0x44f2f9(0xcf)](_0x44f2f9(0xbc))}});}_0x5806fe+0x1===_0x477113&&(wbot_1[_0x44f2f9(0xcb)][_0x1e43c7]=[],_0x45c5e3[_0x44f2f9(0xe6)]&&await(0x0,exports[_0x44f2f9(0xe1)])(_0x1e43c7),await _0x45c5e3['update']({'statusImportMessages':_0x45c5e3['closedTicketsPostImported']?null:_0x44f2f9(0xab),'importOldMessages':null,'importRecentMessages':null}),_0x5123b3[_0x44f2f9(0xe0)]('importMessages-'+_0x45c5e3[_0x44f2f9(0xca)],{'action':'refresh'}));}catch(_0x4f2091){}_0x5806fe++;}}catch(_0x2a87c6){throw new AppError_1[(_0x44f2f9(0xad))](_0x44f2f9(0xdd),0x193);}return _0x44f2f9(0xd0);};exports[a574_0x3e0a91(0xad)]=ImportWhatsAppMessageService;function a574_0x14d6(){const _0x396463=['2273922oGCMLq','companyId','dataMessages','63FWIDed','processImportMessagesWppId','../WbotServices/wbotMessageListener','format','whatsapps','\x0aMensagem\x20','DD/MM/YYYY\x20HH:mm:ss','4HQsady','1543091CxoKyZ','3528440cLTVTh','messageTimestamp','20AjqcMq','getIO','../../libs/wbot','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','../../libs/socket','../../models/Ticket','ERR_NOT_MESSAGE_TO_IMPORT','importRecentMessages','add','emit','closeTicketsImported','466248tzxskR','25uWdkqt','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','has','closedTicketsPostImported','renderButtonCloseTickets','defineProperty','default','__esModule','sort','length','../../helpers/addLogs','importOldMessages','floor','refresh','320247YHvpnP','date-fns','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','../../models/Whatsapp','update','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','.txt','DD/MM/YY\x20HH:mm:ss','1695735NxHgAh','../../errors/AppError','set','low','getTime','importMessages-','getWbot','308qNPtCY','../TicketServices/UpdateTicketService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','findByPk','pending'];a574_0x14d6=function(){return _0x396463;};return a574_0x14d6();}