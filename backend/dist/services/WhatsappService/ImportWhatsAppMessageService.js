'use strict';const a640_0x376fed=a640_0x435a;(function(_0x3d4d0b,_0x1906ca){const _0x514b74=a640_0x435a,_0x5ab60e=_0x3d4d0b();while(!![]){try{const _0x557476=parseInt(_0x514b74(0x18c))/0x1+parseInt(_0x514b74(0x18e))/0x2+parseInt(_0x514b74(0x1ac))/0x3+-parseInt(_0x514b74(0x17e))/0x4*(-parseInt(_0x514b74(0x1a1))/0x5)+-parseInt(_0x514b74(0x19b))/0x6+parseInt(_0x514b74(0x189))/0x7*(parseInt(_0x514b74(0x17a))/0x8)+-parseInt(_0x514b74(0x1ad))/0x9;if(_0x557476===_0x1906ca)break;else _0x5ab60e['push'](_0x5ab60e['shift']());}catch(_0x43297b){_0x5ab60e['push'](_0x5ab60e['shift']());}}}(a640_0xf673,0xe6511));var __importDefault=this&&this[a640_0x376fed(0x1a5)]||function(_0x19cfe3){const _0x21196f=a640_0x376fed;return _0x19cfe3&&_0x19cfe3[_0x21196f(0x194)]?_0x19cfe3:{'default':_0x19cfe3};};function a640_0xf673(){const _0x374da7=['16cyqPmf','emit','../WbotServices/wbotMessageListener','getWbot','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','getIO','dataMessages','whatsapps','handleMessage','../../helpers/addLogs','closed','4110127WQFVDE','DD/MM/YYYY\x20HH:mm:ss','../TicketServices/UpdateTicketService','535272CVZCpY','companyId','977602lPffkg','processImportMessagesWppId','../../libs/socket','renderButtonCloseTickets','default','format','__esModule','messageTimestamp','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','\x20de\x20','closedTicketsPostImported','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','findByPk','9410490SjRwZK','set','ERR_NOT_MESSAGE_TO_IMPORT','moment','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','importMessages-','1485280LYXSXQ','add','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','sort','__importDefault','sequelize','.txt','../../models/Ticket','../../models/Whatsapp','refresh','addLogs','3791412InkLYh','13963230ywhvSW','push','length','date-fns','../../libs/wbot','floor','update','importOldMessages','key','\x20\x0a\x20\x20\x20\x20','closeTicketsImported','pending','8Hvwhyz','defineProperty','getTime','importRecentMessages'];a640_0xf673=function(){return _0x374da7;};return a640_0xf673();}Object[a640_0x376fed(0x17b)](exports,a640_0x376fed(0x194),{'value':!![]}),exports['closeTicketsImported']=void 0x0;function a640_0x435a(_0x1ca9aa,_0x26f96a){const _0xf673ac=a640_0xf673();return a640_0x435a=function(_0x435a06,_0x20e28d){_0x435a06=_0x435a06-0x179;let _0x23a008=_0xf673ac[_0x435a06];return _0x23a008;},a640_0x435a(_0x1ca9aa,_0x26f96a);}const AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a640_0x376fed(0x1a9))),socket_1=require(a640_0x376fed(0x190)),Ticket_1=__importDefault(require(a640_0x376fed(0x1a8))),sequelize_1=require(a640_0x376fed(0x1a6)),date_fns_1=require(a640_0x376fed(0x1b0)),UpdateTicketService_1=__importDefault(require(a640_0x376fed(0x18b))),wbot_1=require(a640_0x376fed(0x1b1)),wbotMessageListener_1=require(a640_0x376fed(0x180)),moment_1=__importDefault(require(a640_0x376fed(0x19e))),addLogs_1=require(a640_0x376fed(0x187)),closeTicketsImported=async _0x54b09c=>{const _0x3ffe5b=a640_0x376fed,_0x51280f=await Ticket_1[_0x3ffe5b(0x192)]['findAll']({'where':{'status':_0x3ffe5b(0x179),'whatsappId':_0x54b09c,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x3ffe5b(0x1a2)])(new Date(),{'hours':+0x5})}}});for(const _0x4dd7f8 of _0x51280f){await new Promise(_0x11fef0=>setTimeout(_0x11fef0,0x14a)),await(0x0,UpdateTicketService_1[_0x3ffe5b(0x192)])({'ticketData':{'status':_0x3ffe5b(0x188)},'ticketId':_0x4dd7f8['id'],'companyId':_0x4dd7f8['companyId']});}let _0x44e90e=await Whatsapp_1[_0x3ffe5b(0x192)][_0x3ffe5b(0x19a)](_0x54b09c);_0x44e90e[_0x3ffe5b(0x1b3)]({'statusImportMessages':null});const _0xf1bda4=(0x0,socket_1[_0x3ffe5b(0x183)])();_0xf1bda4['emit'](_0x3ffe5b(0x1a0)+_0x44e90e[_0x3ffe5b(0x18d)],{'action':_0x3ffe5b(0x1aa)});};exports[a640_0x376fed(0x1b7)]=closeTicketsImported;function sortByMessageTimestamp(_0x5d3062,_0x41fec6){const _0x5808e6=a640_0x376fed;return _0x41fec6[_0x5808e6(0x195)]-_0x5d3062[_0x5808e6(0x195)];}function cleaner(_0xfae76){const _0x129676=a640_0x376fed,_0x4c6990=new Map(),_0x265b19=[];for(const _0x405988 of _0xfae76){const _0x18b2d1=_0x405988[_0x129676(0x1b5)]['id'];!_0x4c6990['has'](_0x18b2d1)&&(_0x4c6990[_0x129676(0x19c)](_0x18b2d1,!![]),_0x265b19[_0x129676(0x1ae)](_0x405988));}return _0x265b19[_0x129676(0x1a4)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x2b27e3=>{const _0x320d44=a640_0x376fed;let _0x5ea171=await Whatsapp_1['default'][_0x320d44(0x19a)](_0x2b27e3);const _0x416d7c=(0x0,wbot_1[_0x320d44(0x181)])(_0x5ea171['id']);try{const _0x5881ba=(0x0,socket_1[_0x320d44(0x183)])(),_0x539829=cleaner(wbot_1[_0x320d44(0x184)][_0x2b27e3]);let _0x4c3c94=new Date(_0x5ea171[_0x320d44(0x1b4)])['getTime'](),_0x2b0149=new Date(_0x5ea171[_0x320d44(0x17d)])[_0x320d44(0x17c)]();(0x0,addLogs_1[_0x320d44(0x1ab)])({'fileName':_0x320d44(0x18f)+_0x2b27e3+_0x320d44(0x1a7),'forceNewFile':!![],'text':_0x320d44(0x196)+_0x5ea171['name']+'\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20'+_0x5ea171['id']+_0x320d44(0x199)+(0x0,moment_1[_0x320d44(0x192)])()[_0x320d44(0x193)](_0x320d44(0x18a))+_0x320d44(0x1a3)+(0x0,moment_1[_0x320d44(0x192)])(_0x4c3c94)[_0x320d44(0x193)](_0x320d44(0x18a))+_0x320d44(0x182)+(0x0,moment_1[_0x320d44(0x192)])(_0x2b0149)[_0x320d44(0x193)](_0x320d44(0x18a))+_0x320d44(0x1b6)});const _0x37c3f1=_0x539829[_0x320d44(0x1af)];let _0x53f6c2=0x0;while(_0x53f6c2<_0x37c3f1){try{const _0x48e06d=_0x539829[_0x53f6c2];(0x0,addLogs_1['addLogs'])({'fileName':'processImportMessagesWppId'+_0x2b27e3+_0x320d44(0x1a7),'text':'\x0aMensagem\x20'+(_0x53f6c2+0x1)+_0x320d44(0x197)+_0x37c3f1+_0x320d44(0x19f)}),await(0x0,wbotMessageListener_1[_0x320d44(0x186)])(_0x48e06d,_0x416d7c,_0x5ea171[_0x320d44(0x18d)],!![]);if(_0x53f6c2%0x2===0x0){const _0x438cdd=Math[_0x320d44(0x1b2)](_0x48e06d['messageTimestamp']['low']*0x3e8);_0x5881ba[_0x320d44(0x17f)](_0x320d44(0x1a0)+_0x5ea171[_0x320d44(0x18d)],{'action':'update','status':{'this':_0x53f6c2+0x1,'all':_0x37c3f1,'date':(0x0,moment_1[_0x320d44(0x192)])(_0x438cdd)[_0x320d44(0x193)]('DD/MM/YY\x20HH:mm:ss')}});}_0x53f6c2+0x1===_0x37c3f1&&(wbot_1[_0x320d44(0x184)][_0x2b27e3]=[],_0x5ea171['closedTicketsPostImported']&&await(0x0,exports[_0x320d44(0x1b7)])(_0x2b27e3),await _0x5ea171[_0x320d44(0x1b3)]({'statusImportMessages':_0x5ea171[_0x320d44(0x198)]?null:_0x320d44(0x191),'importOldMessages':null,'importRecentMessages':null}),_0x5881ba[_0x320d44(0x17f)](_0x320d44(0x1a0)+_0x5ea171[_0x320d44(0x18d)],{'action':'refresh'}));}catch(_0x2ea50a){}_0x53f6c2++;}}catch(_0x4f1607){throw new AppError_1[(_0x320d44(0x192))](_0x320d44(0x19d),0x193);}return _0x320d44(0x185);};exports[a640_0x376fed(0x192)]=ImportWhatsAppMessageService;