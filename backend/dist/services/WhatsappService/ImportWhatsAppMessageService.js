'use strict';const a557_0x4af4be=a557_0x7bb9;(function(_0x49aa2d,_0xfef334){const _0x300238=a557_0x7bb9,_0x4b86c7=_0x49aa2d();while(!![]){try{const _0x3566b0=parseInt(_0x300238(0x16e))/0x1+-parseInt(_0x300238(0x170))/0x2*(-parseInt(_0x300238(0x165))/0x3)+-parseInt(_0x300238(0x162))/0x4+parseInt(_0x300238(0x14e))/0x5+parseInt(_0x300238(0x17d))/0x6*(parseInt(_0x300238(0x166))/0x7)+parseInt(_0x300238(0x14b))/0x8*(parseInt(_0x300238(0x167))/0x9)+-parseInt(_0x300238(0x16b))/0xa;if(_0x3566b0===_0xfef334)break;else _0x4b86c7['push'](_0x4b86c7['shift']());}catch(_0x5a5c3f){_0x4b86c7['push'](_0x4b86c7['shift']());}}}(a557_0xf808,0x3e6d9));var __importDefault=this&&this[a557_0x4af4be(0x160)]||function(_0x105e83){const _0x1f4c9f=a557_0x4af4be;return _0x105e83&&_0x105e83[_0x1f4c9f(0x154)]?_0x105e83:{'default':_0x105e83};};Object[a557_0x4af4be(0x17a)](exports,a557_0x4af4be(0x154),{'value':!![]}),exports[a557_0x4af4be(0x169)]=void 0x0;const AppError_1=__importDefault(require(a557_0x4af4be(0x16d))),Whatsapp_1=__importDefault(require(a557_0x4af4be(0x176))),socket_1=require(a557_0x4af4be(0x168)),Ticket_1=__importDefault(require(a557_0x4af4be(0x18a))),sequelize_1=require(a557_0x4af4be(0x186)),date_fns_1=require(a557_0x4af4be(0x150)),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require(a557_0x4af4be(0x155)),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),moment_1=__importDefault(require(a557_0x4af4be(0x188))),addLogs_1=require('../../helpers/addLogs'),closeTicketsImported=async _0x11e165=>{const _0x426aae=a557_0x4af4be,_0x2f8996=await Ticket_1[_0x426aae(0x178)][_0x426aae(0x17e)]({'where':{'status':_0x426aae(0x153),'whatsappId':_0x11e165,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x426aae(0x18b)])(new Date(),{'hours':+0x5})}}});for(const _0x3a17a4 of _0x2f8996){await new Promise(_0x4ec6b7=>setTimeout(_0x4ec6b7,0x14a)),await(0x0,UpdateTicketService_1[_0x426aae(0x178)])({'ticketData':{'status':_0x426aae(0x187)},'ticketId':_0x3a17a4['id'],'companyId':_0x3a17a4[_0x426aae(0x175)]});}let _0x26b4d6=await Whatsapp_1[_0x426aae(0x178)][_0x426aae(0x163)](_0x11e165);_0x26b4d6[_0x426aae(0x177)]({'statusImportMessages':null});const _0x109886=(0x0,socket_1[_0x426aae(0x180)])();_0x109886[_0x426aae(0x15c)](_0x426aae(0x14d)+_0x26b4d6[_0x426aae(0x175)],{'action':_0x426aae(0x14c)});};exports[a557_0x4af4be(0x169)]=closeTicketsImported;function a557_0x7bb9(_0x40937c,_0x19833c){const _0xf808fa=a557_0xf808();return a557_0x7bb9=function(_0x7bb9ff,_0x2500b8){_0x7bb9ff=_0x7bb9ff-0x14b;let _0x2ccfcc=_0xf808fa[_0x7bb9ff];return _0x2ccfcc;},a557_0x7bb9(_0x40937c,_0x19833c);}function sortByMessageTimestamp(_0x54d68a,_0x501b82){const _0x238389=a557_0x4af4be;return _0x501b82[_0x238389(0x184)]-_0x54d68a[_0x238389(0x184)];}function cleaner(_0x535386){const _0x3acbb0=a557_0x4af4be,_0x2dab4e=new Map(),_0x53a60b=[];for(const _0x36738d of _0x535386){const _0x12d8c5=_0x36738d['key']['id'];!_0x2dab4e[_0x3acbb0(0x151)](_0x12d8c5)&&(_0x2dab4e[_0x3acbb0(0x17b)](_0x12d8c5,!![]),_0x53a60b[_0x3acbb0(0x156)](_0x36738d));}return _0x53a60b[_0x3acbb0(0x152)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x24f82a=>{const _0x3e4b3e=a557_0x4af4be;let _0x25b897=await Whatsapp_1[_0x3e4b3e(0x178)][_0x3e4b3e(0x163)](_0x24f82a);const _0x3d79c6=(0x0,wbot_1[_0x3e4b3e(0x161)])(_0x25b897['id']);try{const _0x2fbbeb=(0x0,socket_1[_0x3e4b3e(0x180)])(),_0x1efee2=cleaner(wbot_1['dataMessages'][_0x24f82a]);let _0xa4e357=new Date(_0x25b897[_0x3e4b3e(0x157)])[_0x3e4b3e(0x174)](),_0x590d81=new Date(_0x25b897[_0x3e4b3e(0x159)])[_0x3e4b3e(0x174)]();(0x0,addLogs_1[_0x3e4b3e(0x15e)])({'fileName':_0x3e4b3e(0x158)+_0x24f82a+'.txt','forceNewFile':!![],'text':_0x3e4b3e(0x15f)+_0x25b897[_0x3e4b3e(0x172)]+_0x3e4b3e(0x189)+_0x25b897['id']+_0x3e4b3e(0x15d)+(0x0,moment_1[_0x3e4b3e(0x178)])()[_0x3e4b3e(0x179)](_0x3e4b3e(0x15b))+_0x3e4b3e(0x173)+(0x0,moment_1[_0x3e4b3e(0x178)])(_0xa4e357)['format'](_0x3e4b3e(0x15b))+_0x3e4b3e(0x181)+(0x0,moment_1[_0x3e4b3e(0x178)])(_0x590d81)['format'](_0x3e4b3e(0x15b))+_0x3e4b3e(0x171)});const _0x518988=_0x1efee2[_0x3e4b3e(0x16c)];let _0x5bf853=0x0;while(_0x5bf853<_0x518988){try{const _0x7bd549=_0x1efee2[_0x5bf853];(0x0,addLogs_1['addLogs'])({'fileName':_0x3e4b3e(0x158)+_0x24f82a+_0x3e4b3e(0x17c),'text':_0x3e4b3e(0x16a)+(_0x5bf853+0x1)+'\x20de\x20'+_0x518988+_0x3e4b3e(0x183)}),await(0x0,wbotMessageListener_1['handleMessage'])(_0x7bd549,_0x3d79c6,_0x25b897['companyId'],!![]);if(_0x5bf853%0x2===0x0){const _0x2c2ce8=Math[_0x3e4b3e(0x17f)](_0x7bd549[_0x3e4b3e(0x184)][_0x3e4b3e(0x185)]*0x3e8);_0x2fbbeb['emit'](_0x3e4b3e(0x14d)+_0x25b897[_0x3e4b3e(0x175)],{'action':'update','status':{'this':_0x5bf853+0x1,'all':_0x518988,'date':(0x0,moment_1[_0x3e4b3e(0x178)])(_0x2c2ce8)[_0x3e4b3e(0x179)](_0x3e4b3e(0x164))}});}_0x5bf853+0x1===_0x518988&&(wbot_1[_0x3e4b3e(0x16f)][_0x24f82a]=[],_0x25b897[_0x3e4b3e(0x15a)]&&await(0x0,exports['closeTicketsImported'])(_0x24f82a),await _0x25b897[_0x3e4b3e(0x177)]({'statusImportMessages':_0x25b897[_0x3e4b3e(0x15a)]?null:_0x3e4b3e(0x14f),'importOldMessages':null,'importRecentMessages':null}),_0x2fbbeb[_0x3e4b3e(0x15c)](_0x3e4b3e(0x14d)+_0x25b897['companyId'],{'action':_0x3e4b3e(0x14c)}));}catch(_0x28f7b0){}_0x5bf853++;}}catch(_0x56968b){throw new AppError_1[(_0x3e4b3e(0x178))](_0x3e4b3e(0x182),0x193);}return'whatsapps';};exports[a557_0x4af4be(0x178)]=ImportWhatsAppMessageService;function a557_0xf808(){const _0x18226a=['emit','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','addLogs','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','__importDefault','getWbot','1648484CCdpVP','findByPk','DD/MM/YY\x20HH:mm:ss','56013rULXHr','5495dSYbpA','3926844gBbraE','../../libs/socket','closeTicketsImported','\x0aMensagem\x20','2116520eoVuOl','length','../../errors/AppError','177833pUEaDM','dataMessages','18ohxBRw','\x20\x0a\x20\x20\x20\x20','name','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','getTime','companyId','../../models/Whatsapp','update','default','format','defineProperty','set','.txt','6uEPMhH','findAll','floor','getIO','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','ERR_NOT_MESSAGE_TO_IMPORT','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','messageTimestamp','low','sequelize','closed','moment','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','../../models/Ticket','add','8mTsSvT','refresh','importMessages-','482525Lppzly','renderButtonCloseTickets','date-fns','has','sort','pending','__esModule','../../libs/wbot','push','importOldMessages','processImportMessagesWppId','importRecentMessages','closedTicketsPostImported','DD/MM/YYYY\x20HH:mm:ss'];a557_0xf808=function(){return _0x18226a;};return a557_0xf808();}