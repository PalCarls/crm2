'use strict';const a538_0x42e5b4=a538_0x4501;(function(_0x2f8d0d,_0xceb6fd){const _0x40da54=a538_0x4501,_0x1d246d=_0x2f8d0d();while(!![]){try{const _0x4d1bea=-parseInt(_0x40da54(0x1b0))/0x1*(parseInt(_0x40da54(0x1b1))/0x2)+-parseInt(_0x40da54(0x1c2))/0x3+parseInt(_0x40da54(0x1a3))/0x4*(parseInt(_0x40da54(0x1c9))/0x5)+-parseInt(_0x40da54(0x1ca))/0x6*(-parseInt(_0x40da54(0x1ce))/0x7)+parseInt(_0x40da54(0x1ac))/0x8+-parseInt(_0x40da54(0x1a1))/0x9+-parseInt(_0x40da54(0x1af))/0xa*(parseInt(_0x40da54(0x1c8))/0xb);if(_0x4d1bea===_0xceb6fd)break;else _0x1d246d['push'](_0x1d246d['shift']());}catch(_0x23108c){_0x1d246d['push'](_0x1d246d['shift']());}}}(a538_0x5786,0xdbfb6));var __importDefault=this&&this[a538_0x42e5b4(0x1a7)]||function(_0x5d224d){const _0x3e3def=a538_0x42e5b4;return _0x5d224d&&_0x5d224d[_0x3e3def(0x1aa)]?_0x5d224d:{'default':_0x5d224d};};Object[a538_0x42e5b4(0x1a6)](exports,'__esModule',{'value':!![]}),exports[a538_0x42e5b4(0x1cb)]=void 0x0;const AppError_1=__importDefault(require(a538_0x42e5b4(0x1bf))),Whatsapp_1=__importDefault(require(a538_0x42e5b4(0x1c4))),socket_1=require(a538_0x42e5b4(0x1bd)),Ticket_1=__importDefault(require('../../models/Ticket')),sequelize_1=require('sequelize'),date_fns_1=require(a538_0x42e5b4(0x1a2)),UpdateTicketService_1=__importDefault(require(a538_0x42e5b4(0x1be))),wbot_1=require(a538_0x42e5b4(0x1bc)),wbotMessageListener_1=require(a538_0x42e5b4(0x1b3)),moment_1=__importDefault(require(a538_0x42e5b4(0x1ad))),closeTicketsImported=async _0x5ccfd9=>{const _0x39207b=a538_0x42e5b4,_0x41e2e2=await Ticket_1[_0x39207b(0x1ab)][_0x39207b(0x1c3)]({'where':{'status':'pending','whatsappId':_0x5ccfd9,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x39207b(0x1bb)])(new Date(),{'hours':+0x5})}}});for(const _0x4743db of _0x41e2e2){await new Promise(_0x5542e6=>setTimeout(_0x5542e6,0x14a)),await(0x0,UpdateTicketService_1[_0x39207b(0x1ab)])({'ticketData':{'status':_0x39207b(0x19f)},'ticketId':_0x4743db['id'],'companyId':_0x4743db[_0x39207b(0x1ae)]});}let _0x5449c1=await Whatsapp_1['default'][_0x39207b(0x1c5)](_0x5ccfd9);_0x5449c1[_0x39207b(0x1ba)]({'statusImportMessages':null});const _0x165590=(0x0,socket_1[_0x39207b(0x1b4)])();_0x165590[_0x39207b(0x1cc)](_0x39207b(0x1b5)+_0x5449c1[_0x39207b(0x1ae)],{'action':'refresh'});};exports['closeTicketsImported']=closeTicketsImported;function a538_0x4501(_0x44196,_0x4b5e84){const _0x578696=a538_0x5786();return a538_0x4501=function(_0x45014c,_0x5c0c01){_0x45014c=_0x45014c-0x19e;let _0x59514a=_0x578696[_0x45014c];return _0x59514a;},a538_0x4501(_0x44196,_0x4b5e84);}function sortByMessageTimestamp(_0x3d443f,_0x48b413){const _0x23b7d8=a538_0x42e5b4;return _0x48b413[_0x23b7d8(0x1b8)]-_0x3d443f[_0x23b7d8(0x1b8)];}function a538_0x5786(){const _0x4f8d5b=['../../models/Whatsapp','findByPk','whatsapps','handleMessage','6457yoemoh','10SPzeBE','24IwNhID','closeTicketsImported','emit','qtd:','2037014GLfAAi','closedTicketsPostImported','closed','DD/MM/YY\x20HH:mm:ss','10322883EzduDC','date-fns','924644vUffGn','set','length','defineProperty','__importDefault','getWbot','has','__esModule','default','13664656FwpwEe','moment','companyId','14810hCJGXw','361968TIlYOD','2enxMpZ','ERR_NOT_MESSAGE_TO_IMPORT','../WbotServices/wbotMessageListener','getIO','importMessages-','floor','log','messageTimestamp','dataMessages','update','add','../../libs/wbot','../../libs/socket','../TicketServices/UpdateTicketService','../../errors/AppError','low','format','165192zMNSlO','findAll'];a538_0x5786=function(){return _0x4f8d5b;};return a538_0x5786();}function cleaner(_0x2d4696){const _0x3be3ed=a538_0x42e5b4,_0xe618c6=new Map(),_0x26edd4=[];for(const _0x18a0bc of _0x2d4696){const _0xf3d0c9=_0x18a0bc['key']['id'];!_0xe618c6[_0x3be3ed(0x1a9)](_0xf3d0c9)&&(_0xe618c6[_0x3be3ed(0x1a4)](_0xf3d0c9,!![]),_0x26edd4['push'](_0x18a0bc));}return _0x26edd4['sort'](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x3ac6d2=>{const _0xf146ff=a538_0x42e5b4;let _0x200ca0=await Whatsapp_1[_0xf146ff(0x1ab)][_0xf146ff(0x1c5)](_0x3ac6d2);const _0x286eac=(0x0,wbot_1[_0xf146ff(0x1a8)])(_0x200ca0['id']);try{const _0x2c6b20=(0x0,socket_1[_0xf146ff(0x1b4)])(),_0x3c1f4e=cleaner(wbot_1[_0xf146ff(0x1b9)][_0x3ac6d2]),_0x1a73de=_0x3c1f4e[_0xf146ff(0x1a5)];let _0x1cc1eb=0x0;while(_0x1cc1eb<_0x1a73de){try{const _0x227740=_0x3c1f4e[_0x1cc1eb];console[_0xf146ff(0x1b7)]('i:',_0x1cc1eb,_0xf146ff(0x1cd),_0x1a73de),await(0x0,wbotMessageListener_1[_0xf146ff(0x1c7)])(_0x227740,_0x286eac,_0x200ca0[_0xf146ff(0x1ae)],!![]);if(_0x1cc1eb%0x2===0x0){const _0x3b96c5=Math[_0xf146ff(0x1b6)](_0x227740['messageTimestamp'][_0xf146ff(0x1c0)]*0x3e8);_0x2c6b20['emit']('importMessages-'+_0x200ca0[_0xf146ff(0x1ae)],{'action':'update','status':{'this':_0x1cc1eb+0x1,'all':_0x1a73de,'date':(0x0,moment_1[_0xf146ff(0x1ab)])(_0x3b96c5)[_0xf146ff(0x1c1)](_0xf146ff(0x1a0))}});}_0x1cc1eb+0x1===_0x1a73de&&(wbot_1[_0xf146ff(0x1b9)][_0x3ac6d2]=[],_0x200ca0['closedTicketsPostImported']&&await(0x0,exports[_0xf146ff(0x1cb)])(_0x3ac6d2),await _0x200ca0[_0xf146ff(0x1ba)]({'statusImportMessages':_0x200ca0[_0xf146ff(0x19e)]?null:'renderButtonCloseTickets','importOldMessages':null,'importRecentMessages':null}),_0x2c6b20[_0xf146ff(0x1cc)](_0xf146ff(0x1b5)+_0x200ca0['companyId'],{'action':'refresh'}));}catch(_0x55d2b4){}_0x1cc1eb++;}}catch(_0x4a3dbd){throw new AppError_1[(_0xf146ff(0x1ab))](_0xf146ff(0x1b2),0x193);}return _0xf146ff(0x1c6);};exports[a538_0x42e5b4(0x1ab)]=ImportWhatsAppMessageService;