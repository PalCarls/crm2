'use strict';const a632_0x2f150e=a632_0x50f4;(function(_0x43e200,_0x497bee){const _0x1b5cef=a632_0x50f4,_0x1bf96a=_0x43e200();while(!![]){try{const _0x538cd5=-parseInt(_0x1b5cef(0xdc))/0x1+-parseInt(_0x1b5cef(0x104))/0x2+parseInt(_0x1b5cef(0xf9))/0x3*(-parseInt(_0x1b5cef(0xdd))/0x4)+parseInt(_0x1b5cef(0xf2))/0x5*(-parseInt(_0x1b5cef(0xd9))/0x6)+-parseInt(_0x1b5cef(0xe2))/0x7*(-parseInt(_0x1b5cef(0xf1))/0x8)+-parseInt(_0x1b5cef(0x112))/0x9*(parseInt(_0x1b5cef(0xda))/0xa)+parseInt(_0x1b5cef(0x109))/0xb;if(_0x538cd5===_0x497bee)break;else _0x1bf96a['push'](_0x1bf96a['shift']());}catch(_0x5c94d5){_0x1bf96a['push'](_0x1bf96a['shift']());}}}(a632_0x2e00,0x5c156));var __importDefault=this&&this[a632_0x2f150e(0xea)]||function(_0x2da3b6){const _0x5b4893=a632_0x2f150e;return _0x2da3b6&&_0x2da3b6[_0x5b4893(0xe9)]?_0x2da3b6:{'default':_0x2da3b6};};Object[a632_0x2f150e(0xdb)](exports,a632_0x2f150e(0xe9),{'value':!![]}),exports[a632_0x2f150e(0xe1)]=void 0x0;function a632_0x50f4(_0x43c7ec,_0x414bf0){const _0x2e00a6=a632_0x2e00();return a632_0x50f4=function(_0x50f439,_0x1de926){_0x50f439=_0x50f439-0xd3;let _0x158a51=_0x2e00a6[_0x50f439];return _0x158a51;},a632_0x50f4(_0x43c7ec,_0x414bf0);}const AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),socket_1=require(a632_0x2f150e(0xe6)),Ticket_1=__importDefault(require(a632_0x2f150e(0xed))),sequelize_1=require('sequelize'),date_fns_1=require(a632_0x2f150e(0xe5)),UpdateTicketService_1=__importDefault(require(a632_0x2f150e(0xfb))),wbot_1=require(a632_0x2f150e(0xfe)),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),moment_1=__importDefault(require('moment')),addLogs_1=require(a632_0x2f150e(0xee)),closeTicketsImported=async _0x83c6d5=>{const _0xbcc678=a632_0x2f150e,_0x4cc0c0=await Ticket_1[_0xbcc678(0x106)][_0xbcc678(0x107)]({'where':{'status':_0xbcc678(0xd7),'whatsappId':_0x83c6d5,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0xbcc678(0xe7)])(new Date(),{'hours':+0x5})}}});for(const _0x20467e of _0x4cc0c0){await new Promise(_0x599717=>setTimeout(_0x599717,0x14a)),await(0x0,UpdateTicketService_1[_0xbcc678(0x106)])({'ticketData':{'status':'closed'},'ticketId':_0x20467e['id'],'companyId':_0x20467e['companyId']});}let _0x5dfcb0=await Whatsapp_1[_0xbcc678(0x106)]['findByPk'](_0x83c6d5);_0x5dfcb0[_0xbcc678(0x102)]({'statusImportMessages':null});const _0x3e1999=(0x0,socket_1[_0xbcc678(0x103)])();_0x3e1999[_0xbcc678(0xd6)](_0xbcc678(0x100)+_0x5dfcb0[_0xbcc678(0xf5)],{'action':_0xbcc678(0x108)});};function a632_0x2e00(){const _0x335872=['DD/MM/YY\x20HH:mm:ss','update','getIO','995342ADULtv','set','default','findAll','refresh','22776358ljdanf','format','Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20','\x20de\x20','floor','low','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','handleMessage','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','2169dqBmDz','\x0aMensagem\x20','sort','\x20\x0a\x20\x20\x20\x20','getTime','emit','pending','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','480666jvimrm','18650VOXphf','defineProperty','117354oNiZRk','38768dxIebt','closedTicketsPostImported','.txt','dataMessages','closeTicketsImported','7BhLLWa','findByPk','importOldMessages','date-fns','../../libs/socket','add','renderButtonCloseTickets','__esModule','__importDefault','length','importRecentMessages','../../models/Ticket','../../helpers/addLogs','whatsapps','push','5347640uRIcZG','35vjfeYi','messageTimestamp','key','companyId','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','name','DD/MM/YYYY\x20HH:mm:ss','228cSVGnR','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','../TicketServices/UpdateTicketService','addLogs','processImportMessagesWppId','../../libs/wbot','has','importMessages-'];a632_0x2e00=function(){return _0x335872;};return a632_0x2e00();}exports[a632_0x2f150e(0xe1)]=closeTicketsImported;function sortByMessageTimestamp(_0x1f6e45,_0x53c44f){const _0x276d46=a632_0x2f150e;return _0x53c44f['messageTimestamp']-_0x1f6e45[_0x276d46(0xf3)];}function cleaner(_0x3a8e63){const _0x13c1b9=a632_0x2f150e,_0x5a14fd=new Map(),_0x5d1ca8=[];for(const _0x2ba8f3 of _0x3a8e63){const _0x2b078a=_0x2ba8f3[_0x13c1b9(0xf4)]['id'];!_0x5a14fd[_0x13c1b9(0xff)](_0x2b078a)&&(_0x5a14fd[_0x13c1b9(0x105)](_0x2b078a,!![]),_0x5d1ca8[_0x13c1b9(0xf0)](_0x2ba8f3));}return _0x5d1ca8[_0x13c1b9(0xd3)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x52c425=>{const _0x1f1939=a632_0x2f150e;let _0x9974e1=await Whatsapp_1[_0x1f1939(0x106)][_0x1f1939(0xe3)](_0x52c425);const _0xa269e6=(0x0,wbot_1['getWbot'])(_0x9974e1['id']);try{const _0x53adec=(0x0,socket_1[_0x1f1939(0x103)])(),_0x58e7c2=cleaner(wbot_1[_0x1f1939(0xe0)][_0x52c425]);let _0x5eca0b=new Date(_0x9974e1[_0x1f1939(0xe4)])[_0x1f1939(0xd5)](),_0x5e2a52=new Date(_0x9974e1[_0x1f1939(0xec)])['getTime']();(0x0,addLogs_1['addLogs'])({'fileName':_0x1f1939(0xfd)+_0x52c425+_0x1f1939(0xdf),'forceNewFile':!![],'text':_0x1f1939(0x10b)+_0x9974e1[_0x1f1939(0xf7)]+_0x1f1939(0x10f)+_0x9974e1['id']+_0x1f1939(0xfa)+(0x0,moment_1[_0x1f1939(0x106)])()[_0x1f1939(0x10a)]('DD/MM/YYYY\x20HH:mm:ss')+_0x1f1939(0xf6)+(0x0,moment_1[_0x1f1939(0x106)])(_0x5eca0b)[_0x1f1939(0x10a)](_0x1f1939(0xf8))+_0x1f1939(0xd8)+(0x0,moment_1['default'])(_0x5e2a52)[_0x1f1939(0x10a)]('DD/MM/YYYY\x20HH:mm:ss')+_0x1f1939(0xd4)});const _0x1b210f=_0x58e7c2[_0x1f1939(0xeb)];let _0x436f60=0x0;while(_0x436f60<_0x1b210f){try{const _0xa36143=_0x58e7c2[_0x436f60];(0x0,addLogs_1[_0x1f1939(0xfc)])({'fileName':'processImportMessagesWppId'+_0x52c425+'.txt','text':_0x1f1939(0x113)+(_0x436f60+0x1)+_0x1f1939(0x10c)+_0x1b210f+_0x1f1939(0x111)}),await(0x0,wbotMessageListener_1[_0x1f1939(0x110)])(_0xa36143,_0xa269e6,_0x9974e1['companyId'],!![]);if(_0x436f60%0x2===0x0){const _0x255190=Math[_0x1f1939(0x10d)](_0xa36143[_0x1f1939(0xf3)][_0x1f1939(0x10e)]*0x3e8);_0x53adec[_0x1f1939(0xd6)](_0x1f1939(0x100)+_0x9974e1['companyId'],{'action':_0x1f1939(0x102),'status':{'this':_0x436f60+0x1,'all':_0x1b210f,'date':(0x0,moment_1['default'])(_0x255190)[_0x1f1939(0x10a)](_0x1f1939(0x101))}});}_0x436f60+0x1===_0x1b210f&&(wbot_1['dataMessages'][_0x52c425]=[],_0x9974e1['closedTicketsPostImported']&&await(0x0,exports[_0x1f1939(0xe1)])(_0x52c425),await _0x9974e1['update']({'statusImportMessages':_0x9974e1[_0x1f1939(0xde)]?null:_0x1f1939(0xe8),'importOldMessages':null,'importRecentMessages':null}),_0x53adec['emit']('importMessages-'+_0x9974e1[_0x1f1939(0xf5)],{'action':_0x1f1939(0x108)}));}catch(_0x323bbd){}_0x436f60++;}}catch(_0x5c5087){throw new AppError_1[(_0x1f1939(0x106))]('ERR_NOT_MESSAGE_TO_IMPORT',0x193);}return _0x1f1939(0xef);};exports['default']=ImportWhatsAppMessageService;