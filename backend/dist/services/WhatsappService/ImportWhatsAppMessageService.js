'use strict';function a632_0x354c(){const _0x5141f0=['getTime','../../models/Ticket','dataMessages','importOldMessages','4677oDtgyK','6519401veIXtX','68nzcayw','importMessages-','getWbot','../../helpers/addLogs','../../libs/socket','set','__importDefault','24WREqhT','1238074DGpxJu','8ySKgRE','14188599oCWQBv','../../libs/wbot','push','\x0aMensagem\x20','DD/MM/YYYY\x20HH:mm:ss','whatsapps','../WbotServices/wbotMessageListener','getIO','1616145nziXLV','format','defineProperty','__esModule','43406BeGWnH','key','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','processImportMessagesWppId','messageTimestamp','closedTicketsPostImported','closeTicketsImported','sequelize','sort','1084489jqiaAC','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','has','addLogs','findAll','name','update','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../TicketServices/UpdateTicketService','../../models/Whatsapp','refresh','default','emit','moment','floor','importRecentMessages','pending','.txt','ERR_NOT_MESSAGE_TO_IMPORT','DD/MM/YY\x20HH:mm:ss','3970KpbjBr','companyId','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20'];a632_0x354c=function(){return _0x5141f0;};return a632_0x354c();}function a632_0x2fcd(_0xa0ccd5,_0x281899){const _0x354cfb=a632_0x354c();return a632_0x2fcd=function(_0x2fcda0,_0x7e14b7){_0x2fcda0=_0x2fcda0-0x166;let _0x29909e=_0x354cfb[_0x2fcda0];return _0x29909e;},a632_0x2fcd(_0xa0ccd5,_0x281899);}const a632_0xc2cadb=a632_0x2fcd;(function(_0x47eea2,_0x2acd65){const _0x2b1f42=a632_0x2fcd,_0xd40b2b=_0x47eea2();while(!![]){try{const _0xd9671f=parseInt(_0x2b1f42(0x16c))/0x1+parseInt(_0x2b1f42(0x191))/0x2+parseInt(_0x2b1f42(0x187))/0x3*(parseInt(_0x2b1f42(0x189))/0x4)+-parseInt(_0x2b1f42(0x19b))/0x5*(-parseInt(_0x2b1f42(0x190))/0x6)+parseInt(_0x2b1f42(0x188))/0x7+-parseInt(_0x2b1f42(0x192))/0x8*(parseInt(_0x2b1f42(0x193))/0x9)+parseInt(_0x2b1f42(0x180))/0xa*(-parseInt(_0x2b1f42(0x19f))/0xb);if(_0xd9671f===_0x2acd65)break;else _0xd40b2b['push'](_0xd40b2b['shift']());}catch(_0x8ddb5d){_0xd40b2b['push'](_0xd40b2b['shift']());}}}(a632_0x354c,0xc60cf));var __importDefault=this&&this[a632_0xc2cadb(0x18f)]||function(_0xa31bbe){const _0x154938=a632_0xc2cadb;return _0xa31bbe&&_0xa31bbe[_0x154938(0x19e)]?_0xa31bbe:{'default':_0xa31bbe};};Object[a632_0xc2cadb(0x19d)](exports,a632_0xc2cadb(0x19e),{'value':!![]}),exports[a632_0xc2cadb(0x169)]=void 0x0;const AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a632_0xc2cadb(0x175))),socket_1=require(a632_0xc2cadb(0x18d)),Ticket_1=__importDefault(require(a632_0xc2cadb(0x184))),sequelize_1=require(a632_0xc2cadb(0x16a)),date_fns_1=require('date-fns'),UpdateTicketService_1=__importDefault(require(a632_0xc2cadb(0x174))),wbot_1=require(a632_0xc2cadb(0x194)),wbotMessageListener_1=require(a632_0xc2cadb(0x199)),moment_1=__importDefault(require(a632_0xc2cadb(0x179))),addLogs_1=require(a632_0xc2cadb(0x18c)),closeTicketsImported=async _0x27ba65=>{const _0x7c673a=a632_0xc2cadb,_0x51b5f3=await Ticket_1[_0x7c673a(0x177)][_0x7c673a(0x170)]({'where':{'status':_0x7c673a(0x17c),'whatsappId':_0x27ba65,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1['add'])(new Date(),{'hours':+0x5})}}});for(const _0x1c8431 of _0x51b5f3){await new Promise(_0x7c9dfe=>setTimeout(_0x7c9dfe,0x14a)),await(0x0,UpdateTicketService_1[_0x7c673a(0x177)])({'ticketData':{'status':'closed'},'ticketId':_0x1c8431['id'],'companyId':_0x1c8431[_0x7c673a(0x181)]});}let _0x470051=await Whatsapp_1[_0x7c673a(0x177)]['findByPk'](_0x27ba65);_0x470051[_0x7c673a(0x172)]({'statusImportMessages':null});const _0xc68cc3=(0x0,socket_1['getIO'])();_0xc68cc3[_0x7c673a(0x178)](_0x7c673a(0x18a)+_0x470051[_0x7c673a(0x181)],{'action':'refresh'});};exports[a632_0xc2cadb(0x169)]=closeTicketsImported;function sortByMessageTimestamp(_0x507ea3,_0x11ca5b){const _0x6a5450=a632_0xc2cadb;return _0x11ca5b[_0x6a5450(0x167)]-_0x507ea3['messageTimestamp'];}function cleaner(_0xa5d964){const _0x1782fc=a632_0xc2cadb,_0x500369=new Map(),_0x3ba476=[];for(const _0x439b75 of _0xa5d964){const _0xf101af=_0x439b75[_0x1782fc(0x1a0)]['id'];!_0x500369[_0x1782fc(0x16e)](_0xf101af)&&(_0x500369[_0x1782fc(0x18e)](_0xf101af,!![]),_0x3ba476[_0x1782fc(0x195)](_0x439b75));}return _0x3ba476[_0x1782fc(0x16b)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x4a0a9e=>{const _0x35b0c3=a632_0xc2cadb;let _0x529db8=await Whatsapp_1[_0x35b0c3(0x177)]['findByPk'](_0x4a0a9e);const _0x50e228=(0x0,wbot_1[_0x35b0c3(0x18b)])(_0x529db8['id']);try{const _0x16ee22=(0x0,socket_1[_0x35b0c3(0x19a)])(),_0x17184d=cleaner(wbot_1[_0x35b0c3(0x185)][_0x4a0a9e]);let _0x22ebe6=new Date(_0x529db8[_0x35b0c3(0x186)])[_0x35b0c3(0x183)](),_0x394573=new Date(_0x529db8[_0x35b0c3(0x17b)])[_0x35b0c3(0x183)]();(0x0,addLogs_1[_0x35b0c3(0x16f)])({'fileName':_0x35b0c3(0x166)+_0x4a0a9e+'.txt','forceNewFile':!![],'text':'Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20'+_0x529db8[_0x35b0c3(0x171)]+_0x35b0c3(0x182)+_0x529db8['id']+'\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20'+(0x0,moment_1[_0x35b0c3(0x177)])()[_0x35b0c3(0x19c)]('DD/MM/YYYY\x20HH:mm:ss')+_0x35b0c3(0x16d)+(0x0,moment_1[_0x35b0c3(0x177)])(_0x22ebe6)[_0x35b0c3(0x19c)](_0x35b0c3(0x197))+_0x35b0c3(0x1a1)+(0x0,moment_1[_0x35b0c3(0x177)])(_0x394573)[_0x35b0c3(0x19c)](_0x35b0c3(0x197))+'\x20\x0a\x20\x20\x20\x20'});const _0x33a7ce=_0x17184d['length'];let _0xd63c4c=0x0;while(_0xd63c4c<_0x33a7ce){try{const _0x125f76=_0x17184d[_0xd63c4c];(0x0,addLogs_1['addLogs'])({'fileName':_0x35b0c3(0x166)+_0x4a0a9e+_0x35b0c3(0x17d),'text':_0x35b0c3(0x196)+(_0xd63c4c+0x1)+'\x20de\x20'+_0x33a7ce+_0x35b0c3(0x173)}),await(0x0,wbotMessageListener_1['handleMessage'])(_0x125f76,_0x50e228,_0x529db8[_0x35b0c3(0x181)],!![]);if(_0xd63c4c%0x2===0x0){const _0x387808=Math[_0x35b0c3(0x17a)](_0x125f76[_0x35b0c3(0x167)]['low']*0x3e8);_0x16ee22[_0x35b0c3(0x178)](_0x35b0c3(0x18a)+_0x529db8[_0x35b0c3(0x181)],{'action':'update','status':{'this':_0xd63c4c+0x1,'all':_0x33a7ce,'date':(0x0,moment_1['default'])(_0x387808)[_0x35b0c3(0x19c)](_0x35b0c3(0x17f))}});}_0xd63c4c+0x1===_0x33a7ce&&(wbot_1[_0x35b0c3(0x185)][_0x4a0a9e]=[],_0x529db8[_0x35b0c3(0x168)]&&await(0x0,exports['closeTicketsImported'])(_0x4a0a9e),await _0x529db8[_0x35b0c3(0x172)]({'statusImportMessages':_0x529db8[_0x35b0c3(0x168)]?null:'renderButtonCloseTickets','importOldMessages':null,'importRecentMessages':null}),_0x16ee22[_0x35b0c3(0x178)](_0x35b0c3(0x18a)+_0x529db8[_0x35b0c3(0x181)],{'action':_0x35b0c3(0x176)}));}catch(_0x87f857){}_0xd63c4c++;}}catch(_0x2c20e7){throw new AppError_1[(_0x35b0c3(0x177))](_0x35b0c3(0x17e),0x193);}return _0x35b0c3(0x198);};exports[a632_0xc2cadb(0x177)]=ImportWhatsAppMessageService;