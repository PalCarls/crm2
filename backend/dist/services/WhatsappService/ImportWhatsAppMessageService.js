'use strict';const a632_0x3aec59=a632_0x22b6;(function(_0x2376d3,_0x335db8){const _0xbfb469=a632_0x22b6,_0x3f3983=_0x2376d3();while(!![]){try{const _0x672398=-parseInt(_0xbfb469(0xee))/0x1+-parseInt(_0xbfb469(0xfa))/0x2*(-parseInt(_0xbfb469(0xf1))/0x3)+parseInt(_0xbfb469(0x113))/0x4*(-parseInt(_0xbfb469(0xff))/0x5)+-parseInt(_0xbfb469(0xfd))/0x6+-parseInt(_0xbfb469(0xe0))/0x7*(parseInt(_0xbfb469(0xea))/0x8)+parseInt(_0xbfb469(0xf8))/0x9+-parseInt(_0xbfb469(0xdc))/0xa*(-parseInt(_0xbfb469(0x107))/0xb);if(_0x672398===_0x335db8)break;else _0x3f3983['push'](_0x3f3983['shift']());}catch(_0x21a17a){_0x3f3983['push'](_0x3f3983['shift']());}}}(a632_0xbf7f,0x4f092));var __importDefault=this&&this['__importDefault']||function(_0x3d63d8){const _0x5b2c59=a632_0x22b6;return _0x3d63d8&&_0x3d63d8[_0x5b2c59(0xe6)]?_0x3d63d8:{'default':_0x3d63d8};};Object[a632_0x3aec59(0x10d)](exports,'__esModule',{'value':!![]}),exports[a632_0x3aec59(0x103)]=void 0x0;function a632_0x22b6(_0x2942aa,_0x29cb2d){const _0xbf7fef=a632_0xbf7f();return a632_0x22b6=function(_0x22b69c,_0x5de5a4){_0x22b69c=_0x22b69c-0xd8;let _0x2b8854=_0xbf7fef[_0x22b69c];return _0x2b8854;},a632_0x22b6(_0x2942aa,_0x29cb2d);}const AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a632_0x3aec59(0xf5))),socket_1=require(a632_0x3aec59(0xf0)),Ticket_1=__importDefault(require(a632_0x3aec59(0xd9))),sequelize_1=require('sequelize'),date_fns_1=require('date-fns'),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require(a632_0x3aec59(0x102)),wbotMessageListener_1=require(a632_0x3aec59(0xf3)),moment_1=__importDefault(require(a632_0x3aec59(0x114))),addLogs_1=require('../../helpers/addLogs'),closeTicketsImported=async _0x4b331c=>{const _0x17691d=a632_0x3aec59,_0x1c5421=await Ticket_1['default'][_0x17691d(0xe5)]({'where':{'status':_0x17691d(0xfe),'whatsappId':_0x4b331c,'imported':{[sequelize_1['Op']['lt']]:+(0x0,date_fns_1[_0x17691d(0x111)])(new Date(),{'hours':+0x5})}}});for(const _0x3fa5c2 of _0x1c5421){await new Promise(_0x12a486=>setTimeout(_0x12a486,0x14a)),await(0x0,UpdateTicketService_1[_0x17691d(0xe2)])({'ticketData':{'status':_0x17691d(0xd8)},'ticketId':_0x3fa5c2['id'],'companyId':_0x3fa5c2[_0x17691d(0xec)]});}let _0x49a0d2=await Whatsapp_1[_0x17691d(0xe2)][_0x17691d(0xde)](_0x4b331c);_0x49a0d2[_0x17691d(0xfc)]({'statusImportMessages':null});const _0x4c4b10=(0x0,socket_1[_0x17691d(0xda)])();_0x4c4b10['emit'](_0x17691d(0xe4)+_0x49a0d2['companyId'],{'action':_0x17691d(0xf6)});};function a632_0xbf7f(){const _0x1b6250=['78345QwPJGl','DD/MM/YY\x20HH:mm:ss','processImportMessagesWppId','../../libs/wbot','closeTicketsImported','DD/MM/YYYY\x20HH:mm:ss','whatsapps','importRecentMessages','4837173cESBlp','set','\x20de\x20','\x0a\x20\x20\x20\x20Selecionado\x20Data\x20de\x20inicio\x20de\x20importação:\x20','sort','format','defineProperty','getTime','closedTicketsPostImported','\x20\x0a\x20\x20\x20\x20Selecionado\x20Data\x20final\x20da\x20importação:\x20','add','length','68ZvIuEy','moment','closed','../../models/Ticket','getIO','getWbot','30GZcSCY','renderButtonCloseTickets','findByPk','\x0a\x20\x20\x20\x20Criação\x20do\x20arquivo\x20de\x20logs:\x20','942683zvSZOw','\x20\x0a\x20\x20\x20\x20','default','ERR_NOT_MESSAGE_TO_IMPORT','importMessages-','findAll','__esModule','dataMessages','low','has','16HgeYwn','floor','companyId','messageTimestamp','322583igHKrg','key','../../libs/socket','28581GPjPZX','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../WbotServices/wbotMessageListener','\x0a\x20\x20\x20\x20Whatsapp\x20Id:\x20','../../models/Whatsapp','refresh','emit','2125566YYvKBn','.txt','14fVIkLl','handleMessage','update','2640408jlLtNN','pending'];a632_0xbf7f=function(){return _0x1b6250;};return a632_0xbf7f();}exports['closeTicketsImported']=closeTicketsImported;function sortByMessageTimestamp(_0x1dd5ec,_0x75a512){const _0x487cdb=a632_0x3aec59;return _0x75a512[_0x487cdb(0xed)]-_0x1dd5ec['messageTimestamp'];}function cleaner(_0x1d63fb){const _0x2f756f=a632_0x3aec59,_0x283647=new Map(),_0x2ebd03=[];for(const _0x3331b7 of _0x1d63fb){const _0xf9389b=_0x3331b7[_0x2f756f(0xef)]['id'];!_0x283647[_0x2f756f(0xe9)](_0xf9389b)&&(_0x283647[_0x2f756f(0x108)](_0xf9389b,!![]),_0x2ebd03['push'](_0x3331b7));}return _0x2ebd03[_0x2f756f(0x10b)](sortByMessageTimestamp);}const ImportWhatsAppMessageService=async _0x2e679c=>{const _0x4777ba=a632_0x3aec59;let _0x2bc96f=await Whatsapp_1[_0x4777ba(0xe2)][_0x4777ba(0xde)](_0x2e679c);const _0x4a1689=(0x0,wbot_1[_0x4777ba(0xdb)])(_0x2bc96f['id']);try{const _0x5eb445=(0x0,socket_1[_0x4777ba(0xda)])(),_0x38d923=cleaner(wbot_1[_0x4777ba(0xe7)][_0x2e679c]);let _0x34d722=new Date(_0x2bc96f['importOldMessages'])[_0x4777ba(0x10e)](),_0x27e6cc=new Date(_0x2bc96f[_0x4777ba(0x106)])[_0x4777ba(0x10e)]();(0x0,addLogs_1['addLogs'])({'fileName':'processImportMessagesWppId'+_0x2e679c+_0x4777ba(0xf9),'forceNewFile':!![],'text':'Aguardando\x20conexão\x20para\x20iniciar\x20a\x20importação\x20de\x20mensagens:\x0a\x20\x20\x20\x20Whatsapp\x20nome:\x20'+_0x2bc96f['name']+_0x4777ba(0xf4)+_0x2bc96f['id']+_0x4777ba(0xdf)+(0x0,moment_1[_0x4777ba(0xe2)])()['format']('DD/MM/YYYY\x20HH:mm:ss')+_0x4777ba(0x10a)+(0x0,moment_1['default'])(_0x34d722)[_0x4777ba(0x10c)](_0x4777ba(0x104))+_0x4777ba(0x110)+(0x0,moment_1['default'])(_0x27e6cc)[_0x4777ba(0x10c)]('DD/MM/YYYY\x20HH:mm:ss')+_0x4777ba(0xe1)});const _0x224c85=_0x38d923[_0x4777ba(0x112)];let _0x11ae39=0x0;while(_0x11ae39<_0x224c85){try{const _0x1b08f6=_0x38d923[_0x11ae39];(0x0,addLogs_1['addLogs'])({'fileName':_0x4777ba(0x101)+_0x2e679c+_0x4777ba(0xf9),'text':'\x0aMensagem\x20'+(_0x11ae39+0x1)+_0x4777ba(0x109)+_0x224c85+_0x4777ba(0xf2)}),await(0x0,wbotMessageListener_1[_0x4777ba(0xfb)])(_0x1b08f6,_0x4a1689,_0x2bc96f[_0x4777ba(0xec)],!![]);if(_0x11ae39%0x2===0x0){const _0x17c829=Math[_0x4777ba(0xeb)](_0x1b08f6[_0x4777ba(0xed)][_0x4777ba(0xe8)]*0x3e8);_0x5eb445[_0x4777ba(0xf7)]('importMessages-'+_0x2bc96f[_0x4777ba(0xec)],{'action':_0x4777ba(0xfc),'status':{'this':_0x11ae39+0x1,'all':_0x224c85,'date':(0x0,moment_1[_0x4777ba(0xe2)])(_0x17c829)[_0x4777ba(0x10c)](_0x4777ba(0x100))}});}_0x11ae39+0x1===_0x224c85&&(wbot_1[_0x4777ba(0xe7)][_0x2e679c]=[],_0x2bc96f[_0x4777ba(0x10f)]&&await(0x0,exports[_0x4777ba(0x103)])(_0x2e679c),await _0x2bc96f['update']({'statusImportMessages':_0x2bc96f['closedTicketsPostImported']?null:_0x4777ba(0xdd),'importOldMessages':null,'importRecentMessages':null}),_0x5eb445[_0x4777ba(0xf7)](_0x4777ba(0xe4)+_0x2bc96f[_0x4777ba(0xec)],{'action':'refresh'}));}catch(_0x3e8e30){}_0x11ae39++;}}catch(_0x1c8e47){throw new AppError_1['default'](_0x4777ba(0xe3),0x193);}return _0x4777ba(0x105);};exports['default']=ImportWhatsAppMessageService;