'use strict';const a555_0x161dc8=a555_0xcc8c;function a555_0x3d28(){const _0x52369c=['string','configurable','min','Check-name','count','plan','2389040HiHzOZ','__setModuleDefault','1395092zQlXBY','findOne','test','../../models/Plan','required','../../models/Company','shape','hasOwnProperty','create','1820148nXTIfY','2328165rHBaND','validate','whatsapp','Check-token','defineProperty','5jzyVUd','2766312sxQLnf','117288JGWZlj','__importStar','connections','boolean','default','../../models/Whatsapp','__esModule','__importDefault','getOwnPropertyDescriptor','892215OuMNXa','ERR_WAPP_GREETING_REQUIRED','message','object','OPENING','927wxYaBv'];a555_0x3d28=function(){return _0x52369c;};return a555_0x3d28();}(function(_0x4bccdc,_0x49dc92){const _0x11668f=a555_0xcc8c,_0x575b1a=_0x4bccdc();while(!![]){try{const _0x2e534b=-parseInt(_0x11668f(0x155))/0x1+parseInt(_0x11668f(0x161))/0x2+-parseInt(_0x11668f(0x144))/0x3+-parseInt(_0x11668f(0x13b))/0x4*(parseInt(_0x11668f(0x14a))/0x5)+-parseInt(_0x11668f(0x14b))/0x6+parseInt(_0x11668f(0x145))/0x7+parseInt(_0x11668f(0x14c))/0x8*(parseInt(_0x11668f(0x15a))/0x9);if(_0x2e534b===_0x49dc92)break;else _0x575b1a['push'](_0x575b1a['shift']());}catch(_0xacbab7){_0x575b1a['push'](_0x575b1a['shift']());}}}(a555_0x3d28,0xb1d7a));function a555_0xcc8c(_0x5c8a29,_0x4cc411){const _0x3d28bd=a555_0x3d28();return a555_0xcc8c=function(_0xcc8cc6,_0x1c1ee4){_0xcc8cc6=_0xcc8cc6-0x13b;let _0x209c8c=_0x3d28bd[_0xcc8cc6];return _0x209c8c;},a555_0xcc8c(_0x5c8a29,_0x4cc411);}var __createBinding=this&&this['__createBinding']||(Object[a555_0x161dc8(0x143)]?function(_0x5a28ab,_0x240a1c,_0x121497,_0x15f43a){const _0x410702=a555_0x161dc8;if(_0x15f43a===undefined)_0x15f43a=_0x121497;var _0x10880f=Object[_0x410702(0x154)](_0x240a1c,_0x121497);(!_0x10880f||('get'in _0x10880f?!_0x240a1c[_0x410702(0x152)]:_0x10880f['writable']||_0x10880f[_0x410702(0x15c)]))&&(_0x10880f={'enumerable':!![],'get':function(){return _0x240a1c[_0x121497];}}),Object[_0x410702(0x149)](_0x5a28ab,_0x15f43a,_0x10880f);}:function(_0xadb2c0,_0x3dd996,_0x3d74a5,_0x379814){if(_0x379814===undefined)_0x379814=_0x3d74a5;_0xadb2c0[_0x379814]=_0x3dd996[_0x3d74a5];}),__setModuleDefault=this&&this[a555_0x161dc8(0x162)]||(Object['create']?function(_0x5b972e,_0x9dc18e){const _0x39bbde=a555_0x161dc8;Object[_0x39bbde(0x149)](_0x5b972e,_0x39bbde(0x150),{'enumerable':!![],'value':_0x9dc18e});}:function(_0x192f7c,_0x3c2927){_0x192f7c['default']=_0x3c2927;}),__importStar=this&&this[a555_0x161dc8(0x14d)]||function(_0x28076c){const _0x5aa2a1=a555_0x161dc8;if(_0x28076c&&_0x28076c[_0x5aa2a1(0x152)])return _0x28076c;var _0x3da9a6={};if(_0x28076c!=null){for(var _0x11ab15 in _0x28076c)if(_0x11ab15!=='default'&&Object['prototype'][_0x5aa2a1(0x142)]['call'](_0x28076c,_0x11ab15))__createBinding(_0x3da9a6,_0x28076c,_0x11ab15);}return __setModuleDefault(_0x3da9a6,_0x28076c),_0x3da9a6;},__importDefault=this&&this[a555_0x161dc8(0x153)]||function(_0x25eee8){return _0x25eee8&&_0x25eee8['__esModule']?_0x25eee8:{'default':_0x25eee8};};Object[a555_0x161dc8(0x149)](exports,a555_0x161dc8(0x152),{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a555_0x161dc8(0x151))),Company_1=__importDefault(require(a555_0x161dc8(0x140))),Plan_1=__importDefault(require(a555_0x161dc8(0x13e))),AssociateWhatsappQueue_1=__importDefault(require('./AssociateWhatsappQueue')),CreateWhatsAppService=async({name:_0x106f40,status:status=a555_0x161dc8(0x159),queueIds:queueIds=[],greetingMessage:_0x232676,complationMessage:_0x2a64fb,outOfHoursMessage:_0x336f0c,isDefault:isDefault=![],companyId:_0x477056,token:token='',provider:provider='beta',facebookUserId:_0x56f598,facebookUserToken:_0x2989f1,facebookPageUserId:_0xe10f6e,tokenMeta:_0x176e58,channel:channel=a555_0x161dc8(0x147),maxUseBotQueues:_0x10fff0,timeUseBotQueues:_0x24fd27,expiresTicket:_0x29d927,allowGroup:allowGroup=![],timeSendQueue:_0x1ecee1,sendIdQueue:_0x5b1275,timeInactiveMessage:_0x27922e,inactiveMessage:_0x33bd46,ratingMessage:_0x3af1b1,maxUseBotQueuesNPS:_0x1a327b,expiresTicketNPS:_0x36236a,whenExpiresTicket:_0x194a03,expiresInactiveMessage:_0x466c36,groupAsTicket:_0x491355,importOldMessages:_0x4e6e1f,importRecentMessages:_0x4d3307,closedTicketsPostImported:_0xa7be51,importOldMessagesGroups:_0x1795b6,timeCreateNewTicket:_0x25cf7c})=>{const _0x5cdc03=a555_0x161dc8,_0x252656=await Company_1[_0x5cdc03(0x150)][_0x5cdc03(0x13c)]({'where':{'id':_0x477056},'include':[{'model':Plan_1['default'],'as':_0x5cdc03(0x160)}]});if(_0x252656!==null){const _0x270708=await Whatsapp_1[_0x5cdc03(0x150)][_0x5cdc03(0x15f)]({'where':{'companyId':_0x477056,'channel':channel}});if(_0x270708>=_0x252656[_0x5cdc03(0x160)][_0x5cdc03(0x14e)])throw new AppError_1[(_0x5cdc03(0x150))]('Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20'+_0x270708);}const _0x10b1d7=Yup[_0x5cdc03(0x158)]()[_0x5cdc03(0x141)]({'name':Yup[_0x5cdc03(0x15b)]()[_0x5cdc03(0x13f)]()[_0x5cdc03(0x15d)](0x2)[_0x5cdc03(0x13d)](_0x5cdc03(0x15e),'Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão',async _0x366fc7=>{const _0xb8737f=_0x5cdc03;if(!_0x366fc7)return![];const _0x116cb0=await Whatsapp_1[_0xb8737f(0x150)][_0xb8737f(0x13c)]({'where':{'name':_0x366fc7,'channel':channel,'companyId':_0x477056}});return!_0x116cb0;}),'isDefault':Yup[_0x5cdc03(0x14f)]()['required']()});try{await _0x10b1d7[_0x5cdc03(0x146)]({'name':_0x106f40,'status':status,'isDefault':isDefault});}catch(_0x503c9a){throw new AppError_1[(_0x5cdc03(0x150))](_0x503c9a[_0x5cdc03(0x157)]);}const _0x5e7b53=await Whatsapp_1[_0x5cdc03(0x150)]['findOne']({'where':{'companyId':_0x477056}});isDefault=channel===_0x5cdc03(0x147)?!_0x5e7b53:![];let _0x39cbc8=null;channel===_0x5cdc03(0x147)&&isDefault&&(_0x39cbc8=await Whatsapp_1[_0x5cdc03(0x150)][_0x5cdc03(0x13c)]({'where':{'isDefault':!![],'companyId':_0x477056,'channel':channel}}),_0x39cbc8&&await _0x39cbc8['update']({'isDefault':![],'companyId':_0x477056}));if(queueIds['length']>0x1&&!_0x232676)throw new AppError_1[(_0x5cdc03(0x150))](_0x5cdc03(0x156));if(token!==null&&token!==''){const _0x24195f=Yup[_0x5cdc03(0x158)]()[_0x5cdc03(0x141)]({'token':Yup[_0x5cdc03(0x15b)]()[_0x5cdc03(0x13f)]()['min'](0x2)[_0x5cdc03(0x13d)](_0x5cdc03(0x148),'This\x20whatsapp\x20token\x20is\x20already\x20used.',async _0x375f50=>{const _0x4123f2=_0x5cdc03;if(!_0x375f50)return![];const _0x2a3b93=await Whatsapp_1[_0x4123f2(0x150)][_0x4123f2(0x13c)]({'where':{'token':_0x375f50,'channel':channel}});return!_0x2a3b93;})});try{await _0x24195f[_0x5cdc03(0x146)]({'token':token});}catch(_0x53d5eb){throw new AppError_1[(_0x5cdc03(0x150))](_0x53d5eb[_0x5cdc03(0x157)]);}}const _0xd953cb=await Whatsapp_1[_0x5cdc03(0x150)][_0x5cdc03(0x143)]({'name':_0x106f40,'status':status,'greetingMessage':_0x232676,'complationMessage':_0x2a64fb,'outOfHoursMessage':_0x336f0c,'ratingMessage':_0x3af1b1,'isDefault':isDefault,'companyId':_0x477056,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x56f598,'facebookUserToken':_0x2989f1,'facebookPageUserId':_0xe10f6e,'tokenMeta':_0x176e58,'maxUseBotQueues':_0x10fff0,'timeUseBotQueues':_0x24fd27,'expiresTicket':_0x29d927,'allowGroup':allowGroup,'timeSendQueue':_0x1ecee1,'sendIdQueue':_0x5b1275,'timeInactiveMessage':_0x27922e,'inactiveMessage':_0x33bd46,'maxUseBotQueuesNPS':_0x1a327b,'expiresTicketNPS':_0x36236a,'whenExpiresTicket':_0x194a03,'expiresInactiveMessage':_0x466c36,'groupAsTicket':_0x491355,'importOldMessages':_0x4e6e1f,'importRecentMessages':_0x4d3307,'closedTicketsPostImported':_0xa7be51,'importOldMessagesGroups':_0x1795b6,'timeCreateNewTicket':_0x25cf7c},{'include':['queues']});return await(0x0,AssociateWhatsappQueue_1[_0x5cdc03(0x150)])(_0xd953cb,queueIds),{'whatsapp':_0xd953cb,'oldDefaultWhatsapp':_0x39cbc8};};exports[a555_0x161dc8(0x150)]=CreateWhatsAppService;