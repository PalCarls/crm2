'use strict';const a577_0x4dad6b=a577_0xca3b;(function(_0x30f67c,_0x294382){const _0x454e69=a577_0xca3b,_0x5b94ac=_0x30f67c();while(!![]){try{const _0x38c218=parseInt(_0x454e69(0x1a7))/0x1+-parseInt(_0x454e69(0x1be))/0x2+parseInt(_0x454e69(0x1b8))/0x3+parseInt(_0x454e69(0x1c1))/0x4+-parseInt(_0x454e69(0x1ab))/0x5+-parseInt(_0x454e69(0x1af))/0x6+parseInt(_0x454e69(0x1b5))/0x7;if(_0x38c218===_0x294382)break;else _0x5b94ac['push'](_0x5b94ac['shift']());}catch(_0x427532){_0x5b94ac['push'](_0x5b94ac['shift']());}}}(a577_0x5951,0x3660c));function a577_0xca3b(_0x2ca36b,_0x1f99eb){const _0x595146=a577_0x5951();return a577_0xca3b=function(_0xca3b20,_0x6c543f){_0xca3b20=_0xca3b20-0x19c;let _0x62abf1=_0x595146[_0xca3b20];return _0x62abf1;},a577_0xca3b(_0x2ca36b,_0x1f99eb);}var __createBinding=this&&this[a577_0x4dad6b(0x1a4)]||(Object[a577_0x4dad6b(0x1a0)]?function(_0x4533e3,_0x382ac3,_0x162331,_0x4c6f67){const _0x529410=a577_0x4dad6b;if(_0x4c6f67===undefined)_0x4c6f67=_0x162331;var _0x2e0d5c=Object[_0x529410(0x1bb)](_0x382ac3,_0x162331);(!_0x2e0d5c||(_0x529410(0x1ae)in _0x2e0d5c?!_0x382ac3[_0x529410(0x1ba)]:_0x2e0d5c[_0x529410(0x1a3)]||_0x2e0d5c[_0x529410(0x1c5)]))&&(_0x2e0d5c={'enumerable':!![],'get':function(){return _0x382ac3[_0x162331];}}),Object['defineProperty'](_0x4533e3,_0x4c6f67,_0x2e0d5c);}:function(_0x5aa14e,_0x1e8983,_0x55ac1c,_0x42c5ce){if(_0x42c5ce===undefined)_0x42c5ce=_0x55ac1c;_0x5aa14e[_0x42c5ce]=_0x1e8983[_0x55ac1c];}),__setModuleDefault=this&&this[a577_0x4dad6b(0x19d)]||(Object['create']?function(_0x25f470,_0x51e1b4){const _0x415006=a577_0x4dad6b;Object[_0x415006(0x1bc)](_0x25f470,_0x415006(0x1b7),{'enumerable':!![],'value':_0x51e1b4});}:function(_0x1c85ba,_0x20fdb1){const _0x358112=a577_0x4dad6b;_0x1c85ba[_0x358112(0x1b7)]=_0x20fdb1;}),__importStar=this&&this[a577_0x4dad6b(0x1b6)]||function(_0x366671){const _0x220967=a577_0x4dad6b;if(_0x366671&&_0x366671[_0x220967(0x1ba)])return _0x366671;var _0xe811b2={};if(_0x366671!=null){for(var _0x134105 in _0x366671)if(_0x134105!==_0x220967(0x1b7)&&Object[_0x220967(0x1c0)]['hasOwnProperty'][_0x220967(0x19f)](_0x366671,_0x134105))__createBinding(_0xe811b2,_0x366671,_0x134105);}return __setModuleDefault(_0xe811b2,_0x366671),_0xe811b2;},__importDefault=this&&this[a577_0x4dad6b(0x1b2)]||function(_0x13a585){const _0x38e9be=a577_0x4dad6b;return _0x13a585&&_0x13a585[_0x38e9be(0x1ba)]?_0x13a585:{'default':_0x13a585};};Object[a577_0x4dad6b(0x1bc)](exports,'__esModule',{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require(a577_0x4dad6b(0x1a1))),Whatsapp_1=__importDefault(require(a577_0x4dad6b(0x1a8))),Company_1=__importDefault(require(a577_0x4dad6b(0x1c2))),Plan_1=__importDefault(require('../../models/Plan')),AssociateWhatsappQueue_1=__importDefault(require('./AssociateWhatsappQueue')),CreateWhatsAppService=async({name:_0x57b8a9,status:status=a577_0x4dad6b(0x1aa),queueIds:queueIds=[],greetingMessage:_0x1ff53b,complationMessage:_0x39b902,outOfHoursMessage:_0xbf55d5,isDefault:isDefault=![],companyId:_0x14c6ce,token:token='',provider:provider=a577_0x4dad6b(0x1c6),facebookUserId:_0x5de78b,facebookUserToken:_0xd10835,facebookPageUserId:_0x44e913,tokenMeta:_0x3149d1,channel:channel='whatsapp',maxUseBotQueues:_0x36a643,timeUseBotQueues:_0x1ef548,expiresTicket:_0x509707,allowGroup:allowGroup=![],timeSendQueue:_0x2d58cc,sendIdQueue:_0x2243df,timeInactiveMessage:_0x223a81,inactiveMessage:_0x4ac767,ratingMessage:_0x2d99e4,maxUseBotQueuesNPS:_0xd96e0c,expiresTicketNPS:_0xb5dff1,whenExpiresTicket:_0x4f37fb,expiresInactiveMessage:_0x2f4c84,groupAsTicket:_0x398780,importOldMessages:_0x147f94,importRecentMessages:_0x4ee34e,closedTicketsPostImported:_0x463899,importOldMessagesGroups:_0x32ce43,timeCreateNewTicket:_0x1c7f08,integrationId:_0x59dcb4,schedules:_0x4f872f})=>{const _0x5bba86=a577_0x4dad6b,_0x9d31cc=await Company_1[_0x5bba86(0x1b7)][_0x5bba86(0x1bd)]({'where':{'id':_0x14c6ce},'include':[{'model':Plan_1['default'],'as':_0x5bba86(0x1ac)}]});if(_0x9d31cc!==null){const _0x1aa4de=await Whatsapp_1[_0x5bba86(0x1b7)][_0x5bba86(0x1b1)]({'where':{'companyId':_0x14c6ce,'channel':channel}});if(_0x1aa4de>=_0x9d31cc[_0x5bba86(0x1ac)][_0x5bba86(0x1a2)])throw new AppError_1['default'](_0x5bba86(0x1a9)+_0x1aa4de);}const _0x58ec63=Yup[_0x5bba86(0x1bf)]()[_0x5bba86(0x1b4)]({'name':Yup['string']()[_0x5bba86(0x1c4)]()[_0x5bba86(0x19c)](0x2)['test'](_0x5bba86(0x1c3),_0x5bba86(0x19e),async _0x563300=>{const _0x4898f0=_0x5bba86;if(!_0x563300)return![];const _0x13bc89=await Whatsapp_1[_0x4898f0(0x1b7)][_0x4898f0(0x1bd)]({'where':{'name':_0x563300,'channel':channel,'companyId':_0x14c6ce}});return!_0x13bc89;}),'isDefault':Yup['boolean']()[_0x5bba86(0x1c4)]()});try{await _0x58ec63[_0x5bba86(0x1b9)]({'name':_0x57b8a9,'status':status,'isDefault':isDefault});}catch(_0x400c5d){throw new AppError_1['default'](_0x400c5d['message']);}const _0x5befd8=await Whatsapp_1['default'][_0x5bba86(0x1bd)]({'where':{'companyId':_0x14c6ce}});isDefault=channel===_0x5bba86(0x1a5)?!_0x5befd8:![];let _0x211acd=null;channel===_0x5bba86(0x1a5)&&isDefault&&(_0x211acd=await Whatsapp_1['default']['findOne']({'where':{'isDefault':!![],'companyId':_0x14c6ce,'channel':channel}}),_0x211acd&&await _0x211acd[_0x5bba86(0x1c7)]({'isDefault':![],'companyId':_0x14c6ce}));if(queueIds['length']>0x1&&!_0x1ff53b)throw new AppError_1[(_0x5bba86(0x1b7))]('ERR_WAPP_GREETING_REQUIRED');if(token!==null&&token!==''){const _0x2d79b1=Yup[_0x5bba86(0x1bf)]()[_0x5bba86(0x1b4)]({'token':Yup[_0x5bba86(0x1b3)]()['required']()['min'](0x2)['test'](_0x5bba86(0x1a6),'This\x20whatsapp\x20token\x20is\x20already\x20used.',async _0x3bc1fc=>{const _0x3628d6=_0x5bba86;if(!_0x3bc1fc)return![];const _0x4b8e58=await Whatsapp_1[_0x3628d6(0x1b7)][_0x3628d6(0x1bd)]({'where':{'token':_0x3bc1fc,'channel':channel}});return!_0x4b8e58;})});try{await _0x2d79b1[_0x5bba86(0x1b9)]({'token':token});}catch(_0x48f7c2){throw new AppError_1[(_0x5bba86(0x1b7))](_0x48f7c2[_0x5bba86(0x1b0)]);}}const _0x93b16c=await Whatsapp_1[_0x5bba86(0x1b7)][_0x5bba86(0x1a0)]({'name':_0x57b8a9,'status':status,'greetingMessage':_0x1ff53b,'complationMessage':_0x39b902,'outOfHoursMessage':_0xbf55d5,'ratingMessage':_0x2d99e4,'isDefault':isDefault,'companyId':_0x14c6ce,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x5de78b,'facebookUserToken':_0xd10835,'facebookPageUserId':_0x44e913,'tokenMeta':_0x3149d1,'maxUseBotQueues':_0x36a643,'timeUseBotQueues':_0x1ef548,'expiresTicket':_0x509707,'allowGroup':allowGroup,'timeSendQueue':_0x2d58cc,'sendIdQueue':_0x2243df,'timeInactiveMessage':_0x223a81,'inactiveMessage':_0x4ac767,'maxUseBotQueuesNPS':_0xd96e0c,'expiresTicketNPS':_0xb5dff1,'whenExpiresTicket':_0x4f37fb,'expiresInactiveMessage':_0x2f4c84,'groupAsTicket':_0x398780,'importOldMessages':_0x147f94,'importRecentMessages':_0x4ee34e,'closedTicketsPostImported':_0x463899,'importOldMessagesGroups':_0x32ce43,'timeCreateNewTicket':_0x1c7f08,'integrationId':_0x59dcb4,'schedules':_0x4f872f},{'include':[_0x5bba86(0x1ad)]});return await(0x0,AssociateWhatsappQueue_1['default'])(_0x93b16c,queueIds),{'whatsapp':_0x93b16c,'oldDefaultWhatsapp':_0x211acd};};exports[a577_0x4dad6b(0x1b7)]=CreateWhatsAppService;function a577_0x5951(){const _0x5896ca=['Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','call','create','../../errors/AppError','connections','writable','__createBinding','whatsapp','Check-token','423680FavAJt','../../models/Whatsapp','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','OPENING','2035625atvEgl','plan','queues','get','1700844EmLIMP','message','count','__importDefault','string','shape','3632993CTlxaM','__importStar','default','28236qIqELr','validate','__esModule','getOwnPropertyDescriptor','defineProperty','findOne','509610VXBSbV','object','prototype','864180YonQCr','../../models/Company','Check-name','required','configurable','beta','update','min','__setModuleDefault'];a577_0x5951=function(){return _0x5896ca;};return a577_0x5951();}