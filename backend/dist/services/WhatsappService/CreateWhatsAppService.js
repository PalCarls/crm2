'use strict';const a536_0x2b206a=a536_0x114b;function a536_0xc292(){const _0x9039ff=['shape','733699gNOuxG','Check-token','../../models/Company','connections','Check-name','This\x20whatsapp\x20token\x20is\x20already\x20used.','__importStar','call','1226864NCzacH','get','5522760HlMjwx','whatsapp','OPENING','hasOwnProperty','10887118ENDhjX','findOne','prototype','8egOAnf','default','265566IoBndW','../../models/Plan','ERR_WAPP_GREETING_REQUIRED','yup','162603JKQHpq','boolean','configurable','10voifwK','../../models/Whatsapp','string','required','plan','beta','defineProperty','__setModuleDefault','459991yMMnoq','length','min','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','count','object','validate','create','6SjOYdz','15izPrkd','__importDefault','queues','__esModule'];a536_0xc292=function(){return _0x9039ff;};return a536_0xc292();}(function(_0xba7ff,_0x34fc4a){const _0x1d7982=a536_0x114b,_0x5a3759=_0xba7ff();while(!![]){try{const _0x50074d=-parseInt(_0x1d7982(0xec))/0x1+parseInt(_0x1d7982(0xf4))/0x2*(parseInt(_0x1d7982(0xe6))/0x3)+parseInt(_0x1d7982(0xf6))/0x4+-parseInt(_0x1d7982(0xe7))/0x5*(parseInt(_0x1d7982(0xff))/0x6)+-parseInt(_0x1d7982(0xdd))/0x7*(parseInt(_0x1d7982(0xfd))/0x8)+parseInt(_0x1d7982(0x103))/0x9+-parseInt(_0x1d7982(0xd5))/0xa*(parseInt(_0x1d7982(0xfa))/0xb);if(_0x50074d===_0x34fc4a)break;else _0x5a3759['push'](_0x5a3759['shift']());}catch(_0x4bfebc){_0x5a3759['push'](_0x5a3759['shift']());}}}(a536_0xc292,0xabcc8));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x2adcc3,_0x412611,_0x30100a,_0x59fe6d){const _0x20b061=a536_0x114b;if(_0x59fe6d===undefined)_0x59fe6d=_0x30100a;var _0x4a40df=Object['getOwnPropertyDescriptor'](_0x412611,_0x30100a);(!_0x4a40df||(_0x20b061(0xf5)in _0x4a40df?!_0x412611[_0x20b061(0xea)]:_0x4a40df['writable']||_0x4a40df[_0x20b061(0x105)]))&&(_0x4a40df={'enumerable':!![],'get':function(){return _0x412611[_0x30100a];}}),Object[_0x20b061(0xdb)](_0x2adcc3,_0x59fe6d,_0x4a40df);}:function(_0x571c10,_0x2c29da,_0x450335,_0x494cc6){if(_0x494cc6===undefined)_0x494cc6=_0x450335;_0x571c10[_0x494cc6]=_0x2c29da[_0x450335];}),__setModuleDefault=this&&this[a536_0x2b206a(0xdc)]||(Object[a536_0x2b206a(0xe5)]?function(_0x409da8,_0xffefbf){const _0x477b70=a536_0x2b206a;Object[_0x477b70(0xdb)](_0x409da8,_0x477b70(0xfe),{'enumerable':!![],'value':_0xffefbf});}:function(_0x2fb81a,_0x13d21d){const _0x39fc9d=a536_0x2b206a;_0x2fb81a[_0x39fc9d(0xfe)]=_0x13d21d;}),__importStar=this&&this[a536_0x2b206a(0xf2)]||function(_0x4e3049){const _0x2caaff=a536_0x2b206a;if(_0x4e3049&&_0x4e3049['__esModule'])return _0x4e3049;var _0x51cbbf={};if(_0x4e3049!=null){for(var _0x2f512d in _0x4e3049)if(_0x2f512d!==_0x2caaff(0xfe)&&Object[_0x2caaff(0xfc)][_0x2caaff(0xf9)][_0x2caaff(0xf3)](_0x4e3049,_0x2f512d))__createBinding(_0x51cbbf,_0x4e3049,_0x2f512d);}return __setModuleDefault(_0x51cbbf,_0x4e3049),_0x51cbbf;},__importDefault=this&&this[a536_0x2b206a(0xe8)]||function(_0x3a3e6c){const _0x214d73=a536_0x2b206a;return _0x3a3e6c&&_0x3a3e6c[_0x214d73(0xea)]?_0x3a3e6c:{'default':_0x3a3e6c};};function a536_0x114b(_0xd2745d,_0xbcfdd4){const _0xc292c2=a536_0xc292();return a536_0x114b=function(_0x114bf9,_0x2fb7d2){_0x114bf9=_0x114bf9-0xd5;let _0x2e807e=_0xc292c2[_0x114bf9];return _0x2e807e;},a536_0x114b(_0xd2745d,_0xbcfdd4);}Object[a536_0x2b206a(0xdb)](exports,a536_0x2b206a(0xea),{'value':!![]});const Yup=__importStar(require(a536_0x2b206a(0x102))),AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a536_0x2b206a(0xd6))),Company_1=__importDefault(require(a536_0x2b206a(0xee))),Plan_1=__importDefault(require(a536_0x2b206a(0x100))),AssociateWhatsappQueue_1=__importDefault(require('./AssociateWhatsappQueue')),CreateWhatsAppService=async({name:_0xb44be7,status:status=a536_0x2b206a(0xf8),queueIds:queueIds=[],greetingMessage:_0x24356b,complationMessage:_0x4719c5,outOfHoursMessage:_0x40f796,isDefault:isDefault=![],companyId:_0x2bad69,token:token='',provider:provider=a536_0x2b206a(0xda),facebookUserId:_0xa1bc2b,facebookUserToken:_0x5e45b6,facebookPageUserId:_0x17e87d,tokenMeta:_0xc26878,channel:channel='whatsapp',maxUseBotQueues:_0x1132da,timeUseBotQueues:_0x3c25fa,expiresTicket:_0x1d31e0,allowGroup:allowGroup=![],timeSendQueue:_0x18b5f4,sendIdQueue:_0x355bb0,timeInactiveMessage:_0x39e882,inactiveMessage:_0x5ac020,ratingMessage:_0x2e34d8,maxUseBotQueuesNPS:_0x355410,expiresTicketNPS:_0x2bde2f,whenExpiresTicket:_0x5f0276,expiresInactiveMessage:_0x49445e,groupAsTicket:_0x2f71ce,importOldMessages:_0x5c52f1,importRecentMessages:_0x22a774,closedTicketsPostImported:_0x410859,importOldMessagesGroups:_0x7f9cfc,timeCreateNewTicket:_0x1e2b77})=>{const _0x4824c8=a536_0x2b206a,_0x283a8b=await Company_1['default'][_0x4824c8(0xfb)]({'where':{'id':_0x2bad69},'include':[{'model':Plan_1[_0x4824c8(0xfe)],'as':_0x4824c8(0xd9)}]});if(_0x283a8b!==null){const _0x5d6731=await Whatsapp_1[_0x4824c8(0xfe)][_0x4824c8(0xe2)]({'where':{'companyId':_0x2bad69,'channel':channel}});if(_0x5d6731>=_0x283a8b[_0x4824c8(0xd9)][_0x4824c8(0xef)])throw new AppError_1[(_0x4824c8(0xfe))](_0x4824c8(0xe0)+_0x5d6731);}const _0x373374=Yup[_0x4824c8(0xe3)]()[_0x4824c8(0xeb)]({'name':Yup[_0x4824c8(0xd7)]()[_0x4824c8(0xd8)]()['min'](0x2)['test'](_0x4824c8(0xf0),_0x4824c8(0xe1),async _0x4f71db=>{if(!_0x4f71db)return![];const _0x2ba0d8=await Whatsapp_1['default']['findOne']({'where':{'name':_0x4f71db,'channel':channel,'companyId':_0x2bad69}});return!_0x2ba0d8;}),'isDefault':Yup[_0x4824c8(0x104)]()[_0x4824c8(0xd8)]()});try{await _0x373374[_0x4824c8(0xe4)]({'name':_0xb44be7,'status':status,'isDefault':isDefault});}catch(_0x266f95){throw new AppError_1[(_0x4824c8(0xfe))](_0x266f95['message']);}const _0xae0d25=await Whatsapp_1['default'][_0x4824c8(0xfb)]({'where':{'companyId':_0x2bad69}});isDefault=channel===_0x4824c8(0xf7)?!_0xae0d25:![];let _0x3963c2=null;channel===_0x4824c8(0xf7)&&isDefault&&(_0x3963c2=await Whatsapp_1['default'][_0x4824c8(0xfb)]({'where':{'isDefault':!![],'companyId':_0x2bad69,'channel':channel}}),_0x3963c2&&await _0x3963c2['update']({'isDefault':![],'companyId':_0x2bad69}));if(queueIds[_0x4824c8(0xde)]>0x1&&!_0x24356b)throw new AppError_1[(_0x4824c8(0xfe))](_0x4824c8(0x101));if(token!==null&&token!==''){const _0x27eb03=Yup[_0x4824c8(0xe3)]()['shape']({'token':Yup[_0x4824c8(0xd7)]()['required']()[_0x4824c8(0xdf)](0x2)['test'](_0x4824c8(0xed),_0x4824c8(0xf1),async _0x57ddd9=>{const _0x125749=_0x4824c8;if(!_0x57ddd9)return![];const _0x4ad247=await Whatsapp_1[_0x125749(0xfe)][_0x125749(0xfb)]({'where':{'token':_0x57ddd9,'channel':channel}});return!_0x4ad247;})});try{await _0x27eb03['validate']({'token':token});}catch(_0x1a263e){throw new AppError_1[(_0x4824c8(0xfe))](_0x1a263e['message']);}}const _0x54c7c1=await Whatsapp_1[_0x4824c8(0xfe)][_0x4824c8(0xe5)]({'name':_0xb44be7,'status':status,'greetingMessage':_0x24356b,'complationMessage':_0x4719c5,'outOfHoursMessage':_0x40f796,'ratingMessage':_0x2e34d8,'isDefault':isDefault,'companyId':_0x2bad69,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0xa1bc2b,'facebookUserToken':_0x5e45b6,'facebookPageUserId':_0x17e87d,'tokenMeta':_0xc26878,'maxUseBotQueues':_0x1132da,'timeUseBotQueues':_0x3c25fa,'expiresTicket':_0x1d31e0,'allowGroup':allowGroup,'timeSendQueue':_0x18b5f4,'sendIdQueue':_0x355bb0,'timeInactiveMessage':_0x39e882,'inactiveMessage':_0x5ac020,'maxUseBotQueuesNPS':_0x355410,'expiresTicketNPS':_0x2bde2f,'whenExpiresTicket':_0x5f0276,'expiresInactiveMessage':_0x49445e,'groupAsTicket':_0x2f71ce,'importOldMessages':_0x5c52f1,'importRecentMessages':_0x22a774,'closedTicketsPostImported':_0x410859,'importOldMessagesGroups':_0x7f9cfc,'timeCreateNewTicket':_0x1e2b77},{'include':[_0x4824c8(0xe9)]});return await(0x0,AssociateWhatsappQueue_1[_0x4824c8(0xfe)])(_0x54c7c1,queueIds),{'whatsapp':_0x54c7c1,'oldDefaultWhatsapp':_0x3963c2};};exports[a536_0x2b206a(0xfe)]=CreateWhatsAppService;