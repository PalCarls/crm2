'use strict';const a638_0xdb71f3=a638_0x29e6;function a638_0x29e6(_0x390322,_0x28f5de){const _0x45d3ca=a638_0x45d3();return a638_0x29e6=function(_0x29e61b,_0x485515){_0x29e61b=_0x29e61b-0x12c;let _0x2ff60e=_0x45d3ca[_0x29e61b];return _0x2ff60e;},a638_0x29e6(_0x390322,_0x28f5de);}(function(_0x2949f2,_0xc0704c){const _0x5b94d7=a638_0x29e6,_0x134542=_0x2949f2();while(!![]){try{const _0x383318=parseInt(_0x5b94d7(0x146))/0x1+parseInt(_0x5b94d7(0x14b))/0x2*(-parseInt(_0x5b94d7(0x151))/0x3)+parseInt(_0x5b94d7(0x14e))/0x4+-parseInt(_0x5b94d7(0x159))/0x5*(-parseInt(_0x5b94d7(0x149))/0x6)+parseInt(_0x5b94d7(0x13b))/0x7+parseInt(_0x5b94d7(0x13c))/0x8+-parseInt(_0x5b94d7(0x136))/0x9*(parseInt(_0x5b94d7(0x153))/0xa);if(_0x383318===_0xc0704c)break;else _0x134542['push'](_0x134542['shift']());}catch(_0x2f921e){_0x134542['push'](_0x134542['shift']());}}}(a638_0x45d3,0xd7a25));function a638_0x45d3(){const _0x1d84c1=['../../models/Plan','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','findOne','__importStar','../../models/Company','481562JTiSwm','boolean','call','2202jdvNTh','This\x20whatsapp\x20token\x20is\x20already\x20used.','18eYyajh','validate','__setModuleDefault','93472WFfVeb','__importDefault','create','458607UIrTiU','required','10QRdogb','__createBinding','whatsapp','__esModule','Check-token','test','445EdtdRO','yup','string','get','plan','beta','ERR_WAPP_GREETING_REQUIRED','queues','connections','defineProperty','Check-name','writable','7202133BMWfKn','default','./AssociateWhatsappQueue','message','shape','5567667ovgrkp','13810568UjsbeF','min','update','object','count'];a638_0x45d3=function(){return _0x1d84c1;};return a638_0x45d3();}var __createBinding=this&&this[a638_0xdb71f3(0x154)]||(Object[a638_0xdb71f3(0x150)]?function(_0x5e341c,_0x4a4365,_0x28dcb5,_0x26ecc5){const _0x117a45=a638_0xdb71f3;if(_0x26ecc5===undefined)_0x26ecc5=_0x28dcb5;var _0x756943=Object['getOwnPropertyDescriptor'](_0x4a4365,_0x28dcb5);(!_0x756943||(_0x117a45(0x12d)in _0x756943?!_0x4a4365[_0x117a45(0x156)]:_0x756943[_0x117a45(0x135)]||_0x756943['configurable']))&&(_0x756943={'enumerable':!![],'get':function(){return _0x4a4365[_0x28dcb5];}}),Object[_0x117a45(0x133)](_0x5e341c,_0x26ecc5,_0x756943);}:function(_0x971d70,_0x5ed03b,_0x14fda3,_0x2dce01){if(_0x2dce01===undefined)_0x2dce01=_0x14fda3;_0x971d70[_0x2dce01]=_0x5ed03b[_0x14fda3];}),__setModuleDefault=this&&this[a638_0xdb71f3(0x14d)]||(Object['create']?function(_0x3e82fd,_0x2d0155){const _0x15afaa=a638_0xdb71f3;Object[_0x15afaa(0x133)](_0x3e82fd,_0x15afaa(0x137),{'enumerable':!![],'value':_0x2d0155});}:function(_0x43e7fb,_0x41d078){const _0x232406=a638_0xdb71f3;_0x43e7fb[_0x232406(0x137)]=_0x41d078;}),__importStar=this&&this[a638_0xdb71f3(0x144)]||function(_0x252d08){const _0x262f76=a638_0xdb71f3;if(_0x252d08&&_0x252d08[_0x262f76(0x156)])return _0x252d08;var _0x33c899={};if(_0x252d08!=null){for(var _0x1bec80 in _0x252d08)if(_0x1bec80!==_0x262f76(0x137)&&Object['prototype']['hasOwnProperty'][_0x262f76(0x148)](_0x252d08,_0x1bec80))__createBinding(_0x33c899,_0x252d08,_0x1bec80);}return __setModuleDefault(_0x33c899,_0x252d08),_0x33c899;},__importDefault=this&&this[a638_0xdb71f3(0x14f)]||function(_0x192105){return _0x192105&&_0x192105['__esModule']?_0x192105:{'default':_0x192105};};Object[a638_0xdb71f3(0x133)](exports,a638_0xdb71f3(0x156),{'value':!![]});const Yup=__importStar(require(a638_0xdb71f3(0x15a))),AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require(a638_0xdb71f3(0x145))),Plan_1=__importDefault(require(a638_0xdb71f3(0x141))),AssociateWhatsappQueue_1=__importDefault(require(a638_0xdb71f3(0x138))),CreateWhatsAppService=async({name:_0x1c8e34,status:status='OPENING',queueIds:queueIds=[],greetingMessage:_0x142ca8,complationMessage:_0x1620f6,outOfHoursMessage:_0x2b6a70,isDefault:isDefault=![],companyId:_0x5edc8a,token:token='',provider:provider=a638_0xdb71f3(0x12f),facebookUserId:_0x4d8ca7,facebookUserToken:_0x3a7b35,facebookPageUserId:_0x4e70e3,tokenMeta:_0x3eee8d,channel:channel=a638_0xdb71f3(0x155),maxUseBotQueues:_0x2d00ae,timeUseBotQueues:_0x50720c,expiresTicket:_0x41613c,allowGroup:allowGroup=![],timeSendQueue:_0x44f98a,sendIdQueue:_0x3c84fb,timeInactiveMessage:_0x458929,inactiveMessage:_0x37deb7,ratingMessage:_0x5b7e43,maxUseBotQueuesNPS:_0x35b7b0,expiresTicketNPS:_0x49d248,whenExpiresTicket:_0x2da23d,expiresInactiveMessage:_0x2fe1cf,groupAsTicket:_0x33c8cd,importOldMessages:_0x21f72b,importRecentMessages:_0x26b393,closedTicketsPostImported:_0x3fdf9b,importOldMessagesGroups:_0x283610,timeCreateNewTicket:_0x279d1e,integrationId:_0x10156f,schedules:_0x52a070,promptId:_0x177f4c,collectiveVacationEnd:_0x1033f9,collectiveVacationMessage:_0x5747f5,collectiveVacationStart:_0x2b4d20})=>{const _0x35e75b=a638_0xdb71f3,_0x48bf34=await Company_1[_0x35e75b(0x137)][_0x35e75b(0x143)]({'where':{'id':_0x5edc8a},'include':[{'model':Plan_1[_0x35e75b(0x137)],'as':_0x35e75b(0x12e)}]});if(_0x48bf34!==null){const _0x54d882=await Whatsapp_1['default'][_0x35e75b(0x140)]({'where':{'companyId':_0x5edc8a,'channel':channel}});if(_0x54d882>=_0x48bf34[_0x35e75b(0x12e)][_0x35e75b(0x132)])throw new AppError_1[(_0x35e75b(0x137))]('Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20'+_0x54d882);}const _0x3c05b8=Yup[_0x35e75b(0x13f)]()['shape']({'name':Yup['string']()[_0x35e75b(0x152)]()[_0x35e75b(0x13d)](0x2)['test'](_0x35e75b(0x134),_0x35e75b(0x142),async _0x439556=>{const _0x16aa0f=_0x35e75b;if(!_0x439556)return![];const _0x500b3d=await Whatsapp_1[_0x16aa0f(0x137)]['findOne']({'where':{'name':_0x439556,'channel':channel,'companyId':_0x5edc8a}});return!_0x500b3d;}),'isDefault':Yup[_0x35e75b(0x147)]()[_0x35e75b(0x152)]()});try{await _0x3c05b8[_0x35e75b(0x14c)]({'name':_0x1c8e34,'status':status,'isDefault':isDefault});}catch(_0x1c3f2a){throw new AppError_1[(_0x35e75b(0x137))](_0x1c3f2a[_0x35e75b(0x139)]);}const _0x3ce218=await Whatsapp_1[_0x35e75b(0x137)][_0x35e75b(0x143)]({'where':{'companyId':_0x5edc8a}});isDefault=channel==='whatsapp'?!_0x3ce218:![];let _0x27f6d7=null;channel===_0x35e75b(0x155)&&isDefault&&(_0x27f6d7=await Whatsapp_1[_0x35e75b(0x137)][_0x35e75b(0x143)]({'where':{'isDefault':!![],'companyId':_0x5edc8a,'channel':channel}}),_0x27f6d7&&await _0x27f6d7[_0x35e75b(0x13e)]({'isDefault':![],'companyId':_0x5edc8a}));if(queueIds['length']>0x1&&!_0x142ca8)throw new AppError_1[(_0x35e75b(0x137))](_0x35e75b(0x130));if(token!==null&&token!==''){const _0x38deab=Yup[_0x35e75b(0x13f)]()[_0x35e75b(0x13a)]({'token':Yup[_0x35e75b(0x12c)]()['required']()[_0x35e75b(0x13d)](0x2)[_0x35e75b(0x158)](_0x35e75b(0x157),_0x35e75b(0x14a),async _0x4ee445=>{if(!_0x4ee445)return![];const _0x454b4d=await Whatsapp_1['default']['findOne']({'where':{'token':_0x4ee445,'channel':channel}});return!_0x454b4d;})});try{await _0x38deab[_0x35e75b(0x14c)]({'token':token});}catch(_0x240176){throw new AppError_1['default'](_0x240176[_0x35e75b(0x139)]);}}const _0xe399d7=await Whatsapp_1['default']['create']({'name':_0x1c8e34,'status':status,'greetingMessage':_0x142ca8,'complationMessage':_0x1620f6,'outOfHoursMessage':_0x2b6a70,'ratingMessage':_0x5b7e43,'isDefault':isDefault,'companyId':_0x5edc8a,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x4d8ca7,'facebookUserToken':_0x3a7b35,'facebookPageUserId':_0x4e70e3,'tokenMeta':_0x3eee8d,'maxUseBotQueues':_0x2d00ae,'timeUseBotQueues':_0x50720c,'expiresTicket':_0x41613c,'allowGroup':allowGroup,'timeSendQueue':_0x44f98a,'sendIdQueue':_0x3c84fb,'timeInactiveMessage':_0x458929,'inactiveMessage':_0x37deb7,'maxUseBotQueuesNPS':_0x35b7b0,'expiresTicketNPS':_0x49d248,'whenExpiresTicket':_0x2da23d,'expiresInactiveMessage':_0x2fe1cf,'groupAsTicket':_0x33c8cd,'importOldMessages':_0x21f72b,'importRecentMessages':_0x26b393,'closedTicketsPostImported':_0x3fdf9b,'importOldMessagesGroups':_0x283610,'timeCreateNewTicket':_0x279d1e,'integrationId':_0x10156f,'schedules':_0x52a070,'promptId':_0x177f4c,'collectiveVacationEnd':_0x1033f9,'collectiveVacationMessage':_0x5747f5,'collectiveVacationStart':_0x2b4d20},{'include':[_0x35e75b(0x131)]});return await(0x0,AssociateWhatsappQueue_1[_0x35e75b(0x137)])(_0xe399d7,queueIds),{'whatsapp':_0xe399d7,'oldDefaultWhatsapp':_0x27f6d7};};exports['default']=CreateWhatsAppService;