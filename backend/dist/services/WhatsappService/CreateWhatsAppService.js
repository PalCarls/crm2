'use strict';const a630_0x2739dd=a630_0x3cfe;function a630_0x280f(){const _0x105822=['22281WjCVNm','default','findOne','yup','__importDefault','min','../../models/Company','Check-token','774142ehIIvS','__setModuleDefault','object','__createBinding','plan','defineProperty','../../models/Plan','connections','whatsapp','6647809JZJSbx','create','length','ERR_WAPP_GREETING_REQUIRED','489210Pgyozb','hasOwnProperty','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','OPENING','validate','../../errors/AppError','beta','shape','prototype','required','string','update','2797890cPWTHT','test','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','./AssociateWhatsappQueue','count','1241400rfWasd','586565pIsifH','getOwnPropertyDescriptor','call','__esModule','message'];a630_0x280f=function(){return _0x105822;};return a630_0x280f();}(function(_0x2cd51c,_0xad1331){const _0x31f620=a630_0x3cfe,_0x17c74d=_0x2cd51c();while(!![]){try{const _0x107d8e=-parseInt(_0x31f620(0x152))/0x1+-parseInt(_0x31f620(0x133))/0x2+parseInt(_0x31f620(0x12b))/0x3+-parseInt(_0x31f620(0x151))/0x4+parseInt(_0x31f620(0x14c))/0x5+parseInt(_0x31f620(0x140))/0x6+parseInt(_0x31f620(0x13c))/0x7;if(_0x107d8e===_0xad1331)break;else _0x17c74d['push'](_0x17c74d['shift']());}catch(_0xd5db5b){_0x17c74d['push'](_0x17c74d['shift']());}}}(a630_0x280f,0x4cb81));var __createBinding=this&&this[a630_0x2739dd(0x136)]||(Object[a630_0x2739dd(0x13d)]?function(_0x2601a2,_0x527cdd,_0x1fe49e,_0x380e8a){const _0x5eac7b=a630_0x2739dd;if(_0x380e8a===undefined)_0x380e8a=_0x1fe49e;var _0x46c757=Object[_0x5eac7b(0x153)](_0x527cdd,_0x1fe49e);(!_0x46c757||('get'in _0x46c757?!_0x527cdd[_0x5eac7b(0x129)]:_0x46c757['writable']||_0x46c757['configurable']))&&(_0x46c757={'enumerable':!![],'get':function(){return _0x527cdd[_0x1fe49e];}}),Object['defineProperty'](_0x2601a2,_0x380e8a,_0x46c757);}:function(_0x13b652,_0x220ade,_0x46f8f5,_0x5329dc){if(_0x5329dc===undefined)_0x5329dc=_0x46f8f5;_0x13b652[_0x5329dc]=_0x220ade[_0x46f8f5];}),__setModuleDefault=this&&this[a630_0x2739dd(0x134)]||(Object['create']?function(_0x5db8f1,_0x53a7df){const _0xc883fa=a630_0x2739dd;Object[_0xc883fa(0x138)](_0x5db8f1,'default',{'enumerable':!![],'value':_0x53a7df});}:function(_0x1b96bd,_0x8b7280){_0x1b96bd['default']=_0x8b7280;}),__importStar=this&&this['__importStar']||function(_0x52658f){const _0x2f757b=a630_0x2739dd;if(_0x52658f&&_0x52658f[_0x2f757b(0x129)])return _0x52658f;var _0x3963e3={};if(_0x52658f!=null){for(var _0x20644f in _0x52658f)if(_0x20644f!==_0x2f757b(0x12c)&&Object[_0x2f757b(0x148)][_0x2f757b(0x141)][_0x2f757b(0x128)](_0x52658f,_0x20644f))__createBinding(_0x3963e3,_0x52658f,_0x20644f);}return __setModuleDefault(_0x3963e3,_0x52658f),_0x3963e3;},__importDefault=this&&this[a630_0x2739dd(0x12f)]||function(_0x422178){const _0x2f0584=a630_0x2739dd;return _0x422178&&_0x422178[_0x2f0584(0x129)]?_0x422178:{'default':_0x422178};};function a630_0x3cfe(_0x3b10ac,_0x42e864){const _0x280f66=a630_0x280f();return a630_0x3cfe=function(_0x3cfef1,_0x24c355){_0x3cfef1=_0x3cfef1-0x128;let _0x3abac9=_0x280f66[_0x3cfef1];return _0x3abac9;},a630_0x3cfe(_0x3b10ac,_0x42e864);}Object[a630_0x2739dd(0x138)](exports,'__esModule',{'value':!![]});const Yup=__importStar(require(a630_0x2739dd(0x12e))),AppError_1=__importDefault(require(a630_0x2739dd(0x145))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require(a630_0x2739dd(0x131))),Plan_1=__importDefault(require(a630_0x2739dd(0x139))),AssociateWhatsappQueue_1=__importDefault(require(a630_0x2739dd(0x14f))),CreateWhatsAppService=async({name:_0x25a565,status:status=a630_0x2739dd(0x143),queueIds:queueIds=[],greetingMessage:_0xe55421,complationMessage:_0x3ceb52,outOfHoursMessage:_0x29cc8d,isDefault:isDefault=![],companyId:_0x2a3db4,token:token='',provider:provider=a630_0x2739dd(0x146),facebookUserId:_0x4fe358,facebookUserToken:_0x56ee74,facebookPageUserId:_0xd29326,tokenMeta:_0x21959e,channel:channel=a630_0x2739dd(0x13b),maxUseBotQueues:_0x18b5d0,timeUseBotQueues:_0x164847,expiresTicket:_0x5a3b54,allowGroup:allowGroup=![],timeSendQueue:_0x219fe9,sendIdQueue:_0x2a3a40,timeInactiveMessage:_0x5c52de,inactiveMessage:_0x1f6c14,ratingMessage:_0x1cda13,maxUseBotQueuesNPS:_0x51afb0,expiresTicketNPS:_0x55c2f3,whenExpiresTicket:_0xb5a3c9,expiresInactiveMessage:_0x4fb358,groupAsTicket:_0x9c06a0,importOldMessages:_0x4bc017,importRecentMessages:_0x48943e,closedTicketsPostImported:_0x9fe93f,importOldMessagesGroups:_0x9131f4,timeCreateNewTicket:_0x31caee,integrationId:_0x443f5d,schedules:_0x38fed5,promptId:_0x232f6d})=>{const _0x1f8632=a630_0x2739dd,_0x37fbbc=await Company_1[_0x1f8632(0x12c)]['findOne']({'where':{'id':_0x2a3db4},'include':[{'model':Plan_1[_0x1f8632(0x12c)],'as':_0x1f8632(0x137)}]});if(_0x37fbbc!==null){const _0x4296b5=await Whatsapp_1[_0x1f8632(0x12c)][_0x1f8632(0x150)]({'where':{'companyId':_0x2a3db4,'channel':channel}});if(_0x4296b5>=_0x37fbbc[_0x1f8632(0x137)][_0x1f8632(0x13a)])throw new AppError_1[(_0x1f8632(0x12c))](_0x1f8632(0x142)+_0x4296b5);}const _0x47c89d=Yup[_0x1f8632(0x135)]()['shape']({'name':Yup['string']()['required']()[_0x1f8632(0x130)](0x2)['test']('Check-name',_0x1f8632(0x14e),async _0x567a8e=>{if(!_0x567a8e)return![];const _0x3ab988=await Whatsapp_1['default']['findOne']({'where':{'name':_0x567a8e,'channel':channel,'companyId':_0x2a3db4}});return!_0x3ab988;}),'isDefault':Yup['boolean']()[_0x1f8632(0x149)]()});try{await _0x47c89d[_0x1f8632(0x144)]({'name':_0x25a565,'status':status,'isDefault':isDefault});}catch(_0x4323ee){throw new AppError_1[(_0x1f8632(0x12c))](_0x4323ee['message']);}const _0x512178=await Whatsapp_1['default'][_0x1f8632(0x12d)]({'where':{'companyId':_0x2a3db4}});isDefault=channel===_0x1f8632(0x13b)?!_0x512178:![];let _0x59b930=null;channel==='whatsapp'&&isDefault&&(_0x59b930=await Whatsapp_1['default'][_0x1f8632(0x12d)]({'where':{'isDefault':!![],'companyId':_0x2a3db4,'channel':channel}}),_0x59b930&&await _0x59b930[_0x1f8632(0x14b)]({'isDefault':![],'companyId':_0x2a3db4}));if(queueIds[_0x1f8632(0x13e)]>0x1&&!_0xe55421)throw new AppError_1[(_0x1f8632(0x12c))](_0x1f8632(0x13f));if(token!==null&&token!==''){const _0x3705f7=Yup['object']()[_0x1f8632(0x147)]({'token':Yup[_0x1f8632(0x14a)]()[_0x1f8632(0x149)]()[_0x1f8632(0x130)](0x2)[_0x1f8632(0x14d)](_0x1f8632(0x132),'This\x20whatsapp\x20token\x20is\x20already\x20used.',async _0x4d6c13=>{const _0x2ee49e=_0x1f8632;if(!_0x4d6c13)return![];const _0x5ceae3=await Whatsapp_1[_0x2ee49e(0x12c)][_0x2ee49e(0x12d)]({'where':{'token':_0x4d6c13,'channel':channel}});return!_0x5ceae3;})});try{await _0x3705f7['validate']({'token':token});}catch(_0x16f712){throw new AppError_1[(_0x1f8632(0x12c))](_0x16f712[_0x1f8632(0x12a)]);}}const _0x228f14=await Whatsapp_1[_0x1f8632(0x12c)][_0x1f8632(0x13d)]({'name':_0x25a565,'status':status,'greetingMessage':_0xe55421,'complationMessage':_0x3ceb52,'outOfHoursMessage':_0x29cc8d,'ratingMessage':_0x1cda13,'isDefault':isDefault,'companyId':_0x2a3db4,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x4fe358,'facebookUserToken':_0x56ee74,'facebookPageUserId':_0xd29326,'tokenMeta':_0x21959e,'maxUseBotQueues':_0x18b5d0,'timeUseBotQueues':_0x164847,'expiresTicket':_0x5a3b54,'allowGroup':allowGroup,'timeSendQueue':_0x219fe9,'sendIdQueue':_0x2a3a40,'timeInactiveMessage':_0x5c52de,'inactiveMessage':_0x1f6c14,'maxUseBotQueuesNPS':_0x51afb0,'expiresTicketNPS':_0x55c2f3,'whenExpiresTicket':_0xb5a3c9,'expiresInactiveMessage':_0x4fb358,'groupAsTicket':_0x9c06a0,'importOldMessages':_0x4bc017,'importRecentMessages':_0x48943e,'closedTicketsPostImported':_0x9fe93f,'importOldMessagesGroups':_0x9131f4,'timeCreateNewTicket':_0x31caee,'integrationId':_0x443f5d,'schedules':_0x38fed5,'promptId':_0x232f6d},{'include':['queues']});return await(0x0,AssociateWhatsappQueue_1[_0x1f8632(0x12c)])(_0x228f14,queueIds),{'whatsapp':_0x228f14,'oldDefaultWhatsapp':_0x59b930};};exports[a630_0x2739dd(0x12c)]=CreateWhatsAppService;