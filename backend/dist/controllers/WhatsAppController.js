'use strict';const a38_0x1b726a=a38_0x2b75;(function(_0x3d8a07,_0x40380f){const _0x39af1d=a38_0x2b75,_0x32781b=_0x3d8a07();while(!![]){try{const _0x3f3981=-parseInt(_0x39af1d(0x1d9))/0x1+-parseInt(_0x39af1d(0x1dc))/0x2+parseInt(_0x39af1d(0x1fd))/0x3+-parseInt(_0x39af1d(0x20f))/0x4*(parseInt(_0x39af1d(0x1e4))/0x5)+parseInt(_0x39af1d(0x212))/0x6+parseInt(_0x39af1d(0x1fb))/0x7*(parseInt(_0x39af1d(0x1f6))/0x8)+parseInt(_0x39af1d(0x1f8))/0x9;if(_0x3f3981===_0x40380f)break;else _0x32781b['push'](_0x32781b['shift']());}catch(_0x2ad67c){_0x32781b['push'](_0x32781b['shift']());}}}(a38_0x1186,0xe44c1));var __importDefault=this&&this['__importDefault']||function(_0x23ec43){const _0x20e1c4=a38_0x2b75;return _0x23ec43&&_0x23ec43[_0x20e1c4(0x1dd)]?_0x23ec43:{'default':_0x23ec43};};Object[a38_0x1b726a(0x1e7)](exports,a38_0x1b726a(0x1dd),{'value':!![]}),exports['restart']=exports[a38_0x1b726a(0x1e9)]=exports[a38_0x1b726a(0x1f3)]=exports[a38_0x1b726a(0x20a)]=exports[a38_0x1b726a(0x1d1)]=exports[a38_0x1b726a(0x1df)]=exports['store']=exports['index']=void 0x0;const socket_1=require(a38_0x1b726a(0x1f7)),cache_1=require(a38_0x1b726a(0x1ff)),wbot_1=require('../libs/wbot'),Whatsapp_1=__importDefault(require(a38_0x1b726a(0x201))),AppError_1=__importDefault(require(a38_0x1b726a(0x1da))),DeleteBaileysService_1=__importDefault(require('../services/BaileysServices/DeleteBaileysService')),ShowCompanyService_1=__importDefault(require(a38_0x1b726a(0x1ed))),graphAPI_1=require(a38_0x1b726a(0x205)),ShowPlanService_1=__importDefault(require(a38_0x1b726a(0x211))),StartWhatsAppSession_1=require(a38_0x1b726a(0x200)),CreateWhatsAppService_1=__importDefault(require(a38_0x1b726a(0x202))),DeleteWhatsAppService_1=__importDefault(require(a38_0x1b726a(0x207))),ListWhatsAppsService_1=__importDefault(require(a38_0x1b726a(0x1f4))),ShowWhatsAppService_1=__importDefault(require('../services/WhatsappService/ShowWhatsAppService')),UpdateWhatsAppService_1=__importDefault(require(a38_0x1b726a(0x1f2))),ImportWhatsAppMessageService_1=require(a38_0x1b726a(0x1f1)),index=async(_0x4a170b,_0x45fd3f)=>{const _0x3c5a1a=a38_0x1b726a,{companyId:_0xaa6a44}=_0x4a170b[_0x3c5a1a(0x1f5)],{session:_0x17e442}=_0x4a170b['query'],_0x480f16=await(0x0,ListWhatsAppsService_1[_0x3c5a1a(0x1fc)])({'companyId':_0xaa6a44,'session':_0x17e442});return _0x45fd3f[_0x3c5a1a(0x1ea)](0xc8)[_0x3c5a1a(0x1d8)](_0x480f16);};exports[a38_0x1b726a(0x1de)]=index;const store=async(_0x8d16c8,_0x454e74)=>{const _0x8c57f2=a38_0x1b726a,{name:_0x5fe3c2,status:_0x7a0298,isDefault:_0x4eb7d6,greetingMessage:_0x418650,complationMessage:_0x3045a4,outOfHoursMessage:_0x12280b,queueIds:_0x30cb8b,token:_0x534285,maxUseBotQueues:_0x28fd66,timeUseBotQueues:_0x3f0cce,expiresTicket:_0x55ff0f,allowGroup:_0xd5b6b1,timeSendQueue:_0x16cd1d,sendIdQueue:_0x22d301,timeInactiveMessage:_0x1f1145,inactiveMessage:_0x5b4754,ratingMessage:_0x4e8502,maxUseBotQueuesNPS:_0x5f0b47,expiresTicketNPS:_0x3d80bc,whenExpiresTicket:_0x61fae4,expiresInactiveMessage:_0x203bfb,importOldMessages:_0x532d30,importRecentMessages:_0x20e7e0,closedTicketsPostImported:_0x4b960c,importOldMessagesGroups:_0x1e0e3b,groupAsTicket:_0x3d22c3,timeCreateNewTicket:_0x41049a}=_0x8d16c8[_0x8c57f2(0x1db)],{companyId:_0x18b3c4}=_0x8d16c8[_0x8c57f2(0x1f5)],_0x181fc6=await(0x0,ShowCompanyService_1[_0x8c57f2(0x1fc)])(_0x18b3c4),_0x56b2da=await(0x0,ShowPlanService_1[_0x8c57f2(0x1fc)])(_0x181fc6['planId']);if(!_0x56b2da[_0x8c57f2(0x1d5)])return _0x454e74[_0x8c57f2(0x1ea)](0x190)['json']({'error':_0x8c57f2(0x1d4)});const {whatsapp:_0x202f8c,oldDefaultWhatsapp:_0x826063}=await(0x0,CreateWhatsAppService_1[_0x8c57f2(0x1fc)])({'name':_0x5fe3c2,'status':_0x7a0298,'isDefault':_0x4eb7d6,'greetingMessage':_0x418650,'complationMessage':_0x3045a4,'outOfHoursMessage':_0x12280b,'queueIds':_0x30cb8b,'companyId':_0x18b3c4,'token':_0x534285,'maxUseBotQueues':_0x28fd66,'timeUseBotQueues':_0x3f0cce,'expiresTicket':_0x55ff0f,'allowGroup':_0xd5b6b1,'timeSendQueue':_0x16cd1d,'sendIdQueue':_0x22d301,'timeInactiveMessage':_0x1f1145,'inactiveMessage':_0x5b4754,'ratingMessage':_0x4e8502,'maxUseBotQueuesNPS':_0x5f0b47,'expiresTicketNPS':_0x3d80bc,'whenExpiresTicket':_0x61fae4,'expiresInactiveMessage':_0x203bfb,'importOldMessages':_0x532d30,'importRecentMessages':_0x20e7e0,'closedTicketsPostImported':_0x4b960c,'importOldMessagesGroups':_0x1e0e3b,'groupAsTicket':_0x3d22c3,'timeCreateNewTicket':_0x41049a});(0x0,StartWhatsAppSession_1[_0x8c57f2(0x1e6)])(_0x202f8c,_0x18b3c4);const _0x47783c=(0x0,socket_1[_0x8c57f2(0x1f0)])();return _0x47783c['emit']('company-'+_0x18b3c4+'-whatsapp',{'action':'update','whatsapp':_0x202f8c}),_0x826063&&_0x47783c[_0x8c57f2(0x20d)]('company-'+_0x18b3c4+_0x8c57f2(0x1fa),{'action':_0x8c57f2(0x20a),'whatsapp':_0x826063}),_0x454e74[_0x8c57f2(0x1ea)](0xc8)['json'](_0x202f8c);};exports[a38_0x1b726a(0x20b)]=store;const storeFacebook=async(_0x1ed83c,_0x3c2e5f)=>{const _0x691c84=a38_0x1b726a;try{const {facebookUserId:_0x225520,facebookUserToken:_0x1090d1,addInstagram:_0x2c7ca5}=_0x1ed83c['body'],{companyId:_0x2749b3}=_0x1ed83c[_0x691c84(0x1f5)],{data:_0x4f5286}=await(0x0,graphAPI_1[_0x691c84(0x20e)])(_0x225520,_0x1090d1);if(_0x4f5286[_0x691c84(0x1ef)]===0x0)return _0x3c2e5f[_0x691c84(0x1ea)](0x190)['json']({'error':'Facebook\x20page\x20not\x20found'});const _0x33d8bc=(0x0,socket_1[_0x691c84(0x1f0)])(),_0x2219e6=[];for await(const _0x2fcbd1 of _0x4f5286){const {name:_0x576d66,access_token:_0x16cea1,id:_0x2cd1e3,instagram_business_account:_0x1720ef}=_0x2fcbd1,_0xaa809d=await(0x0,graphAPI_1['getAccessTokenFromPage'])(_0x16cea1);if(_0x1720ef&&_0x2c7ca5){const {id:_0x17829d,username:_0x1d9c0f,name:_0x2ed121}=_0x1720ef;_0x2219e6[_0x691c84(0x208)]({'companyId':_0x2749b3,'name':'Insta\x20'+(_0x1d9c0f||_0x2ed121),'facebookUserId':_0x225520,'facebookPageUserId':_0x17829d,'facebookUserToken':_0xaa809d,'tokenMeta':_0x1090d1,'isDefault':![],'channel':_0x691c84(0x1d2),'status':_0x691c84(0x1d6),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),_0x2219e6['push']({'companyId':_0x2749b3,'name':_0x576d66,'facebookUserId':_0x225520,'facebookPageUserId':_0x2cd1e3,'facebookUserToken':_0xaa809d,'tokenMeta':_0x1090d1,'isDefault':![],'channel':_0x691c84(0x1d7),'status':_0x691c84(0x1d6),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1['subscribeApp'])(_0x2cd1e3,_0xaa809d);}!_0x1720ef&&(_0x2219e6[_0x691c84(0x208)]({'companyId':_0x2749b3,'name':_0x576d66,'facebookUserId':_0x225520,'facebookPageUserId':_0x2cd1e3,'facebookUserToken':_0xaa809d,'tokenMeta':_0x1090d1,'isDefault':![],'channel':_0x691c84(0x1d7),'status':_0x691c84(0x1d6),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1[_0x691c84(0x1f9)])(_0x2fcbd1['id'],_0xaa809d));}for await(const _0x550ba6 of _0x2219e6){const _0x1d5d21=await Whatsapp_1[_0x691c84(0x1fc)]['findOne']({'where':{'facebookPageUserId':_0x550ba6[_0x691c84(0x1ec)]}});_0x1d5d21&&await _0x1d5d21['update']({..._0x550ba6});if(!_0x1d5d21){const {whatsapp:_0x3fefaf}=await(0x0,CreateWhatsAppService_1[_0x691c84(0x1fc)])(_0x550ba6);_0x33d8bc[_0x691c84(0x20d)]('company-'+_0x2749b3+_0x691c84(0x1fa),{'action':_0x691c84(0x20a),'whatsapp':_0x3fefaf});}}return _0x3c2e5f[_0x691c84(0x1ea)](0xc8);}catch(_0x5db4d7){return console[_0x691c84(0x1fe)](_0x5db4d7),_0x3c2e5f[_0x691c84(0x1ea)](0x190)[_0x691c84(0x1d8)]({'error':_0x691c84(0x203)});}};exports[a38_0x1b726a(0x1df)]=storeFacebook;const show=async(_0x250ec3,_0x454693)=>{const _0x196959=a38_0x1b726a,{whatsappId:_0x36e162}=_0x250ec3['params'],{companyId:_0x248dd5}=_0x250ec3[_0x196959(0x1f5)],{session:_0x5e9657}=_0x250ec3[_0x196959(0x204)],_0x409a24=await(0x0,ShowWhatsAppService_1['default'])(_0x36e162,_0x248dd5,_0x5e9657);return _0x454693['status'](0xc8)['json'](_0x409a24);};exports[a38_0x1b726a(0x1d1)]=show;function a38_0x2b75(_0x2b656f,_0x56cc11){const _0x1186d0=a38_0x1186();return a38_0x2b75=function(_0x2b75c5,_0x487a78){_0x2b75c5=_0x2b75c5-0x1d1;let _0x1046ec=_0x1186d0[_0x2b75c5];return _0x1046ec;},a38_0x2b75(_0x2b656f,_0x56cc11);}const update=async(_0x153dc2,_0x3b229c)=>{const _0x29caff=a38_0x1b726a,{whatsappId:_0x371b3b}=_0x153dc2[_0x29caff(0x1d3)],_0x2439b4=_0x153dc2[_0x29caff(0x1db)],{companyId:_0x1f357d}=_0x153dc2[_0x29caff(0x1f5)],{whatsapp:_0x4e687b,oldDefaultWhatsapp:_0x428a41}=await(0x0,UpdateWhatsAppService_1[_0x29caff(0x1fc)])({'whatsappData':_0x2439b4,'whatsappId':_0x371b3b,'companyId':_0x1f357d}),_0x3f19c1=(0x0,socket_1[_0x29caff(0x1f0)])();return _0x3f19c1[_0x29caff(0x20d)]('company-'+_0x1f357d+'-whatsapp',{'action':_0x29caff(0x20a),'whatsapp':_0x4e687b}),_0x428a41&&_0x3f19c1[_0x29caff(0x20d)](_0x29caff(0x1e1)+_0x1f357d+_0x29caff(0x1fa),{'action':_0x29caff(0x20a),'whatsapp':_0x428a41}),_0x3b229c['status'](0xc8)[_0x29caff(0x1d8)](_0x4e687b);};exports[a38_0x1b726a(0x20a)]=update;function a38_0x1186(){const _0x8bfd5f=['115504RsjPnC','../libs/socket','35592003TyoTxu','subscribeApp','-whatsapp','336rJqgVt','default','330576BwYnWj','log','../libs/cache','../services/WbotServices/StartWhatsAppSession','../models/Whatsapp','../services/WhatsappService/CreateWhatsAppService','Facebook\x20page\x20not\x20found','query','../services/FacebookServices/graphAPI','admin','../services/WhatsappService/DeleteWhatsAppService','push','channel','update','store','delete','emit','getPageProfile','4fSskFe','delFromPattern','../services/PlanService/ShowPlanService','4392624nhGtwW','show','instagram','params','Você\x20não\x20possui\x20permissão\x20para\x20acessar\x20este\x20recurso!','useWhatsapp','CONNECTED','facebook','json','1855497XAzZGy','../errors/AppError','body','2361446OfLTtR','__esModule','index','storeFacebook','cacheLayer','company-','removeWbot','whatsapp','7593310UCDNwA','closeTicketsImported','StartWhatsAppSession','defineProperty','Whatsapp\x20restart.','remove','status','restartWbot','facebookPageUserId','../services/CompanyService/ShowCompanyService','ERR_NO_PERMISSION','length','getIO','../services/WhatsappService/ImportWhatsAppMessageService','../services/WhatsappService/UpdateWhatsAppService','closedTickets','../services/WhatsappService/ListWhatsAppsService','user'];a38_0x1186=function(){return _0x8bfd5f;};return a38_0x1186();}const closedTickets=async(_0x5376c9,_0x2e0fec)=>{const _0x11e9de=a38_0x1b726a,{whatsappId:_0xf0430d}=_0x5376c9[_0x11e9de(0x1d3)];return(0x0,ImportWhatsAppMessageService_1[_0x11e9de(0x1e5)])(_0xf0430d),_0x2e0fec['status'](0xc8)['json'](_0x11e9de(0x1e3));};exports[a38_0x1b726a(0x1f3)]=closedTickets;const remove=async(_0x2d7346,_0x47440e)=>{const _0x486e42=a38_0x1b726a,{whatsappId:_0x249752}=_0x2d7346[_0x486e42(0x1d3)],{companyId:_0x28353a,profile:_0x9577da}=_0x2d7346[_0x486e42(0x1f5)],_0x2ed480=(0x0,socket_1[_0x486e42(0x1f0)])();if(_0x9577da!==_0x486e42(0x206))throw new AppError_1[(_0x486e42(0x1fc))](_0x486e42(0x1ee),0x193);const _0x54f5f4=await(0x0,ShowWhatsAppService_1[_0x486e42(0x1fc)])(_0x249752,_0x28353a);_0x54f5f4[_0x486e42(0x209)]==='whatsapp'&&(await(0x0,DeleteBaileysService_1[_0x486e42(0x1fc)])(_0x249752),await(0x0,DeleteWhatsAppService_1[_0x486e42(0x1fc)])(_0x249752),await cache_1[_0x486e42(0x1e0)][_0x486e42(0x210)]('sessions:'+_0x249752+':*'),(0x0,wbot_1[_0x486e42(0x1e2)])(+_0x249752),_0x2ed480[_0x486e42(0x20d)]('company-'+_0x28353a+'-whatsapp',{'action':'delete','whatsappId':+_0x249752}));if(_0x54f5f4[_0x486e42(0x209)]===_0x486e42(0x1d7)||_0x54f5f4[_0x486e42(0x209)]===_0x486e42(0x1d2)){const {facebookUserToken:_0x891ce1}=_0x54f5f4,_0x2d58ff=await Whatsapp_1[_0x486e42(0x1fc)]['findAll']({'where':{'facebookUserToken':_0x891ce1}});await Whatsapp_1[_0x486e42(0x1fc)]['destroy']({'where':{'facebookUserToken':_0x891ce1}});for await(const _0x7f952a of _0x2d58ff){_0x2ed480['emit']('company-'+_0x28353a+_0x486e42(0x1fa),{'action':_0x486e42(0x20c),'whatsappId':_0x7f952a['id']});}}return _0x47440e[_0x486e42(0x1ea)](0xc8)[_0x486e42(0x1d8)]({'message':'Session\x20disconnected.'});};exports[a38_0x1b726a(0x1e9)]=remove;const restart=async(_0x35037b,_0x1367af)=>{const _0x49baf9=a38_0x1b726a,{companyId:_0x2d103c,profile:_0xd5216b}=_0x35037b[_0x49baf9(0x1f5)];if(_0xd5216b!==_0x49baf9(0x206))throw new AppError_1[(_0x49baf9(0x1fc))](_0x49baf9(0x1ee),0x193);return await(0x0,wbot_1[_0x49baf9(0x1eb)])(_0x2d103c),_0x1367af[_0x49baf9(0x1ea)](0xc8)['json']({'message':_0x49baf9(0x1e8)});};exports['restart']=restart;