'use strict';function a40_0x5e4f(){const _0x5e151e=['admin','ERR_NO_PERMISSION','emit','closedTickets','params','storeFacebook','550822OoPIfg','470RVXlau','../services/FacebookServices/graphAPI','instagram','Insta\x20','remove','getAccessTokenFromPage','company-','planId','removeWbot','-whatsapp','update','body','23778MhlCiM','useWhatsapp','StartWhatsAppSession','__importDefault','1283468JWahqM','status','default','closeTicketsImported','../services/PlanService/ShowPlanService','../services/WhatsappService/DeleteWhatsAppService','3MHSZzZ','delete','../services/CompanyService/ShowCompanyService','findAll','whatsapp','Você\x20não\x20possui\x20permissão\x20para\x20acessar\x20este\x20recurso!','user','../libs/socket','../services/BaileysServices/DeleteBaileysService','destroy','length','facebookPageUserId','../libs/cache','../services/WhatsappService/ListWhatsAppsService','../services/WhatsappService/CreateWhatsAppService','859555LNxMzn','../services/WbotServices/StartWhatsAppSession','4832HvrxoI','restart','getIO','json','../services/WhatsappService/ShowWhatsAppService','channel','facebook','delFromPattern','show','281956rjYUYj','Session\x20disconnected.','718914YRHKhI','__esModule','../libs/wbot','store','CONNECTED','Whatsapp\x20restart.','index','query','Facebook\x20page\x20not\x20found','2072dMjutV','findOne'];a40_0x5e4f=function(){return _0x5e151e;};return a40_0x5e4f();}const a40_0x264c39=a40_0x3c80;(function(_0x56142e,_0x422811){const _0x14e4ee=a40_0x3c80,_0x5919a8=_0x56142e();while(!![]){try{const _0x441a25=parseInt(_0x14e4ee(0xac))/0x1+parseInt(_0x14e4ee(0xbf))/0x2+parseInt(_0x14e4ee(0x92))/0x3*(-parseInt(_0x14e4ee(0x8c))/0x4)+-parseInt(_0x14e4ee(0xa1))/0x5+-parseInt(_0x14e4ee(0xae))/0x6+parseInt(_0x14e4ee(0xb7))/0x7*(parseInt(_0x14e4ee(0xa3))/0x8)+parseInt(_0x14e4ee(0x88))/0x9*(parseInt(_0x14e4ee(0xc0))/0xa);if(_0x441a25===_0x422811)break;else _0x5919a8['push'](_0x5919a8['shift']());}catch(_0x5cd460){_0x5919a8['push'](_0x5919a8['shift']());}}}(a40_0x5e4f,0x3c7b0));function a40_0x3c80(_0x3c2072,_0x16ba0b){const _0x5e4f0a=a40_0x5e4f();return a40_0x3c80=function(_0x3c8088,_0x2de8a0){_0x3c8088=_0x3c8088-0x81;let _0x260503=_0x5e4f0a[_0x3c8088];return _0x260503;},a40_0x3c80(_0x3c2072,_0x16ba0b);}var __importDefault=this&&this[a40_0x264c39(0x8b)]||function(_0x329f9f){const _0x3eefc3=a40_0x264c39;return _0x329f9f&&_0x329f9f[_0x3eefc3(0xaf)]?_0x329f9f:{'default':_0x329f9f};};Object['defineProperty'](exports,a40_0x264c39(0xaf),{'value':!![]}),exports[a40_0x264c39(0xa4)]=exports[a40_0x264c39(0xc4)]=exports[a40_0x264c39(0xbc)]=exports[a40_0x264c39(0x86)]=exports[a40_0x264c39(0xab)]=exports[a40_0x264c39(0xbe)]=exports[a40_0x264c39(0xb1)]=exports[a40_0x264c39(0xb4)]=void 0x0;const socket_1=require(a40_0x264c39(0x99)),cache_1=__importDefault(require(a40_0x264c39(0x9e))),wbot_1=require(a40_0x264c39(0xb0)),Whatsapp_1=__importDefault(require('../models/Whatsapp')),AppError_1=__importDefault(require('../errors/AppError')),DeleteBaileysService_1=__importDefault(require(a40_0x264c39(0x9a))),ShowCompanyService_1=__importDefault(require(a40_0x264c39(0x94))),graphAPI_1=require(a40_0x264c39(0xc1)),ShowPlanService_1=__importDefault(require(a40_0x264c39(0x90))),StartWhatsAppSession_1=require(a40_0x264c39(0xa2)),CreateWhatsAppService_1=__importDefault(require(a40_0x264c39(0xa0))),DeleteWhatsAppService_1=__importDefault(require(a40_0x264c39(0x91))),ListWhatsAppsService_1=__importDefault(require(a40_0x264c39(0x9f))),ShowWhatsAppService_1=__importDefault(require(a40_0x264c39(0xa7))),UpdateWhatsAppService_1=__importDefault(require('../services/WhatsappService/UpdateWhatsAppService')),ImportWhatsAppMessageService_1=require('../services/WhatsappService/ImportWhatsAppMessageService'),index=async(_0x13ae99,_0x1a40ff)=>{const _0x6fc166=a40_0x264c39,{companyId:_0x4cc2c9}=_0x13ae99[_0x6fc166(0x98)],{session:_0x4012d4}=_0x13ae99[_0x6fc166(0xb5)],_0x54394e=await(0x0,ListWhatsAppsService_1[_0x6fc166(0x8e)])({'companyId':_0x4cc2c9,'session':_0x4012d4});return _0x1a40ff[_0x6fc166(0x8d)](0xc8)['json'](_0x54394e);};exports[a40_0x264c39(0xb4)]=index;const store=async(_0x1e7f34,_0x5d7335)=>{const _0x3db5b7=a40_0x264c39,{name:_0x420244,status:_0xfbd03b,isDefault:_0x2ef82d,greetingMessage:_0x1b70a5,complationMessage:_0x2cebbb,outOfHoursMessage:_0x366a11,queueIds:_0x26ab4a,token:_0x1c89e2,maxUseBotQueues:_0x554a5e,timeUseBotQueues:_0x3583e0,expiresTicket:_0x359845,allowGroup:_0x5ab809,timeSendQueue:_0x13bc5c,sendIdQueue:_0x505c5b,timeInactiveMessage:_0xa5a77d,inactiveMessage:_0x4c1acc,ratingMessage:_0x499d45,maxUseBotQueuesNPS:_0x7d0141,expiresTicketNPS:_0x27d30c,whenExpiresTicket:_0xd56e4e,expiresInactiveMessage:_0x5d4133,importOldMessages:_0x33cbe5,importRecentMessages:_0x59fc4d,closedTicketsPostImported:_0x35b656,importOldMessagesGroups:_0x2ca9e9,groupAsTicket:_0x2f6ebe,timeCreateNewTicket:_0x303566}=_0x1e7f34[_0x3db5b7(0x87)],{companyId:_0xf042eb}=_0x1e7f34[_0x3db5b7(0x98)],_0x4816c5=await(0x0,ShowCompanyService_1['default'])(_0xf042eb),_0x82dbb7=await(0x0,ShowPlanService_1[_0x3db5b7(0x8e)])(_0x4816c5[_0x3db5b7(0x83)]);if(!_0x82dbb7[_0x3db5b7(0x89)])return _0x5d7335['status'](0x190)[_0x3db5b7(0xa6)]({'error':_0x3db5b7(0x97)});const {whatsapp:_0x54c0a3,oldDefaultWhatsapp:_0x5d0829}=await(0x0,CreateWhatsAppService_1[_0x3db5b7(0x8e)])({'name':_0x420244,'status':_0xfbd03b,'isDefault':_0x2ef82d,'greetingMessage':_0x1b70a5,'complationMessage':_0x2cebbb,'outOfHoursMessage':_0x366a11,'queueIds':_0x26ab4a,'companyId':_0xf042eb,'token':_0x1c89e2,'maxUseBotQueues':_0x554a5e,'timeUseBotQueues':_0x3583e0,'expiresTicket':_0x359845,'allowGroup':_0x5ab809,'timeSendQueue':_0x13bc5c,'sendIdQueue':_0x505c5b,'timeInactiveMessage':_0xa5a77d,'inactiveMessage':_0x4c1acc,'ratingMessage':_0x499d45,'maxUseBotQueuesNPS':_0x7d0141,'expiresTicketNPS':_0x27d30c,'whenExpiresTicket':_0xd56e4e,'expiresInactiveMessage':_0x5d4133,'importOldMessages':_0x33cbe5,'importRecentMessages':_0x59fc4d,'closedTicketsPostImported':_0x35b656,'importOldMessagesGroups':_0x2ca9e9,'groupAsTicket':_0x2f6ebe,'timeCreateNewTicket':_0x303566});(0x0,StartWhatsAppSession_1[_0x3db5b7(0x8a)])(_0x54c0a3,_0xf042eb);const _0x1a1d64=(0x0,socket_1['getIO'])();return _0x1a1d64[_0x3db5b7(0xbb)](_0x3db5b7(0x82)+_0xf042eb+_0x3db5b7(0x85),{'action':_0x3db5b7(0x86),'whatsapp':_0x54c0a3}),_0x5d0829&&_0x1a1d64[_0x3db5b7(0xbb)](_0x3db5b7(0x82)+_0xf042eb+_0x3db5b7(0x85),{'action':'update','whatsapp':_0x5d0829}),_0x5d7335[_0x3db5b7(0x8d)](0xc8)['json'](_0x54c0a3);};exports[a40_0x264c39(0xb1)]=store;const storeFacebook=async(_0x351d50,_0x175cf0)=>{const _0x9a1ad1=a40_0x264c39;try{const {facebookUserId:_0x46e396,facebookUserToken:_0x2ec655,addInstagram:_0x435fdf}=_0x351d50['body'],{companyId:_0x57df75}=_0x351d50[_0x9a1ad1(0x98)],{data:_0x5b0879}=await(0x0,graphAPI_1['getPageProfile'])(_0x46e396,_0x2ec655);if(_0x5b0879[_0x9a1ad1(0x9c)]===0x0)return _0x175cf0[_0x9a1ad1(0x8d)](0x190)[_0x9a1ad1(0xa6)]({'error':_0x9a1ad1(0xb6)});const _0x3f63a0=(0x0,socket_1[_0x9a1ad1(0xa5)])(),_0x1ba7cd=[];for await(const _0x5bc66b of _0x5b0879){const {name:_0x53306a,access_token:_0x4980be,id:_0x1256fc,instagram_business_account:_0x2a3677}=_0x5bc66b,_0x24a596=await(0x0,graphAPI_1[_0x9a1ad1(0x81)])(_0x4980be);if(_0x2a3677&&_0x435fdf){const {id:_0x5ed018,username:_0x17cdf7,name:_0x1e325b}=_0x2a3677;_0x1ba7cd['push']({'companyId':_0x57df75,'name':_0x9a1ad1(0xc3)+(_0x17cdf7||_0x1e325b),'facebookUserId':_0x46e396,'facebookPageUserId':_0x5ed018,'facebookUserToken':_0x24a596,'tokenMeta':_0x2ec655,'isDefault':![],'channel':_0x9a1ad1(0xc2),'status':'CONNECTED','greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),_0x1ba7cd['push']({'companyId':_0x57df75,'name':_0x53306a,'facebookUserId':_0x46e396,'facebookPageUserId':_0x1256fc,'facebookUserToken':_0x24a596,'tokenMeta':_0x2ec655,'isDefault':![],'channel':_0x9a1ad1(0xa9),'status':_0x9a1ad1(0xb2),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1['subscribeApp'])(_0x1256fc,_0x24a596);}!_0x2a3677&&(_0x1ba7cd['push']({'companyId':_0x57df75,'name':_0x53306a,'facebookUserId':_0x46e396,'facebookPageUserId':_0x1256fc,'facebookUserToken':_0x24a596,'tokenMeta':_0x2ec655,'isDefault':![],'channel':_0x9a1ad1(0xa9),'status':_0x9a1ad1(0xb2),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1['subscribeApp'])(_0x5bc66b['id'],_0x24a596));}for await(const _0x2a995e of _0x1ba7cd){const _0x3ef1a5=await Whatsapp_1['default'][_0x9a1ad1(0xb8)]({'where':{'facebookPageUserId':_0x2a995e[_0x9a1ad1(0x9d)]}});_0x3ef1a5&&await _0x3ef1a5[_0x9a1ad1(0x86)]({..._0x2a995e});if(!_0x3ef1a5){const {whatsapp:_0x3d1b90}=await(0x0,CreateWhatsAppService_1['default'])(_0x2a995e);_0x3f63a0[_0x9a1ad1(0xbb)]('company-'+_0x57df75+'-whatsapp',{'action':_0x9a1ad1(0x86),'whatsapp':_0x3d1b90});}}return _0x175cf0[_0x9a1ad1(0x8d)](0xc8);}catch(_0x1b69c2){return console['log'](_0x1b69c2),_0x175cf0['status'](0x190)[_0x9a1ad1(0xa6)]({'error':_0x9a1ad1(0xb6)});}};exports[a40_0x264c39(0xbe)]=storeFacebook;const show=async(_0x4797bf,_0x21c98b)=>{const _0x4d1989=a40_0x264c39,{whatsappId:_0x277454}=_0x4797bf[_0x4d1989(0xbd)],{companyId:_0x5c1a7d}=_0x4797bf['user'],{session:_0x345b3d}=_0x4797bf[_0x4d1989(0xb5)],_0x47a971=await(0x0,ShowWhatsAppService_1['default'])(_0x277454,_0x5c1a7d,_0x345b3d);return _0x21c98b[_0x4d1989(0x8d)](0xc8)['json'](_0x47a971);};exports['show']=show;const update=async(_0x17ae5a,_0x485bb8)=>{const _0x4385e7=a40_0x264c39,{whatsappId:_0x28c3fd}=_0x17ae5a[_0x4385e7(0xbd)],_0x57ab6c=_0x17ae5a[_0x4385e7(0x87)],{companyId:_0x4177d9}=_0x17ae5a[_0x4385e7(0x98)],{whatsapp:_0x2c1805,oldDefaultWhatsapp:_0x533acd}=await(0x0,UpdateWhatsAppService_1['default'])({'whatsappData':_0x57ab6c,'whatsappId':_0x28c3fd,'companyId':_0x4177d9}),_0x31d740=(0x0,socket_1[_0x4385e7(0xa5)])();return _0x31d740[_0x4385e7(0xbb)]('company-'+_0x4177d9+_0x4385e7(0x85),{'action':_0x4385e7(0x86),'whatsapp':_0x2c1805}),_0x533acd&&_0x31d740['emit']('company-'+_0x4177d9+_0x4385e7(0x85),{'action':_0x4385e7(0x86),'whatsapp':_0x533acd}),_0x485bb8['status'](0xc8)[_0x4385e7(0xa6)](_0x2c1805);};exports[a40_0x264c39(0x86)]=update;const closedTickets=async(_0x24f881,_0x504fcf)=>{const _0x33f529=a40_0x264c39,{whatsappId:_0x3313f5}=_0x24f881[_0x33f529(0xbd)];return(0x0,ImportWhatsAppMessageService_1[_0x33f529(0x8f)])(_0x3313f5),_0x504fcf[_0x33f529(0x8d)](0xc8)[_0x33f529(0xa6)](_0x33f529(0x96));};exports[a40_0x264c39(0xbc)]=closedTickets;const remove=async(_0x2134a,_0x38384d)=>{const _0x14afb2=a40_0x264c39,{whatsappId:_0x4214ed}=_0x2134a[_0x14afb2(0xbd)],{companyId:_0xa70ac8,profile:_0x2735e7}=_0x2134a['user'],_0x54278a=(0x0,socket_1[_0x14afb2(0xa5)])();if(_0x2735e7!==_0x14afb2(0xb9))throw new AppError_1['default']('ERR_NO_PERMISSION',0x193);const _0x150e9e=await(0x0,ShowWhatsAppService_1['default'])(_0x4214ed,_0xa70ac8);_0x150e9e[_0x14afb2(0xa8)]===_0x14afb2(0x96)&&(await(0x0,DeleteBaileysService_1[_0x14afb2(0x8e)])(_0x4214ed),await(0x0,DeleteWhatsAppService_1[_0x14afb2(0x8e)])(_0x4214ed),await cache_1[_0x14afb2(0x8e)][_0x14afb2(0xaa)]('sessions:'+_0x4214ed+':*'),(0x0,wbot_1[_0x14afb2(0x84)])(+_0x4214ed),_0x54278a[_0x14afb2(0xbb)](_0x14afb2(0x82)+_0xa70ac8+_0x14afb2(0x85),{'action':_0x14afb2(0x93),'whatsappId':+_0x4214ed}));if(_0x150e9e[_0x14afb2(0xa8)]==='facebook'||_0x150e9e[_0x14afb2(0xa8)]===_0x14afb2(0xc2)){const {facebookUserToken:_0x41dc59}=_0x150e9e,_0x3e6aa7=await Whatsapp_1['default'][_0x14afb2(0x95)]({'where':{'facebookUserToken':_0x41dc59}});await Whatsapp_1[_0x14afb2(0x8e)][_0x14afb2(0x9b)]({'where':{'facebookUserToken':_0x41dc59}});for await(const _0x2b355a of _0x3e6aa7){_0x54278a['emit'](_0x14afb2(0x82)+_0xa70ac8+'-whatsapp',{'action':_0x14afb2(0x93),'whatsappId':_0x2b355a['id']});}}return _0x38384d[_0x14afb2(0x8d)](0xc8)[_0x14afb2(0xa6)]({'message':_0x14afb2(0xad)});};exports['remove']=remove;const restart=async(_0x2a17e0,_0x1bdb9d)=>{const _0x360adb=a40_0x264c39,{companyId:_0x3dd5de,profile:_0x46645f}=_0x2a17e0['user'];if(_0x46645f!==_0x360adb(0xb9))throw new AppError_1['default'](_0x360adb(0xba),0x193);return await(0x0,wbot_1['restartWbot'])(_0x3dd5de),_0x1bdb9d[_0x360adb(0x8d)](0xc8)[_0x360adb(0xa6)]({'message':_0x360adb(0xb3)});};exports['restart']=restart;