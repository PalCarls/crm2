'use strict';const a39_0x49eec1=a39_0x592d;(function(_0x3ba65c,_0x486f97){const _0x21c9fc=a39_0x592d,_0x513c01=_0x3ba65c();while(!![]){try{const _0x1f21b5=-parseInt(_0x21c9fc(0x1be))/0x1+-parseInt(_0x21c9fc(0x1a9))/0x2+parseInt(_0x21c9fc(0x1a2))/0x3*(parseInt(_0x21c9fc(0x19e))/0x4)+parseInt(_0x21c9fc(0x19b))/0x5+-parseInt(_0x21c9fc(0x1c5))/0x6*(-parseInt(_0x21c9fc(0x1b7))/0x7)+parseInt(_0x21c9fc(0x1a8))/0x8+-parseInt(_0x21c9fc(0x1ce))/0x9*(-parseInt(_0x21c9fc(0x19f))/0xa);if(_0x1f21b5===_0x486f97)break;else _0x513c01['push'](_0x513c01['shift']());}catch(_0x319624){_0x513c01['push'](_0x513c01['shift']());}}}(a39_0xfb51,0x8ade2));var __importDefault=this&&this[a39_0x49eec1(0x1af)]||function(_0x20ff2c){const _0x11b96e=a39_0x49eec1;return _0x20ff2c&&_0x20ff2c[_0x11b96e(0x1c4)]?_0x20ff2c:{'default':_0x20ff2c};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['restart']=exports['remove']=exports[a39_0x49eec1(0x1a7)]=exports[a39_0x49eec1(0x1c1)]=exports[a39_0x49eec1(0x1bf)]=exports[a39_0x49eec1(0x196)]=exports['store']=exports['index']=void 0x0;function a39_0xfb51(){const _0x51c01d=['../libs/socket','body','1525290wFiwnX','emit','admin','36068DciOUQ','2619230zPIcVx','../services/CompanyService/ShowCompanyService','removeWbot','81uxPAdR','subscribeApp','useWhatsapp','facebook','restartWbot','closedTickets','6198664sYdrbe','1715668NLJbeL','destroy','store','query','delFromPattern','ERR_NO_PERMISSION','__importDefault','-whatsapp','delete','length','Insta\x20','../errors/AppError','../libs/cache','../services/WhatsappService/DeleteWhatsAppService','1360016eRsLKb','push','company-','facebookPageUserId','findOne','findAll','json','876771wbtUYb','show','whatsapp','update','index','../services/WhatsappService/ShowWhatsAppService','__esModule','6SKhuyE','channel','../services/WbotServices/StartWhatsAppSession','status','user','../services/WhatsappService/ListWhatsAppsService','../services/WhatsappService/CreateWhatsAppService','restart','params','27yjYMWC','planId','instagram','getIO','closeTicketsImported','CONNECTED','Whatsapp\x20restart.','storeFacebook','default','../services/WhatsappService/UpdateWhatsAppService'];a39_0xfb51=function(){return _0x51c01d;};return a39_0xfb51();}const socket_1=require(a39_0x49eec1(0x199)),cache_1=__importDefault(require(a39_0x49eec1(0x1b5))),wbot_1=require('../libs/wbot'),Whatsapp_1=__importDefault(require('../models/Whatsapp')),AppError_1=__importDefault(require(a39_0x49eec1(0x1b4))),DeleteBaileysService_1=__importDefault(require('../services/BaileysServices/DeleteBaileysService')),ShowCompanyService_1=__importDefault(require(a39_0x49eec1(0x1a0))),graphAPI_1=require('../services/FacebookServices/graphAPI'),ShowPlanService_1=__importDefault(require('../services/PlanService/ShowPlanService')),StartWhatsAppSession_1=require(a39_0x49eec1(0x1c7)),CreateWhatsAppService_1=__importDefault(require(a39_0x49eec1(0x1cb))),DeleteWhatsAppService_1=__importDefault(require(a39_0x49eec1(0x1b6))),ListWhatsAppsService_1=__importDefault(require(a39_0x49eec1(0x1ca))),ShowWhatsAppService_1=__importDefault(require(a39_0x49eec1(0x1c3))),UpdateWhatsAppService_1=__importDefault(require(a39_0x49eec1(0x198))),ImportWhatsAppMessageService_1=require('../services/WhatsappService/ImportWhatsAppMessageService'),index=async(_0x369514,_0x31e2a7)=>{const _0x1a5c8e=a39_0x49eec1,{companyId:_0x2d6170}=_0x369514['user'],{session:_0x2a7280}=_0x369514[_0x1a5c8e(0x1ac)],_0xc53ce0=await(0x0,ListWhatsAppsService_1[_0x1a5c8e(0x197)])({'companyId':_0x2d6170,'session':_0x2a7280});return _0x31e2a7[_0x1a5c8e(0x1c8)](0xc8)['json'](_0xc53ce0);};exports[a39_0x49eec1(0x1c2)]=index;const store=async(_0xb3a6e5,_0x252175)=>{const _0x2a428a=a39_0x49eec1,{name:_0x229667,status:_0x3b17b8,isDefault:_0x30689e,greetingMessage:_0x3f503e,complationMessage:_0xffcde0,outOfHoursMessage:_0x5b69c8,queueIds:_0x534264,token:_0x18747f,maxUseBotQueues:_0x3738de,timeUseBotQueues:_0x1a25e0,expiresTicket:_0x18903b,allowGroup:_0x5b4d40,timeSendQueue:_0x1386ab,sendIdQueue:_0x1fb889,timeInactiveMessage:_0x305f5f,inactiveMessage:_0x48c954,ratingMessage:_0x39c12d,maxUseBotQueuesNPS:_0x135f1e,expiresTicketNPS:_0xf0be99,whenExpiresTicket:_0x24daf8,expiresInactiveMessage:_0x3597ca,importOldMessages:_0x544800,importRecentMessages:_0x2b3d61,closedTicketsPostImported:_0x1f376b,importOldMessagesGroups:_0x1eb7fb,groupAsTicket:_0x45efe1,timeCreateNewTicket:_0x2bc70e}=_0xb3a6e5[_0x2a428a(0x19a)],{companyId:_0x1a5167}=_0xb3a6e5[_0x2a428a(0x1c9)],_0x3be6d1=await(0x0,ShowCompanyService_1[_0x2a428a(0x197)])(_0x1a5167),_0x4b7aad=await(0x0,ShowPlanService_1[_0x2a428a(0x197)])(_0x3be6d1[_0x2a428a(0x1cf)]);if(!_0x4b7aad[_0x2a428a(0x1a4)])return _0x252175['status'](0x190)[_0x2a428a(0x1bd)]({'error':'Você\x20não\x20possui\x20permissão\x20para\x20acessar\x20este\x20recurso!'});const {whatsapp:_0x47b129,oldDefaultWhatsapp:_0x51ca70}=await(0x0,CreateWhatsAppService_1[_0x2a428a(0x197)])({'name':_0x229667,'status':_0x3b17b8,'isDefault':_0x30689e,'greetingMessage':_0x3f503e,'complationMessage':_0xffcde0,'outOfHoursMessage':_0x5b69c8,'queueIds':_0x534264,'companyId':_0x1a5167,'token':_0x18747f,'maxUseBotQueues':_0x3738de,'timeUseBotQueues':_0x1a25e0,'expiresTicket':_0x18903b,'allowGroup':_0x5b4d40,'timeSendQueue':_0x1386ab,'sendIdQueue':_0x1fb889,'timeInactiveMessage':_0x305f5f,'inactiveMessage':_0x48c954,'ratingMessage':_0x39c12d,'maxUseBotQueuesNPS':_0x135f1e,'expiresTicketNPS':_0xf0be99,'whenExpiresTicket':_0x24daf8,'expiresInactiveMessage':_0x3597ca,'importOldMessages':_0x544800,'importRecentMessages':_0x2b3d61,'closedTicketsPostImported':_0x1f376b,'importOldMessagesGroups':_0x1eb7fb,'groupAsTicket':_0x45efe1,'timeCreateNewTicket':_0x2bc70e});(0x0,StartWhatsAppSession_1['StartWhatsAppSession'])(_0x47b129,_0x1a5167);const _0x34c82d=(0x0,socket_1[_0x2a428a(0x192)])();return _0x34c82d[_0x2a428a(0x19c)](_0x2a428a(0x1b9)+_0x1a5167+_0x2a428a(0x1b0),{'action':_0x2a428a(0x1c1),'whatsapp':_0x47b129}),_0x51ca70&&_0x34c82d[_0x2a428a(0x19c)](_0x2a428a(0x1b9)+_0x1a5167+_0x2a428a(0x1b0),{'action':'update','whatsapp':_0x51ca70}),_0x252175[_0x2a428a(0x1c8)](0xc8)['json'](_0x47b129);};exports[a39_0x49eec1(0x1ab)]=store;function a39_0x592d(_0x717871,_0x3a3a5b){const _0xfb5185=a39_0xfb51();return a39_0x592d=function(_0x592d44,_0x1cf35a){_0x592d44=_0x592d44-0x192;let _0x5e86b0=_0xfb5185[_0x592d44];return _0x5e86b0;},a39_0x592d(_0x717871,_0x3a3a5b);}const storeFacebook=async(_0x1c831e,_0x43b188)=>{const _0x45965d=a39_0x49eec1;try{const {facebookUserId:_0x12df95,facebookUserToken:_0x584f08,addInstagram:_0x1f8257}=_0x1c831e[_0x45965d(0x19a)],{companyId:_0x25caf6}=_0x1c831e[_0x45965d(0x1c9)],{data:_0x15457b}=await(0x0,graphAPI_1['getPageProfile'])(_0x12df95,_0x584f08);if(_0x15457b[_0x45965d(0x1b2)]===0x0)return _0x43b188[_0x45965d(0x1c8)](0x190)[_0x45965d(0x1bd)]({'error':'Facebook\x20page\x20not\x20found'});const _0xddd4f7=(0x0,socket_1[_0x45965d(0x192)])(),_0x58a0bc=[];for await(const _0x4e1b40 of _0x15457b){const {name:_0x486b40,access_token:_0x4a90da,id:_0x466612,instagram_business_account:_0x18f3a2}=_0x4e1b40,_0x512ad7=await(0x0,graphAPI_1['getAccessTokenFromPage'])(_0x4a90da);if(_0x18f3a2&&_0x1f8257){const {id:_0x4198d5,username:_0x54ae28,name:_0x1faae0}=_0x18f3a2;_0x58a0bc[_0x45965d(0x1b8)]({'companyId':_0x25caf6,'name':_0x45965d(0x1b3)+(_0x54ae28||_0x1faae0),'facebookUserId':_0x12df95,'facebookPageUserId':_0x4198d5,'facebookUserToken':_0x512ad7,'tokenMeta':_0x584f08,'isDefault':![],'channel':'instagram','status':_0x45965d(0x194),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),_0x58a0bc[_0x45965d(0x1b8)]({'companyId':_0x25caf6,'name':_0x486b40,'facebookUserId':_0x12df95,'facebookPageUserId':_0x466612,'facebookUserToken':_0x512ad7,'tokenMeta':_0x584f08,'isDefault':![],'channel':'facebook','status':_0x45965d(0x194),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1[_0x45965d(0x1a3)])(_0x466612,_0x512ad7);}!_0x18f3a2&&(_0x58a0bc[_0x45965d(0x1b8)]({'companyId':_0x25caf6,'name':_0x486b40,'facebookUserId':_0x12df95,'facebookPageUserId':_0x466612,'facebookUserToken':_0x512ad7,'tokenMeta':_0x584f08,'isDefault':![],'channel':_0x45965d(0x1a5),'status':'CONNECTED','greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1['subscribeApp'])(_0x4e1b40['id'],_0x512ad7));}for await(const _0x154f54 of _0x58a0bc){const _0x311c76=await Whatsapp_1[_0x45965d(0x197)][_0x45965d(0x1bb)]({'where':{'facebookPageUserId':_0x154f54[_0x45965d(0x1ba)]}});_0x311c76&&await _0x311c76[_0x45965d(0x1c1)]({..._0x154f54});if(!_0x311c76){const {whatsapp:_0x4eb018}=await(0x0,CreateWhatsAppService_1[_0x45965d(0x197)])(_0x154f54);_0xddd4f7[_0x45965d(0x19c)](_0x45965d(0x1b9)+_0x25caf6+_0x45965d(0x1b0),{'action':_0x45965d(0x1c1),'whatsapp':_0x4eb018});}}return _0x43b188['status'](0xc8);}catch(_0x31f3fc){return console['log'](_0x31f3fc),_0x43b188[_0x45965d(0x1c8)](0x190)[_0x45965d(0x1bd)]({'error':'Facebook\x20page\x20not\x20found'});}};exports[a39_0x49eec1(0x196)]=storeFacebook;const show=async(_0x5eb9cb,_0x4be199)=>{const _0x2ac167=a39_0x49eec1,{whatsappId:_0x31d433}=_0x5eb9cb[_0x2ac167(0x1cd)],{companyId:_0x3d67ed}=_0x5eb9cb[_0x2ac167(0x1c9)],{session:_0x1009a5}=_0x5eb9cb[_0x2ac167(0x1ac)],_0x2dc58d=await(0x0,ShowWhatsAppService_1['default'])(_0x31d433,_0x3d67ed,_0x1009a5);return _0x4be199[_0x2ac167(0x1c8)](0xc8)[_0x2ac167(0x1bd)](_0x2dc58d);};exports[a39_0x49eec1(0x1bf)]=show;const update=async(_0x193eea,_0x3a3701)=>{const _0x18216d=a39_0x49eec1,{whatsappId:_0x4adafc}=_0x193eea[_0x18216d(0x1cd)],_0x5abec0=_0x193eea[_0x18216d(0x19a)],{companyId:_0x3ef286}=_0x193eea[_0x18216d(0x1c9)],{whatsapp:_0x50a186,oldDefaultWhatsapp:_0x2cffc2}=await(0x0,UpdateWhatsAppService_1[_0x18216d(0x197)])({'whatsappData':_0x5abec0,'whatsappId':_0x4adafc,'companyId':_0x3ef286}),_0x1d94f3=(0x0,socket_1[_0x18216d(0x192)])();return _0x1d94f3['emit'](_0x18216d(0x1b9)+_0x3ef286+_0x18216d(0x1b0),{'action':'update','whatsapp':_0x50a186}),_0x2cffc2&&_0x1d94f3[_0x18216d(0x19c)](_0x18216d(0x1b9)+_0x3ef286+_0x18216d(0x1b0),{'action':'update','whatsapp':_0x2cffc2}),_0x3a3701[_0x18216d(0x1c8)](0xc8)[_0x18216d(0x1bd)](_0x50a186);};exports[a39_0x49eec1(0x1c1)]=update;const closedTickets=async(_0x7f83d4,_0x171625)=>{const _0x3fd92c=a39_0x49eec1,{whatsappId:_0x2e51f3}=_0x7f83d4[_0x3fd92c(0x1cd)];return(0x0,ImportWhatsAppMessageService_1[_0x3fd92c(0x193)])(_0x2e51f3),_0x171625[_0x3fd92c(0x1c8)](0xc8)[_0x3fd92c(0x1bd)](_0x3fd92c(0x1c0));};exports[a39_0x49eec1(0x1a7)]=closedTickets;const remove=async(_0x53bcf2,_0x4633fe)=>{const _0x3e3e48=a39_0x49eec1,{whatsappId:_0xaab78c}=_0x53bcf2[_0x3e3e48(0x1cd)],{companyId:_0x553caf,profile:_0x3b0a4a}=_0x53bcf2['user'],_0x328d35=(0x0,socket_1[_0x3e3e48(0x192)])();if(_0x3b0a4a!==_0x3e3e48(0x19d))throw new AppError_1[(_0x3e3e48(0x197))](_0x3e3e48(0x1ae),0x193);const _0x2eceab=await(0x0,ShowWhatsAppService_1[_0x3e3e48(0x197)])(_0xaab78c,_0x553caf);_0x2eceab[_0x3e3e48(0x1c6)]===_0x3e3e48(0x1c0)&&(await(0x0,DeleteBaileysService_1['default'])(_0xaab78c),await(0x0,DeleteWhatsAppService_1['default'])(_0xaab78c),await cache_1[_0x3e3e48(0x197)][_0x3e3e48(0x1ad)]('sessions:'+_0xaab78c+':*'),(0x0,wbot_1[_0x3e3e48(0x1a1)])(+_0xaab78c),_0x328d35[_0x3e3e48(0x19c)](_0x3e3e48(0x1b9)+_0x553caf+'-whatsapp',{'action':_0x3e3e48(0x1b1),'whatsappId':+_0xaab78c}));if(_0x2eceab[_0x3e3e48(0x1c6)]==='facebook'||_0x2eceab[_0x3e3e48(0x1c6)]===_0x3e3e48(0x1d0)){const {facebookUserToken:_0x3d9005}=_0x2eceab,_0x507d27=await Whatsapp_1[_0x3e3e48(0x197)][_0x3e3e48(0x1bc)]({'where':{'facebookUserToken':_0x3d9005}});await Whatsapp_1['default'][_0x3e3e48(0x1aa)]({'where':{'facebookUserToken':_0x3d9005}});for await(const _0x584b2b of _0x507d27){_0x328d35['emit'](_0x3e3e48(0x1b9)+_0x553caf+_0x3e3e48(0x1b0),{'action':_0x3e3e48(0x1b1),'whatsappId':_0x584b2b['id']});}}return _0x4633fe[_0x3e3e48(0x1c8)](0xc8)[_0x3e3e48(0x1bd)]({'message':'Session\x20disconnected.'});};exports['remove']=remove;const restart=async(_0x5935ca,_0x4d797d)=>{const _0x41f914=a39_0x49eec1,{companyId:_0x2eda7b,profile:_0x1dd152}=_0x5935ca['user'];if(_0x1dd152!==_0x41f914(0x19d))throw new AppError_1[(_0x41f914(0x197))](_0x41f914(0x1ae),0x193);return await(0x0,wbot_1[_0x41f914(0x1a6)])(_0x2eda7b),_0x4d797d['status'](0xc8)['json']({'message':_0x41f914(0x195)});};exports[a39_0x49eec1(0x1cc)]=restart;