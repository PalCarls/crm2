'use strict';const a42_0x34d9ce=a42_0xfc07;(function(_0x31841e,_0x3f6149){const _0x2376c1=a42_0xfc07,_0x50e470=_0x31841e();while(!![]){try{const _0x437ab5=parseInt(_0x2376c1(0x8d))/0x1+parseInt(_0x2376c1(0x9a))/0x2+parseInt(_0x2376c1(0x85))/0x3*(parseInt(_0x2376c1(0x88))/0x4)+-parseInt(_0x2376c1(0x73))/0x5+parseInt(_0x2376c1(0x86))/0x6+parseInt(_0x2376c1(0x8a))/0x7+-parseInt(_0x2376c1(0x79))/0x8;if(_0x437ab5===_0x3f6149)break;else _0x50e470['push'](_0x50e470['shift']());}catch(_0x343ad1){_0x50e470['push'](_0x50e470['shift']());}}}(a42_0x57a6,0x69819));var __importDefault=this&&this['__importDefault']||function(_0x4a1f60){return _0x4a1f60&&_0x4a1f60['__esModule']?_0x4a1f60:{'default':_0x4a1f60};};function a42_0xfc07(_0x296e23,_0x6fd7d6){const _0x57a6e3=a42_0x57a6();return a42_0xfc07=function(_0xfc07d9,_0x20d930){_0xfc07d9=_0xfc07d9-0x67;let _0x31a65d=_0x57a6e3[_0xfc07d9];return _0x31a65d;},a42_0xfc07(_0x296e23,_0x6fd7d6);}Object[a42_0x34d9ce(0x7f)](exports,a42_0x34d9ce(0x6f),{'value':!![]}),exports[a42_0x34d9ce(0x80)]=exports['remove']=exports['closedTickets']=exports[a42_0x34d9ce(0x75)]=exports[a42_0x34d9ce(0x8f)]=exports[a42_0x34d9ce(0x8c)]=exports[a42_0x34d9ce(0x90)]=exports[a42_0x34d9ce(0x92)]=void 0x0;function a42_0x57a6(){const _0xb1f286=['14449784eDVcbZ','../services/FacebookServices/graphAPI','remove','user','json','subscribeApp','defineProperty','restart','log','default','CONNECTED','Whatsapp\x20restart.','117snKvGJ','2369442ZfyGxw','../libs/wbot','77612XtqKBC','planId','2796710TratmC','../services/WhatsappService/UpdateWhatsAppService','storeFacebook','339494aZhOQo','whatsapp','show','store','delFromPattern','index','removeWbot','-whatsapp','Você\x20não\x20possui\x20permissão\x20para\x20acessar\x20este\x20recurso!','../services/CompanyService/ShowCompanyService','channel','useWhatsapp','admin','870800xYkZMa','../services/WhatsappService/DeleteWhatsAppService','emit','company-','destroy','Session\x20disconnected.','delete','length','getAccessTokenFromPage','ERR_NO_PERMISSION','../services/WbotServices/StartWhatsAppSession','../services/BaileysServices/DeleteBaileysService','body','../services/WhatsappService/ShowWhatsAppService','instagram','getIO','restartWbot','params','push','../errors/AppError','status','__esModule','closedTickets','../models/Whatsapp','sessions:','438360Euzsxj','findAll','update','closeTicketsImported','query','../services/WhatsappService/CreateWhatsAppService'];a42_0x57a6=function(){return _0xb1f286;};return a42_0x57a6();}const socket_1=require('../libs/socket'),cache_1=__importDefault(require('../libs/cache')),wbot_1=require(a42_0x34d9ce(0x87)),Whatsapp_1=__importDefault(require(a42_0x34d9ce(0x71))),AppError_1=__importDefault(require(a42_0x34d9ce(0x6d))),DeleteBaileysService_1=__importDefault(require(a42_0x34d9ce(0xa5))),ShowCompanyService_1=__importDefault(require(a42_0x34d9ce(0x96))),graphAPI_1=require(a42_0x34d9ce(0x7a)),ShowPlanService_1=__importDefault(require('../services/PlanService/ShowPlanService')),StartWhatsAppSession_1=require(a42_0x34d9ce(0xa4)),CreateWhatsAppService_1=__importDefault(require(a42_0x34d9ce(0x78))),DeleteWhatsAppService_1=__importDefault(require(a42_0x34d9ce(0x9b))),ListWhatsAppsService_1=__importDefault(require('../services/WhatsappService/ListWhatsAppsService')),ShowWhatsAppService_1=__importDefault(require(a42_0x34d9ce(0x67))),UpdateWhatsAppService_1=__importDefault(require(a42_0x34d9ce(0x8b))),ImportWhatsAppMessageService_1=require('../services/WhatsappService/ImportWhatsAppMessageService'),index=async(_0x5c2432,_0x36567b)=>{const _0x3d9855=a42_0x34d9ce,{companyId:_0x1d704f}=_0x5c2432[_0x3d9855(0x7c)],{session:_0x48eb57}=_0x5c2432[_0x3d9855(0x77)],_0x1ad4e8=await(0x0,ListWhatsAppsService_1[_0x3d9855(0x82)])({'companyId':_0x1d704f,'session':_0x48eb57});return _0x36567b[_0x3d9855(0x6e)](0xc8)['json'](_0x1ad4e8);};exports[a42_0x34d9ce(0x92)]=index;const store=async(_0x5478b5,_0x43cc83)=>{const _0x542561=a42_0x34d9ce,{name:_0x38a43c,status:_0x46f37e,isDefault:_0xef365b,greetingMessage:_0x57146a,complationMessage:_0x462447,outOfHoursMessage:_0x2bd2c7,queueIds:_0x386f43,token:_0xb2b997,maxUseBotQueues:_0x13c1a1,timeUseBotQueues:_0x5bc258,expiresTicket:_0x2b0dc4,allowGroup:_0x3ed26a,timeSendQueue:_0x321e25,sendIdQueue:_0x3ff341,timeInactiveMessage:_0x40e3a8,inactiveMessage:_0x4534e5,ratingMessage:_0x55f384,maxUseBotQueuesNPS:_0x30c01f,expiresTicketNPS:_0x4da2d2,whenExpiresTicket:_0x5261c0,expiresInactiveMessage:_0x10c2e2,importOldMessages:_0x3e0799,importRecentMessages:_0x264927,closedTicketsPostImported:_0x2ec906,importOldMessagesGroups:_0x42b8fc,groupAsTicket:_0x45ea41,timeCreateNewTicket:_0x11297e,schedules:_0x29afd6,promptId:_0x31a101}=_0x5478b5[_0x542561(0xa6)],{companyId:_0x3bf0d3}=_0x5478b5[_0x542561(0x7c)],_0x26ad4d=await(0x0,ShowCompanyService_1[_0x542561(0x82)])(_0x3bf0d3),_0x41592b=await(0x0,ShowPlanService_1['default'])(_0x26ad4d[_0x542561(0x89)]);if(!_0x41592b[_0x542561(0x98)])return _0x43cc83[_0x542561(0x6e)](0x190)[_0x542561(0x7d)]({'error':_0x542561(0x95)});const {whatsapp:_0xa6070d,oldDefaultWhatsapp:_0x4ddbaa}=await(0x0,CreateWhatsAppService_1[_0x542561(0x82)])({'name':_0x38a43c,'status':_0x46f37e,'isDefault':_0xef365b,'greetingMessage':_0x57146a,'complationMessage':_0x462447,'outOfHoursMessage':_0x2bd2c7,'queueIds':_0x386f43,'companyId':_0x3bf0d3,'token':_0xb2b997,'maxUseBotQueues':_0x13c1a1,'timeUseBotQueues':_0x5bc258,'expiresTicket':_0x2b0dc4,'allowGroup':_0x3ed26a,'timeSendQueue':_0x321e25,'sendIdQueue':_0x3ff341,'timeInactiveMessage':_0x40e3a8,'inactiveMessage':_0x4534e5,'ratingMessage':_0x55f384,'maxUseBotQueuesNPS':_0x30c01f,'expiresTicketNPS':_0x4da2d2,'whenExpiresTicket':_0x5261c0,'expiresInactiveMessage':_0x10c2e2,'importOldMessages':_0x3e0799,'importRecentMessages':_0x264927,'closedTicketsPostImported':_0x2ec906,'importOldMessagesGroups':_0x42b8fc,'groupAsTicket':_0x45ea41,'timeCreateNewTicket':_0x11297e,'schedules':_0x29afd6,'promptId':_0x31a101});(0x0,StartWhatsAppSession_1['StartWhatsAppSession'])(_0xa6070d,_0x3bf0d3);const _0x1c6933=(0x0,socket_1[_0x542561(0x69)])();return _0x1c6933['emit'](_0x542561(0x9d)+_0x3bf0d3+_0x542561(0x94),{'action':_0x542561(0x75),'whatsapp':_0xa6070d}),_0x4ddbaa&&_0x1c6933[_0x542561(0x9c)]('company-'+_0x3bf0d3+_0x542561(0x94),{'action':_0x542561(0x75),'whatsapp':_0x4ddbaa}),_0x43cc83[_0x542561(0x6e)](0xc8)[_0x542561(0x7d)](_0xa6070d);};exports[a42_0x34d9ce(0x90)]=store;const storeFacebook=async(_0x12a6f3,_0x272fcb)=>{const _0x3fd34e=a42_0x34d9ce;try{const {facebookUserId:_0xf11603,facebookUserToken:_0x4ba66a,addInstagram:_0x585410}=_0x12a6f3['body'],{companyId:_0x491ae5}=_0x12a6f3[_0x3fd34e(0x7c)],{data:_0x575543}=await(0x0,graphAPI_1['getPageProfile'])(_0xf11603,_0x4ba66a);if(_0x575543[_0x3fd34e(0xa1)]===0x0)return _0x272fcb[_0x3fd34e(0x6e)](0x190)[_0x3fd34e(0x7d)]({'error':'Facebook\x20page\x20not\x20found'});const _0x252444=(0x0,socket_1['getIO'])(),_0x25b2fb=[];for await(const _0x13f7b1 of _0x575543){const {name:_0x2ebfd9,access_token:_0x3143ab,id:_0x5321f9,instagram_business_account:_0x687bc4}=_0x13f7b1,_0x442ca3=await(0x0,graphAPI_1[_0x3fd34e(0xa2)])(_0x3143ab);if(_0x687bc4&&_0x585410){const {id:_0x169c4b,username:_0xf9bc68,name:_0x300711}=_0x687bc4;_0x25b2fb[_0x3fd34e(0x6c)]({'companyId':_0x491ae5,'name':'Insta\x20'+(_0xf9bc68||_0x300711),'facebookUserId':_0xf11603,'facebookPageUserId':_0x169c4b,'facebookUserToken':_0x442ca3,'tokenMeta':_0x4ba66a,'isDefault':![],'channel':_0x3fd34e(0x68),'status':'CONNECTED','greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),_0x25b2fb[_0x3fd34e(0x6c)]({'companyId':_0x491ae5,'name':_0x2ebfd9,'facebookUserId':_0xf11603,'facebookPageUserId':_0x5321f9,'facebookUserToken':_0x442ca3,'tokenMeta':_0x4ba66a,'isDefault':![],'channel':'facebook','status':_0x3fd34e(0x83),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1[_0x3fd34e(0x7e)])(_0x5321f9,_0x442ca3);}!_0x687bc4&&(_0x25b2fb[_0x3fd34e(0x6c)]({'companyId':_0x491ae5,'name':_0x2ebfd9,'facebookUserId':_0xf11603,'facebookPageUserId':_0x5321f9,'facebookUserToken':_0x442ca3,'tokenMeta':_0x4ba66a,'isDefault':![],'channel':'facebook','status':_0x3fd34e(0x83),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1[_0x3fd34e(0x7e)])(_0x13f7b1['id'],_0x442ca3));}for await(const _0x2a005b of _0x25b2fb){const _0x129723=await Whatsapp_1[_0x3fd34e(0x82)]['findOne']({'where':{'facebookPageUserId':_0x2a005b['facebookPageUserId']}});_0x129723&&await _0x129723['update']({..._0x2a005b});if(!_0x129723){const {whatsapp:_0x1f2802}=await(0x0,CreateWhatsAppService_1['default'])(_0x2a005b);_0x252444[_0x3fd34e(0x9c)](_0x3fd34e(0x9d)+_0x491ae5+_0x3fd34e(0x94),{'action':_0x3fd34e(0x75),'whatsapp':_0x1f2802});}}return _0x272fcb[_0x3fd34e(0x6e)](0xc8);}catch(_0x378c14){return console[_0x3fd34e(0x81)](_0x378c14),_0x272fcb['status'](0x190)[_0x3fd34e(0x7d)]({'error':'Facebook\x20page\x20not\x20found'});}};exports[a42_0x34d9ce(0x8c)]=storeFacebook;const show=async(_0x3d7313,_0x3a3f92)=>{const _0x1a2a02=a42_0x34d9ce,{whatsappId:_0x342102}=_0x3d7313['params'],{companyId:_0x4cf9ff}=_0x3d7313['user'],{session:_0x438bab}=_0x3d7313[_0x1a2a02(0x77)],_0x197490=await(0x0,ShowWhatsAppService_1[_0x1a2a02(0x82)])(_0x342102,_0x4cf9ff,_0x438bab);return _0x3a3f92[_0x1a2a02(0x6e)](0xc8)[_0x1a2a02(0x7d)](_0x197490);};exports[a42_0x34d9ce(0x8f)]=show;const update=async(_0x12157b,_0x3f2a26)=>{const _0xc77baf=a42_0x34d9ce,{whatsappId:_0x18c300}=_0x12157b[_0xc77baf(0x6b)],_0xe79914=_0x12157b[_0xc77baf(0xa6)],{companyId:_0x2b0ad2}=_0x12157b['user'],{whatsapp:_0x5514a8,oldDefaultWhatsapp:_0x2eafe6}=await(0x0,UpdateWhatsAppService_1[_0xc77baf(0x82)])({'whatsappData':_0xe79914,'whatsappId':_0x18c300,'companyId':_0x2b0ad2}),_0x4420c4=(0x0,socket_1['getIO'])();return _0x4420c4[_0xc77baf(0x9c)](_0xc77baf(0x9d)+_0x2b0ad2+_0xc77baf(0x94),{'action':_0xc77baf(0x75),'whatsapp':_0x5514a8}),_0x2eafe6&&_0x4420c4[_0xc77baf(0x9c)](_0xc77baf(0x9d)+_0x2b0ad2+'-whatsapp',{'action':_0xc77baf(0x75),'whatsapp':_0x2eafe6}),_0x3f2a26[_0xc77baf(0x6e)](0xc8)[_0xc77baf(0x7d)](_0x5514a8);};exports[a42_0x34d9ce(0x75)]=update;const closedTickets=async(_0x396814,_0x40d4a7)=>{const _0x1dbb1b=a42_0x34d9ce,{whatsappId:_0x510315}=_0x396814['params'];return(0x0,ImportWhatsAppMessageService_1[_0x1dbb1b(0x76)])(_0x510315),_0x40d4a7[_0x1dbb1b(0x6e)](0xc8)['json']('whatsapp');};exports[a42_0x34d9ce(0x70)]=closedTickets;const remove=async(_0x54acf0,_0x358eae)=>{const _0x5bbe46=a42_0x34d9ce,{whatsappId:_0x130607}=_0x54acf0[_0x5bbe46(0x6b)],{companyId:_0x5258f2,profile:_0x4eaf74}=_0x54acf0['user'],_0x3a51b0=(0x0,socket_1[_0x5bbe46(0x69)])();if(_0x4eaf74!==_0x5bbe46(0x99))throw new AppError_1['default'](_0x5bbe46(0xa3),0x193);const _0x26d70d=await(0x0,ShowWhatsAppService_1['default'])(_0x130607,_0x5258f2);_0x26d70d[_0x5bbe46(0x97)]===_0x5bbe46(0x8e)&&(await(0x0,DeleteBaileysService_1['default'])(_0x130607),await(0x0,DeleteWhatsAppService_1[_0x5bbe46(0x82)])(_0x130607),await cache_1[_0x5bbe46(0x82)][_0x5bbe46(0x91)](_0x5bbe46(0x72)+_0x130607+':*'),(0x0,wbot_1[_0x5bbe46(0x93)])(+_0x130607),_0x3a51b0[_0x5bbe46(0x9c)](_0x5bbe46(0x9d)+_0x5258f2+_0x5bbe46(0x94),{'action':_0x5bbe46(0xa0),'whatsappId':+_0x130607}));if(_0x26d70d[_0x5bbe46(0x97)]==='facebook'||_0x26d70d[_0x5bbe46(0x97)]===_0x5bbe46(0x68)){const {facebookUserToken:_0xea502f}=_0x26d70d,_0xdcb521=await Whatsapp_1[_0x5bbe46(0x82)][_0x5bbe46(0x74)]({'where':{'facebookUserToken':_0xea502f}});await Whatsapp_1['default'][_0x5bbe46(0x9e)]({'where':{'facebookUserToken':_0xea502f}});for await(const _0x4607f0 of _0xdcb521){_0x3a51b0[_0x5bbe46(0x9c)](_0x5bbe46(0x9d)+_0x5258f2+_0x5bbe46(0x94),{'action':_0x5bbe46(0xa0),'whatsappId':_0x4607f0['id']});}}return _0x358eae[_0x5bbe46(0x6e)](0xc8)['json']({'message':_0x5bbe46(0x9f)});};exports[a42_0x34d9ce(0x7b)]=remove;const restart=async(_0x49d374,_0x380741)=>{const _0x5be299=a42_0x34d9ce,{companyId:_0x1ce393,profile:_0x546d07}=_0x49d374['user'];if(_0x546d07!=='admin')throw new AppError_1['default']('ERR_NO_PERMISSION',0x193);return await(0x0,wbot_1[_0x5be299(0x6a)])(_0x1ce393),_0x380741['status'](0xc8)[_0x5be299(0x7d)]({'message':_0x5be299(0x84)});};exports[a42_0x34d9ce(0x80)]=restart;