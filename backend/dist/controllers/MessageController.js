<<<<<<< HEAD
'use strict';const a23_0x374d23=a23_0x3df8;(function(_0xa288ef,_0x30c93b){const _0xd659f2=a23_0x3df8,_0x381f7b=_0xa288ef();while(!![]){try{const _0x762bba=parseInt(_0xd659f2(0x179))/0x1*(-parseInt(_0xd659f2(0x1c4))/0x2)+parseInt(_0xd659f2(0x1a5))/0x3*(-parseInt(_0xd659f2(0x18d))/0x4)+parseInt(_0xd659f2(0x193))/0x5+-parseInt(_0xd659f2(0x175))/0x6+-parseInt(_0xd659f2(0x19d))/0x7*(parseInt(_0xd659f2(0x1d0))/0x8)+-parseInt(_0xd659f2(0x184))/0x9+-parseInt(_0xd659f2(0x1bb))/0xa*(-parseInt(_0xd659f2(0x16f))/0xb);if(_0x762bba===_0x30c93b)break;else _0x381f7b['push'](_0x381f7b['shift']());}catch(_0x171480){_0x381f7b['push'](_0x381f7b['shift']());}}}(a23_0x2ed5,0x96353));var __createBinding=this&&this[a23_0x374d23(0x199)]||(Object[a23_0x374d23(0x191)]?function(_0x371e34,_0x179ffe,_0x3e7a79,_0x46a422){const _0x33b445=a23_0x374d23;if(_0x46a422===undefined)_0x46a422=_0x3e7a79;var _0x77662e=Object['getOwnPropertyDescriptor'](_0x179ffe,_0x3e7a79);(!_0x77662e||(_0x33b445(0x196)in _0x77662e?!_0x179ffe[_0x33b445(0x181)]:_0x77662e['writable']||_0x77662e[_0x33b445(0x16a)]))&&(_0x77662e={'enumerable':!![],'get':function(){return _0x179ffe[_0x3e7a79];}}),Object[_0x33b445(0x18a)](_0x371e34,_0x46a422,_0x77662e);}:function(_0x58d27f,_0x3b7145,_0x52126f,_0x3a9031){if(_0x3a9031===undefined)_0x3a9031=_0x52126f;_0x58d27f[_0x3a9031]=_0x3b7145[_0x52126f];}),__setModuleDefault=this&&this[a23_0x374d23(0x1ac)]||(Object[a23_0x374d23(0x191)]?function(_0x21d9ae,_0x2e73ad){const _0x5d56ac=a23_0x374d23;Object[_0x5d56ac(0x18a)](_0x21d9ae,_0x5d56ac(0x174),{'enumerable':!![],'value':_0x2e73ad});}:function(_0x2c354a,_0x40955b){const _0x6fd1bb=a23_0x374d23;_0x2c354a[_0x6fd1bb(0x174)]=_0x40955b;}),__importStar=this&&this[a23_0x374d23(0x169)]||function(_0x2919b9){const _0x511a35=a23_0x374d23;if(_0x2919b9&&_0x2919b9['__esModule'])return _0x2919b9;var _0x25a492={};if(_0x2919b9!=null){for(var _0x1dbc3f in _0x2919b9)if(_0x1dbc3f!==_0x511a35(0x174)&&Object['prototype'][_0x511a35(0x168)]['call'](_0x2919b9,_0x1dbc3f))__createBinding(_0x25a492,_0x2919b9,_0x1dbc3f);}return __setModuleDefault(_0x25a492,_0x2919b9),_0x25a492;},__importDefault=this&&this[a23_0x374d23(0x19f)]||function(_0x13b050){return _0x13b050&&_0x13b050['__esModule']?_0x13b050:{'default':_0x13b050};};Object[a23_0x374d23(0x18a)](exports,'__esModule',{'value':!![]}),exports['send']=exports[a23_0x374d23(0x1db)]=exports[a23_0x374d23(0x1a9)]=exports[a23_0x374d23(0x19b)]=exports[a23_0x374d23(0x17c)]=exports[a23_0x374d23(0x18f)]=exports[a23_0x374d23(0x183)]=void 0x0;const AppError_1=__importDefault(require(a23_0x374d23(0x1b8))),SetTicketMessagesAsRead_1=__importDefault(require(a23_0x374d23(0x17f))),socket_1=require('../libs/socket'),Message_1=__importDefault(require(a23_0x374d23(0x1d6))),Queue_1=__importDefault(require(a23_0x374d23(0x167))),User_1=__importDefault(require(a23_0x374d23(0x1b4))),Whatsapp_1=__importDefault(require(a23_0x374d23(0x186))),jsonwebtoken_1=require(a23_0x374d23(0x1a8)),auth_1=__importDefault(require(a23_0x374d23(0x19c))),path_1=__importDefault(require(a23_0x374d23(0x17d))),lodash_1=require(a23_0x374d23(0x1b2)),ListMessagesService_1=__importDefault(require(a23_0x374d23(0x1c3))),ShowTicketService_1=__importDefault(require(a23_0x374d23(0x172))),DeleteWhatsAppMessage_1=__importDefault(require(a23_0x374d23(0x1cd))),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require('../services/WbotServices/SendWhatsAppMessage')),CreateMessageService_1=__importDefault(require(a23_0x374d23(0x1c1))),sendFacebookMessageMedia_1=require('../services/FacebookServices/sendFacebookMessageMedia'),sendFacebookMessage_1=__importDefault(require(a23_0x374d23(0x1af))),ShowPlanCompanyService_1=__importDefault(require('../services/CompanyService/ShowPlanCompanyService')),ListMessagesServiceAll_1=__importDefault(require(a23_0x374d23(0x1cc))),ShowContactService_1=__importDefault(require('../services/ContactServices/ShowContactService')),FindOrCreateTicketService_1=__importDefault(require(a23_0x374d23(0x1e1))),UpdateTicketService_1=__importDefault(require('../services/TicketServices/UpdateTicketService')),ShowMessageService_1=__importStar(require('../services/MessageServices/ShowMessageService')),CompaniesSettings_1=__importDefault(require('../models/CompaniesSettings')),index=async(_0x4e7a25,_0x4c7c60)=>{const _0x262c12=a23_0x374d23,{ticketId:_0x30c520}=_0x4e7a25[_0x262c12(0x1ab)],{pageNumber:_0x469309,selectedQueues:_0x37f969}=_0x4e7a25[_0x262c12(0x166)],{companyId:_0x3fd817,profile:_0x3268c1}=_0x4e7a25[_0x262c12(0x1aa)];let _0x360158=[];const _0x4134b0=await User_1[_0x262c12(0x174)][_0x262c12(0x16b)](_0x4e7a25[_0x262c12(0x1aa)]['id'],{'include':[{'model':Queue_1['default'],'as':_0x262c12(0x171)}]});_0x37f969?_0x360158=JSON[_0x262c12(0x182)](_0x37f969):_0x4134b0[_0x262c12(0x171)][_0x262c12(0x1d7)](_0x3d818d=>{const _0x522dac=_0x262c12;_0x360158[_0x522dac(0x180)](_0x3d818d['id']);});const {count:_0x5ed5b6,messages:_0x584118,ticket:_0x41a317,hasMore:_0x1daf3a}=await(0x0,ListMessagesService_1[_0x262c12(0x174)])({'pageNumber':_0x469309,'ticketId':_0x30c520,'companyId':_0x3fd817,'queues':_0x360158,'user':_0x4134b0});return _0x41a317['channel']===_0x262c12(0x1dc)&&(0x0,SetTicketMessagesAsRead_1[_0x262c12(0x174)])(_0x41a317),_0x4c7c60['json']({'count':_0x5ed5b6,'messages':_0x584118,'ticket':_0x41a317,'hasMore':_0x1daf3a});};exports[a23_0x374d23(0x183)]=index;function obterNomeEExtensaoDoArquivo(_0x5c32e9){const _0xb62226=a23_0x374d23;var _0x3c8a32=new URL(_0x5c32e9),_0x197834=_0x3c8a32[_0xb62226(0x1dd)],_0xcc13af=_0x197834[_0xb62226(0x1b9)]('/')[_0xb62226(0x1be)](),_0x335010=_0xcc13af['split']('.'),_0x5cb546=_0x335010[0x0],_0x147e78=_0x335010[0x1];return _0x5cb546+'.'+_0x147e78;}const store=async(_0xb491e7,_0x5af946)=>{const _0x417ad1=a23_0x374d23,{ticketId:_0x331609}=_0xb491e7[_0x417ad1(0x1ab)],{body:_0x4cbdd6,quotedMsg:_0x33c613,isPrivate:_0x2eab99,vCard:_0x510a73}=_0xb491e7[_0x417ad1(0x1e2)],_0xed0068=_0xb491e7[_0x417ad1(0x1df)],{companyId:_0x54acbc}=_0xb491e7['user'],_0x3aab35=await(0x0,ShowTicketService_1[_0x417ad1(0x174)])(_0x331609,_0x54acbc);_0x3aab35[_0x417ad1(0x1d5)]===_0x417ad1(0x1dc)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x3aab35);try{if(_0xed0068)await Promise['all'](_0xed0068[_0x417ad1(0x1c6)](async(_0x9fd497,_0x3bbb30)=>{const _0x10f8bc=_0x417ad1;_0x3aab35[_0x10f8bc(0x1d5)]===_0x10f8bc(0x1dc)&&await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x9fd497,'ticket':_0x3aab35,'body':Array[_0x10f8bc(0x1ae)](_0x4cbdd6)?_0x4cbdd6[_0x3bbb30]:_0x4cbdd6,'isPrivate':/\u200d/[_0x10f8bc(0x1e0)](_0x4cbdd6),'isForwarded':![]});if(_0x3aab35[_0x10f8bc(0x1d5)]===_0x10f8bc(0x1c8)||_0x3aab35[_0x10f8bc(0x1d5)]===_0x10f8bc(0x192))try{await(0x0,sendFacebookMessageMedia_1['sendFacebookMessageMedia'])({'media':_0x9fd497,'ticket':_0x3aab35});}catch(_0x22091c){console[_0x10f8bc(0x1da)](_0x22091c);}}));else{_0x3aab35[_0x417ad1(0x1d5)]===_0x417ad1(0x1dc)&&!_0x2eab99&&await(0x0,SendWhatsAppMessage_1[_0x417ad1(0x174)])({'body':_0x4cbdd6,'ticket':_0x3aab35,'quotedMsg':_0x33c613,'isPrivate':_0x2eab99,'vCard':_0x510a73});if(_0x3aab35[_0x417ad1(0x1d5)]===_0x417ad1(0x1dc)&&_0x2eab99){const _0x3d7eda={'wid':_0x417ad1(0x1a1)+_0x3aab35[_0x417ad1(0x178)][_0x417ad1(0x1ba)]()[_0x417ad1(0x16c)]('\x20',''),'ticketId':_0x3aab35['id'],'contactId':undefined,'body':_0x4cbdd6,'fromMe':!![],'mediaType':!(0x0,lodash_1[_0x417ad1(0x1a6)])(_0x510a73)?_0x417ad1(0x1bd):_0x417ad1(0x176),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x3aab35[_0x417ad1(0x190)]?.[_0x417ad1(0x1e3)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':_0x2eab99};await(0x0,CreateMessageService_1[_0x417ad1(0x174)])({'messageData':_0x3d7eda,'companyId':_0x3aab35['companyId']});}(_0x3aab35[_0x417ad1(0x1d5)]===_0x417ad1(0x1c8)||_0x3aab35[_0x417ad1(0x1d5)]===_0x417ad1(0x192))&&await(0x0,sendFacebookMessage_1[_0x417ad1(0x174)])({'body':_0x4cbdd6,'ticket':_0x3aab35,'quotedMsg':_0x33c613});}return _0x5af946[_0x417ad1(0x188)]();}catch(_0x501cde){return console['log'](_0x501cde),_0x5af946[_0x417ad1(0x1c9)](0x190)[_0x417ad1(0x177)]({'error':_0x501cde[_0x417ad1(0x1b7)]});}};exports[a23_0x374d23(0x18f)]=store;const forwardmessage=async(_0x44373c,_0x33863a)=>{const _0x8d006e=a23_0x374d23,_0x3eb486=_0x44373c[_0x8d006e(0x195)]['authorization'],[,_0x450ec7]=_0x3eb486['split']('\x20'),_0x1962ae=(0x0,jsonwebtoken_1[_0x8d006e(0x1d2)])(_0x450ec7,auth_1[_0x8d006e(0x174)]['secret']),{id:_0x2c6248}=_0x44373c['user'],_0x3eef87=await User_1[_0x8d006e(0x174)][_0x8d006e(0x16b)](_0x2c6248),{currentContacts:_0x183fbd,message:_0x5c3215,signMessage:_0xbaa3c4}=_0x44373c['body'],{companyId:_0x393539}=_0x5c3215,_0x4e3631=await CompaniesSettings_1['default']['findOne']({'where':{'companyId':_0x393539}}),_0x364bbf=_0x5c3215[_0x8d006e(0x165)];let _0x5bd5a3;return _0x183fbd['map'](async _0x432b36=>{const _0x2ed73d=_0x8d006e,_0x250bac=await(0x0,ShowContactService_1[_0x2ed73d(0x174)])(_0x432b36['id'],_0x5c3215[_0x2ed73d(0x194)]),_0x487d21=await(0x0,ShowTicketService_1[_0x2ed73d(0x174)])(_0x5c3215[_0x2ed73d(0x19a)],_0x5c3215['companyId']),{ticket:_0x25b31a,isCreated:_0x3dc264}=await(0x0,FindOrCreateTicketService_1[_0x2ed73d(0x174)])(_0x250bac,_0x487d21?.[_0x2ed73d(0x1dc)],0x0,_0x487d21[_0x2ed73d(0x194)],_0x487d21[_0x2ed73d(0x1e5)],_0x3eef87['id'],_0x250bac[_0x2ed73d(0x1b1)]?_0x250bac:null,_0x2ed73d(0x1dc),null,!![],_0x4e3631),_0x847192={'status':_0x25b31a[_0x2ed73d(0x1b1)]?_0x2ed73d(0x1c2):'open','userId':_0x3eef87['id'],'queueId':_0x487d21[_0x2ed73d(0x1e5)]};await(0x0,UpdateTicketService_1[_0x2ed73d(0x174)])({'ticketData':_0x847192,'ticketId':_0x25b31a['id'],'companyId':_0x25b31a[_0x2ed73d(0x194)]});if(_0x487d21['channel']===_0x2ed73d(0x1dc)){if(_0x5c3215[_0x2ed73d(0x1bf)]){_0x5bd5a3='_Encaminhada_';const _0x41b370=_0x5c3215[_0x2ed73d(0x1bf)][_0x2ed73d(0x16c)](':'+process[_0x2ed73d(0x1d9)]['PORT'],''),_0x228368=obterNomeEExtensaoDoArquivo(_0x41b370),_0x3fc8d7=path_1[_0x2ed73d(0x174)][_0x2ed73d(0x1ce)](__dirname,'..','..','..',_0x2ed73d(0x1cf),_0x2ed73d(0x17a)),_0x2dda58=path_1[_0x2ed73d(0x174)][_0x2ed73d(0x1ce)](_0x3fc8d7,_0x2ed73d(0x16e)+_0x487d21[_0x2ed73d(0x194)],_0x228368),_0x307966={'fieldname':_0x2ed73d(0x16d),'originalname':_0x228368,'encoding':'7bit','mimetype':_0x5c3215[_0x2ed73d(0x185)],'filename':_0x228368,'path':_0x2dda58};await(0x0,SendWhatsAppMedia_1[_0x2ed73d(0x174)])({'media':_0x307966,'ticket':_0x25b31a,'body':_0x5bd5a3,'isForwarded':![]});}else _0xbaa3c4?_0x5bd5a3=_0x2ed73d(0x18b)+_0x3eef87[_0x2ed73d(0x1b0)]+'*\x0a\x0a'+_0x5c3215[_0x2ed73d(0x1e2)]:_0x5bd5a3=''+_0x5c3215['body'],await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x5bd5a3,'ticket':_0x25b31a,'quotedMsg':_0x364bbf});}}),_0x33863a[_0x8d006e(0x177)](_0x8d006e(0x1b5));};exports[a23_0x374d23(0x17c)]=forwardmessage;const forwardMessage=async(_0x330d9f,_0x2d7b77)=>{const _0x32aa7a=a23_0x374d23,{quotedMsg:_0x3b1c68,signMessage:_0x46c10a,messageId:_0x5017db,contactId:_0x5f0383}=_0x330d9f[_0x32aa7a(0x1e2)],{id:_0x10d41f,companyId:_0x4dcff9}=_0x330d9f[_0x32aa7a(0x1aa)],_0x2d8a42=await User_1[_0x32aa7a(0x174)][_0x32aa7a(0x16b)](_0x10d41f);if(!_0x5017db||!_0x5f0383)return _0x2d7b77['status'](0xc8)['send'](_0x32aa7a(0x1d4));const _0x6d90e2=await(0x0,ShowMessageService_1[_0x32aa7a(0x174)])(_0x5017db),_0x25da37=await(0x0,ShowContactService_1[_0x32aa7a(0x174)])(_0x5f0383,_0x4dcff9);if(!_0x6d90e2)return _0x2d7b77[_0x32aa7a(0x1c9)](0x194)[_0x32aa7a(0x188)](_0x32aa7a(0x1e4));if(!_0x25da37)return _0x2d7b77['status'](0x194)[_0x32aa7a(0x188)](_0x32aa7a(0x1ca));const _0x4410c0=await CompaniesSettings_1[_0x32aa7a(0x174)][_0x32aa7a(0x1d3)]({'where':{'companyId':_0x4dcff9}}),_0x3c28f7=await(0x0,ShowMessageService_1[_0x32aa7a(0x1c7)])(_0x6d90e2);if(!_0x3c28f7)return _0x2d7b77['status'](0x194)[_0x32aa7a(0x188)](_0x32aa7a(0x17e));const _0xc2baf7=await(0x0,ShowTicketService_1[_0x32aa7a(0x174)])(_0x6d90e2[_0x32aa7a(0x19a)],_0x6d90e2[_0x32aa7a(0x194)]),{ticket:_0x4e7316}=await(0x0,FindOrCreateTicketService_1[_0x32aa7a(0x174)])(_0x25da37,_0xc2baf7?.[_0x32aa7a(0x1dc)],0x0,_0xc2baf7[_0x32aa7a(0x194)],_0xc2baf7[_0x32aa7a(0x1e5)],_0x2d8a42['id'],_0x25da37[_0x32aa7a(0x1b1)]?_0x25da37:null,'whatsapp',null,!![],_0x4410c0);let _0x45a673;(0x0,lodash_1['isNil'])(_0x4e7316?.[_0x32aa7a(0x1e5)])?_0x45a673={'status':_0x4e7316[_0x32aa7a(0x1b1)]?_0x32aa7a(0x1c2):_0x32aa7a(0x1de),'userId':_0x2d8a42['id'],'queueId':_0xc2baf7[_0x32aa7a(0x1e5)]}:_0x45a673={'status':_0x4e7316['isGroup']?_0x32aa7a(0x1c2):_0x32aa7a(0x1de),'userId':_0x2d8a42['id']};await(0x0,UpdateTicketService_1['default'])({'ticketData':_0x45a673,'ticketId':_0x4e7316['id'],'companyId':_0x4e7316[_0x32aa7a(0x194)]});let _0x5f3ffe=_0x6d90e2[_0x32aa7a(0x1e2)];if(_0x6d90e2[_0x32aa7a(0x185)]===_0x32aa7a(0x170)||_0x6d90e2[_0x32aa7a(0x185)]==='extendedTextMessage')await(0x0,SendWhatsAppMessage_1[_0x32aa7a(0x174)])({'body':_0x5f3ffe,'ticket':_0x4e7316,'quotedMsg':_0x3b1c68,'isForwarded':_0x6d90e2['fromMe']?![]:!![]});else{const _0x51a8b7=_0x6d90e2[_0x32aa7a(0x1bf)]['replace'](':'+process[_0x32aa7a(0x1d9)][_0x32aa7a(0x1a0)],''),_0x5d0134=obterNomeEExtensaoDoArquivo(_0x51a8b7);_0x5f3ffe===_0x5d0134&&(_0x5f3ffe='');const _0x1a5c98=path_1[_0x32aa7a(0x174)][_0x32aa7a(0x1ce)](__dirname,'..','..','..',_0x32aa7a(0x1cf),_0x32aa7a(0x17a)),_0x58cb41=path_1[_0x32aa7a(0x174)][_0x32aa7a(0x1ce)](_0x1a5c98,_0x32aa7a(0x16e)+_0x4e7316[_0x32aa7a(0x194)],_0x5d0134),_0x17d9e5={'fieldname':'medias','originalname':_0x5d0134,'encoding':_0x32aa7a(0x187),'mimetype':_0x6d90e2[_0x32aa7a(0x185)],'filename':_0x5d0134,'path':_0x58cb41};await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x17d9e5,'ticket':_0x4e7316,'body':_0x5f3ffe,'isForwarded':_0x6d90e2['fromMe']?![]:!![]});}return _0x2d7b77['send']();};exports[a23_0x374d23(0x19b)]=forwardMessage;function a23_0x2ed5(){const _0x3a2158=['useExternalApi','__importDefault','PORT','PVT','delete','Não\x20foi\x20possível\x20enviar\x20a\x20mensagem,\x20tente\x20novamente\x20em\x20alguns\x20instantes','originalname','186KhSURI','isNil','Mensagem\x20enviada!','jsonwebtoken','remove','user','params','__setModuleDefault','dateStart','isArray','../services/FacebookServices/sendFacebookMessage','name','isGroup','lodash','keys','../models/User','count','length','message','../errors/AppError','split','toString','70qFcQHE','company-','contactMessage','pop','mediaUrl','update','../services/MessageServices/CreateMessageService','group','../services/MessageServices/ListMessagesService','94Fmthge','dateEnd','map','GetWhatsAppFromMessage','facebook','status','Contact\x20not\x20found','Essa\x20empresa\x20não\x20tem\x20permissão\x20para\x20usar\x20a\x20API\x20Externa.\x20Entre\x20em\x20contato\x20com\x20o\x20Suporte\x20para\x20verificar\x20nossos\x20planos!','../services/MessageServices/ListMessagesServiceAll','../services/WbotServices/DeleteWhatsAppMessage','join','backend','51864JHKpvt','authorization','verify','findOne','MessageId\x20or\x20ContactId\x20not\x20found','channel','../models/Message','forEach','emit','env','log','allMe','whatsapp','pathname','open','files','test','../services/TicketServices/FindOrCreateTicketService','body','remoteJid','Message\x20not\x20found','queueId','number','quotedMsgId','query','../models/Queue','hasOwnProperty','__importStar','configurable','findByPk','replace','medias','company','1415117mGrcJq','conversation','queues','../services/TicketServices/ShowTicketService','-appMessage','default','1899780Dfmzbs','extendedTextMessage','json','updatedAt','1196OVYiyq','public','app','forwardmessage','path','Whatsapp\x20from\x20message\x20not\x20found','../helpers/SetTicketMessagesAsRead','push','__esModule','parse','index','2685465Xlicif','mediaType','../models/Whatsapp','7bit','send','O\x20número\x20é\x20obrigatório','defineProperty','*Mensagem\x20encaminhada\x20de\x20','fromMe','5260MEddJx','all','store','contact','create','instagram','4638860iUWIxc','companyId','headers','get','add','messageQueue','__createBinding','ticketId','forwardMessage','../config/auth','497SXBdem'];a23_0x2ed5=function(){return _0x3a2158;};return a23_0x2ed5();}const remove=async(_0x59fbcf,_0x6ed692)=>{const _0x4262a6=a23_0x374d23,{messageId:_0x3f0ede}=_0x59fbcf[_0x4262a6(0x1ab)],{companyId:_0x43449a}=_0x59fbcf[_0x4262a6(0x1aa)],_0x437458=await(0x0,DeleteWhatsAppMessage_1[_0x4262a6(0x174)])(_0x3f0ede),_0x191519=(0x0,socket_1['getIO'])();return _0x437458['isPrivate']&&(await Message_1[_0x4262a6(0x174)]['destroy']({'where':{'id':_0x437458['id']}}),_0x191519['to'](_0x437458[_0x4262a6(0x19a)][_0x4262a6(0x1ba)]())[_0x4262a6(0x1d8)](_0x4262a6(0x1bc)+_0x43449a+_0x4262a6(0x173),{'action':_0x4262a6(0x1a2),'message':_0x437458})),_0x191519['to'](_0x437458['ticketId'][_0x4262a6(0x1ba)]())[_0x4262a6(0x1d8)](_0x4262a6(0x1bc)+_0x43449a+_0x4262a6(0x173),{'action':_0x4262a6(0x1c0),'message':_0x437458}),_0x6ed692[_0x4262a6(0x188)]();};function a23_0x3df8(_0xbd95f6,_0x5d3dad){const _0x2ed5e9=a23_0x2ed5();return a23_0x3df8=function(_0x3df8e2,_0x31534b){_0x3df8e2=_0x3df8e2-0x164;let _0x16b11b=_0x2ed5e9[_0x3df8e2];return _0x16b11b;},a23_0x3df8(_0xbd95f6,_0x5d3dad);}exports['remove']=remove;const allMe=async(_0x444453,_0x42ed2c)=>{const _0x47ed39=a23_0x374d23,_0x5c025a=_0x444453[_0x47ed39(0x166)][_0x47ed39(0x1ad)],_0x5f198d=_0x444453[_0x47ed39(0x166)][_0x47ed39(0x1c5)],_0x5c567d=_0x444453[_0x47ed39(0x166)][_0x47ed39(0x18c)],{companyId:_0x5913a1}=_0x444453['user'],{count:_0x4828e8}=await(0x0,ListMessagesServiceAll_1[_0x47ed39(0x174)])({'companyId':_0x5913a1,'fromMe':_0x5c567d,'dateStart':_0x5c025a,'dateEnd':_0x5f198d});return _0x42ed2c[_0x47ed39(0x177)]({'count':_0x4828e8});};exports[a23_0x374d23(0x1db)]=allMe;const send=async(_0x58d800,_0x3d414f)=>{const _0x20ef8d=a23_0x374d23,_0x284147=_0x58d800['body'],_0x248383=_0x58d800[_0x20ef8d(0x1df)];try{const _0x4fcd37=_0x58d800[_0x20ef8d(0x195)][_0x20ef8d(0x1d1)],[,_0x1e4f67]=_0x4fcd37[_0x20ef8d(0x1b9)]('\x20'),_0xb65ac=await Whatsapp_1[_0x20ef8d(0x174)][_0x20ef8d(0x1d3)]({'where':{'token':_0x1e4f67}}),_0x141345=_0xb65ac[_0x20ef8d(0x194)],_0x7ad96d=await(0x0,ShowPlanCompanyService_1['default'])(_0x141345),_0x27723d=_0x7ad96d['plan'][_0x20ef8d(0x19e)];if(_0x27723d){if(!_0xb65ac)throw new Error('Não\x20foi\x20possível\x20realizar\x20a\x20operação');if(_0x284147[_0x20ef8d(0x164)]===undefined)throw new Error(_0x20ef8d(0x189));const _0x3f6bb7=_0x284147[_0x20ef8d(0x164)],_0xdeee58=_0x284147[_0x20ef8d(0x1e2)];return _0x248383?await Promise[_0x20ef8d(0x18e)](_0x248383[_0x20ef8d(0x1c6)](async _0x32d15f=>{const _0x4af63a=_0x20ef8d;_0x58d800[_0x4af63a(0x17b)]['get'](_0x4af63a(0x171))['messageQueue'][_0x4af63a(0x197)]('SendMessage',{'whatsappId':_0xb65ac['id'],'data':{'number':_0x3f6bb7,'body':_0x32d15f[_0x4af63a(0x1a4)]['replace']('/','-'),'mediaPath':_0x32d15f[_0x4af63a(0x17d)]}},{'removeOnComplete':!![],'attempts':0x3});})):_0x58d800[_0x20ef8d(0x17b)]['get']('queues')[_0x20ef8d(0x198)][_0x20ef8d(0x197)]('SendMessage',{'whatsappId':_0xb65ac['id'],'data':{'number':_0x3f6bb7,'body':_0xdeee58}},{'removeOnComplete':!![],'attempts':0x3}),_0x3d414f[_0x20ef8d(0x188)]({'mensagem':_0x20ef8d(0x1a7)});}return _0x3d414f[_0x20ef8d(0x1c9)](0x190)[_0x20ef8d(0x177)]({'error':_0x20ef8d(0x1cb)});}catch(_0x49c243){console[_0x20ef8d(0x1da)](_0x49c243);if(Object[_0x20ef8d(0x1b3)](_0x49c243)[_0x20ef8d(0x1b6)]===0x0)throw new AppError_1[(_0x20ef8d(0x174))](_0x20ef8d(0x1a3));else throw new AppError_1[(_0x20ef8d(0x174))](_0x49c243[_0x20ef8d(0x1b7)]);}};exports['send']=send;
=======
'use strict';const a23_0x5c3948=a23_0x4c17;(function(_0x239d8c,_0x2f4315){const _0x414120=a23_0x4c17,_0x16e6c2=_0x239d8c();while(!![]){try{const _0x18e497=-parseInt(_0x414120(0x16c))/0x1*(-parseInt(_0x414120(0x16f))/0x2)+-parseInt(_0x414120(0x1c0))/0x3+-parseInt(_0x414120(0x1ac))/0x4+-parseInt(_0x414120(0x185))/0x5*(-parseInt(_0x414120(0x196))/0x6)+-parseInt(_0x414120(0x182))/0x7+-parseInt(_0x414120(0x1b2))/0x8+parseInt(_0x414120(0x151))/0x9*(parseInt(_0x414120(0x1b0))/0xa);if(_0x18e497===_0x2f4315)break;else _0x16e6c2['push'](_0x16e6c2['shift']());}catch(_0x5ccb91){_0x16e6c2['push'](_0x16e6c2['shift']());}}}(a23_0x4866,0x2f809));var __createBinding=this&&this[a23_0x5c3948(0x149)]||(Object[a23_0x5c3948(0x180)]?function(_0x5e09cf,_0x57735d,_0x32d214,_0x521a90){const _0x58a681=a23_0x5c3948;if(_0x521a90===undefined)_0x521a90=_0x32d214;var _0x96065d=Object[_0x58a681(0x18c)](_0x57735d,_0x32d214);(!_0x96065d||('get'in _0x96065d?!_0x57735d[_0x58a681(0x199)]:_0x96065d[_0x58a681(0x15c)]||_0x96065d[_0x58a681(0x16e)]))&&(_0x96065d={'enumerable':!![],'get':function(){return _0x57735d[_0x32d214];}}),Object[_0x58a681(0x1ba)](_0x5e09cf,_0x521a90,_0x96065d);}:function(_0x166ef6,_0x2f40b2,_0x4bc064,_0x4bc95a){if(_0x4bc95a===undefined)_0x4bc95a=_0x4bc064;_0x166ef6[_0x4bc95a]=_0x2f40b2[_0x4bc064];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a23_0x5c3948(0x180)]?function(_0x3b4446,_0x580489){const _0x14fff2=a23_0x5c3948;Object[_0x14fff2(0x1ba)](_0x3b4446,_0x14fff2(0x147),{'enumerable':!![],'value':_0x580489});}:function(_0x52fd7e,_0xdb0916){const _0x10e690=a23_0x5c3948;_0x52fd7e[_0x10e690(0x147)]=_0xdb0916;}),__importStar=this&&this[a23_0x5c3948(0x17f)]||function(_0x1a20a6){const _0x7281b3=a23_0x5c3948;if(_0x1a20a6&&_0x1a20a6['__esModule'])return _0x1a20a6;var _0x539abf={};if(_0x1a20a6!=null){for(var _0x20df95 in _0x1a20a6)if(_0x20df95!=='default'&&Object[_0x7281b3(0x198)][_0x7281b3(0x152)][_0x7281b3(0x1ae)](_0x1a20a6,_0x20df95))__createBinding(_0x539abf,_0x1a20a6,_0x20df95);}return __setModuleDefault(_0x539abf,_0x1a20a6),_0x539abf;},__importDefault=this&&this['__importDefault']||function(_0x4f7015){const _0xccc068=a23_0x5c3948;return _0x4f7015&&_0x4f7015[_0xccc068(0x199)]?_0x4f7015:{'default':_0x4f7015};};Object[a23_0x5c3948(0x1ba)](exports,a23_0x5c3948(0x199),{'value':!![]}),exports['send']=exports[a23_0x5c3948(0x1b7)]=exports[a23_0x5c3948(0x172)]=exports['forwardMessage']=exports[a23_0x5c3948(0x19c)]=exports['store']=exports[a23_0x5c3948(0x160)]=void 0x0;const AppError_1=__importDefault(require('../errors/AppError')),SetTicketMessagesAsRead_1=__importDefault(require(a23_0x5c3948(0x1be))),socket_1=require(a23_0x5c3948(0x158)),Message_1=__importDefault(require(a23_0x5c3948(0x176))),Queue_1=__importDefault(require(a23_0x5c3948(0x19f))),User_1=__importDefault(require(a23_0x5c3948(0x1bf))),Whatsapp_1=__importDefault(require('../models/Whatsapp')),jsonwebtoken_1=require(a23_0x5c3948(0x163)),auth_1=__importDefault(require('../config/auth')),path_1=__importDefault(require(a23_0x5c3948(0x18f))),lodash_1=require(a23_0x5c3948(0x17b)),ListMessagesService_1=__importDefault(require(a23_0x5c3948(0x171))),ShowTicketService_1=__importDefault(require(a23_0x5c3948(0x1a9))),DeleteWhatsAppMessage_1=__importDefault(require(a23_0x5c3948(0x1af))),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a23_0x5c3948(0x1a8))),CreateMessageService_1=__importDefault(require('../services/MessageServices/CreateMessageService')),sendFacebookMessageMedia_1=require(a23_0x5c3948(0x161)),sendFacebookMessage_1=__importDefault(require(a23_0x5c3948(0x187))),ShowPlanCompanyService_1=__importDefault(require('../services/CompanyService/ShowPlanCompanyService')),ListMessagesServiceAll_1=__importDefault(require(a23_0x5c3948(0x1a7))),ShowContactService_1=__importDefault(require('../services/ContactServices/ShowContactService')),FindOrCreateTicketService_1=__importDefault(require(a23_0x5c3948(0x16d))),UpdateTicketService_1=__importDefault(require(a23_0x5c3948(0x154))),ShowMessageService_1=__importStar(require(a23_0x5c3948(0x142))),CompaniesSettings_1=__importDefault(require('../models/CompaniesSettings')),index=async(_0x291800,_0xa5e039)=>{const _0x162eb1=a23_0x5c3948,{ticketId:_0x215ec7}=_0x291800[_0x162eb1(0x189)],{pageNumber:_0x59d2e4,selectedQueues:_0x1f0921}=_0x291800[_0x162eb1(0x1bb)],{companyId:_0x56ebb6,profile:_0x29c420}=_0x291800[_0x162eb1(0x14f)];let _0x8fa0ae=[];const _0x50972c=await User_1[_0x162eb1(0x147)]['findByPk'](_0x291800[_0x162eb1(0x14f)]['id'],{'include':[{'model':Queue_1[_0x162eb1(0x147)],'as':_0x162eb1(0x1a2)}]});_0x1f0921?_0x8fa0ae=JSON['parse'](_0x1f0921):_0x50972c['queues'][_0x162eb1(0x18d)](_0x41957d=>{const _0x47d26b=_0x162eb1;_0x8fa0ae[_0x47d26b(0x1b4)](_0x41957d['id']);});const {count:_0x580902,messages:_0x569030,ticket:_0x4b4d0a,hasMore:_0x5d9ab6}=await(0x0,ListMessagesService_1[_0x162eb1(0x147)])({'pageNumber':_0x59d2e4,'ticketId':_0x215ec7,'companyId':_0x56ebb6,'queues':_0x8fa0ae,'user':_0x50972c});return _0x4b4d0a[_0x162eb1(0x18b)]===_0x162eb1(0x162)&&(0x0,SetTicketMessagesAsRead_1[_0x162eb1(0x147)])(_0x4b4d0a),_0xa5e039[_0x162eb1(0x15f)]({'count':_0x580902,'messages':_0x569030,'ticket':_0x4b4d0a,'hasMore':_0x5d9ab6});};function a23_0x4866(){const _0x11f8bc=['966366lYvdfK','message','messageQueue','mediaType','findOne','../services/MessageServices/ShowMessageService','isNil','forwardMessage','delete','isGroup','default','*\x0a\x0a','__createBinding','useExternalApi','emit','open','toString','join','user','Não\x20foi\x20possível\x20realizar\x20a\x20operação','2703276oxfpGv','hasOwnProperty','map','../services/TicketServices/UpdateTicketService','contactMessage','medias','pathname','../libs/socket','fromMe','public','PORT','writable','keys','headers','json','index','../services/FacebookServices/sendFacebookMessageMedia','whatsapp','jsonwebtoken','ticketId','backend','O\x20número\x20é\x20obrigatório','number','body','findByPk','plan','group','7666oHCWlV','../services/TicketServices/FindOrCreateTicketService','configurable','18sUajoE','app','../services/MessageServices/ListMessagesService','remove','files','status','*Mensagem\x20encaminhada\x20de\x20','../models/Message','all','env','dateStart','isArray','lodash','split','company-','Não\x20foi\x20possível\x20enviar\x20a\x20mensagem,\x20tente\x20novamente\x20em\x20alguns\x20instantes','__importStar','create','log','1974035lgDPIp','-appMessage','test','5ZqJwvp','PVT','../services/FacebookServices/sendFacebookMessage','_Encaminhada_','params','facebook','channel','getOwnPropertyDescriptor','forEach','mediaUrl','path','authorization','company','length','add','get','Mensagem\x20enviada!','928848EVLsqx','queueId','prototype','__esModule','extendedTextMessage','name','forwardmessage','originalname','conversation','../models/Queue','quotedMsgId','secret','queues','dateEnd','7bit','getIO','Message\x20not\x20found','../services/MessageServices/ListMessagesServiceAll','../services/WbotServices/SendWhatsAppMessage','../services/TicketServices/ShowTicketService','updatedAt','companyId','1098152ncnexT','count','call','../services/WbotServices/DeleteWhatsAppMessage','30wtuFLS','verify','413280nWoYwl','isPrivate','push','instagram','destroy','allMe','MessageId\x20or\x20ContactId\x20not\x20found','send','defineProperty','query','Contact\x20not\x20found','contact','../helpers/SetTicketMessagesAsRead','../models/User'];a23_0x4866=function(){return _0x11f8bc;};return a23_0x4866();}exports[a23_0x5c3948(0x160)]=index;function obterNomeEExtensaoDoArquivo(_0x438c7a){const _0x3dd6e5=a23_0x5c3948;var _0x34888f=new URL(_0x438c7a),_0x3b941e=_0x34888f[_0x3dd6e5(0x157)],_0x73014a=_0x3b941e[_0x3dd6e5(0x17c)]('/')['pop'](),_0x49e911=_0x73014a[_0x3dd6e5(0x17c)]('.'),_0x52e90c=_0x49e911[0x0],_0x2279de=_0x49e911[0x1];return _0x52e90c+'.'+_0x2279de;}function a23_0x4c17(_0x240211,_0x472577){const _0x486637=a23_0x4866();return a23_0x4c17=function(_0x4c178d,_0x486cc6){_0x4c178d=_0x4c178d-0x13f;let _0x460084=_0x486637[_0x4c178d];return _0x460084;},a23_0x4c17(_0x240211,_0x472577);}const store=async(_0x5ed06b,_0x1c5715)=>{const _0xb929de=a23_0x5c3948,{ticketId:_0x339b82}=_0x5ed06b['params'],{body:_0x1b4b1c,quotedMsg:_0x92bfad,isPrivate:_0x23cd48,vCard:_0x368cad}=_0x5ed06b[_0xb929de(0x168)],_0x46b4ea=_0x5ed06b[_0xb929de(0x173)],{companyId:_0x4fe7b0}=_0x5ed06b[_0xb929de(0x14f)],_0x29a66d=await(0x0,ShowTicketService_1[_0xb929de(0x147)])(_0x339b82,_0x4fe7b0);_0x29a66d[_0xb929de(0x18b)]===_0xb929de(0x162)&&(0x0,SetTicketMessagesAsRead_1[_0xb929de(0x147)])(_0x29a66d);try{if(_0x46b4ea)await Promise[_0xb929de(0x177)](_0x46b4ea[_0xb929de(0x153)](async(_0x225143,_0x110046)=>{const _0x44fa11=_0xb929de;_0x29a66d[_0x44fa11(0x18b)]===_0x44fa11(0x162)&&await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x225143,'ticket':_0x29a66d,'body':Array[_0x44fa11(0x17a)](_0x1b4b1c)?_0x1b4b1c[_0x110046]:_0x1b4b1c,'isPrivate':/\u200d/[_0x44fa11(0x184)](_0x1b4b1c),'isForwarded':![]});if(_0x29a66d[_0x44fa11(0x18b)]===_0x44fa11(0x18a)||_0x29a66d[_0x44fa11(0x18b)]===_0x44fa11(0x1b5))try{await(0x0,sendFacebookMessageMedia_1['sendFacebookMessageMedia'])({'media':_0x225143,'ticket':_0x29a66d});}catch(_0x1b65cd){console[_0x44fa11(0x181)](_0x1b65cd);}}));else{_0x29a66d['channel']===_0xb929de(0x162)&&!_0x23cd48&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x1b4b1c,'ticket':_0x29a66d,'quotedMsg':_0x92bfad,'isPrivate':_0x23cd48,'vCard':_0x368cad});if(_0x29a66d['channel']==='whatsapp'&&_0x23cd48){const _0x79341a={'wid':_0xb929de(0x186)+_0x29a66d[_0xb929de(0x1aa)][_0xb929de(0x14d)]()['replace']('\x20',''),'ticketId':_0x29a66d['id'],'contactId':undefined,'body':_0x1b4b1c,'fromMe':!![],'mediaType':!(0x0,lodash_1[_0xb929de(0x143)])(_0x368cad)?_0xb929de(0x155):_0xb929de(0x19a),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x29a66d[_0xb929de(0x1bd)]?.['remoteJid'],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':_0x23cd48};await(0x0,CreateMessageService_1[_0xb929de(0x147)])({'messageData':_0x79341a,'companyId':_0x29a66d[_0xb929de(0x1ab)]});}(_0x29a66d[_0xb929de(0x18b)]==='facebook'||_0x29a66d[_0xb929de(0x18b)]===_0xb929de(0x1b5))&&await(0x0,sendFacebookMessage_1[_0xb929de(0x147)])({'body':_0x1b4b1c,'ticket':_0x29a66d,'quotedMsg':_0x92bfad});}return _0x1c5715[_0xb929de(0x1b9)]();}catch(_0x4844b0){return console['log'](_0x4844b0),_0x1c5715[_0xb929de(0x174)](0x190)['json']({'error':_0x4844b0[_0xb929de(0x1c1)]});}};exports['store']=store;const forwardmessage=async(_0x1863d1,_0x3e8ff1)=>{const _0x49d868=a23_0x5c3948,_0x48ecf9=_0x1863d1[_0x49d868(0x15e)][_0x49d868(0x190)],[,_0x37ac79]=_0x48ecf9[_0x49d868(0x17c)]('\x20'),_0x3e3450=(0x0,jsonwebtoken_1[_0x49d868(0x1b1)])(_0x37ac79,auth_1['default'][_0x49d868(0x1a1)]),{id:_0x53596c}=_0x1863d1[_0x49d868(0x14f)],_0x2c484d=await User_1[_0x49d868(0x147)][_0x49d868(0x169)](_0x53596c),{currentContacts:_0x2e6b50,message:_0x11647c,signMessage:_0x1fc1ae}=_0x1863d1[_0x49d868(0x168)],{companyId:_0x2e5e20}=_0x11647c,_0x309992=await CompaniesSettings_1['default'][_0x49d868(0x141)]({'where':{'companyId':_0x2e5e20}}),_0x567a00=_0x11647c[_0x49d868(0x1a0)];let _0x9b56e6;return _0x2e6b50[_0x49d868(0x153)](async _0x413eb7=>{const _0x3b4565=_0x49d868,_0x12e112=await(0x0,ShowContactService_1[_0x3b4565(0x147)])(_0x413eb7['id'],_0x11647c[_0x3b4565(0x1ab)]),_0x52e78b=await(0x0,ShowTicketService_1[_0x3b4565(0x147)])(_0x11647c[_0x3b4565(0x164)],_0x11647c[_0x3b4565(0x1ab)]),{ticket:_0x2181f8,isCreated:_0x130d20}=await(0x0,FindOrCreateTicketService_1[_0x3b4565(0x147)])(_0x12e112,_0x52e78b?.['whatsapp'],0x0,_0x52e78b['companyId'],_0x52e78b[_0x3b4565(0x197)],_0x2c484d['id'],_0x12e112[_0x3b4565(0x146)]?_0x12e112:null,_0x3b4565(0x162),null,!![],_0x309992),_0x132987={'status':_0x2181f8['isGroup']?'group':'open','userId':_0x2c484d['id'],'queueId':_0x52e78b[_0x3b4565(0x197)]};await(0x0,UpdateTicketService_1[_0x3b4565(0x147)])({'ticketData':_0x132987,'ticketId':_0x2181f8['id'],'companyId':_0x2181f8[_0x3b4565(0x1ab)]});if(_0x52e78b['channel']==='whatsapp'){if(_0x11647c[_0x3b4565(0x18e)]){_0x9b56e6=_0x3b4565(0x188);const _0x2a8caf=_0x11647c[_0x3b4565(0x18e)]['replace'](':'+process[_0x3b4565(0x178)][_0x3b4565(0x15b)],''),_0x5b7828=obterNomeEExtensaoDoArquivo(_0x2a8caf),_0x1ccc28=path_1[_0x3b4565(0x147)]['join'](__dirname,'..','..','..','backend',_0x3b4565(0x15a)),_0x3b4457=path_1[_0x3b4565(0x147)][_0x3b4565(0x14e)](_0x1ccc28,_0x3b4565(0x191)+_0x52e78b['companyId'],_0x5b7828),_0x483af8={'fieldname':'medias','originalname':_0x5b7828,'encoding':_0x3b4565(0x1a4),'mimetype':_0x11647c['mediaType'],'filename':_0x5b7828,'path':_0x3b4457};await(0x0,SendWhatsAppMedia_1[_0x3b4565(0x147)])({'media':_0x483af8,'ticket':_0x2181f8,'body':_0x9b56e6,'isForwarded':![]});}else _0x1fc1ae?_0x9b56e6=_0x3b4565(0x175)+_0x2c484d[_0x3b4565(0x19b)]+_0x3b4565(0x148)+_0x11647c[_0x3b4565(0x168)]:_0x9b56e6=''+_0x11647c['body'],await(0x0,SendWhatsAppMessage_1[_0x3b4565(0x147)])({'body':_0x9b56e6,'ticket':_0x2181f8,'quotedMsg':_0x567a00});}}),_0x3e8ff1['json'](_0x49d868(0x1ad));};exports[a23_0x5c3948(0x19c)]=forwardmessage;const forwardMessage=async(_0x57d8eb,_0xa5683d)=>{const _0x1f45b5=a23_0x5c3948,{quotedMsg:_0x555983,signMessage:_0x50cc66,messageId:_0xd400ba,contactId:_0x1e671b}=_0x57d8eb['body'],{id:_0x5f05c2,companyId:_0xffe6d4}=_0x57d8eb[_0x1f45b5(0x14f)],_0x5ae0eb=await User_1[_0x1f45b5(0x147)][_0x1f45b5(0x169)](_0x5f05c2);if(!_0xd400ba||!_0x1e671b)return _0xa5683d['status'](0xc8)[_0x1f45b5(0x1b9)](_0x1f45b5(0x1b8));const _0x568a32=await(0x0,ShowMessageService_1[_0x1f45b5(0x147)])(_0xd400ba),_0x31f36e=await(0x0,ShowContactService_1[_0x1f45b5(0x147)])(_0x1e671b,_0xffe6d4);if(!_0x568a32)return _0xa5683d['status'](0x194)['send'](_0x1f45b5(0x1a6));if(!_0x31f36e)return _0xa5683d[_0x1f45b5(0x174)](0x194)['send'](_0x1f45b5(0x1bc));const _0x486dfc=await CompaniesSettings_1[_0x1f45b5(0x147)][_0x1f45b5(0x141)]({'where':{'companyId':_0xffe6d4}}),_0x3475d6=await(0x0,ShowMessageService_1['GetWhatsAppFromMessage'])(_0x568a32);if(!_0x3475d6)return _0xa5683d['status'](0x194)['send']('Whatsapp\x20from\x20message\x20not\x20found');const _0x21e6ef=await(0x0,ShowTicketService_1['default'])(_0x568a32[_0x1f45b5(0x164)],_0x568a32[_0x1f45b5(0x1ab)]),{ticket:_0x4dbf6a}=await(0x0,FindOrCreateTicketService_1['default'])(_0x31f36e,_0x21e6ef?.[_0x1f45b5(0x162)],0x0,_0x21e6ef[_0x1f45b5(0x1ab)],_0x21e6ef[_0x1f45b5(0x197)],_0x5ae0eb['id'],_0x31f36e[_0x1f45b5(0x146)]?_0x31f36e:null,_0x1f45b5(0x162),null,!![],_0x486dfc);let _0x1e367b;(0x0,lodash_1[_0x1f45b5(0x143)])(_0x4dbf6a?.['queueId'])?_0x1e367b={'status':_0x4dbf6a[_0x1f45b5(0x146)]?_0x1f45b5(0x16b):_0x1f45b5(0x14c),'userId':_0x5ae0eb['id'],'queueId':_0x21e6ef[_0x1f45b5(0x197)]}:_0x1e367b={'status':_0x4dbf6a[_0x1f45b5(0x146)]?_0x1f45b5(0x16b):_0x1f45b5(0x14c),'userId':_0x5ae0eb['id']};await(0x0,UpdateTicketService_1['default'])({'ticketData':_0x1e367b,'ticketId':_0x4dbf6a['id'],'companyId':_0x4dbf6a[_0x1f45b5(0x1ab)]});let _0x285687=_0x568a32[_0x1f45b5(0x168)];if(_0x568a32[_0x1f45b5(0x140)]===_0x1f45b5(0x19e)||_0x568a32[_0x1f45b5(0x140)]===_0x1f45b5(0x19a))await(0x0,SendWhatsAppMessage_1[_0x1f45b5(0x147)])({'body':_0x285687,'ticket':_0x4dbf6a,'quotedMsg':_0x555983,'isForwarded':_0x568a32[_0x1f45b5(0x159)]?![]:!![]});else{const _0x5f0c44=_0x568a32[_0x1f45b5(0x18e)]['replace'](':'+process[_0x1f45b5(0x178)][_0x1f45b5(0x15b)],''),_0x3ba82d=obterNomeEExtensaoDoArquivo(_0x5f0c44);_0x285687===_0x3ba82d&&(_0x285687='');const _0x52e007=path_1[_0x1f45b5(0x147)][_0x1f45b5(0x14e)](__dirname,'..','..','..',_0x1f45b5(0x165),_0x1f45b5(0x15a)),_0x344787=path_1['default'][_0x1f45b5(0x14e)](_0x52e007,_0x1f45b5(0x191)+_0x4dbf6a[_0x1f45b5(0x1ab)],_0x3ba82d),_0x5d3ffb={'fieldname':_0x1f45b5(0x156),'originalname':_0x3ba82d,'encoding':'7bit','mimetype':_0x568a32[_0x1f45b5(0x140)],'filename':_0x3ba82d,'path':_0x344787};await(0x0,SendWhatsAppMedia_1[_0x1f45b5(0x147)])({'media':_0x5d3ffb,'ticket':_0x4dbf6a,'body':_0x285687,'isForwarded':_0x568a32[_0x1f45b5(0x159)]?![]:!![]});}return _0xa5683d['send']();};exports[a23_0x5c3948(0x144)]=forwardMessage;const remove=async(_0xeb0ec4,_0x555b5c)=>{const _0x563b53=a23_0x5c3948,{messageId:_0x246b89}=_0xeb0ec4[_0x563b53(0x189)],{companyId:_0x1dde77}=_0xeb0ec4['user'],_0x401a41=await(0x0,DeleteWhatsAppMessage_1['default'])(_0x246b89),_0x2ee00f=(0x0,socket_1[_0x563b53(0x1a5)])();return _0x401a41[_0x563b53(0x1b3)]&&(await Message_1[_0x563b53(0x147)][_0x563b53(0x1b6)]({'where':{'id':_0x401a41['id']}}),_0x2ee00f['to'](_0x401a41[_0x563b53(0x164)]['toString']())['emit'](_0x563b53(0x17d)+_0x1dde77+'-appMessage',{'action':_0x563b53(0x145),'message':_0x401a41})),_0x2ee00f['to'](_0x401a41[_0x563b53(0x164)]['toString']())[_0x563b53(0x14b)](_0x563b53(0x17d)+_0x1dde77+_0x563b53(0x183),{'action':'update','message':_0x401a41}),_0x555b5c['send']();};exports[a23_0x5c3948(0x172)]=remove;const allMe=async(_0x3c1d4a,_0x48a566)=>{const _0x308b41=a23_0x5c3948,_0xb87bf8=_0x3c1d4a['query'][_0x308b41(0x179)],_0x142f47=_0x3c1d4a['query'][_0x308b41(0x1a3)],_0x987d11=_0x3c1d4a['query'][_0x308b41(0x159)],{companyId:_0x5e89bb}=_0x3c1d4a[_0x308b41(0x14f)],{count:_0x115a8d}=await(0x0,ListMessagesServiceAll_1[_0x308b41(0x147)])({'companyId':_0x5e89bb,'fromMe':_0x987d11,'dateStart':_0xb87bf8,'dateEnd':_0x142f47});return _0x48a566['json']({'count':_0x115a8d});};exports['allMe']=allMe;const send=async(_0x2569e0,_0x4515fa)=>{const _0x4b7910=a23_0x5c3948,_0x535426=_0x2569e0[_0x4b7910(0x168)],_0x442d2a=_0x2569e0[_0x4b7910(0x173)];try{const _0x199a9a=_0x2569e0[_0x4b7910(0x15e)][_0x4b7910(0x190)],[,_0x3f1d7c]=_0x199a9a[_0x4b7910(0x17c)]('\x20'),_0x25d4b5=await Whatsapp_1['default'][_0x4b7910(0x141)]({'where':{'token':_0x3f1d7c}}),_0x568c20=_0x25d4b5[_0x4b7910(0x1ab)],_0x277872=await(0x0,ShowPlanCompanyService_1[_0x4b7910(0x147)])(_0x568c20),_0x1f5631=_0x277872[_0x4b7910(0x16a)][_0x4b7910(0x14a)];if(_0x1f5631){if(!_0x25d4b5)throw new Error(_0x4b7910(0x150));if(_0x535426[_0x4b7910(0x167)]===undefined)throw new Error(_0x4b7910(0x166));const _0x53d762=_0x535426[_0x4b7910(0x167)],_0x26bf1a=_0x535426[_0x4b7910(0x168)];return _0x442d2a?await Promise[_0x4b7910(0x177)](_0x442d2a['map'](async _0x1cbe7b=>{const _0x17857e=_0x4b7910;_0x2569e0[_0x17857e(0x170)][_0x17857e(0x194)](_0x17857e(0x1a2))[_0x17857e(0x13f)]['add']('SendMessage',{'whatsappId':_0x25d4b5['id'],'data':{'number':_0x53d762,'body':_0x1cbe7b[_0x17857e(0x19d)]['replace']('/','-'),'mediaPath':_0x1cbe7b[_0x17857e(0x18f)]}},{'removeOnComplete':!![],'attempts':0x3});})):_0x2569e0[_0x4b7910(0x170)][_0x4b7910(0x194)](_0x4b7910(0x1a2))[_0x4b7910(0x13f)][_0x4b7910(0x193)]('SendMessage',{'whatsappId':_0x25d4b5['id'],'data':{'number':_0x53d762,'body':_0x26bf1a}},{'removeOnComplete':!![],'attempts':0x3}),_0x4515fa[_0x4b7910(0x1b9)]({'mensagem':_0x4b7910(0x195)});}return _0x4515fa['status'](0x190)[_0x4b7910(0x15f)]({'error':'Essa\x20empresa\x20não\x20tem\x20permissão\x20para\x20usar\x20a\x20API\x20Externa.\x20Entre\x20em\x20contato\x20com\x20o\x20Suporte\x20para\x20verificar\x20nossos\x20planos!'});}catch(_0x3aa4fa){console[_0x4b7910(0x181)](_0x3aa4fa);if(Object[_0x4b7910(0x15d)](_0x3aa4fa)[_0x4b7910(0x192)]===0x0)throw new AppError_1['default'](_0x4b7910(0x17e));else throw new AppError_1['default'](_0x3aa4fa['message']);}};exports[a23_0x5c3948(0x1b9)]=send;
>>>>>>> ab722bfbcf394d74dd0b99a984c0dcf6ffbcff7f
