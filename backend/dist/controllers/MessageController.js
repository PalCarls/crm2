'use strict';const a22_0x1c4a9c=a22_0x64e6;(function(_0x3358fd,_0x55be7f){const _0x35468c=a22_0x64e6,_0x7e5bc1=_0x3358fd();while(!![]){try{const _0x4789ab=parseInt(_0x35468c(0x12e))/0x1*(-parseInt(_0x35468c(0x186))/0x2)+-parseInt(_0x35468c(0x156))/0x3+-parseInt(_0x35468c(0x17b))/0x4+parseInt(_0x35468c(0x168))/0x5*(-parseInt(_0x35468c(0x132))/0x6)+-parseInt(_0x35468c(0x12b))/0x7+parseInt(_0x35468c(0x160))/0x8*(-parseInt(_0x35468c(0x158))/0x9)+-parseInt(_0x35468c(0x178))/0xa*(-parseInt(_0x35468c(0x11c))/0xb);if(_0x4789ab===_0x55be7f)break;else _0x7e5bc1['push'](_0x7e5bc1['shift']());}catch(_0x29f336){_0x7e5bc1['push'](_0x7e5bc1['shift']());}}}(a22_0x1ef5,0xeee2a));function a22_0x1ef5(){const _0x150a74=['Não\x20foi\x20possível\x20realizar\x20a\x20operação','name','../services/TicketServices/FindOrCreateTicketService','messageQueue','companyId','facebook','query','whatsapp','backend','forEach','company-','19400ZoJfxX','O\x20número\x20é\x20obrigatório','add','6241640NmOPLe','queues','../helpers/SetTicketMessagesAsRead','mediaType','remove','-appMessage','log','PORT','getIO','updatedAt','../models/Message','2DfCVOq','verify','../services/MessageServices/ListMessagesService','useExternalApi','open','plan','user','index','toString','33737FKNgzm','../services/MessageServices/CreateMessageService','../services/CompanyService/ShowPlanCompanyService','../services/FacebookServices/sendFacebookMessageMedia','defineProperty','secret','*\x0a\x0a','../libs/socket','status','json','isPrivate','app','SendMessage','path','../models/Whatsapp','3632643hsLlTj','findOne','params','700012PJMGcc','lodash','ticketId','authorization','6WkotYl','medias','update','../services/WbotServices/SendWhatsAppMessage','keys','Mensagem\x20enviada!','destroy','store','Não\x20foi\x20possível\x20enviar\x20a\x20mensagem,\x20tente\x20novamente\x20em\x20alguns\x20instantes','split','instagram','group','../services/MessageServices/ListMessagesServiceAll','default','body','admin','7bit','../models/Queue','count','isNil','message','push','test','files','extendedTextMessage','send','get','length','../services/FacebookServices/sendFacebookMessage','public','map','emit','../services/WbotServices/SendWhatsAppMedia','queueId','env','join','1726299eBZEJc','contact','9JfPgwr','*Mensagem\x20encaminhada\x20de\x20','jsonwebtoken','findByPk','fromMe','replace','allMe','number','5350784ViPaUw','quotedMsgId','channel','headers','contactMessage','mediaUrl','dateEnd','pathname','4739270ZWwkrM','forwardmessage','../config/auth','delete','__esModule'];a22_0x1ef5=function(){return _0x150a74;};return a22_0x1ef5();}var __importDefault=this&&this['__importDefault']||function(_0x10559a){const _0x2ebf9a=a22_0x64e6;return _0x10559a&&_0x10559a[_0x2ebf9a(0x16c)]?_0x10559a:{'default':_0x10559a};};Object[a22_0x1c4a9c(0x120)](exports,'__esModule',{'value':!![]}),exports[a22_0x1c4a9c(0x14b)]=exports['allMe']=exports[a22_0x1c4a9c(0x17f)]=exports[a22_0x1c4a9c(0x169)]=exports[a22_0x1c4a9c(0x139)]=exports[a22_0x1c4a9c(0x18d)]=void 0x0;const AppError_1=__importDefault(require('../errors/AppError')),SetTicketMessagesAsRead_1=__importDefault(require(a22_0x1c4a9c(0x17d))),socket_1=require(a22_0x1c4a9c(0x123)),Message_1=__importDefault(require(a22_0x1c4a9c(0x185))),Queue_1=__importDefault(require(a22_0x1c4a9c(0x143))),User_1=__importDefault(require('../models/User')),Whatsapp_1=__importDefault(require(a22_0x1c4a9c(0x12a))),jsonwebtoken_1=require(a22_0x1c4a9c(0x15a)),auth_1=__importDefault(require(a22_0x1c4a9c(0x16a))),path_1=__importDefault(require(a22_0x1c4a9c(0x129))),lodash_1=require(a22_0x1c4a9c(0x12f)),ListMessagesService_1=__importDefault(require(a22_0x1c4a9c(0x188))),ShowTicketService_1=__importDefault(require('../services/TicketServices/ShowTicketService')),DeleteWhatsAppMessage_1=__importDefault(require('../services/WbotServices/DeleteWhatsAppMessage')),SendWhatsAppMedia_1=__importDefault(require(a22_0x1c4a9c(0x152))),SendWhatsAppMessage_1=__importDefault(require(a22_0x1c4a9c(0x135))),CreateMessageService_1=__importDefault(require(a22_0x1c4a9c(0x11d))),sendFacebookMessageMedia_1=__importDefault(require(a22_0x1c4a9c(0x11f))),sendFacebookMessage_1=__importDefault(require(a22_0x1c4a9c(0x14e))),ShowPlanCompanyService_1=__importDefault(require(a22_0x1c4a9c(0x11e))),ListMessagesServiceAll_1=__importDefault(require(a22_0x1c4a9c(0x13e))),ShowContactService_1=__importDefault(require('../services/ContactServices/ShowContactService')),FindOrCreateTicketService_1=__importDefault(require(a22_0x1c4a9c(0x16f))),index=async(_0x393e70,_0x134bfe)=>{const _0x441981=a22_0x1c4a9c,{ticketId:_0x2ce2df}=_0x393e70[_0x441981(0x12d)],{pageNumber:_0x472eea,ticketTrakingId:_0x19f039}=_0x393e70[_0x441981(0x173)],{companyId:_0x31c592,profile:_0x2901f4}=_0x393e70[_0x441981(0x18c)],_0x5b2d14=[];if(_0x2901f4!==_0x441981(0x141)){const _0x49c8bd=await User_1['default'][_0x441981(0x15b)](_0x393e70[_0x441981(0x18c)]['id'],{'include':[{'model':Queue_1[_0x441981(0x13f)],'as':_0x441981(0x17c)}]});_0x49c8bd[_0x441981(0x17c)][_0x441981(0x176)](_0x3f0650=>{const _0x1bd164=_0x441981;_0x5b2d14[_0x1bd164(0x147)](_0x3f0650['id']);});}const {count:_0x538b80,messages:_0x387bd8,ticket:_0x7f0a16,hasMore:_0x147971}=await(0x0,ListMessagesService_1[_0x441981(0x13f)])({'pageNumber':_0x472eea,'ticketId':_0x2ce2df,'companyId':_0x31c592,'queues':_0x5b2d14});return _0x7f0a16['channel']==='whatsapp'&&(0x0,SetTicketMessagesAsRead_1[_0x441981(0x13f)])(_0x7f0a16),_0x134bfe[_0x441981(0x125)]({'count':_0x538b80,'messages':_0x387bd8,'ticket':_0x7f0a16,'hasMore':_0x147971});};exports[a22_0x1c4a9c(0x18d)]=index;function obterNomeEExtensaoDoArquivo(_0x40b578){const _0x20fd3f=a22_0x1c4a9c;var _0x3423e5=new URL(_0x40b578),_0x3c46f4=_0x3423e5[_0x20fd3f(0x167)],_0x3db7f9=_0x3c46f4[_0x20fd3f(0x13b)]('/')['pop'](),_0x1900b3=_0x3db7f9[_0x20fd3f(0x13b)]('.'),_0x1f64c6=_0x1900b3[0x0],_0x973840=_0x1900b3[0x1];return _0x1f64c6+'.'+_0x973840;}const store=async(_0x45176e,_0x2e59d7)=>{const _0x52982c=a22_0x1c4a9c,{ticketId:_0x329673}=_0x45176e[_0x52982c(0x12d)],{body:_0x23dde2,quotedMsg:_0xad062a,isPrivate:_0x1210f6,vCard:_0x539b9e}=_0x45176e['body'],_0x199297=_0x45176e[_0x52982c(0x149)],{companyId:_0x41d52a}=_0x45176e[_0x52982c(0x18c)],_0x4a00ae=await(0x0,ShowTicketService_1[_0x52982c(0x13f)])(_0x329673,_0x41d52a);_0x4a00ae['channel']==='whatsapp'&&(0x0,SetTicketMessagesAsRead_1[_0x52982c(0x13f)])(_0x4a00ae);try{if(_0x199297)await Promise['all'](_0x199297[_0x52982c(0x150)](async _0x175403=>{const _0x16c21d=_0x52982c;_0x4a00ae['channel']===_0x16c21d(0x174)&&await(0x0,SendWhatsAppMedia_1[_0x16c21d(0x13f)])({'media':_0x175403,'ticket':_0x4a00ae,'body':_0x23dde2,'isPrivate':/\u200d/[_0x16c21d(0x148)](_0x23dde2)});if(_0x4a00ae['channel']==='facebook'||_0x4a00ae[_0x16c21d(0x162)]===_0x16c21d(0x13c))try{await(0x0,sendFacebookMessageMedia_1[_0x16c21d(0x13f)])({'media':_0x175403,'ticket':_0x4a00ae});}catch(_0x511b83){console[_0x16c21d(0x181)](_0x511b83);}}));else{_0x4a00ae[_0x52982c(0x162)]===_0x52982c(0x174)&&!_0x1210f6&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x23dde2,'ticket':_0x4a00ae,'quotedMsg':_0xad062a,'isPrivate':_0x1210f6,'vCard':_0x539b9e});if(_0x4a00ae[_0x52982c(0x162)]===_0x52982c(0x174)&&_0x1210f6){const _0xab8f52={'wid':'PVT'+_0x4a00ae[_0x52982c(0x184)]['toString']()[_0x52982c(0x15d)]('\x20',''),'ticketId':_0x4a00ae['id'],'contactId':undefined,'body':_0x23dde2,'fromMe':!![],'mediaType':!(0x0,lodash_1[_0x52982c(0x145)])(_0x539b9e)?_0x52982c(0x164):_0x52982c(0x14a),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x4a00ae[_0x52982c(0x157)]?.['remoteJid'],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':_0x1210f6};await(0x0,CreateMessageService_1['default'])({'messageData':_0xab8f52,'companyId':_0x4a00ae['companyId']});}(_0x4a00ae[_0x52982c(0x162)]===_0x52982c(0x172)||_0x4a00ae['channel']===_0x52982c(0x13c))&&await(0x0,sendFacebookMessage_1[_0x52982c(0x13f)])({'body':_0x23dde2,'ticket':_0x4a00ae,'quotedMsg':_0xad062a});}return _0x2e59d7[_0x52982c(0x14b)]();}catch(_0x5cd606){return console['log'](_0x5cd606),_0x2e59d7[_0x52982c(0x124)](0x190)['json']({'error':_0x5cd606[_0x52982c(0x146)]});}};exports[a22_0x1c4a9c(0x139)]=store;const forwardmessage=async(_0x1cd053,_0x5cc425)=>{const _0x4518d5=a22_0x1c4a9c,_0x31ccaa=_0x1cd053[_0x4518d5(0x163)][_0x4518d5(0x131)],[,_0x29a977]=_0x31ccaa['split']('\x20'),_0xdf9aef=(0x0,jsonwebtoken_1[_0x4518d5(0x187)])(_0x29a977,auth_1['default'][_0x4518d5(0x121)]),{id:_0x3c0e8e}=_0xdf9aef,_0x55601a=await User_1[_0x4518d5(0x13f)][_0x4518d5(0x15b)](_0x3c0e8e),{currentContacts:_0x3b323d,message:_0x2c8fe6,signMessage:_0x35a4de}=_0x1cd053[_0x4518d5(0x140)],_0x121ad1=_0x2c8fe6[_0x4518d5(0x161)];let _0x318a0d;return _0x3b323d[_0x4518d5(0x150)](async _0x7db0cd=>{const _0x8ac132=_0x4518d5,_0x2b3940=await(0x0,ShowContactService_1[_0x8ac132(0x13f)])(_0x7db0cd['id'],_0x2c8fe6['companyId']),_0x1991fa=await(0x0,ShowTicketService_1[_0x8ac132(0x13f)])(_0x2c8fe6[_0x8ac132(0x130)],_0x2c8fe6[_0x8ac132(0x171)]),{ticket:_0x5d5d27,isCreated:_0x1ee014}=await(0x0,FindOrCreateTicketService_1[_0x8ac132(0x13f)])(_0x2b3940,_0x1991fa['whatsappId'],0x0,_0x1991fa[_0x8ac132(0x171)]);await _0x5d5d27[_0x8ac132(0x134)]({'status':_0x5d5d27['isGroup']?_0x8ac132(0x13d):_0x8ac132(0x18a),'userId':_0x55601a['id'],'queueId':_0x2c8fe6[_0x8ac132(0x153)]});if(_0x1991fa[_0x8ac132(0x162)]===_0x8ac132(0x174)){if(_0x2c8fe6[_0x8ac132(0x165)]){_0x35a4de&&(_0x318a0d='*Mensagem\x20encaminhada\x20de\x20'+_0x55601a['name']+'*');const _0x3b6fb5=_0x2c8fe6[_0x8ac132(0x165)]['replace'](':'+process[_0x8ac132(0x154)][_0x8ac132(0x182)],''),_0x47ba04=obterNomeEExtensaoDoArquivo(_0x3b6fb5),_0x89948=path_1['default']['join'](__dirname,'..','..','..',_0x8ac132(0x175),_0x8ac132(0x14f)),_0xe1e76=path_1['default'][_0x8ac132(0x155)](_0x89948,'company'+_0x1991fa['companyId'],_0x47ba04),_0x5b04c7={'fieldname':_0x8ac132(0x133),'originalname':_0x47ba04,'encoding':_0x8ac132(0x142),'mimetype':_0x2c8fe6[_0x8ac132(0x17e)],'filename':_0x47ba04,'path':_0xe1e76};await(0x0,SendWhatsAppMedia_1[_0x8ac132(0x13f)])({'media':_0x5b04c7,'ticket':_0x5d5d27,'body':_0x318a0d});}else _0x35a4de?_0x318a0d=_0x8ac132(0x159)+_0x55601a[_0x8ac132(0x16e)]+_0x8ac132(0x122)+_0x2c8fe6['body']:_0x318a0d=''+_0x2c8fe6[_0x8ac132(0x140)],await(0x0,SendWhatsAppMessage_1[_0x8ac132(0x13f)])({'body':_0x318a0d,'ticket':_0x5d5d27,'quotedMsg':_0x121ad1});}}),_0x5cc425[_0x4518d5(0x125)](_0x4518d5(0x144));};exports[a22_0x1c4a9c(0x169)]=forwardmessage;function a22_0x64e6(_0x3c13ba,_0x2314f8){const _0x1ef560=a22_0x1ef5();return a22_0x64e6=function(_0x64e61f,_0x15653c){_0x64e61f=_0x64e61f-0x11b;let _0xbaeaf3=_0x1ef560[_0x64e61f];return _0xbaeaf3;},a22_0x64e6(_0x3c13ba,_0x2314f8);}const remove=async(_0x53ddd4,_0x3f2603)=>{const _0x34be75=a22_0x1c4a9c,{messageId:_0x309747}=_0x53ddd4[_0x34be75(0x12d)],{companyId:_0x10c10d}=_0x53ddd4[_0x34be75(0x18c)],_0x54e0fb=await(0x0,DeleteWhatsAppMessage_1[_0x34be75(0x13f)])(_0x309747),_0xfb76ee=(0x0,socket_1[_0x34be75(0x183)])();return _0x54e0fb[_0x34be75(0x126)]&&(await Message_1[_0x34be75(0x13f)][_0x34be75(0x138)]({'where':{'id':_0x54e0fb['id']}}),_0xfb76ee['to'](_0x54e0fb[_0x34be75(0x130)][_0x34be75(0x11b)]())[_0x34be75(0x151)]('company-'+_0x10c10d+_0x34be75(0x180),{'action':_0x34be75(0x16b),'message':_0x54e0fb})),_0xfb76ee['to'](_0x54e0fb[_0x34be75(0x130)][_0x34be75(0x11b)]())[_0x34be75(0x151)](_0x34be75(0x177)+_0x10c10d+_0x34be75(0x180),{'action':_0x34be75(0x134),'message':_0x54e0fb}),_0x3f2603['send']();};exports[a22_0x1c4a9c(0x17f)]=remove;const allMe=async(_0x56c2d7,_0x453e15)=>{const _0x24fb80=a22_0x1c4a9c,_0x5937f3=_0x56c2d7[_0x24fb80(0x173)]['dateStart'],_0x478fe1=_0x56c2d7[_0x24fb80(0x173)][_0x24fb80(0x166)],_0x49f1dd=_0x56c2d7[_0x24fb80(0x173)][_0x24fb80(0x15c)],{companyId:_0x5b2e96}=_0x56c2d7[_0x24fb80(0x18c)],{count:_0x1b4fcd}=await(0x0,ListMessagesServiceAll_1['default'])({'companyId':_0x5b2e96,'fromMe':_0x49f1dd,'dateStart':_0x5937f3,'dateEnd':_0x478fe1});return _0x453e15[_0x24fb80(0x125)]({'count':_0x1b4fcd});};exports[a22_0x1c4a9c(0x15e)]=allMe;const send=async(_0x456702,_0x3da869)=>{const _0x443576=a22_0x1c4a9c,_0x3b467f=_0x456702[_0x443576(0x140)],_0x4979d8=_0x456702[_0x443576(0x149)];try{const _0xbf4f43=_0x456702['headers'][_0x443576(0x131)],[,_0x148c45]=_0xbf4f43[_0x443576(0x13b)]('\x20'),_0x535832=await Whatsapp_1[_0x443576(0x13f)][_0x443576(0x12c)]({'where':{'token':_0x148c45}}),_0x2377f4=_0x535832[_0x443576(0x171)],_0xce0995=await(0x0,ShowPlanCompanyService_1[_0x443576(0x13f)])(_0x2377f4),_0x3b3ed9=_0xce0995[_0x443576(0x18b)][_0x443576(0x189)];if(_0x3b3ed9){if(!_0x535832)throw new Error(_0x443576(0x16d));if(_0x3b467f[_0x443576(0x15f)]===undefined)throw new Error(_0x443576(0x179));const _0x1bcd0b=_0x3b467f[_0x443576(0x15f)],_0x2ca862=_0x3b467f[_0x443576(0x140)];return _0x4979d8?await Promise['all'](_0x4979d8[_0x443576(0x150)](async _0x5eed61=>{const _0x3caf79=_0x443576;_0x456702[_0x3caf79(0x127)][_0x3caf79(0x14c)]('queues')[_0x3caf79(0x170)][_0x3caf79(0x17a)]('SendMessage',{'whatsappId':_0x535832['id'],'data':{'number':_0x1bcd0b,'body':_0x5eed61['originalname'][_0x3caf79(0x15d)]('/','-'),'mediaPath':_0x5eed61[_0x3caf79(0x129)]}},{'removeOnComplete':!![],'attempts':0x3});})):_0x456702[_0x443576(0x127)]['get'](_0x443576(0x17c))[_0x443576(0x170)][_0x443576(0x17a)](_0x443576(0x128),{'whatsappId':_0x535832['id'],'data':{'number':_0x1bcd0b,'body':_0x2ca862}},{'removeOnComplete':!![],'attempts':0x3}),_0x3da869[_0x443576(0x14b)]({'mensagem':_0x443576(0x137)});}return _0x3da869['status'](0x190)[_0x443576(0x125)]({'error':'Essa\x20empresa\x20não\x20tem\x20permissão\x20para\x20usar\x20a\x20API\x20Externa.\x20Entre\x20em\x20contato\x20com\x20o\x20Suporte\x20para\x20verificar\x20nossos\x20planos!'});}catch(_0x447325){console[_0x443576(0x181)](_0x447325);if(Object[_0x443576(0x136)](_0x447325)[_0x443576(0x14d)]===0x0)throw new AppError_1['default'](_0x443576(0x13a));else throw new AppError_1[(_0x443576(0x13f))](_0x447325[_0x443576(0x146)]);}};exports[a22_0x1c4a9c(0x14b)]=send;