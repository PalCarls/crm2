'use strict';const a22_0x5b8225=a22_0x4efc;function a22_0x4efc(_0x3a3ed2,_0x19b7c9){const _0x6356b=a22_0x6356();return a22_0x4efc=function(_0x4efc59,_0x3c98be){_0x4efc59=_0x4efc59-0x1cb;let _0x47d290=_0x6356b[_0x4efc59];return _0x47d290;},a22_0x4efc(_0x3a3ed2,_0x19b7c9);}(function(_0x214831,_0x256f42){const _0x117bcf=a22_0x4efc,_0x35d01e=_0x214831();while(!![]){try{const _0x4c6132=parseInt(_0x117bcf(0x226))/0x1+parseInt(_0x117bcf(0x1fa))/0x2+parseInt(_0x117bcf(0x203))/0x3+-parseInt(_0x117bcf(0x1e9))/0x4*(parseInt(_0x117bcf(0x21b))/0x5)+-parseInt(_0x117bcf(0x1dd))/0x6+parseInt(_0x117bcf(0x230))/0x7+parseInt(_0x117bcf(0x227))/0x8*(parseInt(_0x117bcf(0x1cd))/0x9);if(_0x4c6132===_0x256f42)break;else _0x35d01e['push'](_0x35d01e['shift']());}catch(_0x44ed38){_0x35d01e['push'](_0x35d01e['shift']());}}}(a22_0x6356,0x634d3));var __importDefault=this&&this['__importDefault']||function(_0x486665){const _0x47abc2=a22_0x4efc;return _0x486665&&_0x486665[_0x47abc2(0x228)]?_0x486665:{'default':_0x486665};};Object[a22_0x5b8225(0x223)](exports,a22_0x5b8225(0x228),{'value':!![]}),exports['send']=exports[a22_0x5b8225(0x1d1)]=exports[a22_0x5b8225(0x1e4)]=exports[a22_0x5b8225(0x215)]=exports[a22_0x5b8225(0x231)]=exports['index']=void 0x0;const AppError_1=__importDefault(require(a22_0x5b8225(0x222))),SetTicketMessagesAsRead_1=__importDefault(require(a22_0x5b8225(0x22c))),socket_1=require(a22_0x5b8225(0x1db)),Message_1=__importDefault(require('../models/Message')),Queue_1=__importDefault(require(a22_0x5b8225(0x219))),User_1=__importDefault(require(a22_0x5b8225(0x208))),Whatsapp_1=__importDefault(require(a22_0x5b8225(0x22d))),jsonwebtoken_1=require('jsonwebtoken'),auth_1=__importDefault(require(a22_0x5b8225(0x1f3))),path_1=__importDefault(require(a22_0x5b8225(0x21e))),lodash_1=require(a22_0x5b8225(0x1cb)),ListMessagesService_1=__importDefault(require(a22_0x5b8225(0x1ee))),ShowTicketService_1=__importDefault(require(a22_0x5b8225(0x221))),DeleteWhatsAppMessage_1=__importDefault(require(a22_0x5b8225(0x1cf))),SendWhatsAppMedia_1=__importDefault(require(a22_0x5b8225(0x1f8))),SendWhatsAppMessage_1=__importDefault(require(a22_0x5b8225(0x1f4))),CreateMessageService_1=__importDefault(require(a22_0x5b8225(0x1e2))),sendFacebookMessageMedia_1=__importDefault(require(a22_0x5b8225(0x232))),sendFacebookMessage_1=__importDefault(require(a22_0x5b8225(0x210))),ShowPlanCompanyService_1=__importDefault(require(a22_0x5b8225(0x22b))),ListMessagesServiceAll_1=__importDefault(require(a22_0x5b8225(0x1fc))),ShowContactService_1=__importDefault(require(a22_0x5b8225(0x225))),FindOrCreateTicketService_1=__importDefault(require(a22_0x5b8225(0x1fb))),UpdateTicketService_1=__importDefault(require(a22_0x5b8225(0x1f1))),ListSettingsService_1=__importDefault(require(a22_0x5b8225(0x21a))),index=async(_0x67351e,_0x226611)=>{const _0xb301d3=a22_0x5b8225,{ticketId:_0x30bae1}=_0x67351e[_0xb301d3(0x1ec)],{pageNumber:_0x1f6e93,ticketTrakingId:_0x344b35}=_0x67351e[_0xb301d3(0x213)],{companyId:_0x43446b,profile:_0x55ae61}=_0x67351e[_0xb301d3(0x209)],_0x34c998=[];if(_0x55ae61!==_0xb301d3(0x201)){const _0x4d7987=await User_1[_0xb301d3(0x1f6)]['findByPk'](_0x67351e['user']['id'],{'include':[{'model':Queue_1[_0xb301d3(0x1f6)],'as':_0xb301d3(0x1da)}]});_0x4d7987['queues'][_0xb301d3(0x224)](_0x129311=>{const _0x504b52=_0xb301d3;_0x34c998[_0x504b52(0x1e1)](_0x129311['id']);});}const {count:_0x17c247,messages:_0x4c2295,ticket:_0x1fb808,hasMore:_0x502297}=await(0x0,ListMessagesService_1['default'])({'pageNumber':_0x1f6e93,'ticketId':_0x30bae1,'companyId':_0x43446b,'queues':_0x34c998});return _0x1fb808[_0xb301d3(0x211)]==='whatsapp'&&(0x0,SetTicketMessagesAsRead_1[_0xb301d3(0x1f6)])(_0x1fb808),_0x226611[_0xb301d3(0x1ce)]({'count':_0x17c247,'messages':_0x4c2295,'ticket':_0x1fb808,'hasMore':_0x502297});};exports['index']=index;function obterNomeEExtensaoDoArquivo(_0x134f12){const _0x590a7a=a22_0x5b8225;var _0x51463a=new URL(_0x134f12),_0x29cb0c=_0x51463a[_0x590a7a(0x229)],_0x5b244d=_0x29cb0c[_0x590a7a(0x1d6)]('/')[_0x590a7a(0x1d3)](),_0x16df80=_0x5b244d[_0x590a7a(0x1d6)]('.'),_0x9c5046=_0x16df80[0x0],_0x7a1046=_0x16df80[0x1];return _0x9c5046+'.'+_0x7a1046;}const store=async(_0x574890,_0x22aafa)=>{const _0x32bbd3=a22_0x5b8225,{ticketId:_0x17ea97}=_0x574890['params'],{body:_0x3b0453,quotedMsg:_0x4c4590,isPrivate:_0x5ae6fe,vCard:_0x59b052}=_0x574890['body'],_0x507716=_0x574890[_0x32bbd3(0x1fd)],{companyId:_0x3dbc0e}=_0x574890[_0x32bbd3(0x209)],_0x59d01a=await(0x0,ShowTicketService_1[_0x32bbd3(0x1f6)])(_0x17ea97,_0x3dbc0e);_0x59d01a[_0x32bbd3(0x211)]===_0x32bbd3(0x20b)&&(0x0,SetTicketMessagesAsRead_1[_0x32bbd3(0x1f6)])(_0x59d01a);try{if(_0x507716)await Promise['all'](_0x507716[_0x32bbd3(0x1ea)](async _0x44dd0e=>{const _0x2c70c1=_0x32bbd3;_0x59d01a[_0x2c70c1(0x211)]===_0x2c70c1(0x20b)&&await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x44dd0e,'ticket':_0x59d01a,'body':_0x3b0453,'isPrivate':/\u200d/['test'](_0x3b0453)});if(_0x59d01a[_0x2c70c1(0x211)]===_0x2c70c1(0x1ef)||_0x59d01a[_0x2c70c1(0x211)]===_0x2c70c1(0x1e3))try{await(0x0,sendFacebookMessageMedia_1[_0x2c70c1(0x1f6)])({'media':_0x44dd0e,'ticket':_0x59d01a});}catch(_0x4e95ad){console[_0x2c70c1(0x1ff)](_0x4e95ad);}}));else{_0x59d01a[_0x32bbd3(0x211)]==='whatsapp'&&!_0x5ae6fe&&await(0x0,SendWhatsAppMessage_1[_0x32bbd3(0x1f6)])({'body':_0x3b0453,'ticket':_0x59d01a,'quotedMsg':_0x4c4590,'isPrivate':_0x5ae6fe,'vCard':_0x59b052});if(_0x59d01a[_0x32bbd3(0x211)]===_0x32bbd3(0x20b)&&_0x5ae6fe){const _0x595534={'wid':_0x32bbd3(0x202)+_0x59d01a[_0x32bbd3(0x20e)][_0x32bbd3(0x1f7)]()[_0x32bbd3(0x1e8)]('\x20',''),'ticketId':_0x59d01a['id'],'contactId':undefined,'body':_0x3b0453,'fromMe':!![],'mediaType':!(0x0,lodash_1['isNil'])(_0x59b052)?'contactMessage':_0x32bbd3(0x206),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x59d01a[_0x32bbd3(0x1dc)]?.['remoteJid'],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':_0x5ae6fe};await(0x0,CreateMessageService_1[_0x32bbd3(0x1f6)])({'messageData':_0x595534,'companyId':_0x59d01a[_0x32bbd3(0x1cc)]});}(_0x59d01a[_0x32bbd3(0x211)]===_0x32bbd3(0x1ef)||_0x59d01a[_0x32bbd3(0x211)]==='instagram')&&await(0x0,sendFacebookMessage_1[_0x32bbd3(0x1f6)])({'body':_0x3b0453,'ticket':_0x59d01a,'quotedMsg':_0x4c4590});}return _0x22aafa[_0x32bbd3(0x21c)]();}catch(_0x487709){return console[_0x32bbd3(0x1ff)](_0x487709),_0x22aafa[_0x32bbd3(0x1fe)](0x190)[_0x32bbd3(0x1ce)]({'error':_0x487709[_0x32bbd3(0x21d)]});}};exports['store']=store;const forwardmessage=async(_0x1ed44d,_0x42aaa9)=>{const _0x5c0bf1=a22_0x5b8225,_0x338ea4=_0x1ed44d[_0x5c0bf1(0x1d2)][_0x5c0bf1(0x216)],[,_0x412735]=_0x338ea4[_0x5c0bf1(0x1d6)]('\x20'),_0x4272e6=(0x0,jsonwebtoken_1[_0x5c0bf1(0x22a)])(_0x412735,auth_1[_0x5c0bf1(0x1f6)][_0x5c0bf1(0x22e)]),{id:_0x567cc5}=_0x1ed44d['user'],_0x335f9c=await User_1[_0x5c0bf1(0x1f6)]['findByPk'](_0x567cc5),{currentContacts:_0x459885,message:_0x294327,signMessage:_0xf324ec}=_0x1ed44d[_0x5c0bf1(0x200)],_0x449ca6=await(0x0,ListSettingsService_1[_0x5c0bf1(0x1f6)])({'companyId':_0x294327['companyId']}),_0x25f838=_0x294327['quotedMsgId'];let _0x33c9bc;return _0x459885[_0x5c0bf1(0x1ea)](async _0x2eff2e=>{const _0x388ad3=_0x5c0bf1,_0x426915=await(0x0,ShowContactService_1[_0x388ad3(0x1f6)])(_0x2eff2e['id'],_0x294327[_0x388ad3(0x1cc)]),_0x31eeed=await(0x0,ShowTicketService_1[_0x388ad3(0x1f6)])(_0x294327[_0x388ad3(0x217)],_0x294327[_0x388ad3(0x1cc)]),{ticket:_0x20eb97,isCreated:_0x67734c}=await(0x0,FindOrCreateTicketService_1[_0x388ad3(0x1f6)])(_0x426915,_0x31eeed?.['whatsapp'],0x0,_0x31eeed[_0x388ad3(0x1cc)],_0x31eeed['queueId'],_0x335f9c['id'],_0x426915[_0x388ad3(0x1d8)]?_0x426915:null,_0x388ad3(0x20b),null,!![],_0x449ca6),_0x1a22ba={'status':_0x20eb97[_0x388ad3(0x1d8)]?'group':_0x388ad3(0x20d),'userId':_0x335f9c['id'],'queueId':_0x31eeed['queueId']};await(0x0,UpdateTicketService_1[_0x388ad3(0x1f6)])({'ticketData':_0x1a22ba,'ticketId':_0x20eb97['id'],'companyId':_0x20eb97['companyId']});if(_0x31eeed[_0x388ad3(0x211)]==='whatsapp'){if(_0x294327[_0x388ad3(0x1d5)]){_0xf324ec&&(_0x33c9bc='*Mensagem\x20encaminhada\x20de\x20'+_0x335f9c[_0x388ad3(0x21f)]+'*');const _0xc0c7dd=_0x294327['mediaUrl'][_0x388ad3(0x1e8)](':'+process['env'][_0x388ad3(0x1e0)],''),_0x410d10=obterNomeEExtensaoDoArquivo(_0xc0c7dd),_0x29356b=path_1[_0x388ad3(0x1f6)]['join'](__dirname,'..','..','..',_0x388ad3(0x1e7),_0x388ad3(0x1d4)),_0x5dc46f=path_1['default'][_0x388ad3(0x1f2)](_0x29356b,_0x388ad3(0x212)+_0x31eeed[_0x388ad3(0x1cc)],_0x410d10),_0xc0594b={'fieldname':_0x388ad3(0x1f9),'originalname':_0x410d10,'encoding':_0x388ad3(0x218),'mimetype':_0x294327['mediaType'],'filename':_0x410d10,'path':_0x5dc46f};await(0x0,SendWhatsAppMedia_1[_0x388ad3(0x1f6)])({'media':_0xc0594b,'ticket':_0x20eb97,'body':_0x33c9bc});}else _0xf324ec?_0x33c9bc='*Mensagem\x20encaminhada\x20de\x20'+_0x335f9c[_0x388ad3(0x21f)]+_0x388ad3(0x20c)+_0x294327['body']:_0x33c9bc=''+_0x294327[_0x388ad3(0x200)],await(0x0,SendWhatsAppMessage_1[_0x388ad3(0x1f6)])({'body':_0x33c9bc,'ticket':_0x20eb97,'quotedMsg':_0x25f838});}}),_0x42aaa9[_0x5c0bf1(0x1ce)]('count');};exports[a22_0x5b8225(0x215)]=forwardmessage;const remove=async(_0x426bb2,_0x420f53)=>{const _0x1e46a9=a22_0x5b8225,{messageId:_0x3ae152}=_0x426bb2[_0x1e46a9(0x1ec)],{companyId:_0x34f59a}=_0x426bb2[_0x1e46a9(0x209)],_0x55d89b=await(0x0,DeleteWhatsAppMessage_1['default'])(_0x3ae152),_0x59f495=(0x0,socket_1['getIO'])();return _0x55d89b['isPrivate']&&(await Message_1[_0x1e46a9(0x1f6)][_0x1e46a9(0x1eb)]({'where':{'id':_0x55d89b['id']}}),_0x59f495['to'](_0x55d89b[_0x1e46a9(0x217)]['toString']())[_0x1e46a9(0x207)](_0x1e46a9(0x20f)+_0x34f59a+_0x1e46a9(0x1de),{'action':_0x1e46a9(0x1d9),'message':_0x55d89b})),_0x59f495['to'](_0x55d89b[_0x1e46a9(0x217)][_0x1e46a9(0x1f7)]())['emit'](_0x1e46a9(0x20f)+_0x34f59a+_0x1e46a9(0x1de),{'action':_0x1e46a9(0x1f0),'message':_0x55d89b}),_0x420f53[_0x1e46a9(0x21c)]();};exports[a22_0x5b8225(0x1e4)]=remove;const allMe=async(_0x5ed490,_0xc1b3a6)=>{const _0x193865=a22_0x5b8225,_0x55c1d6=_0x5ed490[_0x193865(0x213)]['dateStart'],_0x14b767=_0x5ed490[_0x193865(0x213)][_0x193865(0x204)],_0x3b8a96=_0x5ed490['query']['fromMe'],{companyId:_0x557692}=_0x5ed490[_0x193865(0x209)],{count:_0x2e55d6}=await(0x0,ListMessagesServiceAll_1[_0x193865(0x1f6)])({'companyId':_0x557692,'fromMe':_0x3b8a96,'dateStart':_0x55c1d6,'dateEnd':_0x14b767});return _0xc1b3a6[_0x193865(0x1ce)]({'count':_0x2e55d6});};exports[a22_0x5b8225(0x1d1)]=allMe;function a22_0x6356(){const _0x108d0a=['../services/SettingServices/ListSettingsService','765ItFkXK','send','message','path','name','Não\x20foi\x20possível\x20realizar\x20a\x20operação','../services/TicketServices/ShowTicketService','../errors/AppError','defineProperty','forEach','../services/ContactServices/ShowContactService','578327WuwzMc','69160EtItCY','__esModule','pathname','verify','../services/CompanyService/ShowPlanCompanyService','../helpers/SetTicketMessagesAsRead','../models/Whatsapp','secret','number','1823906TLPiwz','store','../services/FacebookServices/sendFacebookMessageMedia','lodash','companyId','585XpqaKt','json','../services/WbotServices/DeleteWhatsAppMessage','add','allMe','headers','pop','public','mediaUrl','split','O\x20número\x20é\x20obrigatório','isGroup','delete','queues','../libs/socket','contact','4613244NhRQxF','-appMessage','Mensagem\x20enviada!','PORT','push','../services/MessageServices/CreateMessageService','instagram','remove','SendMessage','findOne','backend','replace','18132ybITiG','map','destroy','params','messageQueue','../services/MessageServices/ListMessagesService','facebook','update','../services/TicketServices/UpdateTicketService','join','../config/auth','../services/WbotServices/SendWhatsAppMessage','get','default','toString','../services/WbotServices/SendWhatsAppMedia','medias','687142WHJKue','../services/TicketServices/FindOrCreateTicketService','../services/MessageServices/ListMessagesServiceAll','files','status','log','body','admin','PVT','374343XySikP','dateEnd','length','extendedTextMessage','emit','../models/User','user','all','whatsapp','*\x0a\x0a','open','updatedAt','company-','../services/FacebookServices/sendFacebookMessage','channel','company','query','app','forwardmessage','authorization','ticketId','7bit','../models/Queue'];a22_0x6356=function(){return _0x108d0a;};return a22_0x6356();}const send=async(_0x2d2c03,_0x2659e8)=>{const _0x213d8b=a22_0x5b8225,_0x3f4e66=_0x2d2c03[_0x213d8b(0x200)],_0x116a8f=_0x2d2c03[_0x213d8b(0x1fd)];try{const _0x257976=_0x2d2c03[_0x213d8b(0x1d2)][_0x213d8b(0x216)],[,_0x3edc80]=_0x257976[_0x213d8b(0x1d6)]('\x20'),_0x3fdc57=await Whatsapp_1[_0x213d8b(0x1f6)][_0x213d8b(0x1e6)]({'where':{'token':_0x3edc80}}),_0x168565=_0x3fdc57[_0x213d8b(0x1cc)],_0x2be91d=await(0x0,ShowPlanCompanyService_1['default'])(_0x168565),_0x235a44=_0x2be91d['plan']['useExternalApi'];if(_0x235a44){if(!_0x3fdc57)throw new Error(_0x213d8b(0x220));if(_0x3f4e66[_0x213d8b(0x22f)]===undefined)throw new Error(_0x213d8b(0x1d7));const _0x372600=_0x3f4e66[_0x213d8b(0x22f)],_0x2c395f=_0x3f4e66['body'];return _0x116a8f?await Promise[_0x213d8b(0x20a)](_0x116a8f[_0x213d8b(0x1ea)](async _0x388124=>{const _0x130507=_0x213d8b;_0x2d2c03[_0x130507(0x214)][_0x130507(0x1f5)](_0x130507(0x1da))[_0x130507(0x1ed)][_0x130507(0x1d0)](_0x130507(0x1e5),{'whatsappId':_0x3fdc57['id'],'data':{'number':_0x372600,'body':_0x388124['originalname']['replace']('/','-'),'mediaPath':_0x388124[_0x130507(0x21e)]}},{'removeOnComplete':!![],'attempts':0x3});})):_0x2d2c03[_0x213d8b(0x214)][_0x213d8b(0x1f5)](_0x213d8b(0x1da))['messageQueue'][_0x213d8b(0x1d0)](_0x213d8b(0x1e5),{'whatsappId':_0x3fdc57['id'],'data':{'number':_0x372600,'body':_0x2c395f}},{'removeOnComplete':!![],'attempts':0x3}),_0x2659e8['send']({'mensagem':_0x213d8b(0x1df)});}return _0x2659e8[_0x213d8b(0x1fe)](0x190)['json']({'error':'Essa\x20empresa\x20não\x20tem\x20permissão\x20para\x20usar\x20a\x20API\x20Externa.\x20Entre\x20em\x20contato\x20com\x20o\x20Suporte\x20para\x20verificar\x20nossos\x20planos!'});}catch(_0x4effc4){console[_0x213d8b(0x1ff)](_0x4effc4);if(Object['keys'](_0x4effc4)[_0x213d8b(0x205)]===0x0)throw new AppError_1[(_0x213d8b(0x1f6))]('Não\x20foi\x20possível\x20enviar\x20a\x20mensagem,\x20tente\x20novamente\x20em\x20alguns\x20instantes');else throw new AppError_1['default'](_0x4effc4[_0x213d8b(0x21d)]);}};exports[a22_0x5b8225(0x21c)]=send;