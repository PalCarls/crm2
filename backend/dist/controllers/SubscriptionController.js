'use strict';function a34_0x481a(){const _0x504342=['update','pixDetailCharge','create','body','pixConfigWebhook','dueDate','1797859pgrGGk','loc','1774giBIos','#Fatura:','findOne','../models/Plan','__setModuleDefault','getSubscriptions','required','2020806ylIHPa','isValid','txid','27rSzWMQ','error_subscription','call','694160ZizDjC','params','env','length','97688TMbfjt','yup','pix','forEach','1146jgByoh','name','document','status','currency','getOwnPropertyDescriptor','3394088mDkgEV','paid','configurable','defineProperty','default','company-','-payment','string','index','get','json','object','teste_webhook','NumberFormat','setDate','pixGenerateQRCode','getIO','getDate','../models/Company','webhook','__importDefault','amount','createSubscription','replace','user','writable','deleteWebhook','../models/Invoices','emit','1509088XolXKn','GERENCIANET_CHAVEPIX','__importStar','__esModule','prototype','findByPk','split','pixDeleteWebhook','../config/Gn','log','USD','Validation\x20fails','Company\x20not\x20found','shape'];a34_0x481a=function(){return _0x504342;};return a34_0x481a();}const a34_0x5b4a7b=a34_0x1616;function a34_0x1616(_0x58b033,_0x16d71b){const _0x481a2f=a34_0x481a();return a34_0x1616=function(_0x161647,_0x58be42){_0x161647=_0x161647-0x126;let _0x18286b=_0x481a2f[_0x161647];return _0x18286b;},a34_0x1616(_0x58b033,_0x16d71b);}(function(_0x2d807e,_0x155bd0){const _0x583837=a34_0x1616,_0x14fbfc=_0x2d807e();while(!![]){try{const _0x63f7d0=-parseInt(_0x583837(0x16f))/0x1+-parseInt(_0x583837(0x15e))/0x2*(parseInt(_0x583837(0x173))/0x3)+-parseInt(_0x583837(0x148))/0x4+-parseInt(_0x583837(0x16b))/0x5+-parseInt(_0x583837(0x165))/0x6+parseInt(_0x583837(0x15c))/0x7+-parseInt(_0x583837(0x12b))/0x8*(-parseInt(_0x583837(0x168))/0x9);if(_0x63f7d0===_0x155bd0)break;else _0x14fbfc['push'](_0x14fbfc['shift']());}catch(_0x1719f8){_0x14fbfc['push'](_0x14fbfc['shift']());}}}(a34_0x481a,0x3aa41));var __createBinding=this&&this['__createBinding']||(Object[a34_0x5b4a7b(0x158)]?function(_0x29b427,_0x2f3dd5,_0x4a7859,_0x4ccaf7){const _0xd13ab4=a34_0x5b4a7b;if(_0x4ccaf7===undefined)_0x4ccaf7=_0x4a7859;var _0x59f727=Object[_0xd13ab4(0x12a)](_0x2f3dd5,_0x4a7859);(!_0x59f727||(_0xd13ab4(0x134)in _0x59f727?!_0x2f3dd5[_0xd13ab4(0x14b)]:_0x59f727[_0xd13ab4(0x144)]||_0x59f727[_0xd13ab4(0x12d)]))&&(_0x59f727={'enumerable':!![],'get':function(){return _0x2f3dd5[_0x4a7859];}}),Object[_0xd13ab4(0x12e)](_0x29b427,_0x4ccaf7,_0x59f727);}:function(_0x47acfe,_0x36723e,_0x958e77,_0x554437){if(_0x554437===undefined)_0x554437=_0x958e77;_0x47acfe[_0x554437]=_0x36723e[_0x958e77];}),__setModuleDefault=this&&this[a34_0x5b4a7b(0x162)]||(Object[a34_0x5b4a7b(0x158)]?function(_0x5f0597,_0x23c54f){const _0x59b8a0=a34_0x5b4a7b;Object[_0x59b8a0(0x12e)](_0x5f0597,'default',{'enumerable':!![],'value':_0x23c54f});}:function(_0x5cb0f9,_0x181497){const _0x3c9303=a34_0x5b4a7b;_0x5cb0f9[_0x3c9303(0x12f)]=_0x181497;}),__importStar=this&&this[a34_0x5b4a7b(0x14a)]||function(_0x32eff5){const _0x29609b=a34_0x5b4a7b;if(_0x32eff5&&_0x32eff5[_0x29609b(0x14b)])return _0x32eff5;var _0x3d75e8={};if(_0x32eff5!=null){for(var _0x2744dc in _0x32eff5)if(_0x2744dc!==_0x29609b(0x12f)&&Object[_0x29609b(0x14c)]['hasOwnProperty'][_0x29609b(0x16a)](_0x32eff5,_0x2744dc))__createBinding(_0x3d75e8,_0x32eff5,_0x2744dc);}return __setModuleDefault(_0x3d75e8,_0x32eff5),_0x3d75e8;},__importDefault=this&&this[a34_0x5b4a7b(0x13f)]||function(_0x4c1d55){const _0x2cfae1=a34_0x5b4a7b;return _0x4c1d55&&_0x4c1d55[_0x2cfae1(0x14b)]?_0x4c1d55:{'default':_0x4c1d55};};Object[a34_0x5b4a7b(0x12e)](exports,a34_0x5b4a7b(0x14b),{'value':!![]}),exports[a34_0x5b4a7b(0x13e)]=exports[a34_0x5b4a7b(0x145)]=exports['createWebhook']=exports['createSubscription']=exports[a34_0x5b4a7b(0x133)]=void 0x0;const Yup=__importStar(require(a34_0x5b4a7b(0x170))),gn_api_sdk_typescript_1=__importDefault(require('gn-api-sdk-typescript')),AppError_1=__importDefault(require('../errors/AppError')),Gn_1=__importDefault(require(a34_0x5b4a7b(0x150))),Company_1=__importDefault(require(a34_0x5b4a7b(0x13d))),Invoices_1=__importDefault(require(a34_0x5b4a7b(0x146))),socket_1=require('../libs/socket'),Plan_1=__importDefault(require(a34_0x5b4a7b(0x161))),index=async(_0xfe5101,_0x25531f)=>{const _0x582f93=a34_0x5b4a7b,_0x123713=new gn_api_sdk_typescript_1[(_0x582f93(0x12f))](Gn_1[_0x582f93(0x12f)]);return _0x25531f[_0x582f93(0x135)](_0x123713[_0x582f93(0x163)]());};exports['index']=index;const createSubscription=async(_0x23ac34,_0x285809)=>{const _0x138a70=a34_0x5b4a7b,_0x243fe4=new gn_api_sdk_typescript_1[(_0x138a70(0x12f))](Gn_1[_0x138a70(0x12f)]),{companyId:_0x5b82d6}=_0x23ac34[_0x138a70(0x143)],_0x45280b=Yup[_0x138a70(0x136)]()['shape']({'price':Yup[_0x138a70(0x132)]()[_0x138a70(0x164)](),'users':Yup[_0x138a70(0x132)]()[_0x138a70(0x164)](),'plan':Yup[_0x138a70(0x132)]()[_0x138a70(0x164)]()});if(!await _0x45280b[_0x138a70(0x166)](_0x23ac34[_0x138a70(0x159)]))throw new AppError_1[(_0x138a70(0x12f))]('Validation\x20fails',0x190);const _0x48a74b=new Intl[(_0x138a70(0x138))]('en-US',{'style':_0x138a70(0x129),'currency':_0x138a70(0x152)}),_0x4ebd9b=await Company_1[_0x138a70(0x12f)][_0x138a70(0x160)]({'where':{'id':_0x5b82d6}}),_0x39f9de=await Plan_1[_0x138a70(0x12f)]['findOne']({'where':{'id':_0x4ebd9b['planId']}}),{invoiceId:_0x284747}=_0x23ac34['body'],_0x158fda=_0x39f9de[_0x138a70(0x140)],_0xe8ed2=_0x48a74b['format'](_0x158fda)[_0x138a70(0x142)]('$',''),_0xbe6717={'nome':_0x4ebd9b[_0x138a70(0x126)]},_0x3e9caa=_0x4ebd9b[_0x138a70(0x127)][_0x138a70(0x142)](/\D/g,'');_0x3e9caa[_0x138a70(0x16e)]===0xb?_0xbe6717['cpf']=_0x3e9caa:_0xbe6717['cnpj']=_0x3e9caa;const _0x4e90f3={'calendario':{'expiracao':0xe10},'devedor':{..._0xbe6717},'valor':{'original':_0xe8ed2},'chave':process[_0x138a70(0x16d)][_0x138a70(0x149)],'solicitacaoPagador':_0x138a70(0x15f)+_0x284747};try{const _0x26a08f=await _0x243fe4['pixCreateImmediateCharge'](null,_0x4e90f3),_0x1865b9=await _0x243fe4[_0x138a70(0x13a)]({'id':_0x26a08f[_0x138a70(0x15d)]['id']});if(!_0x4ebd9b)throw new AppError_1[(_0x138a70(0x12f))](_0x138a70(0x154),0x194);return _0x285809[_0x138a70(0x135)]({..._0x26a08f,'qrcode':_0x1865b9});}catch(_0x45bc40){console[_0x138a70(0x151)](_0x138a70(0x169),_0x45bc40);throw new AppError_1[(_0x138a70(0x12f))]('Validation\x20fails',0x190);}};exports[a34_0x5b4a7b(0x141)]=createSubscription;const createWebhook=async(_0x453d13,_0x193147)=>{const _0x3a2f1f=a34_0x5b4a7b,_0x66b375=Yup['object']()[_0x3a2f1f(0x155)]({'chave':Yup[_0x3a2f1f(0x132)]()[_0x3a2f1f(0x164)](),'url':Yup[_0x3a2f1f(0x132)]()[_0x3a2f1f(0x164)]()});if(!await _0x66b375[_0x3a2f1f(0x166)](_0x453d13[_0x3a2f1f(0x159)]))throw new AppError_1['default']('Validation\x20fails',0x190);const {chave:_0x155604,url:_0x4f26e4}=_0x453d13[_0x3a2f1f(0x159)],_0x1dd0c6={'webhookUrl':_0x4f26e4},_0x35ae38={'chave':_0x155604};try{const _0x52cb21=new gn_api_sdk_typescript_1[(_0x3a2f1f(0x12f))](Gn_1[_0x3a2f1f(0x12f)]),_0x1f298a=await _0x52cb21[_0x3a2f1f(0x15a)](_0x35ae38,_0x1dd0c6);return _0x193147[_0x3a2f1f(0x135)](_0x1f298a);}catch(_0x230e63){console[_0x3a2f1f(0x151)](_0x230e63);}};exports['createWebhook']=createWebhook;const deleteWebhook=async(_0x280d2e,_0x4f2f23)=>{const _0x1e5f28=a34_0x5b4a7b,_0x1da2ed=Yup[_0x1e5f28(0x136)]()['shape']({'chave':Yup['string']()['required']()});if(!await _0x1da2ed[_0x1e5f28(0x166)](_0x280d2e[_0x1e5f28(0x159)]))throw new AppError_1[(_0x1e5f28(0x12f))](_0x1e5f28(0x153),0x190);const {chave:_0x1f7b5d}=_0x280d2e[_0x1e5f28(0x159)],_0x27d04a={'chave':_0x1f7b5d},_0x9fed81=new gn_api_sdk_typescript_1[(_0x1e5f28(0x12f))](Gn_1[_0x1e5f28(0x12f)]),_0x16fd99=await _0x9fed81[_0x1e5f28(0x14f)](_0x27d04a);return _0x4f2f23[_0x1e5f28(0x135)](_0x16fd99);};exports[a34_0x5b4a7b(0x145)]=deleteWebhook;const webhook=async(_0x30e356,_0x1c32f6)=>{const _0x2db783=a34_0x5b4a7b,{type:_0x5bc9ce}=_0x30e356[_0x2db783(0x16c)],{evento:_0x56887c}=_0x30e356[_0x2db783(0x159)];if(_0x56887c===_0x2db783(0x137))return _0x1c32f6[_0x2db783(0x135)]({'ok':!![]});if(_0x30e356[_0x2db783(0x159)][_0x2db783(0x171)]){const _0x1422c0=new gn_api_sdk_typescript_1[(_0x2db783(0x12f))](Gn_1[_0x2db783(0x12f)]);_0x30e356['body'][_0x2db783(0x171)][_0x2db783(0x172)](async _0x588973=>{const _0x2a53ea=_0x2db783,_0x185128=await _0x1422c0[_0x2a53ea(0x157)]({'txid':_0x588973[_0x2a53ea(0x167)]});if(_0x185128[_0x2a53ea(0x128)]==='CONCLUIDA'){const {solicitacaoPagador:_0x4a1906}=_0x185128,_0x35a07b=_0x4a1906[_0x2a53ea(0x142)](_0x2a53ea(0x15f),''),_0x8d1a1a=await Invoices_1[_0x2a53ea(0x12f)][_0x2a53ea(0x14d)](_0x35a07b),_0x53df3d=_0x8d1a1a['companyId'],_0x3ff500=await Company_1[_0x2a53ea(0x12f)]['findByPk'](_0x53df3d),_0x54d298=new Date(_0x3ff500[_0x2a53ea(0x15b)]);_0x54d298[_0x2a53ea(0x139)](_0x54d298[_0x2a53ea(0x13c)]()+0x1e);const _0x448c52=_0x54d298['toISOString']()[_0x2a53ea(0x14e)]('T')[0x0];if(_0x3ff500){await _0x3ff500[_0x2a53ea(0x156)]({'dueDate':_0x448c52});const _0x5e8f3f=await _0x8d1a1a[_0x2a53ea(0x156)]({'id':_0x35a07b,'status':_0x2a53ea(0x12c)});await _0x3ff500['reload']();const _0xb795b1=(0x0,socket_1[_0x2a53ea(0x13b)])(),_0x26bdd4=await Company_1[_0x2a53ea(0x12f)][_0x2a53ea(0x160)]({'where':{'id':_0x53df3d}});_0xb795b1[_0x2a53ea(0x147)](_0x2a53ea(0x130)+_0x53df3d+_0x2a53ea(0x131),{'action':_0x185128[_0x2a53ea(0x128)],'company':_0x26bdd4});}}});}return _0x1c32f6[_0x2db783(0x135)]({'ok':!![]});};exports[a34_0x5b4a7b(0x13e)]=webhook;