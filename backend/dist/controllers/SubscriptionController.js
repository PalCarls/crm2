'use strict';const a31_0x3fa80d=a31_0x1d97;function a31_0x5096(){const _0x5eab04=['hasOwnProperty','error_subscription','paid','pixGenerateQRCode','default','../errors/AppError','document','__esModule','NumberFormat','pix','company-','en-US','2463498FYfFoU','createWebhook','emit','349545SOhBpX','prototype','1133380tnmyqK','#Fatura:','32Idaunp','json','136OqohIM','webhook','pixCreateImmediateCharge','log','yup','cnpj','__createBinding','../models/Company','76870jIKpEW','pixDetailCharge','createSubscription','4598530KnIiDa','findByPk','1299060YZlLLg','shape','name','status','pixConfigWebhook','update','isValid','setDate','6GKYxLF','planId','../libs/socket','create','deleteWebhook','object','-payment','call','getIO','currency','replace','../config/Gn','txid','cpf','companyId','../models/Invoices','defineProperty','length','1441VPrDUm','__setModuleDefault','forEach','getDate','__importDefault','string','amount','required','index','body','params','42338kkeRAG','Validation\x20fails','format','CONCLUIDA','env','USD','reload','findOne'];a31_0x5096=function(){return _0x5eab04;};return a31_0x5096();}(function(_0x4c182a,_0x1dbce5){const _0xe40218=a31_0x1d97,_0xb5b83d=_0x4c182a();while(!![]){try{const _0x2b3c4c=parseInt(_0xe40218(0x159))/0x1*(parseInt(_0xe40218(0x13e))/0x2)+parseInt(_0xe40218(0x152))/0x3+parseInt(_0xe40218(0x157))/0x4+-parseInt(_0xe40218(0x166))/0x5*(parseInt(_0xe40218(0x121))/0x6)+-parseInt(_0xe40218(0x155))/0x7*(-parseInt(_0xe40218(0x15b))/0x8)+-parseInt(_0xe40218(0x168))/0x9+parseInt(_0xe40218(0x163))/0xa*(-parseInt(_0xe40218(0x133))/0xb);if(_0x2b3c4c===_0x1dbce5)break;else _0xb5b83d['push'](_0xb5b83d['shift']());}catch(_0x16a9bc){_0xb5b83d['push'](_0xb5b83d['shift']());}}}(a31_0x5096,0x88a9b));var __createBinding=this&&this[a31_0x3fa80d(0x161)]||(Object['create']?function(_0x3bb243,_0x258d2e,_0x33dd53,_0x2d5545){const _0x2d41e5=a31_0x3fa80d;if(_0x2d5545===undefined)_0x2d5545=_0x33dd53;var _0x5c2cea=Object['getOwnPropertyDescriptor'](_0x258d2e,_0x33dd53);(!_0x5c2cea||('get'in _0x5c2cea?!_0x258d2e[_0x2d41e5(0x14d)]:_0x5c2cea['writable']||_0x5c2cea['configurable']))&&(_0x5c2cea={'enumerable':!![],'get':function(){return _0x258d2e[_0x33dd53];}}),Object[_0x2d41e5(0x131)](_0x3bb243,_0x2d5545,_0x5c2cea);}:function(_0x27baa2,_0x15c42,_0x560db,_0x2e8cdc){if(_0x2e8cdc===undefined)_0x2e8cdc=_0x560db;_0x27baa2[_0x2e8cdc]=_0x15c42[_0x560db];}),__setModuleDefault=this&&this[a31_0x3fa80d(0x134)]||(Object[a31_0x3fa80d(0x124)]?function(_0x4e8cd2,_0x377401){const _0x42e74f=a31_0x3fa80d;Object['defineProperty'](_0x4e8cd2,_0x42e74f(0x14a),{'enumerable':!![],'value':_0x377401});}:function(_0x19dd43,_0x1d8f82){const _0x2466bd=a31_0x3fa80d;_0x19dd43[_0x2466bd(0x14a)]=_0x1d8f82;}),__importStar=this&&this['__importStar']||function(_0x2dc043){const _0x200436=a31_0x3fa80d;if(_0x2dc043&&_0x2dc043[_0x200436(0x14d)])return _0x2dc043;var _0xba1a9d={};if(_0x2dc043!=null){for(var _0x50889c in _0x2dc043)if(_0x50889c!=='default'&&Object[_0x200436(0x156)][_0x200436(0x146)][_0x200436(0x128)](_0x2dc043,_0x50889c))__createBinding(_0xba1a9d,_0x2dc043,_0x50889c);}return __setModuleDefault(_0xba1a9d,_0x2dc043),_0xba1a9d;},__importDefault=this&&this[a31_0x3fa80d(0x137)]||function(_0x2f08a6){const _0x23d155=a31_0x3fa80d;return _0x2f08a6&&_0x2f08a6[_0x23d155(0x14d)]?_0x2f08a6:{'default':_0x2f08a6};};Object[a31_0x3fa80d(0x131)](exports,a31_0x3fa80d(0x14d),{'value':!![]}),exports[a31_0x3fa80d(0x15c)]=exports[a31_0x3fa80d(0x125)]=exports[a31_0x3fa80d(0x153)]=exports[a31_0x3fa80d(0x165)]=exports[a31_0x3fa80d(0x13b)]=void 0x0;function a31_0x1d97(_0x1ea045,_0x3b38d9){const _0x5096f4=a31_0x5096();return a31_0x1d97=function(_0x1d976a,_0x536455){_0x1d976a=_0x1d976a-0x11d;let _0x243afa=_0x5096f4[_0x1d976a];return _0x243afa;},a31_0x1d97(_0x1ea045,_0x3b38d9);}const Yup=__importStar(require(a31_0x3fa80d(0x15f))),gn_api_sdk_typescript_1=__importDefault(require('gn-api-sdk-typescript')),AppError_1=__importDefault(require(a31_0x3fa80d(0x14b))),Gn_1=__importDefault(require(a31_0x3fa80d(0x12c))),Company_1=__importDefault(require(a31_0x3fa80d(0x162))),Invoices_1=__importDefault(require(a31_0x3fa80d(0x130))),socket_1=require(a31_0x3fa80d(0x123)),Plan_1=__importDefault(require('../models/Plan')),index=async(_0x4afa81,_0x40dd34)=>{const _0x1e4df8=a31_0x3fa80d,_0x358f5b=new gn_api_sdk_typescript_1['default'](Gn_1[_0x1e4df8(0x14a)]);return _0x40dd34[_0x1e4df8(0x15a)](_0x358f5b['getSubscriptions']());};exports[a31_0x3fa80d(0x13b)]=index;const createSubscription=async(_0x451b05,_0x2f70eb)=>{const _0x4a3adc=a31_0x3fa80d,_0x3052e9=new gn_api_sdk_typescript_1[(_0x4a3adc(0x14a))](Gn_1['default']),{companyId:_0xa7e2e2}=_0x451b05['user'],_0x30e329=Yup[_0x4a3adc(0x126)]()['shape']({'price':Yup[_0x4a3adc(0x138)]()[_0x4a3adc(0x13a)](),'users':Yup['string']()['required'](),'plan':Yup[_0x4a3adc(0x138)]()[_0x4a3adc(0x13a)]()});if(!await _0x30e329[_0x4a3adc(0x11f)](_0x451b05['body']))throw new AppError_1[(_0x4a3adc(0x14a))](_0x4a3adc(0x13f),0x190);const _0x5d858d=new Intl[(_0x4a3adc(0x14e))](_0x4a3adc(0x151),{'style':_0x4a3adc(0x12a),'currency':_0x4a3adc(0x143)}),_0x3ed891=await Company_1[_0x4a3adc(0x14a)][_0x4a3adc(0x145)]({'where':{'id':_0xa7e2e2}}),_0x55ab37=await Plan_1['default']['findOne']({'where':{'id':_0x3ed891[_0x4a3adc(0x122)]}}),{invoiceId:_0x255997}=_0x451b05[_0x4a3adc(0x13c)],_0x3634c3=_0x55ab37[_0x4a3adc(0x139)],_0x51535d=_0x5d858d[_0x4a3adc(0x140)](_0x3634c3)[_0x4a3adc(0x12b)]('$',''),_0x3515b={'nome':_0x3ed891[_0x4a3adc(0x16a)]},_0x5325b8=_0x3ed891[_0x4a3adc(0x14c)][_0x4a3adc(0x12b)](/\D/g,'');_0x5325b8[_0x4a3adc(0x132)]===0xb?_0x3515b[_0x4a3adc(0x12e)]=_0x5325b8:_0x3515b[_0x4a3adc(0x160)]=_0x5325b8;const _0x2368e0={'calendario':{'expiracao':0xe10},'devedor':{..._0x3515b},'valor':{'original':_0x51535d},'chave':process[_0x4a3adc(0x142)]['GERENCIANET_CHAVEPIX'],'solicitacaoPagador':_0x4a3adc(0x158)+_0x255997};try{const _0x251e34=await _0x3052e9[_0x4a3adc(0x15d)](null,_0x2368e0),_0x924f5=await _0x3052e9[_0x4a3adc(0x149)]({'id':_0x251e34['loc']['id']});if(!_0x3ed891)throw new AppError_1[(_0x4a3adc(0x14a))]('Company\x20not\x20found',0x194);return _0x2f70eb[_0x4a3adc(0x15a)]({..._0x251e34,'qrcode':_0x924f5});}catch(_0x1699f1){console[_0x4a3adc(0x15e)](_0x4a3adc(0x147),_0x1699f1);throw new AppError_1[(_0x4a3adc(0x14a))]('Validation\x20fails',0x190);}};exports[a31_0x3fa80d(0x165)]=createSubscription;const createWebhook=async(_0x4d37c0,_0x140452)=>{const _0x2ace5d=a31_0x3fa80d,_0x223af4=Yup[_0x2ace5d(0x126)]()[_0x2ace5d(0x169)]({'chave':Yup[_0x2ace5d(0x138)]()[_0x2ace5d(0x13a)](),'url':Yup[_0x2ace5d(0x138)]()[_0x2ace5d(0x13a)]()});if(!await _0x223af4[_0x2ace5d(0x11f)](_0x4d37c0['body']))throw new AppError_1[(_0x2ace5d(0x14a))](_0x2ace5d(0x13f),0x190);const {chave:_0x2e903c,url:_0x3ec652}=_0x4d37c0[_0x2ace5d(0x13c)],_0x5047e6={'webhookUrl':_0x3ec652},_0x5ec9d2={'chave':_0x2e903c};try{const _0x14a6fb=new gn_api_sdk_typescript_1['default'](Gn_1[_0x2ace5d(0x14a)]),_0x7d69c6=await _0x14a6fb[_0x2ace5d(0x11d)](_0x5ec9d2,_0x5047e6);return _0x140452[_0x2ace5d(0x15a)](_0x7d69c6);}catch(_0x6866b7){console[_0x2ace5d(0x15e)](_0x6866b7);}};exports[a31_0x3fa80d(0x153)]=createWebhook;const deleteWebhook=async(_0x40899c,_0x1c305b)=>{const _0x19169b=a31_0x3fa80d,_0x3e3bb8=Yup[_0x19169b(0x126)]()['shape']({'chave':Yup[_0x19169b(0x138)]()['required']()});if(!await _0x3e3bb8[_0x19169b(0x11f)](_0x40899c[_0x19169b(0x13c)]))throw new AppError_1[(_0x19169b(0x14a))](_0x19169b(0x13f),0x190);const {chave:_0x41a581}=_0x40899c[_0x19169b(0x13c)],_0x54c44b={'chave':_0x41a581},_0x1c3126=new gn_api_sdk_typescript_1[(_0x19169b(0x14a))](Gn_1[_0x19169b(0x14a)]),_0x564c3b=await _0x1c3126['pixDeleteWebhook'](_0x54c44b);return _0x1c305b[_0x19169b(0x15a)](_0x564c3b);};exports[a31_0x3fa80d(0x125)]=deleteWebhook;const webhook=async(_0x40da83,_0x5566bb)=>{const _0x5152f0=a31_0x3fa80d,{type:_0xcee7ae}=_0x40da83[_0x5152f0(0x13d)],{evento:_0x35b126}=_0x40da83['body'];if(_0x35b126==='teste_webhook')return _0x5566bb[_0x5152f0(0x15a)]({'ok':!![]});if(_0x40da83[_0x5152f0(0x13c)][_0x5152f0(0x14f)]){const _0x3b17c6=new gn_api_sdk_typescript_1['default'](Gn_1[_0x5152f0(0x14a)]);_0x40da83[_0x5152f0(0x13c)][_0x5152f0(0x14f)][_0x5152f0(0x135)](async _0x25341e=>{const _0x2c5595=_0x5152f0,_0x14ed62=await _0x3b17c6[_0x2c5595(0x164)]({'txid':_0x25341e[_0x2c5595(0x12d)]});if(_0x14ed62['status']===_0x2c5595(0x141)){const {solicitacaoPagador:_0x58acbf}=_0x14ed62,_0x29b463=_0x58acbf[_0x2c5595(0x12b)](_0x2c5595(0x158),''),_0x3493c1=await Invoices_1[_0x2c5595(0x14a)][_0x2c5595(0x167)](_0x29b463),_0x56eee6=_0x3493c1[_0x2c5595(0x12f)],_0x1f5053=await Company_1[_0x2c5595(0x14a)][_0x2c5595(0x167)](_0x56eee6),_0x1946c6=new Date(_0x1f5053['dueDate']);_0x1946c6[_0x2c5595(0x120)](_0x1946c6[_0x2c5595(0x136)]()+0x1e);const _0x4306a5=_0x1946c6['toISOString']()['split']('T')[0x0];if(_0x1f5053){await _0x1f5053[_0x2c5595(0x11e)]({'dueDate':_0x4306a5});const _0x1724fd=await _0x3493c1[_0x2c5595(0x11e)]({'id':_0x29b463,'status':_0x2c5595(0x148)});await _0x1f5053[_0x2c5595(0x144)]();const _0x477d34=(0x0,socket_1[_0x2c5595(0x129)])(),_0x109bc2=await Company_1[_0x2c5595(0x14a)]['findOne']({'where':{'id':_0x56eee6}});_0x477d34[_0x2c5595(0x154)](_0x2c5595(0x150)+_0x56eee6+_0x2c5595(0x127),{'action':_0x14ed62[_0x2c5595(0x16b)],'company':_0x109bc2});}}});}return _0x5566bb[_0x5152f0(0x15a)]({'ok':!![]});};exports[a31_0x3fa80d(0x15c)]=webhook;