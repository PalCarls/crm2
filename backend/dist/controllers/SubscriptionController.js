'use strict';const a31_0x5807c9=a31_0x2563;function a31_0x5138(){const _0x36908b=['hasOwnProperty','getDate','defineProperty','757500NThRoO','format','__createBinding','1705012YlPerw','shape','get','Company\x20not\x20found','companyId','../models/Plan','status','pixDeleteWebhook','__esModule','#Fatura:','8180530xPXMcL','amount','log','length','../libs/socket','createSubscription','error_subscription','273lVgdAW','../config/Gn','prototype','setDate','../models/Company','getIO','__importDefault','CONCLUIDA','pixConfigWebhook','15bNhTEl','string','findByPk','../errors/AppError','replace','forEach','name','params','Validation\x20fails','teste_webhook','en-US','pix','configurable','dueDate','index','company-','body','-payment','update','webhook','cpf','toISOString','getSubscriptions','215157QDymnX','paid','split','../models/Invoices','findOne','isValid','deleteWebhook','create','5149122TEbRqp','31866naRrTz','user','pixDetailCharge','createWebhook','currency','__setModuleDefault','txid','call','object','default','document','json','gn-api-sdk-typescript','18uwrKqz','3335384TMFzLh','required'];a31_0x5138=function(){return _0x36908b;};return a31_0x5138();}(function(_0xe1c5c,_0x2a5025){const _0x5af50b=a31_0x2563,_0x486fde=_0xe1c5c();while(!![]){try{const _0x1d7e8f=-parseInt(_0x5af50b(0x154))/0x1+parseInt(_0x5af50b(0x170))/0x2+parseInt(_0x5af50b(0x15c))/0x3+-parseInt(_0x5af50b(0x173))/0x4*(-parseInt(_0x5af50b(0x13d))/0x5)+parseInt(_0x5af50b(0x15d))/0x6*(-parseInt(_0x5af50b(0x134))/0x7)+-parseInt(_0x5af50b(0x16b))/0x8+parseInt(_0x5af50b(0x16a))/0x9*(-parseInt(_0x5af50b(0x12d))/0xa);if(_0x1d7e8f===_0x2a5025)break;else _0x486fde['push'](_0x486fde['shift']());}catch(_0x48c061){_0x486fde['push'](_0x486fde['shift']());}}}(a31_0x5138,0xdb608));function a31_0x2563(_0x1b2c89,_0x38e297){const _0x513887=a31_0x5138();return a31_0x2563=function(_0x256348,_0x2c493d){_0x256348=_0x256348-0x127;let _0x3c2c45=_0x513887[_0x256348];return _0x3c2c45;},a31_0x2563(_0x1b2c89,_0x38e297);}var __createBinding=this&&this[a31_0x5807c9(0x172)]||(Object[a31_0x5807c9(0x15b)]?function(_0x306ea1,_0x101784,_0x12713d,_0x1f2596){const _0xdaaf9f=a31_0x5807c9;if(_0x1f2596===undefined)_0x1f2596=_0x12713d;var _0x5aaf18=Object['getOwnPropertyDescriptor'](_0x101784,_0x12713d);(!_0x5aaf18||(_0xdaaf9f(0x175)in _0x5aaf18?!_0x101784[_0xdaaf9f(0x12b)]:_0x5aaf18['writable']||_0x5aaf18[_0xdaaf9f(0x149)]))&&(_0x5aaf18={'enumerable':!![],'get':function(){return _0x101784[_0x12713d];}}),Object[_0xdaaf9f(0x16f)](_0x306ea1,_0x1f2596,_0x5aaf18);}:function(_0x326aef,_0x315a16,_0x8a8a92,_0x4a86f3){if(_0x4a86f3===undefined)_0x4a86f3=_0x8a8a92;_0x326aef[_0x4a86f3]=_0x315a16[_0x8a8a92];}),__setModuleDefault=this&&this[a31_0x5807c9(0x162)]||(Object['create']?function(_0x2d2674,_0x5c39cd){const _0x1fd04e=a31_0x5807c9;Object[_0x1fd04e(0x16f)](_0x2d2674,_0x1fd04e(0x166),{'enumerable':!![],'value':_0x5c39cd});}:function(_0x4981ad,_0x4e31c1){_0x4981ad['default']=_0x4e31c1;}),__importStar=this&&this['__importStar']||function(_0x31cc65){const _0x235944=a31_0x5807c9;if(_0x31cc65&&_0x31cc65[_0x235944(0x12b)])return _0x31cc65;var _0x3cea57={};if(_0x31cc65!=null){for(var _0x4cced2 in _0x31cc65)if(_0x4cced2!==_0x235944(0x166)&&Object[_0x235944(0x136)][_0x235944(0x16d)][_0x235944(0x164)](_0x31cc65,_0x4cced2))__createBinding(_0x3cea57,_0x31cc65,_0x4cced2);}return __setModuleDefault(_0x3cea57,_0x31cc65),_0x3cea57;},__importDefault=this&&this[a31_0x5807c9(0x13a)]||function(_0x3f9196){const _0x40bdbc=a31_0x5807c9;return _0x3f9196&&_0x3f9196[_0x40bdbc(0x12b)]?_0x3f9196:{'default':_0x3f9196};};Object['defineProperty'](exports,a31_0x5807c9(0x12b),{'value':!![]}),exports[a31_0x5807c9(0x150)]=exports[a31_0x5807c9(0x15a)]=exports[a31_0x5807c9(0x160)]=exports[a31_0x5807c9(0x132)]=exports['index']=void 0x0;const Yup=__importStar(require('yup')),gn_api_sdk_typescript_1=__importDefault(require(a31_0x5807c9(0x169))),AppError_1=__importDefault(require(a31_0x5807c9(0x140))),Gn_1=__importDefault(require(a31_0x5807c9(0x135))),Company_1=__importDefault(require(a31_0x5807c9(0x138))),Invoices_1=__importDefault(require(a31_0x5807c9(0x157))),socket_1=require(a31_0x5807c9(0x131)),Plan_1=__importDefault(require(a31_0x5807c9(0x128))),index=async(_0x3898d5,_0x32326e)=>{const _0x2e5fd3=a31_0x5807c9,_0x1c21ef=new gn_api_sdk_typescript_1[(_0x2e5fd3(0x166))](Gn_1[_0x2e5fd3(0x166)]);return _0x32326e['json'](_0x1c21ef[_0x2e5fd3(0x153)]());};exports[a31_0x5807c9(0x14b)]=index;const createSubscription=async(_0x2360bf,_0x1ba86c)=>{const _0x4aee77=a31_0x5807c9,_0x4000d9=new gn_api_sdk_typescript_1[(_0x4aee77(0x166))](Gn_1['default']),{companyId:_0x50e2f9}=_0x2360bf[_0x4aee77(0x15e)],_0x5af15a=Yup[_0x4aee77(0x165)]()['shape']({'price':Yup[_0x4aee77(0x13e)]()[_0x4aee77(0x16c)](),'users':Yup[_0x4aee77(0x13e)]()[_0x4aee77(0x16c)](),'plan':Yup[_0x4aee77(0x13e)]()[_0x4aee77(0x16c)]()});if(!await _0x5af15a[_0x4aee77(0x159)](_0x2360bf[_0x4aee77(0x14d)]))throw new AppError_1[(_0x4aee77(0x166))]('Validation\x20fails',0x190);const _0x40608e=new Intl['NumberFormat'](_0x4aee77(0x147),{'style':_0x4aee77(0x161),'currency':'USD'}),_0x2c7c80=await Company_1[_0x4aee77(0x166)][_0x4aee77(0x158)]({'where':{'id':_0x50e2f9}}),_0x489f5e=await Plan_1[_0x4aee77(0x166)][_0x4aee77(0x158)]({'where':{'id':_0x2c7c80['planId']}}),{invoiceId:_0x272420}=_0x2360bf[_0x4aee77(0x14d)],_0x71d1f=_0x489f5e[_0x4aee77(0x12e)],_0x5c938d=_0x40608e[_0x4aee77(0x171)](_0x71d1f)['replace']('$',''),_0x242f0b={'nome':_0x2c7c80[_0x4aee77(0x143)]},_0x37fc71=_0x2c7c80[_0x4aee77(0x167)][_0x4aee77(0x141)](/\D/g,'');_0x37fc71[_0x4aee77(0x130)]===0xb?_0x242f0b[_0x4aee77(0x151)]=_0x37fc71:_0x242f0b['cnpj']=_0x37fc71;const _0xd77d24={'calendario':{'expiracao':0xe10},'devedor':{..._0x242f0b},'valor':{'original':_0x5c938d},'chave':process['env']['GERENCIANET_CHAVEPIX'],'solicitacaoPagador':_0x4aee77(0x12c)+_0x272420};try{const _0x277e9a=await _0x4000d9['pixCreateImmediateCharge'](null,_0xd77d24),_0x32c460=await _0x4000d9['pixGenerateQRCode']({'id':_0x277e9a['loc']['id']});if(!_0x2c7c80)throw new AppError_1[(_0x4aee77(0x166))](_0x4aee77(0x176),0x194);return _0x1ba86c[_0x4aee77(0x168)]({..._0x277e9a,'qrcode':_0x32c460});}catch(_0x16eab9){console[_0x4aee77(0x12f)](_0x4aee77(0x133),_0x16eab9);throw new AppError_1['default'](_0x4aee77(0x145),0x190);}};exports[a31_0x5807c9(0x132)]=createSubscription;const createWebhook=async(_0x43f50e,_0x294ae9)=>{const _0x4383a9=a31_0x5807c9,_0x205a70=Yup[_0x4383a9(0x165)]()[_0x4383a9(0x174)]({'chave':Yup['string']()[_0x4383a9(0x16c)](),'url':Yup[_0x4383a9(0x13e)]()[_0x4383a9(0x16c)]()});if(!await _0x205a70[_0x4383a9(0x159)](_0x43f50e['body']))throw new AppError_1[(_0x4383a9(0x166))](_0x4383a9(0x145),0x190);const {chave:_0x1a0b35,url:_0x3d4739}=_0x43f50e[_0x4383a9(0x14d)],_0x176621={'webhookUrl':_0x3d4739},_0x312209={'chave':_0x1a0b35};try{const _0x5181d=new gn_api_sdk_typescript_1[(_0x4383a9(0x166))](Gn_1[_0x4383a9(0x166)]),_0xfde45c=await _0x5181d[_0x4383a9(0x13c)](_0x312209,_0x176621);return _0x294ae9[_0x4383a9(0x168)](_0xfde45c);}catch(_0x237763){console[_0x4383a9(0x12f)](_0x237763);}};exports[a31_0x5807c9(0x160)]=createWebhook;const deleteWebhook=async(_0x47a324,_0x2974ad)=>{const _0x374fa8=a31_0x5807c9,_0x117bd7=Yup['object']()[_0x374fa8(0x174)]({'chave':Yup['string']()[_0x374fa8(0x16c)]()});if(!await _0x117bd7[_0x374fa8(0x159)](_0x47a324[_0x374fa8(0x14d)]))throw new AppError_1['default'](_0x374fa8(0x145),0x190);const {chave:_0x5676b6}=_0x47a324[_0x374fa8(0x14d)],_0x12d4fd={'chave':_0x5676b6},_0x33308e=new gn_api_sdk_typescript_1[(_0x374fa8(0x166))](Gn_1[_0x374fa8(0x166)]),_0x18e915=await _0x33308e[_0x374fa8(0x12a)](_0x12d4fd);return _0x2974ad[_0x374fa8(0x168)](_0x18e915);};exports['deleteWebhook']=deleteWebhook;const webhook=async(_0x752464,_0x34e2ad)=>{const _0xe8c559=a31_0x5807c9,{type:_0x74f176}=_0x752464[_0xe8c559(0x144)],{evento:_0x4d283a}=_0x752464[_0xe8c559(0x14d)];if(_0x4d283a===_0xe8c559(0x146))return _0x34e2ad[_0xe8c559(0x168)]({'ok':!![]});if(_0x752464[_0xe8c559(0x14d)]['pix']){const _0x3e0d71=new gn_api_sdk_typescript_1[(_0xe8c559(0x166))](Gn_1[_0xe8c559(0x166)]);_0x752464['body'][_0xe8c559(0x148)][_0xe8c559(0x142)](async _0x447210=>{const _0x4a0f8f=_0xe8c559,_0xf1c153=await _0x3e0d71[_0x4a0f8f(0x15f)]({'txid':_0x447210[_0x4a0f8f(0x163)]});if(_0xf1c153[_0x4a0f8f(0x129)]===_0x4a0f8f(0x13b)){const {solicitacaoPagador:_0x2cc763}=_0xf1c153,_0xa1032d=_0x2cc763[_0x4a0f8f(0x141)](_0x4a0f8f(0x12c),''),_0x146d88=await Invoices_1[_0x4a0f8f(0x166)]['findByPk'](_0xa1032d),_0x4bafae=_0x146d88[_0x4a0f8f(0x127)],_0xb1079=await Company_1['default'][_0x4a0f8f(0x13f)](_0x4bafae),_0x11697e=new Date(_0xb1079[_0x4a0f8f(0x14a)]);_0x11697e[_0x4a0f8f(0x137)](_0x11697e[_0x4a0f8f(0x16e)]()+0x1e);const _0x3ebb71=_0x11697e[_0x4a0f8f(0x152)]()[_0x4a0f8f(0x156)]('T')[0x0];if(_0xb1079){await _0xb1079[_0x4a0f8f(0x14f)]({'dueDate':_0x3ebb71});const _0x4e4307=await _0x146d88[_0x4a0f8f(0x14f)]({'id':_0xa1032d,'status':_0x4a0f8f(0x155)});await _0xb1079['reload']();const _0x3bfa9=(0x0,socket_1[_0x4a0f8f(0x139)])(),_0x432211=await Company_1[_0x4a0f8f(0x166)][_0x4a0f8f(0x158)]({'where':{'id':_0x4bafae}});_0x3bfa9['emit'](_0x4a0f8f(0x14c)+_0x4bafae+_0x4a0f8f(0x14e),{'action':_0xf1c153[_0x4a0f8f(0x129)],'company':_0x432211});}}});}return _0x34e2ad[_0xe8c559(0x168)]({'ok':!![]});};exports[a31_0x5807c9(0x150)]=webhook;