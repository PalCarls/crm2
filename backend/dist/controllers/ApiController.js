<<<<<<< HEAD
'use strict';const a8_0x435a20=a8_0x4c2a;function a8_0xc156(){const _0x254f7e=[':*\x0a','shape','usedOther','configurable','../services/WbotServices/SendWhatsAppMedia','../services/ContactServices/CreateOrUpdateContactService','2105MWpkzU','OnWhatsAppDto','default','update','../services/WbotServices/CheckIsValidContact','9000607fhUnVl','object','FRONTEND_URL','toString','8843463DKXRNi','getOwnPropertyDescriptor','index','useDate','matches','../helpers/SetTicketMessagesAsRead','required','name','image','lodash','validate','isInteger','@g.us','1300164WcHNjJ','../services/WbotServices/wbotMessageListener','closed','jid','headers','body','/nopicture.png','getWbot','true','__importDefault','json','findOne','../services/UserServices/ShowUserService','all','10yEvDWD','__esModule','replace','\x20not\x20found','message','files','create','call','../services/WbotServices/SendWhatsAppMessageLink','../services/TicketServices/UpdateTicketService','pdf','7qdcgXR','usedImage','video','parseInt','../errors/AppError','whatsapp\x20#','yup','../services/WbotServices/SendWhatsappMediaImage','string','Cliente\x20em\x20outro\x20atendimento','../models/Whatsapp','9983248FMmluF','SUCCESS','findByPk','API','usedPDF','../helpers/GetDefaultWhatsApp','indexWhatsappsId','companyId','../services/QueueService/ShowQueueService','defineProperty','@s.whatsapp.net','2752xDdOde','writable','Invalid\x20number\x20format.\x20Only\x20numbers\x20is\x20allowed.','3682242xlrZqD','mimetype','../models/ApiUsages','number','caption','exec','indexLink','UsedOnDay','6ldWgxJ','moment','url','usedCheckNumber','send','trim','../services/WbotServices/CheckNumber','../services/TicketServices/ShowTicketService','__setModuleDefault','map','test','whatsapp','includes','verifyMediaMessage','indexImage','contact','authorization','__createBinding','checkNumber','464968bUaWAJ','../models/CompaniesSettings','usedVideo','dataValues','env','format','split','status'];a8_0xc156=function(){return _0x254f7e;};return a8_0xc156();}(function(_0x6fb61f,_0x4c8a1e){const _0x39092f=a8_0x4c2a,_0x544086=_0x6fb61f();while(!![]){try{const _0x28ac0f=parseInt(_0x39092f(0x140))/0x1+parseInt(_0x39092f(0x12d))/0x2*(-parseInt(_0x39092f(0xf3))/0x3)+parseInt(_0x39092f(0x122))/0x4*(-parseInt(_0x39092f(0x14e))/0x5)+parseInt(_0x39092f(0x125))/0x6*(parseInt(_0x39092f(0x10c))/0x7)+parseInt(_0x39092f(0x117))/0x8+parseInt(_0x39092f(0x157))/0x9+-parseInt(_0x39092f(0x101))/0xa*(parseInt(_0x39092f(0x153))/0xb);if(_0x28ac0f===_0x4c8a1e)break;else _0x544086['push'](_0x544086['shift']());}catch(_0x188925){_0x544086['push'](_0x544086['shift']());}}}(a8_0xc156,0xdc013));var __createBinding=this&&this[a8_0x435a20(0x13e)]||(Object[a8_0x435a20(0x107)]?function(_0x2e7887,_0x1242a5,_0x24ee84,_0x27e4a6){const _0x588190=a8_0x435a20;if(_0x27e4a6===undefined)_0x27e4a6=_0x24ee84;var _0x187aa1=Object[_0x588190(0x158)](_0x1242a5,_0x24ee84);(!_0x187aa1||('get'in _0x187aa1?!_0x1242a5[_0x588190(0x102)]:_0x187aa1[_0x588190(0x123)]||_0x187aa1[_0x588190(0x14b)]))&&(_0x187aa1={'enumerable':!![],'get':function(){return _0x1242a5[_0x24ee84];}}),Object[_0x588190(0x120)](_0x2e7887,_0x27e4a6,_0x187aa1);}:function(_0x48877b,_0x3e359f,_0x4ad12b,_0x52dfd3){if(_0x52dfd3===undefined)_0x52dfd3=_0x4ad12b;_0x48877b[_0x52dfd3]=_0x3e359f[_0x4ad12b];}),__setModuleDefault=this&&this[a8_0x435a20(0x135)]||(Object[a8_0x435a20(0x107)]?function(_0x5dd40a,_0xb3fbeb){const _0x5557a4=a8_0x435a20;Object[_0x5557a4(0x120)](_0x5dd40a,_0x5557a4(0x150),{'enumerable':!![],'value':_0xb3fbeb});}:function(_0x35269f,_0x5e823a){const _0x10d282=a8_0x435a20;_0x35269f[_0x10d282(0x150)]=_0x5e823a;}),__importStar=this&&this['__importStar']||function(_0x4d5102){const _0x2cd892=a8_0x435a20;if(_0x4d5102&&_0x4d5102['__esModule'])return _0x4d5102;var _0x3f3eb7={};if(_0x4d5102!=null){for(var _0x233aca in _0x4d5102)if(_0x233aca!==_0x2cd892(0x150)&&Object['prototype']['hasOwnProperty'][_0x2cd892(0x108)](_0x4d5102,_0x233aca))__createBinding(_0x3f3eb7,_0x4d5102,_0x233aca);}return __setModuleDefault(_0x3f3eb7,_0x4d5102),_0x3f3eb7;},__importDefault=this&&this[a8_0x435a20(0xfc)]||function(_0x26392a){const _0x4c714d=a8_0x435a20;return _0x26392a&&_0x26392a[_0x4c714d(0x102)]?_0x26392a:{'default':_0x26392a};};Object[a8_0x435a20(0x120)](exports,a8_0x435a20(0x102),{'value':!![]}),exports[a8_0x435a20(0x11d)]=exports[a8_0x435a20(0x13f)]=exports[a8_0x435a20(0x13b)]=exports[a8_0x435a20(0x159)]=exports[a8_0x435a20(0x12b)]=exports[a8_0x435a20(0x14f)]=void 0x0;const Yup=__importStar(require(a8_0x435a20(0x112))),AppError_1=__importDefault(require(a8_0x435a20(0x110))),GetDefaultWhatsApp_1=__importDefault(require(a8_0x435a20(0x11c))),SetTicketMessagesAsRead_1=__importDefault(require(a8_0x435a20(0x15c))),Whatsapp_1=__importDefault(require(a8_0x435a20(0x116))),CreateOrUpdateContactService_1=__importDefault(require(a8_0x435a20(0x14d))),FindOrCreateTicketService_1=__importDefault(require('../services/TicketServices/FindOrCreateTicketService')),ShowTicketService_1=__importDefault(require(a8_0x435a20(0x134))),CheckIsValidContact_1=__importDefault(require(a8_0x435a20(0x152))),CheckNumber_1=__importDefault(require(a8_0x435a20(0x133))),SendWhatsAppMedia_1=__importDefault(require(a8_0x435a20(0x14c))),UpdateTicketService_1=__importDefault(require(a8_0x435a20(0x10a))),wbot_1=require('../libs/wbot'),SendWhatsAppMessageLink_1=__importDefault(require(a8_0x435a20(0x109))),SendWhatsAppMessageAPI_1=__importDefault(require('../services/WbotServices/SendWhatsAppMessageAPI')),SendWhatsappMediaImage_1=__importDefault(require(a8_0x435a20(0x113))),ApiUsages_1=__importDefault(require(a8_0x435a20(0x127))),useDate_1=require('../utils/useDate'),moment_1=__importDefault(require(a8_0x435a20(0x12e))),CompaniesSettings_1=__importDefault(require(a8_0x435a20(0x141))),ShowUserService_1=__importDefault(require(a8_0x435a20(0xff))),lodash_1=require(a8_0x435a20(0xef)),wbotMessageListener_1=require(a8_0x435a20(0xf4)),ShowQueueService_1=__importDefault(require(a8_0x435a20(0x11f)));class OnWhatsAppDto{constructor(_0x5f3403,_0x388e71){const _0x2a9d6a=a8_0x435a20;this[_0x2a9d6a(0xf6)]=_0x5f3403,this['exists']=_0x388e71;}}exports[a8_0x435a20(0x14f)]=OnWhatsAppDto;const createContact=async(_0x47eb14,_0x439b60,_0x415aca,_0x31ff32,_0x44897f)=>{const _0x28b7e5=a8_0x435a20;await(0x0,CheckIsValidContact_1[_0x28b7e5(0x150)])(_0x415aca,_0x439b60);const _0xc88ac8=await(0x0,CheckNumber_1[_0x28b7e5(0x150)])(_0x415aca,_0x439b60),_0x33e2bf=process[_0x28b7e5(0x144)][_0x28b7e5(0x155)]+_0x28b7e5(0xf9),_0x49a3f9=_0xc88ac8,_0x17102e={'name':''+_0x49a3f9,'number':_0x49a3f9,'profilePicUrl':_0x33e2bf,'isGroup':![],'companyId':_0x439b60},_0xd3a43=await(0x0,CreateOrUpdateContactService_1[_0x28b7e5(0x150)])(_0x17102e),_0x3cfbe5=await CompaniesSettings_1['default'][_0x28b7e5(0xfe)]({'where':{'companyId':_0x439b60}});let _0x512942;if(_0x47eb14===undefined)_0x512942=await(0x0,GetDefaultWhatsApp_1['default'])(_0x439b60);else{_0x512942=await Whatsapp_1['default'][_0x28b7e5(0x119)](_0x47eb14);if(_0x512942===null)throw new AppError_1[(_0x28b7e5(0x150))](_0x28b7e5(0x111)+_0x47eb14+_0x28b7e5(0x104));}const {ticket:_0x44ae5f,isCreated:_0x30f226}=await(0x0,FindOrCreateTicketService_1[_0x28b7e5(0x150)])(_0xd3a43,_0x512942,0x0,_0x439b60,_0x44897f,_0x31ff32,null,_0x28b7e5(0x138),null,![],_0x3cfbe5);let _0x191cb3;return _0x44ae5f&&(_0x191cb3=await(0x0,ShowTicketService_1[_0x28b7e5(0x150)])(_0x44ae5f['id'],_0x439b60),(0x0,SetTicketMessagesAsRead_1[_0x28b7e5(0x150)])(_0x191cb3)),_0x191cb3;};function formatBRNumber(_0x1104c3){const _0x918f27=a8_0x435a20,_0x86fb4b=new RegExp(/^(\d{2})(\d{2})\d{1}(\d{8})$/);if(_0x86fb4b[_0x918f27(0x137)](_0x1104c3)){const _0x36f997=_0x86fb4b[_0x918f27(0x12a)](_0x1104c3);if(_0x36f997&&_0x36f997[0x1]==='55'&&Number[_0x918f27(0xf1)](Number[_0x918f27(0x10f)](_0x36f997[0x2]))){const _0x6f020a=Number[_0x918f27(0x10f)](_0x36f997[0x2]);if(_0x6f020a<0x1f)return _0x36f997[0x0];else{if(_0x6f020a>=0x1f)return _0x36f997[0x1]+_0x36f997[0x2]+_0x36f997[0x3];}}}else return _0x1104c3;}function createJid(_0xc27046){const _0x42c51e=a8_0x435a20;if(_0xc27046[_0x42c51e(0x139)](_0x42c51e(0xf2))||_0xc27046[_0x42c51e(0x139)](_0x42c51e(0x121)))return formatBRNumber(_0xc27046);return _0xc27046[_0x42c51e(0x139)]('-')?_0xc27046+'@g.us':formatBRNumber(_0xc27046)+_0x42c51e(0x121);}const indexLink=async(_0x4abbc5,_0x5ecdc7)=>{const _0x10b802=a8_0x435a20,_0x15fbdb=_0x4abbc5[_0x10b802(0xf8)],{whatsappId:_0x173265}=_0x4abbc5['body'],{msdelay:_0x508b56}=_0x4abbc5[_0x10b802(0xf8)],_0x27369b=_0x4abbc5[_0x10b802(0xf8)][_0x10b802(0x12f)],_0x484f66=_0x4abbc5['body'][_0x10b802(0x129)],_0x34fe62=_0x4abbc5[_0x10b802(0xf7)][_0x10b802(0x13d)],[,_0x5f0905]=_0x34fe62[_0x10b802(0x146)]('\x20'),_0x230bda=await Whatsapp_1[_0x10b802(0x150)]['findOne']({'where':{'token':_0x5f0905}}),_0x56ec6b=_0x230bda[_0x10b802(0x11e)];_0x15fbdb[_0x10b802(0x128)]=_0x15fbdb[_0x10b802(0x128)]['replace']('-','')[_0x10b802(0x103)]('\x20','');const _0x3c4483=Yup[_0x10b802(0x154)]()['shape']({'number':Yup[_0x10b802(0x114)]()[_0x10b802(0x15d)]()['matches'](/^\d+$/,_0x10b802(0x124))});try{await _0x3c4483[_0x10b802(0xf0)](_0x15fbdb);}catch(_0x9fe7f5){throw new AppError_1[(_0x10b802(0x150))](_0x9fe7f5[_0x10b802(0x105)]);}const _0x2c051e=await createContact(_0x173265,_0x56ec6b,_0x15fbdb['number']);if(!_0x2c051e)throw new AppError_1[(_0x10b802(0x150))](_0x10b802(0x115));return await(0x0,SendWhatsAppMessageLink_1[_0x10b802(0x150)])({'whatsappId':_0x173265,'contact':_0x2c051e[_0x10b802(0x13c)],'url':_0x27369b,'caption':_0x484f66,'msdelay':_0x508b56}),setTimeout(async()=>{const _0x198986=_0x10b802,{dateToClient:_0x17ebde}=(0x0,useDate_1['useDate'])(),_0x28cddb=_0x17ebde(new Date()),_0x569875=(0x0,moment_1['default'])()[_0x198986(0x145)](),_0x118942=await ApiUsages_1['default'][_0x198986(0xfe)]({'where':{'dateUsed':_0x28cddb,'companyId':_0x56ec6b}});if(_0x118942)await _0x118942[_0x198986(0x151)]({'usedPDF':_0x118942[_0x198986(0x143)]['usedPDF']+0x1,'UsedOnDay':_0x118942['dataValues']['UsedOnDay']+0x1,'updatedAt':_0x569875});else{const _0x1d64c8=await ApiUsages_1[_0x198986(0x150)][_0x198986(0x107)]({'companyId':_0x56ec6b,'dateUsed':_0x28cddb});await _0x1d64c8[_0x198986(0x151)]({'usedPDF':_0x1d64c8[_0x198986(0x143)][_0x198986(0x11b)]+0x1,'UsedOnDay':_0x1d64c8[_0x198986(0x143)][_0x198986(0x12c)]+0x1,'updatedAt':_0x569875});}},0x64),_0x5ecdc7['send']({'status':_0x10b802(0x118)});};exports[a8_0x435a20(0x12b)]=indexLink;const index=async(_0x554643,_0x5771bd)=>{const _0x476cfd=a8_0x435a20,_0x5629c2=_0x554643[_0x476cfd(0xf8)],{whatsappId:_0x298bcf}=_0x554643[_0x476cfd(0xf8)],{msdelay:_0x3ee909}=_0x554643[_0x476cfd(0xf8)],{body:_0x897bd9,quotedMsg:_0x36324b,userId:_0x25b37b,queueId:_0x24b09e,sendSignature:_0x53e94c,closeTicket:_0x516fac}=_0x554643[_0x476cfd(0xf8)],_0x55e136=_0x554643[_0x476cfd(0x106)],_0x15afc8=_0x554643[_0x476cfd(0xf7)][_0x476cfd(0x13d)],[,_0x235290]=_0x15afc8[_0x476cfd(0x146)]('\x20'),_0x4b2dfa=await Whatsapp_1[_0x476cfd(0x150)][_0x476cfd(0xfe)]({'where':{'token':_0x235290}}),_0x111675=_0x4b2dfa[_0x476cfd(0x11e)];_0x5629c2[_0x476cfd(0x128)]=_0x5629c2[_0x476cfd(0x128)][_0x476cfd(0x103)]('-','')['replace']('\x20','');const _0x351dd1=Yup['object']()['shape']({'number':Yup[_0x476cfd(0x114)]()[_0x476cfd(0x15d)]()['matches'](/^\d+$/,_0x476cfd(0x124))});try{await _0x351dd1[_0x476cfd(0xf0)](_0x5629c2);}catch(_0x29db17){throw new AppError_1[(_0x476cfd(0x150))](_0x29db17['message']);}console['log'](_0x476cfd(0x11a),_0x25b37b,_0x24b09e);let _0x494261;_0x25b37b?.[_0x476cfd(0x156)]()!==''&&!isNaN(_0x25b37b)&&(_0x494261=await(0x0,ShowUserService_1['default'])(_0x25b37b,_0x111675));let _0x2d722a;_0x24b09e?.[_0x476cfd(0x156)]()!==''&&!isNaN(_0x24b09e)&&(_0x2d722a=await(0x0,ShowQueueService_1['default'])(_0x24b09e,_0x111675));const _0x2931b3=await createContact(_0x4b2dfa['id'],_0x111675,_0x5629c2[_0x476cfd(0x128)],_0x25b37b,_0x24b09e);let _0x52434c;_0x53e94c&&!(0x0,lodash_1['isNil'])(_0x494261)?_0x52434c='*'+_0x494261[_0x476cfd(0xed)]+_0x476cfd(0x148)+_0x897bd9[_0x476cfd(0x132)]():_0x52434c=_0x897bd9['trim']();let _0xc0cb80;return _0x55e136?(await Promise[_0x476cfd(0x100)](_0x55e136[_0x476cfd(0x136)](async _0x2c9cb2=>{_0xc0cb80=await(0x0,SendWhatsAppMedia_1['default'])({'body':'‎\x20'+_0x52434c,'media':_0x2c9cb2,'ticket':_0x2931b3,'isForwarded':![]});})),await(0x0,wbotMessageListener_1[_0x476cfd(0x13a)])(_0xc0cb80,_0x2931b3,_0x2931b3['contact'])):(_0xc0cb80=await(0x0,SendWhatsAppMessageAPI_1[_0x476cfd(0x150)])({'body':_0x52434c,'whatsappId':_0x4b2dfa['id'],'contact':_0x2931b3[_0x476cfd(0x13c)],'quotedMsg':_0x36324b,'msdelay':_0x3ee909}),await(0x0,wbotMessageListener_1['verifyMessage'])(_0xc0cb80,_0x2931b3,_0x2931b3['contact'])),_0x516fac&&_0x516fac===_0x476cfd(0xfb)&&setTimeout(async()=>{const _0x5edbb6=_0x476cfd;await(0x0,UpdateTicketService_1[_0x5edbb6(0x150)])({'ticketId':_0x2931b3['id'],'ticketData':{'status':_0x5edbb6(0xf5),'sendFarewellMessage':![],'amountUsedBotQueues':0x0,'lastMessage':_0x897bd9},'companyId':_0x111675});},0x64),setTimeout(async()=>{const _0x45eb49=_0x476cfd,{dateToClient:_0x1990e1}=(0x0,useDate_1[_0x45eb49(0x15a)])(),_0x5f6af4=_0x1990e1(new Date()),_0x1b84cf=(0x0,moment_1[_0x45eb49(0x150)])()[_0x45eb49(0x145)]();let _0x2d093e=await ApiUsages_1['default'][_0x45eb49(0xfe)]({'where':{'dateUsed':_0x5f6af4,'companyId':_0x111675}});_0x2d093e?_0x55e136?await Promise[_0x45eb49(0x100)](_0x55e136[_0x45eb49(0x136)](async _0xc19ef6=>{const _0x229653=_0x45eb49;if(_0xc19ef6[_0x229653(0x126)][_0x229653(0x139)](_0x229653(0x10b)))await _0x2d093e[_0x229653(0x151)]({'usedPDF':_0x2d093e[_0x229653(0x143)]['usedPDF']+0x1,'UsedOnDay':_0x2d093e['dataValues'][_0x229653(0x12c)]+0x1,'updatedAt':_0x1b84cf});else{if(_0xc19ef6[_0x229653(0x126)]['includes'](_0x229653(0xee)))await _0x2d093e['update']({'usedImage':_0x2d093e['dataValues'][_0x229653(0x10d)]+0x1,'UsedOnDay':_0x2d093e[_0x229653(0x143)][_0x229653(0x12c)]+0x1,'updatedAt':_0x1b84cf});else _0xc19ef6[_0x229653(0x126)][_0x229653(0x139)](_0x229653(0x10e))?await _0x2d093e['update']({'usedVideo':_0x2d093e['dataValues']['usedVideo']+0x1,'UsedOnDay':_0x2d093e[_0x229653(0x143)][_0x229653(0x12c)]+0x1,'updatedAt':_0x1b84cf}):await _0x2d093e[_0x229653(0x151)]({'usedOther':_0x2d093e['dataValues'][_0x229653(0x14a)]+0x1,'UsedOnDay':_0x2d093e[_0x229653(0x143)][_0x229653(0x12c)]+0x1,'updatedAt':_0x1b84cf});}})):await _0x2d093e[_0x45eb49(0x151)]({'usedText':_0x2d093e[_0x45eb49(0x143)]['usedText']+0x1,'UsedOnDay':_0x2d093e[_0x45eb49(0x143)][_0x45eb49(0x12c)]+0x1,'updatedAt':_0x1b84cf}):(_0x2d093e=await ApiUsages_1[_0x45eb49(0x150)][_0x45eb49(0x107)]({'companyId':_0x111675,'dateUsed':_0x5f6af4}),_0x55e136?await Promise[_0x45eb49(0x100)](_0x55e136['map'](async _0x59609a=>{const _0x574481=_0x45eb49;if(_0x59609a['mimetype']['includes'](_0x574481(0x10b)))await _0x2d093e[_0x574481(0x151)]({'usedPDF':_0x2d093e['dataValues']['usedPDF']+0x1,'UsedOnDay':_0x2d093e[_0x574481(0x143)][_0x574481(0x12c)]+0x1,'updatedAt':_0x1b84cf});else{if(_0x59609a[_0x574481(0x126)][_0x574481(0x139)](_0x574481(0xee)))await _0x2d093e[_0x574481(0x151)]({'usedImage':_0x2d093e[_0x574481(0x143)][_0x574481(0x10d)]+0x1,'UsedOnDay':_0x2d093e[_0x574481(0x143)][_0x574481(0x12c)]+0x1,'updatedAt':_0x1b84cf});else _0x59609a[_0x574481(0x126)][_0x574481(0x139)]('video')?await _0x2d093e[_0x574481(0x151)]({'usedVideo':_0x2d093e[_0x574481(0x143)][_0x574481(0x142)]+0x1,'UsedOnDay':_0x2d093e[_0x574481(0x143)][_0x574481(0x12c)]+0x1,'updatedAt':_0x1b84cf}):await _0x2d093e[_0x574481(0x151)]({'usedOther':_0x2d093e[_0x574481(0x143)][_0x574481(0x14a)]+0x1,'UsedOnDay':_0x2d093e[_0x574481(0x143)]['UsedOnDay']+0x1,'updatedAt':_0x1b84cf});}})):await _0x2d093e[_0x45eb49(0x151)]({'usedText':_0x2d093e['dataValues']['usedText']+0x1,'UsedOnDay':_0x2d093e[_0x45eb49(0x143)][_0x45eb49(0x12c)]+0x1,'updatedAt':_0x1b84cf}));},0x64),_0x5771bd['send']({'status':_0x476cfd(0x118)});};exports[a8_0x435a20(0x159)]=index;const indexImage=async(_0x33218f,_0x184be1)=>{const _0x55fd6e=a8_0x435a20,_0x22b875=_0x33218f[_0x55fd6e(0xf8)],{whatsappId:_0x344b62}=_0x33218f[_0x55fd6e(0xf8)],{msdelay:_0x17fc48}=_0x33218f[_0x55fd6e(0xf8)],_0x1423e8=_0x33218f['body']['url'],_0x4dac9c=_0x33218f[_0x55fd6e(0xf8)][_0x55fd6e(0x129)],_0x256853=_0x33218f['headers'][_0x55fd6e(0x13d)],[,_0x371920]=_0x256853[_0x55fd6e(0x146)]('\x20'),_0x550331=await Whatsapp_1[_0x55fd6e(0x150)][_0x55fd6e(0xfe)]({'where':{'token':_0x371920}}),_0x4172d2=_0x550331[_0x55fd6e(0x11e)];_0x22b875[_0x55fd6e(0x128)]=_0x22b875[_0x55fd6e(0x128)][_0x55fd6e(0x103)]('-','')[_0x55fd6e(0x103)]('\x20','');const _0xe2f11f=Yup[_0x55fd6e(0x154)]()[_0x55fd6e(0x149)]({'number':Yup[_0x55fd6e(0x114)]()[_0x55fd6e(0x15d)]()[_0x55fd6e(0x15b)](/^\d+$/,_0x55fd6e(0x124))});try{await _0xe2f11f[_0x55fd6e(0xf0)](_0x22b875);}catch(_0x3ac38b){throw new AppError_1['default'](_0x3ac38b[_0x55fd6e(0x105)]);}const _0x2fb152=await createContact(_0x344b62,_0x4172d2,_0x22b875['number']);return _0x1423e8&&await(0x0,SendWhatsappMediaImage_1[_0x55fd6e(0x150)])({'ticket':_0x2fb152,'url':_0x1423e8,'caption':_0x4dac9c,'msdelay':_0x17fc48}),setTimeout(async()=>{const _0x15a615=_0x55fd6e;await(0x0,UpdateTicketService_1[_0x15a615(0x150)])({'ticketId':_0x2fb152['id'],'ticketData':{'status':'closed','sendFarewellMessage':![],'amountUsedBotQueues':0x0},'companyId':_0x4172d2});},0x64),setTimeout(async()=>{const _0x2ce451=_0x55fd6e,{dateToClient:_0x309446}=(0x0,useDate_1[_0x2ce451(0x15a)])(),_0x53fe82=_0x309446(new Date()),_0x5e7e5b=(0x0,moment_1['default'])()['format'](),_0x26b523=await ApiUsages_1[_0x2ce451(0x150)]['findOne']({'where':{'dateUsed':_0x53fe82,'companyId':_0x4172d2}});if(_0x26b523)await _0x26b523['update']({'usedImage':_0x26b523['dataValues'][_0x2ce451(0x10d)]+0x1,'UsedOnDay':_0x26b523['dataValues'][_0x2ce451(0x12c)]+0x1,'updatedAt':_0x5e7e5b});else{const _0x5ad281=await ApiUsages_1['default']['create']({'companyId':_0x4172d2,'dateUsed':_0x53fe82});await _0x5ad281['update']({'usedImage':_0x5ad281[_0x2ce451(0x143)][_0x2ce451(0x10d)]+0x1,'UsedOnDay':_0x5ad281[_0x2ce451(0x143)][_0x2ce451(0x12c)]+0x1,'updatedAt':_0x5e7e5b});}},0x64),_0x184be1[_0x55fd6e(0x131)]({'status':_0x55fd6e(0x118)});};exports[a8_0x435a20(0x13b)]=indexImage;const checkNumber=async(_0x3a33a9,_0x3e33f7)=>{const _0x153c82=a8_0x435a20,_0x369102=_0x3a33a9[_0x153c82(0xf8)],_0x292ff9=_0x3a33a9['headers']['authorization'],[,_0x324a6b]=_0x292ff9[_0x153c82(0x146)]('\x20'),_0xf7a804=await Whatsapp_1['default']['findOne']({'where':{'token':_0x324a6b}}),_0x34c4d7=_0xf7a804[_0x153c82(0x11e)],_0x378201=_0x369102[_0x153c82(0x128)][_0x153c82(0x103)]('-','')['replace']('\x20',''),_0xc33e89=await(0x0,GetDefaultWhatsApp_1['default'])(_0x34c4d7),_0x3335a6=(0x0,wbot_1[_0x153c82(0xfa)])(_0xc33e89['id']),_0x3b512c=createJid(_0x378201);try{const [_0x23887e]=await _0x3335a6['onWhatsApp'](_0x3b512c);if(_0x23887e['exists'])return setTimeout(async()=>{const _0x160e6e=_0x153c82,{dateToClient:_0x4ed91e}=(0x0,useDate_1[_0x160e6e(0x15a)])(),_0x41d545=_0x4ed91e(new Date()),_0x48bffe=(0x0,moment_1[_0x160e6e(0x150)])()[_0x160e6e(0x145)](),_0x11b9bb=await ApiUsages_1[_0x160e6e(0x150)][_0x160e6e(0xfe)]({'where':{'dateUsed':_0x41d545,'companyId':_0x34c4d7}});if(_0x11b9bb)await _0x11b9bb[_0x160e6e(0x151)]({'usedCheckNumber':_0x11b9bb[_0x160e6e(0x143)][_0x160e6e(0x130)]+0x1,'UsedOnDay':_0x11b9bb['dataValues'][_0x160e6e(0x12c)]+0x1,'updatedAt':_0x48bffe});else{const _0x3eb535=await ApiUsages_1[_0x160e6e(0x150)]['create']({'companyId':_0x34c4d7,'dateUsed':_0x41d545});await _0x3eb535[_0x160e6e(0x151)]({'usedCheckNumber':_0x3eb535[_0x160e6e(0x143)][_0x160e6e(0x130)]+0x1,'UsedOnDay':_0x3eb535[_0x160e6e(0x143)][_0x160e6e(0x12c)]+0x1,'updatedAt':_0x48bffe});}},0x64),_0x3e33f7[_0x153c82(0x147)](0xc8)[_0x153c82(0xfd)]({'existsInWhatsapp':!![],'number':_0x378201,'numberFormatted':_0x23887e[_0x153c82(0xf6)]});}catch(_0x3e451a){return _0x3e33f7[_0x153c82(0x147)](0x190)[_0x153c82(0xfd)]({'existsInWhatsapp':![],'number':_0x3b512c,'error':'Not\x20exists\x20on\x20Whatsapp'});}};exports[a8_0x435a20(0x13f)]=checkNumber;const indexWhatsappsId=async(_0x5fb675,_0x2b7743)=>{const _0x1b42c8=a8_0x435a20;return _0x2b7743[_0x1b42c8(0x147)](0xc8)[_0x1b42c8(0xfd)]('oi');};function a8_0x4c2a(_0x292d61,_0x55eef7){const _0xc15643=a8_0xc156();return a8_0x4c2a=function(_0x4c2ab9,_0x2a8c3a){_0x4c2ab9=_0x4c2ab9-0xed;let _0x17fa1b=_0xc15643[_0x4c2ab9];return _0x17fa1b;},a8_0x4c2a(_0x292d61,_0x55eef7);}exports['indexWhatsappsId']=indexWhatsappsId;
=======
'use strict';const a8_0x36975c=a8_0x23d0;(function(_0x378ca1,_0x208614){const _0x5ab531=a8_0x23d0,_0x316efd=_0x378ca1();while(!![]){try{const _0x5eeb78=parseInt(_0x5ab531(0xb3))/0x1+parseInt(_0x5ab531(0xe2))/0x2+-parseInt(_0x5ab531(0x95))/0x3*(parseInt(_0x5ab531(0xe9))/0x4)+parseInt(_0x5ab531(0xb4))/0x5*(parseInt(_0x5ab531(0xcc))/0x6)+parseInt(_0x5ab531(0xd2))/0x7*(parseInt(_0x5ab531(0xab))/0x8)+parseInt(_0x5ab531(0xe4))/0x9+-parseInt(_0x5ab531(0xe3))/0xa*(parseInt(_0x5ab531(0xa2))/0xb);if(_0x5eeb78===_0x208614)break;else _0x316efd['push'](_0x316efd['shift']());}catch(_0x1b6be0){_0x316efd['push'](_0x316efd['shift']());}}}(a8_0x389e,0xaa07c));var __createBinding=this&&this[a8_0x36975c(0xe8)]||(Object['create']?function(_0x385e2a,_0x46f43e,_0x28cdbb,_0x29f89f){const _0x210b92=a8_0x36975c;if(_0x29f89f===undefined)_0x29f89f=_0x28cdbb;var _0x588917=Object[_0x210b92(0xbd)](_0x46f43e,_0x28cdbb);(!_0x588917||(_0x210b92(0xf2)in _0x588917?!_0x46f43e[_0x210b92(0xa4)]:_0x588917['writable']||_0x588917['configurable']))&&(_0x588917={'enumerable':!![],'get':function(){return _0x46f43e[_0x28cdbb];}}),Object[_0x210b92(0xbc)](_0x385e2a,_0x29f89f,_0x588917);}:function(_0x152006,_0x319326,_0x3dd01d,_0x42463f){if(_0x42463f===undefined)_0x42463f=_0x3dd01d;_0x152006[_0x42463f]=_0x319326[_0x3dd01d];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0xa92bc9,_0x196c8c){const _0xde510=a8_0x36975c;Object[_0xde510(0xbc)](_0xa92bc9,_0xde510(0xe0),{'enumerable':!![],'value':_0x196c8c});}:function(_0x44d500,_0x289fec){const _0x3868b8=a8_0x36975c;_0x44d500[_0x3868b8(0xe0)]=_0x289fec;}),__importStar=this&&this[a8_0x36975c(0x9a)]||function(_0x60b78a){const _0x29d179=a8_0x36975c;if(_0x60b78a&&_0x60b78a[_0x29d179(0xa4)])return _0x60b78a;var _0x1a79e5={};if(_0x60b78a!=null){for(var _0x1598db in _0x60b78a)if(_0x1598db!==_0x29d179(0xe0)&&Object[_0x29d179(0xcb)][_0x29d179(0xd9)][_0x29d179(0xbe)](_0x60b78a,_0x1598db))__createBinding(_0x1a79e5,_0x60b78a,_0x1598db);}return __setModuleDefault(_0x1a79e5,_0x60b78a),_0x1a79e5;},__importDefault=this&&this[a8_0x36975c(0x92)]||function(_0x5641d6){const _0x3c6527=a8_0x36975c;return _0x5641d6&&_0x5641d6[_0x3c6527(0xa4)]?_0x5641d6:{'default':_0x5641d6};};Object[a8_0x36975c(0xbc)](exports,'__esModule',{'value':!![]}),exports[a8_0x36975c(0xaa)]=exports[a8_0x36975c(0xef)]=exports['indexImage']=exports[a8_0x36975c(0xdb)]=exports['indexLink']=exports['OnWhatsAppDto']=void 0x0;const Yup=__importStar(require(a8_0x36975c(0xde))),AppError_1=__importDefault(require(a8_0x36975c(0x94))),GetDefaultWhatsApp_1=__importDefault(require(a8_0x36975c(0xe7))),SetTicketMessagesAsRead_1=__importDefault(require(a8_0x36975c(0xb8))),Whatsapp_1=__importDefault(require(a8_0x36975c(0xf6))),CreateOrUpdateContactService_1=__importDefault(require(a8_0x36975c(0xdc))),FindOrCreateTicketService_1=__importDefault(require(a8_0x36975c(0xd7))),ShowTicketService_1=__importDefault(require(a8_0x36975c(0xed))),CheckIsValidContact_1=__importDefault(require('../services/WbotServices/CheckIsValidContact')),CheckNumber_1=__importDefault(require(a8_0x36975c(0xa6))),SendWhatsAppMedia_1=__importDefault(require(a8_0x36975c(0x9c))),UpdateTicketService_1=__importDefault(require(a8_0x36975c(0xc7))),wbot_1=require('../libs/wbot'),SendWhatsAppMessageLink_1=__importDefault(require(a8_0x36975c(0xb0))),SendWhatsAppMessageAPI_1=__importDefault(require('../services/WbotServices/SendWhatsAppMessageAPI')),SendWhatsappMediaImage_1=__importDefault(require(a8_0x36975c(0x98))),ApiUsages_1=__importDefault(require(a8_0x36975c(0xa7))),useDate_1=require('../utils/useDate'),moment_1=__importDefault(require(a8_0x36975c(0xdf))),CompaniesSettings_1=__importDefault(require(a8_0x36975c(0xeb))),ShowUserService_1=__importDefault(require('../services/UserServices/ShowUserService')),lodash_1=require(a8_0x36975c(0xdd)),wbotMessageListener_1=require('../services/WbotServices/wbotMessageListener'),ShowQueueService_1=__importDefault(require('../services/QueueService/ShowQueueService'));function a8_0x389e(){const _0x34fd74=['verifyMediaMessage','test','json','prototype','66642ZrUDmX','required','closed','exec','headers','\x20not\x20found','21szsSPs','findOne','dataValues','video','contact','../services/TicketServices/FindOrCreateTicketService','indexImage','hasOwnProperty','companyId','index','../services/ContactServices/CreateOrUpdateContactService','lodash','yup','moment','default','number','63954OkDxPY','190erzOOv','5828400tWKtng','map','files','../helpers/GetDefaultWhatsApp','__createBinding','1809256QXmeTA','indexLink','../models/CompaniesSettings','format','../services/TicketServices/ShowTicketService','caption','checkNumber','usedVideo','useDate','get','message','FRONTEND_URL','object','../models/Whatsapp','env','update','@s.whatsapp.net','string','matches','Cliente\x20em\x20outro\x20atendimento','__importDefault','includes','../errors/AppError','6qImKWK','verifyMessage','body','../services/WbotServices/SendWhatsappMediaImage','isNil','__importStar','jid','../services/WbotServices/SendWhatsAppMedia','send','usedCheckNumber','toString','pdf','usedPDF','926002ILlZDn','whatsapp','__esModule','replace','../services/WbotServices/CheckNumber','../models/ApiUsages','isInteger','usedOther','indexWhatsappsId','3121288xJmXVS','true','Not\x20exists\x20on\x20Whatsapp','all','Invalid\x20number\x20format.\x20Only\x20numbers\x20is\x20allowed.','../services/WbotServices/SendWhatsAppMessageLink','whatsapp\x20#','mimetype','361947pFQYuI','445yWXuon','@g.us','split','trim','../helpers/SetTicketMessagesAsRead','UsedOnDay','API','shape','defineProperty','getOwnPropertyDescriptor','call','usedImage','status','parseInt','log','image','create',':*\x0a','onWhatsApp','../services/TicketServices/UpdateTicketService'];a8_0x389e=function(){return _0x34fd74;};return a8_0x389e();}class OnWhatsAppDto{constructor(_0x160d44,_0x2e8a52){const _0x5af99b=a8_0x36975c;this[_0x5af99b(0x9b)]=_0x160d44,this['exists']=_0x2e8a52;}}exports['OnWhatsAppDto']=OnWhatsAppDto;const createContact=async(_0x2b6c1c,_0x4203c8,_0x946898,_0x21c17d,_0x3bcb48)=>{const _0xd8ef93=a8_0x36975c;await(0x0,CheckIsValidContact_1[_0xd8ef93(0xe0)])(_0x946898,_0x4203c8);const _0x16d07e=await(0x0,CheckNumber_1[_0xd8ef93(0xe0)])(_0x946898,_0x4203c8),_0x46a1f8=process[_0xd8ef93(0xf7)][_0xd8ef93(0xf4)]+'/nopicture.png',_0x42a2ef=_0x16d07e,_0x19d21e={'name':''+_0x42a2ef,'number':_0x42a2ef,'profilePicUrl':_0x46a1f8,'isGroup':![],'companyId':_0x4203c8},_0x12ff84=await(0x0,CreateOrUpdateContactService_1[_0xd8ef93(0xe0)])(_0x19d21e),_0x587428=await CompaniesSettings_1[_0xd8ef93(0xe0)][_0xd8ef93(0xd3)]({'where':{'companyId':_0x4203c8}});let _0x2413d4;if(_0x2b6c1c===undefined)_0x2413d4=await(0x0,GetDefaultWhatsApp_1[_0xd8ef93(0xe0)])(_0x4203c8);else{_0x2413d4=await Whatsapp_1['default']['findByPk'](_0x2b6c1c);if(_0x2413d4===null)throw new AppError_1['default'](_0xd8ef93(0xb1)+_0x2b6c1c+_0xd8ef93(0xd1));}const {ticket:_0x3b0471,isCreated:_0x124f28}=await(0x0,FindOrCreateTicketService_1['default'])(_0x12ff84,_0x2413d4,0x0,_0x4203c8,_0x3bcb48,_0x21c17d,null,_0xd8ef93(0xa3),null,![],_0x587428);let _0x13a4c7;return _0x3b0471&&(_0x13a4c7=await(0x0,ShowTicketService_1['default'])(_0x3b0471['id'],_0x4203c8),(0x0,SetTicketMessagesAsRead_1[_0xd8ef93(0xe0)])(_0x13a4c7)),_0x13a4c7;};function formatBRNumber(_0x52aa2c){const _0x5b1ec0=a8_0x36975c,_0x3c9fdf=new RegExp(/^(\d{2})(\d{2})\d{1}(\d{8})$/);if(_0x3c9fdf[_0x5b1ec0(0xc9)](_0x52aa2c)){const _0x5e1ec4=_0x3c9fdf[_0x5b1ec0(0xcf)](_0x52aa2c);if(_0x5e1ec4&&_0x5e1ec4[0x1]==='55'&&Number[_0x5b1ec0(0xa8)](Number[_0x5b1ec0(0xc1)](_0x5e1ec4[0x2]))){const _0x4620b2=Number[_0x5b1ec0(0xc1)](_0x5e1ec4[0x2]);if(_0x4620b2<0x1f)return _0x5e1ec4[0x0];else{if(_0x4620b2>=0x1f)return _0x5e1ec4[0x1]+_0x5e1ec4[0x2]+_0x5e1ec4[0x3];}}}else return _0x52aa2c;}function createJid(_0x376e0a){const _0x1bb1b7=a8_0x36975c;if(_0x376e0a[_0x1bb1b7(0x93)](_0x1bb1b7(0xb5))||_0x376e0a[_0x1bb1b7(0x93)]('@s.whatsapp.net'))return formatBRNumber(_0x376e0a);return _0x376e0a[_0x1bb1b7(0x93)]('-')?_0x376e0a+'@g.us':formatBRNumber(_0x376e0a)+_0x1bb1b7(0xf9);}const indexLink=async(_0x5493c9,_0x3a88f4)=>{const _0x2251ca=a8_0x36975c,_0x2a0ff1=_0x5493c9[_0x2251ca(0x97)],{whatsappId:_0xa55f29}=_0x5493c9[_0x2251ca(0x97)],{msdelay:_0x134a30}=_0x5493c9[_0x2251ca(0x97)],_0x4d4e61=_0x5493c9[_0x2251ca(0x97)]['url'],_0xfd11a9=_0x5493c9[_0x2251ca(0x97)][_0x2251ca(0xee)],_0x3b26e6=_0x5493c9[_0x2251ca(0xd0)]['authorization'],[,_0x16885b]=_0x3b26e6[_0x2251ca(0xb6)]('\x20'),_0x133b17=await Whatsapp_1[_0x2251ca(0xe0)][_0x2251ca(0xd3)]({'where':{'token':_0x16885b}}),_0x3d5fdf=_0x133b17[_0x2251ca(0xda)];_0x2a0ff1[_0x2251ca(0xe1)]=_0x2a0ff1[_0x2251ca(0xe1)]['replace']('-','')[_0x2251ca(0xa5)]('\x20','');const _0x41eeed=Yup[_0x2251ca(0xf5)]()[_0x2251ca(0xbb)]({'number':Yup[_0x2251ca(0xfa)]()[_0x2251ca(0xcd)]()[_0x2251ca(0x90)](/^\d+$/,_0x2251ca(0xaf))});try{await _0x41eeed['validate'](_0x2a0ff1);}catch(_0x5d650f){throw new AppError_1[(_0x2251ca(0xe0))](_0x5d650f[_0x2251ca(0xf3)]);}const _0x2a7435=await createContact(_0xa55f29,_0x3d5fdf,_0x2a0ff1[_0x2251ca(0xe1)]);if(!_0x2a7435)throw new AppError_1[(_0x2251ca(0xe0))](_0x2251ca(0x91));return await(0x0,SendWhatsAppMessageLink_1[_0x2251ca(0xe0)])({'whatsappId':_0xa55f29,'contact':_0x2a7435['contact'],'url':_0x4d4e61,'caption':_0xfd11a9,'msdelay':_0x134a30}),setTimeout(async()=>{const _0x47cb07=_0x2251ca,{dateToClient:_0x854d60}=(0x0,useDate_1[_0x47cb07(0xf1)])(),_0x40faff=_0x854d60(new Date()),_0x174795=(0x0,moment_1[_0x47cb07(0xe0)])()[_0x47cb07(0xec)](),_0x4b14e0=await ApiUsages_1['default'][_0x47cb07(0xd3)]({'where':{'dateUsed':_0x40faff,'companyId':_0x3d5fdf}});if(_0x4b14e0)await _0x4b14e0['update']({'usedPDF':_0x4b14e0[_0x47cb07(0xd4)][_0x47cb07(0xa1)]+0x1,'UsedOnDay':_0x4b14e0['dataValues'][_0x47cb07(0xb9)]+0x1,'updatedAt':_0x174795});else{const _0x1479a8=await ApiUsages_1[_0x47cb07(0xe0)][_0x47cb07(0xc4)]({'companyId':_0x3d5fdf,'dateUsed':_0x40faff});await _0x1479a8[_0x47cb07(0xf8)]({'usedPDF':_0x1479a8[_0x47cb07(0xd4)]['usedPDF']+0x1,'UsedOnDay':_0x1479a8['dataValues'][_0x47cb07(0xb9)]+0x1,'updatedAt':_0x174795});}},0x64),_0x3a88f4['send']({'status':'SUCCESS'});};exports[a8_0x36975c(0xea)]=indexLink;const index=async(_0x3e4567,_0x4dd55c)=>{const _0x4f0225=a8_0x36975c,_0x1ea35e=_0x3e4567[_0x4f0225(0x97)],{whatsappId:_0x4a6d80}=_0x3e4567[_0x4f0225(0x97)],{msdelay:_0x4bccf3}=_0x3e4567[_0x4f0225(0x97)],{body:_0x309c19,quotedMsg:_0x451fe9,userId:_0x2d5867,queueId:_0x4a9ece,sendSignature:_0x1b793f,closeTicket:_0x773e52}=_0x3e4567[_0x4f0225(0x97)],_0x1de61e=_0x3e4567[_0x4f0225(0xe6)],_0x2639d2=_0x3e4567[_0x4f0225(0xd0)]['authorization'],[,_0x230c86]=_0x2639d2['split']('\x20'),_0x4e4e97=await Whatsapp_1['default']['findOne']({'where':{'token':_0x230c86}}),_0x3b5196=_0x4e4e97[_0x4f0225(0xda)];_0x1ea35e[_0x4f0225(0xe1)]=_0x1ea35e[_0x4f0225(0xe1)][_0x4f0225(0xa5)]('-','')['replace']('\x20','');const _0x2592d1=Yup[_0x4f0225(0xf5)]()[_0x4f0225(0xbb)]({'number':Yup[_0x4f0225(0xfa)]()[_0x4f0225(0xcd)]()[_0x4f0225(0x90)](/^\d+$/,_0x4f0225(0xaf))});try{await _0x2592d1['validate'](_0x1ea35e);}catch(_0x2f3adc){throw new AppError_1['default'](_0x2f3adc[_0x4f0225(0xf3)]);}console[_0x4f0225(0xc2)](_0x4f0225(0xba),_0x2d5867,_0x4a9ece);let _0x3c62fa;_0x2d5867?.['toString']()!==''&&!isNaN(_0x2d5867)&&(_0x3c62fa=await(0x0,ShowUserService_1[_0x4f0225(0xe0)])(_0x2d5867,_0x3b5196));let _0x460251;_0x4a9ece?.[_0x4f0225(0x9f)]()!==''&&!isNaN(_0x4a9ece)&&(_0x460251=await(0x0,ShowQueueService_1[_0x4f0225(0xe0)])(_0x4a9ece,_0x3b5196));const _0x1a7bf6=await createContact(_0x4e4e97['id'],_0x3b5196,_0x1ea35e[_0x4f0225(0xe1)],_0x2d5867,_0x4a9ece);let _0x19b0c4;_0x1b793f&&!(0x0,lodash_1[_0x4f0225(0x99)])(_0x3c62fa)?_0x19b0c4='*'+_0x3c62fa['name']+_0x4f0225(0xc5)+_0x309c19[_0x4f0225(0xb7)]():_0x19b0c4=_0x309c19[_0x4f0225(0xb7)]();let _0x5eaa06;return _0x1de61e?(await Promise[_0x4f0225(0xae)](_0x1de61e[_0x4f0225(0xe5)](async _0x372bce=>{const _0x2844cb=_0x4f0225;_0x5eaa06=await(0x0,SendWhatsAppMedia_1[_0x2844cb(0xe0)])({'body':'‎\x20'+_0x19b0c4,'media':_0x372bce,'ticket':_0x1a7bf6,'isForwarded':![]});})),await(0x0,wbotMessageListener_1[_0x4f0225(0xc8)])(_0x5eaa06,_0x1a7bf6,_0x1a7bf6[_0x4f0225(0xd6)])):(_0x5eaa06=await(0x0,SendWhatsAppMessageAPI_1['default'])({'body':_0x19b0c4,'whatsappId':_0x4e4e97['id'],'contact':_0x1a7bf6[_0x4f0225(0xd6)],'quotedMsg':_0x451fe9,'msdelay':_0x4bccf3}),await(0x0,wbotMessageListener_1[_0x4f0225(0x96)])(_0x5eaa06,_0x1a7bf6,_0x1a7bf6[_0x4f0225(0xd6)])),_0x773e52&&_0x773e52===_0x4f0225(0xac)&&setTimeout(async()=>{const _0x3f695e=_0x4f0225;await(0x0,UpdateTicketService_1[_0x3f695e(0xe0)])({'ticketId':_0x1a7bf6['id'],'ticketData':{'status':_0x3f695e(0xce),'sendFarewellMessage':![],'amountUsedBotQueues':0x0,'lastMessage':_0x309c19},'companyId':_0x3b5196});},0x64),setTimeout(async()=>{const _0x448323=_0x4f0225,{dateToClient:_0x14126c}=(0x0,useDate_1[_0x448323(0xf1)])(),_0x51d33b=_0x14126c(new Date()),_0xcf9266=(0x0,moment_1['default'])()[_0x448323(0xec)]();let _0x10fa5f=await ApiUsages_1[_0x448323(0xe0)][_0x448323(0xd3)]({'where':{'dateUsed':_0x51d33b,'companyId':_0x3b5196}});_0x10fa5f?_0x1de61e?await Promise[_0x448323(0xae)](_0x1de61e[_0x448323(0xe5)](async _0x5c663d=>{const _0x155181=_0x448323;if(_0x5c663d[_0x155181(0xb2)][_0x155181(0x93)](_0x155181(0xa0)))await _0x10fa5f[_0x155181(0xf8)]({'usedPDF':_0x10fa5f[_0x155181(0xd4)][_0x155181(0xa1)]+0x1,'UsedOnDay':_0x10fa5f['dataValues'][_0x155181(0xb9)]+0x1,'updatedAt':_0xcf9266});else{if(_0x5c663d['mimetype'][_0x155181(0x93)](_0x155181(0xc3)))await _0x10fa5f['update']({'usedImage':_0x10fa5f[_0x155181(0xd4)][_0x155181(0xbf)]+0x1,'UsedOnDay':_0x10fa5f[_0x155181(0xd4)][_0x155181(0xb9)]+0x1,'updatedAt':_0xcf9266});else _0x5c663d[_0x155181(0xb2)]['includes'](_0x155181(0xd5))?await _0x10fa5f[_0x155181(0xf8)]({'usedVideo':_0x10fa5f[_0x155181(0xd4)]['usedVideo']+0x1,'UsedOnDay':_0x10fa5f[_0x155181(0xd4)][_0x155181(0xb9)]+0x1,'updatedAt':_0xcf9266}):await _0x10fa5f['update']({'usedOther':_0x10fa5f['dataValues']['usedOther']+0x1,'UsedOnDay':_0x10fa5f[_0x155181(0xd4)][_0x155181(0xb9)]+0x1,'updatedAt':_0xcf9266});}})):await _0x10fa5f['update']({'usedText':_0x10fa5f[_0x448323(0xd4)]['usedText']+0x1,'UsedOnDay':_0x10fa5f['dataValues'][_0x448323(0xb9)]+0x1,'updatedAt':_0xcf9266}):(_0x10fa5f=await ApiUsages_1[_0x448323(0xe0)][_0x448323(0xc4)]({'companyId':_0x3b5196,'dateUsed':_0x51d33b}),_0x1de61e?await Promise[_0x448323(0xae)](_0x1de61e['map'](async _0x4342e7=>{const _0x1751bf=_0x448323;if(_0x4342e7[_0x1751bf(0xb2)][_0x1751bf(0x93)](_0x1751bf(0xa0)))await _0x10fa5f[_0x1751bf(0xf8)]({'usedPDF':_0x10fa5f[_0x1751bf(0xd4)][_0x1751bf(0xa1)]+0x1,'UsedOnDay':_0x10fa5f[_0x1751bf(0xd4)]['UsedOnDay']+0x1,'updatedAt':_0xcf9266});else{if(_0x4342e7[_0x1751bf(0xb2)][_0x1751bf(0x93)](_0x1751bf(0xc3)))await _0x10fa5f['update']({'usedImage':_0x10fa5f['dataValues'][_0x1751bf(0xbf)]+0x1,'UsedOnDay':_0x10fa5f[_0x1751bf(0xd4)][_0x1751bf(0xb9)]+0x1,'updatedAt':_0xcf9266});else _0x4342e7['mimetype'][_0x1751bf(0x93)](_0x1751bf(0xd5))?await _0x10fa5f[_0x1751bf(0xf8)]({'usedVideo':_0x10fa5f[_0x1751bf(0xd4)][_0x1751bf(0xf0)]+0x1,'UsedOnDay':_0x10fa5f['dataValues'][_0x1751bf(0xb9)]+0x1,'updatedAt':_0xcf9266}):await _0x10fa5f[_0x1751bf(0xf8)]({'usedOther':_0x10fa5f[_0x1751bf(0xd4)][_0x1751bf(0xa9)]+0x1,'UsedOnDay':_0x10fa5f['dataValues'][_0x1751bf(0xb9)]+0x1,'updatedAt':_0xcf9266});}})):await _0x10fa5f[_0x448323(0xf8)]({'usedText':_0x10fa5f[_0x448323(0xd4)]['usedText']+0x1,'UsedOnDay':_0x10fa5f[_0x448323(0xd4)][_0x448323(0xb9)]+0x1,'updatedAt':_0xcf9266}));},0x64),_0x4dd55c['send']({'status':'SUCCESS'});};exports[a8_0x36975c(0xdb)]=index;const indexImage=async(_0x464bec,_0x504a60)=>{const _0x78ab06=a8_0x36975c,_0xddece8=_0x464bec[_0x78ab06(0x97)],{whatsappId:_0x4452d6}=_0x464bec['body'],{msdelay:_0x3705c7}=_0x464bec[_0x78ab06(0x97)],_0xaf471d=_0x464bec[_0x78ab06(0x97)]['url'],_0x34ff8a=_0x464bec[_0x78ab06(0x97)][_0x78ab06(0xee)],_0x3680e0=_0x464bec[_0x78ab06(0xd0)]['authorization'],[,_0x498616]=_0x3680e0[_0x78ab06(0xb6)]('\x20'),_0x3217cd=await Whatsapp_1[_0x78ab06(0xe0)][_0x78ab06(0xd3)]({'where':{'token':_0x498616}}),_0x5388cb=_0x3217cd[_0x78ab06(0xda)];_0xddece8[_0x78ab06(0xe1)]=_0xddece8['number']['replace']('-','')[_0x78ab06(0xa5)]('\x20','');const _0x440fbc=Yup['object']()[_0x78ab06(0xbb)]({'number':Yup[_0x78ab06(0xfa)]()[_0x78ab06(0xcd)]()[_0x78ab06(0x90)](/^\d+$/,_0x78ab06(0xaf))});try{await _0x440fbc['validate'](_0xddece8);}catch(_0x3b966d){throw new AppError_1['default'](_0x3b966d[_0x78ab06(0xf3)]);}const _0x104564=await createContact(_0x4452d6,_0x5388cb,_0xddece8[_0x78ab06(0xe1)]);return _0xaf471d&&await(0x0,SendWhatsappMediaImage_1[_0x78ab06(0xe0)])({'ticket':_0x104564,'url':_0xaf471d,'caption':_0x34ff8a,'msdelay':_0x3705c7}),setTimeout(async()=>{const _0x3aed6b=_0x78ab06;await(0x0,UpdateTicketService_1[_0x3aed6b(0xe0)])({'ticketId':_0x104564['id'],'ticketData':{'status':_0x3aed6b(0xce),'sendFarewellMessage':![],'amountUsedBotQueues':0x0},'companyId':_0x5388cb});},0x64),setTimeout(async()=>{const _0x2694d1=_0x78ab06,{dateToClient:_0x4d3a3b}=(0x0,useDate_1[_0x2694d1(0xf1)])(),_0x5d8d52=_0x4d3a3b(new Date()),_0x571af5=(0x0,moment_1[_0x2694d1(0xe0)])()[_0x2694d1(0xec)](),_0x1988f3=await ApiUsages_1[_0x2694d1(0xe0)][_0x2694d1(0xd3)]({'where':{'dateUsed':_0x5d8d52,'companyId':_0x5388cb}});if(_0x1988f3)await _0x1988f3[_0x2694d1(0xf8)]({'usedImage':_0x1988f3[_0x2694d1(0xd4)][_0x2694d1(0xbf)]+0x1,'UsedOnDay':_0x1988f3['dataValues'][_0x2694d1(0xb9)]+0x1,'updatedAt':_0x571af5});else{const _0x5bae26=await ApiUsages_1[_0x2694d1(0xe0)]['create']({'companyId':_0x5388cb,'dateUsed':_0x5d8d52});await _0x5bae26[_0x2694d1(0xf8)]({'usedImage':_0x5bae26['dataValues'][_0x2694d1(0xbf)]+0x1,'UsedOnDay':_0x5bae26['dataValues']['UsedOnDay']+0x1,'updatedAt':_0x571af5});}},0x64),_0x504a60[_0x78ab06(0x9d)]({'status':'SUCCESS'});};exports[a8_0x36975c(0xd8)]=indexImage;const checkNumber=async(_0x5a47f5,_0xf12326)=>{const _0x191064=a8_0x36975c,_0x1ae8eb=_0x5a47f5[_0x191064(0x97)],_0x4b73bd=_0x5a47f5[_0x191064(0xd0)]['authorization'],[,_0x5b27f0]=_0x4b73bd[_0x191064(0xb6)]('\x20'),_0x4573a9=await Whatsapp_1[_0x191064(0xe0)][_0x191064(0xd3)]({'where':{'token':_0x5b27f0}}),_0x1d06f6=_0x4573a9[_0x191064(0xda)],_0x30663c=_0x1ae8eb['number'][_0x191064(0xa5)]('-','')[_0x191064(0xa5)]('\x20',''),_0xf862ff=await(0x0,GetDefaultWhatsApp_1[_0x191064(0xe0)])(_0x1d06f6),_0x15b660=(0x0,wbot_1['getWbot'])(_0xf862ff['id']),_0x29f16a=createJid(_0x30663c);try{const [_0x2b61f0]=await _0x15b660[_0x191064(0xc6)](_0x29f16a);if(_0x2b61f0['exists'])return setTimeout(async()=>{const _0x14fe61=_0x191064,{dateToClient:_0x38791e}=(0x0,useDate_1[_0x14fe61(0xf1)])(),_0x46f0b0=_0x38791e(new Date()),_0x547733=(0x0,moment_1[_0x14fe61(0xe0)])()[_0x14fe61(0xec)](),_0x295e75=await ApiUsages_1[_0x14fe61(0xe0)][_0x14fe61(0xd3)]({'where':{'dateUsed':_0x46f0b0,'companyId':_0x1d06f6}});if(_0x295e75)await _0x295e75['update']({'usedCheckNumber':_0x295e75[_0x14fe61(0xd4)][_0x14fe61(0x9e)]+0x1,'UsedOnDay':_0x295e75[_0x14fe61(0xd4)][_0x14fe61(0xb9)]+0x1,'updatedAt':_0x547733});else{const _0x55abd6=await ApiUsages_1[_0x14fe61(0xe0)][_0x14fe61(0xc4)]({'companyId':_0x1d06f6,'dateUsed':_0x46f0b0});await _0x55abd6['update']({'usedCheckNumber':_0x55abd6[_0x14fe61(0xd4)]['usedCheckNumber']+0x1,'UsedOnDay':_0x55abd6[_0x14fe61(0xd4)][_0x14fe61(0xb9)]+0x1,'updatedAt':_0x547733});}},0x64),_0xf12326['status'](0xc8)['json']({'existsInWhatsapp':!![],'number':_0x30663c,'numberFormatted':_0x2b61f0['jid']});}catch(_0x90c52c){return _0xf12326['status'](0x190)['json']({'existsInWhatsapp':![],'number':_0x29f16a,'error':_0x191064(0xad)});}};function a8_0x23d0(_0x335ebc,_0x1e5601){const _0x389ef0=a8_0x389e();return a8_0x23d0=function(_0x23d09a,_0x71d5de){_0x23d09a=_0x23d09a-0x90;let _0x25de6c=_0x389ef0[_0x23d09a];return _0x25de6c;},a8_0x23d0(_0x335ebc,_0x1e5601);}exports[a8_0x36975c(0xef)]=checkNumber;const indexWhatsappsId=async(_0x53c495,_0x35cd47)=>{const _0x185c28=a8_0x36975c;return _0x35cd47[_0x185c28(0xc0)](0xc8)[_0x185c28(0xca)]('oi');};exports[a8_0x36975c(0xaa)]=indexWhatsappsId;
>>>>>>> ab722bfbcf394d74dd0b99a984c0dcf6ffbcff7f
