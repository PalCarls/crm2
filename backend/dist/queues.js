'use strict';const a346_0x4c8312=a346_0x1bfd;(function(_0x26a3f9,_0x172cdb){const _0x26f8e6=a346_0x1bfd,_0x2d1cca=_0x26a3f9();while(!![]){try{const _0x27a0c3=parseInt(_0x26f8e6(0x223))/0x1+parseInt(_0x26f8e6(0x17e))/0x2+-parseInt(_0x26f8e6(0x203))/0x3+-parseInt(_0x26f8e6(0x1a6))/0x4+-parseInt(_0x26f8e6(0x1d3))/0x5*(parseInt(_0x26f8e6(0x23d))/0x6)+-parseInt(_0x26f8e6(0x1ae))/0x7+parseInt(_0x26f8e6(0x1d2))/0x8;if(_0x27a0c3===_0x172cdb)break;else _0x2d1cca['push'](_0x2d1cca['shift']());}catch(_0x4cd61b){_0x2d1cca['push'](_0x2d1cca['shift']());}}}(a346_0x4f9e,0xdbdd2));var __createBinding=this&&this[a346_0x4c8312(0x175)]||(Object['create']?function(_0x373b03,_0x1e95ea,_0x3afde8,_0x4d3665){const _0x1d926e=a346_0x4c8312;if(_0x4d3665===undefined)_0x4d3665=_0x3afde8;var _0xe1582d=Object['getOwnPropertyDescriptor'](_0x1e95ea,_0x3afde8);(!_0xe1582d||(_0x1d926e(0x1ca)in _0xe1582d?!_0x1e95ea[_0x1d926e(0x17d)]:_0xe1582d[_0x1d926e(0x1d9)]||_0xe1582d[_0x1d926e(0x1ce)]))&&(_0xe1582d={'enumerable':!![],'get':function(){return _0x1e95ea[_0x3afde8];}}),Object[_0x1d926e(0x1f5)](_0x373b03,_0x4d3665,_0xe1582d);}:function(_0xe08235,_0x5059e0,_0x4b5523,_0x126187){if(_0x126187===undefined)_0x126187=_0x4b5523;_0xe08235[_0x126187]=_0x5059e0[_0x4b5523];}),__setModuleDefault=this&&this[a346_0x4c8312(0x1be)]||(Object[a346_0x4c8312(0x22c)]?function(_0x4116d1,_0x48c8db){const _0x12c3cf=a346_0x4c8312;Object[_0x12c3cf(0x1f5)](_0x4116d1,_0x12c3cf(0x200),{'enumerable':!![],'value':_0x48c8db});}:function(_0x27078f,_0x3c54a4){const _0x266125=a346_0x4c8312;_0x27078f[_0x266125(0x200)]=_0x3c54a4;}),__importStar=this&&this[a346_0x4c8312(0x1a3)]||function(_0x4bac5a){const _0x408265=a346_0x4c8312;if(_0x4bac5a&&_0x4bac5a[_0x408265(0x17d)])return _0x4bac5a;var _0x2b66a4={};if(_0x4bac5a!=null){for(var _0x11a7a8 in _0x4bac5a)if(_0x11a7a8!=='default'&&Object[_0x408265(0x1c9)][_0x408265(0x20d)][_0x408265(0x196)](_0x4bac5a,_0x11a7a8))__createBinding(_0x2b66a4,_0x4bac5a,_0x11a7a8);}return __setModuleDefault(_0x2b66a4,_0x4bac5a),_0x2b66a4;},__importDefault=this&&this[a346_0x4c8312(0x18c)]||function(_0x556734){const _0x598431=a346_0x4c8312;return _0x556734&&_0x556734[_0x598431(0x17d)]?_0x556734:{'default':_0x556734};};Object[a346_0x4c8312(0x1f5)](exports,a346_0x4c8312(0x17d),{'value':!![]}),exports[a346_0x4c8312(0x1bd)]=exports[a346_0x4c8312(0x1d0)]=exports['parseToMilliseconds']=exports[a346_0x4c8312(0x1fc)]=exports[a346_0x4c8312(0x170)]=exports[a346_0x4c8312(0x137)]=exports[a346_0x4c8312(0x233)]=exports[a346_0x4c8312(0x224)]=exports[a346_0x4c8312(0x21d)]=void 0x0;const Sentry=__importStar(require(a346_0x4c8312(0x19f))),bull_1=__importDefault(require(a346_0x4c8312(0x1ff))),SendMessage_1=require('./helpers/SendMessage'),Whatsapp_1=__importDefault(require(a346_0x4c8312(0x23c))),logger_1=require(a346_0x4c8312(0x14d)),moment_1=__importDefault(require(a346_0x4c8312(0x1dd))),Schedule_1=__importDefault(require(a346_0x4c8312(0x18a))),sequelize_1=require(a346_0x4c8312(0x151)),GetDefaultWhatsApp_1=__importDefault(require(a346_0x4c8312(0x230))),Campaign_1=__importDefault(require(a346_0x4c8312(0x21a))),Queue_1=__importDefault(require('./models/Queue')),ContactList_1=__importDefault(require(a346_0x4c8312(0x167))),ContactListItem_1=__importDefault(require(a346_0x4c8312(0x1b9))),lodash_1=require(a346_0x4c8312(0x176)),CampaignSetting_1=__importDefault(require(a346_0x4c8312(0x15a))),CampaignShipping_1=__importDefault(require('./models/CampaignShipping')),GetWhatsappWbot_1=__importDefault(require(a346_0x4c8312(0x187))),database_1=__importDefault(require(a346_0x4c8312(0x172))),SendWhatsAppMedia_1=require(a346_0x4c8312(0x20f)),socket_1=require(a346_0x4c8312(0x13b)),path_1=__importDefault(require(a346_0x4c8312(0x226))),User_1=__importDefault(require('./models/User')),Company_1=__importDefault(require(a346_0x4c8312(0x189))),Contact_1=__importDefault(require(a346_0x4c8312(0x1c0))),Queue_2=__importDefault(require('./models/Queue')),wbotClosedTickets_1=require(a346_0x4c8312(0x153)),Ticket_1=__importDefault(require(a346_0x4c8312(0x1cd))),ShowContactService_1=__importDefault(require(a346_0x4c8312(0x17f))),UserQueue_1=__importDefault(require(a346_0x4c8312(0x193))),ShowTicketService_1=__importDefault(require(a346_0x4c8312(0x212))),SendWhatsAppMessage_1=__importDefault(require(a346_0x4c8312(0x1ad))),UpdateTicketService_1=__importDefault(require(a346_0x4c8312(0x199))),date_fns_1=require(a346_0x4c8312(0x235)),GetWhatsapp_1=require(a346_0x4c8312(0x1a7)),nodemailer=require(a346_0x4c8312(0x1b0)),CronJob=require(a346_0x4c8312(0x16b))[a346_0x4c8312(0x220)],CompaniesSettings_1=__importDefault(require(a346_0x4c8312(0x1c1))),wbotMessageListener_1=require('./services/WbotServices/wbotMessageListener'),FindOrCreateTicketService_1=__importDefault(require(a346_0x4c8312(0x1a4))),connection=process[a346_0x4c8312(0x15d)][a346_0x4c8312(0x135)]||'',limiterMax=process['env'][a346_0x4c8312(0x22e)]||0x1,limiterDuration=process['env']['REDIS_OPT_LIMITER_DURATION']||0xbb8;exports[a346_0x4c8312(0x21d)]=new bull_1[(a346_0x4c8312(0x200))]('UserMonitor',connection),exports[a346_0x4c8312(0x224)]=new bull_1['default'](a346_0x4c8312(0x21f),connection),exports[a346_0x4c8312(0x233)]=new bull_1['default'](a346_0x4c8312(0x16f),connection),exports[a346_0x4c8312(0x137)]=new bull_1[(a346_0x4c8312(0x200))]('CampaignQueue',connection),exports[a346_0x4c8312(0x170)]=new bull_1['default'](a346_0x4c8312(0x17c),connection),exports[a346_0x4c8312(0x1fc)]=new bull_1[(a346_0x4c8312(0x200))](a346_0x4c8312(0x165),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});function a346_0x4f9e(){const _0x516edf=['add','map','{numero}','urlPicture','user','wait','extraInfo','clean','./models/ContactListItem','differenceInSeconds','longerIntervalAfter','\x20segundos\x20finalizado:\x20','startQueueProcess','__setModuleDefault','contacts','./models/Contact','./models/CompaniesSettings','HH:mm:ss','CONNECTED','isEmpty','company-','endHour','keys','public','prototype','get','VerifyCampaignsDaatabase','isNil','./models/Ticket','configurable','toDate','randomValue','failed','32082072yaRffQ','14835BEuaUe','VerifyQueueStatus','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','reload','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','Atendimento\x20Perdido:\x20','writable','contactList','includes','name','moment','parse','stop','all','{nome}','mediaPath','message3','PrepareContact','lgpdAcceptedAt','timeSendQueue','Sleep\x20de\x20','confirmationMessage4','count','email','isInteger','sabado','companyId','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','data','not','Disparo\x20agendado\x20para:\x20','save','completed','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','defineProperty','false','YYYY-MM-DD\x20HH:mm','*\x2015\x203\x20*\x20*\x20*','DispatchCampaign','day','captureException','messageQueue','whatsapp','profilePicUrl','bull','default',';Contato=','findByPk','4223625VoofJi','notification','*/5\x20*\x20*\x20*\x20*\x20*','confirmation','-campaign','GetWhatsapp','@s.whatsapp.net','whatsappId','Iniciando\x20processamento\x20de\x20filas',',\x20hora\x20atual\x20','hasOwnProperty','addSeconds','./services/WbotServices/SendWhatsAppMedia','SELECT','scheduledAt','./services/TicketServices/ShowTicketService','message5','format','UPDATE','contact','Verify','Whatsapp\x20não\x20identificado','queue','./models/Campaign','message2','subtract','userMonitor','diff','ScheduleMonitor','CronJob','SendMessage','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','1267712LZBgsJ','scheduleMonitor','findAll','path','process','isArray','value','*/20\x20*\x20*\x20*\x20*\x20*','confirmationRequestedAt','create','MessageQueue\x20->\x20SendMessage:\x20error','REDIS_OPT_LIMITER_MAX','resolve','./helpers/GetDefaultWhatsApp','deliveredAt','queueId','sendScheduledMessages','America/Sao_Paulo','date-fns','VerifyLoginStatus','minutes','openTicket',',\x20Delay\x20Inicial=','expiresTicket','HH:mm','./models/Whatsapp','3450hzhJkY','QueryTypes','pending','forEach','REDIS_URI','length','campaignQueue','delayed','startHour','toString','./libs/socket','ERRO','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','findAndCountAll','confirmationMessage3','YYYY-MM-DD\x20HH:mm:ss','log','profile','ClosedAllOpenTickets',';delay=','enabled','seconds','Campanhas\x20encontradas:\x20','info','join','ProcessCampaign','push','userId','./utils/logger','UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20(','floor','sendMessage','sequelize','pause','./services/WbotServices/wbotClosedTickets','update','verify-login','\x20-\x20','contactTags','disableBot','SearchForQueue\x20->\x20VerifyQueue:\x20error','./models/CampaignSetting','verify-campaing','error','env','gte','greaterInterval','replace','confirmationMessage5','whatsapps','message1','ENVIADA','MessageQueue','key','./models/ContactList','Envio\x20inicia\x20as\x20','campaignId','ClosedAllOpenTickets\x20->\x20Verify:\x20error','cron','random','findOrCreate','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','SendSacheduledMessages','queueMonitor','verifyMessage','./database','updatedAt','number','__createBinding','lodash','tags','PENDENTE','confirmationMessage2','\x20updated\x20with\x20UserId\x20','SendScheduledMessage\x20->\x20Verify:\x20error','QueueMonitor','__esModule','2999526HtFaTe','./services/ContactServices/ShowContactService','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','\x20não\x20está\x20dentro\x20do\x20horário','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','-ticket','FINALIZADA','variables','./helpers/GetWhatsappWbot','start','./models/Company','./models/Schedule','confirmationMessage','__importDefault','query','active','emit','online','@g.us','milliseconds','./models/UserQueue','getIO','domingo','call','verifyMediaMessage','isGroup','./services/TicketServices/UpdateTicketService','findOne','confirmationMessage1','filter','closed','message4','@sentry/node','SendScheduledMessage\x20->\x20SendMessage:\x20error','statusTicket','status','__importStar','./services/TicketServices/FindOrCreateTicketService','getMessageOptions','5139736RvWyOZ','./helpers/GetWhatsapp','logger','resume','groupAsTicket','parseToMilliseconds','message','./services/WbotServices/SendWhatsAppMessage','10348366zcgvst','contactId','nodemailer'];a346_0x4f9e=function(){return _0x516edf;};return a346_0x4f9e();}async function handleSendMessage(_0x5bf117){const _0xe847bf=a346_0x4c8312;try{const {data:_0x12bf02}=_0x5bf117,_0x321481=await Whatsapp_1['default']['findByPk'](_0x12bf02[_0xe847bf(0x20a)]);if(_0x321481===null)throw Error(_0xe847bf(0x218));const _0x437a12=_0x12bf02[_0xe847bf(0x1ef)];await(0x0,SendMessage_1[_0xe847bf(0x221)])(_0x321481,_0x437a12);}catch(_0x27e7b1){Sentry[_0xe847bf(0x1fb)](_0x27e7b1),logger_1['logger']['error'](_0xe847bf(0x22d),_0x27e7b1['message']);throw _0x27e7b1;}}async function handleVerifySchedules(_0x400612){const _0x5bf165=a346_0x4c8312;try{const {count:_0x32baf7,rows:_0x4fba80}=await Schedule_1[_0x5bf165(0x200)]['findAndCountAll']({'where':{'status':_0x5bf165(0x178),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x5bf165(0x15e)]]:(0x0,moment_1[_0x5bf165(0x200)])()['format'](_0x5bf165(0x140)),[sequelize_1['Op']['lte']]:(0x0,moment_1[_0x5bf165(0x200)])()[_0x5bf165(0x1b1)]('30',_0x5bf165(0x146))[_0x5bf165(0x214)]('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x5bf165(0x200)],'as':_0x5bf165(0x216)}]});_0x32baf7>0x0&&_0x4fba80['map'](async _0x414ffe=>{const _0x329831=_0x5bf165;await _0x414ffe[_0x329831(0x154)]({'status':'AGENDADA'}),exports[_0x329831(0x233)][_0x329831(0x1b1)](_0x329831(0x221),{'schedule':_0x414ffe},{'delay':0x9c40}),logger_1[_0x329831(0x1a8)]['info'](_0x329831(0x1f1)+_0x414ffe[_0x329831(0x216)][_0x329831(0x1dc)]);});}catch(_0x1eee89){Sentry[_0x5bf165(0x1fb)](_0x1eee89),logger_1[_0x5bf165(0x1a8)]['error'](_0x5bf165(0x17b),_0x1eee89[_0x5bf165(0x1ac)]);throw _0x1eee89;}}async function handleSendScheduledMessage(_0x2302b7){const _0x1c5ca3=a346_0x4c8312,{data:{schedule:_0x1ff20c}}=_0x2302b7;let _0x3440ee=null;try{_0x3440ee=await Schedule_1['default']['findByPk'](_0x1ff20c['id']);}catch(_0x1c1f02){Sentry[_0x1c5ca3(0x1fb)](_0x1c1f02),logger_1['logger']['info'](_0x1c5ca3(0x222)+_0x1ff20c['id']);}try{const _0x501ffe=await(0x0,GetDefaultWhatsApp_1[_0x1c5ca3(0x200)])(_0x1ff20c[_0x1c5ca3(0x1ed)]);console['log'](_0x1ff20c);const _0x43ff47=await CompaniesSettings_1[_0x1c5ca3(0x200)]['findOne']({'where':{'companyId':_0x1ff20c[_0x1c5ca3(0x1ed)]}}),{ticket:_0x3ad91c}=await(0x0,FindOrCreateTicketService_1[_0x1c5ca3(0x200)])(_0x1ff20c['contact'],_0x501ffe,0x1,_0x1ff20c[_0x1c5ca3(0x1ed)],0x0,0x0,null,_0x1c5ca3(0x1fd),![],![],_0x43ff47),_0x5c22a0=await(0x0,SendMessage_1[_0x1c5ca3(0x221)])(_0x501ffe,{'number':_0x1ff20c[_0x1c5ca3(0x216)]['number'],'body':_0x1ff20c['body']});await(0x0,wbotMessageListener_1[_0x1c5ca3(0x171)])(_0x5c22a0,_0x3ad91c,_0x1ff20c['contact']['number']),await _0x3440ee?.['update']({'sentAt':(0x0,moment_1[_0x1c5ca3(0x200)])()[_0x1c5ca3(0x214)](_0x1c5ca3(0x1f7)),'status':_0x1c5ca3(0x164)}),logger_1[_0x1c5ca3(0x1a8)][_0x1c5ca3(0x148)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x1ff20c[_0x1c5ca3(0x216)][_0x1c5ca3(0x1dc)]),exports[_0x1c5ca3(0x233)][_0x1c5ca3(0x1b8)](0x3a98,_0x1c5ca3(0x1f3));}catch(_0x25ead3){Sentry[_0x1c5ca3(0x1fb)](_0x25ead3),await _0x3440ee?.[_0x1c5ca3(0x154)]({'status':_0x1c5ca3(0x13c)}),logger_1[_0x1c5ca3(0x1a8)][_0x1c5ca3(0x15c)](_0x1c5ca3(0x1a0),_0x25ead3['message']);throw _0x25ead3;}}async function handleVerifyCampaigns(_0x54ebfe){const _0x31e436=a346_0x4c8312,_0x2aa0e2=await database_1[_0x31e436(0x200)]['query'](_0x31e436(0x182),{'type':sequelize_1[_0x31e436(0x132)][_0x31e436(0x210)]});if(_0x2aa0e2[_0x31e436(0x136)]>0x0)logger_1[_0x31e436(0x1a8)]['info'](_0x31e436(0x147)+_0x2aa0e2[_0x31e436(0x136)]);for(let _0x14af6d of _0x2aa0e2){try{const _0x3b35d7=(0x0,moment_1[_0x31e436(0x200)])(),_0x127cae=(0x0,moment_1['default'])(_0x14af6d[_0x31e436(0x211)]),_0x37f82b=_0x127cae[_0x31e436(0x21e)](_0x3b35d7,_0x31e436(0x192));logger_1[_0x31e436(0x1a8)][_0x31e436(0x148)](_0x31e436(0x1f4)+_0x14af6d['id']+_0x31e436(0x239)+_0x37f82b),exports[_0x31e436(0x137)][_0x31e436(0x1b1)]('ProcessCampaign',{'id':_0x14af6d['id'],'delay':_0x37f82b},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x3a4320){Sentry['captureException'](_0x3a4320);}}}async function getCampaign(_0x353399){const _0x1bfd52=a346_0x4c8312;return await Campaign_1[_0x1bfd52(0x200)][_0x1bfd52(0x19a)]({'where':{'id':_0x353399},'include':[{'model':ContactList_1['default'],'as':_0x1bfd52(0x1da),'attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x1bfd52(0x200)],'as':_0x1bfd52(0x1bf),'attributes':['id','name','number',_0x1bfd52(0x1ea),'isWhatsappValid','isGroup'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x1bfd52(0x200)],'as':'whatsapp','attributes':['id',_0x1bfd52(0x1dc)]}]});}async function getContact(_0x2dd485){const _0x2584cb=a346_0x4c8312;return await ContactListItem_1['default'][_0x2584cb(0x202)](_0x2dd485,{'attributes':['id',_0x2584cb(0x1dc),'number',_0x2584cb(0x1ea),_0x2584cb(0x198)]});}async function getSettings(_0x294314){const _0x3772b4=a346_0x4c8312;try{const _0x65173d=await CampaignSetting_1[_0x3772b4(0x200)][_0x3772b4(0x225)]({'where':{'companyId':_0x294314[_0x3772b4(0x1ed)]},'attributes':[_0x3772b4(0x166),_0x3772b4(0x229)]});let _0x1b034b=0x14,_0x349aa9=0x14,_0x54eb62=0x3c,_0x6ec86a=[];return _0x65173d[_0x3772b4(0x134)](_0x4a9305=>{const _0x46bacd=_0x3772b4;_0x4a9305[_0x46bacd(0x166)]==='messageInterval'&&(_0x1b034b=JSON[_0x46bacd(0x1de)](_0x4a9305[_0x46bacd(0x229)])),_0x4a9305[_0x46bacd(0x166)]===_0x46bacd(0x1bb)&&(_0x349aa9=JSON['parse'](_0x4a9305[_0x46bacd(0x229)])),_0x4a9305['key']===_0x46bacd(0x15f)&&(_0x54eb62=JSON[_0x46bacd(0x1de)](_0x4a9305[_0x46bacd(0x229)])),_0x4a9305[_0x46bacd(0x166)]===_0x46bacd(0x186)&&(_0x6ec86a=JSON[_0x46bacd(0x1de)](_0x4a9305['value']));}),{'messageInterval':_0x1b034b,'longerIntervalAfter':_0x349aa9,'greaterInterval':_0x54eb62,'variables':_0x6ec86a};}catch(_0x3c5e54){console['log'](_0x3c5e54);throw _0x3c5e54;}}function parseToMilliseconds(_0xa3059c){return _0xa3059c*0x3e8;}exports[a346_0x4c8312(0x1ab)]=parseToMilliseconds;async function sleep(_0x14030b){const _0x5bc5d9=a346_0x4c8312;return logger_1[_0x5bc5d9(0x1a8)][_0x5bc5d9(0x148)](_0x5bc5d9(0x1e7)+_0x14030b+'\x20segundos\x20iniciado:\x20'+(0x0,moment_1[_0x5bc5d9(0x200)])()[_0x5bc5d9(0x214)](_0x5bc5d9(0x1c2))),new Promise(_0x367b4a=>{setTimeout(()=>{const _0x48a577=a346_0x1bfd;logger_1[_0x48a577(0x1a8)][_0x48a577(0x148)](_0x48a577(0x1e7)+_0x14030b+_0x48a577(0x1bc)+(0x0,moment_1[_0x48a577(0x200)])()[_0x48a577(0x214)](_0x48a577(0x1c2))),_0x367b4a(!![]);},parseToMilliseconds(_0x14030b));});}function getCampaignValidMessages(_0x38e973){const _0x3c5e19=a346_0x4c8312,_0x1ae77d=[];return!(0x0,lodash_1['isEmpty'])(_0x38e973[_0x3c5e19(0x163)])&&!(0x0,lodash_1['isNil'])(_0x38e973[_0x3c5e19(0x163)])&&_0x1ae77d['push'](_0x38e973[_0x3c5e19(0x163)]),!(0x0,lodash_1[_0x3c5e19(0x1c4)])(_0x38e973[_0x3c5e19(0x21b)])&&!(0x0,lodash_1[_0x3c5e19(0x1cc)])(_0x38e973[_0x3c5e19(0x21b)])&&_0x1ae77d[_0x3c5e19(0x14b)](_0x38e973[_0x3c5e19(0x21b)]),!(0x0,lodash_1[_0x3c5e19(0x1c4)])(_0x38e973[_0x3c5e19(0x1e3)])&&!(0x0,lodash_1['isNil'])(_0x38e973[_0x3c5e19(0x1e3)])&&_0x1ae77d[_0x3c5e19(0x14b)](_0x38e973[_0x3c5e19(0x1e3)]),!(0x0,lodash_1[_0x3c5e19(0x1c4)])(_0x38e973[_0x3c5e19(0x19e)])&&!(0x0,lodash_1[_0x3c5e19(0x1cc)])(_0x38e973['message4'])&&_0x1ae77d[_0x3c5e19(0x14b)](_0x38e973[_0x3c5e19(0x19e)]),!(0x0,lodash_1['isEmpty'])(_0x38e973[_0x3c5e19(0x213)])&&!(0x0,lodash_1[_0x3c5e19(0x1cc)])(_0x38e973[_0x3c5e19(0x213)])&&_0x1ae77d[_0x3c5e19(0x14b)](_0x38e973[_0x3c5e19(0x213)]),_0x1ae77d;}function getCampaignValidConfirmationMessages(_0x121693){const _0x161d23=a346_0x4c8312,_0x537588=[];return!(0x0,lodash_1[_0x161d23(0x1c4)])(_0x121693[_0x161d23(0x19b)])&&!(0x0,lodash_1['isNil'])(_0x121693[_0x161d23(0x19b)])&&_0x537588[_0x161d23(0x14b)](_0x121693[_0x161d23(0x19b)]),!(0x0,lodash_1[_0x161d23(0x1c4)])(_0x121693[_0x161d23(0x179)])&&!(0x0,lodash_1[_0x161d23(0x1cc)])(_0x121693[_0x161d23(0x179)])&&_0x537588[_0x161d23(0x14b)](_0x121693[_0x161d23(0x179)]),!(0x0,lodash_1['isEmpty'])(_0x121693[_0x161d23(0x13f)])&&!(0x0,lodash_1[_0x161d23(0x1cc)])(_0x121693[_0x161d23(0x13f)])&&_0x537588[_0x161d23(0x14b)](_0x121693[_0x161d23(0x13f)]),!(0x0,lodash_1['isEmpty'])(_0x121693[_0x161d23(0x1e8)])&&!(0x0,lodash_1[_0x161d23(0x1cc)])(_0x121693['confirmationMessage4'])&&_0x537588[_0x161d23(0x14b)](_0x121693[_0x161d23(0x1e8)]),!(0x0,lodash_1[_0x161d23(0x1c4)])(_0x121693[_0x161d23(0x161)])&&!(0x0,lodash_1['isNil'])(_0x121693[_0x161d23(0x161)])&&_0x537588[_0x161d23(0x14b)](_0x121693[_0x161d23(0x161)]),_0x537588;}function getProcessedMessage(_0x3a085a,_0x566c95,_0x2b4b3c){const _0x264821=a346_0x4c8312;let _0x339d87=_0x3a085a;return _0x339d87[_0x264821(0x1db)](_0x264821(0x1e1))&&(_0x339d87=_0x339d87['replace'](/{nome}/g,_0x2b4b3c[_0x264821(0x1dc)])),_0x339d87['includes']('{email}')&&(_0x339d87=_0x339d87[_0x264821(0x160)](/{email}/g,_0x2b4b3c[_0x264821(0x1ea)])),_0x339d87[_0x264821(0x1db)](_0x264821(0x1b3))&&(_0x339d87=_0x339d87[_0x264821(0x160)](/{numero}/g,_0x2b4b3c[_0x264821(0x174)])),_0x566c95[0x0][_0x264821(0x229)]!=='[]'&&_0x566c95[_0x264821(0x134)](_0x2c0a90=>{const _0x174c7e=_0x264821;if(_0x339d87['includes']('{'+_0x2c0a90['key']+'}')){const _0x37a2d3=new RegExp('{'+_0x2c0a90[_0x174c7e(0x166)]+'}','g');_0x339d87=_0x339d87[_0x174c7e(0x160)](_0x37a2d3,_0x2c0a90[_0x174c7e(0x229)]);}}),_0x339d87;}const checkerWeek=async()=>{const _0x12c750=a346_0x4c8312,_0x2cb580=(0x0,moment_1[_0x12c750(0x200)])()[_0x12c750(0x1fa)]()===0x6,_0x1cde8b=(0x0,moment_1['default'])()['day']()===0x0,_0x2e7ae7=await CampaignSetting_1[_0x12c750(0x200)][_0x12c750(0x19a)]({'where':{'key':_0x12c750(0x1ec)}}),_0x228972=await CampaignSetting_1[_0x12c750(0x200)]['findOne']({'where':{'key':_0x12c750(0x195)}});if(_0x2e7ae7?.[_0x12c750(0x229)]==='false'&&_0x2cb580)return exports[_0x12c750(0x1fc)]['pause'](),!![];if(_0x228972?.['value']===_0x12c750(0x1f6)&&_0x1cde8b)return exports[_0x12c750(0x1fc)][_0x12c750(0x152)](),!![];return exports[_0x12c750(0x1fc)][_0x12c750(0x1a9)](),![];},checkTime=async()=>{const _0x465f4c=a346_0x4c8312,_0x2b1f81=await CampaignSetting_1[_0x465f4c(0x200)]['findOne']({'where':{'key':_0x465f4c(0x139)}}),_0x49537f=await CampaignSetting_1[_0x465f4c(0x200)][_0x465f4c(0x19a)]({'where':{'key':_0x465f4c(0x1c6)}}),_0x344983=_0x2b1f81[_0x465f4c(0x229)],_0x5a7c43=_0x49537f['value'],_0x1a377b=(0x0,moment_1[_0x465f4c(0x200)])()[_0x465f4c(0x214)](_0x465f4c(0x23b));if(_0x1a377b<=_0x5a7c43&&_0x1a377b>=_0x344983)return exports[_0x465f4c(0x1fc)]['resume'](),!![];return logger_1[_0x465f4c(0x1a8)]['info'](_0x465f4c(0x168)+_0x344983+'\x20e\x20termina\x20as\x20'+_0x5a7c43+_0x465f4c(0x20c)+_0x1a377b+_0x465f4c(0x181)),exports[_0x465f4c(0x1fc)][_0x465f4c(0x1b8)](0x0,_0x465f4c(0x138)),exports[_0x465f4c(0x1fc)][_0x465f4c(0x1b8)](0x0,_0x465f4c(0x1b6)),exports[_0x465f4c(0x1fc)]['clean'](0x0,_0x465f4c(0x18e)),exports[_0x465f4c(0x1fc)][_0x465f4c(0x1b8)](0x0,_0x465f4c(0x1f3)),exports[_0x465f4c(0x1fc)][_0x465f4c(0x1b8)](0x0,_0x465f4c(0x1d1)),exports['messageQueue'][_0x465f4c(0x152)](),![];};function randomValue(_0x5e9831,_0x2eedc3){const _0x3467e8=a346_0x4c8312;return Math[_0x3467e8(0x14f)](Math[_0x3467e8(0x16c)]()*_0x2eedc3)+_0x5e9831;}exports[a346_0x4c8312(0x1d0)]=randomValue;function a346_0x1bfd(_0x3f40da,_0x134195){const _0x4f9e71=a346_0x4f9e();return a346_0x1bfd=function(_0x1bfd11,_0xc25c32){_0x1bfd11=_0x1bfd11-0x132;let _0x5eb1d2=_0x4f9e71[_0x1bfd11];return _0x5eb1d2;},a346_0x1bfd(_0x3f40da,_0x134195);}async function verifyAndFinalizeCampaign(_0x29ad7a){const _0x30f0c5=a346_0x4c8312,{contacts:_0x174be9}=_0x29ad7a[_0x30f0c5(0x1da)],_0x3715af=_0x174be9[_0x30f0c5(0x136)],_0x14f1e2=await CampaignShipping_1['default'][_0x30f0c5(0x1e9)]({'where':{'campaignId':_0x29ad7a['id'],'deliveredAt':{[sequelize_1['Op'][_0x30f0c5(0x1f0)]]:null}}});_0x3715af===_0x14f1e2&&await _0x29ad7a[_0x30f0c5(0x154)]({'status':_0x30f0c5(0x185),'completedAt':(0x0,moment_1[_0x30f0c5(0x200)])()});const _0x318fe6=(0x0,socket_1['getIO'])();_0x318fe6[_0x30f0c5(0x18f)](_0x30f0c5(0x1c5)+_0x29ad7a['companyId']+'-campaign',{'action':'update','record':_0x29ad7a});}async function handleProcessCampaign(_0x2440bb){const _0x417763=a346_0x4c8312;try{const {id:_0x43fd74}=_0x2440bb['data'],_0x3056d8=await getCampaign(_0x43fd74),_0x5ba93f=await getSettings(_0x3056d8);if(_0x3056d8){const {contacts:_0x30e51b}=_0x3056d8[_0x417763(0x1da)];if((0x0,lodash_1[_0x417763(0x228)])(_0x30e51b)){const _0x2fd367=_0x30e51b[_0x417763(0x1b2)](_0x1bf6e7=>({'contactId':_0x1bf6e7['id'],'campaignId':_0x3056d8['id'],'variables':_0x5ba93f['variables'],'isGroup':_0x1bf6e7['isGroup']})),_0x7cbf97=parseToMilliseconds(_0x5ba93f[_0x417763(0x1bb)]),_0x430c76=parseToMilliseconds(_0x5ba93f['greaterInterval']),_0x43a900=_0x5ba93f['messageInterval'];let _0x35d92b=_0x3056d8['scheduledAt'];const _0x9ca8f1=[];for(let _0x18489f=0x0;_0x18489f<_0x2fd367[_0x417763(0x136)];_0x18489f++){_0x35d92b=(0x0,date_fns_1[_0x417763(0x20e)])(_0x35d92b,_0x18489f>_0x7cbf97?_0x430c76:_0x43a900);const {contactId:_0x2a58c8,campaignId:_0x16e44a,variables:_0x37a856}=_0x2fd367[_0x18489f],_0x5d3481=calculateDelay(_0x18489f,_0x35d92b,_0x7cbf97,_0x430c76,_0x43a900),_0x4a8096=exports['campaignQueue'][_0x417763(0x1b1)](_0x417763(0x1e4),{'contactId':_0x2a58c8,'campaignId':_0x16e44a,'variables':_0x37a856,'delay':_0x5d3481},{'removeOnComplete':!![]});_0x9ca8f1[_0x417763(0x14b)](_0x4a8096),logger_1[_0x417763(0x1a8)][_0x417763(0x148)](_0x417763(0x13d)+_0x3056d8['id']+';Contato='+_0x30e51b[_0x18489f]['name']+_0x417763(0x144)+_0x5d3481);}await Promise[_0x417763(0x1e0)](_0x9ca8f1),await _0x3056d8[_0x417763(0x154)]({'status':'EM_ANDAMENTO'});}}}catch(_0x471fb3){Sentry[_0x417763(0x1fb)](_0x471fb3);}}function calculateDelay(_0x2267ca,_0x7a2cc5,_0x4ec122,_0x588835,_0x35903e){const _0x5472ed=a346_0x4c8312,_0x3fc188=(0x0,date_fns_1[_0x5472ed(0x1ba)])(_0x7a2cc5,new Date());return _0x2267ca>_0x4ec122?_0x3fc188*0x3e8+_0x588835:_0x3fc188*0x3e8+_0x35903e;}async function handlePrepareContact(_0x368242){const _0x6cd193=a346_0x4c8312;try{const {contactId:_0x5132bb,campaignId:_0x458a7c,delay:_0x315ef8,variables:_0x1bc05a}=_0x368242['data'],_0x3de4d5=await getCampaign(_0x458a7c),_0x5b271e=await getContact(_0x5132bb),_0xb2b6d3={};_0xb2b6d3[_0x6cd193(0x174)]=_0x5b271e[_0x6cd193(0x174)],_0xb2b6d3[_0x6cd193(0x1af)]=_0x5132bb,_0xb2b6d3[_0x6cd193(0x169)]=_0x458a7c;const _0x3ea2d4=getCampaignValidMessages(_0x3de4d5);if(_0x3ea2d4[_0x6cd193(0x136)]){const _0x40414a=randomValue(0x0,_0x3ea2d4[_0x6cd193(0x136)]),_0x445531=getProcessedMessage(_0x3ea2d4[_0x40414a],_0x1bc05a,_0x5b271e);_0xb2b6d3[_0x6cd193(0x1ac)]='‌\x20'+_0x445531;}if(_0x3de4d5['confirmation']){const _0x28bbda=getCampaignValidConfirmationMessages(_0x3de4d5);if(_0x28bbda['length']){const _0x2f0476=randomValue(0x0,_0x28bbda[_0x6cd193(0x136)]),_0x49f786=getProcessedMessage(_0x28bbda[_0x2f0476],_0x1bc05a,_0x5b271e);_0xb2b6d3[_0x6cd193(0x18b)]='‌\x20'+_0x49f786;}}const [_0x4a79cc,_0x364ce0]=await CampaignShipping_1['default'][_0x6cd193(0x16d)]({'where':{'campaignId':_0xb2b6d3[_0x6cd193(0x169)],'contactId':_0xb2b6d3[_0x6cd193(0x1af)]},'defaults':_0xb2b6d3});!_0x364ce0&&_0x4a79cc[_0x6cd193(0x231)]===null&&_0x4a79cc[_0x6cd193(0x22b)]===null&&(_0x4a79cc['set'](_0xb2b6d3),await _0x4a79cc[_0x6cd193(0x1f2)]());if(_0x4a79cc[_0x6cd193(0x231)]===null&&_0x4a79cc['confirmationRequestedAt']===null){const _0x8d23b6=await exports[_0x6cd193(0x137)][_0x6cd193(0x1b1)]('DispatchCampaign',{'campaignId':_0x3de4d5['id'],'campaignShippingId':_0x4a79cc['id'],'contactListItemId':_0x5132bb},{'delay':_0x315ef8});await _0x4a79cc['update']({'jobId':_0x8d23b6['id']});}await verifyAndFinalizeCampaign(_0x3de4d5);}catch(_0x32a61f){Sentry[_0x6cd193(0x1fb)](_0x32a61f),logger_1[_0x6cd193(0x1a8)][_0x6cd193(0x15c)](_0x6cd193(0x183)+_0x32a61f['message']);}}async function handleDispatchCampaign(_0x1f7cd0){const _0x142384=a346_0x4c8312;try{const {data:_0x175bf9}=_0x1f7cd0,{campaignShippingId:_0x35060b,campaignId:_0x49a5f0}=_0x175bf9,_0x3375e8=await getCampaign(_0x49a5f0),_0x29f346=await(0x0,GetWhatsappWbot_1['default'])(_0x3375e8[_0x142384(0x1fd)]);if(!_0x29f346){logger_1[_0x142384(0x1a8)]['error']('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found');return;}if(!_0x3375e8[_0x142384(0x1fd)]){logger_1[_0x142384(0x1a8)][_0x142384(0x15c)](_0x142384(0x1d7));return;}if(!_0x29f346?.[_0x142384(0x1b5)]?.['id']){logger_1[_0x142384(0x1a8)][_0x142384(0x15c)](_0x142384(0x1d5));return;}logger_1[_0x142384(0x1a8)][_0x142384(0x148)](_0x142384(0x1ee)+_0x49a5f0+';Registro='+_0x35060b);const _0x455225=await CampaignShipping_1[_0x142384(0x200)][_0x142384(0x202)](_0x35060b,{'include':[{'model':ContactListItem_1['default'],'as':_0x142384(0x216)}]});console['log'](_0x455225);const _0xc5c5d=_0x455225[_0x142384(0x216)][_0x142384(0x198)]?_0x455225[_0x142384(0x174)]+_0x142384(0x191):_0x455225['number']+_0x142384(0x209);let _0x589364=_0x455225['message'];_0x3375e8[_0x142384(0x206)]&&_0x455225['confirmation']===null&&(_0x589364=_0x455225['confirmationMessage']);if(_0x3375e8[_0x142384(0x238)]===_0x142384(0x145)){const _0x1a29d0=await Contact_1[_0x142384(0x200)]['findOne']({'where':{'number':_0x455225[_0x142384(0x174)]}}),_0x1f519a=await Whatsapp_1[_0x142384(0x200)][_0x142384(0x202)](_0x3375e8[_0x142384(0x20a)]),_0x19470c=await CompaniesSettings_1[_0x142384(0x200)][_0x142384(0x19a)]({'where':{'companyId':_0x3375e8[_0x142384(0x1ed)]}}),{ticket:_0x1e49e3}=await(0x0,FindOrCreateTicketService_1[_0x142384(0x200)])(_0x1a29d0,_0x1f519a,0x1,_0x3375e8[_0x142384(0x1ed)],_0x3375e8?.[_0x142384(0x232)],_0x3375e8?.[_0x142384(0x14c)],null,_0x142384(0x1fd),![],![],_0x19470c);if(_0x3375e8['mediaPath']===null){const _0x4d5f18=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x589364,'ticket':_0x1e49e3});await(0x0,wbotMessageListener_1[_0x142384(0x171)])(_0x4d5f18,_0x1e49e3,_0x1e49e3[_0x142384(0x216)]);}else{const _0x4fd66f=path_1[_0x142384(0x200)]['resolve'](__dirname,'..',_0x142384(0x1c8)),_0x429e16=path_1[_0x142384(0x200)][_0x142384(0x149)](_0x4fd66f,'company'+_0x3375e8[_0x142384(0x1ed)],_0x3375e8[_0x142384(0x1e2)]),_0x390b5c=await(0x0,SendWhatsAppMedia_1[_0x142384(0x1a5)])(_0x3375e8['mediaName'],_0x429e16,_0x3375e8['companyId'][_0x142384(0x13a)](),_0x589364);if(Object[_0x142384(0x1c7)](_0x390b5c)[_0x142384(0x136)]){const _0x494b32=await _0x29f346[_0x142384(0x150)](_0xc5c5d,{..._0x390b5c});await(0x0,wbotMessageListener_1[_0x142384(0x197)])(_0x494b32,_0x1e49e3,_0x1e49e3[_0x142384(0x216)]);}}_0x3375e8?.[_0x142384(0x1a1)]==='closed'&&await _0x1e49e3['update']({'status':_0x142384(0x19d)}),await _0x455225[_0x142384(0x154)]({'deliveredAt':(0x0,moment_1['default'])()});}else{if(_0x3375e8[_0x142384(0x1e2)]){const _0x1efa11=path_1[_0x142384(0x200)][_0x142384(0x22f)](__dirname,'..',_0x142384(0x1c8)),_0xd2f55f=path_1[_0x142384(0x200)]['join'](_0x1efa11,'company'+_0x3375e8['companyId'],_0x3375e8[_0x142384(0x1e2)]),_0xc0532d=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x3375e8['mediaName'],_0xd2f55f,_0x3375e8[_0x142384(0x1ed)][_0x142384(0x13a)](),_0x589364);Object['keys'](_0xc0532d)[_0x142384(0x136)]&&await _0x29f346[_0x142384(0x150)](_0xc5c5d,{..._0xc0532d});}else _0x3375e8[_0x142384(0x206)]&&_0x455225[_0x142384(0x206)]===null?(await _0x29f346[_0x142384(0x150)](_0xc5c5d,{'text':_0x589364}),await _0x455225[_0x142384(0x154)]({'confirmationRequestedAt':(0x0,moment_1['default'])()})):await _0x29f346['sendMessage'](_0xc5c5d,{'text':_0x589364});await _0x455225[_0x142384(0x154)]({'deliveredAt':(0x0,moment_1[_0x142384(0x200)])()});}await verifyAndFinalizeCampaign(_0x3375e8);const _0xee14c7=(0x0,socket_1[_0x142384(0x194)])();_0xee14c7['emit']('company-'+_0x3375e8[_0x142384(0x1ed)]+_0x142384(0x207),{'action':_0x142384(0x154),'record':_0x3375e8}),logger_1[_0x142384(0x1a8)][_0x142384(0x148)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x49a5f0+_0x142384(0x201)+_0x455225[_0x142384(0x216)][_0x142384(0x1dc)]);}catch(_0x197537){Sentry[_0x142384(0x1fb)](_0x197537),logger_1[_0x142384(0x1a8)][_0x142384(0x15c)](_0x197537[_0x142384(0x1ac)]),console[_0x142384(0x141)](_0x197537['stack']);}}async function handleLoginStatus(_0x638d76){const _0x2e50ee=a346_0x4c8312,_0x15fe57=await database_1[_0x2e50ee(0x200)][_0x2e50ee(0x18d)]('select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true',{'type':sequelize_1[_0x2e50ee(0x132)][_0x2e50ee(0x210)]}),_0xc6e0cb=_0x15fe57[_0x2e50ee(0x1b2)](_0x42226d=>_0x42226d['id']),_0x1c7959=_0xc6e0cb[_0x2e50ee(0x149)](',\x20');try{const _0x2898f5=_0x2e50ee(0x14e)+_0x1c7959+');',_0x19020b=await database_1['default'][_0x2e50ee(0x18d)](_0x2898f5,{'type':sequelize_1[_0x2e50ee(0x132)][_0x2e50ee(0x215)]});}catch(_0x3207bd){Sentry[_0x2e50ee(0x1fb)](_0x3207bd);}}async function handleVerifyQueue(_0x3ef149){const _0x28954f=a346_0x4c8312;try{const _0x5b8bed=await Company_1[_0x28954f(0x200)][_0x28954f(0x225)]({'attributes':['id',_0x28954f(0x1dc)],'where':{'status':!![]},'include':[{'model':Whatsapp_1['default'],'attributes':['id',_0x28954f(0x1dc),_0x28954f(0x1a2),_0x28954f(0x1e6),'sendIdQueue']}]});_0x5b8bed[_0x28954f(0x1b2)](async _0x1de5ae=>{const _0x31fa13=_0x28954f;_0x1de5ae[_0x31fa13(0x162)]['map'](async _0x249bbe=>{const _0x53df44=_0x31fa13;if(_0x249bbe['status']===_0x53df44(0x1c3)){var _0x2415aa=_0x1de5ae['id'];const _0x1ef153=_0x249bbe[_0x53df44(0x1e6)]?_0x249bbe['timeSendQueue']:0x0,_0x3e5254=_0x249bbe['sendIdQueue'],_0x740fcf=_0x1ef153,_0x436b60=_0x3e5254,_0xfd0b3e=_0x740fcf;if(_0x1ef153>0x0){if(!isNaN(_0x436b60)&&Number[_0x53df44(0x1eb)](_0x436b60)&&!isNaN(_0xfd0b3e)&&Number[_0x53df44(0x1eb)](_0xfd0b3e)){const _0x26aef1=(0x0,moment_1[_0x53df44(0x200)])()[_0x53df44(0x21c)](_0xfd0b3e,_0x53df44(0x237))['utc']()[_0x53df44(0x214)](),{count:_0x283b45,rows:_0x5c689f}=await Ticket_1[_0x53df44(0x200)][_0x53df44(0x13e)]({'attributes':['id'],'where':{'status':_0x53df44(0x133),'queueId':null,'companyId':_0x2415aa,'whatsappId':_0x249bbe['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x26aef1}},'include':[{'model':Contact_1['default'],'as':_0x53df44(0x216),'attributes':['id','name',_0x53df44(0x174),_0x53df44(0x1ea),_0x53df44(0x1fe),'acceptAudioMessage',_0x53df44(0x18e),_0x53df44(0x158),_0x53df44(0x1b4),_0x53df44(0x1e5),_0x53df44(0x1ed)],'include':[_0x53df44(0x1b7),_0x53df44(0x157),_0x53df44(0x177)]},{'model':Queue_2[_0x53df44(0x200)],'as':_0x53df44(0x219),'attributes':['id',_0x53df44(0x1dc),'color']},{'model':Whatsapp_1[_0x53df44(0x200)],'as':_0x53df44(0x1fd),'attributes':['id',_0x53df44(0x1dc),_0x53df44(0x23a),_0x53df44(0x1aa)]}]});_0x283b45>0x0&&_0x5c689f[_0x53df44(0x1b2)](async _0x5dbe0f=>{const _0x7e6590=_0x53df44;await _0x5dbe0f[_0x7e6590(0x154)]({'queueId':_0x436b60}),await _0x5dbe0f[_0x7e6590(0x1d6)]();const _0x22d871=(0x0,socket_1[_0x7e6590(0x194)])();_0x22d871['to'](_0x5dbe0f[_0x7e6590(0x1a2)])['to'](_0x7e6590(0x204))['to'](_0x5dbe0f['id']['toString']())[_0x7e6590(0x18f)](_0x7e6590(0x1c5)+_0x2415aa+_0x7e6590(0x184),{'action':_0x7e6590(0x154),'ticket':_0x5dbe0f,'ticketId':_0x5dbe0f['id']}),logger_1[_0x7e6590(0x1a8)]['info'](_0x7e6590(0x1d8)+_0x5dbe0f['id']+'\x20-\x20Empresa:\x20'+_0x2415aa);});}else logger_1[_0x53df44(0x1a8)][_0x53df44(0x148)]('Condição\x20não\x20respeitada\x20-\x20Empresa:\x20'+_0x2415aa);}}});});}catch(_0x529b23){Sentry[_0x28954f(0x1fb)](_0x529b23),logger_1[_0x28954f(0x1a8)]['error'](_0x28954f(0x159),_0x529b23['message']);throw _0x529b23;}};async function handleRandomUser(){const _0x273c2a=a346_0x4c8312,_0x32f00b=new CronJob(_0x273c2a(0x205),async()=>{const _0x37edc5=_0x273c2a;try{const {count:_0x23dd59,rows:_0x253b9c}=await Ticket_1[_0x37edc5(0x200)][_0x37edc5(0x13e)]({'where':{'status':_0x37edc5(0x133),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0x37edc5(0x200)],'as':_0x37edc5(0x219)}]}),_0x32ea45=_0x282a50=>{const _0x5cd13e=_0x37edc5,_0x54f407=Math['floor'](Math[_0x5cd13e(0x16c)]()*_0x282a50[_0x5cd13e(0x136)]);return _0x282a50[_0x54f407];},_0x11d6cf=async _0x2956eb=>{const _0x5aaca0=_0x37edc5;try{const _0x3c3e0c=await User_1[_0x5aaca0(0x200)][_0x5aaca0(0x19a)]({'where':{'id':_0x2956eb}});return _0x3c3e0c[_0x5aaca0(0x142)]===_0x5aaca0(0x1b5)?_0x3c3e0c[_0x5aaca0(0x190)]===!![]?_0x3c3e0c['id']:0x0:0x0;}catch(_0x2a4d4d){Sentry[_0x5aaca0(0x1fb)](_0x2a4d4d),logger_1[_0x5aaca0(0x1a8)][_0x5aaca0(0x15c)](_0x5aaca0(0x180),_0x2a4d4d['message']);throw _0x2a4d4d;}};if(_0x23dd59>0x0)for(const _0x4720f0 of _0x253b9c){const {queue:_0x3d081c,queueId:_0x20bfd6,userId:_0x1ddee9}=_0x4720f0,_0x134251=_0x3d081c['tempoRoteador'],_0x1a63cc=await UserQueue_1[_0x37edc5(0x200)]['findAll']({'where':{'queueId':_0x20bfd6}}),_0x40880f=await(0x0,ShowContactService_1[_0x37edc5(0x200)])(_0x4720f0['contactId'],_0x4720f0[_0x37edc5(0x1ed)]),_0x2c32b6=_0x1a63cc[_0x37edc5(0x1b2)](_0x49f445=>_0x49f445[_0x37edc5(0x14c)]),_0x157e60=(0x0,moment_1[_0x37edc5(0x200)])()['subtract'](_0x134251,_0x37edc5(0x237))['utc']()[_0x37edc5(0x1cf)](),_0xc03ed=new Date(_0x4720f0[_0x37edc5(0x173)]);let _0x55dc01=await CompaniesSettings_1[_0x37edc5(0x200)][_0x37edc5(0x19a)]({'where':{'companyId':_0x4720f0[_0x37edc5(0x1ed)]}});const _0x2d1be9=_0x55dc01['sendGreetingMessageOneQueues']===_0x37edc5(0x145)||![];if(!_0x1ddee9){const _0x389f7f=_0x32ea45(_0x2c32b6);if(await _0x11d6cf(_0x389f7f)>0x0){if(_0x2d1be9){const _0x4a015f=await(0x0,ShowTicketService_1['default'])(_0x4720f0['id'],_0x4720f0['companyId']);await(0x0,SendWhatsAppMessage_1[_0x37edc5(0x200)])({'body':_0x37edc5(0x16e),'ticket':_0x4a015f});}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x37edc5(0x133),'userId':_0x389f7f},'ticketId':_0x4720f0['id'],'companyId':_0x4720f0['companyId']}),logger_1['logger']['info']('Ticket\x20ID\x20'+_0x4720f0['id']+_0x37edc5(0x17a)+_0x389f7f+_0x37edc5(0x156)+_0x4720f0[_0x37edc5(0x173)]);}else{}}else{if(_0x2c32b6[_0x37edc5(0x1db)](_0x1ddee9)){if(_0x157e60>_0xc03ed){const _0x32f208=_0x2c32b6[_0x37edc5(0x19c)](_0xb6552c=>_0xb6552c!==_0x1ddee9);if(_0x32f208['length']>0x0){const _0x3fe618=_0x32ea45(_0x32f208);if(await _0x11d6cf(_0x3fe618)>0x0){if(_0x2d1be9){const _0x1f847a=await(0x0,ShowTicketService_1[_0x37edc5(0x200)])(_0x4720f0['id'],_0x4720f0[_0x37edc5(0x1ed)]);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x37edc5(0x16e),'ticket':_0x1f847a});};await(0x0,UpdateTicketService_1[_0x37edc5(0x200)])({'ticketData':{'status':_0x37edc5(0x133),'userId':_0x3fe618},'ticketId':_0x4720f0['id'],'companyId':_0x4720f0[_0x37edc5(0x1ed)]}),await _0x4720f0[_0x37edc5(0x1d6)]();}else{}}else{}}else{}}else{}}}}catch(_0x5d4b18){Sentry['captureException'](_0x5d4b18),logger_1['logger']['error']('SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error',_0x5d4b18[_0x37edc5(0x1ac)]);throw _0x5d4b18;}});_0x32f00b['start']();}async function handleCloseTicketsAutomatic(){const _0x4ecc31=a346_0x4c8312,_0x4e9aff=new CronJob('*/1\x20*\x20*\x20*\x20*',async()=>{const _0x12ba61=a346_0x1bfd,_0x2e4248=await Company_1[_0x12ba61(0x200)][_0x12ba61(0x225)]();_0x2e4248[_0x12ba61(0x1b2)](async _0x529b7e=>{const _0x13fe55=_0x12ba61;try{const _0x55f0d3=_0x529b7e['id'];await(0x0,wbotClosedTickets_1[_0x13fe55(0x143)])(_0x55f0d3);}catch(_0x16e918){Sentry['captureException'](_0x16e918),logger_1[_0x13fe55(0x1a8)][_0x13fe55(0x15c)](_0x13fe55(0x16a),_0x16e918[_0x13fe55(0x1ac)]);throw _0x16e918;}});});_0x4e9aff[_0x4ecc31(0x188)]();}async function handleWhatsapp(){const _0x3a5ea6=a346_0x4c8312,_0x5aa412=new CronJob(_0x3a5ea6(0x1f8),async()=>{const _0x3e3181=_0x3a5ea6;(0x0,GetWhatsapp_1[_0x3e3181(0x208)])(),_0x5aa412[_0x3e3181(0x1df)]();},null,![],_0x3a5ea6(0x234));_0x5aa412['start']();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x3a6cc5=a346_0x4c8312;logger_1[_0x3a6cc5(0x1a8)][_0x3a6cc5(0x148)](_0x3a6cc5(0x20b)),exports[_0x3a6cc5(0x1fc)]['process'](_0x3a6cc5(0x221),handleSendMessage),exports[_0x3a6cc5(0x224)][_0x3a6cc5(0x227)](_0x3a6cc5(0x217),handleVerifySchedules),exports['sendScheduledMessages'][_0x3a6cc5(0x227)](_0x3a6cc5(0x221),handleSendScheduledMessage),exports[_0x3a6cc5(0x137)][_0x3a6cc5(0x227)](_0x3a6cc5(0x1cb),handleVerifyCampaigns),exports[_0x3a6cc5(0x137)][_0x3a6cc5(0x227)](_0x3a6cc5(0x14a),handleProcessCampaign),exports['campaignQueue'][_0x3a6cc5(0x227)]('PrepareContact',handlePrepareContact),exports['campaignQueue'][_0x3a6cc5(0x227)](_0x3a6cc5(0x1f9),handleDispatchCampaign),exports[_0x3a6cc5(0x21d)][_0x3a6cc5(0x227)](_0x3a6cc5(0x236),handleLoginStatus),exports[_0x3a6cc5(0x170)][_0x3a6cc5(0x227)](_0x3a6cc5(0x1d4),handleVerifyQueue),exports['scheduleMonitor'][_0x3a6cc5(0x1b1)]('Verify',{},{'repeat':{'cron':'*/5\x20*\x20*\x20*\x20*\x20*','key':'verify'},'removeOnComplete':!![]}),exports[_0x3a6cc5(0x137)][_0x3a6cc5(0x1b1)](_0x3a6cc5(0x1cb),{},{'repeat':{'cron':_0x3a6cc5(0x22a),'key':_0x3a6cc5(0x15b)},'removeOnComplete':!![]}),exports[_0x3a6cc5(0x21d)][_0x3a6cc5(0x1b1)](_0x3a6cc5(0x236),{},{'repeat':{'cron':'*\x20*\x20*\x20*\x20*','key':_0x3a6cc5(0x155)},'removeOnComplete':!![]}),exports[_0x3a6cc5(0x170)]['add'](_0x3a6cc5(0x1d4),{},{'repeat':{'cron':_0x3a6cc5(0x22a),'key':'verify-queue'},'removeOnComplete':!![]});}exports[a346_0x4c8312(0x1bd)]=startQueueProcess;