<<<<<<< HEAD
'use strict';const a337_0x5985ce=a337_0x17ed;(function(_0x31e45c,_0x2c3b8e){const _0x2de889=a337_0x17ed,_0x3893e5=_0x31e45c();while(!![]){try{const _0x3f3f4f=-parseInt(_0x2de889(0x1b4))/0x1+-parseInt(_0x2de889(0x22f))/0x2+-parseInt(_0x2de889(0x1c2))/0x3*(parseInt(_0x2de889(0x19c))/0x4)+-parseInt(_0x2de889(0x1dd))/0x5+parseInt(_0x2de889(0x18a))/0x6+-parseInt(_0x2de889(0x23f))/0x7*(parseInt(_0x2de889(0x257))/0x8)+parseInt(_0x2de889(0x1a2))/0x9;if(_0x3f3f4f===_0x2c3b8e)break;else _0x3893e5['push'](_0x3893e5['shift']());}catch(_0x17638d){_0x3893e5['push'](_0x3893e5['shift']());}}}(a337_0x4962,0x61a63));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x465def,_0x4e9fdd,_0x4c5f55,_0x3e7542){const _0x4cc326=a337_0x17ed;if(_0x3e7542===undefined)_0x3e7542=_0x4c5f55;var _0x164bfb=Object[_0x4cc326(0x22d)](_0x4e9fdd,_0x4c5f55);(!_0x164bfb||(_0x4cc326(0x1c3)in _0x164bfb?!_0x4e9fdd[_0x4cc326(0x173)]:_0x164bfb[_0x4cc326(0x1b5)]||_0x164bfb['configurable']))&&(_0x164bfb={'enumerable':!![],'get':function(){return _0x4e9fdd[_0x4c5f55];}}),Object[_0x4cc326(0x184)](_0x465def,_0x3e7542,_0x164bfb);}:function(_0x1eabfc,_0x2a9f9e,_0x57b0fe,_0x2cd0d0){if(_0x2cd0d0===undefined)_0x2cd0d0=_0x57b0fe;_0x1eabfc[_0x2cd0d0]=_0x2a9f9e[_0x57b0fe];}),__setModuleDefault=this&&this[a337_0x5985ce(0x1ea)]||(Object[a337_0x5985ce(0x18e)]?function(_0x4e86b2,_0x56ba2c){const _0x498811=a337_0x5985ce;Object['defineProperty'](_0x4e86b2,_0x498811(0x1f4),{'enumerable':!![],'value':_0x56ba2c});}:function(_0x1456a3,_0x3f116c){const _0x3594f=a337_0x5985ce;_0x1456a3[_0x3594f(0x1f4)]=_0x3f116c;}),__importStar=this&&this[a337_0x5985ce(0x1b1)]||function(_0x78d46c){const _0x59d367=a337_0x5985ce;if(_0x78d46c&&_0x78d46c[_0x59d367(0x173)])return _0x78d46c;var _0x5e4aba={};if(_0x78d46c!=null){for(var _0xacfef1 in _0x78d46c)if(_0xacfef1!==_0x59d367(0x1f4)&&Object['prototype']['hasOwnProperty']['call'](_0x78d46c,_0xacfef1))__createBinding(_0x5e4aba,_0x78d46c,_0xacfef1);}return __setModuleDefault(_0x5e4aba,_0x78d46c),_0x5e4aba;},__importDefault=this&&this[a337_0x5985ce(0x1c0)]||function(_0x56e60e){return _0x56e60e&&_0x56e60e['__esModule']?_0x56e60e:{'default':_0x56e60e};};function a337_0x4962(){const _0x5702e7=['./models/UserQueue','verifyMediaMessage','color','not','message4','bull','error','clean','gte','data','ClosedAllOpenTickets','add','diff','28OiYUZu','replace','company-','startQueueProcess','Verify','Iniciando\x20processamento\x20de\x20filas','19356021KCDOpW','forEach','GetWhatsapp','verify-login','tags','count','user','getIO','America/Sao_Paulo','MessageQueue','verify-campaing','SendScheduledMessage\x20->\x20SendMessage:\x20error','queueId','public','@s.whatsapp.net','__importStar','./models/Queue','verifyMessage','724712filVml','writable','join','captureException','{numero}','scheduledAt','findOrCreate','contactId',';Registro=','nodemailer','./helpers/GetWhatsapp','message','__importDefault','confirmation','2919StlhQi','get','isNil','info','expiresTicket','message2','length','timeSendQueue','status','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','CONNECTED','./services/ContactServices/ShowContactService','mediaName','QueryTypes','query','./services/TicketServices/FindOrCreateTicketService','company','./models/CampaignSetting','./services/WbotServices/wbotClosedTickets','./helpers/SendMessage','floor','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true',',\x20Delay\x20Inicial=','VerifyCampaignsDaatabase','sendIdQueue','key','UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20(','1485270ihOHRj','YYYY-MM-DD\x20HH:mm','MessageQueue\x20->\x20SendMessage:\x20error','./services/TicketServices/UpdateTicketService','./models/Whatsapp','statusTicket','SendSacheduledMessages','process','name','REDIS_URI','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','./models/Schedule','message3','__setModuleDefault','confirmationMessage2','mediaPath','*/5\x20*\x20*\x20*\x20*\x20*','isInteger','minutes','*/20\x20*\x20*\x20*\x20*\x20*','confirmationMessage3','-campaign','confirmationMessage4','default','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','isArray','completed','ENVIADA','confirmationMessage5','confirmationRequestedAt','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','queue','emit','variables','message1','value','profile','email','findByPk','whatsapps','lodash','tempoRoteador','PrepareContact',';delay=','cron','subtract','body','@sentry/node','YYYY-MM-DD\x20HH:mm:ss','differenceInSeconds','updatedAt','userId','enabled','SendScheduledMessage\x20->\x20Verify:\x20error','all','profilePicUrl','./models/CampaignShipping','campaignId','confirmationMessage','format','campaignQueue','./models/User','sendMessage','utc','contactList','contact','findAndCountAll','randomValue','ScheduleMonitor','./models/CompaniesSettings','update','stop','Sleep\x20de\x20','./helpers/GetWhatsappWbot','HH:mm:ss','./models/ContactListItem','VerifyLoginStatus','deliveredAt','Campanha\x20enviada\x20para:\x20Campanha=','toDate','getOwnPropertyDescriptor','./models/Campaign','1476888YDewcg','EM_ANDAMENTO','verify-queue','{nome}','addSeconds','./services/WbotServices/wbotMessageListener','lte','reload','whatsapp','REDIS_OPT_LIMITER_DURATION','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','*/1\x20*\x20*\x20*\x20*','stack','start','companyId','greaterInterval','54894ZUWhyF','isEmpty','logger','UserMonitor','SELECT','resolve','SendMessage','getMessageOptions',';Contato=','-ticket','whatsappId','number','VerifyQueueStatus','env','online','FINALIZADA','./models/Ticket','userMonitor','log','parseToMilliseconds','contacts','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','queueMonitor','DispatchCampaign','48XaopWZ','findAll','includes','push','longerIntervalAfter','./models/Company','findOne','sendScheduledMessages','pending','Disparo\x20agendado\x20para:\x20','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','__esModule','./models/Contact','date-fns','./services/TicketServices/ShowTicketService','scheduleMonitor','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','UPDATE','ProcessCampaign','messageQueue','seconds','toString','sequelize','parse','Atendimento\x20Perdido:\x20','Whatsapp\x20não\x20identificado','map','message5','defineProperty','random','CronJob','\x20segundos\x20iniciado:\x20','notification','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','380250vmqQcn','\x20segundos\x20finalizado:\x20','{email}','messageInterval','create'];a337_0x4962=function(){return _0x5702e7;};return a337_0x4962();}Object[a337_0x5985ce(0x184)](exports,'__esModule',{'value':!![]}),exports[a337_0x5985ce(0x19f)]=exports[a337_0x5985ce(0x220)]=exports[a337_0x5985ce(0x252)]=exports[a337_0x5985ce(0x17b)]=exports[a337_0x5985ce(0x255)]=exports['campaignQueue']=exports['sendScheduledMessages']=exports[a337_0x5985ce(0x177)]=exports[a337_0x5985ce(0x250)]=void 0x0;const Sentry=__importStar(require(a337_0x5985ce(0x20c))),bull_1=__importDefault(require(a337_0x5985ce(0x194))),SendMessage_1=require(a337_0x5985ce(0x1d5)),Whatsapp_1=__importDefault(require(a337_0x5985ce(0x1e1))),logger_1=require('./utils/logger'),moment_1=__importDefault(require('moment')),Schedule_1=__importDefault(require(a337_0x5985ce(0x1e8))),sequelize_1=require(a337_0x5985ce(0x17e)),GetDefaultWhatsApp_1=__importDefault(require('./helpers/GetDefaultWhatsApp')),Campaign_1=__importDefault(require(a337_0x5985ce(0x22e))),Queue_1=__importDefault(require(a337_0x5985ce(0x1b2))),ContactList_1=__importDefault(require('./models/ContactList')),ContactListItem_1=__importDefault(require(a337_0x5985ce(0x228))),lodash_1=require(a337_0x5985ce(0x205)),CampaignSetting_1=__importDefault(require(a337_0x5985ce(0x1d3))),CampaignShipping_1=__importDefault(require(a337_0x5985ce(0x215))),GetWhatsappWbot_1=__importDefault(require(a337_0x5985ce(0x226))),database_1=__importDefault(require('./database')),SendWhatsAppMedia_1=require('./services/WbotServices/SendWhatsAppMedia'),socket_1=require('./libs/socket'),path_1=__importDefault(require('path')),User_1=__importDefault(require(a337_0x5985ce(0x21a))),Company_1=__importDefault(require(a337_0x5985ce(0x16d))),Contact_1=__importDefault(require(a337_0x5985ce(0x174))),Queue_2=__importDefault(require(a337_0x5985ce(0x1b2))),wbotClosedTickets_1=require(a337_0x5985ce(0x1d4)),Ticket_1=__importDefault(require(a337_0x5985ce(0x24f))),ShowContactService_1=__importDefault(require(a337_0x5985ce(0x1cd))),UserQueue_1=__importDefault(require(a337_0x5985ce(0x18f))),ShowTicketService_1=__importDefault(require(a337_0x5985ce(0x176))),SendWhatsAppMessage_1=__importDefault(require('./services/WbotServices/SendWhatsAppMessage')),UpdateTicketService_1=__importDefault(require(a337_0x5985ce(0x1e0))),date_fns_1=require(a337_0x5985ce(0x175)),GetWhatsapp_1=require(a337_0x5985ce(0x1be)),nodemailer=require(a337_0x5985ce(0x1bd)),CronJob=require(a337_0x5985ce(0x209))[a337_0x5985ce(0x186)],CompaniesSettings_1=__importDefault(require(a337_0x5985ce(0x222))),wbotMessageListener_1=require(a337_0x5985ce(0x234)),FindOrCreateTicketService_1=__importDefault(require(a337_0x5985ce(0x1d1))),connection=process['env'][a337_0x5985ce(0x1e6)]||'',limiterMax=process[a337_0x5985ce(0x24c)]['REDIS_OPT_LIMITER_MAX']||0x1,limiterDuration=process[a337_0x5985ce(0x24c)][a337_0x5985ce(0x238)]||0xbb8;exports['userMonitor']=new bull_1[(a337_0x5985ce(0x1f4))](a337_0x5985ce(0x242),connection),exports[a337_0x5985ce(0x177)]=new bull_1[(a337_0x5985ce(0x1f4))](a337_0x5985ce(0x221),connection),exports[a337_0x5985ce(0x16f)]=new bull_1['default'](a337_0x5985ce(0x1e3),connection),exports[a337_0x5985ce(0x219)]=new bull_1[(a337_0x5985ce(0x1f4))]('CampaignQueue',connection),exports[a337_0x5985ce(0x255)]=new bull_1[(a337_0x5985ce(0x1f4))]('QueueMonitor',connection),exports[a337_0x5985ce(0x17b)]=new bull_1[(a337_0x5985ce(0x1f4))](a337_0x5985ce(0x1ab),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x3ad2a9){const _0x149817=a337_0x5985ce;try{const {data:_0x555c26}=_0x3ad2a9,_0x284631=await Whatsapp_1[_0x149817(0x1f4)][_0x149817(0x203)](_0x555c26[_0x149817(0x249)]);if(_0x284631===null)throw Error(_0x149817(0x181));const _0x3986f6=_0x555c26[_0x149817(0x198)];await(0x0,SendMessage_1[_0x149817(0x245)])(_0x284631,_0x3986f6);}catch(_0x1fc4a5){Sentry['captureException'](_0x1fc4a5),logger_1[_0x149817(0x241)][_0x149817(0x195)](_0x149817(0x1df),_0x1fc4a5[_0x149817(0x1bf)]);throw _0x1fc4a5;}}async function handleVerifySchedules(_0x46f2e0){const _0x30a262=a337_0x5985ce;try{const {count:_0x4d87e1,rows:_0x3e9004}=await Schedule_1[_0x30a262(0x1f4)]['findAndCountAll']({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op'][_0x30a262(0x197)]]:(0x0,moment_1[_0x30a262(0x1f4)])()[_0x30a262(0x218)](_0x30a262(0x20d)),[sequelize_1['Op'][_0x30a262(0x235)]]:(0x0,moment_1[_0x30a262(0x1f4)])()['add']('30',_0x30a262(0x17c))[_0x30a262(0x218)]('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x30a262(0x1f4)],'as':'contact'}]});_0x4d87e1>0x0&&_0x3e9004[_0x30a262(0x182)](async _0x3ecf8e=>{const _0x43f2cf=_0x30a262;await _0x3ecf8e[_0x43f2cf(0x223)]({'status':'AGENDADA'}),exports['sendScheduledMessages'][_0x43f2cf(0x19a)](_0x43f2cf(0x245),{'schedule':_0x3ecf8e},{'delay':0x9c40}),logger_1['logger'][_0x43f2cf(0x1c5)](_0x43f2cf(0x171)+_0x3ecf8e[_0x43f2cf(0x21e)][_0x43f2cf(0x1e5)]);});}catch(_0x3acd43){Sentry[_0x30a262(0x1b7)](_0x3acd43),logger_1['logger'][_0x30a262(0x195)](_0x30a262(0x212),_0x3acd43[_0x30a262(0x1bf)]);throw _0x3acd43;}}async function handleSendScheduledMessage(_0x229f09){const _0x10531e=a337_0x5985ce,{data:{schedule:_0x45cf3b}}=_0x229f09;let _0x531d57=null;try{_0x531d57=await Schedule_1[_0x10531e(0x1f4)][_0x10531e(0x203)](_0x45cf3b['id']);}catch(_0x25f70c){Sentry['captureException'](_0x25f70c),logger_1['logger'][_0x10531e(0x1c5)](_0x10531e(0x178)+_0x45cf3b['id']);}try{const _0x344d0f=await(0x0,GetDefaultWhatsApp_1[_0x10531e(0x1f4)])(_0x45cf3b[_0x10531e(0x23d)]);console[_0x10531e(0x251)](_0x45cf3b);const _0x22a3ee=await CompaniesSettings_1['default']['findOne']({'where':{'companyId':_0x45cf3b[_0x10531e(0x23d)]}}),{ticket:_0x315c99}=await(0x0,FindOrCreateTicketService_1[_0x10531e(0x1f4)])(_0x45cf3b[_0x10531e(0x21e)],_0x344d0f,0x1,_0x45cf3b['companyId'],0x0,0x0,null,'whatsapp',![],![],_0x22a3ee),_0x11a273=await(0x0,SendMessage_1[_0x10531e(0x245)])(_0x344d0f,{'number':_0x45cf3b['contact'][_0x10531e(0x24a)],'body':_0x45cf3b[_0x10531e(0x20b)]});await(0x0,wbotMessageListener_1[_0x10531e(0x1b3)])(_0x11a273,_0x315c99,_0x45cf3b['contact'][_0x10531e(0x24a)]),await _0x531d57?.[_0x10531e(0x223)]({'sentAt':(0x0,moment_1[_0x10531e(0x1f4)])()[_0x10531e(0x218)](_0x10531e(0x1de)),'status':_0x10531e(0x1f8)}),logger_1[_0x10531e(0x241)][_0x10531e(0x1c5)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x45cf3b[_0x10531e(0x21e)][_0x10531e(0x1e5)]),exports[_0x10531e(0x16f)][_0x10531e(0x196)](0x3a98,_0x10531e(0x1f7));}catch(_0x58f2ab){Sentry['captureException'](_0x58f2ab),await _0x531d57?.[_0x10531e(0x223)]({'status':'ERRO'}),logger_1[_0x10531e(0x241)]['error'](_0x10531e(0x1ad),_0x58f2ab[_0x10531e(0x1bf)]);throw _0x58f2ab;}}async function handleVerifyCampaigns(_0x23e655){const _0x5e0ef4=a337_0x5985ce,_0x397d17=await database_1[_0x5e0ef4(0x1f4)][_0x5e0ef4(0x1d0)](_0x5e0ef4(0x1fb),{'type':sequelize_1[_0x5e0ef4(0x1cf)]['SELECT']});if(_0x397d17[_0x5e0ef4(0x1c8)]>0x0)logger_1[_0x5e0ef4(0x241)]['info']('Campanhas\x20encontradas:\x20'+_0x397d17[_0x5e0ef4(0x1c8)]);for(let _0x4c3584 of _0x397d17){try{const _0x2e364d=(0x0,moment_1[_0x5e0ef4(0x1f4)])(),_0x633197=(0x0,moment_1['default'])(_0x4c3584[_0x5e0ef4(0x1b9)]),_0x392b6b=_0x633197[_0x5e0ef4(0x19b)](_0x2e364d,'milliseconds');logger_1['logger']['info']('Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha='+_0x4c3584['id']+_0x5e0ef4(0x1d8)+_0x392b6b),exports[_0x5e0ef4(0x219)]['add'](_0x5e0ef4(0x17a),{'id':_0x4c3584['id'],'delay':_0x392b6b},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x37500c){Sentry[_0x5e0ef4(0x1b7)](_0x37500c);}}}async function getCampaign(_0x355c3b){const _0x4d078a=a337_0x5985ce;return await Campaign_1['default']['findOne']({'where':{'id':_0x355c3b},'include':[{'model':ContactList_1['default'],'as':_0x4d078a(0x21d),'attributes':['id',_0x4d078a(0x1e5)],'include':[{'model':ContactListItem_1[_0x4d078a(0x1f4)],'as':_0x4d078a(0x253),'attributes':['id',_0x4d078a(0x1e5),_0x4d078a(0x24a),_0x4d078a(0x202),'isWhatsappValid'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x4d078a(0x1f4)],'as':'whatsapp','attributes':['id','name']}]});}async function getContact(_0x2baa75){const _0x485559=a337_0x5985ce;return await ContactListItem_1['default'][_0x485559(0x203)](_0x2baa75,{'attributes':['id',_0x485559(0x1e5),'number',_0x485559(0x202)]});}async function getSettings(_0x34304a){const _0x5c184a=a337_0x5985ce;try{const _0x4c3eac=await CampaignSetting_1[_0x5c184a(0x1f4)][_0x5c184a(0x258)]({'where':{'companyId':_0x34304a[_0x5c184a(0x23d)]},'attributes':['key','value']});let _0x12346d=0x14,_0x44e1fe=0x14,_0x37a26b=0x3c,_0x200c47=[];return _0x4c3eac[_0x5c184a(0x1a3)](_0x4a7d05=>{const _0x477eca=_0x5c184a;_0x4a7d05['key']===_0x477eca(0x18d)&&(_0x12346d=JSON[_0x477eca(0x17f)](_0x4a7d05[_0x477eca(0x200)])),_0x4a7d05[_0x477eca(0x1db)]===_0x477eca(0x16c)&&(_0x44e1fe=JSON['parse'](_0x4a7d05[_0x477eca(0x200)])),_0x4a7d05['key']==='greaterInterval'&&(_0x37a26b=JSON[_0x477eca(0x17f)](_0x4a7d05[_0x477eca(0x200)])),_0x4a7d05[_0x477eca(0x1db)]==='variables'&&(_0x200c47=JSON[_0x477eca(0x17f)](_0x4a7d05['value']));}),{'messageInterval':_0x12346d,'longerIntervalAfter':_0x44e1fe,'greaterInterval':_0x37a26b,'variables':_0x200c47};}catch(_0x31ba9f){console[_0x5c184a(0x251)](_0x31ba9f);throw _0x31ba9f;}}function parseToMilliseconds(_0x4014d2){return _0x4014d2*0x3e8;}exports[a337_0x5985ce(0x252)]=parseToMilliseconds;async function sleep(_0x5826e6){const _0x438a0e=a337_0x5985ce;return logger_1[_0x438a0e(0x241)][_0x438a0e(0x1c5)](_0x438a0e(0x225)+_0x5826e6+_0x438a0e(0x187)+(0x0,moment_1[_0x438a0e(0x1f4)])()[_0x438a0e(0x218)](_0x438a0e(0x227))),new Promise(_0x3fd664=>{setTimeout(()=>{const _0x311ae5=a337_0x17ed;logger_1['logger'][_0x311ae5(0x1c5)](_0x311ae5(0x225)+_0x5826e6+_0x311ae5(0x18b)+(0x0,moment_1['default'])()[_0x311ae5(0x218)](_0x311ae5(0x227))),_0x3fd664(!![]);},parseToMilliseconds(_0x5826e6));});}function getCampaignValidMessages(_0x505eb2){const _0x277ac2=a337_0x5985ce,_0x2a9fc4=[];return!(0x0,lodash_1[_0x277ac2(0x240)])(_0x505eb2[_0x277ac2(0x1ff)])&&!(0x0,lodash_1[_0x277ac2(0x1c4)])(_0x505eb2['message1'])&&_0x2a9fc4[_0x277ac2(0x16b)](_0x505eb2[_0x277ac2(0x1ff)]),!(0x0,lodash_1['isEmpty'])(_0x505eb2[_0x277ac2(0x1c7)])&&!(0x0,lodash_1[_0x277ac2(0x1c4)])(_0x505eb2[_0x277ac2(0x1c7)])&&_0x2a9fc4[_0x277ac2(0x16b)](_0x505eb2['message2']),!(0x0,lodash_1['isEmpty'])(_0x505eb2[_0x277ac2(0x1e9)])&&!(0x0,lodash_1[_0x277ac2(0x1c4)])(_0x505eb2['message3'])&&_0x2a9fc4['push'](_0x505eb2[_0x277ac2(0x1e9)]),!(0x0,lodash_1[_0x277ac2(0x240)])(_0x505eb2[_0x277ac2(0x193)])&&!(0x0,lodash_1[_0x277ac2(0x1c4)])(_0x505eb2[_0x277ac2(0x193)])&&_0x2a9fc4[_0x277ac2(0x16b)](_0x505eb2[_0x277ac2(0x193)]),!(0x0,lodash_1[_0x277ac2(0x240)])(_0x505eb2[_0x277ac2(0x183)])&&!(0x0,lodash_1[_0x277ac2(0x1c4)])(_0x505eb2[_0x277ac2(0x183)])&&_0x2a9fc4[_0x277ac2(0x16b)](_0x505eb2[_0x277ac2(0x183)]),_0x2a9fc4;}function getCampaignValidConfirmationMessages(_0x5291ca){const _0x26fe04=a337_0x5985ce,_0x42add2=[];return!(0x0,lodash_1[_0x26fe04(0x240)])(_0x5291ca['confirmationMessage1'])&&!(0x0,lodash_1[_0x26fe04(0x1c4)])(_0x5291ca['confirmationMessage1'])&&_0x42add2[_0x26fe04(0x16b)](_0x5291ca['confirmationMessage1']),!(0x0,lodash_1[_0x26fe04(0x240)])(_0x5291ca['confirmationMessage2'])&&!(0x0,lodash_1[_0x26fe04(0x1c4)])(_0x5291ca[_0x26fe04(0x1eb)])&&_0x42add2[_0x26fe04(0x16b)](_0x5291ca[_0x26fe04(0x1eb)]),!(0x0,lodash_1[_0x26fe04(0x240)])(_0x5291ca['confirmationMessage3'])&&!(0x0,lodash_1[_0x26fe04(0x1c4)])(_0x5291ca[_0x26fe04(0x1f1)])&&_0x42add2['push'](_0x5291ca[_0x26fe04(0x1f1)]),!(0x0,lodash_1[_0x26fe04(0x240)])(_0x5291ca['confirmationMessage4'])&&!(0x0,lodash_1[_0x26fe04(0x1c4)])(_0x5291ca['confirmationMessage4'])&&_0x42add2[_0x26fe04(0x16b)](_0x5291ca[_0x26fe04(0x1f3)]),!(0x0,lodash_1[_0x26fe04(0x240)])(_0x5291ca['confirmationMessage5'])&&!(0x0,lodash_1['isNil'])(_0x5291ca[_0x26fe04(0x1f9)])&&_0x42add2[_0x26fe04(0x16b)](_0x5291ca[_0x26fe04(0x1f9)]),_0x42add2;}function getProcessedMessage(_0x5b4441,_0x41d0fa,_0x46f620){const _0x3f53f2=a337_0x5985ce;let _0x3acd97=_0x5b4441;return _0x3acd97['includes'](_0x3f53f2(0x232))&&(_0x3acd97=_0x3acd97['replace'](/{nome}/g,_0x46f620['name'])),_0x3acd97[_0x3f53f2(0x259)](_0x3f53f2(0x18c))&&(_0x3acd97=_0x3acd97['replace'](/{email}/g,_0x46f620[_0x3f53f2(0x202)])),_0x3acd97[_0x3f53f2(0x259)](_0x3f53f2(0x1b8))&&(_0x3acd97=_0x3acd97[_0x3f53f2(0x19d)](/{numero}/g,_0x46f620[_0x3f53f2(0x24a)])),_0x41d0fa[_0x3f53f2(0x1a3)](_0x405d91=>{const _0x279915=_0x3f53f2;if(_0x3acd97['includes']('{'+_0x405d91['key']+'}')){const _0x2b3520=new RegExp('{'+_0x405d91[_0x279915(0x1db)]+'}','g');_0x3acd97=_0x3acd97[_0x279915(0x19d)](_0x2b3520,_0x405d91['value']);}}),_0x3acd97;}function randomValue(_0x34cc0b,_0x25ffcc){const _0x539ce6=a337_0x5985ce;return Math[_0x539ce6(0x1d6)](Math['random']()*_0x25ffcc)+_0x34cc0b;}exports[a337_0x5985ce(0x220)]=randomValue;function a337_0x17ed(_0x45a68d,_0x380965){const _0x496235=a337_0x4962();return a337_0x17ed=function(_0x17edf6,_0x5e5105){_0x17edf6=_0x17edf6-0x16b;let _0x577bde=_0x496235[_0x17edf6];return _0x577bde;},a337_0x17ed(_0x45a68d,_0x380965);}async function verifyAndFinalizeCampaign(_0xe752d8){const _0x343268=a337_0x5985ce,{contacts:_0x2a3e4a}=_0xe752d8[_0x343268(0x21d)],_0x22ea53=_0x2a3e4a['length'],_0x2f392e=await CampaignShipping_1[_0x343268(0x1f4)][_0x343268(0x1a7)]({'where':{'campaignId':_0xe752d8['id'],'deliveredAt':{[sequelize_1['Op'][_0x343268(0x192)]]:null}}});_0x22ea53===_0x2f392e&&await _0xe752d8[_0x343268(0x223)]({'status':_0x343268(0x24e),'completedAt':(0x0,moment_1[_0x343268(0x1f4)])()});const _0x52fbf9=(0x0,socket_1['getIO'])();_0x52fbf9[_0x343268(0x1fd)](_0x343268(0x19e)+_0xe752d8[_0x343268(0x23d)]+'-campaign',{'action':'update','record':_0xe752d8});}async function handleProcessCampaign(_0x31382b){const _0x335188=a337_0x5985ce;try{const {id:_0x2e91d8}=_0x31382b[_0x335188(0x198)],_0x1f32e6=await getCampaign(_0x2e91d8),_0x34fd7c=await getSettings(_0x1f32e6);if(_0x1f32e6){const {contacts:_0x23057a}=_0x1f32e6['contactList'];if((0x0,lodash_1[_0x335188(0x1f6)])(_0x23057a)){const _0x411adf=_0x23057a[_0x335188(0x182)](_0x1a2d38=>({'contactId':_0x1a2d38['id'],'campaignId':_0x1f32e6['id'],'variables':_0x34fd7c[_0x335188(0x1fe)]})),_0x1d2ad0=parseToMilliseconds(_0x34fd7c[_0x335188(0x16c)]),_0x2a03fb=parseToMilliseconds(_0x34fd7c[_0x335188(0x23e)]),_0x28dc1a=_0x34fd7c[_0x335188(0x18d)];let _0x423727=_0x1f32e6['scheduledAt'];const _0x5d264d=[];for(let _0x238a58=0x0;_0x238a58<_0x411adf[_0x335188(0x1c8)];_0x238a58++){_0x423727=(0x0,date_fns_1[_0x335188(0x233)])(_0x423727,_0x238a58>_0x1d2ad0?_0x2a03fb:_0x28dc1a);const {contactId:_0x296912,campaignId:_0x2dad8c,variables:_0x3a3b59}=_0x411adf[_0x238a58],_0x504c8e=calculateDelay(_0x238a58,_0x423727,_0x1d2ad0,_0x2a03fb,_0x28dc1a),_0x214783=exports[_0x335188(0x219)]['add']('PrepareContact',{'contactId':_0x296912,'campaignId':_0x2dad8c,'variables':_0x3a3b59,'delay':_0x504c8e},{'removeOnComplete':!![]});_0x5d264d[_0x335188(0x16b)](_0x214783),logger_1[_0x335188(0x241)][_0x335188(0x1c5)](_0x335188(0x1cb)+_0x1f32e6['id']+_0x335188(0x247)+_0x23057a[_0x238a58][_0x335188(0x1e5)]+_0x335188(0x208)+_0x504c8e);}await Promise[_0x335188(0x213)](_0x5d264d),await _0x1f32e6[_0x335188(0x223)]({'status':_0x335188(0x230)});}}}catch(_0x2d1900){Sentry[_0x335188(0x1b7)](_0x2d1900);}}function calculateDelay(_0x43b50e,_0x215734,_0x2fb565,_0x40edc4,_0x206fe0){const _0x39f5a9=a337_0x5985ce,_0x4b21eb=(0x0,date_fns_1[_0x39f5a9(0x20e)])(_0x215734,new Date());return _0x43b50e>_0x2fb565?_0x4b21eb*0x3e8+_0x40edc4:_0x4b21eb*0x3e8+_0x206fe0;}async function handlePrepareContact(_0x2fa483){const _0x2fd1ea=a337_0x5985ce;try{const {contactId:_0x5887c5,campaignId:_0x15a39a,delay:_0x43e643,variables:_0x412a96}=_0x2fa483[_0x2fd1ea(0x198)],_0x16b167=await getCampaign(_0x15a39a),_0x59ea03=await getContact(_0x5887c5),_0xd319d9={};_0xd319d9['number']=_0x59ea03[_0x2fd1ea(0x24a)],_0xd319d9[_0x2fd1ea(0x1bb)]=_0x5887c5,_0xd319d9[_0x2fd1ea(0x216)]=_0x15a39a;const _0x13f180=getCampaignValidMessages(_0x16b167);if(_0x13f180['length']){const _0x428bed=randomValue(0x0,_0x13f180[_0x2fd1ea(0x1c8)]),_0x5975c2=getProcessedMessage(_0x13f180[_0x428bed],_0x412a96,_0x59ea03);_0xd319d9[_0x2fd1ea(0x1bf)]='‌\x20'+_0x5975c2;}if(_0x16b167[_0x2fd1ea(0x1c1)]){const _0x47479e=getCampaignValidConfirmationMessages(_0x16b167);if(_0x47479e[_0x2fd1ea(0x1c8)]){const _0x3d1511=randomValue(0x0,_0x47479e[_0x2fd1ea(0x1c8)]),_0x273274=getProcessedMessage(_0x47479e[_0x3d1511],_0x412a96,_0x59ea03);_0xd319d9['confirmationMessage']='‌\x20'+_0x273274;}}const [_0x2d6b4d,_0x360b61]=await CampaignShipping_1[_0x2fd1ea(0x1f4)][_0x2fd1ea(0x1ba)]({'where':{'campaignId':_0xd319d9[_0x2fd1ea(0x216)],'contactId':_0xd319d9[_0x2fd1ea(0x1bb)]},'defaults':_0xd319d9});!_0x360b61&&_0x2d6b4d[_0x2fd1ea(0x22a)]===null&&_0x2d6b4d[_0x2fd1ea(0x1fa)]===null&&(_0x2d6b4d['set'](_0xd319d9),await _0x2d6b4d['save']());if(_0x2d6b4d['deliveredAt']===null&&_0x2d6b4d['confirmationRequestedAt']===null){const _0x3d60cb=await exports[_0x2fd1ea(0x219)][_0x2fd1ea(0x19a)](_0x2fd1ea(0x256),{'campaignId':_0x16b167['id'],'campaignShippingId':_0x2d6b4d['id'],'contactListItemId':_0x5887c5},{'delay':_0x43e643});await _0x2d6b4d[_0x2fd1ea(0x223)]({'jobId':_0x3d60cb['id']});}await verifyAndFinalizeCampaign(_0x16b167);}catch(_0x2f08bf){Sentry[_0x2fd1ea(0x1b7)](_0x2f08bf),logger_1[_0x2fd1ea(0x241)][_0x2fd1ea(0x195)](_0x2fd1ea(0x172)+_0x2f08bf[_0x2fd1ea(0x1bf)]);}}async function handleDispatchCampaign(_0x5b9726){const _0x4eb0ab=a337_0x5985ce;try{const {data:_0x4f961a}=_0x5b9726,{campaignShippingId:_0x53d7f8,campaignId:_0xafa1c4}=_0x4f961a,_0x5a8fb5=await getCampaign(_0xafa1c4),_0x269e1a=await(0x0,GetWhatsappWbot_1[_0x4eb0ab(0x1f4)])(_0x5a8fb5[_0x4eb0ab(0x237)]);if(!_0x269e1a){logger_1['logger'][_0x4eb0ab(0x195)](_0x4eb0ab(0x254));return;}if(!_0x5a8fb5[_0x4eb0ab(0x237)]){logger_1['logger']['error']('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0x269e1a?.['user']?.['id']){logger_1[_0x4eb0ab(0x241)][_0x4eb0ab(0x195)](_0x4eb0ab(0x1f5));return;}logger_1[_0x4eb0ab(0x241)]['info'](_0x4eb0ab(0x189)+_0xafa1c4+_0x4eb0ab(0x1bc)+_0x53d7f8);const _0x3a30ad=await CampaignShipping_1[_0x4eb0ab(0x1f4)][_0x4eb0ab(0x203)](_0x53d7f8,{'include':[{'model':ContactListItem_1[_0x4eb0ab(0x1f4)],'as':'contact'}]}),_0x5f2aa7=_0x3a30ad['number']+_0x4eb0ab(0x1b0);let _0x481b0b=_0x3a30ad['message'];_0x5a8fb5['confirmation']&&_0x3a30ad['confirmation']===null&&(_0x481b0b=_0x3a30ad[_0x4eb0ab(0x217)]);if(_0x5a8fb5['openTicket']===_0x4eb0ab(0x211)){const _0x492a9c=await Contact_1[_0x4eb0ab(0x1f4)][_0x4eb0ab(0x16e)]({'where':{'number':_0x3a30ad[_0x4eb0ab(0x24a)]}}),_0x17398b=await Whatsapp_1['default'][_0x4eb0ab(0x203)](_0x5a8fb5['whatsappId']),_0x5e69be=await CompaniesSettings_1['default']['findOne']({'where':{'companyId':_0x5a8fb5['companyId']}}),{ticket:_0x232b6d}=await(0x0,FindOrCreateTicketService_1[_0x4eb0ab(0x1f4)])(_0x492a9c,_0x17398b,0x1,_0x5a8fb5[_0x4eb0ab(0x23d)],_0x5a8fb5?.[_0x4eb0ab(0x1ae)],_0x5a8fb5?.[_0x4eb0ab(0x210)],null,'whatsapp',![],![],_0x5e69be);if(_0x5a8fb5[_0x4eb0ab(0x1ec)]===null){const _0x5484a9=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x481b0b,'ticket':_0x232b6d});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x5484a9,_0x232b6d,_0x232b6d[_0x4eb0ab(0x21e)]);}else{const _0x1b59b8=path_1[_0x4eb0ab(0x1f4)]['resolve'](__dirname,'..',_0x4eb0ab(0x1af)),_0x21a9f2=path_1[_0x4eb0ab(0x1f4)][_0x4eb0ab(0x1b6)](_0x1b59b8,_0x4eb0ab(0x1d2)+_0x5a8fb5[_0x4eb0ab(0x23d)],_0x5a8fb5[_0x4eb0ab(0x1ec)]),_0x19abd2=await(0x0,SendWhatsAppMedia_1[_0x4eb0ab(0x246)])(_0x5a8fb5[_0x4eb0ab(0x1ce)],_0x21a9f2,_0x5a8fb5[_0x4eb0ab(0x23d)][_0x4eb0ab(0x17d)](),_0x481b0b);if(Object['keys'](_0x19abd2)[_0x4eb0ab(0x1c8)]){const _0x56fea0=await _0x269e1a[_0x4eb0ab(0x21b)](_0x5f2aa7,{..._0x19abd2});await(0x0,wbotMessageListener_1[_0x4eb0ab(0x190)])(_0x56fea0,_0x232b6d,_0x232b6d['contact']);}}_0x5a8fb5?.[_0x4eb0ab(0x1e2)]==='closed'&&await _0x232b6d['update']({'status':'closed'}),await _0x3a30ad['update']({'deliveredAt':(0x0,moment_1[_0x4eb0ab(0x1f4)])()});}else{if(_0x5a8fb5['mediaPath']){const _0x96fd44=path_1[_0x4eb0ab(0x1f4)][_0x4eb0ab(0x244)](__dirname,'..',_0x4eb0ab(0x1af)),_0x5159af=path_1['default'][_0x4eb0ab(0x1b6)](_0x96fd44,_0x4eb0ab(0x1d2)+_0x5a8fb5[_0x4eb0ab(0x23d)],_0x5a8fb5[_0x4eb0ab(0x1ec)]),_0x30bde1=await(0x0,SendWhatsAppMedia_1[_0x4eb0ab(0x246)])(_0x5a8fb5[_0x4eb0ab(0x1ce)],_0x5159af,_0x5a8fb5[_0x4eb0ab(0x23d)][_0x4eb0ab(0x17d)](),_0x481b0b);Object['keys'](_0x30bde1)[_0x4eb0ab(0x1c8)]&&await _0x269e1a[_0x4eb0ab(0x21b)](_0x5f2aa7,{..._0x30bde1});}else _0x5a8fb5[_0x4eb0ab(0x1c1)]&&_0x3a30ad[_0x4eb0ab(0x1c1)]===null?(await _0x269e1a[_0x4eb0ab(0x21b)](_0x5f2aa7,{'text':_0x481b0b}),await _0x3a30ad['update']({'confirmationRequestedAt':(0x0,moment_1['default'])()})):await _0x269e1a[_0x4eb0ab(0x21b)](_0x5f2aa7,{'text':_0x481b0b});await _0x3a30ad[_0x4eb0ab(0x223)]({'deliveredAt':(0x0,moment_1[_0x4eb0ab(0x1f4)])()});}await verifyAndFinalizeCampaign(_0x5a8fb5);const _0x5af1d0=(0x0,socket_1[_0x4eb0ab(0x1a9)])();_0x5af1d0[_0x4eb0ab(0x1fd)]('company-'+_0x5a8fb5[_0x4eb0ab(0x23d)]+_0x4eb0ab(0x1f2),{'action':_0x4eb0ab(0x223),'record':_0x5a8fb5}),logger_1[_0x4eb0ab(0x241)][_0x4eb0ab(0x1c5)](_0x4eb0ab(0x22b)+_0xafa1c4+_0x4eb0ab(0x247)+_0x3a30ad[_0x4eb0ab(0x21e)]['name']);}catch(_0x1c61fc){Sentry[_0x4eb0ab(0x1b7)](_0x1c61fc),logger_1[_0x4eb0ab(0x241)][_0x4eb0ab(0x195)](_0x1c61fc[_0x4eb0ab(0x1bf)]),console['log'](_0x1c61fc[_0x4eb0ab(0x23b)]);}}async function handleLoginStatus(_0x445e32){const _0x1ac565=a337_0x5985ce,_0x1c3f5c=await database_1[_0x1ac565(0x1f4)][_0x1ac565(0x1d0)](_0x1ac565(0x1d7),{'type':sequelize_1[_0x1ac565(0x1cf)][_0x1ac565(0x243)]}),_0x5cd1fd=_0x1c3f5c['map'](_0x2e2343=>_0x2e2343['id']),_0x1a3862=_0x5cd1fd['join'](',\x20');try{const _0x67d1cf=_0x1ac565(0x1dc)+_0x1a3862+');',_0xe21f9f=await database_1[_0x1ac565(0x1f4)][_0x1ac565(0x1d0)](_0x67d1cf,{'type':sequelize_1[_0x1ac565(0x1cf)][_0x1ac565(0x179)]});}catch(_0x569677){Sentry['captureException'](_0x569677);}}async function handleVerifyQueue(_0x2773ef){const _0x350684=a337_0x5985ce;try{const _0x572cfc=await Company_1[_0x350684(0x1f4)][_0x350684(0x258)]({'attributes':['id',_0x350684(0x1e5)],'where':{'status':!![]},'include':[{'model':Whatsapp_1['default'],'attributes':['id',_0x350684(0x1e5),'status',_0x350684(0x1c9),_0x350684(0x1da)]}]});_0x572cfc[_0x350684(0x182)](async _0x14a799=>{const _0x177dd2=_0x350684;_0x14a799[_0x177dd2(0x204)][_0x177dd2(0x182)](async _0x19646f=>{const _0x1741d3=_0x177dd2;if(_0x19646f['status']===_0x1741d3(0x1cc)){var _0x581dd8=_0x14a799['id'];const _0x60d863=_0x19646f[_0x1741d3(0x1c9)]?_0x19646f[_0x1741d3(0x1c9)]:0x0,_0x46d4f3=_0x19646f[_0x1741d3(0x1da)],_0x3f8544=_0x60d863,_0x3e813f=_0x46d4f3,_0x12b033=_0x3f8544;if(_0x60d863>0x0){if(!isNaN(_0x3e813f)&&Number[_0x1741d3(0x1ee)](_0x3e813f)&&!isNaN(_0x12b033)&&Number[_0x1741d3(0x1ee)](_0x12b033)){const _0x50df80=(0x0,moment_1[_0x1741d3(0x1f4)])()[_0x1741d3(0x20a)](_0x12b033,_0x1741d3(0x1ef))[_0x1741d3(0x21c)]()[_0x1741d3(0x218)](),{count:_0x398511,rows:_0x1265e3}=await Ticket_1[_0x1741d3(0x1f4)][_0x1741d3(0x21f)]({'attributes':['id'],'where':{'status':_0x1741d3(0x170),'queueId':null,'companyId':_0x581dd8,'whatsappId':_0x19646f['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x50df80}},'include':[{'model':Contact_1[_0x1741d3(0x1f4)],'as':'contact','attributes':['id',_0x1741d3(0x1e5),_0x1741d3(0x24a),_0x1741d3(0x202),_0x1741d3(0x214),'acceptAudioMessage','active','disableBot'],'include':['extraInfo','contactTags',_0x1741d3(0x1a6)]},{'model':Queue_2[_0x1741d3(0x1f4)],'as':_0x1741d3(0x1fc),'attributes':['id',_0x1741d3(0x1e5),_0x1741d3(0x191)]},{'model':Whatsapp_1[_0x1741d3(0x1f4)],'as':_0x1741d3(0x237),'attributes':['id',_0x1741d3(0x1e5),_0x1741d3(0x1c6),'groupAsTicket']}]});_0x398511>0x0&&_0x1265e3[_0x1741d3(0x182)](async _0x3b78dd=>{const _0x2d17b4=_0x1741d3;await _0x3b78dd[_0x2d17b4(0x223)]({'queueId':_0x3e813f}),await _0x3b78dd[_0x2d17b4(0x236)]();const _0x5eba21=(0x0,socket_1[_0x2d17b4(0x1a9)])();_0x5eba21['to'](_0x3b78dd[_0x2d17b4(0x1ca)])['to'](_0x2d17b4(0x188))['to'](_0x3b78dd['id'][_0x2d17b4(0x17d)]())['emit'](_0x2d17b4(0x19e)+_0x581dd8+_0x2d17b4(0x248),{'action':_0x2d17b4(0x223),'ticket':_0x3b78dd,'ticketId':_0x3b78dd['id']}),logger_1[_0x2d17b4(0x241)][_0x2d17b4(0x1c5)](_0x2d17b4(0x180)+_0x3b78dd['id']+'\x20-\x20Empresa:\x20'+_0x581dd8);});}else logger_1[_0x1741d3(0x241)][_0x1741d3(0x1c5)]('Condição\x20não\x20respeitada\x20-\x20Empresa:\x20'+_0x581dd8);}}});});}catch(_0xfb85eb){Sentry[_0x350684(0x1b7)](_0xfb85eb),logger_1[_0x350684(0x241)][_0x350684(0x195)]('SearchForQueue\x20->\x20VerifyQueue:\x20error',_0xfb85eb[_0x350684(0x1bf)]);throw _0xfb85eb;}};async function handleRandomUser(){const _0x565001=a337_0x5985ce,_0x4811aa=new CronJob('*/5\x20*\x20*\x20*\x20*\x20*',async()=>{const _0x578109=a337_0x17ed;try{const {count:_0x591fa8,rows:_0x2f1635}=await Ticket_1[_0x578109(0x1f4)]['findAndCountAll']({'where':{'status':_0x578109(0x170),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1['default'],'as':_0x578109(0x1fc)}]}),_0x4e7c21=_0x2791db=>{const _0x3afeab=_0x578109,_0x4dec2a=Math[_0x3afeab(0x1d6)](Math[_0x3afeab(0x185)]()*_0x2791db['length']);return _0x2791db[_0x4dec2a];},_0x3796b9=async _0x4d2fc0=>{const _0x4d0c83=_0x578109;try{const _0x3a80ed=await User_1[_0x4d0c83(0x1f4)][_0x4d0c83(0x16e)]({'where':{'id':_0x4d2fc0}});return _0x3a80ed[_0x4d0c83(0x201)]===_0x4d0c83(0x1a8)?_0x3a80ed[_0x4d0c83(0x24d)]===!![]?_0x3a80ed['id']:0x0:0x0;}catch(_0x4c0e85){Sentry[_0x4d0c83(0x1b7)](_0x4c0e85),logger_1[_0x4d0c83(0x241)][_0x4d0c83(0x195)](_0x4d0c83(0x239),_0x4c0e85[_0x4d0c83(0x1bf)]);throw _0x4c0e85;}};if(_0x591fa8>0x0)for(const _0xac86b6 of _0x2f1635){const {queue:_0x4b04db,queueId:_0x33bc18,userId:_0x51b5f9}=_0xac86b6,_0x399a19=_0x4b04db[_0x578109(0x206)],_0x242684=await UserQueue_1[_0x578109(0x1f4)][_0x578109(0x258)]({'where':{'queueId':_0x33bc18}}),_0x3dc9b7=await(0x0,ShowContactService_1[_0x578109(0x1f4)])(_0xac86b6[_0x578109(0x1bb)],_0xac86b6[_0x578109(0x23d)]),_0x17efb4=_0x242684[_0x578109(0x182)](_0x2c7000=>_0x2c7000[_0x578109(0x210)]),_0x5ea625=(0x0,moment_1[_0x578109(0x1f4)])()['subtract'](_0x399a19,_0x578109(0x1ef))[_0x578109(0x21c)]()[_0x578109(0x22c)](),_0x312f40=new Date(_0xac86b6[_0x578109(0x20f)]);let _0x4c255f=await CompaniesSettings_1[_0x578109(0x1f4)][_0x578109(0x16e)]({'where':{'companyId':_0xac86b6[_0x578109(0x23d)]}});const _0x3d9a6f=_0x4c255f['sendGreetingMessageOneQueues']===_0x578109(0x211)||![];if(!_0x51b5f9){const _0x12a105=_0x4e7c21(_0x17efb4);if(await _0x3796b9(_0x12a105)>0x0){if(_0x3d9a6f){const _0x660e13=await(0x0,ShowTicketService_1[_0x578109(0x1f4)])(_0xac86b6['id'],_0xac86b6[_0x578109(0x23d)]);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x578109(0x1e7),'ticket':_0x660e13});}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x578109(0x170),'userId':_0x12a105},'ticketId':_0xac86b6['id'],'companyId':_0xac86b6[_0x578109(0x23d)]}),logger_1[_0x578109(0x241)][_0x578109(0x1c5)]('Ticket\x20ID\x20'+_0xac86b6['id']+'\x20updated\x20with\x20UserId\x20'+_0x12a105+'\x20-\x20'+_0xac86b6[_0x578109(0x20f)]);}else{}}else{if(_0x17efb4[_0x578109(0x259)](_0x51b5f9)){if(_0x5ea625>_0x312f40){const _0x250aa4=_0x17efb4['filter'](_0xb6b969=>_0xb6b969!==_0x51b5f9);if(_0x250aa4[_0x578109(0x1c8)]>0x0){const _0x27103d=_0x4e7c21(_0x250aa4);if(await _0x3796b9(_0x27103d)>0x0){if(_0x3d9a6f){const _0x161daa=await(0x0,ShowTicketService_1[_0x578109(0x1f4)])(_0xac86b6['id'],_0xac86b6['companyId']);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x578109(0x1e7),'ticket':_0x161daa});};await(0x0,UpdateTicketService_1[_0x578109(0x1f4)])({'ticketData':{'status':_0x578109(0x170),'userId':_0x27103d},'ticketId':_0xac86b6['id'],'companyId':_0xac86b6['companyId']}),await _0xac86b6[_0x578109(0x236)]();}else{}}else{}}else{}}else{}}}}catch(_0x10bf4d){Sentry[_0x578109(0x1b7)](_0x10bf4d),logger_1[_0x578109(0x241)][_0x578109(0x195)](_0x578109(0x239),_0x10bf4d[_0x578109(0x1bf)]);throw _0x10bf4d;}});_0x4811aa[_0x565001(0x23c)]();}async function handleCloseTicketsAutomatic(){const _0x6485a3=a337_0x5985ce,_0x3f8885=new CronJob(_0x6485a3(0x23a),async()=>{const _0x30a95d=_0x6485a3,_0x430bbf=await Company_1[_0x30a95d(0x1f4)][_0x30a95d(0x258)]();_0x430bbf[_0x30a95d(0x182)](async _0x2c5bc1=>{const _0x1f4196=_0x30a95d;try{const _0x46b7ca=_0x2c5bc1['id'];await(0x0,wbotClosedTickets_1[_0x1f4196(0x199)])(_0x46b7ca);}catch(_0x1ca4e6){Sentry[_0x1f4196(0x1b7)](_0x1ca4e6),logger_1[_0x1f4196(0x241)][_0x1f4196(0x195)]('ClosedAllOpenTickets\x20->\x20Verify:\x20error',_0x1ca4e6[_0x1f4196(0x1bf)]);throw _0x1ca4e6;}});});_0x3f8885['start']();}async function handleWhatsapp(){const _0x2eed28=a337_0x5985ce,_0x577b80=new CronJob('*\x2015\x203\x20*\x20*\x20*',async()=>{const _0x37eef8=a337_0x17ed;(0x0,GetWhatsapp_1[_0x37eef8(0x1a4)])(),_0x577b80[_0x37eef8(0x224)]();},null,![],_0x2eed28(0x1aa));_0x577b80[_0x2eed28(0x23c)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x5c9de7=a337_0x5985ce;logger_1[_0x5c9de7(0x241)][_0x5c9de7(0x1c5)](_0x5c9de7(0x1a1)),exports['messageQueue'][_0x5c9de7(0x1e4)]('SendMessage',handleSendMessage),exports['scheduleMonitor'][_0x5c9de7(0x1e4)](_0x5c9de7(0x1a0),handleVerifySchedules),exports['sendScheduledMessages']['process'](_0x5c9de7(0x245),handleSendScheduledMessage),exports['campaignQueue'][_0x5c9de7(0x1e4)]('VerifyCampaignsDaatabase',handleVerifyCampaigns),exports['campaignQueue']['process'](_0x5c9de7(0x17a),handleProcessCampaign),exports['campaignQueue']['process'](_0x5c9de7(0x207),handlePrepareContact),exports[_0x5c9de7(0x219)]['process'](_0x5c9de7(0x256),handleDispatchCampaign),exports[_0x5c9de7(0x250)][_0x5c9de7(0x1e4)](_0x5c9de7(0x229),handleLoginStatus),exports[_0x5c9de7(0x255)][_0x5c9de7(0x1e4)]('VerifyQueueStatus',handleVerifyQueue),exports[_0x5c9de7(0x177)]['add'](_0x5c9de7(0x1a0),{},{'repeat':{'cron':_0x5c9de7(0x1ed),'key':'verify'},'removeOnComplete':!![]}),exports['campaignQueue'][_0x5c9de7(0x19a)](_0x5c9de7(0x1d9),{},{'repeat':{'cron':_0x5c9de7(0x1f0),'key':_0x5c9de7(0x1ac)},'removeOnComplete':!![]}),exports['userMonitor'][_0x5c9de7(0x19a)](_0x5c9de7(0x229),{},{'repeat':{'cron':'*\x20*\x20*\x20*\x20*','key':_0x5c9de7(0x1a5)},'removeOnComplete':!![]}),exports[_0x5c9de7(0x255)][_0x5c9de7(0x19a)](_0x5c9de7(0x24b),{},{'repeat':{'cron':'*/20\x20*\x20*\x20*\x20*\x20*','key':_0x5c9de7(0x231)},'removeOnComplete':!![]});}exports['startQueueProcess']=startQueueProcess;
=======
'use strict';const a337_0x5a2b44=a337_0x3c02;(function(_0x429108,_0x3c217a){const _0xe67443=a337_0x3c02,_0x5f4662=_0x429108();while(!![]){try{const _0x45cecc=-parseInt(_0xe67443(0x145))/0x1+parseInt(_0xe67443(0x130))/0x2*(parseInt(_0xe67443(0x146))/0x3)+parseInt(_0xe67443(0x174))/0x4*(parseInt(_0xe67443(0x1c4))/0x5)+-parseInt(_0xe67443(0xfc))/0x6+parseInt(_0xe67443(0x192))/0x7+-parseInt(_0xe67443(0x16a))/0x8*(-parseInt(_0xe67443(0xff))/0x9)+-parseInt(_0xe67443(0x107))/0xa;if(_0x45cecc===_0x3c217a)break;else _0x5f4662['push'](_0x5f4662['shift']());}catch(_0x47a524){_0x5f4662['push'](_0x5f4662['shift']());}}}(a337_0xac02,0x21db4));var __createBinding=this&&this['__createBinding']||(Object[a337_0x5a2b44(0x113)]?function(_0x58a965,_0x2efc18,_0x2d2ef5,_0x262601){const _0x2e4698=a337_0x5a2b44;if(_0x262601===undefined)_0x262601=_0x2d2ef5;var _0x43f9bd=Object[_0x2e4698(0xfa)](_0x2efc18,_0x2d2ef5);(!_0x43f9bd||(_0x2e4698(0x184)in _0x43f9bd?!_0x2efc18[_0x2e4698(0x1b1)]:_0x43f9bd[_0x2e4698(0x122)]||_0x43f9bd['configurable']))&&(_0x43f9bd={'enumerable':!![],'get':function(){return _0x2efc18[_0x2d2ef5];}}),Object[_0x2e4698(0xe6)](_0x58a965,_0x262601,_0x43f9bd);}:function(_0x40ab8d,_0x260ffe,_0x678a0e,_0x41f204){if(_0x41f204===undefined)_0x41f204=_0x678a0e;_0x40ab8d[_0x41f204]=_0x260ffe[_0x678a0e];}),__setModuleDefault=this&&this[a337_0x5a2b44(0x18f)]||(Object['create']?function(_0x45ccfb,_0x1cf72c){const _0x43d87e=a337_0x5a2b44;Object['defineProperty'](_0x45ccfb,_0x43d87e(0xde),{'enumerable':!![],'value':_0x1cf72c});}:function(_0x530262,_0x1a601e){const _0x3fcf1c=a337_0x5a2b44;_0x530262[_0x3fcf1c(0xde)]=_0x1a601e;}),__importStar=this&&this[a337_0x5a2b44(0x19a)]||function(_0x5b60df){const _0x4ade34=a337_0x5a2b44;if(_0x5b60df&&_0x5b60df['__esModule'])return _0x5b60df;var _0x34c08f={};if(_0x5b60df!=null){for(var _0xd52c05 in _0x5b60df)if(_0xd52c05!==_0x4ade34(0xde)&&Object[_0x4ade34(0x103)]['hasOwnProperty'][_0x4ade34(0x15a)](_0x5b60df,_0xd52c05))__createBinding(_0x34c08f,_0x5b60df,_0xd52c05);}return __setModuleDefault(_0x34c08f,_0x5b60df),_0x34c08f;},__importDefault=this&&this[a337_0x5a2b44(0x1b0)]||function(_0x229b33){return _0x229b33&&_0x229b33['__esModule']?_0x229b33:{'default':_0x229b33};};Object['defineProperty'](exports,a337_0x5a2b44(0x1b1),{'value':!![]}),exports[a337_0x5a2b44(0x1a9)]=exports['randomValue']=exports[a337_0x5a2b44(0x1c1)]=exports[a337_0x5a2b44(0x1b3)]=exports[a337_0x5a2b44(0x1af)]=exports['campaignQueue']=exports[a337_0x5a2b44(0x150)]=exports[a337_0x5a2b44(0x141)]=exports[a337_0x5a2b44(0x15b)]=void 0x0;const Sentry=__importStar(require('@sentry/node')),bull_1=__importDefault(require('bull')),SendMessage_1=require('./helpers/SendMessage'),Whatsapp_1=__importDefault(require(a337_0x5a2b44(0x12e))),logger_1=require(a337_0x5a2b44(0x16f)),moment_1=__importDefault(require(a337_0x5a2b44(0x190))),Schedule_1=__importDefault(require(a337_0x5a2b44(0x179))),sequelize_1=require('sequelize'),GetDefaultWhatsApp_1=__importDefault(require(a337_0x5a2b44(0x19c))),Campaign_1=__importDefault(require(a337_0x5a2b44(0x161))),Queue_1=__importDefault(require(a337_0x5a2b44(0x1be))),ContactList_1=__importDefault(require(a337_0x5a2b44(0x11a))),ContactListItem_1=__importDefault(require(a337_0x5a2b44(0x13c))),lodash_1=require('lodash'),CampaignSetting_1=__importDefault(require('./models/CampaignSetting')),CampaignShipping_1=__importDefault(require('./models/CampaignShipping')),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require(a337_0x5a2b44(0xdf))),SendWhatsAppMedia_1=require('./services/WbotServices/SendWhatsAppMedia'),socket_1=require('./libs/socket'),path_1=__importDefault(require(a337_0x5a2b44(0x12f))),User_1=__importDefault(require('./models/User')),Company_1=__importDefault(require('./models/Company')),Contact_1=__importDefault(require(a337_0x5a2b44(0x123))),Queue_2=__importDefault(require(a337_0x5a2b44(0x1be))),wbotClosedTickets_1=require(a337_0x5a2b44(0x11e)),Ticket_1=__importDefault(require(a337_0x5a2b44(0x183))),ShowContactService_1=__importDefault(require(a337_0x5a2b44(0x188))),UserQueue_1=__importDefault(require(a337_0x5a2b44(0x19f))),ShowTicketService_1=__importDefault(require(a337_0x5a2b44(0x114))),SendWhatsAppMessage_1=__importDefault(require('./services/WbotServices/SendWhatsAppMessage')),UpdateTicketService_1=__importDefault(require(a337_0x5a2b44(0x1ad))),date_fns_1=require('date-fns'),GetWhatsapp_1=require(a337_0x5a2b44(0x135)),nodemailer=require('nodemailer'),CronJob=require(a337_0x5a2b44(0x10a))['CronJob'],CompaniesSettings_1=__importDefault(require(a337_0x5a2b44(0xfb))),wbotMessageListener_1=require(a337_0x5a2b44(0x152)),FindOrCreateTicketService_1=__importDefault(require('./services/TicketServices/FindOrCreateTicketService')),connection=process[a337_0x5a2b44(0x1b9)][a337_0x5a2b44(0x131)]||'',limiterMax=process[a337_0x5a2b44(0x1b9)]['REDIS_OPT_LIMITER_MAX']||0x1,limiterDuration=process[a337_0x5a2b44(0x1b9)][a337_0x5a2b44(0x170)]||0xbb8;exports[a337_0x5a2b44(0x15b)]=new bull_1[(a337_0x5a2b44(0xde))](a337_0x5a2b44(0x1a8),connection),exports[a337_0x5a2b44(0x141)]=new bull_1[(a337_0x5a2b44(0xde))](a337_0x5a2b44(0xf8),connection),exports[a337_0x5a2b44(0x150)]=new bull_1[(a337_0x5a2b44(0xde))]('SendSacheduledMessages',connection),exports['campaignQueue']=new bull_1[(a337_0x5a2b44(0xde))]('CampaignQueue',connection),exports[a337_0x5a2b44(0x1af)]=new bull_1[(a337_0x5a2b44(0xde))]('QueueMonitor',connection),exports[a337_0x5a2b44(0x1b3)]=new bull_1[(a337_0x5a2b44(0xde))]('MessageQueue',connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x55571e){const _0xd45536=a337_0x5a2b44;try{const {data:_0x4fa2e3}=_0x55571e,_0xe75b5c=await Whatsapp_1['default']['findByPk'](_0x4fa2e3[_0xd45536(0xe9)]);if(_0xe75b5c===null)throw Error('Whatsapp\x20não\x20identificado');const _0x5abade=_0x4fa2e3['data'];await(0x0,SendMessage_1['SendMessage'])(_0xe75b5c,_0x5abade);}catch(_0xd5df7b){Sentry[_0xd45536(0x1bd)](_0xd5df7b),logger_1['logger']['error']('MessageQueue\x20->\x20SendMessage:\x20error',_0xd5df7b[_0xd45536(0x15f)]);throw _0xd5df7b;}}async function handleVerifySchedules(_0x27ba1f){const _0x42b3c2=a337_0x5a2b44;try{const {count:_0x329159,rows:_0x2c7207}=await Schedule_1[_0x42b3c2(0xde)][_0x42b3c2(0x163)]({'where':{'status':_0x42b3c2(0x12d),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x42b3c2(0x180)]]:(0x0,moment_1[_0x42b3c2(0xde)])()[_0x42b3c2(0xe3)](_0x42b3c2(0x14f)),[sequelize_1['Op']['lte']]:(0x0,moment_1[_0x42b3c2(0xde)])()[_0x42b3c2(0x14b)]('30','seconds')[_0x42b3c2(0xe3)](_0x42b3c2(0x14f))}},'include':[{'model':Contact_1[_0x42b3c2(0xde)],'as':'contact'}]});_0x329159>0x0&&_0x2c7207[_0x42b3c2(0x171)](async _0x5e3a8e=>{const _0x574160=_0x42b3c2;await _0x5e3a8e['update']({'status':'AGENDADA'}),exports['sendScheduledMessages'][_0x574160(0x14b)]('SendMessage',{'schedule':_0x5e3a8e},{'delay':0x9c40}),logger_1[_0x574160(0xeb)]['info'](_0x574160(0x18c)+_0x5e3a8e[_0x574160(0x197)][_0x574160(0x1b4)]);});}catch(_0x33f323){Sentry[_0x42b3c2(0x1bd)](_0x33f323),logger_1['logger'][_0x42b3c2(0x167)](_0x42b3c2(0x12b),_0x33f323[_0x42b3c2(0x15f)]);throw _0x33f323;}}async function handleSendScheduledMessage(_0x487ebe){const _0x3b2b56=a337_0x5a2b44,{data:{schedule:_0xc57b4c}}=_0x487ebe;let _0x433dbd=null;try{_0x433dbd=await Schedule_1[_0x3b2b56(0xde)]['findByPk'](_0xc57b4c['id']);}catch(_0x4d6062){Sentry[_0x3b2b56(0x1bd)](_0x4d6062),logger_1[_0x3b2b56(0xeb)][_0x3b2b56(0x172)](_0x3b2b56(0x136)+_0xc57b4c['id']);}try{const _0x236537=await(0x0,GetDefaultWhatsApp_1[_0x3b2b56(0xde)])(_0xc57b4c['companyId']);console[_0x3b2b56(0x132)](_0xc57b4c);const _0x3eb220=await CompaniesSettings_1['default']['findOne']({'where':{'companyId':_0xc57b4c['companyId']}}),{ticket:_0x254e6a}=await(0x0,FindOrCreateTicketService_1[_0x3b2b56(0xde)])(_0xc57b4c['contact'],_0x236537,0x1,_0xc57b4c[_0x3b2b56(0x13e)],0x0,0x0,null,_0x3b2b56(0x14a),![],![],_0x3eb220),_0x2761fb=await(0x0,SendMessage_1[_0x3b2b56(0xe8)])(_0x236537,{'number':_0xc57b4c['contact'][_0x3b2b56(0x13d)],'body':_0xc57b4c[_0x3b2b56(0x126)]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x2761fb,_0x254e6a,_0xc57b4c['contact']['number']),await _0x433dbd?.[_0x3b2b56(0x120)]({'sentAt':(0x0,moment_1[_0x3b2b56(0xde)])()[_0x3b2b56(0xe3)](_0x3b2b56(0x149)),'status':_0x3b2b56(0x176)}),logger_1['logger']['info']('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0xc57b4c[_0x3b2b56(0x197)]['name']),exports[_0x3b2b56(0x150)][_0x3b2b56(0x117)](0x3a98,'completed');}catch(_0x32333a){Sentry[_0x3b2b56(0x1bd)](_0x32333a),await _0x433dbd?.[_0x3b2b56(0x120)]({'status':_0x3b2b56(0x1b8)}),logger_1[_0x3b2b56(0xeb)][_0x3b2b56(0x167)]('SendScheduledMessage\x20->\x20SendMessage:\x20error',_0x32333a[_0x3b2b56(0x15f)]);throw _0x32333a;}}async function handleVerifyCampaigns(_0x9b8207){const _0x73677d=a337_0x5a2b44,_0x3b5789=await database_1[_0x73677d(0xde)][_0x73677d(0x19b)](_0x73677d(0x134),{'type':sequelize_1[_0x73677d(0x1a7)][_0x73677d(0x1a4)]});if(_0x3b5789[_0x73677d(0x1ae)]>0x0)logger_1[_0x73677d(0xeb)][_0x73677d(0x172)](_0x73677d(0x14d)+_0x3b5789[_0x73677d(0x1ae)]);for(let _0x2f0faf of _0x3b5789){try{const _0x4d1384=(0x0,moment_1['default'])(),_0x1f3ec5=(0x0,moment_1[_0x73677d(0xde)])(_0x2f0faf[_0x73677d(0x124)]),_0x3732ce=_0x1f3ec5['diff'](_0x4d1384,_0x73677d(0x116));logger_1[_0x73677d(0xeb)]['info'](_0x73677d(0x17e)+_0x2f0faf['id']+',\x20Delay\x20Inicial='+_0x3732ce),exports[_0x73677d(0x121)][_0x73677d(0x14b)](_0x73677d(0x137),{'id':_0x2f0faf['id'],'delay':_0x3732ce},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x330c30){Sentry[_0x73677d(0x1bd)](_0x330c30);}}}async function getCampaign(_0x2295e1){const _0x3b892a=a337_0x5a2b44;return await Campaign_1['default'][_0x3b892a(0x112)]({'where':{'id':_0x2295e1},'include':[{'model':ContactList_1[_0x3b892a(0xde)],'as':_0x3b892a(0x15d),'attributes':['id',_0x3b892a(0x1b4)],'include':[{'model':ContactListItem_1[_0x3b892a(0xde)],'as':_0x3b892a(0xe1),'attributes':['id',_0x3b892a(0x1b4),_0x3b892a(0x13d),'email',_0x3b892a(0x115)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x3b892a(0x14a),'attributes':['id',_0x3b892a(0x1b4)]}]});}async function getContact(_0x46a043){const _0x20ddfd=a337_0x5a2b44;return await ContactListItem_1[_0x20ddfd(0xde)][_0x20ddfd(0x140)](_0x46a043,{'attributes':['id',_0x20ddfd(0x1b4),'number','email']});}async function getSettings(_0x3e841c){const _0x4c1a8b=a337_0x5a2b44;try{const _0x4e13f9=await CampaignSetting_1['default'][_0x4c1a8b(0x155)]({'where':{'companyId':_0x3e841c[_0x4c1a8b(0x13e)]},'attributes':[_0x4c1a8b(0x108),'value']});let _0x198ba5=0x14,_0x374c84=0x14,_0x4d7526=0x3c,_0x1c4db5=[];return _0x4e13f9[_0x4c1a8b(0x139)](_0x542251=>{const _0x49876d=_0x4c1a8b;_0x542251['key']===_0x49876d(0x1a0)&&(_0x198ba5=JSON['parse'](_0x542251[_0x49876d(0x1b6)])),_0x542251[_0x49876d(0x108)]==='longerIntervalAfter'&&(_0x374c84=JSON[_0x49876d(0x173)](_0x542251[_0x49876d(0x1b6)])),_0x542251['key']===_0x49876d(0x182)&&(_0x4d7526=JSON['parse'](_0x542251[_0x49876d(0x1b6)])),_0x542251['key']===_0x49876d(0x165)&&(_0x1c4db5=JSON[_0x49876d(0x173)](_0x542251[_0x49876d(0x1b6)]));}),{'messageInterval':_0x198ba5,'longerIntervalAfter':_0x374c84,'greaterInterval':_0x4d7526,'variables':_0x1c4db5};}catch(_0x1aa6c6){console[_0x4c1a8b(0x132)](_0x1aa6c6);throw _0x1aa6c6;}}function parseToMilliseconds(_0x3ea13d){return _0x3ea13d*0x3e8;}exports[a337_0x5a2b44(0x1c1)]=parseToMilliseconds;async function sleep(_0x7066c3){const _0x103aeb=a337_0x5a2b44;return logger_1[_0x103aeb(0xeb)]['info']('Sleep\x20de\x20'+_0x7066c3+_0x103aeb(0xf2)+(0x0,moment_1[_0x103aeb(0xde)])()['format'](_0x103aeb(0xea))),new Promise(_0xe7b604=>{setTimeout(()=>{const _0x52e357=a337_0x3c02;logger_1[_0x52e357(0xeb)][_0x52e357(0x172)]('Sleep\x20de\x20'+_0x7066c3+_0x52e357(0x1bf)+(0x0,moment_1[_0x52e357(0xde)])()[_0x52e357(0xe3)](_0x52e357(0xea))),_0xe7b604(!![]);},parseToMilliseconds(_0x7066c3));});}function getCampaignValidMessages(_0x4b4287){const _0x401499=a337_0x5a2b44,_0x50aeb2=[];return!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287['message1'])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287['message1'])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x195)]),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287[_0x401499(0x148)])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287[_0x401499(0x148)])&&_0x50aeb2['push'](_0x4b4287['message2']),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287[_0x401499(0x118)])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287['message3'])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x118)]),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287[_0x401499(0x159)])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287[_0x401499(0x159)])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x159)]),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287['message5'])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287[_0x401499(0x19e)])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x19e)]),_0x50aeb2;}function a337_0xac02(){const _0x6ed42e=['whatsappId','HH:mm:ss','logger','toString','confirmationMessage4','randomValue','UPDATE','keys','floor','\x20segundos\x20iniciado:\x20','America/Sao_Paulo','isInteger','user','filter','active','ScheduleMonitor','sendGreetingMessageOneQueues','getOwnPropertyDescriptor','./models/CompaniesSettings','1064688AinlvG','contactId','pending','144QKJCor','sendMessage','statusTicket','mediaPath','prototype','confirmationRequestedAt','groupAsTicket','data','1699730kbxnAu','key','PrepareContact','cron','tempoRoteador','longerIntervalAfter','VerifyLoginStatus','notification','CONNECTED','reload','SearchForQueue\x20->\x20VerifyQueue:\x20error','findOne','create','./services/TicketServices/ShowTicketService','isWhatsappValid','milliseconds','clean','message3','status','./models/ContactList','utc','online','verify-login','./services/WbotServices/wbotClosedTickets','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','update','campaignQueue','writable','./models/Contact','scheduledAt','getMessageOptions','body','count','addSeconds','resolve','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','SendScheduledMessage\x20->\x20Verify:\x20error','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','PENDENTE','./models/Whatsapp','path','3742lXcovU','REDIS_URI','log','join','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','./helpers/GetWhatsapp','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','ProcessCampaign','confirmationMessage','forEach','extraInfo','color','./models/ContactListItem','number','companyId','*/20\x20*\x20*\x20*\x20*\x20*','findByPk','scheduleMonitor','minutes','*\x20*\x20*\x20*\x20*','FINALIZADA','149726EOMkNW','111RQXLfm','verify-queue','message2','YYYY-MM-DD\x20HH:mm','whatsapp','add','enabled','Campanhas\x20encontradas:\x20','\x20-\x20Empresa:\x20','YYYY-MM-DD\x20HH:mm:ss','sendScheduledMessages','-campaign','./services/WbotServices/wbotMessageListener','*/5\x20*\x20*\x20*\x20*\x20*','isNil','findAll','emit','timeSendQueue','VerifyQueueStatus','message4','call','userMonitor','not','contactList','GetWhatsapp','message','userId','./models/Campaign','-ticket','findAndCountAll','confirmationMessage1','variables','campaignId','error','{email}','EM_ANDAMENTO','134104ILovHJ','random','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','email','./utils/logger','REDIS_OPT_LIMITER_DURATION','map','info','parse','580JJBxOS','openTicket','ENVIADA','Atendimento\x20Perdido:\x20','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','./models/Schedule','deliveredAt','expiresTicket','toDate',';Registro=','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','all','gte','VerifyCampaignsDaatabase','greaterInterval','./models/Ticket','get','company-','confirmationMessage5',';Contato=','./services/ContactServices/ShowContactService','stack','DispatchCampaign',';delay=','Disparo\x20agendado\x20para:\x20','\x20updated\x20with\x20UserId\x20','Ticket\x20ID\x20','__setModuleDefault','moment','isEmpty','1767976OWelwb','mediaName','public','message1','queue','contact','sendIdQueue','Iniciando\x20processamento\x20de\x20filas','__importStar','query','./helpers/GetDefaultWhatsApp','replace','message5','./models/UserQueue','messageInterval','tags','{numero}','findOrCreate','SELECT','closed','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','QueryTypes','UserMonitor','startQueueProcess','verify','subtract','confirmationMessage3','./services/TicketServices/UpdateTicketService','length','queueMonitor','__importDefault','__esModule','disableBot','messageQueue','name','confirmation','value','profile','ERRO','env','@s.whatsapp.net','set','queueId','captureException','./models/Queue','\x20segundos\x20finalizado:\x20','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','parseToMilliseconds','includes','whatsapps','1580vKDuJm','start','*/1\x20*\x20*\x20*\x20*','process','default','./database','push','contacts','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','format','company','updatedAt','defineProperty','confirmationMessage2','SendMessage'];a337_0xac02=function(){return _0x6ed42e;};return a337_0xac02();}function getCampaignValidConfirmationMessages(_0x447efc){const _0x4d3ac7=a337_0x5a2b44,_0x522477=[];return!(0x0,lodash_1['isEmpty'])(_0x447efc[_0x4d3ac7(0x164)])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0x164)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0x164)]),!(0x0,lodash_1[_0x4d3ac7(0x191)])(_0x447efc['confirmationMessage2'])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0xe7)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0xe7)]),!(0x0,lodash_1['isEmpty'])(_0x447efc['confirmationMessage3'])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc['confirmationMessage3'])&&_0x522477['push'](_0x447efc[_0x4d3ac7(0x1ac)]),!(0x0,lodash_1[_0x4d3ac7(0x191)])(_0x447efc[_0x4d3ac7(0xed)])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0xed)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0xed)]),!(0x0,lodash_1['isEmpty'])(_0x447efc[_0x4d3ac7(0x186)])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0x186)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0x186)]),_0x522477;}function getProcessedMessage(_0x1f6c2d,_0x154598,_0xeb1546){const _0x1c7ffb=a337_0x5a2b44;let _0xcdf3fd=_0x1f6c2d;return _0xcdf3fd['includes']('{nome}')&&(_0xcdf3fd=_0xcdf3fd[_0x1c7ffb(0x19d)](/{nome}/g,_0xeb1546[_0x1c7ffb(0x1b4)])),_0xcdf3fd['includes'](_0x1c7ffb(0x168))&&(_0xcdf3fd=_0xcdf3fd['replace'](/{email}/g,_0xeb1546['email'])),_0xcdf3fd[_0x1c7ffb(0x1c2)](_0x1c7ffb(0x1a2))&&(_0xcdf3fd=_0xcdf3fd[_0x1c7ffb(0x19d)](/{numero}/g,_0xeb1546[_0x1c7ffb(0x13d)])),_0x154598[_0x1c7ffb(0x139)](_0x4005b5=>{const _0x3c5b53=_0x1c7ffb;if(_0xcdf3fd[_0x3c5b53(0x1c2)]('{'+_0x4005b5[_0x3c5b53(0x108)]+'}')){const _0x19ca61=new RegExp('{'+_0x4005b5[_0x3c5b53(0x108)]+'}','g');_0xcdf3fd=_0xcdf3fd[_0x3c5b53(0x19d)](_0x19ca61,_0x4005b5['value']);}}),_0xcdf3fd;}function randomValue(_0xd5bde1,_0x3995ce){const _0x41faa8=a337_0x5a2b44;return Math['floor'](Math[_0x41faa8(0x16b)]()*_0x3995ce)+_0xd5bde1;}exports[a337_0x5a2b44(0xee)]=randomValue;async function verifyAndFinalizeCampaign(_0x11650){const _0x54590d=a337_0x5a2b44,{contacts:_0x4de6a7}=_0x11650[_0x54590d(0x15d)],_0x172782=_0x4de6a7[_0x54590d(0x1ae)],_0x37e046=await CampaignShipping_1[_0x54590d(0xde)][_0x54590d(0x127)]({'where':{'campaignId':_0x11650['id'],'deliveredAt':{[sequelize_1['Op'][_0x54590d(0x15c)]]:null}}});_0x172782===_0x37e046&&await _0x11650[_0x54590d(0x120)]({'status':_0x54590d(0x144),'completedAt':(0x0,moment_1[_0x54590d(0xde)])()});const _0x57d42a=(0x0,socket_1['getIO'])();_0x57d42a[_0x54590d(0x156)](_0x54590d(0x185)+_0x11650[_0x54590d(0x13e)]+'-campaign',{'action':_0x54590d(0x120),'record':_0x11650});}async function handleProcessCampaign(_0x4ceec5){const _0x502e4c=a337_0x5a2b44;try{const {id:_0x134ded}=_0x4ceec5[_0x502e4c(0x106)],_0x1a6118=await getCampaign(_0x134ded),_0x42ef52=await getSettings(_0x1a6118);if(_0x1a6118){const {contacts:_0x4d043c}=_0x1a6118[_0x502e4c(0x15d)];if((0x0,lodash_1['isArray'])(_0x4d043c)){const _0x2808bf=_0x4d043c[_0x502e4c(0x171)](_0x5893f2=>({'contactId':_0x5893f2['id'],'campaignId':_0x1a6118['id'],'variables':_0x42ef52[_0x502e4c(0x165)]})),_0x452bbe=parseToMilliseconds(_0x42ef52[_0x502e4c(0x10c)]),_0x3b399f=parseToMilliseconds(_0x42ef52['greaterInterval']),_0x361a03=_0x42ef52[_0x502e4c(0x1a0)];let _0x1e5e09=_0x1a6118['scheduledAt'];const _0x2bc620=[];for(let _0x52d572=0x0;_0x52d572<_0x2808bf['length'];_0x52d572++){_0x1e5e09=(0x0,date_fns_1[_0x502e4c(0x128)])(_0x1e5e09,_0x52d572>_0x452bbe?_0x3b399f:_0x361a03);const {contactId:_0x399848,campaignId:_0x123fa1,variables:_0x50d055}=_0x2808bf[_0x52d572],_0xf23d43=calculateDelay(_0x52d572,_0x1e5e09,_0x452bbe,_0x3b399f,_0x361a03),_0x5554b7=exports['campaignQueue'][_0x502e4c(0x14b)](_0x502e4c(0x109),{'contactId':_0x399848,'campaignId':_0x123fa1,'variables':_0x50d055,'delay':_0xf23d43},{'removeOnComplete':!![]});_0x2bc620[_0x502e4c(0xe0)](_0x5554b7),logger_1[_0x502e4c(0xeb)][_0x502e4c(0x172)](_0x502e4c(0x178)+_0x1a6118['id']+_0x502e4c(0x187)+_0x4d043c[_0x52d572][_0x502e4c(0x1b4)]+_0x502e4c(0x18b)+_0xf23d43);}await Promise[_0x502e4c(0x17f)](_0x2bc620),await _0x1a6118[_0x502e4c(0x120)]({'status':_0x502e4c(0x169)});}}}catch(_0x3c58b8){Sentry[_0x502e4c(0x1bd)](_0x3c58b8);}}function calculateDelay(_0x3d5bfc,_0xbd4009,_0x492301,_0x1f9a7e,_0x4cb212){const _0x321e77=(0x0,date_fns_1['differenceInSeconds'])(_0xbd4009,new Date());return _0x3d5bfc>_0x492301?_0x321e77*0x3e8+_0x1f9a7e:_0x321e77*0x3e8+_0x4cb212;}async function handlePrepareContact(_0x353896){const _0xc87d9=a337_0x5a2b44;try{const {contactId:_0x1eca8a,campaignId:_0x30a96b,delay:_0x548740,variables:_0x16cef4}=_0x353896[_0xc87d9(0x106)],_0x1d74d5=await getCampaign(_0x30a96b),_0x2277d7=await getContact(_0x1eca8a),_0x447af9={};_0x447af9['number']=_0x2277d7['number'],_0x447af9[_0xc87d9(0xfd)]=_0x1eca8a,_0x447af9[_0xc87d9(0x166)]=_0x30a96b;const _0xd76ee5=getCampaignValidMessages(_0x1d74d5);if(_0xd76ee5['length']){const _0x116f60=randomValue(0x0,_0xd76ee5['length']),_0x289be2=getProcessedMessage(_0xd76ee5[_0x116f60],_0x16cef4,_0x2277d7);_0x447af9[_0xc87d9(0x15f)]='‌\x20'+_0x289be2;}if(_0x1d74d5[_0xc87d9(0x1b5)]){const _0x2e73e6=getCampaignValidConfirmationMessages(_0x1d74d5);if(_0x2e73e6[_0xc87d9(0x1ae)]){const _0xf3f09f=randomValue(0x0,_0x2e73e6[_0xc87d9(0x1ae)]),_0x1de725=getProcessedMessage(_0x2e73e6[_0xf3f09f],_0x16cef4,_0x2277d7);_0x447af9[_0xc87d9(0x138)]='‌\x20'+_0x1de725;}}const [_0x49d2b8,_0x115b83]=await CampaignShipping_1['default'][_0xc87d9(0x1a3)]({'where':{'campaignId':_0x447af9[_0xc87d9(0x166)],'contactId':_0x447af9['contactId']},'defaults':_0x447af9});!_0x115b83&&_0x49d2b8['deliveredAt']===null&&_0x49d2b8['confirmationRequestedAt']===null&&(_0x49d2b8[_0xc87d9(0x1bb)](_0x447af9),await _0x49d2b8['save']());if(_0x49d2b8[_0xc87d9(0x17a)]===null&&_0x49d2b8[_0xc87d9(0x104)]===null){const _0x58b735=await exports[_0xc87d9(0x121)][_0xc87d9(0x14b)](_0xc87d9(0x18a),{'campaignId':_0x1d74d5['id'],'campaignShippingId':_0x49d2b8['id'],'contactListItemId':_0x1eca8a},{'delay':_0x548740});await _0x49d2b8[_0xc87d9(0x120)]({'jobId':_0x58b735['id']});}await verifyAndFinalizeCampaign(_0x1d74d5);}catch(_0x4feafd){Sentry[_0xc87d9(0x1bd)](_0x4feafd),logger_1['logger'][_0xc87d9(0x167)](_0xc87d9(0x1a6)+_0x4feafd['message']);}}async function handleDispatchCampaign(_0x314e74){const _0x341767=a337_0x5a2b44;try{const {data:_0x204d78}=_0x314e74,{campaignShippingId:_0x555396,campaignId:_0x435948}=_0x204d78,_0x3b43a2=await getCampaign(_0x435948),_0x287e65=await(0x0,GetWhatsappWbot_1[_0x341767(0xde)])(_0x3b43a2['whatsapp']);if(!_0x287e65){logger_1[_0x341767(0xeb)]['error'](_0x341767(0x16d));return;}if(!_0x3b43a2['whatsapp']){logger_1[_0x341767(0xeb)][_0x341767(0x167)](_0x341767(0x12c));return;}if(!_0x287e65?.['user']?.['id']){logger_1[_0x341767(0xeb)][_0x341767(0x167)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found');return;}logger_1['logger'][_0x341767(0x172)](_0x341767(0x1c0)+_0x435948+_0x341767(0x17d)+_0x555396);const _0x3aab4d=await CampaignShipping_1['default']['findByPk'](_0x555396,{'include':[{'model':ContactListItem_1[_0x341767(0xde)],'as':_0x341767(0x197)}]}),_0x57e395=_0x3aab4d['number']+_0x341767(0x1ba);let _0x58d568=_0x3aab4d[_0x341767(0x15f)];_0x3b43a2[_0x341767(0x1b5)]&&_0x3aab4d[_0x341767(0x1b5)]===null&&(_0x58d568=_0x3aab4d[_0x341767(0x138)]);if(_0x3b43a2[_0x341767(0x175)]==='enabled'){const _0x14dce1=await Contact_1[_0x341767(0xde)][_0x341767(0x112)]({'where':{'number':_0x3aab4d['number']}}),_0xd02158=await Whatsapp_1['default'][_0x341767(0x140)](_0x3b43a2[_0x341767(0xe9)]),_0x202859=await CompaniesSettings_1[_0x341767(0xde)][_0x341767(0x112)]({'where':{'companyId':_0x3b43a2[_0x341767(0x13e)]}}),{ticket:_0x45dd07}=await(0x0,FindOrCreateTicketService_1[_0x341767(0xde)])(_0x14dce1,_0xd02158,0x1,_0x3b43a2[_0x341767(0x13e)],_0x3b43a2?.[_0x341767(0x1bc)],_0x3b43a2?.[_0x341767(0x160)],null,'whatsapp',![],![],_0x202859);if(_0x3b43a2['mediaPath']===null){const _0x588e27=await(0x0,SendWhatsAppMessage_1[_0x341767(0xde)])({'body':_0x58d568,'ticket':_0x45dd07});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x588e27,_0x45dd07,_0x45dd07[_0x341767(0x197)]);}else{const _0x25b2ad=path_1[_0x341767(0xde)][_0x341767(0x129)](__dirname,'..',_0x341767(0x194)),_0x478c81=path_1[_0x341767(0xde)][_0x341767(0x133)](_0x25b2ad,'company'+_0x3b43a2[_0x341767(0x13e)],_0x3b43a2['mediaPath']),_0x3df4e4=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x3b43a2[_0x341767(0x193)],_0x478c81,_0x3b43a2[_0x341767(0x13e)]['toString'](),_0x58d568);if(Object['keys'](_0x3df4e4)[_0x341767(0x1ae)]){const _0x2e864c=await _0x287e65[_0x341767(0x100)](_0x57e395,{..._0x3df4e4});await(0x0,wbotMessageListener_1['verifyMediaMessage'])(_0x2e864c,_0x45dd07,_0x45dd07[_0x341767(0x197)]);}}_0x3b43a2?.[_0x341767(0x101)]===_0x341767(0x1a5)&&await _0x45dd07[_0x341767(0x120)]({'status':_0x341767(0x1a5)}),await _0x3aab4d[_0x341767(0x120)]({'deliveredAt':(0x0,moment_1['default'])()});}else{if(_0x3b43a2['mediaPath']){const _0x99c1bd=path_1[_0x341767(0xde)][_0x341767(0x129)](__dirname,'..','public'),_0x578401=path_1[_0x341767(0xde)][_0x341767(0x133)](_0x99c1bd,_0x341767(0xe4)+_0x3b43a2['companyId'],_0x3b43a2[_0x341767(0x102)]),_0x17c124=await(0x0,SendWhatsAppMedia_1[_0x341767(0x125)])(_0x3b43a2[_0x341767(0x193)],_0x578401,_0x3b43a2[_0x341767(0x13e)][_0x341767(0xec)](),_0x58d568);Object[_0x341767(0xf0)](_0x17c124)[_0x341767(0x1ae)]&&await _0x287e65[_0x341767(0x100)](_0x57e395,{..._0x17c124});}else _0x3b43a2['confirmation']&&_0x3aab4d[_0x341767(0x1b5)]===null?(await _0x287e65[_0x341767(0x100)](_0x57e395,{'text':_0x58d568}),await _0x3aab4d['update']({'confirmationRequestedAt':(0x0,moment_1[_0x341767(0xde)])()})):await _0x287e65['sendMessage'](_0x57e395,{'text':_0x58d568});await _0x3aab4d[_0x341767(0x120)]({'deliveredAt':(0x0,moment_1[_0x341767(0xde)])()});}await verifyAndFinalizeCampaign(_0x3b43a2);const _0x448539=(0x0,socket_1['getIO'])();_0x448539[_0x341767(0x156)](_0x341767(0x185)+_0x3b43a2[_0x341767(0x13e)]+_0x341767(0x151),{'action':'update','record':_0x3b43a2}),logger_1['logger'][_0x341767(0x172)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x435948+_0x341767(0x187)+_0x3aab4d[_0x341767(0x197)]['name']);}catch(_0x275de0){Sentry['captureException'](_0x275de0),logger_1[_0x341767(0xeb)][_0x341767(0x167)](_0x275de0[_0x341767(0x15f)]),console[_0x341767(0x132)](_0x275de0[_0x341767(0x189)]);}}async function handleLoginStatus(_0x45bd3e){const _0xe1e9cd=a337_0x5a2b44,_0x4b9e21=await database_1[_0xe1e9cd(0xde)][_0xe1e9cd(0x19b)](_0xe1e9cd(0xe2),{'type':sequelize_1[_0xe1e9cd(0x1a7)][_0xe1e9cd(0x1a4)]}),_0x5cee7c=_0x4b9e21['map'](_0x13171d=>_0x13171d['id']),_0x11d48=_0x5cee7c[_0xe1e9cd(0x133)](',\x20');try{const _0x461e0d='UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20('+_0x11d48+');',_0x4c5e96=await database_1[_0xe1e9cd(0xde)][_0xe1e9cd(0x19b)](_0x461e0d,{'type':sequelize_1[_0xe1e9cd(0x1a7)][_0xe1e9cd(0xef)]});}catch(_0x1ead3f){Sentry['captureException'](_0x1ead3f);}}async function handleVerifyQueue(_0xf29d4){const _0x48beeb=a337_0x5a2b44;try{const _0x4319b2=await Company_1[_0x48beeb(0xde)]['findAll']({'attributes':['id',_0x48beeb(0x1b4)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x48beeb(0xde)],'attributes':['id',_0x48beeb(0x1b4),_0x48beeb(0x119),'timeSendQueue',_0x48beeb(0x198)]}]});_0x4319b2[_0x48beeb(0x171)](async _0x1a1e3a=>{const _0x8a31ae=_0x48beeb;_0x1a1e3a[_0x8a31ae(0x1c3)]['map'](async _0x284586=>{const _0x1cb2e3=_0x8a31ae;if(_0x284586['status']===_0x1cb2e3(0x10f)){var _0xc69fd5=_0x1a1e3a['id'];const _0x4f7dd5=_0x284586[_0x1cb2e3(0x157)]?_0x284586[_0x1cb2e3(0x157)]:0x0,_0xc46191=_0x284586[_0x1cb2e3(0x198)],_0x586e73=_0x4f7dd5,_0x3c8ff9=_0xc46191,_0x252b62=_0x586e73;if(_0x4f7dd5>0x0){if(!isNaN(_0x3c8ff9)&&Number[_0x1cb2e3(0xf4)](_0x3c8ff9)&&!isNaN(_0x252b62)&&Number[_0x1cb2e3(0xf4)](_0x252b62)){const _0x158d9d=(0x0,moment_1['default'])()['subtract'](_0x252b62,_0x1cb2e3(0x142))[_0x1cb2e3(0x11b)]()[_0x1cb2e3(0xe3)](),{count:_0x3d67ae,rows:_0x1d70c4}=await Ticket_1[_0x1cb2e3(0xde)][_0x1cb2e3(0x163)]({'attributes':['id'],'where':{'status':'pending','queueId':null,'companyId':_0xc69fd5,'whatsappId':_0x284586['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x158d9d}},'include':[{'model':Contact_1[_0x1cb2e3(0xde)],'as':_0x1cb2e3(0x197),'attributes':['id','name',_0x1cb2e3(0x13d),_0x1cb2e3(0x16e),'profilePicUrl','acceptAudioMessage',_0x1cb2e3(0xf7),_0x1cb2e3(0x1b2)],'include':[_0x1cb2e3(0x13a),'contactTags',_0x1cb2e3(0x1a1)]},{'model':Queue_2[_0x1cb2e3(0xde)],'as':'queue','attributes':['id','name',_0x1cb2e3(0x13b)]},{'model':Whatsapp_1[_0x1cb2e3(0xde)],'as':_0x1cb2e3(0x14a),'attributes':['id',_0x1cb2e3(0x1b4),_0x1cb2e3(0x17b),_0x1cb2e3(0x105)]}]});_0x3d67ae>0x0&&_0x1d70c4['map'](async _0x525312=>{const _0x12bc63=_0x1cb2e3;await _0x525312[_0x12bc63(0x120)]({'queueId':_0x3c8ff9}),await _0x525312[_0x12bc63(0x110)]();const _0xcd4548=(0x0,socket_1['getIO'])();_0xcd4548['to'](_0x525312[_0x12bc63(0x119)])['to'](_0x12bc63(0x10e))['to'](_0x525312['id'][_0x12bc63(0xec)]())[_0x12bc63(0x156)](_0x12bc63(0x185)+_0xc69fd5+_0x12bc63(0x162),{'action':'update','ticket':_0x525312,'ticketId':_0x525312['id']}),logger_1[_0x12bc63(0xeb)]['info'](_0x12bc63(0x177)+_0x525312['id']+_0x12bc63(0x14e)+_0xc69fd5);});}else logger_1[_0x1cb2e3(0xeb)][_0x1cb2e3(0x172)](_0x1cb2e3(0x12a)+_0xc69fd5);}}});});}catch(_0x70b3cd){Sentry['captureException'](_0x70b3cd),logger_1[_0x48beeb(0xeb)][_0x48beeb(0x167)](_0x48beeb(0x111),_0x70b3cd[_0x48beeb(0x15f)]);throw _0x70b3cd;}};async function handleRandomUser(){const _0x340f5a=a337_0x5a2b44,_0x8c2a8=new CronJob(_0x340f5a(0x153),async()=>{const _0x3584f9=_0x340f5a;try{const {count:_0x1499cc,rows:_0x1774dd}=await Ticket_1[_0x3584f9(0xde)][_0x3584f9(0x163)]({'where':{'status':_0x3584f9(0xfe),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0x3584f9(0xde)],'as':_0x3584f9(0x196)}]}),_0x514464=_0x5dfbf1=>{const _0x2a4cfb=_0x3584f9,_0x2c1b54=Math[_0x2a4cfb(0xf1)](Math[_0x2a4cfb(0x16b)]()*_0x5dfbf1[_0x2a4cfb(0x1ae)]);return _0x5dfbf1[_0x2c1b54];},_0x45c69e=async _0x3d259b=>{const _0x444ae5=_0x3584f9;try{const _0x52d424=await User_1[_0x444ae5(0xde)][_0x444ae5(0x112)]({'where':{'id':_0x3d259b}});return _0x52d424[_0x444ae5(0x1b7)]===_0x444ae5(0xf5)?_0x52d424[_0x444ae5(0x11c)]===!![]?_0x52d424['id']:0x0:0x0;}catch(_0x53fc6f){Sentry[_0x444ae5(0x1bd)](_0x53fc6f),logger_1['logger']['error'](_0x444ae5(0x16c),_0x53fc6f[_0x444ae5(0x15f)]);throw _0x53fc6f;}};if(_0x1499cc>0x0)for(const _0x43d812 of _0x1774dd){const {queue:_0x4bec3a,queueId:_0x1adf1e,userId:_0xa12ed9}=_0x43d812,_0x263721=_0x4bec3a[_0x3584f9(0x10b)],_0x504e57=await UserQueue_1[_0x3584f9(0xde)][_0x3584f9(0x155)]({'where':{'queueId':_0x1adf1e}}),_0x3c767e=await(0x0,ShowContactService_1[_0x3584f9(0xde)])(_0x43d812[_0x3584f9(0xfd)],_0x43d812['companyId']),_0x4554d4=_0x504e57[_0x3584f9(0x171)](_0x5655ff=>_0x5655ff[_0x3584f9(0x160)]),_0x1e3aef=(0x0,moment_1[_0x3584f9(0xde)])()[_0x3584f9(0x1ab)](_0x263721,_0x3584f9(0x142))[_0x3584f9(0x11b)]()[_0x3584f9(0x17c)](),_0x57c780=new Date(_0x43d812['updatedAt']);let _0x44bb82=await CompaniesSettings_1[_0x3584f9(0xde)][_0x3584f9(0x112)]({'where':{'companyId':_0x43d812['companyId']}});const _0x52ab2d=_0x44bb82[_0x3584f9(0xf9)]===_0x3584f9(0x14c)||![];if(!_0xa12ed9){const _0x4d213c=_0x514464(_0x4554d4);if(await _0x45c69e(_0x4d213c)>0x0){if(_0x52ab2d){const _0x4ec648=await(0x0,ShowTicketService_1['default'])(_0x43d812['id'],_0x43d812['companyId']);await(0x0,SendWhatsAppMessage_1[_0x3584f9(0xde)])({'body':_0x3584f9(0x11f),'ticket':_0x4ec648});}await(0x0,UpdateTicketService_1[_0x3584f9(0xde)])({'ticketData':{'status':_0x3584f9(0xfe),'userId':_0x4d213c},'ticketId':_0x43d812['id'],'companyId':_0x43d812[_0x3584f9(0x13e)]}),logger_1['logger']['info'](_0x3584f9(0x18e)+_0x43d812['id']+_0x3584f9(0x18d)+_0x4d213c+'\x20-\x20'+_0x43d812[_0x3584f9(0xe5)]);}else{}}else{if(_0x4554d4[_0x3584f9(0x1c2)](_0xa12ed9)){if(_0x1e3aef>_0x57c780){const _0x51378a=_0x4554d4[_0x3584f9(0xf6)](_0x5ee003=>_0x5ee003!==_0xa12ed9);if(_0x51378a[_0x3584f9(0x1ae)]>0x0){const _0x52b14e=_0x514464(_0x51378a);if(await _0x45c69e(_0x52b14e)>0x0){if(_0x52ab2d){const _0x334c4f=await(0x0,ShowTicketService_1['default'])(_0x43d812['id'],_0x43d812[_0x3584f9(0x13e)]);await(0x0,SendWhatsAppMessage_1['default'])({'body':'*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','ticket':_0x334c4f});};await(0x0,UpdateTicketService_1[_0x3584f9(0xde)])({'ticketData':{'status':'pending','userId':_0x52b14e},'ticketId':_0x43d812['id'],'companyId':_0x43d812['companyId']}),await _0x43d812[_0x3584f9(0x110)]();}else{}}else{}}else{}}else{}}}}catch(_0x23d987){Sentry[_0x3584f9(0x1bd)](_0x23d987),logger_1['logger'][_0x3584f9(0x167)]('SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error',_0x23d987[_0x3584f9(0x15f)]);throw _0x23d987;}});_0x8c2a8[_0x340f5a(0x1c5)]();}function a337_0x3c02(_0x433d91,_0x3789c0){const _0xac0293=a337_0xac02();return a337_0x3c02=function(_0x3c024e,_0x1ef699){_0x3c024e=_0x3c024e-0xdc;let _0x25a948=_0xac0293[_0x3c024e];return _0x25a948;},a337_0x3c02(_0x433d91,_0x3789c0);}async function handleCloseTicketsAutomatic(){const _0x177d81=a337_0x5a2b44,_0x267cb9=new CronJob(_0x177d81(0xdc),async()=>{const _0x254b79=_0x177d81,_0x5681af=await Company_1[_0x254b79(0xde)]['findAll']();_0x5681af[_0x254b79(0x171)](async _0x3187e=>{const _0x5c4def=_0x254b79;try{const _0x3c71bb=_0x3187e['id'];await(0x0,wbotClosedTickets_1['ClosedAllOpenTickets'])(_0x3c71bb);}catch(_0x12182e){Sentry[_0x5c4def(0x1bd)](_0x12182e),logger_1[_0x5c4def(0xeb)][_0x5c4def(0x167)]('ClosedAllOpenTickets\x20->\x20Verify:\x20error',_0x12182e[_0x5c4def(0x15f)]);throw _0x12182e;}});});_0x267cb9[_0x177d81(0x1c5)]();}async function handleWhatsapp(){const _0x541a42=a337_0x5a2b44,_0x3c73ea=new CronJob('*\x2015\x203\x20*\x20*\x20*',async()=>{const _0x47477=a337_0x3c02;(0x0,GetWhatsapp_1[_0x47477(0x15e)])(),_0x3c73ea['stop']();},null,![],_0x541a42(0xf3));_0x3c73ea[_0x541a42(0x1c5)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x41bc78=a337_0x5a2b44;logger_1[_0x41bc78(0xeb)][_0x41bc78(0x172)](_0x41bc78(0x199)),exports[_0x41bc78(0x1b3)][_0x41bc78(0xdd)]('SendMessage',handleSendMessage),exports[_0x41bc78(0x141)][_0x41bc78(0xdd)]('Verify',handleVerifySchedules),exports[_0x41bc78(0x150)][_0x41bc78(0xdd)](_0x41bc78(0xe8),handleSendScheduledMessage),exports[_0x41bc78(0x121)][_0x41bc78(0xdd)](_0x41bc78(0x181),handleVerifyCampaigns),exports['campaignQueue'][_0x41bc78(0xdd)](_0x41bc78(0x137),handleProcessCampaign),exports['campaignQueue']['process'](_0x41bc78(0x109),handlePrepareContact),exports['campaignQueue']['process']('DispatchCampaign',handleDispatchCampaign),exports[_0x41bc78(0x15b)][_0x41bc78(0xdd)](_0x41bc78(0x10d),handleLoginStatus),exports[_0x41bc78(0x1af)][_0x41bc78(0xdd)](_0x41bc78(0x158),handleVerifyQueue),exports[_0x41bc78(0x141)]['add']('Verify',{},{'repeat':{'cron':_0x41bc78(0x153),'key':_0x41bc78(0x1aa)},'removeOnComplete':!![]}),exports[_0x41bc78(0x121)][_0x41bc78(0x14b)](_0x41bc78(0x181),{},{'repeat':{'cron':_0x41bc78(0x13f),'key':'verify-campaing'},'removeOnComplete':!![]}),exports[_0x41bc78(0x15b)][_0x41bc78(0x14b)]('VerifyLoginStatus',{},{'repeat':{'cron':_0x41bc78(0x143),'key':_0x41bc78(0x11d)},'removeOnComplete':!![]}),exports[_0x41bc78(0x1af)][_0x41bc78(0x14b)](_0x41bc78(0x158),{},{'repeat':{'cron':_0x41bc78(0x13f),'key':_0x41bc78(0x147)},'removeOnComplete':!![]});}exports[a337_0x5a2b44(0x1a9)]=startQueueProcess;
>>>>>>> ab722bfbcf394d74dd0b99a984c0dcf6ffbcff7f
