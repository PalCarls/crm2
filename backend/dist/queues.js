'use strict';const a337_0x5a2b44=a337_0x3c02;(function(_0x429108,_0x3c217a){const _0xe67443=a337_0x3c02,_0x5f4662=_0x429108();while(!![]){try{const _0x45cecc=-parseInt(_0xe67443(0x145))/0x1+parseInt(_0xe67443(0x130))/0x2*(parseInt(_0xe67443(0x146))/0x3)+parseInt(_0xe67443(0x174))/0x4*(parseInt(_0xe67443(0x1c4))/0x5)+-parseInt(_0xe67443(0xfc))/0x6+parseInt(_0xe67443(0x192))/0x7+-parseInt(_0xe67443(0x16a))/0x8*(-parseInt(_0xe67443(0xff))/0x9)+-parseInt(_0xe67443(0x107))/0xa;if(_0x45cecc===_0x3c217a)break;else _0x5f4662['push'](_0x5f4662['shift']());}catch(_0x47a524){_0x5f4662['push'](_0x5f4662['shift']());}}}(a337_0xac02,0x21db4));var __createBinding=this&&this['__createBinding']||(Object[a337_0x5a2b44(0x113)]?function(_0x58a965,_0x2efc18,_0x2d2ef5,_0x262601){const _0x2e4698=a337_0x5a2b44;if(_0x262601===undefined)_0x262601=_0x2d2ef5;var _0x43f9bd=Object[_0x2e4698(0xfa)](_0x2efc18,_0x2d2ef5);(!_0x43f9bd||(_0x2e4698(0x184)in _0x43f9bd?!_0x2efc18[_0x2e4698(0x1b1)]:_0x43f9bd[_0x2e4698(0x122)]||_0x43f9bd['configurable']))&&(_0x43f9bd={'enumerable':!![],'get':function(){return _0x2efc18[_0x2d2ef5];}}),Object[_0x2e4698(0xe6)](_0x58a965,_0x262601,_0x43f9bd);}:function(_0x40ab8d,_0x260ffe,_0x678a0e,_0x41f204){if(_0x41f204===undefined)_0x41f204=_0x678a0e;_0x40ab8d[_0x41f204]=_0x260ffe[_0x678a0e];}),__setModuleDefault=this&&this[a337_0x5a2b44(0x18f)]||(Object['create']?function(_0x45ccfb,_0x1cf72c){const _0x43d87e=a337_0x5a2b44;Object['defineProperty'](_0x45ccfb,_0x43d87e(0xde),{'enumerable':!![],'value':_0x1cf72c});}:function(_0x530262,_0x1a601e){const _0x3fcf1c=a337_0x5a2b44;_0x530262[_0x3fcf1c(0xde)]=_0x1a601e;}),__importStar=this&&this[a337_0x5a2b44(0x19a)]||function(_0x5b60df){const _0x4ade34=a337_0x5a2b44;if(_0x5b60df&&_0x5b60df['__esModule'])return _0x5b60df;var _0x34c08f={};if(_0x5b60df!=null){for(var _0xd52c05 in _0x5b60df)if(_0xd52c05!==_0x4ade34(0xde)&&Object[_0x4ade34(0x103)]['hasOwnProperty'][_0x4ade34(0x15a)](_0x5b60df,_0xd52c05))__createBinding(_0x34c08f,_0x5b60df,_0xd52c05);}return __setModuleDefault(_0x34c08f,_0x5b60df),_0x34c08f;},__importDefault=this&&this[a337_0x5a2b44(0x1b0)]||function(_0x229b33){return _0x229b33&&_0x229b33['__esModule']?_0x229b33:{'default':_0x229b33};};Object['defineProperty'](exports,a337_0x5a2b44(0x1b1),{'value':!![]}),exports[a337_0x5a2b44(0x1a9)]=exports['randomValue']=exports[a337_0x5a2b44(0x1c1)]=exports[a337_0x5a2b44(0x1b3)]=exports[a337_0x5a2b44(0x1af)]=exports['campaignQueue']=exports[a337_0x5a2b44(0x150)]=exports[a337_0x5a2b44(0x141)]=exports[a337_0x5a2b44(0x15b)]=void 0x0;const Sentry=__importStar(require('@sentry/node')),bull_1=__importDefault(require('bull')),SendMessage_1=require('./helpers/SendMessage'),Whatsapp_1=__importDefault(require(a337_0x5a2b44(0x12e))),logger_1=require(a337_0x5a2b44(0x16f)),moment_1=__importDefault(require(a337_0x5a2b44(0x190))),Schedule_1=__importDefault(require(a337_0x5a2b44(0x179))),sequelize_1=require('sequelize'),GetDefaultWhatsApp_1=__importDefault(require(a337_0x5a2b44(0x19c))),Campaign_1=__importDefault(require(a337_0x5a2b44(0x161))),Queue_1=__importDefault(require(a337_0x5a2b44(0x1be))),ContactList_1=__importDefault(require(a337_0x5a2b44(0x11a))),ContactListItem_1=__importDefault(require(a337_0x5a2b44(0x13c))),lodash_1=require('lodash'),CampaignSetting_1=__importDefault(require('./models/CampaignSetting')),CampaignShipping_1=__importDefault(require('./models/CampaignShipping')),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require(a337_0x5a2b44(0xdf))),SendWhatsAppMedia_1=require('./services/WbotServices/SendWhatsAppMedia'),socket_1=require('./libs/socket'),path_1=__importDefault(require(a337_0x5a2b44(0x12f))),User_1=__importDefault(require('./models/User')),Company_1=__importDefault(require('./models/Company')),Contact_1=__importDefault(require(a337_0x5a2b44(0x123))),Queue_2=__importDefault(require(a337_0x5a2b44(0x1be))),wbotClosedTickets_1=require(a337_0x5a2b44(0x11e)),Ticket_1=__importDefault(require(a337_0x5a2b44(0x183))),ShowContactService_1=__importDefault(require(a337_0x5a2b44(0x188))),UserQueue_1=__importDefault(require(a337_0x5a2b44(0x19f))),ShowTicketService_1=__importDefault(require(a337_0x5a2b44(0x114))),SendWhatsAppMessage_1=__importDefault(require('./services/WbotServices/SendWhatsAppMessage')),UpdateTicketService_1=__importDefault(require(a337_0x5a2b44(0x1ad))),date_fns_1=require('date-fns'),GetWhatsapp_1=require(a337_0x5a2b44(0x135)),nodemailer=require('nodemailer'),CronJob=require(a337_0x5a2b44(0x10a))['CronJob'],CompaniesSettings_1=__importDefault(require(a337_0x5a2b44(0xfb))),wbotMessageListener_1=require(a337_0x5a2b44(0x152)),FindOrCreateTicketService_1=__importDefault(require('./services/TicketServices/FindOrCreateTicketService')),connection=process[a337_0x5a2b44(0x1b9)][a337_0x5a2b44(0x131)]||'',limiterMax=process[a337_0x5a2b44(0x1b9)]['REDIS_OPT_LIMITER_MAX']||0x1,limiterDuration=process[a337_0x5a2b44(0x1b9)][a337_0x5a2b44(0x170)]||0xbb8;exports[a337_0x5a2b44(0x15b)]=new bull_1[(a337_0x5a2b44(0xde))](a337_0x5a2b44(0x1a8),connection),exports[a337_0x5a2b44(0x141)]=new bull_1[(a337_0x5a2b44(0xde))](a337_0x5a2b44(0xf8),connection),exports[a337_0x5a2b44(0x150)]=new bull_1[(a337_0x5a2b44(0xde))]('SendSacheduledMessages',connection),exports['campaignQueue']=new bull_1[(a337_0x5a2b44(0xde))]('CampaignQueue',connection),exports[a337_0x5a2b44(0x1af)]=new bull_1[(a337_0x5a2b44(0xde))]('QueueMonitor',connection),exports[a337_0x5a2b44(0x1b3)]=new bull_1[(a337_0x5a2b44(0xde))]('MessageQueue',connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x55571e){const _0xd45536=a337_0x5a2b44;try{const {data:_0x4fa2e3}=_0x55571e,_0xe75b5c=await Whatsapp_1['default']['findByPk'](_0x4fa2e3[_0xd45536(0xe9)]);if(_0xe75b5c===null)throw Error('Whatsapp\x20não\x20identificado');const _0x5abade=_0x4fa2e3['data'];await(0x0,SendMessage_1['SendMessage'])(_0xe75b5c,_0x5abade);}catch(_0xd5df7b){Sentry[_0xd45536(0x1bd)](_0xd5df7b),logger_1['logger']['error']('MessageQueue\x20->\x20SendMessage:\x20error',_0xd5df7b[_0xd45536(0x15f)]);throw _0xd5df7b;}}async function handleVerifySchedules(_0x27ba1f){const _0x42b3c2=a337_0x5a2b44;try{const {count:_0x329159,rows:_0x2c7207}=await Schedule_1[_0x42b3c2(0xde)][_0x42b3c2(0x163)]({'where':{'status':_0x42b3c2(0x12d),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x42b3c2(0x180)]]:(0x0,moment_1[_0x42b3c2(0xde)])()[_0x42b3c2(0xe3)](_0x42b3c2(0x14f)),[sequelize_1['Op']['lte']]:(0x0,moment_1[_0x42b3c2(0xde)])()[_0x42b3c2(0x14b)]('30','seconds')[_0x42b3c2(0xe3)](_0x42b3c2(0x14f))}},'include':[{'model':Contact_1[_0x42b3c2(0xde)],'as':'contact'}]});_0x329159>0x0&&_0x2c7207[_0x42b3c2(0x171)](async _0x5e3a8e=>{const _0x574160=_0x42b3c2;await _0x5e3a8e['update']({'status':'AGENDADA'}),exports['sendScheduledMessages'][_0x574160(0x14b)]('SendMessage',{'schedule':_0x5e3a8e},{'delay':0x9c40}),logger_1[_0x574160(0xeb)]['info'](_0x574160(0x18c)+_0x5e3a8e[_0x574160(0x197)][_0x574160(0x1b4)]);});}catch(_0x33f323){Sentry[_0x42b3c2(0x1bd)](_0x33f323),logger_1['logger'][_0x42b3c2(0x167)](_0x42b3c2(0x12b),_0x33f323[_0x42b3c2(0x15f)]);throw _0x33f323;}}async function handleSendScheduledMessage(_0x487ebe){const _0x3b2b56=a337_0x5a2b44,{data:{schedule:_0xc57b4c}}=_0x487ebe;let _0x433dbd=null;try{_0x433dbd=await Schedule_1[_0x3b2b56(0xde)]['findByPk'](_0xc57b4c['id']);}catch(_0x4d6062){Sentry[_0x3b2b56(0x1bd)](_0x4d6062),logger_1[_0x3b2b56(0xeb)][_0x3b2b56(0x172)](_0x3b2b56(0x136)+_0xc57b4c['id']);}try{const _0x236537=await(0x0,GetDefaultWhatsApp_1[_0x3b2b56(0xde)])(_0xc57b4c['companyId']);console[_0x3b2b56(0x132)](_0xc57b4c);const _0x3eb220=await CompaniesSettings_1['default']['findOne']({'where':{'companyId':_0xc57b4c['companyId']}}),{ticket:_0x254e6a}=await(0x0,FindOrCreateTicketService_1[_0x3b2b56(0xde)])(_0xc57b4c['contact'],_0x236537,0x1,_0xc57b4c[_0x3b2b56(0x13e)],0x0,0x0,null,_0x3b2b56(0x14a),![],![],_0x3eb220),_0x2761fb=await(0x0,SendMessage_1[_0x3b2b56(0xe8)])(_0x236537,{'number':_0xc57b4c['contact'][_0x3b2b56(0x13d)],'body':_0xc57b4c[_0x3b2b56(0x126)]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x2761fb,_0x254e6a,_0xc57b4c['contact']['number']),await _0x433dbd?.[_0x3b2b56(0x120)]({'sentAt':(0x0,moment_1[_0x3b2b56(0xde)])()[_0x3b2b56(0xe3)](_0x3b2b56(0x149)),'status':_0x3b2b56(0x176)}),logger_1['logger']['info']('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0xc57b4c[_0x3b2b56(0x197)]['name']),exports[_0x3b2b56(0x150)][_0x3b2b56(0x117)](0x3a98,'completed');}catch(_0x32333a){Sentry[_0x3b2b56(0x1bd)](_0x32333a),await _0x433dbd?.[_0x3b2b56(0x120)]({'status':_0x3b2b56(0x1b8)}),logger_1[_0x3b2b56(0xeb)][_0x3b2b56(0x167)]('SendScheduledMessage\x20->\x20SendMessage:\x20error',_0x32333a[_0x3b2b56(0x15f)]);throw _0x32333a;}}async function handleVerifyCampaigns(_0x9b8207){const _0x73677d=a337_0x5a2b44,_0x3b5789=await database_1[_0x73677d(0xde)][_0x73677d(0x19b)](_0x73677d(0x134),{'type':sequelize_1[_0x73677d(0x1a7)][_0x73677d(0x1a4)]});if(_0x3b5789[_0x73677d(0x1ae)]>0x0)logger_1[_0x73677d(0xeb)][_0x73677d(0x172)](_0x73677d(0x14d)+_0x3b5789[_0x73677d(0x1ae)]);for(let _0x2f0faf of _0x3b5789){try{const _0x4d1384=(0x0,moment_1['default'])(),_0x1f3ec5=(0x0,moment_1[_0x73677d(0xde)])(_0x2f0faf[_0x73677d(0x124)]),_0x3732ce=_0x1f3ec5['diff'](_0x4d1384,_0x73677d(0x116));logger_1[_0x73677d(0xeb)]['info'](_0x73677d(0x17e)+_0x2f0faf['id']+',\x20Delay\x20Inicial='+_0x3732ce),exports[_0x73677d(0x121)][_0x73677d(0x14b)](_0x73677d(0x137),{'id':_0x2f0faf['id'],'delay':_0x3732ce},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x330c30){Sentry[_0x73677d(0x1bd)](_0x330c30);}}}async function getCampaign(_0x2295e1){const _0x3b892a=a337_0x5a2b44;return await Campaign_1['default'][_0x3b892a(0x112)]({'where':{'id':_0x2295e1},'include':[{'model':ContactList_1[_0x3b892a(0xde)],'as':_0x3b892a(0x15d),'attributes':['id',_0x3b892a(0x1b4)],'include':[{'model':ContactListItem_1[_0x3b892a(0xde)],'as':_0x3b892a(0xe1),'attributes':['id',_0x3b892a(0x1b4),_0x3b892a(0x13d),'email',_0x3b892a(0x115)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x3b892a(0x14a),'attributes':['id',_0x3b892a(0x1b4)]}]});}async function getContact(_0x46a043){const _0x20ddfd=a337_0x5a2b44;return await ContactListItem_1[_0x20ddfd(0xde)][_0x20ddfd(0x140)](_0x46a043,{'attributes':['id',_0x20ddfd(0x1b4),'number','email']});}async function getSettings(_0x3e841c){const _0x4c1a8b=a337_0x5a2b44;try{const _0x4e13f9=await CampaignSetting_1['default'][_0x4c1a8b(0x155)]({'where':{'companyId':_0x3e841c[_0x4c1a8b(0x13e)]},'attributes':[_0x4c1a8b(0x108),'value']});let _0x198ba5=0x14,_0x374c84=0x14,_0x4d7526=0x3c,_0x1c4db5=[];return _0x4e13f9[_0x4c1a8b(0x139)](_0x542251=>{const _0x49876d=_0x4c1a8b;_0x542251['key']===_0x49876d(0x1a0)&&(_0x198ba5=JSON['parse'](_0x542251[_0x49876d(0x1b6)])),_0x542251[_0x49876d(0x108)]==='longerIntervalAfter'&&(_0x374c84=JSON[_0x49876d(0x173)](_0x542251[_0x49876d(0x1b6)])),_0x542251['key']===_0x49876d(0x182)&&(_0x4d7526=JSON['parse'](_0x542251[_0x49876d(0x1b6)])),_0x542251['key']===_0x49876d(0x165)&&(_0x1c4db5=JSON[_0x49876d(0x173)](_0x542251[_0x49876d(0x1b6)]));}),{'messageInterval':_0x198ba5,'longerIntervalAfter':_0x374c84,'greaterInterval':_0x4d7526,'variables':_0x1c4db5};}catch(_0x1aa6c6){console[_0x4c1a8b(0x132)](_0x1aa6c6);throw _0x1aa6c6;}}function parseToMilliseconds(_0x3ea13d){return _0x3ea13d*0x3e8;}exports[a337_0x5a2b44(0x1c1)]=parseToMilliseconds;async function sleep(_0x7066c3){const _0x103aeb=a337_0x5a2b44;return logger_1[_0x103aeb(0xeb)]['info']('Sleep\x20de\x20'+_0x7066c3+_0x103aeb(0xf2)+(0x0,moment_1[_0x103aeb(0xde)])()['format'](_0x103aeb(0xea))),new Promise(_0xe7b604=>{setTimeout(()=>{const _0x52e357=a337_0x3c02;logger_1[_0x52e357(0xeb)][_0x52e357(0x172)]('Sleep\x20de\x20'+_0x7066c3+_0x52e357(0x1bf)+(0x0,moment_1[_0x52e357(0xde)])()[_0x52e357(0xe3)](_0x52e357(0xea))),_0xe7b604(!![]);},parseToMilliseconds(_0x7066c3));});}function getCampaignValidMessages(_0x4b4287){const _0x401499=a337_0x5a2b44,_0x50aeb2=[];return!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287['message1'])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287['message1'])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x195)]),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287[_0x401499(0x148)])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287[_0x401499(0x148)])&&_0x50aeb2['push'](_0x4b4287['message2']),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287[_0x401499(0x118)])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287['message3'])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x118)]),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287[_0x401499(0x159)])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287[_0x401499(0x159)])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x159)]),!(0x0,lodash_1[_0x401499(0x191)])(_0x4b4287['message5'])&&!(0x0,lodash_1[_0x401499(0x154)])(_0x4b4287[_0x401499(0x19e)])&&_0x50aeb2[_0x401499(0xe0)](_0x4b4287[_0x401499(0x19e)]),_0x50aeb2;}function a337_0xac02(){const _0x6ed42e=['whatsappId','HH:mm:ss','logger','toString','confirmationMessage4','randomValue','UPDATE','keys','floor','\x20segundos\x20iniciado:\x20','America/Sao_Paulo','isInteger','user','filter','active','ScheduleMonitor','sendGreetingMessageOneQueues','getOwnPropertyDescriptor','./models/CompaniesSettings','1064688AinlvG','contactId','pending','144QKJCor','sendMessage','statusTicket','mediaPath','prototype','confirmationRequestedAt','groupAsTicket','data','1699730kbxnAu','key','PrepareContact','cron','tempoRoteador','longerIntervalAfter','VerifyLoginStatus','notification','CONNECTED','reload','SearchForQueue\x20->\x20VerifyQueue:\x20error','findOne','create','./services/TicketServices/ShowTicketService','isWhatsappValid','milliseconds','clean','message3','status','./models/ContactList','utc','online','verify-login','./services/WbotServices/wbotClosedTickets','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','update','campaignQueue','writable','./models/Contact','scheduledAt','getMessageOptions','body','count','addSeconds','resolve','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','SendScheduledMessage\x20->\x20Verify:\x20error','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','PENDENTE','./models/Whatsapp','path','3742lXcovU','REDIS_URI','log','join','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','./helpers/GetWhatsapp','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','ProcessCampaign','confirmationMessage','forEach','extraInfo','color','./models/ContactListItem','number','companyId','*/20\x20*\x20*\x20*\x20*\x20*','findByPk','scheduleMonitor','minutes','*\x20*\x20*\x20*\x20*','FINALIZADA','149726EOMkNW','111RQXLfm','verify-queue','message2','YYYY-MM-DD\x20HH:mm','whatsapp','add','enabled','Campanhas\x20encontradas:\x20','\x20-\x20Empresa:\x20','YYYY-MM-DD\x20HH:mm:ss','sendScheduledMessages','-campaign','./services/WbotServices/wbotMessageListener','*/5\x20*\x20*\x20*\x20*\x20*','isNil','findAll','emit','timeSendQueue','VerifyQueueStatus','message4','call','userMonitor','not','contactList','GetWhatsapp','message','userId','./models/Campaign','-ticket','findAndCountAll','confirmationMessage1','variables','campaignId','error','{email}','EM_ANDAMENTO','134104ILovHJ','random','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','email','./utils/logger','REDIS_OPT_LIMITER_DURATION','map','info','parse','580JJBxOS','openTicket','ENVIADA','Atendimento\x20Perdido:\x20','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','./models/Schedule','deliveredAt','expiresTicket','toDate',';Registro=','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','all','gte','VerifyCampaignsDaatabase','greaterInterval','./models/Ticket','get','company-','confirmationMessage5',';Contato=','./services/ContactServices/ShowContactService','stack','DispatchCampaign',';delay=','Disparo\x20agendado\x20para:\x20','\x20updated\x20with\x20UserId\x20','Ticket\x20ID\x20','__setModuleDefault','moment','isEmpty','1767976OWelwb','mediaName','public','message1','queue','contact','sendIdQueue','Iniciando\x20processamento\x20de\x20filas','__importStar','query','./helpers/GetDefaultWhatsApp','replace','message5','./models/UserQueue','messageInterval','tags','{numero}','findOrCreate','SELECT','closed','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','QueryTypes','UserMonitor','startQueueProcess','verify','subtract','confirmationMessage3','./services/TicketServices/UpdateTicketService','length','queueMonitor','__importDefault','__esModule','disableBot','messageQueue','name','confirmation','value','profile','ERRO','env','@s.whatsapp.net','set','queueId','captureException','./models/Queue','\x20segundos\x20finalizado:\x20','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','parseToMilliseconds','includes','whatsapps','1580vKDuJm','start','*/1\x20*\x20*\x20*\x20*','process','default','./database','push','contacts','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','format','company','updatedAt','defineProperty','confirmationMessage2','SendMessage'];a337_0xac02=function(){return _0x6ed42e;};return a337_0xac02();}function getCampaignValidConfirmationMessages(_0x447efc){const _0x4d3ac7=a337_0x5a2b44,_0x522477=[];return!(0x0,lodash_1['isEmpty'])(_0x447efc[_0x4d3ac7(0x164)])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0x164)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0x164)]),!(0x0,lodash_1[_0x4d3ac7(0x191)])(_0x447efc['confirmationMessage2'])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0xe7)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0xe7)]),!(0x0,lodash_1['isEmpty'])(_0x447efc['confirmationMessage3'])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc['confirmationMessage3'])&&_0x522477['push'](_0x447efc[_0x4d3ac7(0x1ac)]),!(0x0,lodash_1[_0x4d3ac7(0x191)])(_0x447efc[_0x4d3ac7(0xed)])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0xed)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0xed)]),!(0x0,lodash_1['isEmpty'])(_0x447efc[_0x4d3ac7(0x186)])&&!(0x0,lodash_1[_0x4d3ac7(0x154)])(_0x447efc[_0x4d3ac7(0x186)])&&_0x522477[_0x4d3ac7(0xe0)](_0x447efc[_0x4d3ac7(0x186)]),_0x522477;}function getProcessedMessage(_0x1f6c2d,_0x154598,_0xeb1546){const _0x1c7ffb=a337_0x5a2b44;let _0xcdf3fd=_0x1f6c2d;return _0xcdf3fd['includes']('{nome}')&&(_0xcdf3fd=_0xcdf3fd[_0x1c7ffb(0x19d)](/{nome}/g,_0xeb1546[_0x1c7ffb(0x1b4)])),_0xcdf3fd['includes'](_0x1c7ffb(0x168))&&(_0xcdf3fd=_0xcdf3fd['replace'](/{email}/g,_0xeb1546['email'])),_0xcdf3fd[_0x1c7ffb(0x1c2)](_0x1c7ffb(0x1a2))&&(_0xcdf3fd=_0xcdf3fd[_0x1c7ffb(0x19d)](/{numero}/g,_0xeb1546[_0x1c7ffb(0x13d)])),_0x154598[_0x1c7ffb(0x139)](_0x4005b5=>{const _0x3c5b53=_0x1c7ffb;if(_0xcdf3fd[_0x3c5b53(0x1c2)]('{'+_0x4005b5[_0x3c5b53(0x108)]+'}')){const _0x19ca61=new RegExp('{'+_0x4005b5[_0x3c5b53(0x108)]+'}','g');_0xcdf3fd=_0xcdf3fd[_0x3c5b53(0x19d)](_0x19ca61,_0x4005b5['value']);}}),_0xcdf3fd;}function randomValue(_0xd5bde1,_0x3995ce){const _0x41faa8=a337_0x5a2b44;return Math['floor'](Math[_0x41faa8(0x16b)]()*_0x3995ce)+_0xd5bde1;}exports[a337_0x5a2b44(0xee)]=randomValue;async function verifyAndFinalizeCampaign(_0x11650){const _0x54590d=a337_0x5a2b44,{contacts:_0x4de6a7}=_0x11650[_0x54590d(0x15d)],_0x172782=_0x4de6a7[_0x54590d(0x1ae)],_0x37e046=await CampaignShipping_1[_0x54590d(0xde)][_0x54590d(0x127)]({'where':{'campaignId':_0x11650['id'],'deliveredAt':{[sequelize_1['Op'][_0x54590d(0x15c)]]:null}}});_0x172782===_0x37e046&&await _0x11650[_0x54590d(0x120)]({'status':_0x54590d(0x144),'completedAt':(0x0,moment_1[_0x54590d(0xde)])()});const _0x57d42a=(0x0,socket_1['getIO'])();_0x57d42a[_0x54590d(0x156)](_0x54590d(0x185)+_0x11650[_0x54590d(0x13e)]+'-campaign',{'action':_0x54590d(0x120),'record':_0x11650});}async function handleProcessCampaign(_0x4ceec5){const _0x502e4c=a337_0x5a2b44;try{const {id:_0x134ded}=_0x4ceec5[_0x502e4c(0x106)],_0x1a6118=await getCampaign(_0x134ded),_0x42ef52=await getSettings(_0x1a6118);if(_0x1a6118){const {contacts:_0x4d043c}=_0x1a6118[_0x502e4c(0x15d)];if((0x0,lodash_1['isArray'])(_0x4d043c)){const _0x2808bf=_0x4d043c[_0x502e4c(0x171)](_0x5893f2=>({'contactId':_0x5893f2['id'],'campaignId':_0x1a6118['id'],'variables':_0x42ef52[_0x502e4c(0x165)]})),_0x452bbe=parseToMilliseconds(_0x42ef52[_0x502e4c(0x10c)]),_0x3b399f=parseToMilliseconds(_0x42ef52['greaterInterval']),_0x361a03=_0x42ef52[_0x502e4c(0x1a0)];let _0x1e5e09=_0x1a6118['scheduledAt'];const _0x2bc620=[];for(let _0x52d572=0x0;_0x52d572<_0x2808bf['length'];_0x52d572++){_0x1e5e09=(0x0,date_fns_1[_0x502e4c(0x128)])(_0x1e5e09,_0x52d572>_0x452bbe?_0x3b399f:_0x361a03);const {contactId:_0x399848,campaignId:_0x123fa1,variables:_0x50d055}=_0x2808bf[_0x52d572],_0xf23d43=calculateDelay(_0x52d572,_0x1e5e09,_0x452bbe,_0x3b399f,_0x361a03),_0x5554b7=exports['campaignQueue'][_0x502e4c(0x14b)](_0x502e4c(0x109),{'contactId':_0x399848,'campaignId':_0x123fa1,'variables':_0x50d055,'delay':_0xf23d43},{'removeOnComplete':!![]});_0x2bc620[_0x502e4c(0xe0)](_0x5554b7),logger_1[_0x502e4c(0xeb)][_0x502e4c(0x172)](_0x502e4c(0x178)+_0x1a6118['id']+_0x502e4c(0x187)+_0x4d043c[_0x52d572][_0x502e4c(0x1b4)]+_0x502e4c(0x18b)+_0xf23d43);}await Promise[_0x502e4c(0x17f)](_0x2bc620),await _0x1a6118[_0x502e4c(0x120)]({'status':_0x502e4c(0x169)});}}}catch(_0x3c58b8){Sentry[_0x502e4c(0x1bd)](_0x3c58b8);}}function calculateDelay(_0x3d5bfc,_0xbd4009,_0x492301,_0x1f9a7e,_0x4cb212){const _0x321e77=(0x0,date_fns_1['differenceInSeconds'])(_0xbd4009,new Date());return _0x3d5bfc>_0x492301?_0x321e77*0x3e8+_0x1f9a7e:_0x321e77*0x3e8+_0x4cb212;}async function handlePrepareContact(_0x353896){const _0xc87d9=a337_0x5a2b44;try{const {contactId:_0x1eca8a,campaignId:_0x30a96b,delay:_0x548740,variables:_0x16cef4}=_0x353896[_0xc87d9(0x106)],_0x1d74d5=await getCampaign(_0x30a96b),_0x2277d7=await getContact(_0x1eca8a),_0x447af9={};_0x447af9['number']=_0x2277d7['number'],_0x447af9[_0xc87d9(0xfd)]=_0x1eca8a,_0x447af9[_0xc87d9(0x166)]=_0x30a96b;const _0xd76ee5=getCampaignValidMessages(_0x1d74d5);if(_0xd76ee5['length']){const _0x116f60=randomValue(0x0,_0xd76ee5['length']),_0x289be2=getProcessedMessage(_0xd76ee5[_0x116f60],_0x16cef4,_0x2277d7);_0x447af9[_0xc87d9(0x15f)]='‌\x20'+_0x289be2;}if(_0x1d74d5[_0xc87d9(0x1b5)]){const _0x2e73e6=getCampaignValidConfirmationMessages(_0x1d74d5);if(_0x2e73e6[_0xc87d9(0x1ae)]){const _0xf3f09f=randomValue(0x0,_0x2e73e6[_0xc87d9(0x1ae)]),_0x1de725=getProcessedMessage(_0x2e73e6[_0xf3f09f],_0x16cef4,_0x2277d7);_0x447af9[_0xc87d9(0x138)]='‌\x20'+_0x1de725;}}const [_0x49d2b8,_0x115b83]=await CampaignShipping_1['default'][_0xc87d9(0x1a3)]({'where':{'campaignId':_0x447af9[_0xc87d9(0x166)],'contactId':_0x447af9['contactId']},'defaults':_0x447af9});!_0x115b83&&_0x49d2b8['deliveredAt']===null&&_0x49d2b8['confirmationRequestedAt']===null&&(_0x49d2b8[_0xc87d9(0x1bb)](_0x447af9),await _0x49d2b8['save']());if(_0x49d2b8[_0xc87d9(0x17a)]===null&&_0x49d2b8[_0xc87d9(0x104)]===null){const _0x58b735=await exports[_0xc87d9(0x121)][_0xc87d9(0x14b)](_0xc87d9(0x18a),{'campaignId':_0x1d74d5['id'],'campaignShippingId':_0x49d2b8['id'],'contactListItemId':_0x1eca8a},{'delay':_0x548740});await _0x49d2b8[_0xc87d9(0x120)]({'jobId':_0x58b735['id']});}await verifyAndFinalizeCampaign(_0x1d74d5);}catch(_0x4feafd){Sentry[_0xc87d9(0x1bd)](_0x4feafd),logger_1['logger'][_0xc87d9(0x167)](_0xc87d9(0x1a6)+_0x4feafd['message']);}}async function handleDispatchCampaign(_0x314e74){const _0x341767=a337_0x5a2b44;try{const {data:_0x204d78}=_0x314e74,{campaignShippingId:_0x555396,campaignId:_0x435948}=_0x204d78,_0x3b43a2=await getCampaign(_0x435948),_0x287e65=await(0x0,GetWhatsappWbot_1[_0x341767(0xde)])(_0x3b43a2['whatsapp']);if(!_0x287e65){logger_1[_0x341767(0xeb)]['error'](_0x341767(0x16d));return;}if(!_0x3b43a2['whatsapp']){logger_1[_0x341767(0xeb)][_0x341767(0x167)](_0x341767(0x12c));return;}if(!_0x287e65?.['user']?.['id']){logger_1[_0x341767(0xeb)][_0x341767(0x167)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found');return;}logger_1['logger'][_0x341767(0x172)](_0x341767(0x1c0)+_0x435948+_0x341767(0x17d)+_0x555396);const _0x3aab4d=await CampaignShipping_1['default']['findByPk'](_0x555396,{'include':[{'model':ContactListItem_1[_0x341767(0xde)],'as':_0x341767(0x197)}]}),_0x57e395=_0x3aab4d['number']+_0x341767(0x1ba);let _0x58d568=_0x3aab4d[_0x341767(0x15f)];_0x3b43a2[_0x341767(0x1b5)]&&_0x3aab4d[_0x341767(0x1b5)]===null&&(_0x58d568=_0x3aab4d[_0x341767(0x138)]);if(_0x3b43a2[_0x341767(0x175)]==='enabled'){const _0x14dce1=await Contact_1[_0x341767(0xde)][_0x341767(0x112)]({'where':{'number':_0x3aab4d['number']}}),_0xd02158=await Whatsapp_1['default'][_0x341767(0x140)](_0x3b43a2[_0x341767(0xe9)]),_0x202859=await CompaniesSettings_1[_0x341767(0xde)][_0x341767(0x112)]({'where':{'companyId':_0x3b43a2[_0x341767(0x13e)]}}),{ticket:_0x45dd07}=await(0x0,FindOrCreateTicketService_1[_0x341767(0xde)])(_0x14dce1,_0xd02158,0x1,_0x3b43a2[_0x341767(0x13e)],_0x3b43a2?.[_0x341767(0x1bc)],_0x3b43a2?.[_0x341767(0x160)],null,'whatsapp',![],![],_0x202859);if(_0x3b43a2['mediaPath']===null){const _0x588e27=await(0x0,SendWhatsAppMessage_1[_0x341767(0xde)])({'body':_0x58d568,'ticket':_0x45dd07});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x588e27,_0x45dd07,_0x45dd07[_0x341767(0x197)]);}else{const _0x25b2ad=path_1[_0x341767(0xde)][_0x341767(0x129)](__dirname,'..',_0x341767(0x194)),_0x478c81=path_1[_0x341767(0xde)][_0x341767(0x133)](_0x25b2ad,'company'+_0x3b43a2[_0x341767(0x13e)],_0x3b43a2['mediaPath']),_0x3df4e4=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x3b43a2[_0x341767(0x193)],_0x478c81,_0x3b43a2[_0x341767(0x13e)]['toString'](),_0x58d568);if(Object['keys'](_0x3df4e4)[_0x341767(0x1ae)]){const _0x2e864c=await _0x287e65[_0x341767(0x100)](_0x57e395,{..._0x3df4e4});await(0x0,wbotMessageListener_1['verifyMediaMessage'])(_0x2e864c,_0x45dd07,_0x45dd07[_0x341767(0x197)]);}}_0x3b43a2?.[_0x341767(0x101)]===_0x341767(0x1a5)&&await _0x45dd07[_0x341767(0x120)]({'status':_0x341767(0x1a5)}),await _0x3aab4d[_0x341767(0x120)]({'deliveredAt':(0x0,moment_1['default'])()});}else{if(_0x3b43a2['mediaPath']){const _0x99c1bd=path_1[_0x341767(0xde)][_0x341767(0x129)](__dirname,'..','public'),_0x578401=path_1[_0x341767(0xde)][_0x341767(0x133)](_0x99c1bd,_0x341767(0xe4)+_0x3b43a2['companyId'],_0x3b43a2[_0x341767(0x102)]),_0x17c124=await(0x0,SendWhatsAppMedia_1[_0x341767(0x125)])(_0x3b43a2[_0x341767(0x193)],_0x578401,_0x3b43a2[_0x341767(0x13e)][_0x341767(0xec)](),_0x58d568);Object[_0x341767(0xf0)](_0x17c124)[_0x341767(0x1ae)]&&await _0x287e65[_0x341767(0x100)](_0x57e395,{..._0x17c124});}else _0x3b43a2['confirmation']&&_0x3aab4d[_0x341767(0x1b5)]===null?(await _0x287e65[_0x341767(0x100)](_0x57e395,{'text':_0x58d568}),await _0x3aab4d['update']({'confirmationRequestedAt':(0x0,moment_1[_0x341767(0xde)])()})):await _0x287e65['sendMessage'](_0x57e395,{'text':_0x58d568});await _0x3aab4d[_0x341767(0x120)]({'deliveredAt':(0x0,moment_1[_0x341767(0xde)])()});}await verifyAndFinalizeCampaign(_0x3b43a2);const _0x448539=(0x0,socket_1['getIO'])();_0x448539[_0x341767(0x156)](_0x341767(0x185)+_0x3b43a2[_0x341767(0x13e)]+_0x341767(0x151),{'action':'update','record':_0x3b43a2}),logger_1['logger'][_0x341767(0x172)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x435948+_0x341767(0x187)+_0x3aab4d[_0x341767(0x197)]['name']);}catch(_0x275de0){Sentry['captureException'](_0x275de0),logger_1[_0x341767(0xeb)][_0x341767(0x167)](_0x275de0[_0x341767(0x15f)]),console[_0x341767(0x132)](_0x275de0[_0x341767(0x189)]);}}async function handleLoginStatus(_0x45bd3e){const _0xe1e9cd=a337_0x5a2b44,_0x4b9e21=await database_1[_0xe1e9cd(0xde)][_0xe1e9cd(0x19b)](_0xe1e9cd(0xe2),{'type':sequelize_1[_0xe1e9cd(0x1a7)][_0xe1e9cd(0x1a4)]}),_0x5cee7c=_0x4b9e21['map'](_0x13171d=>_0x13171d['id']),_0x11d48=_0x5cee7c[_0xe1e9cd(0x133)](',\x20');try{const _0x461e0d='UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20('+_0x11d48+');',_0x4c5e96=await database_1[_0xe1e9cd(0xde)][_0xe1e9cd(0x19b)](_0x461e0d,{'type':sequelize_1[_0xe1e9cd(0x1a7)][_0xe1e9cd(0xef)]});}catch(_0x1ead3f){Sentry['captureException'](_0x1ead3f);}}async function handleVerifyQueue(_0xf29d4){const _0x48beeb=a337_0x5a2b44;try{const _0x4319b2=await Company_1[_0x48beeb(0xde)]['findAll']({'attributes':['id',_0x48beeb(0x1b4)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x48beeb(0xde)],'attributes':['id',_0x48beeb(0x1b4),_0x48beeb(0x119),'timeSendQueue',_0x48beeb(0x198)]}]});_0x4319b2[_0x48beeb(0x171)](async _0x1a1e3a=>{const _0x8a31ae=_0x48beeb;_0x1a1e3a[_0x8a31ae(0x1c3)]['map'](async _0x284586=>{const _0x1cb2e3=_0x8a31ae;if(_0x284586['status']===_0x1cb2e3(0x10f)){var _0xc69fd5=_0x1a1e3a['id'];const _0x4f7dd5=_0x284586[_0x1cb2e3(0x157)]?_0x284586[_0x1cb2e3(0x157)]:0x0,_0xc46191=_0x284586[_0x1cb2e3(0x198)],_0x586e73=_0x4f7dd5,_0x3c8ff9=_0xc46191,_0x252b62=_0x586e73;if(_0x4f7dd5>0x0){if(!isNaN(_0x3c8ff9)&&Number[_0x1cb2e3(0xf4)](_0x3c8ff9)&&!isNaN(_0x252b62)&&Number[_0x1cb2e3(0xf4)](_0x252b62)){const _0x158d9d=(0x0,moment_1['default'])()['subtract'](_0x252b62,_0x1cb2e3(0x142))[_0x1cb2e3(0x11b)]()[_0x1cb2e3(0xe3)](),{count:_0x3d67ae,rows:_0x1d70c4}=await Ticket_1[_0x1cb2e3(0xde)][_0x1cb2e3(0x163)]({'attributes':['id'],'where':{'status':'pending','queueId':null,'companyId':_0xc69fd5,'whatsappId':_0x284586['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x158d9d}},'include':[{'model':Contact_1[_0x1cb2e3(0xde)],'as':_0x1cb2e3(0x197),'attributes':['id','name',_0x1cb2e3(0x13d),_0x1cb2e3(0x16e),'profilePicUrl','acceptAudioMessage',_0x1cb2e3(0xf7),_0x1cb2e3(0x1b2)],'include':[_0x1cb2e3(0x13a),'contactTags',_0x1cb2e3(0x1a1)]},{'model':Queue_2[_0x1cb2e3(0xde)],'as':'queue','attributes':['id','name',_0x1cb2e3(0x13b)]},{'model':Whatsapp_1[_0x1cb2e3(0xde)],'as':_0x1cb2e3(0x14a),'attributes':['id',_0x1cb2e3(0x1b4),_0x1cb2e3(0x17b),_0x1cb2e3(0x105)]}]});_0x3d67ae>0x0&&_0x1d70c4['map'](async _0x525312=>{const _0x12bc63=_0x1cb2e3;await _0x525312[_0x12bc63(0x120)]({'queueId':_0x3c8ff9}),await _0x525312[_0x12bc63(0x110)]();const _0xcd4548=(0x0,socket_1['getIO'])();_0xcd4548['to'](_0x525312[_0x12bc63(0x119)])['to'](_0x12bc63(0x10e))['to'](_0x525312['id'][_0x12bc63(0xec)]())[_0x12bc63(0x156)](_0x12bc63(0x185)+_0xc69fd5+_0x12bc63(0x162),{'action':'update','ticket':_0x525312,'ticketId':_0x525312['id']}),logger_1[_0x12bc63(0xeb)]['info'](_0x12bc63(0x177)+_0x525312['id']+_0x12bc63(0x14e)+_0xc69fd5);});}else logger_1[_0x1cb2e3(0xeb)][_0x1cb2e3(0x172)](_0x1cb2e3(0x12a)+_0xc69fd5);}}});});}catch(_0x70b3cd){Sentry['captureException'](_0x70b3cd),logger_1[_0x48beeb(0xeb)][_0x48beeb(0x167)](_0x48beeb(0x111),_0x70b3cd[_0x48beeb(0x15f)]);throw _0x70b3cd;}};async function handleRandomUser(){const _0x340f5a=a337_0x5a2b44,_0x8c2a8=new CronJob(_0x340f5a(0x153),async()=>{const _0x3584f9=_0x340f5a;try{const {count:_0x1499cc,rows:_0x1774dd}=await Ticket_1[_0x3584f9(0xde)][_0x3584f9(0x163)]({'where':{'status':_0x3584f9(0xfe),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0x3584f9(0xde)],'as':_0x3584f9(0x196)}]}),_0x514464=_0x5dfbf1=>{const _0x2a4cfb=_0x3584f9,_0x2c1b54=Math[_0x2a4cfb(0xf1)](Math[_0x2a4cfb(0x16b)]()*_0x5dfbf1[_0x2a4cfb(0x1ae)]);return _0x5dfbf1[_0x2c1b54];},_0x45c69e=async _0x3d259b=>{const _0x444ae5=_0x3584f9;try{const _0x52d424=await User_1[_0x444ae5(0xde)][_0x444ae5(0x112)]({'where':{'id':_0x3d259b}});return _0x52d424[_0x444ae5(0x1b7)]===_0x444ae5(0xf5)?_0x52d424[_0x444ae5(0x11c)]===!![]?_0x52d424['id']:0x0:0x0;}catch(_0x53fc6f){Sentry[_0x444ae5(0x1bd)](_0x53fc6f),logger_1['logger']['error'](_0x444ae5(0x16c),_0x53fc6f[_0x444ae5(0x15f)]);throw _0x53fc6f;}};if(_0x1499cc>0x0)for(const _0x43d812 of _0x1774dd){const {queue:_0x4bec3a,queueId:_0x1adf1e,userId:_0xa12ed9}=_0x43d812,_0x263721=_0x4bec3a[_0x3584f9(0x10b)],_0x504e57=await UserQueue_1[_0x3584f9(0xde)][_0x3584f9(0x155)]({'where':{'queueId':_0x1adf1e}}),_0x3c767e=await(0x0,ShowContactService_1[_0x3584f9(0xde)])(_0x43d812[_0x3584f9(0xfd)],_0x43d812['companyId']),_0x4554d4=_0x504e57[_0x3584f9(0x171)](_0x5655ff=>_0x5655ff[_0x3584f9(0x160)]),_0x1e3aef=(0x0,moment_1[_0x3584f9(0xde)])()[_0x3584f9(0x1ab)](_0x263721,_0x3584f9(0x142))[_0x3584f9(0x11b)]()[_0x3584f9(0x17c)](),_0x57c780=new Date(_0x43d812['updatedAt']);let _0x44bb82=await CompaniesSettings_1[_0x3584f9(0xde)][_0x3584f9(0x112)]({'where':{'companyId':_0x43d812['companyId']}});const _0x52ab2d=_0x44bb82[_0x3584f9(0xf9)]===_0x3584f9(0x14c)||![];if(!_0xa12ed9){const _0x4d213c=_0x514464(_0x4554d4);if(await _0x45c69e(_0x4d213c)>0x0){if(_0x52ab2d){const _0x4ec648=await(0x0,ShowTicketService_1['default'])(_0x43d812['id'],_0x43d812['companyId']);await(0x0,SendWhatsAppMessage_1[_0x3584f9(0xde)])({'body':_0x3584f9(0x11f),'ticket':_0x4ec648});}await(0x0,UpdateTicketService_1[_0x3584f9(0xde)])({'ticketData':{'status':_0x3584f9(0xfe),'userId':_0x4d213c},'ticketId':_0x43d812['id'],'companyId':_0x43d812[_0x3584f9(0x13e)]}),logger_1['logger']['info'](_0x3584f9(0x18e)+_0x43d812['id']+_0x3584f9(0x18d)+_0x4d213c+'\x20-\x20'+_0x43d812[_0x3584f9(0xe5)]);}else{}}else{if(_0x4554d4[_0x3584f9(0x1c2)](_0xa12ed9)){if(_0x1e3aef>_0x57c780){const _0x51378a=_0x4554d4[_0x3584f9(0xf6)](_0x5ee003=>_0x5ee003!==_0xa12ed9);if(_0x51378a[_0x3584f9(0x1ae)]>0x0){const _0x52b14e=_0x514464(_0x51378a);if(await _0x45c69e(_0x52b14e)>0x0){if(_0x52ab2d){const _0x334c4f=await(0x0,ShowTicketService_1['default'])(_0x43d812['id'],_0x43d812[_0x3584f9(0x13e)]);await(0x0,SendWhatsAppMessage_1['default'])({'body':'*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','ticket':_0x334c4f});};await(0x0,UpdateTicketService_1[_0x3584f9(0xde)])({'ticketData':{'status':'pending','userId':_0x52b14e},'ticketId':_0x43d812['id'],'companyId':_0x43d812['companyId']}),await _0x43d812[_0x3584f9(0x110)]();}else{}}else{}}else{}}else{}}}}catch(_0x23d987){Sentry[_0x3584f9(0x1bd)](_0x23d987),logger_1['logger'][_0x3584f9(0x167)]('SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error',_0x23d987[_0x3584f9(0x15f)]);throw _0x23d987;}});_0x8c2a8[_0x340f5a(0x1c5)]();}function a337_0x3c02(_0x433d91,_0x3789c0){const _0xac0293=a337_0xac02();return a337_0x3c02=function(_0x3c024e,_0x1ef699){_0x3c024e=_0x3c024e-0xdc;let _0x25a948=_0xac0293[_0x3c024e];return _0x25a948;},a337_0x3c02(_0x433d91,_0x3789c0);}async function handleCloseTicketsAutomatic(){const _0x177d81=a337_0x5a2b44,_0x267cb9=new CronJob(_0x177d81(0xdc),async()=>{const _0x254b79=_0x177d81,_0x5681af=await Company_1[_0x254b79(0xde)]['findAll']();_0x5681af[_0x254b79(0x171)](async _0x3187e=>{const _0x5c4def=_0x254b79;try{const _0x3c71bb=_0x3187e['id'];await(0x0,wbotClosedTickets_1['ClosedAllOpenTickets'])(_0x3c71bb);}catch(_0x12182e){Sentry[_0x5c4def(0x1bd)](_0x12182e),logger_1[_0x5c4def(0xeb)][_0x5c4def(0x167)]('ClosedAllOpenTickets\x20->\x20Verify:\x20error',_0x12182e[_0x5c4def(0x15f)]);throw _0x12182e;}});});_0x267cb9[_0x177d81(0x1c5)]();}async function handleWhatsapp(){const _0x541a42=a337_0x5a2b44,_0x3c73ea=new CronJob('*\x2015\x203\x20*\x20*\x20*',async()=>{const _0x47477=a337_0x3c02;(0x0,GetWhatsapp_1[_0x47477(0x15e)])(),_0x3c73ea['stop']();},null,![],_0x541a42(0xf3));_0x3c73ea[_0x541a42(0x1c5)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x41bc78=a337_0x5a2b44;logger_1[_0x41bc78(0xeb)][_0x41bc78(0x172)](_0x41bc78(0x199)),exports[_0x41bc78(0x1b3)][_0x41bc78(0xdd)]('SendMessage',handleSendMessage),exports[_0x41bc78(0x141)][_0x41bc78(0xdd)]('Verify',handleVerifySchedules),exports[_0x41bc78(0x150)][_0x41bc78(0xdd)](_0x41bc78(0xe8),handleSendScheduledMessage),exports[_0x41bc78(0x121)][_0x41bc78(0xdd)](_0x41bc78(0x181),handleVerifyCampaigns),exports['campaignQueue'][_0x41bc78(0xdd)](_0x41bc78(0x137),handleProcessCampaign),exports['campaignQueue']['process'](_0x41bc78(0x109),handlePrepareContact),exports['campaignQueue']['process']('DispatchCampaign',handleDispatchCampaign),exports[_0x41bc78(0x15b)][_0x41bc78(0xdd)](_0x41bc78(0x10d),handleLoginStatus),exports[_0x41bc78(0x1af)][_0x41bc78(0xdd)](_0x41bc78(0x158),handleVerifyQueue),exports[_0x41bc78(0x141)]['add']('Verify',{},{'repeat':{'cron':_0x41bc78(0x153),'key':_0x41bc78(0x1aa)},'removeOnComplete':!![]}),exports[_0x41bc78(0x121)][_0x41bc78(0x14b)](_0x41bc78(0x181),{},{'repeat':{'cron':_0x41bc78(0x13f),'key':'verify-campaing'},'removeOnComplete':!![]}),exports[_0x41bc78(0x15b)][_0x41bc78(0x14b)]('VerifyLoginStatus',{},{'repeat':{'cron':_0x41bc78(0x143),'key':_0x41bc78(0x11d)},'removeOnComplete':!![]}),exports[_0x41bc78(0x1af)][_0x41bc78(0x14b)](_0x41bc78(0x158),{},{'repeat':{'cron':_0x41bc78(0x13f),'key':_0x41bc78(0x147)},'removeOnComplete':!![]});}exports[a337_0x5a2b44(0x1a9)]=startQueueProcess;