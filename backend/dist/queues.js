'use strict';const a353_0x3f62f7=a353_0x2666;(function(_0x25e9f8,_0x5d331b){const _0x4078e4=a353_0x2666,_0x362fdb=_0x25e9f8();while(!![]){try{const _0xed131d=-parseInt(_0x4078e4(0x221))/0x1+parseInt(_0x4078e4(0x14d))/0x2*(-parseInt(_0x4078e4(0x173))/0x3)+parseInt(_0x4078e4(0x234))/0x4*(-parseInt(_0x4078e4(0x21f))/0x5)+-parseInt(_0x4078e4(0x18b))/0x6*(-parseInt(_0x4078e4(0x1cd))/0x7)+-parseInt(_0x4078e4(0x175))/0x8+parseInt(_0x4078e4(0x226))/0x9*(parseInt(_0x4078e4(0x14f))/0xa)+parseInt(_0x4078e4(0x192))/0xb;if(_0xed131d===_0x5d331b)break;else _0x362fdb['push'](_0x362fdb['shift']());}catch(_0x44003c){_0x362fdb['push'](_0x362fdb['shift']());}}}(a353_0x2436,0xc86c5));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x1ad3fe,_0x42e81c,_0x287f1f,_0x3ca91a){const _0x18292e=a353_0x2666;if(_0x3ca91a===undefined)_0x3ca91a=_0x287f1f;var _0x588c5f=Object[_0x18292e(0x154)](_0x42e81c,_0x287f1f);(!_0x588c5f||(_0x18292e(0x238)in _0x588c5f?!_0x42e81c['__esModule']:_0x588c5f[_0x18292e(0x1fe)]||_0x588c5f[_0x18292e(0x1e1)]))&&(_0x588c5f={'enumerable':!![],'get':function(){return _0x42e81c[_0x287f1f];}}),Object['defineProperty'](_0x1ad3fe,_0x3ca91a,_0x588c5f);}:function(_0x3e18c6,_0x318567,_0x8e79ee,_0x4f81f3){if(_0x4f81f3===undefined)_0x4f81f3=_0x8e79ee;_0x3e18c6[_0x4f81f3]=_0x318567[_0x8e79ee];}),__setModuleDefault=this&&this[a353_0x3f62f7(0x1a1)]||(Object[a353_0x3f62f7(0x1ff)]?function(_0x2b0235,_0x321121){const _0x5db25d=a353_0x3f62f7;Object[_0x5db25d(0x21e)](_0x2b0235,'default',{'enumerable':!![],'value':_0x321121});}:function(_0x1b8c8c,_0x2438a1){const _0x183f9b=a353_0x3f62f7;_0x1b8c8c[_0x183f9b(0x22b)]=_0x2438a1;}),__importStar=this&&this[a353_0x3f62f7(0x1a6)]||function(_0x324fe6){const _0x403e16=a353_0x3f62f7;if(_0x324fe6&&_0x324fe6['__esModule'])return _0x324fe6;var _0x4630a4={};if(_0x324fe6!=null){for(var _0x137066 in _0x324fe6)if(_0x137066!==_0x403e16(0x22b)&&Object[_0x403e16(0x17e)][_0x403e16(0x1e4)][_0x403e16(0x18f)](_0x324fe6,_0x137066))__createBinding(_0x4630a4,_0x324fe6,_0x137066);}return __setModuleDefault(_0x4630a4,_0x324fe6),_0x4630a4;},__importDefault=this&&this[a353_0x3f62f7(0x198)]||function(_0x311cc2){const _0x585913=a353_0x3f62f7;return _0x311cc2&&_0x311cc2[_0x585913(0x228)]?_0x311cc2:{'default':_0x311cc2};};Object[a353_0x3f62f7(0x21e)](exports,a353_0x3f62f7(0x228),{'value':!![]}),exports['startQueueProcess']=exports[a353_0x3f62f7(0x21d)]=exports[a353_0x3f62f7(0x1dd)]=exports[a353_0x3f62f7(0x16c)]=exports[a353_0x3f62f7(0x247)]=exports[a353_0x3f62f7(0x22d)]=exports[a353_0x3f62f7(0x1e8)]=exports[a353_0x3f62f7(0x1f5)]=exports['userMonitor']=void 0x0;const Sentry=__importStar(require(a353_0x3f62f7(0x1b9))),bull_1=__importDefault(require('bull')),SendMessage_1=require(a353_0x3f62f7(0x195)),Whatsapp_1=__importDefault(require(a353_0x3f62f7(0x1c5))),logger_1=require('./utils/logger'),moment_1=__importDefault(require(a353_0x3f62f7(0x243))),Schedule_1=__importDefault(require(a353_0x3f62f7(0x1d0))),sequelize_1=require('sequelize'),GetDefaultWhatsApp_1=__importDefault(require(a353_0x3f62f7(0x158))),Campaign_1=__importDefault(require(a353_0x3f62f7(0x1b1))),Queue_1=__importDefault(require(a353_0x3f62f7(0x1b8))),ContactList_1=__importDefault(require('./models/ContactList')),ContactListItem_1=__importDefault(require(a353_0x3f62f7(0x1e9))),lodash_1=require(a353_0x3f62f7(0x18c)),CampaignSetting_1=__importDefault(require(a353_0x3f62f7(0x153))),CampaignShipping_1=__importDefault(require(a353_0x3f62f7(0x227))),GetWhatsappWbot_1=__importDefault(require(a353_0x3f62f7(0x1d5))),database_1=__importDefault(require(a353_0x3f62f7(0x189))),SendWhatsAppMedia_1=require(a353_0x3f62f7(0x20a)),socket_1=require(a353_0x3f62f7(0x219)),path_1=__importDefault(require('path')),User_1=__importDefault(require(a353_0x3f62f7(0x147))),Company_1=__importDefault(require(a353_0x3f62f7(0x1b5))),Contact_1=__importDefault(require('./models/Contact')),Queue_2=__importDefault(require('./models/Queue')),wbotClosedTickets_1=require(a353_0x3f62f7(0x187)),Ticket_1=__importDefault(require(a353_0x3f62f7(0x1d8))),ShowContactService_1=__importDefault(require(a353_0x3f62f7(0x22e))),UserQueue_1=__importDefault(require(a353_0x3f62f7(0x13e))),ShowTicketService_1=__importDefault(require(a353_0x3f62f7(0x20c))),SendWhatsAppMessage_1=__importDefault(require(a353_0x3f62f7(0x150))),UpdateTicketService_1=__importDefault(require(a353_0x3f62f7(0x1b2))),date_fns_1=require(a353_0x3f62f7(0x236)),GetWhatsapp_1=require(a353_0x3f62f7(0x13b)),nodemailer=require(a353_0x3f62f7(0x222)),CronJob=require(a353_0x3f62f7(0x194))[a353_0x3f62f7(0x203)],CompaniesSettings_1=__importDefault(require(a353_0x3f62f7(0x1b3))),wbotMessageListener_1=require(a353_0x3f62f7(0x239)),FindOrCreateTicketService_1=__importDefault(require(a353_0x3f62f7(0x209))),connection=process['env']['REDIS_URI']||'',limiterMax=process[a353_0x3f62f7(0x14b)][a353_0x3f62f7(0x1f4)]||0x1,limiterDuration=process['env'][a353_0x3f62f7(0x148)]||0xbb8;exports['userMonitor']=new bull_1[(a353_0x3f62f7(0x22b))]('UserMonitor',connection),exports['scheduleMonitor']=new bull_1[(a353_0x3f62f7(0x22b))](a353_0x3f62f7(0x19a),connection),exports['sendScheduledMessages']=new bull_1[(a353_0x3f62f7(0x22b))](a353_0x3f62f7(0x1fb),connection),exports[a353_0x3f62f7(0x22d)]=new bull_1[(a353_0x3f62f7(0x22b))](a353_0x3f62f7(0x208),connection),exports[a353_0x3f62f7(0x247)]=new bull_1[(a353_0x3f62f7(0x22b))](a353_0x3f62f7(0x172),connection),exports[a353_0x3f62f7(0x16c)]=new bull_1[(a353_0x3f62f7(0x22b))](a353_0x3f62f7(0x207),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x4e7079){const _0x39151c=a353_0x3f62f7;try{const {data:_0x6b5287}=_0x4e7079,_0x40b4b8=await Whatsapp_1[_0x39151c(0x22b)]['findByPk'](_0x6b5287['whatsappId']);if(_0x40b4b8===null)throw Error(_0x39151c(0x14e));const _0xbdb7a8=_0x6b5287[_0x39151c(0x240)];await(0x0,SendMessage_1[_0x39151c(0x213)])(_0x40b4b8,_0xbdb7a8);}catch(_0x33d34b){Sentry[_0x39151c(0x145)](_0x33d34b),logger_1[_0x39151c(0x23a)][_0x39151c(0x1da)](_0x39151c(0x225),_0x33d34b[_0x39151c(0x1ae)]);throw _0x33d34b;}}async function handleVerifySchedules(_0x58e972){const _0x445e96=a353_0x3f62f7;try{const {count:_0x381044,rows:_0x2ede9c}=await Schedule_1[_0x445e96(0x22b)][_0x445e96(0x143)]({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op']['gte']]:(0x0,moment_1[_0x445e96(0x22b)])()[_0x445e96(0x16f)]('YYYY-MM-DD\x20HH:mm:ss'),[sequelize_1['Op'][_0x445e96(0x15b)]]:(0x0,moment_1[_0x445e96(0x22b)])()[_0x445e96(0x15d)]('30','seconds')['format'](_0x445e96(0x157))}},'include':[{'model':Contact_1[_0x445e96(0x22b)],'as':_0x445e96(0x237)}]});_0x381044>0x0&&_0x2ede9c[_0x445e96(0x19c)](async _0x4d45a5=>{const _0x3e8590=_0x445e96;await _0x4d45a5['update']({'status':_0x3e8590(0x180)}),exports[_0x3e8590(0x1e8)]['add'](_0x3e8590(0x213),{'schedule':_0x4d45a5},{'delay':0x9c40}),logger_1[_0x3e8590(0x23a)][_0x3e8590(0x1e5)]('Disparo\x20agendado\x20para:\x20'+_0x4d45a5[_0x3e8590(0x237)]['name']);});}catch(_0x37dbd4){Sentry[_0x445e96(0x145)](_0x37dbd4),logger_1[_0x445e96(0x23a)][_0x445e96(0x1da)](_0x445e96(0x230),_0x37dbd4['message']);throw _0x37dbd4;}}async function handleSendScheduledMessage(_0x1023a5){const _0xac4a1b=a353_0x3f62f7,{data:{schedule:_0x2e66e2}}=_0x1023a5;let _0x486778=null;try{_0x486778=await Schedule_1[_0xac4a1b(0x22b)]['findByPk'](_0x2e66e2['id']);}catch(_0x307e9c){Sentry[_0xac4a1b(0x145)](_0x307e9c),logger_1[_0xac4a1b(0x23a)]['info']('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x2e66e2['id']);}try{const _0x16104b=await(0x0,GetDefaultWhatsApp_1[_0xac4a1b(0x22b)])(_0x2e66e2[_0xac4a1b(0x185)]),_0x3ff43c=await CompaniesSettings_1[_0xac4a1b(0x22b)][_0xac4a1b(0x1b0)]({'where':{'companyId':_0x2e66e2[_0xac4a1b(0x185)]}}),{ticket:_0x2a5b5d}=await(0x0,FindOrCreateTicketService_1['default'])(_0x2e66e2[_0xac4a1b(0x237)],_0x16104b,0x1,_0x2e66e2[_0xac4a1b(0x185)],0x0,0x0,null,_0xac4a1b(0x151),![],![],_0x3ff43c,![],!![]),_0x536d2d=await(0x0,SendMessage_1[_0xac4a1b(0x213)])(_0x16104b,{'number':_0x2e66e2[_0xac4a1b(0x237)][_0xac4a1b(0x13a)],'body':_0x2e66e2[_0xac4a1b(0x1f7)]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x536d2d,_0x2a5b5d,_0x2e66e2[_0xac4a1b(0x237)]['number']),await _0x486778?.[_0xac4a1b(0x1ac)]({'sentAt':(0x0,moment_1[_0xac4a1b(0x22b)])()['format']('YYYY-MM-DD\x20HH:mm'),'status':'ENVIADA'}),logger_1[_0xac4a1b(0x23a)]['info'](_0xac4a1b(0x1a5)+_0x2e66e2[_0xac4a1b(0x237)][_0xac4a1b(0x1f9)]),exports['sendScheduledMessages']['clean'](0x3a98,_0xac4a1b(0x1eb));}catch(_0x55cabc){Sentry[_0xac4a1b(0x145)](_0x55cabc),await _0x486778?.['update']({'status':_0xac4a1b(0x18a)}),logger_1['logger'][_0xac4a1b(0x1da)](_0xac4a1b(0x15f),_0x55cabc[_0xac4a1b(0x1ae)]);throw _0x55cabc;}}async function handleVerifyCampaigns(_0x892fac){const _0x1d6864=a353_0x3f62f7,_0x24d11b=await database_1['default'][_0x1d6864(0x1ad)](_0x1d6864(0x241),{'type':sequelize_1['QueryTypes']['SELECT']});if(_0x24d11b[_0x1d6864(0x17f)]>0x0)logger_1[_0x1d6864(0x23a)]['info'](_0x1d6864(0x1c1)+_0x24d11b['length']);for(let _0x3c64df of _0x24d11b){try{const _0x347111=(0x0,moment_1['default'])(),_0x2f769b=(0x0,moment_1['default'])(_0x3c64df[_0x1d6864(0x155)]),_0x5dfb58=_0x2f769b[_0x1d6864(0x1df)](_0x347111,'milliseconds');logger_1[_0x1d6864(0x23a)]['info'](_0x1d6864(0x1ab)+_0x3c64df['id']+_0x1d6864(0x1c0)+_0x5dfb58),exports[_0x1d6864(0x22d)][_0x1d6864(0x15d)](_0x1d6864(0x1c6),{'id':_0x3c64df['id'],'delay':_0x5dfb58},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0xc40c16){Sentry[_0x1d6864(0x145)](_0xc40c16);}}}async function getCampaign(_0x2dfcb2){const _0x2fe969=a353_0x3f62f7;return await Campaign_1['default']['findOne']({'where':{'id':_0x2dfcb2},'include':[{'model':ContactList_1[_0x2fe969(0x22b)],'as':_0x2fe969(0x199),'attributes':['id',_0x2fe969(0x1f9)],'include':[{'model':ContactListItem_1[_0x2fe969(0x22b)],'as':_0x2fe969(0x231),'attributes':['id',_0x2fe969(0x1f9),_0x2fe969(0x13a),_0x2fe969(0x13d),'isWhatsappValid','isGroup'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x2fe969(0x151),'attributes':['id',_0x2fe969(0x1f9)]}]});}async function getContact(_0x2c884c){const _0x50ab88=a353_0x3f62f7;return await ContactListItem_1[_0x50ab88(0x22b)][_0x50ab88(0x16b)](_0x2c884c,{'attributes':['id',_0x50ab88(0x1f9),_0x50ab88(0x13a),_0x50ab88(0x13d),_0x50ab88(0x1d7)]});}async function getSettings(_0x8ff885){const _0x5867a2=a353_0x3f62f7;try{const _0x38e0bb=await CampaignSetting_1['default'][_0x5867a2(0x22f)]({'where':{'companyId':_0x8ff885[_0x5867a2(0x185)]},'attributes':['key',_0x5867a2(0x224)]});let _0x519e01=0x14,_0x23faab=0x14,_0x39affd=0x3c,_0x5327e1=[];return _0x38e0bb[_0x5867a2(0x18e)](_0x13050d=>{const _0xe87308=_0x5867a2;_0x13050d[_0xe87308(0x184)]===_0xe87308(0x1db)&&(_0x519e01=JSON['parse'](_0x13050d[_0xe87308(0x224)])),_0x13050d[_0xe87308(0x184)]===_0xe87308(0x159)&&(_0x23faab=JSON[_0xe87308(0x1a8)](_0x13050d[_0xe87308(0x224)])),_0x13050d[_0xe87308(0x184)]===_0xe87308(0x1ea)&&(_0x39affd=JSON[_0xe87308(0x1a8)](_0x13050d[_0xe87308(0x224)])),_0x13050d[_0xe87308(0x184)]==='variables'&&(_0x5327e1=JSON[_0xe87308(0x1a8)](_0x13050d['value']));}),{'messageInterval':_0x519e01,'longerIntervalAfter':_0x23faab,'greaterInterval':_0x39affd,'variables':_0x5327e1};}catch(_0x589647){console[_0x5867a2(0x1a7)](_0x589647);throw _0x589647;}}function parseToMilliseconds(_0x405da4){return _0x405da4*0x3e8;}exports[a353_0x3f62f7(0x1dd)]=parseToMilliseconds;async function sleep(_0x4d5d8f){const _0x17f8db=a353_0x3f62f7;return logger_1[_0x17f8db(0x23a)]['info'](_0x17f8db(0x1b4)+_0x4d5d8f+_0x17f8db(0x205)+(0x0,moment_1[_0x17f8db(0x22b)])()[_0x17f8db(0x16f)]('HH:mm:ss')),new Promise(_0x37215d=>{setTimeout(()=>{const _0x182938=a353_0x2666;logger_1['logger'][_0x182938(0x1e5)](_0x182938(0x1b4)+_0x4d5d8f+_0x182938(0x20f)+(0x0,moment_1[_0x182938(0x22b)])()['format'](_0x182938(0x201))),_0x37215d(!![]);},parseToMilliseconds(_0x4d5d8f));});}function getCampaignValidMessages(_0x510710){const _0x1ae08c=a353_0x3f62f7,_0x322229=[];return!(0x0,lodash_1['isEmpty'])(_0x510710[_0x1ae08c(0x1d2)])&&!(0x0,lodash_1[_0x1ae08c(0x20b)])(_0x510710['message1'])&&_0x322229[_0x1ae08c(0x174)](_0x510710[_0x1ae08c(0x1d2)]),!(0x0,lodash_1['isEmpty'])(_0x510710[_0x1ae08c(0x1c2)])&&!(0x0,lodash_1[_0x1ae08c(0x20b)])(_0x510710['message2'])&&_0x322229[_0x1ae08c(0x174)](_0x510710['message2']),!(0x0,lodash_1[_0x1ae08c(0x1c3)])(_0x510710[_0x1ae08c(0x22a)])&&!(0x0,lodash_1[_0x1ae08c(0x20b)])(_0x510710[_0x1ae08c(0x22a)])&&_0x322229[_0x1ae08c(0x174)](_0x510710['message3']),!(0x0,lodash_1[_0x1ae08c(0x1c3)])(_0x510710[_0x1ae08c(0x1bd)])&&!(0x0,lodash_1[_0x1ae08c(0x20b)])(_0x510710[_0x1ae08c(0x1bd)])&&_0x322229['push'](_0x510710[_0x1ae08c(0x1bd)]),!(0x0,lodash_1[_0x1ae08c(0x1c3)])(_0x510710[_0x1ae08c(0x17a)])&&!(0x0,lodash_1['isNil'])(_0x510710[_0x1ae08c(0x17a)])&&_0x322229['push'](_0x510710[_0x1ae08c(0x17a)]),_0x322229;}function getCampaignValidConfirmationMessages(_0x4d5984){const _0x392e3f=a353_0x3f62f7,_0x146ba3=[];return!(0x0,lodash_1[_0x392e3f(0x1c3)])(_0x4d5984[_0x392e3f(0x235)])&&!(0x0,lodash_1[_0x392e3f(0x20b)])(_0x4d5984[_0x392e3f(0x235)])&&_0x146ba3[_0x392e3f(0x174)](_0x4d5984[_0x392e3f(0x235)]),!(0x0,lodash_1[_0x392e3f(0x1c3)])(_0x4d5984[_0x392e3f(0x1aa)])&&!(0x0,lodash_1[_0x392e3f(0x20b)])(_0x4d5984['confirmationMessage2'])&&_0x146ba3[_0x392e3f(0x174)](_0x4d5984[_0x392e3f(0x1aa)]),!(0x0,lodash_1[_0x392e3f(0x1c3)])(_0x4d5984['confirmationMessage3'])&&!(0x0,lodash_1['isNil'])(_0x4d5984[_0x392e3f(0x242)])&&_0x146ba3[_0x392e3f(0x174)](_0x4d5984[_0x392e3f(0x242)]),!(0x0,lodash_1['isEmpty'])(_0x4d5984[_0x392e3f(0x146)])&&!(0x0,lodash_1['isNil'])(_0x4d5984[_0x392e3f(0x146)])&&_0x146ba3['push'](_0x4d5984[_0x392e3f(0x146)]),!(0x0,lodash_1[_0x392e3f(0x1c3)])(_0x4d5984[_0x392e3f(0x161)])&&!(0x0,lodash_1[_0x392e3f(0x20b)])(_0x4d5984['confirmationMessage5'])&&_0x146ba3['push'](_0x4d5984['confirmationMessage5']),_0x146ba3;}function getProcessedMessage(_0x19d42e,_0x48a623,_0x1f7427){const _0x4f46d4=a353_0x3f62f7;let _0x3546b0=_0x19d42e;return _0x3546b0[_0x4f46d4(0x1f6)](_0x4f46d4(0x1d6))&&(_0x3546b0=_0x3546b0[_0x4f46d4(0x177)](/{nome}/g,_0x1f7427[_0x4f46d4(0x1f9)])),_0x3546b0[_0x4f46d4(0x1f6)](_0x4f46d4(0x1e2))&&(_0x3546b0=_0x3546b0[_0x4f46d4(0x177)](/{email}/g,_0x1f7427[_0x4f46d4(0x13d)])),_0x3546b0['includes'](_0x4f46d4(0x1c4))&&(_0x3546b0=_0x3546b0[_0x4f46d4(0x177)](/{numero}/g,_0x1f7427['number'])),_0x48a623[0x0]?.[_0x4f46d4(0x224)]!=='[]'&&_0x48a623[_0x4f46d4(0x18e)](_0x296fa9=>{const _0xf0e294=_0x4f46d4;if(_0x3546b0[_0xf0e294(0x1f6)]('{'+_0x296fa9['key']+'}')){const _0x171d62=new RegExp('{'+_0x296fa9[_0xf0e294(0x184)]+'}','g');_0x3546b0=_0x3546b0['replace'](_0x171d62,_0x296fa9[_0xf0e294(0x224)]);}}),_0x3546b0;}const checkerWeek=async()=>{const _0x729c2e=a353_0x3f62f7,_0x37729e=(0x0,moment_1[_0x729c2e(0x22b)])()[_0x729c2e(0x21a)]()===0x6,_0x5968a6=(0x0,moment_1[_0x729c2e(0x22b)])()[_0x729c2e(0x21a)]()===0x0,_0x43c758=await CampaignSetting_1['default'][_0x729c2e(0x1b0)]({'where':{'key':_0x729c2e(0x1ca)}}),_0x3596b5=await CampaignSetting_1['default'][_0x729c2e(0x1b0)]({'where':{'key':_0x729c2e(0x142)}});if(_0x43c758?.[_0x729c2e(0x224)]==='false'&&_0x37729e)return exports[_0x729c2e(0x16c)][_0x729c2e(0x193)](),!![];if(_0x3596b5?.[_0x729c2e(0x224)]===_0x729c2e(0x14c)&&_0x5968a6)return exports[_0x729c2e(0x16c)][_0x729c2e(0x193)](),!![];return exports[_0x729c2e(0x16c)][_0x729c2e(0x1a4)](),![];},checkTime=async()=>{const _0x51318e=a353_0x3f62f7,_0x784528=await CampaignSetting_1[_0x51318e(0x22b)]['findOne']({'where':{'key':_0x51318e(0x15c)}}),_0x2d6688=await CampaignSetting_1[_0x51318e(0x22b)][_0x51318e(0x1b0)]({'where':{'key':_0x51318e(0x18d)}}),_0x44ed05=_0x784528[_0x51318e(0x224)],_0x3a85c6=_0x2d6688[_0x51318e(0x224)],_0x34ad1f=(0x0,moment_1[_0x51318e(0x22b)])()[_0x51318e(0x16f)](_0x51318e(0x1f8));if(_0x34ad1f<=_0x3a85c6&&_0x34ad1f>=_0x44ed05)return exports[_0x51318e(0x16c)][_0x51318e(0x1a4)](),!![];return logger_1[_0x51318e(0x23a)][_0x51318e(0x1e5)](_0x51318e(0x1e7)+_0x44ed05+_0x51318e(0x13c)+_0x3a85c6+_0x51318e(0x1b7)+_0x34ad1f+_0x51318e(0x1f3)),exports[_0x51318e(0x16c)]['clean'](0x0,_0x51318e(0x23e)),exports[_0x51318e(0x16c)][_0x51318e(0x19d)](0x0,'wait'),exports[_0x51318e(0x16c)]['clean'](0x0,'active'),exports['messageQueue'][_0x51318e(0x19d)](0x0,_0x51318e(0x1eb)),exports[_0x51318e(0x16c)][_0x51318e(0x19d)](0x0,_0x51318e(0x17b)),exports[_0x51318e(0x16c)]['pause'](),![];};function randomValue(_0x2eba1c,_0x3d8e67){const _0x100fb8=a353_0x3f62f7;return Math[_0x100fb8(0x246)](Math[_0x100fb8(0x1e0)]()*_0x3d8e67)+_0x2eba1c;}exports[a353_0x3f62f7(0x21d)]=randomValue;async function verifyAndFinalizeCampaign(_0x4f7176){const _0x1f45cc=a353_0x3f62f7,{contacts:_0x2422d5}=_0x4f7176[_0x1f45cc(0x199)],_0x415019=_0x2422d5[_0x1f45cc(0x17f)],_0x254817=await CampaignShipping_1[_0x1f45cc(0x22b)][_0x1f45cc(0x140)]({'where':{'campaignId':_0x4f7176['id'],'deliveredAt':{[sequelize_1['Op']['not']]:null},'confirmation':_0x4f7176[_0x1f45cc(0x1a3)]?!![]:null||![]}});_0x415019===_0x254817&&await _0x4f7176[_0x1f45cc(0x1ac)]({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0x1f45cc(0x22b)])()});const _0x3c0821=(0x0,socket_1[_0x1f45cc(0x233)])();_0x3c0821['emit'](_0x1f45cc(0x14a)+_0x4f7176['companyId']+_0x1f45cc(0x23b),{'action':_0x1f45cc(0x1ac),'record':_0x4f7176});}async function handleProcessCampaign(_0xb27934){const _0x457f53=a353_0x3f62f7;try{const {id:_0x374d84}=_0xb27934[_0x457f53(0x240)],_0x3c9761=await getCampaign(_0x374d84),_0x53952b=await getSettings(_0x3c9761);if(_0x3c9761){const {contacts:_0xfca96}=_0x3c9761[_0x457f53(0x199)];if((0x0,lodash_1[_0x457f53(0x23c)])(_0xfca96)){const _0x1714b6=_0xfca96[_0x457f53(0x19c)](_0x2c9da8=>({'contactId':_0x2c9da8['id'],'campaignId':_0x3c9761['id'],'variables':_0x53952b[_0x457f53(0x22c)],'isGroup':_0x2c9da8[_0x457f53(0x1d7)]})),_0x3aefa0=parseToMilliseconds(_0x53952b[_0x457f53(0x159)]),_0x22694e=parseToMilliseconds(_0x53952b[_0x457f53(0x1ea)]),_0x112037=_0x53952b[_0x457f53(0x1db)];let _0x3fb47a=_0x3c9761[_0x457f53(0x155)];const _0x46dec7=[];for(let _0x521454=0x0;_0x521454<_0x1714b6[_0x457f53(0x17f)];_0x521454++){_0x3fb47a=(0x0,date_fns_1[_0x457f53(0x186)])(_0x3fb47a,_0x521454>_0x3aefa0?_0x22694e:_0x112037);const {contactId:_0x44e1ac,campaignId:_0x544a9e,variables:_0x1c9633}=_0x1714b6[_0x521454],_0x406773=calculateDelay(_0x521454,_0x3fb47a,_0x3aefa0,_0x22694e,_0x112037),_0x7d8ef8=exports[_0x457f53(0x22d)][_0x457f53(0x15d)]('PrepareContact',{'contactId':_0x44e1ac,'campaignId':_0x544a9e,'variables':_0x1c9633,'delay':_0x406773},{'removeOnComplete':!![]});_0x46dec7[_0x457f53(0x174)](_0x7d8ef8),logger_1[_0x457f53(0x23a)][_0x457f53(0x1e5)](_0x457f53(0x191)+_0x3c9761['id']+';Contato='+_0xfca96[_0x521454][_0x457f53(0x1f9)]+';delay='+_0x406773);}await Promise[_0x457f53(0x1d9)](_0x46dec7),await _0x3c9761[_0x457f53(0x1ac)]({'status':'EM_ANDAMENTO'});}}}catch(_0x75aa87){Sentry[_0x457f53(0x145)](_0x75aa87);}}function a353_0x2666(_0x207f5c,_0x107647){const _0x2436f7=a353_0x2436();return a353_0x2666=function(_0x266642,_0x2e6e1a){_0x266642=_0x266642-0x137;let _0x364029=_0x2436f7[_0x266642];return _0x364029;},a353_0x2666(_0x207f5c,_0x107647);}function calculateDelay(_0x270814,_0x2b5188,_0x44b94b,_0x196e0c,_0x5d0a96){const _0x36d3fb=(0x0,date_fns_1['differenceInSeconds'])(_0x2b5188,new Date());return _0x270814>_0x44b94b?_0x36d3fb*0x3e8+_0x196e0c:_0x36d3fb*0x3e8+_0x5d0a96;}async function handlePrepareContact(_0x4f5ada){const _0x17e221=a353_0x3f62f7;try{const {contactId:_0x2eea32,campaignId:_0x5dff6e,delay:_0x3ce676,variables:_0x3e5003}=_0x4f5ada[_0x17e221(0x240)],_0x1be0e0=await getCampaign(_0x5dff6e),_0x527b15=await getContact(_0x2eea32),_0x1404ad={};_0x1404ad['number']=_0x527b15[_0x17e221(0x13a)],_0x1404ad['contactId']=_0x2eea32,_0x1404ad[_0x17e221(0x1af)]=_0x5dff6e;const _0x4af02a=getCampaignValidMessages(_0x1be0e0);console['log'](_0x4af02a['length']);if(_0x4af02a['length']>=0x0){const _0x23033b=randomValue(0x0,_0x4af02a['length']),_0x5a3037=getProcessedMessage(_0x4af02a[_0x23033b]||'',_0x3e5003,_0x527b15);_0x1404ad[_0x17e221(0x1ae)]=_0x5a3037===null?'':'‌\x20'+_0x5a3037;}if(_0x1be0e0[_0x17e221(0x1a3)]){const _0x3c58f8=getCampaignValidConfirmationMessages(_0x1be0e0);if(_0x3c58f8['length']){const _0x4188b4=randomValue(0x0,_0x3c58f8[_0x17e221(0x17f)]),_0x114d9e=getProcessedMessage(_0x3c58f8[_0x4188b4]||'',_0x3e5003,_0x527b15);_0x1404ad[_0x17e221(0x15a)]='‌\x20'+_0x114d9e;}}const [_0x5c01f1,_0x288a0b]=await CampaignShipping_1[_0x17e221(0x22b)][_0x17e221(0x197)]({'where':{'campaignId':_0x1404ad[_0x17e221(0x1af)],'contactId':_0x1404ad[_0x17e221(0x166)]},'defaults':_0x1404ad});!_0x288a0b&&_0x5c01f1[_0x17e221(0x1c8)]===null&&_0x5c01f1[_0x17e221(0x214)]===null&&(_0x5c01f1['set'](_0x1404ad),await _0x5c01f1['save']());if(_0x5c01f1[_0x17e221(0x1c8)]===null&&_0x5c01f1[_0x17e221(0x214)]===null){const _0x5de08e=await exports[_0x17e221(0x22d)][_0x17e221(0x15d)](_0x17e221(0x1a0),{'campaignId':_0x1be0e0['id'],'campaignShippingId':_0x5c01f1['id'],'contactListItemId':_0x2eea32},{'delay':_0x3ce676});await _0x5c01f1[_0x17e221(0x1ac)]({'jobId':_0x5de08e['id']});}await verifyAndFinalizeCampaign(_0x1be0e0);}catch(_0x3fb9f7){Sentry[_0x17e221(0x145)](_0x3fb9f7),logger_1[_0x17e221(0x23a)][_0x17e221(0x1da)](_0x17e221(0x1bc)+_0x3fb9f7['message']);}}async function handleDispatchCampaign(_0x2ee011){const _0x3db5a1=a353_0x3f62f7;try{const {data:_0x3942e5}=_0x2ee011,{campaignShippingId:_0x2e6ca3,campaignId:_0xc0cb2d}=_0x3942e5,_0xe626b6=await getCampaign(_0xc0cb2d),_0x42385b=await(0x0,GetWhatsappWbot_1[_0x3db5a1(0x22b)])(_0xe626b6[_0x3db5a1(0x151)]);if(!_0x42385b){logger_1[_0x3db5a1(0x23a)][_0x3db5a1(0x1da)](_0x3db5a1(0x137));return;}if(!_0xe626b6['whatsapp']){logger_1[_0x3db5a1(0x23a)][_0x3db5a1(0x1da)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0x42385b?.[_0x3db5a1(0x164)]?.['id']){logger_1[_0x3db5a1(0x23a)]['error'](_0x3db5a1(0x144));return;}logger_1['logger'][_0x3db5a1(0x1e5)](_0x3db5a1(0x1bf)+_0xc0cb2d+_0x3db5a1(0x220)+_0x2e6ca3);const _0x513293=await CampaignShipping_1[_0x3db5a1(0x22b)][_0x3db5a1(0x16b)](_0x2e6ca3,{'include':[{'model':ContactListItem_1[_0x3db5a1(0x22b)],'as':_0x3db5a1(0x237)}]}),_0x5473b5=_0x513293[_0x3db5a1(0x237)][_0x3db5a1(0x1d7)]?_0x513293['number']+_0x3db5a1(0x1a9):_0x513293[_0x3db5a1(0x13a)]+_0x3db5a1(0x23f);if(_0xe626b6[_0x3db5a1(0x1ce)]===_0x3db5a1(0x1ef)){const _0x5f43b9=await Contact_1[_0x3db5a1(0x22b)][_0x3db5a1(0x1b0)]({'where':{'number':_0x513293[_0x3db5a1(0x13a)]}}),_0x256cdb=await Whatsapp_1[_0x3db5a1(0x22b)]['findByPk'](_0xe626b6[_0x3db5a1(0x156)]),_0x3655de=await CompaniesSettings_1['default']['findOne']({'where':{'companyId':_0xe626b6['companyId']}}),{ticket:_0x3411ea}=await(0x0,FindOrCreateTicketService_1[_0x3db5a1(0x22b)])(_0x5f43b9,_0x256cdb,0x1,_0xe626b6['companyId'],_0xe626b6?.[_0x3db5a1(0x162)],_0xe626b6?.[_0x3db5a1(0x1f0)],null,_0x3db5a1(0x151),![],![],_0x3655de,![],!![]);if(_0xe626b6[_0x3db5a1(0x1a3)]&&_0x513293[_0x3db5a1(0x1a3)]===null)await _0x42385b[_0x3db5a1(0x1fc)](_0x5473b5,{'text':_0x513293[_0x3db5a1(0x15a)]}),await _0x513293['update']({'confirmationRequestedAt':(0x0,moment_1[_0x3db5a1(0x22b)])()});else{await _0x42385b['sendMessage'](_0x5473b5,{'text':_0x513293['message']});if(_0xe626b6[_0x3db5a1(0x216)]){const _0x351fe1=path_1[_0x3db5a1(0x22b)]['resolve'](__dirname,'..',_0x3db5a1(0x1fa)),_0x5dede8=path_1[_0x3db5a1(0x22b)][_0x3db5a1(0x200)](_0x351fe1,_0x3db5a1(0x139)+_0xe626b6[_0x3db5a1(0x185)],_0xe626b6[_0x3db5a1(0x216)]),_0x46d5c9=await(0x0,SendWhatsAppMedia_1[_0x3db5a1(0x21c)])(_0xe626b6['mediaName'],_0x5dede8,_0xe626b6[_0x3db5a1(0x185)][_0x3db5a1(0x1f1)](),null);if(Object['keys'](_0x46d5c9)[_0x3db5a1(0x17f)]){const _0x20b34d=await _0x42385b['sendMessage'](_0x5473b5,{..._0x46d5c9});await(0x0,wbotMessageListener_1['verifyMediaMessage'])(_0x20b34d,_0x3411ea,_0x3411ea[_0x3db5a1(0x237)]);}}}_0xe626b6?.['statusTicket']===_0x3db5a1(0x1ee)&&await _0x3411ea[_0x3db5a1(0x1ac)]({'status':_0x3db5a1(0x1ee)}),await _0x513293[_0x3db5a1(0x1ac)]({'deliveredAt':(0x0,moment_1[_0x3db5a1(0x22b)])()});}else{if(_0xe626b6[_0x3db5a1(0x1a3)]&&_0x513293[_0x3db5a1(0x1a3)]===null)await _0x42385b['sendMessage'](_0x5473b5,{'text':_0x513293['confirmationMessage']}),await _0x513293[_0x3db5a1(0x1ac)]({'confirmationRequestedAt':(0x0,moment_1['default'])()});else{await _0x42385b[_0x3db5a1(0x1fc)](_0x5473b5,{'text':_0x513293['message']});if(_0xe626b6[_0x3db5a1(0x216)]){const _0x437d47=path_1[_0x3db5a1(0x22b)]['resolve'](__dirname,'..','public'),_0x434232=path_1['default'][_0x3db5a1(0x200)](_0x437d47,_0x3db5a1(0x139)+_0xe626b6[_0x3db5a1(0x185)],_0xe626b6[_0x3db5a1(0x216)]),_0x39fd86=await(0x0,SendWhatsAppMedia_1[_0x3db5a1(0x21c)])(_0xe626b6[_0x3db5a1(0x1fd)],_0x434232,_0xe626b6[_0x3db5a1(0x185)][_0x3db5a1(0x1f1)](),null);Object[_0x3db5a1(0x1e3)](_0x39fd86)[_0x3db5a1(0x17f)]&&await _0x42385b[_0x3db5a1(0x1fc)](_0x5473b5,{..._0x39fd86});}}await _0x513293[_0x3db5a1(0x1ac)]({'deliveredAt':(0x0,moment_1[_0x3db5a1(0x22b)])()});}await verifyAndFinalizeCampaign(_0xe626b6);const _0x165e72=(0x0,socket_1[_0x3db5a1(0x233)])();_0x165e72['emit'](_0x3db5a1(0x14a)+_0xe626b6['companyId']+_0x3db5a1(0x23b),{'action':_0x3db5a1(0x1ac),'record':_0xe626b6}),logger_1['logger'][_0x3db5a1(0x1e5)]('Campanha\x20enviada\x20para:\x20Campanha='+_0xc0cb2d+_0x3db5a1(0x141)+_0x513293['contact']['name']);}catch(_0x26bd47){Sentry['captureException'](_0x26bd47),logger_1[_0x3db5a1(0x23a)]['error'](_0x26bd47[_0x3db5a1(0x1ae)]),console[_0x3db5a1(0x1a7)](_0x26bd47[_0x3db5a1(0x17d)]);}}async function handleLoginStatus(_0x589d31){const _0x56c266=a353_0x3f62f7,_0x422315=await database_1['default'][_0x56c266(0x1ad)](_0x56c266(0x1ba),{'type':sequelize_1[_0x56c266(0x13f)][_0x56c266(0x229)]}),_0x203284=_0x422315['map'](_0x2fd140=>_0x2fd140['id']),_0x2686cd=_0x203284[_0x56c266(0x200)](',\x20');try{const _0x1fce3e=_0x56c266(0x1de)+_0x2686cd+');',_0x12e565=await database_1['default'][_0x56c266(0x1ad)](_0x1fce3e,{'type':sequelize_1[_0x56c266(0x13f)][_0x56c266(0x206)]});}catch(_0x251b29){Sentry[_0x56c266(0x145)](_0x251b29);}}async function handleResumeTicketsOutOfHour(_0x1011b9){const _0x284795=a353_0x3f62f7;try{const _0x30d8e6=await Company_1[_0x284795(0x22b)][_0x284795(0x22f)]({'attributes':['id',_0x284795(0x1f9)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x284795(0x22b)],'attributes':['id','name',_0x284795(0x1cc),_0x284795(0x1a2),_0x284795(0x196)]}]});_0x30d8e6[_0x284795(0x19c)](async _0x42039a=>{const _0x4557b4=_0x284795;_0x42039a[_0x4557b4(0x1ec)]['map'](async _0x54b656=>{const _0x178d10=_0x4557b4;if(_0x54b656[_0x178d10(0x1cc)]==='CONNECTED'){var _0x18eee9=_0x42039a['id'];const _0x157c6d=_0x54b656[_0x178d10(0x1a2)]?_0x54b656[_0x178d10(0x1a2)]:0x0,_0x9327af=_0x54b656[_0x178d10(0x196)],_0x4ac6ef=_0x157c6d,_0x294049=_0x9327af,_0x45226d=_0x4ac6ef;if(_0x157c6d>0x0){if(!isNaN(_0x294049)&&Number[_0x178d10(0x1be)](_0x294049)&&!isNaN(_0x45226d)&&Number[_0x178d10(0x1be)](_0x45226d)){const _0x3f2c64=(0x0,moment_1[_0x178d10(0x22b)])()[_0x178d10(0x168)](_0x45226d,_0x178d10(0x23d))[_0x178d10(0x218)]()[_0x178d10(0x16f)](),{count:_0x2d42de,rows:_0x157704}=await Ticket_1[_0x178d10(0x22b)][_0x178d10(0x143)]({'attributes':['id'],'where':{'status':_0x178d10(0x1d4),'queueId':null,'companyId':_0x18eee9,'whatsappId':_0x54b656['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x3f2c64}},'include':[{'model':Contact_1[_0x178d10(0x22b)],'as':'contact','attributes':['id',_0x178d10(0x1f9),_0x178d10(0x13a),'email',_0x178d10(0x17c),'acceptAudioMessage',_0x178d10(0x215),'disableBot',_0x178d10(0x181),_0x178d10(0x1d1),'companyId'],'include':['extraInfo',_0x178d10(0x245),_0x178d10(0x152)]},{'model':Queue_2[_0x178d10(0x22b)],'as':_0x178d10(0x188),'attributes':['id','name',_0x178d10(0x19e)]},{'model':Whatsapp_1[_0x178d10(0x22b)],'as':_0x178d10(0x151),'attributes':['id','name','expiresTicket',_0x178d10(0x1b6)]}]});_0x2d42de>0x0&&_0x157704[_0x178d10(0x19c)](async _0x7b322f=>{const _0x16629b=_0x178d10;await _0x7b322f[_0x16629b(0x1ac)]({'queueId':_0x294049}),await _0x7b322f['reload']();const _0x3d3c5e=(0x0,socket_1[_0x16629b(0x233)])();_0x3d3c5e['to'](_0x7b322f['status'])['to'](_0x16629b(0x179))['to'](_0x7b322f['id']['toString']())[_0x16629b(0x1f2)](_0x16629b(0x14a)+_0x18eee9+_0x16629b(0x1c7),{'action':_0x16629b(0x1ac),'ticket':_0x7b322f,'ticketId':_0x7b322f['id']}),logger_1[_0x16629b(0x23a)][_0x16629b(0x1e5)]('Atendimento\x20Perdido:\x20'+_0x7b322f['id']+'\x20-\x20Empresa:\x20'+_0x18eee9);});}else logger_1[_0x178d10(0x23a)][_0x178d10(0x1e5)]('Condição\x20não\x20respeitada\x20-\x20Empresa:\x20'+_0x18eee9);}}});});}catch(_0x506d51){Sentry[_0x284795(0x145)](_0x506d51),logger_1[_0x284795(0x23a)][_0x284795(0x1da)](_0x284795(0x204),_0x506d51[_0x284795(0x1ae)]);throw _0x506d51;}};async function handleVerifyQueue(_0x4f62dc){const _0x3a355b=a353_0x3f62f7;try{const _0x551e46=await Company_1[_0x3a355b(0x22b)]['findAll']({'attributes':['id',_0x3a355b(0x1f9)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x3a355b(0x22b)],'attributes':['id','name',_0x3a355b(0x1cc),'timeSendQueue',_0x3a355b(0x196)]}]});_0x551e46['map'](async _0x4190f5=>{_0x4190f5['whatsapps']['map'](async _0x523b70=>{const _0x2c7664=a353_0x2666;if(_0x523b70[_0x2c7664(0x1cc)]===_0x2c7664(0x19f)){var _0x4ecdc2=_0x4190f5['id'];const _0x419775=_0x523b70[_0x2c7664(0x1a2)]?_0x523b70[_0x2c7664(0x1a2)]:0x0,_0xfef7a7=_0x523b70[_0x2c7664(0x196)],_0x44cc40=_0x419775,_0x597715=_0xfef7a7,_0x532a2a=_0x44cc40;if(_0x419775>0x0){if(!isNaN(_0x597715)&&Number['isInteger'](_0x597715)&&!isNaN(_0x532a2a)&&Number[_0x2c7664(0x1be)](_0x532a2a)){const _0x3f9cc5=(0x0,moment_1[_0x2c7664(0x22b)])()[_0x2c7664(0x168)](_0x532a2a,_0x2c7664(0x23d))['utc']()[_0x2c7664(0x16f)](),{count:_0x2d4010,rows:_0x394a9d}=await Ticket_1[_0x2c7664(0x22b)]['findAndCountAll']({'attributes':['id'],'where':{'status':_0x2c7664(0x1d4),'queueId':null,'companyId':_0x4ecdc2,'whatsappId':_0x523b70['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x3f9cc5}},'include':[{'model':Contact_1[_0x2c7664(0x22b)],'as':_0x2c7664(0x237),'attributes':['id',_0x2c7664(0x1f9),'number',_0x2c7664(0x13d),'profilePicUrl','acceptAudioMessage',_0x2c7664(0x215),_0x2c7664(0x20e),'urlPicture',_0x2c7664(0x1d1),_0x2c7664(0x185)],'include':['extraInfo','contactTags',_0x2c7664(0x152)]},{'model':Queue_2[_0x2c7664(0x22b)],'as':_0x2c7664(0x188),'attributes':['id',_0x2c7664(0x1f9),_0x2c7664(0x19e)]},{'model':Whatsapp_1[_0x2c7664(0x22b)],'as':_0x2c7664(0x151),'attributes':['id',_0x2c7664(0x1f9),_0x2c7664(0x16e),_0x2c7664(0x1b6)]}]});_0x2d4010>0x0&&_0x394a9d['map'](async _0xdf117c=>{const _0x1a717f=_0x2c7664;await _0xdf117c[_0x1a717f(0x1ac)]({'queueId':_0x597715}),await _0xdf117c[_0x1a717f(0x20d)]();const _0x364161=(0x0,socket_1['getIO'])();_0x364161['to'](_0xdf117c[_0x1a717f(0x1cc)])['to'](_0x1a717f(0x179))['to'](_0xdf117c['id'][_0x1a717f(0x1f1)]())[_0x1a717f(0x1f2)](_0x1a717f(0x14a)+_0x4ecdc2+_0x1a717f(0x1c7),{'action':_0x1a717f(0x1ac),'ticket':_0xdf117c,'ticketId':_0xdf117c['id']}),logger_1[_0x1a717f(0x23a)][_0x1a717f(0x1e5)](_0x1a717f(0x1cf)+_0xdf117c['id']+_0x1a717f(0x217)+_0x4ecdc2);});}else logger_1[_0x2c7664(0x23a)][_0x2c7664(0x1e5)](_0x2c7664(0x212)+_0x4ecdc2);}}});});}catch(_0x29072c){Sentry['captureException'](_0x29072c),logger_1['logger'][_0x3a355b(0x1da)](_0x3a355b(0x204),_0x29072c['message']);throw _0x29072c;}}function a353_0x2436(){const _0x41ceab=['timeSendQueue','confirmation','resume','Mensagem\x20agendada\x20enviada\x20para:\x20','__importStar','log','parse','@g.us','confirmationMessage2','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','update','query','message','campaignId','findOne','./models/Campaign','./services/TicketServices/UpdateTicketService','./models/CompaniesSettings','Sleep\x20de\x20','./models/Company','groupAsTicket',',\x20hora\x20atual\x20','./models/Queue','@sentry/node','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','verify','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','message4','isInteger','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=',',\x20Delay\x20Inicial=','Campanhas\x20encontradas:\x20','message2','isEmpty','{numero}','./models/Whatsapp','ProcessCampaign','-ticket','deliveredAt','GetWhatsapp','sabado','verify-queue','status','49rkmnnj','openTicket','Atendimento\x20Perdido:\x20','./models/Schedule','lgpdAcceptedAt','message1','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','pending','./helpers/GetWhatsappWbot','{nome}','isGroup','./models/Ticket','all','error','messageInterval','PrepareContact','parseToMilliseconds','UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20(','diff','random','configurable','{email}','keys','hasOwnProperty','info','process','Envio\x20inicia\x20as\x20','sendScheduledMessages','./models/ContactListItem','greaterInterval','completed','whatsapps','Ticket\x20ID\x20','closed','enabled','userId','toString','emit','\x20não\x20está\x20dentro\x20do\x20horário','REDIS_OPT_LIMITER_MAX','scheduleMonitor','includes','body','HH:mm','name','public','SendSacheduledMessages','sendMessage','mediaName','writable','create','join','HH:mm:ss','VerifyQueueStatus','CronJob','SearchForQueue\x20->\x20VerifyQueue:\x20error','\x20segundos\x20iniciado:\x20','UPDATE','MessageQueue','CampaignQueue','./services/TicketServices/FindOrCreateTicketService','./services/WbotServices/SendWhatsAppMedia','isNil','./services/TicketServices/ShowTicketService','reload','disableBot','\x20segundos\x20finalizado:\x20','VerifyLoginStatus','online','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','SendMessage','confirmationRequestedAt','active','mediaPath','\x20-\x20Empresa:\x20','utc','./libs/socket','day','*/5\x20*\x20*\x20*\x20*\x20*','getMessageOptions','randomValue','defineProperty','1343165ndZvNq',';Registro=','1299724XhHvtM','nodemailer','ClosedAllOpenTickets\x20->\x20Verify:\x20error','value','MessageQueue\x20->\x20SendMessage:\x20error','364023qeWUJy','./models/CampaignShipping','__esModule','SELECT','message3','default','variables','campaignQueue','./services/ContactServices/ShowContactService','findAll','SendScheduledMessage\x20->\x20Verify:\x20error','contacts','*/1\x20*\x20*\x20*\x20*','getIO','4nNviLZ','confirmationMessage1','date-fns','contact','get','./services/WbotServices/wbotMessageListener','logger','-campaign','isArray','minutes','delayed','@s.whatsapp.net','data','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','confirmationMessage3','moment','verify-login','contactTags','floor','queueMonitor','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','tempoRoteador','company','number','./helpers/GetWhatsapp','\x20e\x20termina\x20as\x20','email','./models/UserQueue','QueryTypes','count',';Contato=','domingo','findAndCountAll','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','captureException','confirmationMessage4','./models/User','REDIS_OPT_LIMITER_DURATION','Verify','company-','env','false','824130rOFdaF','Whatsapp\x20não\x20identificado','310xwLxSM','./services/WbotServices/SendWhatsAppMessage','whatsapp','tags','./models/CampaignSetting','getOwnPropertyDescriptor','scheduledAt','whatsappId','YYYY-MM-DD\x20HH:mm:ss','./helpers/GetDefaultWhatsApp','longerIntervalAfter','confirmationMessage','lte','startHour','add','filter','SendScheduledMessage\x20->\x20SendMessage:\x20error','*/20\x20*\x20*\x20*\x20*\x20*','confirmationMessage5','queueId','stop','user','verify-campaing','contactId','*\x20*\x20*\x20*\x20*','subtract','toDate','start','findByPk','messageQueue','and','expiresTicket','format','updatedAt','‎\x20*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','QueueMonitor','3BJpifv','push','355496QvdslU','America/Sao_Paulo','replace','profile','notification','message5','failed','profilePicUrl','stack','prototype','length','AGENDADA','urlPicture','*\x2015\x203\x20*\x20*\x20*','Iniciando\x20processamento\x20de\x20filas','key','companyId','addSeconds','./services/WbotServices/wbotClosedTickets','queue','./database','ERRO','108132CQZhAv','lodash','endHour','forEach','call','VerifyCampaignsDaatabase','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','16123591gzxtFS','pause','cron','./helpers/SendMessage','sendIdQueue','findOrCreate','__importDefault','contactList','ScheduleMonitor','ClosedAllOpenTickets','map','clean','color','CONNECTED','DispatchCampaign','__setModuleDefault'];a353_0x2436=function(){return _0x41ceab;};return a353_0x2436();};async function handleRandomUser(){const _0x7c41d2=a353_0x3f62f7,_0x1a0d32=new CronJob(_0x7c41d2(0x21b),async()=>{const _0xfe1a49=_0x7c41d2;try{const {count:_0x371e83,rows:_0x3fdcd6}=await Ticket_1[_0xfe1a49(0x22b)][_0xfe1a49(0x143)]({'where':{'status':_0xfe1a49(0x1d4),[sequelize_1['Op'][_0xfe1a49(0x16d)]]:[{'queueId':{[sequelize_1['Op']['ne']]:null}},{'queueId':{[sequelize_1['Op']['ne']]:0x0}}],'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0xfe1a49(0x22b)],'as':_0xfe1a49(0x188)}]}),_0x2baab8=_0x302dd5=>{const _0x59382d=_0xfe1a49,_0x3c9b11=Math[_0x59382d(0x246)](Math[_0x59382d(0x1e0)]()*_0x302dd5[_0x59382d(0x17f)]);return _0x302dd5[_0x3c9b11];},_0x534730=async _0x505dc2=>{const _0x1f77b3=_0xfe1a49;try{const _0x1e5dc5=await User_1[_0x1f77b3(0x22b)][_0x1f77b3(0x1b0)]({'where':{'id':_0x505dc2}});return _0x1e5dc5[_0x1f77b3(0x178)]===_0x1f77b3(0x164)?_0x1e5dc5[_0x1f77b3(0x211)]===!![]?_0x1e5dc5['id']:0x0:0x0;}catch(_0x3a9a90){Sentry[_0x1f77b3(0x145)](_0x3a9a90),logger_1[_0x1f77b3(0x23a)][_0x1f77b3(0x1da)](_0x1f77b3(0x1d3),_0x3a9a90[_0x1f77b3(0x1ae)]);throw _0x3a9a90;}};if(_0x371e83>0x0)for(const _0x5ae1f2 of _0x3fdcd6){const {queue:_0x176973,queueId:_0x50cd25,userId:_0x5291a6}=_0x5ae1f2,_0x3fec4c=_0x176973[_0xfe1a49(0x138)],_0x148457=await UserQueue_1[_0xfe1a49(0x22b)]['findAll']({'where':{'queueId':_0x50cd25}}),_0x28c909=await(0x0,ShowContactService_1[_0xfe1a49(0x22b)])(_0x5ae1f2[_0xfe1a49(0x166)],_0x5ae1f2[_0xfe1a49(0x185)]),_0x2839fd=_0x148457['map'](_0x45d8f1=>_0x45d8f1[_0xfe1a49(0x1f0)]),_0x3196f2=(0x0,moment_1[_0xfe1a49(0x22b)])()[_0xfe1a49(0x168)](_0x3fec4c,_0xfe1a49(0x23d))[_0xfe1a49(0x218)]()[_0xfe1a49(0x169)](),_0x1e53e6=new Date(_0x5ae1f2[_0xfe1a49(0x170)]);let _0x220bc3=await CompaniesSettings_1[_0xfe1a49(0x22b)][_0xfe1a49(0x1b0)]({'where':{'companyId':_0x5ae1f2[_0xfe1a49(0x185)]}});const _0x1afd88=_0x220bc3['sendGreetingMessageOneQueues']==='enabled'||![];if(!_0x5291a6){const _0x39a3bc=_0x2baab8(_0x2839fd);if(await _0x534730(_0x39a3bc)>0x0){if(_0x1afd88){const _0x2a3ff1=await(0x0,ShowTicketService_1[_0xfe1a49(0x22b)])(_0x5ae1f2['id'],_0x5ae1f2[_0xfe1a49(0x185)]);await(0x0,SendWhatsAppMessage_1[_0xfe1a49(0x22b)])({'body':_0xfe1a49(0x171),'ticket':_0x2a3ff1});}await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0xfe1a49(0x1d4),'userId':_0x39a3bc},'ticketId':_0x5ae1f2['id'],'companyId':_0x5ae1f2[_0xfe1a49(0x185)]}),logger_1['logger']['info'](_0xfe1a49(0x1ed)+_0x5ae1f2['id']+'\x20updated\x20with\x20UserId\x20'+_0x39a3bc+'\x20-\x20'+_0x5ae1f2[_0xfe1a49(0x170)]);}else{}}else{if(_0x2839fd[_0xfe1a49(0x1f6)](_0x5291a6)){if(_0x3196f2>_0x1e53e6){const _0x51d9e5=_0x2839fd[_0xfe1a49(0x15e)](_0x30a7bc=>_0x30a7bc!==_0x5291a6);if(_0x51d9e5[_0xfe1a49(0x17f)]>0x0){const _0x5365f7=_0x2baab8(_0x51d9e5);if(await _0x534730(_0x5365f7)>0x0){if(_0x1afd88){const _0x559dbc=await(0x0,ShowTicketService_1[_0xfe1a49(0x22b)])(_0x5ae1f2['id'],_0x5ae1f2[_0xfe1a49(0x185)]);await(0x0,SendWhatsAppMessage_1[_0xfe1a49(0x22b)])({'body':'*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','ticket':_0x559dbc});};await(0x0,UpdateTicketService_1[_0xfe1a49(0x22b)])({'ticketData':{'status':_0xfe1a49(0x1d4),'userId':_0x5365f7},'ticketId':_0x5ae1f2['id'],'companyId':_0x5ae1f2['companyId']}),await _0x5ae1f2[_0xfe1a49(0x20d)]();}else{}}else{}}else{}}else{}}}}catch(_0x3ae24d){Sentry['captureException'](_0x3ae24d),logger_1['logger']['error'](_0xfe1a49(0x1d3),_0x3ae24d[_0xfe1a49(0x1ae)]);throw _0x3ae24d;}});_0x1a0d32[_0x7c41d2(0x16a)]();}async function handleCloseTicketsAutomatic(){const _0x5044a7=a353_0x3f62f7,_0x6e7e03=new CronJob(_0x5044a7(0x232),async()=>{const _0x10b95d=_0x5044a7,_0x4062f7=await Company_1[_0x10b95d(0x22b)][_0x10b95d(0x22f)]();_0x4062f7[_0x10b95d(0x19c)](async _0x53a51c=>{const _0x567b35=_0x10b95d;try{const _0x563fc5=_0x53a51c['id'];await(0x0,wbotClosedTickets_1[_0x567b35(0x19b)])(_0x563fc5);}catch(_0x1bb264){Sentry['captureException'](_0x1bb264),logger_1['logger'][_0x567b35(0x1da)](_0x567b35(0x223),_0x1bb264[_0x567b35(0x1ae)]);throw _0x1bb264;}});});_0x6e7e03['start']();}async function handleWhatsapp(){const _0x290056=a353_0x3f62f7,_0x29d67e=new CronJob(_0x290056(0x182),async()=>{const _0x23485a=_0x290056;(0x0,GetWhatsapp_1[_0x23485a(0x1c9)])(),_0x29d67e[_0x23485a(0x163)]();},null,![],_0x290056(0x176));_0x29d67e[_0x290056(0x16a)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x143580=a353_0x3f62f7;logger_1[_0x143580(0x23a)][_0x143580(0x1e5)](_0x143580(0x183)),exports[_0x143580(0x16c)][_0x143580(0x1e6)](_0x143580(0x213),handleSendMessage),exports[_0x143580(0x1f5)][_0x143580(0x1e6)](_0x143580(0x149),handleVerifySchedules),exports[_0x143580(0x1e8)][_0x143580(0x1e6)](_0x143580(0x213),handleSendScheduledMessage),exports['campaignQueue'][_0x143580(0x1e6)](_0x143580(0x190),handleVerifyCampaigns),exports[_0x143580(0x22d)][_0x143580(0x1e6)](_0x143580(0x1c6),handleProcessCampaign),exports[_0x143580(0x22d)][_0x143580(0x1e6)](_0x143580(0x1dc),handlePrepareContact),exports['campaignQueue'][_0x143580(0x1e6)](_0x143580(0x1a0),handleDispatchCampaign),exports['userMonitor'][_0x143580(0x1e6)](_0x143580(0x210),handleLoginStatus),exports[_0x143580(0x247)]['process'](_0x143580(0x202),handleVerifyQueue),exports[_0x143580(0x1f5)][_0x143580(0x15d)](_0x143580(0x149),{},{'repeat':{'cron':_0x143580(0x21b),'key':_0x143580(0x1bb)},'removeOnComplete':!![]}),exports[_0x143580(0x22d)][_0x143580(0x15d)]('VerifyCampaignsDaatabase',{},{'repeat':{'cron':_0x143580(0x160),'key':_0x143580(0x165)},'removeOnComplete':!![]}),exports['userMonitor'][_0x143580(0x15d)](_0x143580(0x210),{},{'repeat':{'cron':_0x143580(0x167),'key':_0x143580(0x244)},'removeOnComplete':!![]}),exports['queueMonitor']['add'](_0x143580(0x202),{},{'repeat':{'cron':_0x143580(0x160),'key':_0x143580(0x1cb)},'removeOnComplete':!![]});}exports['startQueueProcess']=startQueueProcess;