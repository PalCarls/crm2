'use strict';const a337_0x3256f2=a337_0x3666;(function(_0x32da26,_0x14d415){const _0x10d007=a337_0x3666,_0x19f194=_0x32da26();while(!![]){try{const _0x53367b=parseInt(_0x10d007(0x153))/0x1*(parseInt(_0x10d007(0x13f))/0x2)+parseInt(_0x10d007(0x15b))/0x3*(-parseInt(_0x10d007(0x110))/0x4)+-parseInt(_0x10d007(0x10b))/0x5*(parseInt(_0x10d007(0x155))/0x6)+parseInt(_0x10d007(0xe1))/0x7*(-parseInt(_0x10d007(0xe7))/0x8)+parseInt(_0x10d007(0x18f))/0x9+parseInt(_0x10d007(0xea))/0xa*(parseInt(_0x10d007(0x1bb))/0xb)+parseInt(_0x10d007(0x18b))/0xc*(-parseInt(_0x10d007(0x11b))/0xd);if(_0x53367b===_0x14d415)break;else _0x19f194['push'](_0x19f194['shift']());}catch(_0x382b09){_0x19f194['push'](_0x19f194['shift']());}}}(a337_0x2b38,0x97fe1));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x3b7793,_0x585adc,_0x120a27,_0x4fb21a){const _0x5887cb=a337_0x3666;if(_0x4fb21a===undefined)_0x4fb21a=_0x120a27;var _0x56276d=Object[_0x5887cb(0x10f)](_0x585adc,_0x120a27);(!_0x56276d||(_0x5887cb(0xcb)in _0x56276d?!_0x585adc[_0x5887cb(0x10c)]:_0x56276d[_0x5887cb(0xf5)]||_0x56276d['configurable']))&&(_0x56276d={'enumerable':!![],'get':function(){return _0x585adc[_0x120a27];}}),Object[_0x5887cb(0x1bc)](_0x3b7793,_0x4fb21a,_0x56276d);}:function(_0x1542ed,_0x1903b6,_0x501734,_0x101e6a){if(_0x101e6a===undefined)_0x101e6a=_0x501734;_0x1542ed[_0x101e6a]=_0x1903b6[_0x501734];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x221569,_0x3fed02){const _0x357a65=a337_0x3666;Object[_0x357a65(0x1bc)](_0x221569,_0x357a65(0x1b0),{'enumerable':!![],'value':_0x3fed02});}:function(_0x24d9bd,_0x4efded){_0x24d9bd['default']=_0x4efded;}),__importStar=this&&this[a337_0x3256f2(0x194)]||function(_0x3464ea){const _0x21ef73=a337_0x3256f2;if(_0x3464ea&&_0x3464ea[_0x21ef73(0x10c)])return _0x3464ea;var _0xa24eea={};if(_0x3464ea!=null){for(var _0x315714 in _0x3464ea)if(_0x315714!==_0x21ef73(0x1b0)&&Object[_0x21ef73(0x1be)]['hasOwnProperty'][_0x21ef73(0x19f)](_0x3464ea,_0x315714))__createBinding(_0xa24eea,_0x3464ea,_0x315714);}return __setModuleDefault(_0xa24eea,_0x3464ea),_0xa24eea;},__importDefault=this&&this['__importDefault']||function(_0x277cfc){const _0x2e6792=a337_0x3256f2;return _0x277cfc&&_0x277cfc[_0x2e6792(0x10c)]?_0x277cfc:{'default':_0x277cfc};};Object[a337_0x3256f2(0x1bc)](exports,a337_0x3256f2(0x10c),{'value':!![]}),exports[a337_0x3256f2(0x1a1)]=exports[a337_0x3256f2(0x118)]=exports['parseToMilliseconds']=exports[a337_0x3256f2(0x184)]=exports['queueMonitor']=exports[a337_0x3256f2(0xd7)]=exports['sendScheduledMessages']=exports[a337_0x3256f2(0x172)]=exports['userMonitor']=void 0x0;const Sentry=__importStar(require(a337_0x3256f2(0x140))),bull_1=__importDefault(require('bull')),SendMessage_1=require(a337_0x3256f2(0xd9)),Whatsapp_1=__importDefault(require('./models/Whatsapp')),logger_1=require(a337_0x3256f2(0x17d)),moment_1=__importDefault(require(a337_0x3256f2(0xf7))),Schedule_1=__importDefault(require(a337_0x3256f2(0x13a))),sequelize_1=require(a337_0x3256f2(0xdc)),GetDefaultWhatsApp_1=__importDefault(require(a337_0x3256f2(0x136))),Campaign_1=__importDefault(require('./models/Campaign')),Queue_1=__importDefault(require('./models/Queue')),ContactList_1=__importDefault(require('./models/ContactList')),ContactListItem_1=__importDefault(require(a337_0x3256f2(0x132))),lodash_1=require(a337_0x3256f2(0xdf)),CampaignSetting_1=__importDefault(require(a337_0x3256f2(0xe6))),CampaignShipping_1=__importDefault(require(a337_0x3256f2(0x122))),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require(a337_0x3256f2(0xfa))),SendWhatsAppMedia_1=require(a337_0x3256f2(0x1c1)),socket_1=require(a337_0x3256f2(0xe4)),path_1=__importDefault(require(a337_0x3256f2(0x13c))),User_1=__importDefault(require('./models/User')),Company_1=__importDefault(require('./models/Company')),Contact_1=__importDefault(require('./models/Contact')),Queue_2=__importDefault(require(a337_0x3256f2(0x18a))),wbotClosedTickets_1=require('./services/WbotServices/wbotClosedTickets'),Ticket_1=__importDefault(require(a337_0x3256f2(0xce))),ShowContactService_1=__importDefault(require(a337_0x3256f2(0x147))),UserQueue_1=__importDefault(require(a337_0x3256f2(0x117))),ShowTicketService_1=__importDefault(require(a337_0x3256f2(0x182))),SendWhatsAppMessage_1=__importDefault(require(a337_0x3256f2(0x1b1))),UpdateTicketService_1=__importDefault(require(a337_0x3256f2(0x120))),date_fns_1=require(a337_0x3256f2(0x107)),GetWhatsapp_1=require('./helpers/GetWhatsapp'),nodemailer=require('nodemailer'),CronJob=require(a337_0x3256f2(0x12f))[a337_0x3256f2(0x193)],axios_1=__importDefault(require(a337_0x3256f2(0x128))),CompaniesSettings_1=__importDefault(require('./models/CompaniesSettings')),wbotMessageListener_1=require(a337_0x3256f2(0x119)),FindOrCreateTicketService_1=__importDefault(require('./services/TicketServices/FindOrCreateTicketService')),connection=process[a337_0x3256f2(0x1b6)][a337_0x3256f2(0xec)]||'',limiterMax=process[a337_0x3256f2(0x1b6)][a337_0x3256f2(0x145)]||0x1,limiterDuration=process[a337_0x3256f2(0x1b6)][a337_0x3256f2(0x1a6)]||0xbb8;exports[a337_0x3256f2(0x1ba)]=new bull_1[(a337_0x3256f2(0x1b0))](a337_0x3256f2(0xdd),connection),exports[a337_0x3256f2(0x172)]=new bull_1['default'](a337_0x3256f2(0x143),connection),exports[a337_0x3256f2(0x111)]=new bull_1[(a337_0x3256f2(0x1b0))]('SendSacheduledMessages',connection),exports[a337_0x3256f2(0xd7)]=new bull_1[(a337_0x3256f2(0x1b0))](a337_0x3256f2(0x17f),connection),exports['queueMonitor']=new bull_1[(a337_0x3256f2(0x1b0))](a337_0x3256f2(0xd8),connection),exports[a337_0x3256f2(0x184)]=new bull_1[(a337_0x3256f2(0x1b0))]('MessageQueue',connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x29b938){const _0xb38e70=a337_0x3256f2;try{const {data:_0x2b28e9}=_0x29b938,_0x23e1a9=await Whatsapp_1[_0xb38e70(0x1b0)][_0xb38e70(0x144)](_0x2b28e9[_0xb38e70(0xd2)]);if(_0x23e1a9===null)throw Error(_0xb38e70(0x12a));const _0x31a5fa=_0x2b28e9[_0xb38e70(0x164)];await(0x0,SendMessage_1['SendMessage'])(_0x23e1a9,_0x31a5fa);}catch(_0x1e3e47){Sentry[_0xb38e70(0x14e)](_0x1e3e47),logger_1[_0xb38e70(0x19b)][_0xb38e70(0x131)](_0xb38e70(0x156),_0x1e3e47[_0xb38e70(0xeb)]);throw _0x1e3e47;}}async function handleVerifySchedules(_0x4ea118){const _0x4fa6eb=a337_0x3256f2;try{const {count:_0x570e8a,rows:_0x58627f}=await Schedule_1['default'][_0x4fa6eb(0xee)]({'where':{'status':_0x4fa6eb(0x142),'sentAt':null,'sendAt':{[sequelize_1['Op']['gte']]:(0x0,moment_1[_0x4fa6eb(0x1b0)])()[_0x4fa6eb(0x18d)](_0x4fa6eb(0xf4)),[sequelize_1['Op'][_0x4fa6eb(0x105)]]:(0x0,moment_1[_0x4fa6eb(0x1b0)])()[_0x4fa6eb(0x16d)]('30',_0x4fa6eb(0xe0))[_0x4fa6eb(0x18d)](_0x4fa6eb(0xf4))}},'include':[{'model':Contact_1[_0x4fa6eb(0x1b0)],'as':'contact'}]});_0x570e8a>0x0&&_0x58627f[_0x4fa6eb(0x1ac)](async _0x2f09d0=>{const _0xcadf23=_0x4fa6eb;await _0x2f09d0['update']({'status':_0xcadf23(0x17b)}),exports[_0xcadf23(0x111)][_0xcadf23(0x16d)]('SendMessage',{'schedule':_0x2f09d0},{'delay':0x9c40}),logger_1[_0xcadf23(0x19b)][_0xcadf23(0x125)](_0xcadf23(0x109)+_0x2f09d0[_0xcadf23(0x148)][_0xcadf23(0xf6)]);});}catch(_0x3b4b9e){Sentry[_0x4fa6eb(0x14e)](_0x3b4b9e),logger_1[_0x4fa6eb(0x19b)][_0x4fa6eb(0x131)]('SendScheduledMessage\x20->\x20Verify:\x20error',_0x3b4b9e[_0x4fa6eb(0xeb)]);throw _0x3b4b9e;}}async function handleSendScheduledMessage(_0x4ff341){const _0x971618=a337_0x3256f2,{data:{schedule:_0xf602cb}}=_0x4ff341;let _0x17234d=null;try{_0x17234d=await Schedule_1[_0x971618(0x1b0)][_0x971618(0x144)](_0xf602cb['id']);}catch(_0x596ea7){Sentry['captureException'](_0x596ea7),logger_1[_0x971618(0x19b)][_0x971618(0x125)](_0x971618(0xc8)+_0xf602cb['id']);}try{const _0x5150ae=await(0x0,GetDefaultWhatsApp_1[_0x971618(0x1b0)])(_0xf602cb['companyId']);console[_0x971618(0x1bd)](_0xf602cb);const _0x2249e0=await CompaniesSettings_1[_0x971618(0x1b0)]['findOne']({'where':{'companyId':_0xf602cb[_0x971618(0x158)]}}),{ticket:_0x14234c}=await(0x0,FindOrCreateTicketService_1[_0x971618(0x1b0)])(_0xf602cb[_0x971618(0x148)],_0x5150ae,0x1,_0xf602cb[_0x971618(0x158)],0x0,0x0,null,_0x971618(0x1b7),![],![],_0x2249e0),_0xb4cb7b=await(0x0,SendMessage_1[_0x971618(0x1ab)])(_0x5150ae,{'number':_0xf602cb[_0x971618(0x148)][_0x971618(0x18e)],'body':_0xf602cb[_0x971618(0x1bf)]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0xb4cb7b,_0x14234c,_0xf602cb[_0x971618(0x148)][_0x971618(0x18e)]),await _0x17234d?.[_0x971618(0x127)]({'sentAt':(0x0,moment_1[_0x971618(0x1b0)])()[_0x971618(0x18d)](_0x971618(0x11f)),'status':_0x971618(0x19d)}),logger_1[_0x971618(0x19b)][_0x971618(0x125)](_0x971618(0x191)+_0xf602cb[_0x971618(0x148)][_0x971618(0xf6)]),exports[_0x971618(0x111)][_0x971618(0x159)](0x3a98,_0x971618(0x168));}catch(_0x357ae4){Sentry['captureException'](_0x357ae4),await _0x17234d?.[_0x971618(0x127)]({'status':_0x971618(0x183)}),logger_1[_0x971618(0x19b)][_0x971618(0x131)](_0x971618(0x141),_0x357ae4['message']);throw _0x357ae4;}}async function handleVerifyCampaigns(_0x1de3f4){const _0x29c19e=a337_0x3256f2,_0x4da12c=await database_1[_0x29c19e(0x1b0)][_0x29c19e(0x16e)](_0x29c19e(0x133),{'type':sequelize_1[_0x29c19e(0xfe)][_0x29c19e(0x190)]});logger_1['logger']['info']('Campanhas\x20encontradas:\x20'+_0x4da12c['length']);for(let _0x62f65d of _0x4da12c){try{const _0x2a1ee8=(0x0,moment_1[_0x29c19e(0x1b0)])(),_0xd56a65=(0x0,moment_1[_0x29c19e(0x1b0)])(_0x62f65d[_0x29c19e(0x18c)]),_0x449679=_0xd56a65[_0x29c19e(0xda)](_0x2a1ee8,_0x29c19e(0x1a7));logger_1[_0x29c19e(0x19b)][_0x29c19e(0x125)]('Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha='+_0x62f65d['id']+',\x20Delay\x20Inicial='+_0x449679),exports[_0x29c19e(0xd7)][_0x29c19e(0x16d)](_0x29c19e(0x1a2),{'id':_0x62f65d['id'],'delay':_0x449679},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x2e0ffd){Sentry['captureException'](_0x2e0ffd);}}}async function getCampaign(_0xf7d682){const _0x5e7121=a337_0x3256f2;return await Campaign_1[_0x5e7121(0x1b0)][_0x5e7121(0xde)]({'where':{'id':_0xf7d682},'include':[{'model':ContactList_1['default'],'as':'contactList','attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x5e7121(0x1b0)],'as':'contacts','attributes':['id',_0x5e7121(0xf6),'number',_0x5e7121(0x15a),_0x5e7121(0x124)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x5e7121(0x1b0)],'as':_0x5e7121(0x1b7),'attributes':['id','name']}]});}async function getContact(_0x390f23){const _0x2dcc0c=a337_0x3256f2;return await ContactListItem_1[_0x2dcc0c(0x1b0)][_0x2dcc0c(0x144)](_0x390f23,{'attributes':['id',_0x2dcc0c(0xf6),_0x2dcc0c(0x18e),_0x2dcc0c(0x15a)]});}async function getSettings(_0x6640ef){const _0x3c1c46=a337_0x3256f2;try{const _0x47eb01=await CampaignSetting_1['default'][_0x3c1c46(0x187)]({'where':{'companyId':_0x6640ef[_0x3c1c46(0x158)]},'attributes':[_0x3c1c46(0x123),_0x3c1c46(0x180)]});let _0x2e8c37=0x14,_0x18a090=0x14,_0x5ee903=0x3c,_0x403652=[];return _0x47eb01[_0x3c1c46(0x115)](_0x4e33c3=>{const _0x1cb2ec=_0x3c1c46;_0x4e33c3['key']===_0x1cb2ec(0xd1)&&(_0x2e8c37=JSON[_0x1cb2ec(0x1a4)](_0x4e33c3[_0x1cb2ec(0x180)])),_0x4e33c3[_0x1cb2ec(0x123)]==='longerIntervalAfter'&&(_0x18a090=JSON['parse'](_0x4e33c3[_0x1cb2ec(0x180)])),_0x4e33c3['key']===_0x1cb2ec(0xd6)&&(_0x5ee903=JSON[_0x1cb2ec(0x1a4)](_0x4e33c3[_0x1cb2ec(0x180)])),_0x4e33c3[_0x1cb2ec(0x123)]===_0x1cb2ec(0x1a0)&&(_0x403652=JSON[_0x1cb2ec(0x1a4)](_0x4e33c3[_0x1cb2ec(0x180)]));}),{'messageInterval':_0x2e8c37,'longerIntervalAfter':_0x18a090,'greaterInterval':_0x5ee903,'variables':_0x403652};}catch(_0x11425e){console['log'](_0x11425e);throw _0x11425e;}}function parseToMilliseconds(_0x56bc3b){return _0x56bc3b*0x3e8;}function a337_0x2b38(){const _0xd70b6f=['queueId','./libs/socket','isArray','./models/CampaignSetting','152ZHVcOA','isNil','queue','30PSKwle','message','REDIS_URI','sendMessage','findAndCountAll','mediaPath','not','ClosedAllOpenTickets','UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20(','verify-campaing','YYYY-MM-DD\x20HH:mm:ss','writable','name','moment','confirmation','\x20-\x20Empresa:\x20','./database','findOrCreate','Buscando\x20atendimentos\x20perdidos\x20nas\x20filas','\x20usuarios\x20passados\x20para\x20offline','QueryTypes','isInteger','userId','differenceInSeconds','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','confirmationMessage1','timeSendQueue','lte','SearchForQueue\x20->\x20VerifyQueue:\x20error','date-fns','Iniciando\x20processamento\x20de\x20filas','Disparo\x20agendado\x20para:\x20','whatsapps','5ZiDBas','__esModule','Sleep\x20de\x20','toDate','getOwnPropertyDescriptor','34324qGRXiO','sendScheduledMessages','minutes','*\x20*\x20*\x20*\x20*','closed','forEach','confirmationMessage4','./models/UserQueue','randomValue','./services/WbotServices/wbotMessageListener','queueMonitor','13YMgkSE','message3','message4','PrepareContact','YYYY-MM-DD\x20HH:mm','./services/TicketServices/UpdateTicketService','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','./models/CampaignShipping','key','isWhatsappValid','info','mediaName','update','axios','HH:mm:ss','Whatsapp\x20não\x20identificado','extraInfo','UPDATE','contactId','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','cron','Iniciando\x20a\x20randomização\x20dos\x20atendimentos...','error','./models/ContactListItem','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','join','https://checkip.amazonaws.com','./helpers/GetDefaultWhatsApp','statusTicket','Nenhum\x20atendimento\x20perdido\x20encontrado\x20-\x20Empresa:\x20','pending','./models/Schedule','{email}','path','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','confirmationMessage2','22hftqpj','@sentry/node','SendScheduledMessage\x20->\x20SendMessage:\x20error','PENDENTE','ScheduleMonitor','findByPk','REDIS_OPT_LIMITER_MAX','enabled','./services/ContactServices/ShowContactService','contact','-campaign','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','\x20-\x20','VerifyCampaignsDaatabase','confirmationMessage','captureException','sendIdQueue','*\x2015\x203\x20*\x20*\x20*','emit','public','83515uAsFBI','user','963750LTIdEI','MessageQueue\x20->\x20SendMessage:\x20error','message5','companyId','clean','email','33UXcGKP','start','color','groupAsTicket','campaignId','verifyMediaMessage','EM_ANDAMENTO','parseToMilliseconds','includes','data','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','getMessageOptions','{nome}','completed','USER','status','updatedAt','push','add','query','notification','*/5\x20*\x20*\x20*\x20*\x20*','resolve','scheduleMonitor','Ticket\x20ID\x20',';delay=','replace','isEmpty','filter','tempoRoteador','tags','stack','AGENDADA','sendGreetingMessageOneQueues','./utils/logger','company-','CampaignQueue','value','active','./services/TicketServices/ShowTicketService','ERRO','messageQueue','longerIntervalAfter','confirmationMessage3','findAll','America/Sao_Paulo','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','./models/Queue','11549364CllSFD','scheduledAt','format','number','11062935DARFCW','SELECT','Mensagem\x20agendada\x20enviada\x20para:\x20','confirmationRequestedAt','CronJob','__importStar','expiresTicket','confirmationMessage5','length','-ticket','VerifyLoginStatus','*/20\x20*\x20*\x20*\x20*\x20*','logger','company','ENVIADA','ADMIN','call','variables','startQueueProcess','ProcessCampaign',';Registro=','parse','*/1\x20*\x20*\x20*\x20*','REDIS_OPT_LIMITER_DURATION','milliseconds','CONNECTED','all','process','SendMessage','map','message1','Verify','toString','default','./services/WbotServices/SendWhatsAppMessage','profile','GetWhatsapp','DispatchCampaign','addSeconds','env','whatsapp','message2','\x20segundos\x20iniciado:\x20','userMonitor','926431SomEwE','defineProperty','log','prototype','body','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','./services/WbotServices/SendWhatsAppMedia','profilePicUrl','stop','set','reload','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','\x20updated\x20with\x20UserId\x20','deliveredAt','get',';Contato=','random','./models/Ticket','getIO','openTicket','messageInterval','whatsappId','Campanha\x20enviada\x20para:\x20Campanha=','subtract','keys','greaterInterval','campaignQueue','QueueMonitor','./helpers/SendMessage','diff','contactList','sequelize','UserMonitor','findOne','lodash','seconds','206507SNpZaa','count'];a337_0x2b38=function(){return _0xd70b6f;};return a337_0x2b38();}exports[a337_0x3256f2(0x162)]=parseToMilliseconds;async function sleep(_0x584bfa){const _0x3a87d4=a337_0x3256f2;return logger_1[_0x3a87d4(0x19b)][_0x3a87d4(0x125)](_0x3a87d4(0x10d)+_0x584bfa+_0x3a87d4(0x1b9)+(0x0,moment_1['default'])()[_0x3a87d4(0x18d)](_0x3a87d4(0x129))),new Promise(_0x263f4a=>{setTimeout(()=>{const _0x3de151=a337_0x3666;logger_1[_0x3de151(0x19b)][_0x3de151(0x125)](_0x3de151(0x10d)+_0x584bfa+'\x20segundos\x20finalizado:\x20'+(0x0,moment_1[_0x3de151(0x1b0)])()[_0x3de151(0x18d)](_0x3de151(0x129))),_0x263f4a(!![]);},parseToMilliseconds(_0x584bfa));});}function getCampaignValidMessages(_0x3c50c3){const _0x51edcf=a337_0x3256f2,_0x5534ca=[];return!(0x0,lodash_1[_0x51edcf(0x176)])(_0x3c50c3[_0x51edcf(0x1ad)])&&!(0x0,lodash_1[_0x51edcf(0xe8)])(_0x3c50c3[_0x51edcf(0x1ad)])&&_0x5534ca[_0x51edcf(0x16c)](_0x3c50c3[_0x51edcf(0x1ad)]),!(0x0,lodash_1[_0x51edcf(0x176)])(_0x3c50c3[_0x51edcf(0x1b8)])&&!(0x0,lodash_1[_0x51edcf(0xe8)])(_0x3c50c3[_0x51edcf(0x1b8)])&&_0x5534ca[_0x51edcf(0x16c)](_0x3c50c3[_0x51edcf(0x1b8)]),!(0x0,lodash_1[_0x51edcf(0x176)])(_0x3c50c3[_0x51edcf(0x11c)])&&!(0x0,lodash_1['isNil'])(_0x3c50c3[_0x51edcf(0x11c)])&&_0x5534ca[_0x51edcf(0x16c)](_0x3c50c3[_0x51edcf(0x11c)]),!(0x0,lodash_1[_0x51edcf(0x176)])(_0x3c50c3['message4'])&&!(0x0,lodash_1['isNil'])(_0x3c50c3['message4'])&&_0x5534ca[_0x51edcf(0x16c)](_0x3c50c3[_0x51edcf(0x11d)]),!(0x0,lodash_1[_0x51edcf(0x176)])(_0x3c50c3[_0x51edcf(0x157)])&&!(0x0,lodash_1[_0x51edcf(0xe8)])(_0x3c50c3[_0x51edcf(0x157)])&&_0x5534ca[_0x51edcf(0x16c)](_0x3c50c3[_0x51edcf(0x157)]),_0x5534ca;}function getCampaignValidConfirmationMessages(_0x5c0800){const _0xd8fd27=a337_0x3256f2,_0x4d0a8c=[];return!(0x0,lodash_1[_0xd8fd27(0x176)])(_0x5c0800[_0xd8fd27(0x103)])&&!(0x0,lodash_1[_0xd8fd27(0xe8)])(_0x5c0800[_0xd8fd27(0x103)])&&_0x4d0a8c[_0xd8fd27(0x16c)](_0x5c0800['confirmationMessage1']),!(0x0,lodash_1['isEmpty'])(_0x5c0800[_0xd8fd27(0x13e)])&&!(0x0,lodash_1[_0xd8fd27(0xe8)])(_0x5c0800[_0xd8fd27(0x13e)])&&_0x4d0a8c[_0xd8fd27(0x16c)](_0x5c0800['confirmationMessage2']),!(0x0,lodash_1[_0xd8fd27(0x176)])(_0x5c0800['confirmationMessage3'])&&!(0x0,lodash_1[_0xd8fd27(0xe8)])(_0x5c0800[_0xd8fd27(0x186)])&&_0x4d0a8c[_0xd8fd27(0x16c)](_0x5c0800[_0xd8fd27(0x186)]),!(0x0,lodash_1[_0xd8fd27(0x176)])(_0x5c0800[_0xd8fd27(0x116)])&&!(0x0,lodash_1['isNil'])(_0x5c0800[_0xd8fd27(0x116)])&&_0x4d0a8c[_0xd8fd27(0x16c)](_0x5c0800[_0xd8fd27(0x116)]),!(0x0,lodash_1['isEmpty'])(_0x5c0800[_0xd8fd27(0x196)])&&!(0x0,lodash_1[_0xd8fd27(0xe8)])(_0x5c0800[_0xd8fd27(0x196)])&&_0x4d0a8c['push'](_0x5c0800['confirmationMessage5']),_0x4d0a8c;}function getProcessedMessage(_0xed686c,_0x20be74,_0x2ca53b){const _0x31af77=a337_0x3256f2;let _0x3568c6=_0xed686c;return _0x3568c6[_0x31af77(0x163)](_0x31af77(0x167))&&(_0x3568c6=_0x3568c6[_0x31af77(0x175)](/{nome}/g,_0x2ca53b[_0x31af77(0xf6)])),_0x3568c6[_0x31af77(0x163)](_0x31af77(0x13b))&&(_0x3568c6=_0x3568c6[_0x31af77(0x175)](/{email}/g,_0x2ca53b[_0x31af77(0x15a)])),_0x3568c6[_0x31af77(0x163)]('{numero}')&&(_0x3568c6=_0x3568c6[_0x31af77(0x175)](/{numero}/g,_0x2ca53b[_0x31af77(0x18e)])),_0x20be74[_0x31af77(0x115)](_0xd30fd5=>{const _0x4cc95b=_0x31af77;if(_0x3568c6['includes']('{'+_0xd30fd5['key']+'}')){const _0x507e66=new RegExp('{'+_0xd30fd5['key']+'}','g');_0x3568c6=_0x3568c6[_0x4cc95b(0x175)](_0x507e66,_0xd30fd5[_0x4cc95b(0x180)]);}}),_0x3568c6;}function randomValue(_0x5758a3,_0xeebff4){const _0x55945f=a337_0x3256f2;return Math['floor'](Math[_0x55945f(0xcd)]()*_0xeebff4)+_0x5758a3;}exports[a337_0x3256f2(0x118)]=randomValue;async function verifyAndFinalizeCampaign(_0xa26cc6){const _0x392dc0=a337_0x3256f2,{contacts:_0x531215}=_0xa26cc6[_0x392dc0(0xdb)],_0x6efefb=_0x531215[_0x392dc0(0x197)],_0x8aaf05=await CampaignShipping_1[_0x392dc0(0x1b0)][_0x392dc0(0xe2)]({'where':{'campaignId':_0xa26cc6['id'],'deliveredAt':{[sequelize_1['Op'][_0x392dc0(0xf0)]]:null}}});_0x6efefb===_0x8aaf05&&await _0xa26cc6[_0x392dc0(0x127)]({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0x392dc0(0x1b0)])()});const _0x315e9f=(0x0,socket_1['getIO'])();_0x315e9f[_0x392dc0(0x151)](_0x392dc0(0x17e)+_0xa26cc6[_0x392dc0(0x158)]+_0x392dc0(0x149),{'action':'update','record':_0xa26cc6});}async function handleProcessCampaign(_0x2e940b){const _0x2f690a=a337_0x3256f2;try{const {id:_0x212274}=_0x2e940b[_0x2f690a(0x164)],_0x23d30e=await getCampaign(_0x212274),_0x444842=await getSettings(_0x23d30e);if(_0x23d30e){const {contacts:_0xb22e60}=_0x23d30e[_0x2f690a(0xdb)];if((0x0,lodash_1[_0x2f690a(0xe5)])(_0xb22e60)){const _0x1c860f=_0xb22e60[_0x2f690a(0x1ac)](_0x11a07c=>({'contactId':_0x11a07c['id'],'campaignId':_0x23d30e['id'],'variables':_0x444842['variables']})),_0x1e318e=parseToMilliseconds(_0x444842[_0x2f690a(0x185)]),_0x568bff=parseToMilliseconds(_0x444842[_0x2f690a(0xd6)]),_0x3e13ba=_0x444842['messageInterval'];let _0x36b8f5=_0x23d30e[_0x2f690a(0x18c)];const _0x3509b5=[];for(let _0x3263c5=0x0;_0x3263c5<_0x1c860f[_0x2f690a(0x197)];_0x3263c5++){_0x36b8f5=(0x0,date_fns_1[_0x2f690a(0x1b5)])(_0x36b8f5,_0x3263c5>_0x1e318e?_0x568bff:_0x3e13ba);const {contactId:_0x1c90f0,campaignId:_0x1d402d,variables:_0x989727}=_0x1c860f[_0x3263c5],_0x2495ce=calculateDelay(_0x3263c5,_0x36b8f5,_0x1e318e,_0x568bff,_0x3e13ba),_0x89f4c0=exports['campaignQueue'][_0x2f690a(0x16d)]('PrepareContact',{'contactId':_0x1c90f0,'campaignId':_0x1d402d,'variables':_0x989727,'delay':_0x2495ce},{'removeOnComplete':!![]});_0x3509b5['push'](_0x89f4c0),logger_1[_0x2f690a(0x19b)][_0x2f690a(0x125)]('Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha='+_0x23d30e['id']+';Contato='+_0xb22e60[_0x3263c5]['name']+_0x2f690a(0x174)+_0x2495ce);}await Promise[_0x2f690a(0x1a9)](_0x3509b5),await _0x23d30e[_0x2f690a(0x127)]({'status':_0x2f690a(0x161)});}}}catch(_0x445aea){Sentry['captureException'](_0x445aea);}}function calculateDelay(_0x430d89,_0x2a62a5,_0x1acdb6,_0x474571,_0x577c93){const _0x2c3b3f=a337_0x3256f2,_0xc10967=(0x0,date_fns_1[_0x2c3b3f(0x101)])(_0x2a62a5,new Date());return _0x430d89>_0x1acdb6?_0xc10967*0x3e8+_0x474571:_0xc10967*0x3e8+_0x577c93;}async function handlePrepareContact(_0x3f8888){const _0x2cc388=a337_0x3256f2;try{const {contactId:_0x1e73b3,campaignId:_0x44eef2,delay:_0x56c268,variables:_0x3b0529}=_0x3f8888[_0x2cc388(0x164)],_0x21d2ea=await getCampaign(_0x44eef2),_0x3b76d0=await getContact(_0x1e73b3),_0x12633b={};_0x12633b[_0x2cc388(0x18e)]=_0x3b76d0[_0x2cc388(0x18e)],_0x12633b[_0x2cc388(0x12d)]=_0x1e73b3,_0x12633b['campaignId']=_0x44eef2;const _0x53cef2=getCampaignValidMessages(_0x21d2ea);if(_0x53cef2[_0x2cc388(0x197)]){const _0x15c910=randomValue(0x0,_0x53cef2[_0x2cc388(0x197)]),_0x404d48=getProcessedMessage(_0x53cef2[_0x15c910],_0x3b0529,_0x3b76d0);_0x12633b['message']='‌\x20'+_0x404d48;}if(_0x21d2ea[_0x2cc388(0xf8)]){const _0x16a584=getCampaignValidConfirmationMessages(_0x21d2ea);if(_0x16a584[_0x2cc388(0x197)]){const _0x27c5c0=randomValue(0x0,_0x16a584['length']),_0xea7894=getProcessedMessage(_0x16a584[_0x27c5c0],_0x3b0529,_0x3b76d0);_0x12633b[_0x2cc388(0x14d)]='‌\x20'+_0xea7894;}}const [_0x328c7b,_0x3abebf]=await CampaignShipping_1[_0x2cc388(0x1b0)][_0x2cc388(0xfb)]({'where':{'campaignId':_0x12633b[_0x2cc388(0x15f)],'contactId':_0x12633b[_0x2cc388(0x12d)]},'defaults':_0x12633b});!_0x3abebf&&_0x328c7b[_0x2cc388(0xca)]===null&&_0x328c7b[_0x2cc388(0x192)]===null&&(_0x328c7b[_0x2cc388(0x1c4)](_0x12633b),await _0x328c7b['save']());if(_0x328c7b[_0x2cc388(0xca)]===null&&_0x328c7b[_0x2cc388(0x192)]===null){const _0x35de70=await exports['campaignQueue']['add']('DispatchCampaign',{'campaignId':_0x21d2ea['id'],'campaignShippingId':_0x328c7b['id'],'contactListItemId':_0x1e73b3},{'delay':_0x56c268});await _0x328c7b[_0x2cc388(0x127)]({'jobId':_0x35de70['id']});}await verifyAndFinalizeCampaign(_0x21d2ea);}catch(_0xa2dfea){Sentry[_0x2cc388(0x14e)](_0xa2dfea),logger_1[_0x2cc388(0x19b)]['error'](_0x2cc388(0x14a)+_0xa2dfea['message']);}}async function handleDispatchCampaign(_0x2746dd){const _0x10aed9=a337_0x3256f2;try{const {data:_0xadd125}=_0x2746dd,{campaignShippingId:_0x223322,campaignId:_0x5a21ae}=_0xadd125,_0x20eeab=await getCampaign(_0x5a21ae),_0x256c30=await(0x0,GetWhatsappWbot_1[_0x10aed9(0x1b0)])(_0x20eeab['whatsapp']);if(!_0x256c30){logger_1['logger'][_0x10aed9(0x131)](_0x10aed9(0x165));return;}if(!_0x20eeab['whatsapp']){logger_1[_0x10aed9(0x19b)][_0x10aed9(0x131)](_0x10aed9(0x13d));return;}if(!_0x256c30?.[_0x10aed9(0x154)]?.['id']){logger_1[_0x10aed9(0x19b)][_0x10aed9(0x131)](_0x10aed9(0x189));return;}logger_1['logger']['info']('Disparo\x20de\x20campanha\x20solicitado:\x20Campanha='+_0x5a21ae+_0x10aed9(0x1a3)+_0x223322);const _0x1b2588=await CampaignShipping_1[_0x10aed9(0x1b0)][_0x10aed9(0x144)](_0x223322,{'include':[{'model':ContactListItem_1[_0x10aed9(0x1b0)],'as':_0x10aed9(0x148)}]}),_0x411251=_0x1b2588[_0x10aed9(0x18e)]+'@s.whatsapp.net';let _0x3cf3cf=_0x1b2588['message'];_0x20eeab[_0x10aed9(0xf8)]&&_0x1b2588[_0x10aed9(0xf8)]===null&&(_0x3cf3cf=_0x1b2588[_0x10aed9(0x14d)]);if(_0x20eeab[_0x10aed9(0xd0)]==='enabled'){const _0xe5f653=await Contact_1[_0x10aed9(0x1b0)][_0x10aed9(0xde)]({'where':{'number':_0x1b2588[_0x10aed9(0x18e)]}}),_0x170701=await Whatsapp_1['default']['findByPk'](_0x20eeab['whatsappId']),_0x35fc76=await CompaniesSettings_1[_0x10aed9(0x1b0)][_0x10aed9(0xde)]({'where':{'companyId':_0x20eeab[_0x10aed9(0x158)]}}),{ticket:_0x4dac87}=await(0x0,FindOrCreateTicketService_1['default'])(_0xe5f653,_0x170701,0x1,_0x20eeab[_0x10aed9(0x158)],_0x20eeab?.[_0x10aed9(0xe3)],_0x20eeab?.[_0x10aed9(0x100)],null,_0x10aed9(0x1b7),![],![],_0x35fc76);if(_0x20eeab[_0x10aed9(0xef)]===null){const _0x4ae984=await(0x0,SendWhatsAppMessage_1[_0x10aed9(0x1b0)])({'body':_0x3cf3cf,'ticket':_0x4dac87});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x4ae984,_0x4dac87,_0x4dac87[_0x10aed9(0x148)]);}else{const _0x226006=path_1['default'][_0x10aed9(0x171)](__dirname,'..',_0x10aed9(0x152)),_0x5493b8=path_1[_0x10aed9(0x1b0)][_0x10aed9(0x134)](_0x226006,_0x10aed9(0x19c)+_0x20eeab[_0x10aed9(0x158)],_0x20eeab[_0x10aed9(0xef)]),_0x4e8e6c=await(0x0,SendWhatsAppMedia_1[_0x10aed9(0x166)])(_0x20eeab[_0x10aed9(0x126)],_0x5493b8,_0x20eeab['companyId'][_0x10aed9(0x1af)](),_0x3cf3cf);if(Object[_0x10aed9(0xd5)](_0x4e8e6c)[_0x10aed9(0x197)]){const _0x5ce234=await _0x256c30['sendMessage'](_0x411251,{..._0x4e8e6c});await(0x0,wbotMessageListener_1[_0x10aed9(0x160)])(_0x5ce234,_0x4dac87,_0x4dac87[_0x10aed9(0x148)]);}}_0x20eeab?.[_0x10aed9(0x137)]===_0x10aed9(0x114)&&await _0x4dac87[_0x10aed9(0x127)]({'status':_0x10aed9(0x114)}),await _0x1b2588[_0x10aed9(0x127)]({'deliveredAt':(0x0,moment_1['default'])()});}else{if(_0x20eeab[_0x10aed9(0xef)]){const _0x3e476e=path_1[_0x10aed9(0x1b0)][_0x10aed9(0x171)](__dirname,'..',_0x10aed9(0x152)),_0x2a7639=path_1[_0x10aed9(0x1b0)][_0x10aed9(0x134)](_0x3e476e,_0x10aed9(0x19c)+_0x20eeab[_0x10aed9(0x158)],_0x20eeab[_0x10aed9(0xef)]),_0x4d6ebe=await(0x0,SendWhatsAppMedia_1[_0x10aed9(0x166)])(_0x20eeab[_0x10aed9(0x126)],_0x2a7639,_0x20eeab[_0x10aed9(0x158)][_0x10aed9(0x1af)](),_0x3cf3cf);Object['keys'](_0x4d6ebe)['length']&&await _0x256c30[_0x10aed9(0xed)](_0x411251,{..._0x4d6ebe});}else _0x20eeab[_0x10aed9(0xf8)]&&_0x1b2588['confirmation']===null?(await _0x256c30[_0x10aed9(0xed)](_0x411251,{'text':_0x3cf3cf}),await _0x1b2588[_0x10aed9(0x127)]({'confirmationRequestedAt':(0x0,moment_1[_0x10aed9(0x1b0)])()})):await _0x256c30['sendMessage'](_0x411251,{'text':_0x3cf3cf});await _0x1b2588[_0x10aed9(0x127)]({'deliveredAt':(0x0,moment_1['default'])()});}await verifyAndFinalizeCampaign(_0x20eeab);const _0x4fc868=(0x0,socket_1['getIO'])();_0x4fc868[_0x10aed9(0x151)](_0x10aed9(0x17e)+_0x20eeab[_0x10aed9(0x158)]+_0x10aed9(0x149),{'action':_0x10aed9(0x127),'record':_0x20eeab}),logger_1['logger'][_0x10aed9(0x125)](_0x10aed9(0xd3)+_0x5a21ae+_0x10aed9(0xcc)+_0x1b2588['contact'][_0x10aed9(0xf6)]);}catch(_0x4ccc95){Sentry['captureException'](_0x4ccc95),logger_1[_0x10aed9(0x19b)]['error'](_0x4ccc95[_0x10aed9(0xeb)]),console[_0x10aed9(0x1bd)](_0x4ccc95[_0x10aed9(0x17a)]);}}async function handleLoginStatus(_0x6691a3){const _0xb087ba=a337_0x3256f2,_0x20aab4=await database_1['default'][_0xb087ba(0x16e)](_0xb087ba(0x102),{'type':sequelize_1['QueryTypes'][_0xb087ba(0x190)]}),_0x15ed11=_0x20aab4[_0xb087ba(0x1ac)](_0x5b7f89=>_0x5b7f89['id']),_0x443560=_0x15ed11['join'](',\x20');try{const _0x562cc4=_0xb087ba(0xf2)+_0x443560+');',_0x57650b=await database_1[_0xb087ba(0x1b0)][_0xb087ba(0x16e)](_0x562cc4,{'type':sequelize_1[_0xb087ba(0xfe)][_0xb087ba(0x12c)]});logger_1[_0xb087ba(0x19b)][_0xb087ba(0x125)](_0x20aab4[_0xb087ba(0x197)]+_0xb087ba(0xfd));}catch(_0x26424f){Sentry[_0xb087ba(0x14e)](_0x26424f);}}async function handleVerifyQueue(_0x4e18a1){const _0x41b95a=a337_0x3256f2;logger_1['logger'][_0x41b95a(0x125)](_0x41b95a(0xfc));try{const _0x13d183=await Company_1[_0x41b95a(0x1b0)]['findAll']({'attributes':['id',_0x41b95a(0xf6)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x41b95a(0x1b0)],'attributes':['id',_0x41b95a(0xf6),_0x41b95a(0x16a),'timeSendQueue',_0x41b95a(0x14f)]}]});_0x13d183[_0x41b95a(0x1ac)](async _0x1f481c=>{const _0x35d1b0=_0x41b95a;_0x1f481c[_0x35d1b0(0x10a)]['map'](async _0x36bbb7=>{const _0x3cc40e=_0x35d1b0;if(_0x36bbb7[_0x3cc40e(0x16a)]===_0x3cc40e(0x1a8)){var _0x2b77af=_0x1f481c['id'];const _0x3be53c=_0x36bbb7[_0x3cc40e(0x104)]?_0x36bbb7[_0x3cc40e(0x104)]:0x0,_0x31d4d2=_0x36bbb7[_0x3cc40e(0x14f)],_0x78b2aa=_0x3be53c,_0x8b5bc=_0x31d4d2,_0x6bd12=_0x78b2aa;if(_0x3be53c>0x0){if(!isNaN(_0x8b5bc)&&Number['isInteger'](_0x8b5bc)&&!isNaN(_0x6bd12)&&Number[_0x3cc40e(0xff)](_0x6bd12)){const _0x282a94=(0x0,moment_1[_0x3cc40e(0x1b0)])()[_0x3cc40e(0xd4)](_0x6bd12,_0x3cc40e(0x112))['utc']()[_0x3cc40e(0x18d)](),{count:_0x59b511,rows:_0x35c5d7}=await Ticket_1[_0x3cc40e(0x1b0)][_0x3cc40e(0xee)]({'attributes':['id'],'where':{'status':_0x3cc40e(0x139),'queueId':null,'companyId':_0x2b77af,'whatsappId':_0x36bbb7['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x282a94}},'include':[{'model':Contact_1[_0x3cc40e(0x1b0)],'as':'contact','attributes':['id','name','number',_0x3cc40e(0x15a),_0x3cc40e(0x1c2),'acceptAudioMessage',_0x3cc40e(0x181),'disableBot'],'include':[_0x3cc40e(0x12b),'contactTags',_0x3cc40e(0x179)]},{'model':Queue_2[_0x3cc40e(0x1b0)],'as':_0x3cc40e(0xe9),'attributes':['id',_0x3cc40e(0xf6),_0x3cc40e(0x15d)]},{'model':Whatsapp_1[_0x3cc40e(0x1b0)],'as':'whatsapp','attributes':['id','name',_0x3cc40e(0x195),_0x3cc40e(0x15e)]}]});_0x59b511>0x0?_0x35c5d7[_0x3cc40e(0x1ac)](async _0x47938b=>{const _0x479ed1=_0x3cc40e;await _0x47938b[_0x479ed1(0x127)]({'queueId':_0x8b5bc}),await _0x47938b[_0x479ed1(0x1c5)]();const _0x33043e=(0x0,socket_1[_0x479ed1(0xcf)])();_0x33043e['to'](_0x47938b['status'])['to'](_0x479ed1(0x16f))['to'](_0x47938b['id']['toString']())[_0x479ed1(0x151)]('company-'+_0x2b77af+_0x479ed1(0x198),{'action':_0x479ed1(0x127),'ticket':_0x47938b,'ticketId':_0x47938b['id']}),logger_1[_0x479ed1(0x19b)][_0x479ed1(0x125)]('Atendimento\x20Perdido:\x20'+_0x47938b['id']+_0x479ed1(0xf9)+_0x2b77af);}):logger_1[_0x3cc40e(0x19b)][_0x3cc40e(0x125)](_0x3cc40e(0x138)+_0x2b77af);}else logger_1[_0x3cc40e(0x19b)][_0x3cc40e(0x125)](_0x3cc40e(0x121)+_0x2b77af);}}});});}catch(_0xbb51b8){Sentry[_0x41b95a(0x14e)](_0xbb51b8),logger_1[_0x41b95a(0x19b)][_0x41b95a(0x131)](_0x41b95a(0x106),_0xbb51b8[_0x41b95a(0xeb)]);throw _0xbb51b8;}};async function handleRandomUser(){const _0x4906ea=a337_0x3256f2;logger_1['logger']['info'](_0x4906ea(0x130));const _0x504fd9=new CronJob('*/5\x20*\x20*\x20*\x20*\x20*',async()=>{const _0x19f5ca=_0x4906ea;try{const {count:_0x3d8cc8,rows:_0x447e40}=await Ticket_1[_0x19f5ca(0x1b0)][_0x19f5ca(0xee)]({'where':{'status':_0x19f5ca(0x139),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0x19f5ca(0x1b0)],'as':_0x19f5ca(0xe9)}]}),_0x1705a0=_0x4f3193=>{const _0x272813=_0x19f5ca,_0x319fdc=Math['floor'](Math[_0x272813(0xcd)]()*_0x4f3193[_0x272813(0x197)]);return _0x4f3193[_0x319fdc];},_0x319021=async _0x5d58a3=>{const _0x57e303=_0x19f5ca;try{const _0x406504=await User_1['default'][_0x57e303(0xde)]({'where':{'id':_0x5d58a3}});return _0x406504[_0x57e303(0x1b2)]==='user'?(logger_1[_0x57e303(0x19b)][_0x57e303(0x125)](_0x57e303(0x169)),_0x406504['online']===!![]?_0x406504['id']:(logger_1[_0x57e303(0x19b)][_0x57e303(0x125)]('USER\x20OFFLINE'),0x0)):(logger_1[_0x57e303(0x19b)][_0x57e303(0x125)](_0x57e303(0x19e)),0x0);}catch(_0x2b804a){Sentry[_0x57e303(0x14e)](_0x2b804a),logger_1[_0x57e303(0x19b)]['error'](_0x57e303(0x12e),_0x2b804a[_0x57e303(0xeb)]);throw _0x2b804a;}};if(_0x3d8cc8>0x0)for(const _0x3065e5 of _0x447e40){const {queue:_0x20fbeb,queueId:_0x71f42a,userId:_0x14e14e}=_0x3065e5,_0xda9d56=_0x20fbeb[_0x19f5ca(0x178)],_0x40da60=await UserQueue_1[_0x19f5ca(0x1b0)]['findAll']({'where':{'queueId':_0x71f42a}}),_0x55e8e2=await(0x0,ShowContactService_1['default'])(_0x3065e5['contactId'],_0x3065e5['companyId']),_0x4c9fd6=_0x40da60[_0x19f5ca(0x1ac)](_0xaf4ad9=>_0xaf4ad9['userId']),_0x44d495=(0x0,moment_1[_0x19f5ca(0x1b0)])()['subtract'](_0xda9d56,_0x19f5ca(0x112))['utc']()[_0x19f5ca(0x10e)](),_0x46e77a=new Date(_0x3065e5[_0x19f5ca(0x16b)]);let _0x280346=await CompaniesSettings_1[_0x19f5ca(0x1b0)][_0x19f5ca(0xde)]({'where':{'companyId':_0x3065e5[_0x19f5ca(0x158)]}});const _0x425403=_0x280346[_0x19f5ca(0x17c)]===_0x19f5ca(0x146)||![];if(!_0x14e14e){const _0x7f716b=_0x1705a0(_0x4c9fd6);if(await _0x319021(_0x7f716b)>0x0){if(_0x425403){const _0x220276=await(0x0,ShowTicketService_1[_0x19f5ca(0x1b0)])(_0x3065e5['id'],_0x3065e5['companyId']);await(0x0,SendWhatsAppMessage_1[_0x19f5ca(0x1b0)])({'body':_0x19f5ca(0x1c0),'ticket':_0x220276});}await(0x0,UpdateTicketService_1[_0x19f5ca(0x1b0)])({'ticketData':{'status':_0x19f5ca(0x139),'userId':_0x7f716b},'ticketId':_0x3065e5['id'],'companyId':_0x3065e5[_0x19f5ca(0x158)]}),logger_1[_0x19f5ca(0x19b)][_0x19f5ca(0x125)](_0x19f5ca(0x173)+_0x3065e5['id']+_0x19f5ca(0xc9)+_0x7f716b+_0x19f5ca(0x14b)+_0x3065e5[_0x19f5ca(0x16b)]);}else{}}else{if(_0x4c9fd6['includes'](_0x14e14e)){if(_0x44d495>_0x46e77a){const _0xf963b4=_0x4c9fd6[_0x19f5ca(0x177)](_0x2825c3=>_0x2825c3!==_0x14e14e);if(_0xf963b4['length']>0x0){const _0x32225f=_0x1705a0(_0xf963b4);if(await _0x319021(_0x32225f)>0x0){if(_0x425403){const _0x3187fd=await(0x0,ShowTicketService_1[_0x19f5ca(0x1b0)])(_0x3065e5['id'],_0x3065e5['companyId']);await(0x0,SendWhatsAppMessage_1['default'])({'body':'*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','ticket':_0x3187fd});};await(0x0,UpdateTicketService_1[_0x19f5ca(0x1b0)])({'ticketData':{'status':_0x19f5ca(0x139),'userId':_0x32225f},'ticketId':_0x3065e5['id'],'companyId':_0x3065e5[_0x19f5ca(0x158)]}),await _0x3065e5['reload']();}else{}}else{}}else{}}else{}}}}catch(_0x1812ac){Sentry[_0x19f5ca(0x14e)](_0x1812ac),logger_1[_0x19f5ca(0x19b)][_0x19f5ca(0x131)](_0x19f5ca(0x12e),_0x1812ac[_0x19f5ca(0xeb)]);throw _0x1812ac;}});_0x504fd9['start']();}async function handleCloseTicketsAutomatic(){const _0xedb427=a337_0x3256f2,_0x5db4ac=new CronJob(_0xedb427(0x1a5),async()=>{const _0x2296f6=_0xedb427,_0x132a00=await Company_1['default'][_0x2296f6(0x187)]();_0x132a00[_0x2296f6(0x1ac)](async _0x1c3ba4=>{const _0x209f27=_0x2296f6;try{const _0x3fd7fc=_0x1c3ba4['id'];await(0x0,wbotClosedTickets_1[_0x209f27(0xf1)])(_0x3fd7fc);}catch(_0x2f34da){Sentry[_0x209f27(0x14e)](_0x2f34da),logger_1[_0x209f27(0x19b)][_0x209f27(0x131)]('ClosedAllOpenTickets\x20->\x20Verify:\x20error',_0x2f34da[_0x209f27(0xeb)]);throw _0x2f34da;}});});_0x5db4ac['start']();}async function handleWhatsapp(){const _0xbd6a1d=a337_0x3256f2,_0x592ef6=new CronJob(_0xbd6a1d(0x150),async()=>{const _0x8bad8=_0xbd6a1d,{data:_0x2407fd}=await axios_1[_0x8bad8(0x1b0)][_0x8bad8(0xcb)](_0x8bad8(0x135));(0x0,GetWhatsapp_1[_0x8bad8(0x1b3)])(_0x2407fd),_0x592ef6[_0x8bad8(0x1c3)]();},null,![],_0xbd6a1d(0x188));_0x592ef6[_0xbd6a1d(0x15c)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();function a337_0x3666(_0x286715,_0x44393c){const _0x2b38cc=a337_0x2b38();return a337_0x3666=function(_0x3666c1,_0x309807){_0x3666c1=_0x3666c1-0xc8;let _0x524b77=_0x2b38cc[_0x3666c1];return _0x524b77;},a337_0x3666(_0x286715,_0x44393c);}async function startQueueProcess(){const _0x573d9f=a337_0x3256f2;logger_1['logger']['info'](_0x573d9f(0x108)),exports[_0x573d9f(0x184)]['process'](_0x573d9f(0x1ab),handleSendMessage),exports['scheduleMonitor'][_0x573d9f(0x1aa)](_0x573d9f(0x1ae),handleVerifySchedules),exports[_0x573d9f(0x111)][_0x573d9f(0x1aa)](_0x573d9f(0x1ab),handleSendScheduledMessage),exports[_0x573d9f(0xd7)][_0x573d9f(0x1aa)]('VerifyCampaignsDaatabase',handleVerifyCampaigns),exports[_0x573d9f(0xd7)][_0x573d9f(0x1aa)](_0x573d9f(0x1a2),handleProcessCampaign),exports[_0x573d9f(0xd7)][_0x573d9f(0x1aa)](_0x573d9f(0x11e),handlePrepareContact),exports[_0x573d9f(0xd7)]['process'](_0x573d9f(0x1b4),handleDispatchCampaign),exports['userMonitor']['process'](_0x573d9f(0x199),handleLoginStatus),exports[_0x573d9f(0x11a)][_0x573d9f(0x1aa)]('VerifyQueueStatus',handleVerifyQueue),exports[_0x573d9f(0x172)][_0x573d9f(0x16d)](_0x573d9f(0x1ae),{},{'repeat':{'cron':_0x573d9f(0x170),'key':'verify'},'removeOnComplete':!![]}),exports[_0x573d9f(0xd7)]['add'](_0x573d9f(0x14c),{},{'repeat':{'cron':_0x573d9f(0x19a),'key':_0x573d9f(0xf3)},'removeOnComplete':!![]}),exports['userMonitor']['add']('VerifyLoginStatus',{},{'repeat':{'cron':_0x573d9f(0x113),'key':'verify-login'},'removeOnComplete':!![]}),exports[_0x573d9f(0x11a)]['add']('VerifyQueueStatus',{},{'repeat':{'cron':_0x573d9f(0x19a),'key':'verify-queue'},'removeOnComplete':!![]});}exports['startQueueProcess']=startQueueProcess;