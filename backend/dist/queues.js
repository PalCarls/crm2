'use strict';const a290_0x5c85de=a290_0x3785;(function(_0x3dbc56,_0x1ec21a){const _0x55c859=a290_0x3785,_0x421480=_0x3dbc56();while(!![]){try{const _0x525dc3=-parseInt(_0x55c859(0xbc))/0x1+-parseInt(_0x55c859(0x9f))/0x2+parseInt(_0x55c859(0x11b))/0x3*(-parseInt(_0x55c859(0xfa))/0x4)+-parseInt(_0x55c859(0x107))/0x5+parseInt(_0x55c859(0xc3))/0x6+-parseInt(_0x55c859(0x79))/0x7+-parseInt(_0x55c859(0x103))/0x8*(-parseInt(_0x55c859(0x9c))/0x9);if(_0x525dc3===_0x1ec21a)break;else _0x421480['push'](_0x421480['shift']());}catch(_0x400d6d){_0x421480['push'](_0x421480['shift']());}}}(a290_0xe7e4,0xd4280));var __createBinding=this&&this[a290_0x5c85de(0xf0)]||(Object['create']?function(_0x3c1771,_0x1b6c32,_0x4ddce9,_0x1bfeae){const _0x5a84dd=a290_0x5c85de;if(_0x1bfeae===undefined)_0x1bfeae=_0x4ddce9;var _0x2a3d20=Object[_0x5a84dd(0xd0)](_0x1b6c32,_0x4ddce9);(!_0x2a3d20||(_0x5a84dd(0x97)in _0x2a3d20?!_0x1b6c32['__esModule']:_0x2a3d20[_0x5a84dd(0xe2)]||_0x2a3d20[_0x5a84dd(0xea)]))&&(_0x2a3d20={'enumerable':!![],'get':function(){return _0x1b6c32[_0x4ddce9];}}),Object[_0x5a84dd(0x10a)](_0x3c1771,_0x1bfeae,_0x2a3d20);}:function(_0x4e25e4,_0x2fad24,_0x3b680f,_0x56cf1d){if(_0x56cf1d===undefined)_0x56cf1d=_0x3b680f;_0x4e25e4[_0x56cf1d]=_0x2fad24[_0x3b680f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a290_0x5c85de(0x77)]?function(_0xe0ba69,_0x319c39){const _0x3c67f=a290_0x5c85de;Object[_0x3c67f(0x10a)](_0xe0ba69,'default',{'enumerable':!![],'value':_0x319c39});}:function(_0x568d27,_0x3bb2f5){_0x568d27['default']=_0x3bb2f5;}),__importStar=this&&this[a290_0x5c85de(0x12a)]||function(_0x4ab732){const _0x3a2fe2=a290_0x5c85de;if(_0x4ab732&&_0x4ab732[_0x3a2fe2(0x135)])return _0x4ab732;var _0xeb0db4={};if(_0x4ab732!=null){for(var _0x8bce36 in _0x4ab732)if(_0x8bce36!==_0x3a2fe2(0x137)&&Object[_0x3a2fe2(0x139)][_0x3a2fe2(0x111)][_0x3a2fe2(0x87)](_0x4ab732,_0x8bce36))__createBinding(_0xeb0db4,_0x4ab732,_0x8bce36);}return __setModuleDefault(_0xeb0db4,_0x4ab732),_0xeb0db4;},__importDefault=this&&this['__importDefault']||function(_0x5518b0){return _0x5518b0&&_0x5518b0['__esModule']?_0x5518b0:{'default':_0x5518b0};};Object[a290_0x5c85de(0x10a)](exports,'__esModule',{'value':!![]}),exports[a290_0x5c85de(0x116)]=exports[a290_0x5c85de(0xb4)]=exports[a290_0x5c85de(0xa3)]=exports[a290_0x5c85de(0xc1)]=exports[a290_0x5c85de(0xc7)]=exports[a290_0x5c85de(0x117)]=exports[a290_0x5c85de(0x7e)]=exports[a290_0x5c85de(0x72)]=exports['userMonitor']=void 0x0;const Sentry=__importStar(require(a290_0x5c85de(0x120))),bull_1=__importDefault(require('bull')),SendMessage_1=require('./helpers/SendMessage'),Whatsapp_1=__importDefault(require('./models/Whatsapp')),logger_1=require(a290_0x5c85de(0xec)),moment_1=__importDefault(require(a290_0x5c85de(0xbe))),Schedule_1=__importDefault(require(a290_0x5c85de(0x83))),sequelize_1=require(a290_0x5c85de(0x8c)),GetDefaultWhatsApp_1=__importDefault(require(a290_0x5c85de(0x13c))),Campaign_1=__importDefault(require(a290_0x5c85de(0xe7))),ContactList_1=__importDefault(require('./models/ContactList')),ContactListItem_1=__importDefault(require(a290_0x5c85de(0x12f))),lodash_1=require(a290_0x5c85de(0x134)),CampaignSetting_1=__importDefault(require(a290_0x5c85de(0x118))),CampaignShipping_1=__importDefault(require(a290_0x5c85de(0xa0))),GetWhatsappWbot_1=__importDefault(require(a290_0x5c85de(0x131))),database_1=__importDefault(require(a290_0x5c85de(0xcf))),SendWhatsAppMedia_1=require(a290_0x5c85de(0x11c)),socket_1=require('./libs/socket'),path_1=__importDefault(require(a290_0x5c85de(0x7a))),Company_1=__importDefault(require(a290_0x5c85de(0xf2))),Contact_1=__importDefault(require(a290_0x5c85de(0x129))),Queue_1=__importDefault(require(a290_0x5c85de(0xd1))),wbotClosedTickets_1=require(a290_0x5c85de(0x78)),Ticket_1=__importDefault(require('./models/Ticket')),nodemailer=require('nodemailer'),CronJob=require(a290_0x5c85de(0x119))[a290_0x5c85de(0x133)],connection=process['env'][a290_0x5c85de(0x13e)]||'',limiterMax=process['env']['REDIS_OPT_LIMITER_MAX']||0x1,limiterDuration=process[a290_0x5c85de(0xfe)][a290_0x5c85de(0xdd)]||0xbb8;exports[a290_0x5c85de(0xcb)]=new bull_1[(a290_0x5c85de(0x137))](a290_0x5c85de(0x122),connection),exports[a290_0x5c85de(0x72)]=new bull_1[(a290_0x5c85de(0x137))](a290_0x5c85de(0xde),connection),exports[a290_0x5c85de(0x7e)]=new bull_1[(a290_0x5c85de(0x137))](a290_0x5c85de(0xbd),connection),exports[a290_0x5c85de(0x117)]=new bull_1['default'](a290_0x5c85de(0x12c),connection),exports[a290_0x5c85de(0xc7)]=new bull_1[(a290_0x5c85de(0x137))](a290_0x5c85de(0xc4),connection),exports[a290_0x5c85de(0xc1)]=new bull_1[(a290_0x5c85de(0x137))](a290_0x5c85de(0x123),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x1df82b){const _0x38ba95=a290_0x5c85de;try{const {data:_0x13232d}=_0x1df82b,_0x3f27dd=await Whatsapp_1[_0x38ba95(0x137)][_0x38ba95(0x115)](_0x13232d[_0x38ba95(0xf7)]);if(_0x3f27dd===null)throw Error(_0x38ba95(0xff));const _0x387025=_0x13232d[_0x38ba95(0xca)];await(0x0,SendMessage_1['SendMessage'])(_0x3f27dd,_0x387025);}catch(_0x1df4a2){Sentry[_0x38ba95(0x85)](_0x1df4a2),logger_1['logger']['error'](_0x38ba95(0x96),_0x1df4a2[_0x38ba95(0xd2)]);throw _0x1df4a2;}}async function handleVerifySchedules(_0x3adac0){const _0x3dd4b0=a290_0x5c85de;try{const {count:_0x47e093,rows:_0x57f74d}=await Schedule_1[_0x3dd4b0(0x137)][_0x3dd4b0(0x9d)]({'where':{'status':_0x3dd4b0(0x90),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x3dd4b0(0xfb)]]:(0x0,moment_1[_0x3dd4b0(0x137)])()['format'](_0x3dd4b0(0x13f)),[sequelize_1['Op'][_0x3dd4b0(0x7b)]]:(0x0,moment_1[_0x3dd4b0(0x137)])()[_0x3dd4b0(0xf6)]('30',_0x3dd4b0(0xac))[_0x3dd4b0(0xee)](_0x3dd4b0(0x13f))}},'include':[{'model':Contact_1[_0x3dd4b0(0x137)],'as':_0x3dd4b0(0xfc)}]});_0x47e093>0x0&&_0x57f74d[_0x3dd4b0(0x9a)](async _0x3d2a47=>{const _0x594d06=_0x3dd4b0;await _0x3d2a47['update']({'status':'AGENDADA'}),exports[_0x594d06(0x7e)][_0x594d06(0xf6)](_0x594d06(0xe3),{'schedule':_0x3d2a47},{'delay':0x9c40}),logger_1[_0x594d06(0x125)][_0x594d06(0x82)]('Disparo\x20agendado\x20para:\x20'+_0x3d2a47[_0x594d06(0xfc)][_0x594d06(0xae)]);});}catch(_0x5b4ee1){Sentry[_0x3dd4b0(0x85)](_0x5b4ee1),logger_1[_0x3dd4b0(0x125)][_0x3dd4b0(0x149)](_0x3dd4b0(0x11a),_0x5b4ee1[_0x3dd4b0(0xd2)]);throw _0x5b4ee1;}}async function handleSendScheduledMessage(_0x27590f){const _0x53802c=a290_0x5c85de,{data:{schedule:_0x485df9}}=_0x27590f;let _0x348c77=null;try{_0x348c77=await Schedule_1['default']['findByPk'](_0x485df9['id']);}catch(_0x1434ef){Sentry[_0x53802c(0x85)](_0x1434ef),logger_1['logger']['info'](_0x53802c(0x89)+_0x485df9['id']);}try{const _0x17fa74=await(0x0,GetDefaultWhatsApp_1[_0x53802c(0x137)])(_0x485df9[_0x53802c(0xe4)]);await(0x0,SendMessage_1[_0x53802c(0xe3)])(_0x17fa74,{'number':_0x485df9['contact']['number'],'body':_0x485df9[_0x53802c(0x74)]}),await _0x348c77?.['update']({'sentAt':(0x0,moment_1['default'])()[_0x53802c(0xee)](_0x53802c(0x6d)),'status':'ENVIADA'}),logger_1[_0x53802c(0x125)][_0x53802c(0x82)](_0x53802c(0x10d)+_0x485df9[_0x53802c(0xfc)]['name']),exports[_0x53802c(0x7e)]['clean'](0x3a98,_0x53802c(0xa9));}catch(_0x27172f){Sentry[_0x53802c(0x85)](_0x27172f),await _0x348c77?.['update']({'status':_0x53802c(0x141)}),logger_1[_0x53802c(0x125)][_0x53802c(0x149)](_0x53802c(0x71),_0x27172f[_0x53802c(0xd2)]);throw _0x27172f;}}async function handleVerifyCampaigns(_0x35b363){const _0x4a0d97=a290_0x5c85de,_0x32a199=await database_1['default'][_0x4a0d97(0x86)](_0x4a0d97(0x104),{'type':sequelize_1['QueryTypes'][_0x4a0d97(0x99)]});logger_1[_0x4a0d97(0x125)][_0x4a0d97(0x82)](_0x4a0d97(0x13d)+_0x32a199[_0x4a0d97(0xe5)]);for(let _0x1400b0 of _0x32a199){try{const _0xd67e19=(0x0,moment_1['default'])(),_0x75ec6a=(0x0,moment_1[_0x4a0d97(0x137)])(_0x1400b0[_0x4a0d97(0xad)]),_0x55c9e0=_0x75ec6a[_0x4a0d97(0xf3)](_0xd67e19,_0x4a0d97(0xf4));logger_1[_0x4a0d97(0x125)][_0x4a0d97(0x82)](_0x4a0d97(0xaf)+_0x1400b0['id']+',\x20Delay\x20Inicial='+_0x55c9e0),exports[_0x4a0d97(0x117)][_0x4a0d97(0xf6)](_0x4a0d97(0xa5),{'id':_0x1400b0['id'],'delay':_0x55c9e0},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x112f08){Sentry[_0x4a0d97(0x85)](_0x112f08);}}}async function getCampaign(_0x173ebe){const _0x3b254f=a290_0x5c85de;return await Campaign_1[_0x3b254f(0x137)][_0x3b254f(0xe1)]({'where':{'id':_0x173ebe},'include':[{'model':ContactList_1[_0x3b254f(0x137)],'as':_0x3b254f(0xba),'attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x3b254f(0x137)],'as':'contacts','attributes':['id',_0x3b254f(0xae),_0x3b254f(0xdb),_0x3b254f(0xab),_0x3b254f(0x108)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':'whatsapp','attributes':['id',_0x3b254f(0xae)]}]});}async function getContact(_0x5ed913){const _0x2d4373=a290_0x5c85de;return await ContactListItem_1[_0x2d4373(0x137)][_0x2d4373(0x115)](_0x5ed913,{'attributes':['id',_0x2d4373(0xae),_0x2d4373(0xdb),_0x2d4373(0xab)]});}async function getSettings(_0x2b2b91){const _0x59b444=a290_0x5c85de;try{const _0x2209bc=await CampaignSetting_1[_0x59b444(0x137)][_0x59b444(0x148)]({'where':{'companyId':_0x2b2b91[_0x59b444(0xe4)]},'attributes':['key',_0x59b444(0xef)]}),_0x2785ae=_0x2209bc[_0x59b444(0x12b)]((_0x4eb85f,_0x4eaa7e)=>{const _0x3334ff=_0x59b444;return _0x4eb85f[_0x4eaa7e[_0x3334ff(0x126)]]=JSON[_0x3334ff(0x95)](_0x4eaa7e['value']),_0x4eb85f;},{}),{messageInterval:messageInterval=0x14,longerIntervalAfter:longerIntervalAfter=0x14,greaterInterval:greaterInterval=0x3c,variables:variables=[]}=_0x2785ae;return{'messageInterval':messageInterval,'longerIntervalAfter':longerIntervalAfter,'greaterInterval':greaterInterval,'variables':variables};}catch(_0x14fda3){console[_0x59b444(0x114)](_0x14fda3);throw _0x14fda3;}}function parseToMilliseconds(_0x19f04b){return _0x19f04b*0x3e8;}exports[a290_0x5c85de(0xa3)]=parseToMilliseconds;async function sleep(_0x5daec0){const _0x17dcb7=a290_0x5c85de;return logger_1[_0x17dcb7(0x125)]['info'](_0x17dcb7(0xb2)+_0x5daec0+_0x17dcb7(0xb0)+(0x0,moment_1[_0x17dcb7(0x137)])()[_0x17dcb7(0xee)]('HH:mm:ss')),new Promise(_0x541a73=>{setTimeout(()=>{const _0x46031f=a290_0x3785;logger_1['logger']['info'](_0x46031f(0xb2)+_0x5daec0+_0x46031f(0x10f)+(0x0,moment_1[_0x46031f(0x137)])()[_0x46031f(0xee)]('HH:mm:ss')),_0x541a73(!![]);},parseToMilliseconds(_0x5daec0));});}function a290_0x3785(_0x34bff2,_0x35eba2){const _0xe7e44b=a290_0xe7e4();return a290_0x3785=function(_0x378522,_0x118da3){_0x378522=_0x378522-0x6d;let _0xb9a31b=_0xe7e44b[_0x378522];return _0xb9a31b;},a290_0x3785(_0x34bff2,_0x35eba2);}function getCampaignValidMessages(_0x134f49){const _0x131e50=a290_0x5c85de,_0x1233fb=[];return!(0x0,lodash_1['isEmpty'])(_0x134f49[_0x131e50(0xa1)])&&!(0x0,lodash_1[_0x131e50(0xa7)])(_0x134f49[_0x131e50(0xa1)])&&_0x1233fb[_0x131e50(0xb1)](_0x134f49[_0x131e50(0xa1)]),!(0x0,lodash_1[_0x131e50(0xb9)])(_0x134f49[_0x131e50(0x12e)])&&!(0x0,lodash_1['isNil'])(_0x134f49[_0x131e50(0x12e)])&&_0x1233fb['push'](_0x134f49['message2']),!(0x0,lodash_1[_0x131e50(0xb9)])(_0x134f49[_0x131e50(0x92)])&&!(0x0,lodash_1[_0x131e50(0xa7)])(_0x134f49[_0x131e50(0x92)])&&_0x1233fb['push'](_0x134f49[_0x131e50(0x92)]),!(0x0,lodash_1[_0x131e50(0xb9)])(_0x134f49[_0x131e50(0x105)])&&!(0x0,lodash_1[_0x131e50(0xa7)])(_0x134f49[_0x131e50(0x105)])&&_0x1233fb[_0x131e50(0xb1)](_0x134f49[_0x131e50(0x105)]),!(0x0,lodash_1['isEmpty'])(_0x134f49[_0x131e50(0x109)])&&!(0x0,lodash_1[_0x131e50(0xa7)])(_0x134f49[_0x131e50(0x109)])&&_0x1233fb[_0x131e50(0xb1)](_0x134f49[_0x131e50(0x109)]),_0x1233fb;}function getCampaignValidConfirmationMessages(_0x451bc7){const _0x350a49=a290_0x5c85de,_0x8834ea=[];return!(0x0,lodash_1[_0x350a49(0xb9)])(_0x451bc7[_0x350a49(0xc9)])&&!(0x0,lodash_1[_0x350a49(0xa7)])(_0x451bc7[_0x350a49(0xc9)])&&_0x8834ea[_0x350a49(0xb1)](_0x451bc7['confirmationMessage1']),!(0x0,lodash_1['isEmpty'])(_0x451bc7[_0x350a49(0x147)])&&!(0x0,lodash_1[_0x350a49(0xa7)])(_0x451bc7[_0x350a49(0x147)])&&_0x8834ea[_0x350a49(0xb1)](_0x451bc7['confirmationMessage2']),!(0x0,lodash_1[_0x350a49(0xb9)])(_0x451bc7[_0x350a49(0xa6)])&&!(0x0,lodash_1[_0x350a49(0xa7)])(_0x451bc7['confirmationMessage3'])&&_0x8834ea[_0x350a49(0xb1)](_0x451bc7[_0x350a49(0xa6)]),!(0x0,lodash_1[_0x350a49(0xb9)])(_0x451bc7[_0x350a49(0x8f)])&&!(0x0,lodash_1[_0x350a49(0xa7)])(_0x451bc7['confirmationMessage4'])&&_0x8834ea['push'](_0x451bc7[_0x350a49(0x8f)]),!(0x0,lodash_1[_0x350a49(0xb9)])(_0x451bc7[_0x350a49(0x145)])&&!(0x0,lodash_1[_0x350a49(0xa7)])(_0x451bc7[_0x350a49(0x145)])&&_0x8834ea[_0x350a49(0xb1)](_0x451bc7[_0x350a49(0x145)]),_0x8834ea;}function getProcessedMessage(_0x36ff45,_0x5a5678,_0x5aa89e){const _0x9e720c=a290_0x5c85de;let _0x5aa551=_0x36ff45;return _0x5aa551[_0x9e720c(0xd8)](_0x9e720c(0xf5))&&(_0x5aa551=_0x5aa551[_0x9e720c(0x14b)](/{nome}/g,_0x5aa89e['name'])),_0x5aa551[_0x9e720c(0xd8)](_0x9e720c(0x112))&&(_0x5aa551=_0x5aa551[_0x9e720c(0x14b)](/{email}/g,_0x5aa89e[_0x9e720c(0xab)])),_0x5aa551[_0x9e720c(0xd8)](_0x9e720c(0x14a))&&(_0x5aa551=_0x5aa551[_0x9e720c(0x14b)](/{numero}/g,_0x5aa89e[_0x9e720c(0xdb)])),_0x5a5678[_0x9e720c(0x136)](_0x5d11ac=>{const _0x3ff2af=_0x9e720c;if(_0x5aa551[_0x3ff2af(0xd8)]('{'+_0x5d11ac[_0x3ff2af(0x126)]+'}')){const _0x50c636=new RegExp('{'+_0x5d11ac[_0x3ff2af(0x126)]+'}','g');_0x5aa551=_0x5aa551[_0x3ff2af(0x14b)](_0x50c636,_0x5d11ac[_0x3ff2af(0xef)]);}}),_0x5aa551;}function randomValue(_0x34c8b9,_0x51acd5){const _0x48b32d=a290_0x5c85de;return Math[_0x48b32d(0xce)](Math[_0x48b32d(0x6e)]()*_0x51acd5)+_0x34c8b9;}exports[a290_0x5c85de(0xb4)]=randomValue;async function verifyAndFinalizeCampaign(_0x156108){const _0x3da258=a290_0x5c85de,{contacts:_0x3ccf32}=_0x156108[_0x3da258(0xba)],_0x21359d=_0x3ccf32['length'],_0xf5b59e=await CampaignShipping_1[_0x3da258(0x137)][_0x3da258(0xd6)]({'where':{'campaignId':_0x156108['id'],'deliveredAt':{[sequelize_1['Op'][_0x3da258(0x10c)]]:null}}});_0x21359d===_0xf5b59e&&await _0x156108[_0x3da258(0xa4)]({'status':_0x3da258(0xc6),'completedAt':(0x0,moment_1[_0x3da258(0x137)])()});const _0x2abc70=(0x0,socket_1[_0x3da258(0x8a)])();_0x2abc70[_0x3da258(0x80)]('company-'+_0x156108[_0x3da258(0xe4)]+_0x3da258(0x14c),{'action':'update','record':_0x156108});}async function handleProcessCampaign(_0x4a32cb){const _0x43f681=a290_0x5c85de;try{const {id:_0x2bed48}=_0x4a32cb[_0x43f681(0xca)],_0x1686fd=await getCampaign(_0x2bed48),_0x346929=await getSettings(_0x1686fd);if(_0x1686fd){const {contacts:_0x2139aa}=_0x1686fd[_0x43f681(0xba)];if((0x0,lodash_1[_0x43f681(0xd4)])(_0x2139aa)){const _0x418402=_0x2139aa[_0x43f681(0x9a)](_0x24f30a=>({'contactId':_0x24f30a['id'],'campaignId':_0x1686fd['id'],'variables':_0x346929[_0x43f681(0x91)]})),_0x374468=_0x4a32cb[_0x43f681(0xca)][_0x43f681(0xcd)]||0x0,_0x37b794=_0x346929['longerIntervalAfter'],_0x4d6140=parseToMilliseconds(_0x346929['greaterInterval']),_0x3ca316=parseToMilliseconds(_0x346929['messageInterval']),_0x11d54f=[];for(let _0x596102=0x0;_0x596102<_0x418402[_0x43f681(0xe5)];_0x596102++){const {contactId:_0x33aeab,campaignId:_0x49f625,variables:_0x1b60fe}=_0x418402[_0x596102],_0x4e835b=calculateDelay(_0x596102,_0x374468,_0x37b794,_0x4d6140,_0x3ca316),_0x5493e1=exports['campaignQueue'][_0x43f681(0xf6)](_0x43f681(0xb5),{'contactId':_0x33aeab,'campaignId':_0x49f625,'variables':_0x1b60fe,'delay':_0x4e835b},{'removeOnComplete':!![]});_0x11d54f[_0x43f681(0xb1)](_0x5493e1),logger_1['logger'][_0x43f681(0x82)](_0x43f681(0x93)+_0x1686fd['id']+_0x43f681(0xf9)+_0x2139aa[_0x596102][_0x43f681(0xae)]+_0x43f681(0xa8)+_0x4e835b);}await Promise[_0x43f681(0x100)](_0x11d54f),await _0x1686fd[_0x43f681(0xa4)]({'status':_0x43f681(0x94)});}}}catch(_0x4782cf){Sentry[_0x43f681(0x85)](_0x4782cf);}}function a290_0xe7e4(){const _0x2fc939=['./database','getOwnPropertyDescriptor','./models/Queue','message','Verify','isArray','sendIdQueue','count','verify-queue','includes','getMessageOptions','@s.whatsapp.net','number','mediaName','REDIS_OPT_LIMITER_DURATION','ScheduleMonitor','confirmation','contactId','findOne','writable','SendMessage','companyId','length','toString','./models/Campaign','Buscando\x20atendimentos\x20perdidos\x20nas\x20filas','DispatchCampaign','configurable','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','./utils/logger','color','format','value','__createBinding','contactTags','./models/Company','diff','milliseconds','{nome}','add','whatsappId','whatsapps',';Contato=','4OjIJnx','gte','contact','pending','env','Whatsapp\x20não\x20identificado','all','ClosedAllOpenTickets','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','8vsTVwV','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','message4','mediaPath','5794225ydsbCu','isWhatsappValid','message5','defineProperty',';Registro=','not','Mensagem\x20agendada\x20enviada\x20para:\x20','tags','\x20segundos\x20finalizado:\x20','deliveredAt','hasOwnProperty','{email}','company','log','findByPk','startQueueProcess','campaignQueue','./models/CampaignSetting','cron','SendScheduledMessage\x20->\x20Verify:\x20error','2316219fFgdKQ','./services/WbotServices/SendWhatsAppMedia','utc','campaignId','VerifyLoginStatus','@sentry/node','start','UserMonitor','MessageQueue','verify-campaing','logger','key','*/20\x20*\x20*\x20*\x20*\x20*','verify-login','./models/Contact','__importStar','reduce','CampaignQueue','VerifyQueueStatus','message2','./models/ContactListItem','*/5\x20*\x20*\x20*\x20*\x20*','./helpers/GetWhatsappWbot','whatsapp','CronJob','lodash','__esModule','forEach','default','join','prototype','active','subtract','./helpers/GetDefaultWhatsApp','Campanhas\x20encontradas:\x20','REDIS_URI','YYYY-MM-DD\x20HH:mm:ss','keys','ERRO','CONNECTED','status','findOrCreate','confirmationMessage5','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','confirmationMessage2','findAll','error','{numero}','replace','-campaign','YYYY-MM-DD\x20HH:mm','random','extraInfo','save','SendScheduledMessage\x20->\x20SendMessage:\x20error','scheduleMonitor','Iniciando\x20processamento\x20de\x20filas','body','\x20-\x20Empresa:\x20','\x20usuarios\x20passados\x20para\x20offline','create','./services/WbotServices/wbotClosedTickets','9296840SktMJa','path','lte','queue','Sequelize','sendScheduledMessages','sendMessage','emit','verify','info','./models/Schedule','ClosedAllOpenTickets\x20->\x20Verify:\x20error','captureException','query','call','set','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','getIO','company-','sequelize','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','public','confirmationMessage4','PENDENTE','variables','message3','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','EM_ANDAMENTO','parse','MessageQueue\x20->\x20SendMessage:\x20error','get','Nenhum\x20atendimento\x20perdido\x20encontrado\x20-\x20Empresa:\x20','SELECT','map','QueryTypes','29454552zALukB','findAndCountAll','SearchForQueue\x20->\x20VerifyQueue:\x20error','615842ZoQiTZ','./models/CampaignShipping','message1','profilePicUrl','parseToMilliseconds','update','ProcessCampaign','confirmationMessage3','isNil',';delay=','completed','timeSendQueue','email','seconds','scheduledAt','name','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','\x20segundos\x20iniciado:\x20','push','Sleep\x20de\x20','confirmationMessage','randomValue','PrepareContact','acceptAudioMessage','CURRENT_DATE','stack','isEmpty','contactList','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','494616yLLQIQ','SendSacheduledMessages','moment','-ticket','confirmationRequestedAt','messageQueue','disableBot','9947034qRYHBy','QueueMonitor','resolve','FINALIZADA','queueMonitor','process','confirmationMessage1','data','userMonitor','literal','delay','floor'];a290_0xe7e4=function(){return _0x2fc939;};return a290_0xe7e4();}function calculateDelay(_0xbfdc91,_0x233f55,_0x4846d6,_0xacd735,_0x4de209){return _0xbfdc91%_0x4846d6===0x0?_0x233f55+_0xbfdc91/_0x4846d6*_0xacd735:_0x233f55+randomValue(_0x4de209,_0xacd735);}async function handlePrepareContact(_0x1c02f3){const _0x18bc91=a290_0x5c85de;try{const {contactId:_0xe751d8,campaignId:_0x1d51e1,delay:_0x5ad6ce,variables:_0x307ab8}=_0x1c02f3['data'],_0x118a93=await getCampaign(_0x1d51e1),_0x1c8563=await getContact(_0xe751d8),_0x10c5a5={};_0x10c5a5['number']=_0x1c8563[_0x18bc91(0xdb)],_0x10c5a5[_0x18bc91(0xe0)]=_0xe751d8,_0x10c5a5[_0x18bc91(0x11e)]=_0x1d51e1;const _0x39fdcf=getCampaignValidMessages(_0x118a93);if(_0x39fdcf[_0x18bc91(0xe5)]){const _0x16f0a1=randomValue(0x0,_0x39fdcf['length']),_0x3136cf=getProcessedMessage(_0x39fdcf[_0x16f0a1],_0x307ab8,_0x1c8563);_0x10c5a5[_0x18bc91(0xd2)]='‌'+_0x3136cf;}if(_0x118a93[_0x18bc91(0xdf)]){const _0x55b332=getCampaignValidConfirmationMessages(_0x118a93);if(_0x55b332[_0x18bc91(0xe5)]){const _0x53e3ab=randomValue(0x0,_0x55b332[_0x18bc91(0xe5)]),_0x2e8ef9=getProcessedMessage(_0x55b332[_0x53e3ab],_0x307ab8,_0x1c8563);_0x10c5a5[_0x18bc91(0xb3)]='‌'+_0x2e8ef9;}}const [_0x2397da,_0x498865]=await CampaignShipping_1[_0x18bc91(0x137)][_0x18bc91(0x144)]({'where':{'campaignId':_0x10c5a5[_0x18bc91(0x11e)],'contactId':_0x10c5a5[_0x18bc91(0xe0)]},'defaults':_0x10c5a5});!_0x498865&&_0x2397da[_0x18bc91(0x110)]===null&&_0x2397da['confirmationRequestedAt']===null&&(_0x2397da[_0x18bc91(0x88)](_0x10c5a5),await _0x2397da[_0x18bc91(0x70)]());if(_0x2397da[_0x18bc91(0x110)]===null&&_0x2397da[_0x18bc91(0xc0)]===null){const _0x5efdab=await exports[_0x18bc91(0x117)]['add'](_0x18bc91(0xe9),{'campaignId':_0x118a93['id'],'campaignShippingId':_0x2397da['id'],'contactListItemId':_0xe751d8},{'delay':_0x5ad6ce});await _0x2397da[_0x18bc91(0xa4)]({'jobId':_0x5efdab['id']});}await verifyAndFinalizeCampaign(_0x118a93);}catch(_0x3fe043){Sentry['captureException'](_0x3fe043),logger_1[_0x18bc91(0x125)][_0x18bc91(0x149)]('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0x3fe043[_0x18bc91(0xd2)]);}}async function handleDispatchCampaign(_0x1a0218){const _0x2e962d=a290_0x5c85de;try{const {data:_0x290dd6}=_0x1a0218,{campaignShippingId:_0x162391,campaignId:_0x3ebaca}=_0x290dd6,_0x3ad7ab=await getCampaign(_0x3ebaca),_0x465b53=await(0x0,GetWhatsappWbot_1[_0x2e962d(0x137)])(_0x3ad7ab[_0x2e962d(0x132)]);if(!_0x465b53){logger_1[_0x2e962d(0x125)][_0x2e962d(0x149)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found');return;}if(!_0x3ad7ab[_0x2e962d(0x132)]){logger_1['logger'][_0x2e962d(0x149)](_0x2e962d(0x146));return;}if(!_0x465b53?.['user']?.['id']){logger_1['logger'][_0x2e962d(0x149)](_0x2e962d(0xeb));return;}logger_1[_0x2e962d(0x125)][_0x2e962d(0x82)](_0x2e962d(0x102)+_0x3ebaca+_0x2e962d(0x10b)+_0x162391);const _0x28bef6=await CampaignShipping_1[_0x2e962d(0x137)][_0x2e962d(0x115)](_0x162391,{'include':[{'model':ContactListItem_1[_0x2e962d(0x137)],'as':_0x2e962d(0xfc)}]}),_0x233ebc=_0x28bef6[_0x2e962d(0xdb)]+_0x2e962d(0xda);if(_0x3ad7ab['confirmation']&&_0x28bef6[_0x2e962d(0xdf)]===null)await _0x465b53['sendMessage'](_0x233ebc,{'text':_0x28bef6[_0x2e962d(0xb3)]}),await _0x28bef6['update']({'confirmationRequestedAt':(0x0,moment_1[_0x2e962d(0x137)])()});else{await _0x465b53[_0x2e962d(0x7f)](_0x233ebc,{'text':_0x28bef6[_0x2e962d(0xd2)]});if(_0x3ad7ab['mediaPath']){const _0x2b7a3f=path_1[_0x2e962d(0x137)][_0x2e962d(0xc5)](__dirname,'..',_0x2e962d(0x8e)),_0x306c2e=path_1['default']['join'](_0x2b7a3f,_0x2e962d(0x113)+_0x3ad7ab[_0x2e962d(0xe4)],_0x3ad7ab[_0x2e962d(0x106)]),_0x1602ba=await(0x0,SendWhatsAppMedia_1[_0x2e962d(0xd9)])(_0x3ad7ab[_0x2e962d(0xdc)],_0x306c2e,_0x3ad7ab[_0x2e962d(0xe4)][_0x2e962d(0xe6)]());Object[_0x2e962d(0x140)](_0x1602ba)[_0x2e962d(0xe5)]&&await _0x465b53['sendMessage'](_0x233ebc,{..._0x1602ba});}await _0x28bef6['update']({'deliveredAt':(0x0,moment_1[_0x2e962d(0x137)])()});}await verifyAndFinalizeCampaign(_0x3ad7ab);const _0x11469f=(0x0,socket_1[_0x2e962d(0x8a)])();_0x11469f[_0x2e962d(0x80)]('company-'+_0x3ad7ab[_0x2e962d(0xe4)]+'-campaign',{'action':_0x2e962d(0xa4),'record':_0x3ad7ab}),logger_1['logger'][_0x2e962d(0x82)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x3ebaca+_0x2e962d(0xf9)+_0x28bef6[_0x2e962d(0xfc)][_0x2e962d(0xae)]);}catch(_0xb9b60d){Sentry[_0x2e962d(0x85)](_0xb9b60d),logger_1[_0x2e962d(0x125)][_0x2e962d(0x149)](_0xb9b60d['message']),console['log'](_0xb9b60d[_0x2e962d(0xb8)]);}}async function handleLoginStatus(_0x4a6c26){const _0xce2d30=a290_0x5c85de,_0x2d8a3d=await database_1[_0xce2d30(0x137)][_0xce2d30(0x86)](_0xce2d30(0x8d),{'type':sequelize_1[_0xce2d30(0x9b)][_0xce2d30(0x99)]}),_0x194984=_0x2d8a3d[_0xce2d30(0x9a)](_0x52a245=>_0x52a245['id']),_0x4338e2=_0x194984[_0xce2d30(0x138)](',\x20');try{const _0x4b37ae='UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20('+_0x4338e2+');',_0x215854=await database_1[_0xce2d30(0x137)]['query'](_0x4b37ae,{'type':sequelize_1[_0xce2d30(0x9b)]['UPDATE']});logger_1['logger']['info'](_0x2d8a3d[_0xce2d30(0xe5)]+_0xce2d30(0x76));}catch(_0x3392a7){Sentry[_0xce2d30(0x85)](_0x3392a7);}}async function handleVerifyQueue(_0x45f463){const _0x15f0d4=a290_0x5c85de;logger_1[_0x15f0d4(0x125)][_0x15f0d4(0x82)](_0x15f0d4(0xe8));try{const _0x38b9a0=await Company_1['default'][_0x15f0d4(0x148)]({'attributes':['id',_0x15f0d4(0xae)],'where':{'status':!![],'dueDate':{[sequelize_1['Op']['gt']]:sequelize_1[_0x15f0d4(0x7d)][_0x15f0d4(0xcc)](_0x15f0d4(0xb7))}},'include':[{'model':Whatsapp_1[_0x15f0d4(0x137)],'attributes':['id',_0x15f0d4(0xae),'status',_0x15f0d4(0xaa),_0x15f0d4(0xd5)],'where':{'timeSendQueue':{[sequelize_1['Op']['gt']]:0x0}}}]});_0x38b9a0['map'](async _0x1a99f7=>{const _0x3421e6=_0x15f0d4;_0x1a99f7[_0x3421e6(0xf8)]['map'](async _0x2892f8=>{const _0x42b2ae=_0x3421e6;if(_0x2892f8[_0x42b2ae(0x143)]===_0x42b2ae(0x142)){var _0x3c4d59=_0x1a99f7['id'];const _0x41219f=_0x2892f8[_0x42b2ae(0xaa)]?_0x2892f8[_0x42b2ae(0xaa)]:0x0,_0xcb1483=_0x2892f8['sendIdQueue'],_0x185672=_0x41219f,_0x485eae=_0xcb1483,_0x58b2fe=_0x185672;if(_0x41219f>0x0){if(!isNaN(_0x485eae)&&Number['isInteger'](_0x485eae)&&!isNaN(_0x58b2fe)&&Number['isInteger'](_0x58b2fe)){const _0x3b5cd4=(0x0,moment_1[_0x42b2ae(0x137)])()[_0x42b2ae(0x13b)](_0x58b2fe,'minutes')[_0x42b2ae(0x11d)]()[_0x42b2ae(0xee)](),{count:_0x23dfed,rows:_0x3789da}=await Ticket_1[_0x42b2ae(0x137)][_0x42b2ae(0x9d)]({'where':{'status':_0x42b2ae(0xfd),'queueId':null,'companyId':_0x3c4d59,'whatsappId':_0x2892f8['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x3b5cd4}},'include':[{'model':Contact_1[_0x42b2ae(0x137)],'as':_0x42b2ae(0xfc),'attributes':['id','name',_0x42b2ae(0xdb),_0x42b2ae(0xab),_0x42b2ae(0xa2),_0x42b2ae(0xb6),_0x42b2ae(0x13a),_0x42b2ae(0xc2)],'include':[_0x42b2ae(0x6f),_0x42b2ae(0xf1),_0x42b2ae(0x10e)]},{'model':Queue_1['default'],'as':_0x42b2ae(0x7c),'attributes':['id',_0x42b2ae(0xae),_0x42b2ae(0xed)]}]});_0x23dfed>0x0?_0x3789da[_0x42b2ae(0x9a)](async _0x48862b=>{const _0x4c45ea=_0x42b2ae;await _0x48862b['update']({'queueId':_0x485eae}),await _0x48862b['reload']();const _0x248599=(0x0,socket_1[_0x4c45ea(0x8a)])();_0x248599['to'](_0x4c45ea(0xfd))[_0x4c45ea(0x80)](_0x4c45ea(0x8b)+_0x3c4d59+_0x4c45ea(0xbf),{'action':_0x4c45ea(0xa4),'ticket':_0x48862b}),logger_1[_0x4c45ea(0x125)][_0x4c45ea(0x82)]('Atendimento\x20Perdido:\x20'+_0x48862b['id']+_0x4c45ea(0x75)+_0x3c4d59);}):logger_1['logger'][_0x42b2ae(0x82)](_0x42b2ae(0x98)+_0x3c4d59);}else logger_1[_0x42b2ae(0x125)][_0x42b2ae(0x82)](_0x42b2ae(0xbb)+_0x3c4d59);}}});});}catch(_0x2aaa28){Sentry[_0x15f0d4(0x85)](_0x2aaa28),logger_1[_0x15f0d4(0x125)]['error'](_0x15f0d4(0x9e),_0x2aaa28[_0x15f0d4(0xd2)]);throw _0x2aaa28;}}async function handleCloseTicketsAutomatic(){const _0x1f0dbc=a290_0x5c85de,_0x2bf4e9=new CronJob('*/1\x20*\x20*\x20*\x20*',async()=>{const _0x3b24d2=a290_0x3785,_0x376f0f=await Company_1[_0x3b24d2(0x137)]['findAll']();_0x376f0f['map'](async _0x5cd93a=>{const _0x30c890=_0x3b24d2;try{const _0x14dd78=_0x5cd93a['id'];await(0x0,wbotClosedTickets_1[_0x30c890(0x101)])(_0x14dd78);}catch(_0x12cbd3){Sentry[_0x30c890(0x85)](_0x12cbd3),logger_1['logger'][_0x30c890(0x149)](_0x30c890(0x84),_0x12cbd3[_0x30c890(0xd2)]);throw _0x12cbd3;}});});_0x2bf4e9[_0x1f0dbc(0x121)]();}handleCloseTicketsAutomatic();async function startQueueProcess(){const _0x17f294=a290_0x5c85de;logger_1['logger'][_0x17f294(0x82)](_0x17f294(0x73)),exports[_0x17f294(0xc1)]['process'](_0x17f294(0xe3),handleSendMessage),exports[_0x17f294(0x72)][_0x17f294(0xc8)]('Verify',handleVerifySchedules),exports[_0x17f294(0x7e)][_0x17f294(0xc8)]('SendMessage',handleSendScheduledMessage),exports[_0x17f294(0x117)][_0x17f294(0xc8)]('VerifyCampaignsDaatabase',handleVerifyCampaigns),exports[_0x17f294(0x117)][_0x17f294(0xc8)]('ProcessCampaign',handleProcessCampaign),exports[_0x17f294(0x117)][_0x17f294(0xc8)](_0x17f294(0xb5),handlePrepareContact),exports[_0x17f294(0x117)][_0x17f294(0xc8)](_0x17f294(0xe9),handleDispatchCampaign),exports['userMonitor'][_0x17f294(0xc8)](_0x17f294(0x11f),handleLoginStatus),exports['queueMonitor']['process'](_0x17f294(0x12d),handleVerifyQueue),exports[_0x17f294(0x72)][_0x17f294(0xf6)](_0x17f294(0xd3),{},{'repeat':{'cron':_0x17f294(0x130),'key':_0x17f294(0x81)},'removeOnComplete':!![]}),exports[_0x17f294(0x117)][_0x17f294(0xf6)]('VerifyCampaignsDaatabase',{},{'repeat':{'cron':_0x17f294(0x127),'key':_0x17f294(0x124)},'removeOnComplete':!![]}),exports[_0x17f294(0xcb)][_0x17f294(0xf6)](_0x17f294(0x11f),{},{'repeat':{'cron':'*\x20*\x20*\x20*\x20*','key':_0x17f294(0x128)},'removeOnComplete':!![]}),exports['queueMonitor'][_0x17f294(0xf6)](_0x17f294(0x12d),{},{'repeat':{'cron':_0x17f294(0x127),'key':_0x17f294(0xd7)},'removeOnComplete':!![]});}exports[a290_0x5c85de(0x116)]=startQueueProcess;