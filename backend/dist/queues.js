'use strict';const a277_0x5ba9a7=a277_0x3c25;(function(_0x4eb1af,_0xbaaacf){const _0x62af04=a277_0x3c25,_0x4c1954=_0x4eb1af();while(!![]){try{const _0x1ff3bb=-parseInt(_0x62af04(0x14e))/0x1+parseInt(_0x62af04(0xee))/0x2+-parseInt(_0x62af04(0x116))/0x3+parseInt(_0x62af04(0xd3))/0x4*(parseInt(_0x62af04(0x107))/0x5)+-parseInt(_0x62af04(0xec))/0x6*(-parseInt(_0x62af04(0x14d))/0x7)+parseInt(_0x62af04(0x102))/0x8+parseInt(_0x62af04(0x13f))/0x9*(parseInt(_0x62af04(0xa4))/0xa);if(_0x1ff3bb===_0xbaaacf)break;else _0x4c1954['push'](_0x4c1954['shift']());}catch(_0x513f87){_0x4c1954['push'](_0x4c1954['shift']());}}}(a277_0x1665,0x52207));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x52a9dc,_0x391f29,_0x1524ce,_0x342d8f){const _0x2594ca=a277_0x3c25;if(_0x342d8f===undefined)_0x342d8f=_0x1524ce;var _0x1c89aa=Object['getOwnPropertyDescriptor'](_0x391f29,_0x1524ce);(!_0x1c89aa||(_0x2594ca(0x16e)in _0x1c89aa?!_0x391f29[_0x2594ca(0x108)]:_0x1c89aa['writable']||_0x1c89aa[_0x2594ca(0x151)]))&&(_0x1c89aa={'enumerable':!![],'get':function(){return _0x391f29[_0x1524ce];}}),Object['defineProperty'](_0x52a9dc,_0x342d8f,_0x1c89aa);}:function(_0x217a7a,_0x489ca4,_0x5a458b,_0x160c7f){if(_0x160c7f===undefined)_0x160c7f=_0x5a458b;_0x217a7a[_0x160c7f]=_0x489ca4[_0x5a458b];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x40464b,_0x1b8edb){const _0x4713f1=a277_0x3c25;Object['defineProperty'](_0x40464b,_0x4713f1(0xdb),{'enumerable':!![],'value':_0x1b8edb});}:function(_0x21d6cc,_0x3bbe02){_0x21d6cc['default']=_0x3bbe02;}),__importStar=this&&this['__importStar']||function(_0x1f0e34){const _0x139395=a277_0x3c25;if(_0x1f0e34&&_0x1f0e34['__esModule'])return _0x1f0e34;var _0x5da5f8={};if(_0x1f0e34!=null){for(var _0x485a3c in _0x1f0e34)if(_0x485a3c!=='default'&&Object['prototype']['hasOwnProperty'][_0x139395(0x119)](_0x1f0e34,_0x485a3c))__createBinding(_0x5da5f8,_0x1f0e34,_0x485a3c);}return __setModuleDefault(_0x5da5f8,_0x1f0e34),_0x5da5f8;},__importDefault=this&&this[a277_0x5ba9a7(0xe8)]||function(_0x371df5){const _0x489361=a277_0x5ba9a7;return _0x371df5&&_0x371df5[_0x489361(0x108)]?_0x371df5:{'default':_0x371df5};};Object['defineProperty'](exports,a277_0x5ba9a7(0x108),{'value':!![]}),exports[a277_0x5ba9a7(0xf3)]=exports['randomValue']=exports[a277_0x5ba9a7(0xa8)]=exports[a277_0x5ba9a7(0xe6)]=exports[a277_0x5ba9a7(0xa3)]=exports[a277_0x5ba9a7(0x127)]=exports[a277_0x5ba9a7(0x12b)]=exports[a277_0x5ba9a7(0xc5)]=exports[a277_0x5ba9a7(0xb1)]=void 0x0;const Sentry=__importStar(require(a277_0x5ba9a7(0xd2))),bull_1=__importDefault(require('bull')),SendMessage_1=require(a277_0x5ba9a7(0xfe)),Whatsapp_1=__importDefault(require(a277_0x5ba9a7(0x12e))),logger_1=require('./utils/logger'),moment_1=__importDefault(require('moment')),Schedule_1=__importDefault(require('./models/Schedule')),sequelize_1=require(a277_0x5ba9a7(0x152)),GetDefaultWhatsApp_1=__importDefault(require(a277_0x5ba9a7(0x13a))),Campaign_1=__importDefault(require(a277_0x5ba9a7(0x15f))),ContactList_1=__importDefault(require(a277_0x5ba9a7(0xdd))),ContactListItem_1=__importDefault(require(a277_0x5ba9a7(0x139))),lodash_1=require(a277_0x5ba9a7(0x158)),CampaignSetting_1=__importDefault(require('./models/CampaignSetting')),CampaignShipping_1=__importDefault(require(a277_0x5ba9a7(0x10d))),GetWhatsappWbot_1=__importDefault(require(a277_0x5ba9a7(0xff))),database_1=__importDefault(require(a277_0x5ba9a7(0xc0))),SendWhatsAppMedia_1=require(a277_0x5ba9a7(0x14b)),socket_1=require(a277_0x5ba9a7(0xc7)),path_1=__importDefault(require(a277_0x5ba9a7(0xdf))),Company_1=__importDefault(require(a277_0x5ba9a7(0x9e))),Contact_1=__importDefault(require(a277_0x5ba9a7(0x165))),Queue_1=__importDefault(require(a277_0x5ba9a7(0x11c))),wbotClosedTickets_1=require(a277_0x5ba9a7(0x149)),Ticket_1=__importDefault(require(a277_0x5ba9a7(0xd0))),nodemailer=require(a277_0x5ba9a7(0xf4)),CronJob=require(a277_0x5ba9a7(0xe7))[a277_0x5ba9a7(0xb0)],connection=process[a277_0x5ba9a7(0x10b)][a277_0x5ba9a7(0x142)]||'',limiterMax=process['env'][a277_0x5ba9a7(0xc6)]||0x1,limiterDuration=process[a277_0x5ba9a7(0x10b)][a277_0x5ba9a7(0x10a)]||0xbb8;exports[a277_0x5ba9a7(0xb1)]=new bull_1[(a277_0x5ba9a7(0xdb))]('UserMonitor',connection),exports[a277_0x5ba9a7(0xc5)]=new bull_1[(a277_0x5ba9a7(0xdb))](a277_0x5ba9a7(0xc4),connection),exports[a277_0x5ba9a7(0x12b)]=new bull_1[(a277_0x5ba9a7(0xdb))]('SendSacheduledMessages',connection),exports[a277_0x5ba9a7(0x127)]=new bull_1[(a277_0x5ba9a7(0xdb))](a277_0x5ba9a7(0xab),connection),exports[a277_0x5ba9a7(0xa3)]=new bull_1[(a277_0x5ba9a7(0xdb))](a277_0x5ba9a7(0x14a),connection),exports['messageQueue']=new bull_1[(a277_0x5ba9a7(0xdb))]('MessageQueue',connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0xa96784){const _0x5287c6=a277_0x5ba9a7;try{const {data:_0x830207}=_0xa96784,_0x12b1c8=await Whatsapp_1[_0x5287c6(0xdb)][_0x5287c6(0x109)](_0x830207['whatsappId']);if(_0x12b1c8===null)throw Error(_0x5287c6(0x16c));const _0x14527a=_0x830207[_0x5287c6(0x170)];await(0x0,SendMessage_1[_0x5287c6(0x126)])(_0x12b1c8,_0x14527a);}catch(_0x421fed){Sentry[_0x5287c6(0x154)](_0x421fed),logger_1[_0x5287c6(0x11d)]['error'](_0x5287c6(0x168),_0x421fed[_0x5287c6(0x162)]);throw _0x421fed;}}async function handleVerifySchedules(_0x4ca487){const _0x3c8be8=a277_0x5ba9a7;try{const {count:_0x4ed7db,rows:_0x4eb3a1}=await Schedule_1[_0x3c8be8(0xdb)][_0x3c8be8(0xe2)]({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op']['gte']]:(0x0,moment_1[_0x3c8be8(0xdb)])()[_0x3c8be8(0x101)](_0x3c8be8(0xb7)),[sequelize_1['Op'][_0x3c8be8(0xbe)]]:(0x0,moment_1[_0x3c8be8(0xdb)])()['add']('30',_0x3c8be8(0x13b))[_0x3c8be8(0x101)](_0x3c8be8(0xb7))}},'include':[{'model':Contact_1[_0x3c8be8(0xdb)],'as':_0x3c8be8(0x15c)}]});_0x4ed7db>0x0&&_0x4eb3a1[_0x3c8be8(0x11e)](async _0x4e4fb9=>{const _0x493d12=_0x3c8be8;await _0x4e4fb9[_0x493d12(0xca)]({'status':'AGENDADA'}),exports[_0x493d12(0x12b)][_0x493d12(0x131)](_0x493d12(0x126),{'schedule':_0x4e4fb9},{'delay':0x9c40}),logger_1['logger'][_0x493d12(0xef)](_0x493d12(0xb8)+_0x4e4fb9[_0x493d12(0x15c)]['name']);});}catch(_0x23704a){Sentry['captureException'](_0x23704a),logger_1['logger'][_0x3c8be8(0xd5)](_0x3c8be8(0xc1),_0x23704a[_0x3c8be8(0x162)]);throw _0x23704a;}}function a277_0x1665(){const _0x4f2f53=['campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','query','REDIS_URI','SendScheduledMessage\x20->\x20SendMessage:\x20error','DispatchCampaign','contactList','literal','key','delay','./services/WbotServices/wbotClosedTickets','QueueMonitor','./services/WbotServices/SendWhatsAppMedia','contactTags','7khVeyH','365245SbSpCa','message2','confirmationRequestedAt','configurable','sequelize','\x20segundos\x20iniciado:\x20','captureException','status','confirmationMessage5','-campaign','lodash','active','push','ProcessCampaign','contact','length','ClosedAllOpenTickets\x20->\x20Verify:\x20error','./models/Campaign','SELECT',',\x20Delay\x20Inicial=','message','value','*\x20*\x20*\x20*\x20*','./models/Contact','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','{nome}','MessageQueue\x20->\x20SendMessage:\x20error','isNil','Sequelize','resolve','Whatsapp\x20não\x20identificado','confirmationMessage','get','profilePicUrl','data','./models/Company','scheduledAt','extraInfo','*/5\x20*\x20*\x20*\x20*\x20*','companyId','queueMonitor','10PYuTHj','Atendimento\x20Perdido:\x20','getMessageOptions','isArray','parseToMilliseconds','mediaPath','count','CampaignQueue','Verify','message5','whatsapp','completed','CronJob','userMonitor','VerifyCampaignsDaatabase','diff','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','toString','VerifyLoginStatus','YYYY-MM-DD\x20HH:mm:ss','Disparo\x20agendado\x20para:\x20','CONNECTED','message1','QueryTypes','number','messageInterval','lte','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','./database','SendScheduledMessage\x20->\x20Verify:\x20error','set','reload','ScheduleMonitor','scheduleMonitor','REDIS_OPT_LIMITER_MAX','./libs/socket','verify-queue','CURRENT_DATE','update','verify-campaing','name','company','YYYY-MM-DD\x20HH:mm','getIO','./models/Ticket','sendMessage','@sentry/node','2212dentQa','verify-login','error','Mensagem\x20agendada\x20enviada\x20para:\x20','PrepareContact','FINALIZADA',';Contato=','subtract','default','parse','./models/ContactList','public','path','VerifyQueueStatus','disableBot','findAndCountAll','verify','forEach','HH:mm:ss','messageQueue','cron','__importDefault','floor','Nenhum\x20atendimento\x20perdido\x20encontrado\x20-\x20Empresa:\x20','reduce','2729172AHFgAz','minutes','299150FfFCLn','info','color','Campanhas\x20encontradas:\x20','findAll','startQueueProcess','nodemailer','SearchForQueue\x20->\x20VerifyQueue:\x20error','company-','contactId','isInteger','UPDATE','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','all','-ticket','keys','./helpers/SendMessage','./helpers/GetWhatsappWbot','confirmationMessage2','format','3395136yZUpbm','EM_ANDAMENTO','user','\x20usuarios\x20passados\x20para\x20offline','greaterInterval','1415WVHytO','__esModule','findByPk','REDIS_OPT_LIMITER_DURATION','env','message3','./models/CampaignShipping','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','includes','{numero}','process','email','randomValue','campaignId','{email}','1677831IHqoLU','queue','\x20-\x20Empresa:\x20','call','confirmationMessage4',';Registro=','./models/Queue','logger','map','timeSendQueue','confirmationMessage3',';delay=','emit','Campanha\x20enviada\x20para:\x20Campanha=','not','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','SendMessage','campaignQueue','findOne','join','message4','sendScheduledMessages','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','longerIntervalAfter','./models/Whatsapp','Sleep\x20de\x20','isEmpty','add','confirmationMessage1','random','clean','save','deliveredAt','pending','confirmation','./models/ContactListItem','./helpers/GetDefaultWhatsApp','seconds','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','log','replace','680265AiNwIq'];a277_0x1665=function(){return _0x4f2f53;};return a277_0x1665();}async function handleSendScheduledMessage(_0x25f0c4){const _0x1f0aae=a277_0x5ba9a7,{data:{schedule:_0x1cf3ec}}=_0x25f0c4;let _0x2ebda4=null;try{_0x2ebda4=await Schedule_1[_0x1f0aae(0xdb)][_0x1f0aae(0x109)](_0x1cf3ec['id']);}catch(_0x1decf4){Sentry['captureException'](_0x1decf4),logger_1[_0x1f0aae(0x11d)][_0x1f0aae(0xef)](_0x1f0aae(0xb4)+_0x1cf3ec['id']);}try{const _0x3f8ca3=await(0x0,GetDefaultWhatsApp_1['default'])(_0x1cf3ec[_0x1f0aae(0xa2)]);await(0x0,SendMessage_1[_0x1f0aae(0x126)])(_0x3f8ca3,{'number':_0x1cf3ec['contact'][_0x1f0aae(0xbc)],'body':_0x1cf3ec['body']}),await _0x2ebda4?.['update']({'sentAt':(0x0,moment_1[_0x1f0aae(0xdb)])()[_0x1f0aae(0x101)](_0x1f0aae(0xce)),'status':'ENVIADA'}),logger_1[_0x1f0aae(0x11d)]['info'](_0x1f0aae(0xd6)+_0x1cf3ec[_0x1f0aae(0x15c)][_0x1f0aae(0xcc)]),exports['sendScheduledMessages'][_0x1f0aae(0x134)](0x3a98,_0x1f0aae(0xaf));}catch(_0x10eefe){Sentry['captureException'](_0x10eefe),await _0x2ebda4?.['update']({'status':'ERRO'}),logger_1['logger'][_0x1f0aae(0xd5)](_0x1f0aae(0x143),_0x10eefe['message']);throw _0x10eefe;}}async function handleVerifyCampaigns(_0x280e25){const _0x43fbbd=a277_0x5ba9a7,_0x3d88cf=await database_1['default'][_0x43fbbd(0x141)](_0x43fbbd(0x125),{'type':sequelize_1['QueryTypes'][_0x43fbbd(0x160)]});logger_1[_0x43fbbd(0x11d)]['info'](_0x43fbbd(0xf1)+_0x3d88cf[_0x43fbbd(0x15d)]);for(let _0x45a82a of _0x3d88cf){try{const _0x59f4a7=(0x0,moment_1[_0x43fbbd(0xdb)])(),_0x5e4fa3=(0x0,moment_1[_0x43fbbd(0xdb)])(_0x45a82a[_0x43fbbd(0x9f)]),_0x21d1aa=_0x5e4fa3[_0x43fbbd(0xb3)](_0x59f4a7,'milliseconds');logger_1['logger'][_0x43fbbd(0xef)](_0x43fbbd(0x13c)+_0x45a82a['id']+_0x43fbbd(0x161)+_0x21d1aa),exports[_0x43fbbd(0x127)][_0x43fbbd(0x131)](_0x43fbbd(0x15b),{'id':_0x45a82a['id'],'delay':_0x21d1aa},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x4a59a2){Sentry[_0x43fbbd(0x154)](_0x4a59a2);}}}async function getCampaign(_0x103afe){const _0x1759e9=a277_0x5ba9a7;return await Campaign_1[_0x1759e9(0xdb)][_0x1759e9(0x128)]({'where':{'id':_0x103afe},'include':[{'model':ContactList_1[_0x1759e9(0xdb)],'as':'contactList','attributes':['id',_0x1759e9(0xcc)],'include':[{'model':ContactListItem_1[_0x1759e9(0xdb)],'as':'contacts','attributes':['id',_0x1759e9(0xcc),_0x1759e9(0xbc),'email','isWhatsappValid'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x1759e9(0xdb)],'as':_0x1759e9(0xae),'attributes':['id',_0x1759e9(0xcc)]}]});}async function getContact(_0x4b8978){const _0x5c46b3=a277_0x5ba9a7;return await ContactListItem_1['default'][_0x5c46b3(0x109)](_0x4b8978,{'attributes':['id',_0x5c46b3(0xcc),_0x5c46b3(0xbc),_0x5c46b3(0x112)]});}async function getSettings(_0x23c84e){const _0x56843a=a277_0x5ba9a7;try{const _0x1bc2a7=await CampaignSetting_1['default'][_0x56843a(0xf2)]({'where':{'companyId':_0x23c84e['companyId']},'attributes':[_0x56843a(0x147),_0x56843a(0x163)]}),_0x2de783=_0x1bc2a7[_0x56843a(0xeb)]((_0x28a546,_0x2d9aa6)=>{const _0x3a1477=_0x56843a;return _0x28a546[_0x2d9aa6[_0x3a1477(0x147)]]=JSON[_0x3a1477(0xdc)](_0x2d9aa6[_0x3a1477(0x163)]),_0x28a546;},{}),{messageInterval:messageInterval=0x14,longerIntervalAfter:longerIntervalAfter=0x14,greaterInterval:greaterInterval=0x3c,variables:variables=[]}=_0x2de783;return{'messageInterval':messageInterval,'longerIntervalAfter':longerIntervalAfter,'greaterInterval':greaterInterval,'variables':variables};}catch(_0x1c2639){console[_0x56843a(0x13d)](_0x1c2639);throw _0x1c2639;}}function parseToMilliseconds(_0x520df3){return _0x520df3*0x3e8;}exports[a277_0x5ba9a7(0xa8)]=parseToMilliseconds;async function sleep(_0x168cfc){const _0x344fd2=a277_0x5ba9a7;return logger_1[_0x344fd2(0x11d)][_0x344fd2(0xef)](_0x344fd2(0x12f)+_0x168cfc+_0x344fd2(0x153)+(0x0,moment_1[_0x344fd2(0xdb)])()[_0x344fd2(0x101)](_0x344fd2(0xe5))),new Promise(_0x216e48=>{setTimeout(()=>{const _0x527793=a277_0x3c25;logger_1[_0x527793(0x11d)][_0x527793(0xef)](_0x527793(0x12f)+_0x168cfc+'\x20segundos\x20finalizado:\x20'+(0x0,moment_1[_0x527793(0xdb)])()[_0x527793(0x101)](_0x527793(0xe5))),_0x216e48(!![]);},parseToMilliseconds(_0x168cfc));});}function getCampaignValidMessages(_0x32eb41){const _0x1e02c2=a277_0x5ba9a7,_0x1f62f8=[];return!(0x0,lodash_1['isEmpty'])(_0x32eb41[_0x1e02c2(0xba)])&&!(0x0,lodash_1[_0x1e02c2(0x169)])(_0x32eb41[_0x1e02c2(0xba)])&&_0x1f62f8[_0x1e02c2(0x15a)](_0x32eb41[_0x1e02c2(0xba)]),!(0x0,lodash_1[_0x1e02c2(0x130)])(_0x32eb41[_0x1e02c2(0x14f)])&&!(0x0,lodash_1[_0x1e02c2(0x169)])(_0x32eb41[_0x1e02c2(0x14f)])&&_0x1f62f8[_0x1e02c2(0x15a)](_0x32eb41[_0x1e02c2(0x14f)]),!(0x0,lodash_1[_0x1e02c2(0x130)])(_0x32eb41[_0x1e02c2(0x10c)])&&!(0x0,lodash_1[_0x1e02c2(0x169)])(_0x32eb41[_0x1e02c2(0x10c)])&&_0x1f62f8[_0x1e02c2(0x15a)](_0x32eb41[_0x1e02c2(0x10c)]),!(0x0,lodash_1[_0x1e02c2(0x130)])(_0x32eb41[_0x1e02c2(0x12a)])&&!(0x0,lodash_1[_0x1e02c2(0x169)])(_0x32eb41['message4'])&&_0x1f62f8[_0x1e02c2(0x15a)](_0x32eb41['message4']),!(0x0,lodash_1[_0x1e02c2(0x130)])(_0x32eb41['message5'])&&!(0x0,lodash_1['isNil'])(_0x32eb41[_0x1e02c2(0xad)])&&_0x1f62f8[_0x1e02c2(0x15a)](_0x32eb41[_0x1e02c2(0xad)]),_0x1f62f8;}function getCampaignValidConfirmationMessages(_0xff6d1b){const _0x1bce7a=a277_0x5ba9a7,_0x370c9a=[];return!(0x0,lodash_1[_0x1bce7a(0x130)])(_0xff6d1b[_0x1bce7a(0x132)])&&!(0x0,lodash_1[_0x1bce7a(0x169)])(_0xff6d1b[_0x1bce7a(0x132)])&&_0x370c9a[_0x1bce7a(0x15a)](_0xff6d1b[_0x1bce7a(0x132)]),!(0x0,lodash_1[_0x1bce7a(0x130)])(_0xff6d1b[_0x1bce7a(0x100)])&&!(0x0,lodash_1['isNil'])(_0xff6d1b[_0x1bce7a(0x100)])&&_0x370c9a[_0x1bce7a(0x15a)](_0xff6d1b[_0x1bce7a(0x100)]),!(0x0,lodash_1['isEmpty'])(_0xff6d1b[_0x1bce7a(0x120)])&&!(0x0,lodash_1[_0x1bce7a(0x169)])(_0xff6d1b[_0x1bce7a(0x120)])&&_0x370c9a[_0x1bce7a(0x15a)](_0xff6d1b['confirmationMessage3']),!(0x0,lodash_1[_0x1bce7a(0x130)])(_0xff6d1b[_0x1bce7a(0x11a)])&&!(0x0,lodash_1[_0x1bce7a(0x169)])(_0xff6d1b[_0x1bce7a(0x11a)])&&_0x370c9a[_0x1bce7a(0x15a)](_0xff6d1b['confirmationMessage4']),!(0x0,lodash_1[_0x1bce7a(0x130)])(_0xff6d1b['confirmationMessage5'])&&!(0x0,lodash_1[_0x1bce7a(0x169)])(_0xff6d1b['confirmationMessage5'])&&_0x370c9a['push'](_0xff6d1b[_0x1bce7a(0x156)]),_0x370c9a;}function getProcessedMessage(_0x2e353c,_0xff0fa,_0x43c1f2){const _0x4fbad2=a277_0x5ba9a7;let _0x3fbcc8=_0x2e353c;return _0x3fbcc8['includes'](_0x4fbad2(0x167))&&(_0x3fbcc8=_0x3fbcc8[_0x4fbad2(0x13e)](/{nome}/g,_0x43c1f2[_0x4fbad2(0xcc)])),_0x3fbcc8['includes'](_0x4fbad2(0x115))&&(_0x3fbcc8=_0x3fbcc8[_0x4fbad2(0x13e)](/{email}/g,_0x43c1f2[_0x4fbad2(0x112)])),_0x3fbcc8['includes'](_0x4fbad2(0x110))&&(_0x3fbcc8=_0x3fbcc8[_0x4fbad2(0x13e)](/{numero}/g,_0x43c1f2[_0x4fbad2(0xbc)])),_0xff0fa[_0x4fbad2(0xe4)](_0x5659e2=>{const _0x50f259=_0x4fbad2;if(_0x3fbcc8[_0x50f259(0x10f)]('{'+_0x5659e2[_0x50f259(0x147)]+'}')){const _0x4c803a=new RegExp('{'+_0x5659e2['key']+'}','g');_0x3fbcc8=_0x3fbcc8['replace'](_0x4c803a,_0x5659e2[_0x50f259(0x163)]);}}),_0x3fbcc8;}function randomValue(_0x34249c,_0x5509e2){const _0x3272f6=a277_0x5ba9a7;return Math[_0x3272f6(0xe9)](Math[_0x3272f6(0x133)]()*_0x5509e2)+_0x34249c;}exports[a277_0x5ba9a7(0x113)]=randomValue;async function verifyAndFinalizeCampaign(_0x1150c0){const _0x347ec2=a277_0x5ba9a7,{contacts:_0xf5330d}=_0x1150c0[_0x347ec2(0x145)],_0x46ad54=_0xf5330d['length'],_0x1dc79a=await CampaignShipping_1[_0x347ec2(0xdb)][_0x347ec2(0xaa)]({'where':{'campaignId':_0x1150c0['id'],'deliveredAt':{[sequelize_1['Op'][_0x347ec2(0x124)]]:null}}});_0x46ad54===_0x1dc79a&&await _0x1150c0[_0x347ec2(0xca)]({'status':_0x347ec2(0xd8),'completedAt':(0x0,moment_1[_0x347ec2(0xdb)])()});const _0x5db55f=(0x0,socket_1[_0x347ec2(0xcf)])();_0x5db55f[_0x347ec2(0x122)](_0x347ec2(0xf6)+_0x1150c0[_0x347ec2(0xa2)]+_0x347ec2(0x157),{'action':_0x347ec2(0xca),'record':_0x1150c0});}async function handleProcessCampaign(_0x37ca52){const _0x3b12c3=a277_0x5ba9a7;try{const {id:_0x4016ca}=_0x37ca52[_0x3b12c3(0x170)],_0x1cfbe9=await getCampaign(_0x4016ca),_0x266bde=await getSettings(_0x1cfbe9);if(_0x1cfbe9){const {contacts:_0x400e4e}=_0x1cfbe9[_0x3b12c3(0x145)];if((0x0,lodash_1[_0x3b12c3(0xa7)])(_0x400e4e)){const _0x45903f=_0x400e4e['map'](_0x378a64=>({'contactId':_0x378a64['id'],'campaignId':_0x1cfbe9['id'],'variables':_0x266bde['variables']})),_0x51fac1=_0x37ca52['data'][_0x3b12c3(0x148)]||0x0,_0x57be21=_0x266bde[_0x3b12c3(0x12d)],_0x313278=parseToMilliseconds(_0x266bde[_0x3b12c3(0x106)]),_0x1bab60=parseToMilliseconds(_0x266bde[_0x3b12c3(0xbd)]),_0x4db2f9=[];for(let _0x3254d4=0x0;_0x3254d4<_0x45903f[_0x3b12c3(0x15d)];_0x3254d4++){const {contactId:_0x2fe124,campaignId:_0x39cf2e,variables:_0x1e4c08}=_0x45903f[_0x3254d4],_0x11687d=calculateDelay(_0x3254d4,_0x51fac1,_0x57be21,_0x313278,_0x1bab60),_0x1fa4d5=exports['campaignQueue'][_0x3b12c3(0x131)](_0x3b12c3(0xd7),{'contactId':_0x2fe124,'campaignId':_0x39cf2e,'variables':_0x1e4c08,'delay':_0x11687d},{'removeOnComplete':!![]});_0x4db2f9[_0x3b12c3(0x15a)](_0x1fa4d5),logger_1[_0x3b12c3(0x11d)]['info'](_0x3b12c3(0x12c)+_0x1cfbe9['id']+_0x3b12c3(0xd9)+_0x400e4e[_0x3254d4][_0x3b12c3(0xcc)]+_0x3b12c3(0x121)+_0x11687d);}await Promise[_0x3b12c3(0xfb)](_0x4db2f9),await _0x1cfbe9[_0x3b12c3(0xca)]({'status':_0x3b12c3(0x103)});}}}catch(_0x5d7ac){Sentry[_0x3b12c3(0x154)](_0x5d7ac);}}function calculateDelay(_0x2a4447,_0x20bd43,_0x59fcdb,_0x411d33,_0x5a035e){return _0x2a4447%_0x59fcdb===0x0?_0x20bd43+_0x2a4447/_0x59fcdb*_0x411d33:_0x20bd43+randomValue(_0x5a035e,_0x411d33);}async function handlePrepareContact(_0x89855e){const _0x27faff=a277_0x5ba9a7;try{const {contactId:_0x1892a3,campaignId:_0x405c83,delay:_0x17acef,variables:_0x4a3283}=_0x89855e[_0x27faff(0x170)],_0x1c9e37=await getCampaign(_0x405c83),_0x572c3a=await getContact(_0x1892a3),_0x4e0394={};_0x4e0394['number']=_0x572c3a[_0x27faff(0xbc)],_0x4e0394[_0x27faff(0xf7)]=_0x1892a3,_0x4e0394['campaignId']=_0x405c83;const _0x214e73=getCampaignValidMessages(_0x1c9e37);if(_0x214e73['length']){const _0x230a3f=randomValue(0x0,_0x214e73[_0x27faff(0x15d)]),_0x266d7c=getProcessedMessage(_0x214e73[_0x230a3f],_0x4a3283,_0x572c3a);_0x4e0394['message']='‌'+_0x266d7c;}if(_0x1c9e37[_0x27faff(0x138)]){const _0x5ba168=getCampaignValidConfirmationMessages(_0x1c9e37);if(_0x5ba168[_0x27faff(0x15d)]){const _0x2000cf=randomValue(0x0,_0x5ba168[_0x27faff(0x15d)]),_0x10d97a=getProcessedMessage(_0x5ba168[_0x2000cf],_0x4a3283,_0x572c3a);_0x4e0394[_0x27faff(0x16d)]='‌'+_0x10d97a;}}const [_0xed2dd3,_0x456517]=await CampaignShipping_1[_0x27faff(0xdb)]['findOrCreate']({'where':{'campaignId':_0x4e0394[_0x27faff(0x114)],'contactId':_0x4e0394[_0x27faff(0xf7)]},'defaults':_0x4e0394});!_0x456517&&_0xed2dd3['deliveredAt']===null&&_0xed2dd3[_0x27faff(0x150)]===null&&(_0xed2dd3[_0x27faff(0xc2)](_0x4e0394),await _0xed2dd3[_0x27faff(0x135)]());if(_0xed2dd3[_0x27faff(0x136)]===null&&_0xed2dd3[_0x27faff(0x150)]===null){const _0x51d63f=await exports[_0x27faff(0x127)]['add'](_0x27faff(0x144),{'campaignId':_0x1c9e37['id'],'campaignShippingId':_0xed2dd3['id'],'contactListItemId':_0x1892a3},{'delay':_0x17acef});await _0xed2dd3[_0x27faff(0xca)]({'jobId':_0x51d63f['id']});}await verifyAndFinalizeCampaign(_0x1c9e37);}catch(_0x44ab3c){Sentry[_0x27faff(0x154)](_0x44ab3c),logger_1[_0x27faff(0x11d)][_0x27faff(0xd5)](_0x27faff(0xbf)+_0x44ab3c[_0x27faff(0x162)]);}}async function handleDispatchCampaign(_0x4b88d1){const _0x252153=a277_0x5ba9a7;try{const {data:_0x139eb1}=_0x4b88d1,{campaignShippingId:_0x1efb9a,campaignId:_0x1a1625}=_0x139eb1,_0x3f357d=await getCampaign(_0x1a1625),_0x73b417=await(0x0,GetWhatsappWbot_1[_0x252153(0xdb)])(_0x3f357d[_0x252153(0xae)]);if(!_0x73b417){logger_1[_0x252153(0x11d)][_0x252153(0xd5)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found');return;}if(!_0x3f357d[_0x252153(0xae)]){logger_1[_0x252153(0x11d)]['error'](_0x252153(0x140));return;}if(!_0x73b417?.[_0x252153(0x104)]?.['id']){logger_1[_0x252153(0x11d)][_0x252153(0xd5)](_0x252153(0x10e));return;}logger_1[_0x252153(0x11d)][_0x252153(0xef)]('Disparo\x20de\x20campanha\x20solicitado:\x20Campanha='+_0x1a1625+_0x252153(0x11b)+_0x1efb9a);const _0xeabb91=await CampaignShipping_1[_0x252153(0xdb)]['findByPk'](_0x1efb9a,{'include':[{'model':ContactListItem_1[_0x252153(0xdb)],'as':'contact'}]}),_0x987e0a=_0xeabb91[_0x252153(0xbc)]+'@s.whatsapp.net';if(_0x3f357d[_0x252153(0x138)]&&_0xeabb91[_0x252153(0x138)]===null)await _0x73b417[_0x252153(0xd1)](_0x987e0a,{'text':_0xeabb91[_0x252153(0x16d)]}),await _0xeabb91[_0x252153(0xca)]({'confirmationRequestedAt':(0x0,moment_1[_0x252153(0xdb)])()});else{await _0x73b417[_0x252153(0xd1)](_0x987e0a,{'text':_0xeabb91[_0x252153(0x162)]});if(_0x3f357d[_0x252153(0xa9)]){const _0x357d6f=path_1['default'][_0x252153(0x16b)](__dirname,'..',_0x252153(0xde)),_0x3f170c=path_1[_0x252153(0xdb)][_0x252153(0x129)](_0x357d6f,_0x252153(0xcd)+_0x3f357d[_0x252153(0xa2)],_0x3f357d[_0x252153(0xa9)]),_0x397356=await(0x0,SendWhatsAppMedia_1[_0x252153(0xa6)])(_0x3f357d['mediaName'],_0x3f170c,_0x3f357d[_0x252153(0xa2)][_0x252153(0xb5)]());Object[_0x252153(0xfd)](_0x397356)['length']&&await _0x73b417[_0x252153(0xd1)](_0x987e0a,{..._0x397356});}await _0xeabb91[_0x252153(0xca)]({'deliveredAt':(0x0,moment_1[_0x252153(0xdb)])()});}await verifyAndFinalizeCampaign(_0x3f357d);const _0x245d4e=(0x0,socket_1['getIO'])();_0x245d4e['emit'](_0x252153(0xf6)+_0x3f357d[_0x252153(0xa2)]+_0x252153(0x157),{'action':'update','record':_0x3f357d}),logger_1[_0x252153(0x11d)]['info'](_0x252153(0x123)+_0x1a1625+_0x252153(0xd9)+_0xeabb91[_0x252153(0x15c)][_0x252153(0xcc)]);}catch(_0x3805e8){Sentry[_0x252153(0x154)](_0x3805e8),logger_1[_0x252153(0x11d)]['error'](_0x3805e8[_0x252153(0x162)]),console['log'](_0x3805e8['stack']);}}async function handleLoginStatus(_0x27bfee){const _0x2fc918=a277_0x5ba9a7,_0x5587df=await database_1[_0x2fc918(0xdb)][_0x2fc918(0x141)](_0x2fc918(0x166),{'type':sequelize_1[_0x2fc918(0xbb)][_0x2fc918(0x160)]}),_0x32963b=_0x5587df[_0x2fc918(0x11e)](_0x22d5eb=>_0x22d5eb['id']),_0x185195=_0x32963b[_0x2fc918(0x129)](',\x20');try{const _0x5a4921='UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20('+_0x185195+');',_0x53e058=await database_1[_0x2fc918(0xdb)][_0x2fc918(0x141)](_0x5a4921,{'type':sequelize_1[_0x2fc918(0xbb)][_0x2fc918(0xf9)]});logger_1['logger'][_0x2fc918(0xef)](_0x5587df[_0x2fc918(0x15d)]+_0x2fc918(0x105));}catch(_0x4dc7f6){Sentry[_0x2fc918(0x154)](_0x4dc7f6);}}async function handleVerifyQueue(_0x101d23){const _0x543341=a277_0x5ba9a7;logger_1[_0x543341(0x11d)][_0x543341(0xef)]('Buscando\x20atendimentos\x20perdidos\x20nas\x20filas');try{const _0x219721=await Company_1[_0x543341(0xdb)][_0x543341(0xf2)]({'attributes':['id',_0x543341(0xcc)],'where':{'status':!![],'dueDate':{[sequelize_1['Op']['gt']]:sequelize_1[_0x543341(0x16a)][_0x543341(0x146)](_0x543341(0xc9))}},'include':[{'model':Whatsapp_1[_0x543341(0xdb)],'attributes':['id','name',_0x543341(0x155),_0x543341(0x11f),'sendIdQueue'],'where':{'timeSendQueue':{[sequelize_1['Op']['gt']]:0x0}}}]});_0x219721[_0x543341(0x11e)](async _0x5122af=>{const _0x29b4fc=_0x543341;_0x5122af['whatsapps'][_0x29b4fc(0x11e)](async _0x17b9df=>{const _0x3fc423=_0x29b4fc;if(_0x17b9df[_0x3fc423(0x155)]===_0x3fc423(0xb9)){var _0x51944c=_0x5122af['id'];const _0x24576d=_0x17b9df['timeSendQueue']?_0x17b9df[_0x3fc423(0x11f)]:0x0,_0x5004f8=_0x17b9df['sendIdQueue'],_0x7f8662=_0x24576d,_0x2dc984=_0x5004f8,_0x21b6d9=_0x7f8662;if(_0x24576d>0x0){if(!isNaN(_0x2dc984)&&Number[_0x3fc423(0xf8)](_0x2dc984)&&!isNaN(_0x21b6d9)&&Number[_0x3fc423(0xf8)](_0x21b6d9)){const _0x2b441a=(0x0,moment_1['default'])()[_0x3fc423(0xda)](_0x21b6d9,_0x3fc423(0xed))['utc']()[_0x3fc423(0x101)](),{count:_0x2ef251,rows:_0x36288e}=await Ticket_1[_0x3fc423(0xdb)][_0x3fc423(0xe2)]({'where':{'status':_0x3fc423(0x137),'queueId':null,'companyId':_0x51944c,'whatsappId':_0x17b9df['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x2b441a}},'include':[{'model':Contact_1[_0x3fc423(0xdb)],'as':_0x3fc423(0x15c),'attributes':['id',_0x3fc423(0xcc),_0x3fc423(0xbc),_0x3fc423(0x112),_0x3fc423(0x16f),'acceptAudioMessage',_0x3fc423(0x159),_0x3fc423(0xe1)],'include':[_0x3fc423(0xa0),_0x3fc423(0x14c),'tags']},{'model':Queue_1['default'],'as':_0x3fc423(0x117),'attributes':['id','name',_0x3fc423(0xf0)]}]});_0x2ef251>0x0?_0x36288e['map'](async _0x2d0242=>{const _0x312e2a=_0x3fc423;await _0x2d0242[_0x312e2a(0xca)]({'queueId':_0x2dc984}),await _0x2d0242[_0x312e2a(0xc3)]();const _0x23c82d=(0x0,socket_1['getIO'])();_0x23c82d['to'](_0x312e2a(0x137))[_0x312e2a(0x122)]('company-'+_0x51944c+_0x312e2a(0xfc),{'action':'update','ticket':_0x2d0242}),logger_1[_0x312e2a(0x11d)]['info'](_0x312e2a(0xa5)+_0x2d0242['id']+_0x312e2a(0x118)+_0x51944c);}):logger_1[_0x3fc423(0x11d)][_0x3fc423(0xef)](_0x3fc423(0xea)+_0x51944c);}else logger_1[_0x3fc423(0x11d)]['info'](_0x3fc423(0xfa)+_0x51944c);}}});});}catch(_0x4f0ec1){Sentry[_0x543341(0x154)](_0x4f0ec1),logger_1[_0x543341(0x11d)][_0x543341(0xd5)](_0x543341(0xf5),_0x4f0ec1[_0x543341(0x162)]);throw _0x4f0ec1;}}function a277_0x3c25(_0x283ddc,_0x5a67e8){const _0x166597=a277_0x1665();return a277_0x3c25=function(_0x3c258f,_0x2154eb){_0x3c258f=_0x3c258f-0x9e;let _0x1dff0e=_0x166597[_0x3c258f];return _0x1dff0e;},a277_0x3c25(_0x283ddc,_0x5a67e8);}async function handleCloseTicketsAutomatic(){const _0x1626b7=new CronJob('*/1\x20*\x20*\x20*\x20*',async()=>{const _0x185453=a277_0x3c25,_0x30063d=await Company_1[_0x185453(0xdb)][_0x185453(0xf2)]();_0x30063d[_0x185453(0x11e)](async _0xf6f216=>{const _0x1e4d4d=_0x185453;try{const _0x5561ba=_0xf6f216['id'];await(0x0,wbotClosedTickets_1['ClosedAllOpenTickets'])(_0x5561ba);}catch(_0x2c0fb3){Sentry['captureException'](_0x2c0fb3),logger_1[_0x1e4d4d(0x11d)]['error'](_0x1e4d4d(0x15e),_0x2c0fb3['message']);throw _0x2c0fb3;}});});_0x1626b7['start']();}handleCloseTicketsAutomatic();async function startQueueProcess(){const _0x2e9855=a277_0x5ba9a7;logger_1[_0x2e9855(0x11d)][_0x2e9855(0xef)]('Iniciando\x20processamento\x20de\x20filas'),exports[_0x2e9855(0xe6)][_0x2e9855(0x111)](_0x2e9855(0x126),handleSendMessage),exports[_0x2e9855(0xc5)]['process'](_0x2e9855(0xac),handleVerifySchedules),exports[_0x2e9855(0x12b)][_0x2e9855(0x111)](_0x2e9855(0x126),handleSendScheduledMessage),exports[_0x2e9855(0x127)][_0x2e9855(0x111)](_0x2e9855(0xb2),handleVerifyCampaigns),exports[_0x2e9855(0x127)][_0x2e9855(0x111)](_0x2e9855(0x15b),handleProcessCampaign),exports['campaignQueue'][_0x2e9855(0x111)](_0x2e9855(0xd7),handlePrepareContact),exports[_0x2e9855(0x127)][_0x2e9855(0x111)](_0x2e9855(0x144),handleDispatchCampaign),exports[_0x2e9855(0xb1)][_0x2e9855(0x111)](_0x2e9855(0xb6),handleLoginStatus),exports[_0x2e9855(0xa3)][_0x2e9855(0x111)](_0x2e9855(0xe0),handleVerifyQueue),exports[_0x2e9855(0xc5)][_0x2e9855(0x131)]('Verify',{},{'repeat':{'cron':_0x2e9855(0xa1),'key':_0x2e9855(0xe3)},'removeOnComplete':!![]}),exports['campaignQueue']['add'](_0x2e9855(0xb2),{},{'repeat':{'cron':'*/20\x20*\x20*\x20*\x20*\x20*','key':_0x2e9855(0xcb)},'removeOnComplete':!![]}),exports['userMonitor'][_0x2e9855(0x131)](_0x2e9855(0xb6),{},{'repeat':{'cron':_0x2e9855(0x164),'key':_0x2e9855(0xd4)},'removeOnComplete':!![]}),exports[_0x2e9855(0xa3)][_0x2e9855(0x131)](_0x2e9855(0xe0),{},{'repeat':{'cron':'*/20\x20*\x20*\x20*\x20*\x20*','key':_0x2e9855(0xc8)},'removeOnComplete':!![]});}exports['startQueueProcess']=startQueueProcess;