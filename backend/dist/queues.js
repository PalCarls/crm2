'use strict';const a346_0x1927ef=a346_0x3e9c;(function(_0x5b5657,_0x15539b){const _0xea8acb=a346_0x3e9c,_0x4c201d=_0x5b5657();while(!![]){try{const _0x17415b=parseInt(_0xea8acb(0xe4))/0x1*(parseInt(_0xea8acb(0xd1))/0x2)+parseInt(_0xea8acb(0xcf))/0x3*(parseInt(_0xea8acb(0x136))/0x4)+-parseInt(_0xea8acb(0x142))/0x5*(-parseInt(_0xea8acb(0x159))/0x6)+parseInt(_0xea8acb(0x17d))/0x7*(-parseInt(_0xea8acb(0x118))/0x8)+-parseInt(_0xea8acb(0x18b))/0x9*(parseInt(_0xea8acb(0x18c))/0xa)+-parseInt(_0xea8acb(0x107))/0xb*(-parseInt(_0xea8acb(0x151))/0xc)+-parseInt(_0xea8acb(0xea))/0xd;if(_0x17415b===_0x15539b)break;else _0x4c201d['push'](_0x4c201d['shift']());}catch(_0x16d805){_0x4c201d['push'](_0x4c201d['shift']());}}}(a346_0x4495,0x1e8c5));var __createBinding=this&&this[a346_0x1927ef(0x131)]||(Object['create']?function(_0x215123,_0xc0d5ae,_0x330b3a,_0xb89f6b){const _0x1400fb=a346_0x1927ef;if(_0xb89f6b===undefined)_0xb89f6b=_0x330b3a;var _0x34872d=Object[_0x1400fb(0x103)](_0xc0d5ae,_0x330b3a);(!_0x34872d||(_0x1400fb(0x17b)in _0x34872d?!_0xc0d5ae['__esModule']:_0x34872d['writable']||_0x34872d[_0x1400fb(0x139)]))&&(_0x34872d={'enumerable':!![],'get':function(){return _0xc0d5ae[_0x330b3a];}}),Object[_0x1400fb(0x10d)](_0x215123,_0xb89f6b,_0x34872d);}:function(_0x210488,_0x15d0de,_0x431098,_0x28d885){if(_0x28d885===undefined)_0x28d885=_0x431098;_0x210488[_0x28d885]=_0x15d0de[_0x431098];}),__setModuleDefault=this&&this[a346_0x1927ef(0xae)]||(Object[a346_0x1927ef(0x110)]?function(_0x407a45,_0x1a7a9b){const _0x1226f=a346_0x1927ef;Object[_0x1226f(0x10d)](_0x407a45,_0x1226f(0x140),{'enumerable':!![],'value':_0x1a7a9b});}:function(_0x23d49b,_0x32692c){const _0x4a0c60=a346_0x1927ef;_0x23d49b[_0x4a0c60(0x140)]=_0x32692c;}),__importStar=this&&this['__importStar']||function(_0x3f229f){const _0x5467f2=a346_0x1927ef;if(_0x3f229f&&_0x3f229f['__esModule'])return _0x3f229f;var _0x2e4d40={};if(_0x3f229f!=null){for(var _0xfe1dc3 in _0x3f229f)if(_0xfe1dc3!==_0x5467f2(0x140)&&Object[_0x5467f2(0x119)][_0x5467f2(0x137)][_0x5467f2(0x184)](_0x3f229f,_0xfe1dc3))__createBinding(_0x2e4d40,_0x3f229f,_0xfe1dc3);}return __setModuleDefault(_0x2e4d40,_0x3f229f),_0x2e4d40;},__importDefault=this&&this[a346_0x1927ef(0x177)]||function(_0x361ffe){const _0x2837a2=a346_0x1927ef;return _0x361ffe&&_0x361ffe[_0x2837a2(0xa4)]?_0x361ffe:{'default':_0x361ffe};};Object[a346_0x1927ef(0x10d)](exports,'__esModule',{'value':!![]}),exports[a346_0x1927ef(0xd4)]=exports[a346_0x1927ef(0xa0)]=exports[a346_0x1927ef(0x15f)]=exports[a346_0x1927ef(0xf9)]=exports['queueMonitor']=exports[a346_0x1927ef(0x121)]=exports[a346_0x1927ef(0x9a)]=exports['scheduleMonitor']=exports[a346_0x1927ef(0x14b)]=void 0x0;const Sentry=__importStar(require(a346_0x1927ef(0xf2))),bull_1=__importDefault(require(a346_0x1927ef(0xc0))),SendMessage_1=require(a346_0x1927ef(0xba)),Whatsapp_1=__importDefault(require(a346_0x1927ef(0xf6))),logger_1=require(a346_0x1927ef(0x13e)),moment_1=__importDefault(require(a346_0x1927ef(0x157))),Schedule_1=__importDefault(require(a346_0x1927ef(0xbb))),sequelize_1=require('sequelize'),GetDefaultWhatsApp_1=__importDefault(require(a346_0x1927ef(0x182))),Campaign_1=__importDefault(require(a346_0x1927ef(0x124))),Queue_1=__importDefault(require(a346_0x1927ef(0x14d))),ContactList_1=__importDefault(require(a346_0x1927ef(0x176))),ContactListItem_1=__importDefault(require(a346_0x1927ef(0x10f))),lodash_1=require(a346_0x1927ef(0x146)),CampaignSetting_1=__importDefault(require(a346_0x1927ef(0x15c))),CampaignShipping_1=__importDefault(require(a346_0x1927ef(0x9d))),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require('./database')),SendWhatsAppMedia_1=require(a346_0x1927ef(0xd6)),socket_1=require(a346_0x1927ef(0x126)),path_1=__importDefault(require('path')),User_1=__importDefault(require(a346_0x1927ef(0x12b))),Company_1=__importDefault(require(a346_0x1927ef(0x16b))),Contact_1=__importDefault(require(a346_0x1927ef(0x93))),Queue_2=__importDefault(require(a346_0x1927ef(0x14d))),wbotClosedTickets_1=require(a346_0x1927ef(0xa1)),Ticket_1=__importDefault(require('./models/Ticket')),ShowContactService_1=__importDefault(require('./services/ContactServices/ShowContactService')),UserQueue_1=__importDefault(require('./models/UserQueue')),ShowTicketService_1=__importDefault(require('./services/TicketServices/ShowTicketService')),SendWhatsAppMessage_1=__importDefault(require(a346_0x1927ef(0xc1))),UpdateTicketService_1=__importDefault(require('./services/TicketServices/UpdateTicketService')),date_fns_1=require('date-fns'),GetWhatsapp_1=require('./helpers/GetWhatsapp'),nodemailer=require(a346_0x1927ef(0x152)),CronJob=require(a346_0x1927ef(0x17f))['CronJob'],CompaniesSettings_1=__importDefault(require('./models/CompaniesSettings')),wbotMessageListener_1=require('./services/WbotServices/wbotMessageListener'),FindOrCreateTicketService_1=__importDefault(require(a346_0x1927ef(0xdb))),connection=process[a346_0x1927ef(0x141)]['REDIS_URI']||'',limiterMax=process[a346_0x1927ef(0x141)][a346_0x1927ef(0xb1)]||0x1,limiterDuration=process[a346_0x1927ef(0x141)]['REDIS_OPT_LIMITER_DURATION']||0xbb8;exports[a346_0x1927ef(0x14b)]=new bull_1[(a346_0x1927ef(0x140))](a346_0x1927ef(0x143),connection),exports[a346_0x1927ef(0x175)]=new bull_1[(a346_0x1927ef(0x140))](a346_0x1927ef(0x163),connection),exports[a346_0x1927ef(0x9a)]=new bull_1[(a346_0x1927ef(0x140))](a346_0x1927ef(0xb4),connection),exports['campaignQueue']=new bull_1[(a346_0x1927ef(0x140))]('CampaignQueue',connection),exports[a346_0x1927ef(0x133)]=new bull_1[(a346_0x1927ef(0x140))](a346_0x1927ef(0xf8),connection),exports[a346_0x1927ef(0xf9)]=new bull_1['default'](a346_0x1927ef(0x130),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x5b8a17){const _0x31ac11=a346_0x1927ef;try{const {data:_0x11c843}=_0x5b8a17,_0x1e5e43=await Whatsapp_1[_0x31ac11(0x140)]['findByPk'](_0x11c843['whatsappId']);if(_0x1e5e43===null)throw Error('Whatsapp\x20nÃ£o\x20identificado');const _0x43a60e=_0x11c843['data'];await(0x0,SendMessage_1[_0x31ac11(0xf4)])(_0x1e5e43,_0x43a60e);}catch(_0x308c63){Sentry[_0x31ac11(0x102)](_0x308c63),logger_1[_0x31ac11(0x11f)][_0x31ac11(0x18d)]('MessageQueue\x20->\x20SendMessage:\x20error',_0x308c63[_0x31ac11(0xda)]);throw _0x308c63;}}async function handleVerifySchedules(_0x24783e){const _0x39f8b9=a346_0x1927ef;try{const {count:_0x576c8c,rows:_0x226748}=await Schedule_1[_0x39f8b9(0x140)][_0x39f8b9(0xeb)]({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op'][_0x39f8b9(0x14a)]]:(0x0,moment_1['default'])()[_0x39f8b9(0xc2)]('YYYY-MM-DD\x20HH:mm:ss'),[sequelize_1['Op'][_0x39f8b9(0x14f)]]:(0x0,moment_1[_0x39f8b9(0x140)])()[_0x39f8b9(0xfa)]('30',_0x39f8b9(0xfd))[_0x39f8b9(0xc2)](_0x39f8b9(0x167))}},'include':[{'model':Contact_1[_0x39f8b9(0x140)],'as':_0x39f8b9(0x14e)}]});_0x576c8c>0x0&&_0x226748[_0x39f8b9(0x169)](async _0x2e427b=>{const _0x34d8b3=_0x39f8b9;await _0x2e427b[_0x34d8b3(0x17e)]({'status':'AGENDADA'}),exports[_0x34d8b3(0x9a)][_0x34d8b3(0xfa)](_0x34d8b3(0xf4),{'schedule':_0x2e427b},{'delay':0x9c40}),logger_1[_0x34d8b3(0x11f)][_0x34d8b3(0xad)](_0x34d8b3(0x10c)+_0x2e427b[_0x34d8b3(0x14e)][_0x34d8b3(0x11c)]);});}catch(_0x53e2fc){Sentry[_0x39f8b9(0x102)](_0x53e2fc),logger_1[_0x39f8b9(0x11f)][_0x39f8b9(0x18d)](_0x39f8b9(0x189),_0x53e2fc[_0x39f8b9(0xda)]);throw _0x53e2fc;}}async function handleSendScheduledMessage(_0x5cc245){const _0x440469=a346_0x1927ef,{data:{schedule:_0x3445d}}=_0x5cc245;let _0xd6bf2a=null;try{_0xd6bf2a=await Schedule_1[_0x440469(0x140)][_0x440469(0xcc)](_0x3445d['id']);}catch(_0x51b783){Sentry[_0x440469(0x102)](_0x51b783),logger_1['logger'][_0x440469(0xad)]('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x3445d['id']);}try{const _0x48a640=await(0x0,GetDefaultWhatsApp_1[_0x440469(0x140)])(_0x3445d['companyId']),_0x26022f=await CompaniesSettings_1[_0x440469(0x140)]['findOne']({'where':{'companyId':_0x3445d[_0x440469(0xd0)]}}),{ticket:_0x36a712}=await(0x0,FindOrCreateTicketService_1['default'])(_0x3445d[_0x440469(0x14e)],_0x48a640,0x1,_0x3445d[_0x440469(0xd0)],0x0,0x0,null,'whatsapp',![],![],_0x26022f),_0x59c414=await(0x0,SendMessage_1[_0x440469(0xf4)])(_0x48a640,{'number':_0x3445d['contact'][_0x440469(0x154)],'body':_0x3445d[_0x440469(0x120)]});await(0x0,wbotMessageListener_1[_0x440469(0x16c)])(_0x59c414,_0x36a712,_0x3445d[_0x440469(0x14e)]['number']),await _0xd6bf2a?.[_0x440469(0x17e)]({'sentAt':(0x0,moment_1['default'])()[_0x440469(0xc2)](_0x440469(0xc8)),'status':_0x440469(0x95)}),logger_1[_0x440469(0x11f)][_0x440469(0xad)](_0x440469(0xdc)+_0x3445d['contact'][_0x440469(0x11c)]),exports['sendScheduledMessages'][_0x440469(0x160)](0x3a98,_0x440469(0xf3));}catch(_0x3a61b2){Sentry['captureException'](_0x3a61b2),await _0xd6bf2a?.[_0x440469(0x17e)]({'status':'ERRO'}),logger_1['logger'][_0x440469(0x18d)](_0x440469(0x115),_0x3a61b2['message']);throw _0x3a61b2;}}async function handleVerifyCampaigns(_0x370775){const _0x54c05a=a346_0x1927ef,_0x3869fa=await database_1[_0x54c05a(0x140)][_0x54c05a(0x13d)](_0x54c05a(0x10b),{'type':sequelize_1[_0x54c05a(0xac)][_0x54c05a(0xf5)]});if(_0x3869fa[_0x54c05a(0xd2)]>0x0)logger_1[_0x54c05a(0x11f)][_0x54c05a(0xad)](_0x54c05a(0x125)+_0x3869fa[_0x54c05a(0xd2)]);for(let _0x5856f1 of _0x3869fa){try{const _0x1834df=(0x0,moment_1[_0x54c05a(0x140)])(),_0x13ca71=(0x0,moment_1['default'])(_0x5856f1[_0x54c05a(0xbd)]),_0x1b86ae=_0x13ca71['diff'](_0x1834df,_0x54c05a(0xa2));logger_1['logger'][_0x54c05a(0xad)](_0x54c05a(0x105)+_0x5856f1['id']+',\x20Delay\x20Inicial='+_0x1b86ae),exports[_0x54c05a(0x121)][_0x54c05a(0xfa)](_0x54c05a(0x186),{'id':_0x5856f1['id'],'delay':_0x1b86ae},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x4b2fa9){Sentry[_0x54c05a(0x102)](_0x4b2fa9);}}}async function getCampaign(_0x308c4f){const _0x6d58c=a346_0x1927ef;return await Campaign_1[_0x6d58c(0x140)][_0x6d58c(0x12f)]({'where':{'id':_0x308c4f},'include':[{'model':ContactList_1[_0x6d58c(0x140)],'as':_0x6d58c(0x156),'attributes':['id',_0x6d58c(0x11c)],'include':[{'model':ContactListItem_1[_0x6d58c(0x140)],'as':_0x6d58c(0xab),'attributes':['id',_0x6d58c(0x11c),_0x6d58c(0x154),_0x6d58c(0x178),_0x6d58c(0xc5),_0x6d58c(0xb9)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x6d58c(0xde),'attributes':['id','name']}]});}async function getContact(_0x47f75a){const _0x1cab9d=a346_0x1927ef;return await ContactListItem_1[_0x1cab9d(0x140)][_0x1cab9d(0xcc)](_0x47f75a,{'attributes':['id',_0x1cab9d(0x11c),_0x1cab9d(0x154),_0x1cab9d(0x178),_0x1cab9d(0xb9)]});}async function getSettings(_0x502e38){const _0x4e69eb=a346_0x1927ef;try{const _0x3054e9=await CampaignSetting_1['default'][_0x4e69eb(0xd5)]({'where':{'companyId':_0x502e38[_0x4e69eb(0xd0)]},'attributes':[_0x4e69eb(0x10e),_0x4e69eb(0xfe)]});let _0x546193=0x14,_0x2ad320=0x14,_0x3a2ac8=0x3c,_0x53a33c=[];return _0x3054e9['forEach'](_0x5a7865=>{const _0x37353a=_0x4e69eb;_0x5a7865[_0x37353a(0x10e)]===_0x37353a(0x150)&&(_0x546193=JSON['parse'](_0x5a7865[_0x37353a(0xfe)])),_0x5a7865[_0x37353a(0x10e)]==='longerIntervalAfter'&&(_0x2ad320=JSON[_0x37353a(0xb3)](_0x5a7865[_0x37353a(0xfe)])),_0x5a7865[_0x37353a(0x10e)]===_0x37353a(0x109)&&(_0x3a2ac8=JSON['parse'](_0x5a7865[_0x37353a(0xfe)])),_0x5a7865['key']==='variables'&&(_0x53a33c=JSON['parse'](_0x5a7865[_0x37353a(0xfe)]));}),{'messageInterval':_0x546193,'longerIntervalAfter':_0x2ad320,'greaterInterval':_0x3a2ac8,'variables':_0x53a33c};}catch(_0x23a7b5){console[_0x4e69eb(0x166)](_0x23a7b5);throw _0x23a7b5;}}function parseToMilliseconds(_0x172dfa){return _0x172dfa*0x3e8;}exports['parseToMilliseconds']=parseToMilliseconds;async function sleep(_0x23d883){const _0x516cfc=a346_0x1927ef;return logger_1[_0x516cfc(0x11f)][_0x516cfc(0xad)](_0x516cfc(0x117)+_0x23d883+'\x20segundos\x20iniciado:\x20'+(0x0,moment_1[_0x516cfc(0x140)])()['format'](_0x516cfc(0xd8))),new Promise(_0x53589d=>{setTimeout(()=>{const _0x27cbb6=a346_0x3e9c;logger_1[_0x27cbb6(0x11f)]['info'](_0x27cbb6(0x117)+_0x23d883+_0x27cbb6(0x128)+(0x0,moment_1[_0x27cbb6(0x140)])()[_0x27cbb6(0xc2)](_0x27cbb6(0xd8))),_0x53589d(!![]);},parseToMilliseconds(_0x23d883));});}function getCampaignValidMessages(_0x5a2961){const _0x12d125=a346_0x1927ef,_0x1dc191=[];return!(0x0,lodash_1[_0x12d125(0x162)])(_0x5a2961[_0x12d125(0xc6)])&&!(0x0,lodash_1[_0x12d125(0xa7)])(_0x5a2961[_0x12d125(0xc6)])&&_0x1dc191[_0x12d125(0x188)](_0x5a2961[_0x12d125(0xc6)]),!(0x0,lodash_1[_0x12d125(0x162)])(_0x5a2961['message2'])&&!(0x0,lodash_1[_0x12d125(0xa7)])(_0x5a2961['message2'])&&_0x1dc191[_0x12d125(0x188)](_0x5a2961[_0x12d125(0xfb)]),!(0x0,lodash_1[_0x12d125(0x162)])(_0x5a2961['message3'])&&!(0x0,lodash_1[_0x12d125(0xa7)])(_0x5a2961['message3'])&&_0x1dc191[_0x12d125(0x188)](_0x5a2961[_0x12d125(0x94)]),!(0x0,lodash_1[_0x12d125(0x162)])(_0x5a2961[_0x12d125(0x13a)])&&!(0x0,lodash_1[_0x12d125(0xa7)])(_0x5a2961[_0x12d125(0x13a)])&&_0x1dc191[_0x12d125(0x188)](_0x5a2961[_0x12d125(0x13a)]),!(0x0,lodash_1[_0x12d125(0x162)])(_0x5a2961['message5'])&&!(0x0,lodash_1[_0x12d125(0xa7)])(_0x5a2961[_0x12d125(0x99)])&&_0x1dc191[_0x12d125(0x188)](_0x5a2961['message5']),_0x1dc191;}function getCampaignValidConfirmationMessages(_0x4a3d1b){const _0x585e3e=a346_0x1927ef,_0x366d13=[];return!(0x0,lodash_1['isEmpty'])(_0x4a3d1b['confirmationMessage1'])&&!(0x0,lodash_1[_0x585e3e(0xa7)])(_0x4a3d1b[_0x585e3e(0x9e)])&&_0x366d13[_0x585e3e(0x188)](_0x4a3d1b[_0x585e3e(0x9e)]),!(0x0,lodash_1[_0x585e3e(0x162)])(_0x4a3d1b[_0x585e3e(0x144)])&&!(0x0,lodash_1[_0x585e3e(0xa7)])(_0x4a3d1b['confirmationMessage2'])&&_0x366d13[_0x585e3e(0x188)](_0x4a3d1b['confirmationMessage2']),!(0x0,lodash_1[_0x585e3e(0x162)])(_0x4a3d1b[_0x585e3e(0x14c)])&&!(0x0,lodash_1['isNil'])(_0x4a3d1b[_0x585e3e(0x14c)])&&_0x366d13[_0x585e3e(0x188)](_0x4a3d1b[_0x585e3e(0x14c)]),!(0x0,lodash_1[_0x585e3e(0x162)])(_0x4a3d1b[_0x585e3e(0xee)])&&!(0x0,lodash_1[_0x585e3e(0xa7)])(_0x4a3d1b['confirmationMessage4'])&&_0x366d13[_0x585e3e(0x188)](_0x4a3d1b[_0x585e3e(0xee)]),!(0x0,lodash_1[_0x585e3e(0x162)])(_0x4a3d1b[_0x585e3e(0x180)])&&!(0x0,lodash_1[_0x585e3e(0xa7)])(_0x4a3d1b[_0x585e3e(0x180)])&&_0x366d13[_0x585e3e(0x188)](_0x4a3d1b[_0x585e3e(0x180)]),_0x366d13;}function getProcessedMessage(_0x4d8185,_0x7537a4,_0x1383ba){const _0x3ae2de=a346_0x1927ef;let _0x5f34f1=_0x4d8185;return _0x5f34f1[_0x3ae2de(0xef)]('{nome}')&&(_0x5f34f1=_0x5f34f1['replace'](/{nome}/g,_0x1383ba[_0x3ae2de(0x11c)])),_0x5f34f1[_0x3ae2de(0xef)]('{email}')&&(_0x5f34f1=_0x5f34f1[_0x3ae2de(0x122)](/{email}/g,_0x1383ba[_0x3ae2de(0x178)])),_0x5f34f1[_0x3ae2de(0xef)]('{numero}')&&(_0x5f34f1=_0x5f34f1[_0x3ae2de(0x122)](/{numero}/g,_0x1383ba['number'])),_0x7537a4[0x0]?.[_0x3ae2de(0xfe)]!=='[]'&&_0x7537a4['forEach'](_0x2a92b6=>{const _0x60fc03=_0x3ae2de;if(_0x5f34f1[_0x60fc03(0xef)]('{'+_0x2a92b6[_0x60fc03(0x10e)]+'}')){const _0xb8babf=new RegExp('{'+_0x2a92b6[_0x60fc03(0x10e)]+'}','g');_0x5f34f1=_0x5f34f1['replace'](_0xb8babf,_0x2a92b6[_0x60fc03(0xfe)]);}}),_0x5f34f1;}const checkerWeek=async()=>{const _0x265418=a346_0x1927ef,_0x3c9f6c=(0x0,moment_1[_0x265418(0x140)])()[_0x265418(0xbe)]()===0x6,_0x361170=(0x0,moment_1[_0x265418(0x140)])()[_0x265418(0xbe)]()===0x0,_0x464f39=await CampaignSetting_1[_0x265418(0x140)][_0x265418(0x12f)]({'where':{'key':_0x265418(0x123)}}),_0xc16ada=await CampaignSetting_1[_0x265418(0x140)]['findOne']({'where':{'key':_0x265418(0x165)}});if(_0x464f39?.[_0x265418(0xfe)]===_0x265418(0x174)&&_0x3c9f6c)return exports[_0x265418(0xf9)][_0x265418(0x158)](),!![];if(_0xc16ada?.[_0x265418(0xfe)]==='false'&&_0x361170)return exports['messageQueue']['pause'](),!![];return exports['messageQueue'][_0x265418(0x114)](),![];},checkTime=async()=>{const _0x59108d=a346_0x1927ef,_0x6ade77=await CampaignSetting_1[_0x59108d(0x140)][_0x59108d(0x12f)]({'where':{'key':_0x59108d(0xa3)}}),_0x340c68=await CampaignSetting_1[_0x59108d(0x140)]['findOne']({'where':{'key':_0x59108d(0xb5)}}),_0x2454de=_0x6ade77[_0x59108d(0xfe)],_0x461c1f=_0x340c68[_0x59108d(0xfe)],_0x219177=(0x0,moment_1[_0x59108d(0x140)])()['format'](_0x59108d(0x153));if(_0x219177<=_0x461c1f&&_0x219177>=_0x2454de)return exports[_0x59108d(0xf9)][_0x59108d(0x114)](),!![];return logger_1[_0x59108d(0x11f)][_0x59108d(0xad)](_0x59108d(0x129)+_0x2454de+_0x59108d(0x185)+_0x461c1f+_0x59108d(0xe6)+_0x219177+_0x59108d(0xe3)),exports['messageQueue'][_0x59108d(0x160)](0x0,_0x59108d(0x12a)),exports['messageQueue'][_0x59108d(0x160)](0x0,'wait'),exports[_0x59108d(0xf9)][_0x59108d(0x160)](0x0,'active'),exports[_0x59108d(0xf9)][_0x59108d(0x160)](0x0,_0x59108d(0xf3)),exports[_0x59108d(0xf9)]['clean'](0x0,'failed'),exports['messageQueue'][_0x59108d(0x158)](),![];};function randomValue(_0x5572a7,_0x3e912a){const _0x1613a7=a346_0x1927ef;return Math[_0x1613a7(0x13f)](Math['random']()*_0x3e912a)+_0x5572a7;}exports[a346_0x1927ef(0xa0)]=randomValue;async function verifyAndFinalizeCampaign(_0x1349f7){const _0xc3f7b3=a346_0x1927ef,{contacts:_0x21c641}=_0x1349f7[_0xc3f7b3(0x156)],_0xbacb23=_0x21c641[_0xc3f7b3(0xd2)],_0x2b6f9f=await CampaignShipping_1[_0xc3f7b3(0x140)][_0xc3f7b3(0xec)]({'where':{'campaignId':_0x1349f7['id'],'deliveredAt':{[sequelize_1['Op'][_0xc3f7b3(0xcd)]]:null}}});_0xbacb23===_0x2b6f9f&&await _0x1349f7[_0xc3f7b3(0x17e)]({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0xc3f7b3(0x140)])()});const _0x19a27e=(0x0,socket_1['getIO'])();_0x19a27e[_0xc3f7b3(0xc4)]('company-'+_0x1349f7[_0xc3f7b3(0xd0)]+'-campaign',{'action':_0xc3f7b3(0x17e),'record':_0x1349f7});}async function handleProcessCampaign(_0x19f32e){const _0x509aee=a346_0x1927ef;try{const {id:_0x4c2d41}=_0x19f32e[_0x509aee(0xdd)],_0x5d30c5=await getCampaign(_0x4c2d41),_0x21e89b=await getSettings(_0x5d30c5);if(_0x5d30c5){const {contacts:_0x3446bb}=_0x5d30c5[_0x509aee(0x156)];if((0x0,lodash_1[_0x509aee(0xe0)])(_0x3446bb)){const _0x11499b=_0x3446bb[_0x509aee(0x169)](_0x49bb84=>({'contactId':_0x49bb84['id'],'campaignId':_0x5d30c5['id'],'variables':_0x21e89b[_0x509aee(0x15e)],'isGroup':_0x49bb84[_0x509aee(0xb9)]})),_0x53a259=parseToMilliseconds(_0x21e89b[_0x509aee(0x92)]),_0x5d037f=parseToMilliseconds(_0x21e89b[_0x509aee(0x109)]),_0x4a3ffe=_0x21e89b[_0x509aee(0x150)];let _0x5c4464=_0x5d30c5['scheduledAt'];const _0x220c45=[];for(let _0x822597=0x0;_0x822597<_0x11499b['length'];_0x822597++){_0x5c4464=(0x0,date_fns_1[_0x509aee(0xcb)])(_0x5c4464,_0x822597>_0x53a259?_0x5d037f:_0x4a3ffe);const {contactId:_0x2a3983,campaignId:_0x4446bc,variables:_0x5ab98d}=_0x11499b[_0x822597],_0x2627f7=calculateDelay(_0x822597,_0x5c4464,_0x53a259,_0x5d037f,_0x4a3ffe),_0xe6fa35=exports[_0x509aee(0x121)][_0x509aee(0xfa)](_0x509aee(0x97),{'contactId':_0x2a3983,'campaignId':_0x4446bc,'variables':_0x5ab98d,'delay':_0x2627f7},{'removeOnComplete':!![]});_0x220c45[_0x509aee(0x188)](_0xe6fa35),logger_1['logger']['info']('Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha='+_0x5d30c5['id']+_0x509aee(0x11e)+_0x3446bb[_0x822597][_0x509aee(0x11c)]+';delay='+_0x2627f7);}await Promise[_0x509aee(0x16f)](_0x220c45),await _0x5d30c5[_0x509aee(0x17e)]({'status':_0x509aee(0x132)});}}}catch(_0x18d675){Sentry[_0x509aee(0x102)](_0x18d675);}}function calculateDelay(_0x3a7f3d,_0x22db35,_0x4802f4,_0x277a43,_0x1adc0c){const _0x317658=(0x0,date_fns_1['differenceInSeconds'])(_0x22db35,new Date());return _0x3a7f3d>_0x4802f4?_0x317658*0x3e8+_0x277a43:_0x317658*0x3e8+_0x1adc0c;}async function handlePrepareContact(_0x4d9596){const _0x3d00ee=a346_0x1927ef;try{const {contactId:_0x3ae6fe,campaignId:_0x3bff22,delay:_0x5d0acc,variables:_0x266bf9}=_0x4d9596[_0x3d00ee(0xdd)],_0x56932b=await getCampaign(_0x3bff22),_0x24a9ab=await getContact(_0x3ae6fe),_0xed9996={};_0xed9996[_0x3d00ee(0x154)]=_0x24a9ab[_0x3d00ee(0x154)],_0xed9996['contactId']=_0x3ae6fe,_0xed9996[_0x3d00ee(0x187)]=_0x3bff22;const _0x3b9249=getCampaignValidMessages(_0x56932b);if(_0x3b9249[_0x3d00ee(0xd2)]){const _0x388fbc=randomValue(0x0,_0x3b9249[_0x3d00ee(0xd2)]),_0x45e2fb=getProcessedMessage(_0x3b9249[_0x388fbc],_0x266bf9,_0x24a9ab);_0xed9996[_0x3d00ee(0xda)]='â\x20'+_0x45e2fb;}if(_0x56932b[_0x3d00ee(0x179)]){const _0x3673ca=getCampaignValidConfirmationMessages(_0x56932b);if(_0x3673ca['length']){const _0x5641f1=randomValue(0x0,_0x3673ca[_0x3d00ee(0xd2)]),_0x4c8662=getProcessedMessage(_0x3673ca[_0x5641f1],_0x266bf9,_0x24a9ab);_0xed9996[_0x3d00ee(0x16a)]='â\x20'+_0x4c8662;}}const [_0x31a072,_0x3f2e13]=await CampaignShipping_1['default'][_0x3d00ee(0x113)]({'where':{'campaignId':_0xed9996['campaignId'],'contactId':_0xed9996[_0x3d00ee(0x9b)]},'defaults':_0xed9996});!_0x3f2e13&&_0x31a072[_0x3d00ee(0xa8)]===null&&_0x31a072[_0x3d00ee(0x112)]===null&&(_0x31a072[_0x3d00ee(0x9f)](_0xed9996),await _0x31a072['save']());if(_0x31a072[_0x3d00ee(0xa8)]===null&&_0x31a072['confirmationRequestedAt']===null){const _0x126460=await exports['campaignQueue']['add'](_0x3d00ee(0x98),{'campaignId':_0x56932b['id'],'campaignShippingId':_0x31a072['id'],'contactListItemId':_0x3ae6fe},{'delay':_0x5d0acc});await _0x31a072[_0x3d00ee(0x17e)]({'jobId':_0x126460['id']});}await verifyAndFinalizeCampaign(_0x56932b);}catch(_0x13b301){Sentry['captureException'](_0x13b301),logger_1[_0x3d00ee(0x11f)]['error']('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0x13b301[_0x3d00ee(0xda)]);}}async function handleDispatchCampaign(_0x3200ac){const _0x10d95f=a346_0x1927ef;try{const {data:_0x5d7c73}=_0x3200ac,{campaignShippingId:_0x56e776,campaignId:_0x256bda}=_0x5d7c73,_0xe2dfcf=await getCampaign(_0x256bda),_0x2ad2ed=await(0x0,GetWhatsappWbot_1[_0x10d95f(0x140)])(_0xe2dfcf['whatsapp']);if(!_0x2ad2ed){logger_1[_0x10d95f(0x11f)][_0x10d95f(0x18d)](_0x10d95f(0x101));return;}if(!_0xe2dfcf[_0x10d95f(0xde)]){logger_1['logger']['error'](_0x10d95f(0x172));return;}if(!_0x2ad2ed?.[_0x10d95f(0xa9)]?.['id']){logger_1['logger'][_0x10d95f(0x18d)](_0x10d95f(0xe1));return;}logger_1['logger']['info'](_0x10d95f(0x100)+_0x256bda+';Registro='+_0x56e776);const _0x36b13d=await CampaignShipping_1[_0x10d95f(0x140)][_0x10d95f(0xcc)](_0x56e776,{'include':[{'model':ContactListItem_1[_0x10d95f(0x140)],'as':'contact'}]}),_0x579e16=_0x36b13d['contact']['isGroup']?_0x36b13d[_0x10d95f(0x154)]+_0x10d95f(0xa5):_0x36b13d[_0x10d95f(0x154)]+_0x10d95f(0x147);let _0x346ac3=_0x36b13d[_0x10d95f(0xda)];_0xe2dfcf['confirmation']&&_0x36b13d['confirmation']===null&&(_0x346ac3=_0x36b13d[_0x10d95f(0x16a)]);if(_0xe2dfcf[_0x10d95f(0x90)]===_0x10d95f(0x18a)){const _0x4f1b6f=await Contact_1[_0x10d95f(0x140)][_0x10d95f(0x12f)]({'where':{'number':_0x36b13d[_0x10d95f(0x154)]}}),_0x5cd42e=await Whatsapp_1[_0x10d95f(0x140)]['findByPk'](_0xe2dfcf[_0x10d95f(0x91)]),_0x2d2789=await CompaniesSettings_1[_0x10d95f(0x140)][_0x10d95f(0x12f)]({'where':{'companyId':_0xe2dfcf[_0x10d95f(0xd0)]}}),{ticket:_0x230aee}=await(0x0,FindOrCreateTicketService_1[_0x10d95f(0x140)])(_0x4f1b6f,_0x5cd42e,0x1,_0xe2dfcf[_0x10d95f(0xd0)],_0xe2dfcf?.['queueId'],_0xe2dfcf?.[_0x10d95f(0x12e)],null,_0x10d95f(0xde),![],![],_0x2d2789);if(_0xe2dfcf[_0x10d95f(0x183)]===null){const _0x4eccd7=await(0x0,SendWhatsAppMessage_1[_0x10d95f(0x140)])({'body':_0x346ac3,'ticket':_0x230aee});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x4eccd7,_0x230aee,_0x230aee[_0x10d95f(0x14e)]);}else{const _0x493b45=path_1[_0x10d95f(0x140)]['resolve'](__dirname,'..',_0x10d95f(0x17c)),_0x40d969=path_1[_0x10d95f(0x140)][_0x10d95f(0x148)](_0x493b45,_0x10d95f(0xf1)+_0xe2dfcf['companyId'],_0xe2dfcf[_0x10d95f(0x183)]),_0x8c357a=await(0x0,SendWhatsAppMedia_1[_0x10d95f(0x155)])(_0xe2dfcf[_0x10d95f(0x108)],_0x40d969,_0xe2dfcf[_0x10d95f(0xd0)][_0x10d95f(0x9c)](),_0x346ac3);if(Object['keys'](_0x8c357a)[_0x10d95f(0xd2)]){const _0x2862f9=await _0x2ad2ed[_0x10d95f(0xca)](_0x579e16,{..._0x8c357a});await(0x0,wbotMessageListener_1[_0x10d95f(0xff)])(_0x2862f9,_0x230aee,_0x230aee[_0x10d95f(0x14e)]);}}_0xe2dfcf?.[_0x10d95f(0x13c)]===_0x10d95f(0xd7)&&await _0x230aee[_0x10d95f(0x17e)]({'status':'closed'}),await _0x36b13d[_0x10d95f(0x17e)]({'deliveredAt':(0x0,moment_1[_0x10d95f(0x140)])()});}else{if(_0xe2dfcf[_0x10d95f(0x183)]){const _0x1c6295=path_1[_0x10d95f(0x140)][_0x10d95f(0xb2)](__dirname,'..',_0x10d95f(0x17c)),_0x18f3f0=path_1[_0x10d95f(0x140)][_0x10d95f(0x148)](_0x1c6295,'company'+_0xe2dfcf['companyId'],_0xe2dfcf['mediaPath']),_0x2b9019=await(0x0,SendWhatsAppMedia_1[_0x10d95f(0x155)])(_0xe2dfcf['mediaName'],_0x18f3f0,_0xe2dfcf['companyId'][_0x10d95f(0x9c)](),_0x346ac3);Object[_0x10d95f(0xc7)](_0x2b9019)[_0x10d95f(0xd2)]&&await _0x2ad2ed[_0x10d95f(0xca)](_0x579e16,{..._0x2b9019});}else _0xe2dfcf[_0x10d95f(0x179)]&&_0x36b13d[_0x10d95f(0x179)]===null?(await _0x2ad2ed[_0x10d95f(0xca)](_0x579e16,{'text':_0x346ac3}),await _0x36b13d[_0x10d95f(0x17e)]({'confirmationRequestedAt':(0x0,moment_1[_0x10d95f(0x140)])()})):await _0x2ad2ed[_0x10d95f(0xca)](_0x579e16,{'text':_0x346ac3});await _0x36b13d[_0x10d95f(0x17e)]({'deliveredAt':(0x0,moment_1[_0x10d95f(0x140)])()});}await verifyAndFinalizeCampaign(_0xe2dfcf);const _0x33413c=(0x0,socket_1['getIO'])();_0x33413c['emit']('company-'+_0xe2dfcf[_0x10d95f(0xd0)]+'-campaign',{'action':_0x10d95f(0x17e),'record':_0xe2dfcf}),logger_1['logger'][_0x10d95f(0xad)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x256bda+_0x10d95f(0x11e)+_0x36b13d[_0x10d95f(0x14e)][_0x10d95f(0x11c)]);}catch(_0x29d1b7){Sentry[_0x10d95f(0x102)](_0x29d1b7),logger_1[_0x10d95f(0x11f)][_0x10d95f(0x18d)](_0x29d1b7['message']),console[_0x10d95f(0x166)](_0x29d1b7[_0x10d95f(0xaa)]);}}async function handleLoginStatus(_0x4cc79c){const _0x31e1c8=a346_0x1927ef,_0x298b7d=await database_1[_0x31e1c8(0x140)]['query'](_0x31e1c8(0xe9),{'type':sequelize_1['QueryTypes'][_0x31e1c8(0xf5)]}),_0x35c222=_0x298b7d[_0x31e1c8(0x169)](_0x46a054=>_0x46a054['id']),_0x32274d=_0x35c222['join'](',\x20');try{const _0x1192a1=_0x31e1c8(0xf7)+_0x32274d+');',_0x103427=await database_1[_0x31e1c8(0x140)][_0x31e1c8(0x13d)](_0x1192a1,{'type':sequelize_1[_0x31e1c8(0xac)][_0x31e1c8(0xe8)]});}catch(_0x26e3eb){Sentry['captureException'](_0x26e3eb);}}async function handleVerifyQueue(_0x7be2c7){const _0x1b8a2f=a346_0x1927ef;try{const _0x2172c7=await Company_1[_0x1b8a2f(0x140)][_0x1b8a2f(0xd5)]({'attributes':['id',_0x1b8a2f(0x11c)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x1b8a2f(0x140)],'attributes':['id','name',_0x1b8a2f(0x170),'timeSendQueue',_0x1b8a2f(0xe5)]}]});_0x2172c7[_0x1b8a2f(0x169)](async _0x5ac7d7=>{const _0x51b57c=_0x1b8a2f;_0x5ac7d7['whatsapps'][_0x51b57c(0x169)](async _0xd07eb6=>{const _0x1fdaa1=_0x51b57c;if(_0xd07eb6[_0x1fdaa1(0x170)]===_0x1fdaa1(0xb8)){var _0x4e0685=_0x5ac7d7['id'];const _0x2bee9e=_0xd07eb6['timeSendQueue']?_0xd07eb6[_0x1fdaa1(0xa6)]:0x0,_0x457b4b=_0xd07eb6[_0x1fdaa1(0xe5)],_0x582093=_0x2bee9e,_0x26c6ac=_0x457b4b,_0x7c908d=_0x582093;if(_0x2bee9e>0x0){if(!isNaN(_0x26c6ac)&&Number['isInteger'](_0x26c6ac)&&!isNaN(_0x7c908d)&&Number['isInteger'](_0x7c908d)){const _0x39b72b=(0x0,moment_1[_0x1fdaa1(0x140)])()[_0x1fdaa1(0xaf)](_0x7c908d,_0x1fdaa1(0xb6))[_0x1fdaa1(0x161)]()[_0x1fdaa1(0xc2)](),{count:_0x3f7539,rows:_0x1ebe2f}=await Ticket_1['default'][_0x1fdaa1(0xeb)]({'attributes':['id'],'where':{'status':_0x1fdaa1(0x16d),'queueId':null,'companyId':_0x4e0685,'whatsappId':_0xd07eb6['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x39b72b}},'include':[{'model':Contact_1['default'],'as':_0x1fdaa1(0x14e),'attributes':['id',_0x1fdaa1(0x11c),'number',_0x1fdaa1(0x178),_0x1fdaa1(0xce),_0x1fdaa1(0xc3),_0x1fdaa1(0x96),_0x1fdaa1(0xe2),_0x1fdaa1(0x106),_0x1fdaa1(0xb0),_0x1fdaa1(0xd0)],'include':[_0x1fdaa1(0xd3),_0x1fdaa1(0xb7),_0x1fdaa1(0xc9)]},{'model':Queue_2[_0x1fdaa1(0x140)],'as':'queue','attributes':['id',_0x1fdaa1(0x11c),_0x1fdaa1(0x134)]},{'model':Whatsapp_1['default'],'as':_0x1fdaa1(0xde),'attributes':['id',_0x1fdaa1(0x11c),_0x1fdaa1(0x173),_0x1fdaa1(0x18e)]}]});_0x3f7539>0x0&&_0x1ebe2f[_0x1fdaa1(0x169)](async _0x52cc83=>{const _0x42dfcd=_0x1fdaa1;await _0x52cc83[_0x42dfcd(0x17e)]({'queueId':_0x26c6ac}),await _0x52cc83[_0x42dfcd(0xbf)]();const _0x294296=(0x0,socket_1[_0x42dfcd(0x17a)])();_0x294296['to'](_0x52cc83[_0x42dfcd(0x170)])['to'](_0x42dfcd(0x135))['to'](_0x52cc83['id'][_0x42dfcd(0x9c)]())[_0x42dfcd(0xc4)](_0x42dfcd(0x127)+_0x4e0685+_0x42dfcd(0x111),{'action':_0x42dfcd(0x17e),'ticket':_0x52cc83,'ticketId':_0x52cc83['id']}),logger_1['logger'][_0x42dfcd(0xad)](_0x42dfcd(0x138)+_0x52cc83['id']+'\x20-\x20Empresa:\x20'+_0x4e0685);});}else logger_1[_0x1fdaa1(0x11f)][_0x1fdaa1(0xad)]('CondiÃ§Ã£o\x20nÃ£o\x20respeitada\x20-\x20Empresa:\x20'+_0x4e0685);}}});});}catch(_0x4f7e03){Sentry[_0x1b8a2f(0x102)](_0x4f7e03),logger_1[_0x1b8a2f(0x11f)][_0x1b8a2f(0x18d)](_0x1b8a2f(0x171),_0x4f7e03[_0x1b8a2f(0xda)]);throw _0x4f7e03;}};function a346_0x4495(){const _0x19f485=['select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true','6395688QlAPWo','findAndCountAll','count','SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error','confirmationMessage4','includes','verify-login','company','@sentry/node','completed','SendMessage','SELECT','./models/Whatsapp','UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20(','QueueMonitor','messageQueue','add','message2','online','seconds','value','verifyMediaMessage','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','captureException','getOwnPropertyDescriptor','Ticket\x20ID\x20','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','urlPicture','902AIolqr','mediaName','greaterInterval','filter','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','Disparo\x20agendado\x20para:\x20','defineProperty','key','./models/ContactListItem','create','-ticket','confirmationRequestedAt','findOrCreate','resume','SendScheduledMessage\x20->\x20SendMessage:\x20error','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20VocÃª\x20serÃ¡\x20atendido\x20em\x20breve!','Sleep\x20de\x20','17816mYZWCE','prototype','profile','updatedAt','name','VerifyCampaignsDaatabase',';Contato=','logger','body','campaignQueue','replace','sabado','./models/Campaign','Campanhas\x20encontradas:\x20','./libs/socket','company-','\x20segundos\x20finalizado:\x20','Envio\x20inicia\x20as\x20','delayed','./models/User','process','ClosedAllOpenTickets\x20->\x20Verify:\x20error','userId','findOne','MessageQueue','__createBinding','EM_ANDAMENTO','queueMonitor','color','notification','272nUSxay','hasOwnProperty','Atendimento\x20Perdido:\x20','configurable','message4','Verify','statusTicket','query','./utils/logger','floor','default','env','4825yiZYwI','UserMonitor','confirmationMessage2','ClosedAllOpenTickets','lodash','@s.whatsapp.net','join','verify-queue','gte','userMonitor','confirmationMessage3','./models/Queue','contact','lte','messageInterval','35472KqcheC','nodemailer','HH:mm','number','getMessageOptions','contactList','moment','pause','1158hpeeTf','verify','*/5\x20*\x20*\x20*\x20*\x20*','./models/CampaignSetting','stop','variables','parseToMilliseconds','clean','utc','isEmpty','ScheduleMonitor','start','domingo','log','YYYY-MM-DD\x20HH:mm:ss','GetWhatsapp','map','confirmationMessage','./models/Company','verifyMessage','pending','VerifyQueueStatus','all','status','SearchForQueue\x20->\x20VerifyQueue:\x20error','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','expiresTicket','false','scheduleMonitor','./models/ContactList','__importDefault','email','confirmation','getIO','get','public','91Zjyajp','update','cron','confirmationMessage5','America/Sao_Paulo','./helpers/GetDefaultWhatsApp','mediaPath','call','\x20e\x20termina\x20as\x20','ProcessCampaign','campaignId','push','SendScheduledMessage\x20->\x20Verify:\x20error','enabled','18FZgqIr','834510evjqDr','error','groupAsTicket','openTicket','whatsappId','longerIntervalAfter','./models/Contact','message3','ENVIADA','active','PrepareContact','DispatchCampaign','message5','sendScheduledMessages','contactId','toString','./models/CampaignShipping','confirmationMessage1','set','randomValue','./services/WbotServices/wbotClosedTickets','milliseconds','startHour','__esModule','@g.us','timeSendQueue','isNil','deliveredAt','user','stack','contacts','QueryTypes','info','__setModuleDefault','subtract','lgpdAcceptedAt','REDIS_OPT_LIMITER_MAX','resolve','parse','SendSacheduledMessages','endHour','minutes','contactTags','CONNECTED','isGroup','./helpers/SendMessage','./models/Schedule','verify-campaing','scheduledAt','day','reload','bull','./services/WbotServices/SendWhatsAppMessage','format','acceptAudioMessage','emit','isWhatsappValid','message1','keys','YYYY-MM-DD\x20HH:mm','tags','sendMessage','addSeconds','findByPk','not','profilePicUrl','8391rZimZi','companyId','6qMlZWZ','length','extraInfo','startQueueProcess','findAll','./services/WbotServices/SendWhatsAppMedia','closed','HH:mm:ss','*/20\x20*\x20*\x20*\x20*\x20*','message','./services/TicketServices/FindOrCreateTicketService','Mensagem\x20agendada\x20enviada\x20para:\x20','data','whatsapp','VerifyLoginStatus','isArray','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','disableBot','\x20nÃ£o\x20estÃ¡\x20dentro\x20do\x20horÃ¡rio','64707IRNOqf','sendIdQueue',',\x20hora\x20atual\x20','\x20updated\x20with\x20UserId\x20','UPDATE'];a346_0x4495=function(){return _0x19f485;};return a346_0x4495();}async function handleRandomUser(){const _0x20ee77=a346_0x1927ef,_0x41ef62=new CronJob(_0x20ee77(0x15b),async()=>{const _0x30c343=_0x20ee77;try{const {count:_0x18c76f,rows:_0x578a89}=await Ticket_1[_0x30c343(0x140)][_0x30c343(0xeb)]({'where':{'status':_0x30c343(0x16d),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0x30c343(0x140)],'as':'queue'}]}),_0xab7b77=_0x302aa4=>{const _0x17afa3=Math['floor'](Math['random']()*_0x302aa4['length']);return _0x302aa4[_0x17afa3];},_0xa3c6c3=async _0x586498=>{const _0xcb54ea=_0x30c343;try{const _0x58a057=await User_1['default'][_0xcb54ea(0x12f)]({'where':{'id':_0x586498}});return _0x58a057[_0xcb54ea(0x11a)]===_0xcb54ea(0xa9)?_0x58a057[_0xcb54ea(0xfc)]===!![]?_0x58a057['id']:0x0:0x0;}catch(_0x18621e){Sentry['captureException'](_0x18621e),logger_1[_0xcb54ea(0x11f)]['error'](_0xcb54ea(0xed),_0x18621e[_0xcb54ea(0xda)]);throw _0x18621e;}};if(_0x18c76f>0x0)for(const _0x589004 of _0x578a89){const {queue:_0x2f5f90,queueId:_0x3651f7,userId:_0x5457d9}=_0x589004,_0x4fe928=_0x2f5f90['tempoRoteador'],_0x38787c=await UserQueue_1[_0x30c343(0x140)][_0x30c343(0xd5)]({'where':{'queueId':_0x3651f7}}),_0x1a746a=await(0x0,ShowContactService_1[_0x30c343(0x140)])(_0x589004[_0x30c343(0x9b)],_0x589004[_0x30c343(0xd0)]),_0x6cf27b=_0x38787c[_0x30c343(0x169)](_0x5c529d=>_0x5c529d[_0x30c343(0x12e)]),_0x1df1b9=(0x0,moment_1[_0x30c343(0x140)])()[_0x30c343(0xaf)](_0x4fe928,'minutes')['utc']()['toDate'](),_0x3f8cd2=new Date(_0x589004[_0x30c343(0x11b)]);let _0x372e93=await CompaniesSettings_1['default'][_0x30c343(0x12f)]({'where':{'companyId':_0x589004[_0x30c343(0xd0)]}});const _0x5e0772=_0x372e93['sendGreetingMessageOneQueues']===_0x30c343(0x18a)||![];if(!_0x5457d9){const _0x4496c1=_0xab7b77(_0x6cf27b);if(await _0xa3c6c3(_0x4496c1)>0x0){if(_0x5e0772){const _0x15269a=await(0x0,ShowTicketService_1[_0x30c343(0x140)])(_0x589004['id'],_0x589004[_0x30c343(0xd0)]);await(0x0,SendWhatsAppMessage_1['default'])({'body':'*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20VocÃª\x20serÃ¡\x20atendido\x20em\x20breve!','ticket':_0x15269a});}await(0x0,UpdateTicketService_1[_0x30c343(0x140)])({'ticketData':{'status':_0x30c343(0x16d),'userId':_0x4496c1},'ticketId':_0x589004['id'],'companyId':_0x589004[_0x30c343(0xd0)]}),logger_1['logger'][_0x30c343(0xad)](_0x30c343(0x104)+_0x589004['id']+_0x30c343(0xe7)+_0x4496c1+'\x20-\x20'+_0x589004[_0x30c343(0x11b)]);}else{}}else{if(_0x6cf27b[_0x30c343(0xef)](_0x5457d9)){if(_0x1df1b9>_0x3f8cd2){const _0x35932f=_0x6cf27b[_0x30c343(0x10a)](_0x312115=>_0x312115!==_0x5457d9);if(_0x35932f[_0x30c343(0xd2)]>0x0){const _0x298e6e=_0xab7b77(_0x35932f);if(await _0xa3c6c3(_0x298e6e)>0x0){if(_0x5e0772){const _0xc92193=await(0x0,ShowTicketService_1[_0x30c343(0x140)])(_0x589004['id'],_0x589004[_0x30c343(0xd0)]);await(0x0,SendWhatsAppMessage_1[_0x30c343(0x140)])({'body':_0x30c343(0x116),'ticket':_0xc92193});};await(0x0,UpdateTicketService_1[_0x30c343(0x140)])({'ticketData':{'status':_0x30c343(0x16d),'userId':_0x298e6e},'ticketId':_0x589004['id'],'companyId':_0x589004[_0x30c343(0xd0)]}),await _0x589004[_0x30c343(0xbf)]();}else{}}else{}}else{}}else{}}}}catch(_0x1085bc){Sentry[_0x30c343(0x102)](_0x1085bc),logger_1[_0x30c343(0x11f)][_0x30c343(0x18d)](_0x30c343(0xed),_0x1085bc[_0x30c343(0xda)]);throw _0x1085bc;}});_0x41ef62[_0x20ee77(0x164)]();}function a346_0x3e9c(_0x36215f,_0x4645e){const _0x44957d=a346_0x4495();return a346_0x3e9c=function(_0x3e9cd7,_0x47ffd7){_0x3e9cd7=_0x3e9cd7-0x90;let _0x373a26=_0x44957d[_0x3e9cd7];return _0x373a26;},a346_0x3e9c(_0x36215f,_0x4645e);}async function handleCloseTicketsAutomatic(){const _0x5747e0=a346_0x1927ef,_0x3a6486=new CronJob('*/1\x20*\x20*\x20*\x20*',async()=>{const _0x3f86af=a346_0x3e9c,_0x2f038c=await Company_1[_0x3f86af(0x140)][_0x3f86af(0xd5)]();_0x2f038c[_0x3f86af(0x169)](async _0x2cf58c=>{const _0xcf5a14=_0x3f86af;try{const _0x35c82a=_0x2cf58c['id'];await(0x0,wbotClosedTickets_1[_0xcf5a14(0x145)])(_0x35c82a);}catch(_0xa20a09){Sentry['captureException'](_0xa20a09),logger_1[_0xcf5a14(0x11f)][_0xcf5a14(0x18d)](_0xcf5a14(0x12d),_0xa20a09['message']);throw _0xa20a09;}});});_0x3a6486[_0x5747e0(0x164)]();}async function handleWhatsapp(){const _0x71d40=a346_0x1927ef,_0x53bd62=new CronJob('*\x2015\x203\x20*\x20*\x20*',async()=>{const _0x4a8919=a346_0x3e9c;(0x0,GetWhatsapp_1[_0x4a8919(0x168)])(),_0x53bd62[_0x4a8919(0x15d)]();},null,![],_0x71d40(0x181));_0x53bd62[_0x71d40(0x164)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x1aa0c2=a346_0x1927ef;logger_1[_0x1aa0c2(0x11f)][_0x1aa0c2(0xad)]('Iniciando\x20processamento\x20de\x20filas'),exports['messageQueue'][_0x1aa0c2(0x12c)](_0x1aa0c2(0xf4),handleSendMessage),exports[_0x1aa0c2(0x175)][_0x1aa0c2(0x12c)](_0x1aa0c2(0x13b),handleVerifySchedules),exports[_0x1aa0c2(0x9a)][_0x1aa0c2(0x12c)]('SendMessage',handleSendScheduledMessage),exports['campaignQueue']['process']('VerifyCampaignsDaatabase',handleVerifyCampaigns),exports['campaignQueue'][_0x1aa0c2(0x12c)](_0x1aa0c2(0x186),handleProcessCampaign),exports[_0x1aa0c2(0x121)][_0x1aa0c2(0x12c)](_0x1aa0c2(0x97),handlePrepareContact),exports[_0x1aa0c2(0x121)][_0x1aa0c2(0x12c)](_0x1aa0c2(0x98),handleDispatchCampaign),exports[_0x1aa0c2(0x14b)][_0x1aa0c2(0x12c)](_0x1aa0c2(0xdf),handleLoginStatus),exports['queueMonitor'][_0x1aa0c2(0x12c)](_0x1aa0c2(0x16e),handleVerifyQueue),exports[_0x1aa0c2(0x175)][_0x1aa0c2(0xfa)]('Verify',{},{'repeat':{'cron':'*/5\x20*\x20*\x20*\x20*\x20*','key':_0x1aa0c2(0x15a)},'removeOnComplete':!![]}),exports[_0x1aa0c2(0x121)][_0x1aa0c2(0xfa)](_0x1aa0c2(0x11d),{},{'repeat':{'cron':_0x1aa0c2(0xd9),'key':_0x1aa0c2(0xbc)},'removeOnComplete':!![]}),exports[_0x1aa0c2(0x14b)]['add'](_0x1aa0c2(0xdf),{},{'repeat':{'cron':'*\x20*\x20*\x20*\x20*','key':_0x1aa0c2(0xf0)},'removeOnComplete':!![]}),exports[_0x1aa0c2(0x133)][_0x1aa0c2(0xfa)](_0x1aa0c2(0x16e),{},{'repeat':{'cron':_0x1aa0c2(0xd9),'key':_0x1aa0c2(0x149)},'removeOnComplete':!![]});}exports['startQueueProcess']=startQueueProcess;