'use strict';const a346_0x48a2c8=a346_0x129c;(function(_0x6d54a0,_0x281bb7){const _0x39380b=a346_0x129c,_0x46d81a=_0x6d54a0();while(!![]){try{const _0x8be9bf=-parseInt(_0x39380b(0x20d))/0x1*(parseInt(_0x39380b(0x19d))/0x2)+-parseInt(_0x39380b(0x1d6))/0x3*(parseInt(_0x39380b(0x19e))/0x4)+-parseInt(_0x39380b(0x186))/0x5+-parseInt(_0x39380b(0x1f9))/0x6*(-parseInt(_0x39380b(0x147))/0x7)+-parseInt(_0x39380b(0x17d))/0x8*(parseInt(_0x39380b(0x1d1))/0x9)+parseInt(_0x39380b(0x16c))/0xa+-parseInt(_0x39380b(0x214))/0xb*(-parseInt(_0x39380b(0x1fb))/0xc);if(_0x8be9bf===_0x281bb7)break;else _0x46d81a['push'](_0x46d81a['shift']());}catch(_0x473362){_0x46d81a['push'](_0x46d81a['shift']());}}}(a346_0x50ce,0x26c62));var __createBinding=this&&this[a346_0x48a2c8(0x1f6)]||(Object[a346_0x48a2c8(0x228)]?function(_0x9f2779,_0x13d5a5,_0x163edc,_0x7c31b8){const _0x247696=a346_0x48a2c8;if(_0x7c31b8===undefined)_0x7c31b8=_0x163edc;var _0x2791db=Object[_0x247696(0x194)](_0x13d5a5,_0x163edc);(!_0x2791db||(_0x247696(0x1b7)in _0x2791db?!_0x13d5a5[_0x247696(0x1d2)]:_0x2791db['writable']||_0x2791db['configurable']))&&(_0x2791db={'enumerable':!![],'get':function(){return _0x13d5a5[_0x163edc];}}),Object['defineProperty'](_0x9f2779,_0x7c31b8,_0x2791db);}:function(_0x43a356,_0x19bf5e,_0x2129d1,_0x512541){if(_0x512541===undefined)_0x512541=_0x2129d1;_0x43a356[_0x512541]=_0x19bf5e[_0x2129d1];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a346_0x48a2c8(0x228)]?function(_0x3436b8,_0x1e6d66){const _0x28bf83=a346_0x48a2c8;Object['defineProperty'](_0x3436b8,_0x28bf83(0x15b),{'enumerable':!![],'value':_0x1e6d66});}:function(_0x51569c,_0x1ab488){_0x51569c['default']=_0x1ab488;}),__importStar=this&&this[a346_0x48a2c8(0x1ad)]||function(_0x3dcac7){const _0x57c400=a346_0x48a2c8;if(_0x3dcac7&&_0x3dcac7[_0x57c400(0x1d2)])return _0x3dcac7;var _0xb7fe31={};if(_0x3dcac7!=null){for(var _0x51566f in _0x3dcac7)if(_0x51566f!==_0x57c400(0x15b)&&Object['prototype'][_0x57c400(0x224)]['call'](_0x3dcac7,_0x51566f))__createBinding(_0xb7fe31,_0x3dcac7,_0x51566f);}return __setModuleDefault(_0xb7fe31,_0x3dcac7),_0xb7fe31;},__importDefault=this&&this['__importDefault']||function(_0x2f3630){return _0x2f3630&&_0x2f3630['__esModule']?_0x2f3630:{'default':_0x2f3630};};Object['defineProperty'](exports,a346_0x48a2c8(0x1d2),{'value':!![]}),exports[a346_0x48a2c8(0x216)]=exports['randomValue']=exports[a346_0x48a2c8(0x1a0)]=exports['messageQueue']=exports['queueMonitor']=exports['campaignQueue']=exports[a346_0x48a2c8(0x202)]=exports[a346_0x48a2c8(0x15e)]=exports[a346_0x48a2c8(0x226)]=void 0x0;const Sentry=__importStar(require(a346_0x48a2c8(0x176))),bull_1=__importDefault(require(a346_0x48a2c8(0x1e9))),SendMessage_1=require(a346_0x48a2c8(0x17f)),Whatsapp_1=__importDefault(require('./models/Whatsapp')),logger_1=require(a346_0x48a2c8(0x227)),moment_1=__importDefault(require('moment')),Schedule_1=__importDefault(require(a346_0x48a2c8(0x233))),sequelize_1=require(a346_0x48a2c8(0x1cf)),GetDefaultWhatsApp_1=__importDefault(require(a346_0x48a2c8(0x181))),Campaign_1=__importDefault(require(a346_0x48a2c8(0x195))),Queue_1=__importDefault(require(a346_0x48a2c8(0x1d7))),ContactList_1=__importDefault(require(a346_0x48a2c8(0x18c))),ContactListItem_1=__importDefault(require(a346_0x48a2c8(0x14a))),lodash_1=require(a346_0x48a2c8(0x23e)),CampaignSetting_1=__importDefault(require(a346_0x48a2c8(0x190))),CampaignShipping_1=__importDefault(require(a346_0x48a2c8(0x236))),GetWhatsappWbot_1=__importDefault(require(a346_0x48a2c8(0x18e))),database_1=__importDefault(require(a346_0x48a2c8(0x17e))),SendWhatsAppMedia_1=require(a346_0x48a2c8(0x18a)),socket_1=require(a346_0x48a2c8(0x219)),path_1=__importDefault(require(a346_0x48a2c8(0x175))),User_1=__importDefault(require(a346_0x48a2c8(0x15f))),Company_1=__importDefault(require(a346_0x48a2c8(0x1d3))),Contact_1=__importDefault(require(a346_0x48a2c8(0x184))),Queue_2=__importDefault(require(a346_0x48a2c8(0x1d7))),wbotClosedTickets_1=require(a346_0x48a2c8(0x1d0)),Ticket_1=__importDefault(require(a346_0x48a2c8(0x1f3))),ShowContactService_1=__importDefault(require(a346_0x48a2c8(0x204))),UserQueue_1=__importDefault(require(a346_0x48a2c8(0x1a8))),ShowTicketService_1=__importDefault(require('./services/TicketServices/ShowTicketService')),SendWhatsAppMessage_1=__importDefault(require(a346_0x48a2c8(0x146))),UpdateTicketService_1=__importDefault(require(a346_0x48a2c8(0x178))),date_fns_1=require(a346_0x48a2c8(0x1ce)),GetWhatsapp_1=require(a346_0x48a2c8(0x1af)),nodemailer=require(a346_0x48a2c8(0x145)),CronJob=require(a346_0x48a2c8(0x1c9))[a346_0x48a2c8(0x20e)],CompaniesSettings_1=__importDefault(require(a346_0x48a2c8(0x1a7))),wbotMessageListener_1=require(a346_0x48a2c8(0x221)),FindOrCreateTicketService_1=__importDefault(require(a346_0x48a2c8(0x1fc))),connection=process[a346_0x48a2c8(0x14f)][a346_0x48a2c8(0x1bc)]||'',limiterMax=process[a346_0x48a2c8(0x14f)][a346_0x48a2c8(0x203)]||0x1,limiterDuration=process[a346_0x48a2c8(0x14f)][a346_0x48a2c8(0x23c)]||0xbb8;exports[a346_0x48a2c8(0x226)]=new bull_1[(a346_0x48a2c8(0x15b))]('UserMonitor',connection),exports[a346_0x48a2c8(0x15e)]=new bull_1[(a346_0x48a2c8(0x15b))](a346_0x48a2c8(0x230),connection),exports[a346_0x48a2c8(0x202)]=new bull_1[(a346_0x48a2c8(0x15b))](a346_0x48a2c8(0x217),connection),exports[a346_0x48a2c8(0x1c2)]=new bull_1[(a346_0x48a2c8(0x15b))](a346_0x48a2c8(0x15a),connection),exports[a346_0x48a2c8(0x21f)]=new bull_1[(a346_0x48a2c8(0x15b))](a346_0x48a2c8(0x185),connection),exports[a346_0x48a2c8(0x23a)]=new bull_1[(a346_0x48a2c8(0x15b))](a346_0x48a2c8(0x169),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}});async function handleSendMessage(_0x37277b){const _0x4a0756=a346_0x48a2c8;try{const {data:_0x45c09a}=_0x37277b,_0x110216=await Whatsapp_1[_0x4a0756(0x15b)][_0x4a0756(0x21c)](_0x45c09a[_0x4a0756(0x1ff)]);if(_0x110216===null)throw Error(_0x4a0756(0x15c));const _0x4d6224=_0x45c09a['data'];await(0x0,SendMessage_1[_0x4a0756(0x177)])(_0x110216,_0x4d6224);}catch(_0x5bad5a){Sentry['captureException'](_0x5bad5a),logger_1[_0x4a0756(0x1eb)][_0x4a0756(0x1a2)](_0x4a0756(0x155),_0x5bad5a[_0x4a0756(0x207)]);throw _0x5bad5a;}}async function handleVerifySchedules(_0x252165){const _0x4ec0e3=a346_0x48a2c8;try{const {count:_0x243c08,rows:_0x4295c3}=await Schedule_1[_0x4ec0e3(0x15b)][_0x4ec0e3(0x189)]({'where':{'status':_0x4ec0e3(0x237),'sentAt':null,'sendAt':{[sequelize_1['Op']['gte']]:(0x0,moment_1[_0x4ec0e3(0x15b)])()[_0x4ec0e3(0x168)](_0x4ec0e3(0x213)),[sequelize_1['Op'][_0x4ec0e3(0x1e3)]]:(0x0,moment_1[_0x4ec0e3(0x15b)])()[_0x4ec0e3(0x234)]('30',_0x4ec0e3(0x1bb))[_0x4ec0e3(0x168)](_0x4ec0e3(0x213))}},'include':[{'model':Contact_1[_0x4ec0e3(0x15b)],'as':_0x4ec0e3(0x19a)}]});_0x243c08>0x0&&_0x4295c3[_0x4ec0e3(0x164)](async _0x50f7b8=>{const _0x5b97c2=_0x4ec0e3;await _0x50f7b8[_0x5b97c2(0x187)]({'status':'AGENDADA'}),exports[_0x5b97c2(0x202)][_0x5b97c2(0x234)](_0x5b97c2(0x177),{'schedule':_0x50f7b8},{'delay':0x9c40}),logger_1['logger'][_0x5b97c2(0x1da)](_0x5b97c2(0x212)+_0x50f7b8[_0x5b97c2(0x19a)][_0x5b97c2(0x23b)]);});}catch(_0x400fe2){Sentry[_0x4ec0e3(0x18b)](_0x400fe2),logger_1[_0x4ec0e3(0x1eb)][_0x4ec0e3(0x1a2)]('SendScheduledMessage\x20->\x20Verify:\x20error',_0x400fe2[_0x4ec0e3(0x207)]);throw _0x400fe2;}}async function handleSendScheduledMessage(_0x2bc31c){const _0x276f77=a346_0x48a2c8,{data:{schedule:_0x45045f}}=_0x2bc31c;let _0x39c80a=null;try{_0x39c80a=await Schedule_1[_0x276f77(0x15b)][_0x276f77(0x21c)](_0x45045f['id']);}catch(_0x1cd87c){Sentry[_0x276f77(0x18b)](_0x1cd87c),logger_1[_0x276f77(0x1eb)]['info'](_0x276f77(0x188)+_0x45045f['id']);}try{const _0x1323bf=await(0x0,GetDefaultWhatsApp_1[_0x276f77(0x15b)])(_0x45045f[_0x276f77(0x191)]),_0x1d7dbe=await CompaniesSettings_1['default'][_0x276f77(0x182)]({'where':{'companyId':_0x45045f[_0x276f77(0x191)]}}),{ticket:_0x4c820c}=await(0x0,FindOrCreateTicketService_1[_0x276f77(0x15b)])(_0x45045f['contact'],_0x1323bf,0x1,_0x45045f[_0x276f77(0x191)],0x0,0x0,null,_0x276f77(0x1e1),![],![],_0x1d7dbe),_0x2089d4=await(0x0,SendMessage_1[_0x276f77(0x177)])(_0x1323bf,{'number':_0x45045f[_0x276f77(0x19a)][_0x276f77(0x1ca)],'body':_0x45045f[_0x276f77(0x198)]});await(0x0,wbotMessageListener_1[_0x276f77(0x1db)])(_0x2089d4,_0x4c820c,_0x45045f['contact'][_0x276f77(0x1ca)]),await _0x39c80a?.[_0x276f77(0x187)]({'sentAt':(0x0,moment_1[_0x276f77(0x15b)])()[_0x276f77(0x168)]('YYYY-MM-DD\x20HH:mm'),'status':_0x276f77(0x140)}),logger_1['logger'][_0x276f77(0x1da)](_0x276f77(0x1d5)+_0x45045f[_0x276f77(0x19a)]['name']),exports[_0x276f77(0x202)][_0x276f77(0x196)](0x3a98,_0x276f77(0x1e6));}catch(_0x4029f2){Sentry['captureException'](_0x4029f2),await _0x39c80a?.[_0x276f77(0x187)]({'status':_0x276f77(0x149)}),logger_1[_0x276f77(0x1eb)][_0x276f77(0x1a2)](_0x276f77(0x162),_0x4029f2[_0x276f77(0x207)]);throw _0x4029f2;}}async function handleVerifyCampaigns(_0x31e17d){const _0x2800e6=a346_0x48a2c8,_0x45c479=await database_1[_0x2800e6(0x15b)][_0x2800e6(0x1e0)]('select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x273\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27',{'type':sequelize_1[_0x2800e6(0x1c5)]['SELECT']});if(_0x45c479[_0x2800e6(0x229)]>0x0)logger_1[_0x2800e6(0x1eb)][_0x2800e6(0x1da)](_0x2800e6(0x1d9)+_0x45c479['length']);for(let _0x2a814f of _0x45c479){try{const _0x8fd69d=(0x0,moment_1[_0x2800e6(0x15b)])(),_0x57caaa=(0x0,moment_1[_0x2800e6(0x15b)])(_0x2a814f[_0x2800e6(0x1c8)]),_0x4d1d80=_0x57caaa[_0x2800e6(0x1b1)](_0x8fd69d,_0x2800e6(0x13e));logger_1[_0x2800e6(0x1eb)][_0x2800e6(0x1da)](_0x2800e6(0x22a)+_0x2a814f['id']+',\x20Delay\x20Inicial='+_0x4d1d80),exports[_0x2800e6(0x1c2)]['add'](_0x2800e6(0x208),{'id':_0x2a814f['id'],'delay':_0x4d1d80},{'priority':0x3,'removeOnComplete':{'age':0x3c*0x3c,'count':0xa},'removeOnFail':{'age':0x3c*0x3c,'count':0xa}});}catch(_0x2dfea9){Sentry[_0x2800e6(0x18b)](_0x2dfea9);}}}async function getCampaign(_0x2dbdbe){const _0x1b3692=a346_0x48a2c8;return await Campaign_1[_0x1b3692(0x15b)][_0x1b3692(0x182)]({'where':{'id':_0x2dbdbe},'include':[{'model':ContactList_1['default'],'as':_0x1b3692(0x18d),'attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x1b3692(0x15b)],'as':_0x1b3692(0x20b),'attributes':['id','name',_0x1b3692(0x1ca),_0x1b3692(0x1f5),_0x1b3692(0x150),_0x1b3692(0x19b)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':'whatsapp','attributes':['id',_0x1b3692(0x23b)]}]});}async function getContact(_0x39c24d){const _0x15bfb6=a346_0x48a2c8;return await ContactListItem_1[_0x15bfb6(0x15b)][_0x15bfb6(0x21c)](_0x39c24d,{'attributes':['id',_0x15bfb6(0x23b),_0x15bfb6(0x1ca),_0x15bfb6(0x1f5),_0x15bfb6(0x19b)]});}async function getSettings(_0x52fc97){const _0x38318a=a346_0x48a2c8;try{const _0x572b47=await CampaignSetting_1[_0x38318a(0x15b)][_0x38318a(0x20c)]({'where':{'companyId':_0x52fc97[_0x38318a(0x191)]},'attributes':[_0x38318a(0x14d),_0x38318a(0x1b9)]});let _0x5d5258=0x14,_0x162858=0x14,_0x5dbf3b=0x3c,_0x3c16f0=[];return _0x572b47[_0x38318a(0x20f)](_0x39c504=>{const _0xe56fb3=_0x38318a;_0x39c504[_0xe56fb3(0x14d)]===_0xe56fb3(0x209)&&(_0x5d5258=JSON['parse'](_0x39c504[_0xe56fb3(0x1b9)])),_0x39c504['key']===_0xe56fb3(0x211)&&(_0x162858=JSON[_0xe56fb3(0x1a9)](_0x39c504[_0xe56fb3(0x1b9)])),_0x39c504[_0xe56fb3(0x14d)]===_0xe56fb3(0x192)&&(_0x5dbf3b=JSON[_0xe56fb3(0x1a9)](_0x39c504[_0xe56fb3(0x1b9)])),_0x39c504[_0xe56fb3(0x14d)]==='variables'&&(_0x3c16f0=JSON[_0xe56fb3(0x1a9)](_0x39c504['value']));}),{'messageInterval':_0x5d5258,'longerIntervalAfter':_0x162858,'greaterInterval':_0x5dbf3b,'variables':_0x3c16f0};}catch(_0x2302e7){console['log'](_0x2302e7);throw _0x2302e7;}}function parseToMilliseconds(_0x5d460a){return _0x5d460a*0x3e8;}exports[a346_0x48a2c8(0x1a0)]=parseToMilliseconds;async function sleep(_0x224b13){const _0x1bc212=a346_0x48a2c8;return logger_1[_0x1bc212(0x1eb)][_0x1bc212(0x1da)]('Sleep\x20de\x20'+_0x224b13+_0x1bc212(0x18f)+(0x0,moment_1[_0x1bc212(0x15b)])()[_0x1bc212(0x168)]('HH:mm:ss')),new Promise(_0x4c9481=>{setTimeout(()=>{const _0x3c57f7=a346_0x129c;logger_1[_0x3c57f7(0x1eb)][_0x3c57f7(0x1da)](_0x3c57f7(0x1e8)+_0x224b13+'\x20segundos\x20finalizado:\x20'+(0x0,moment_1[_0x3c57f7(0x15b)])()[_0x3c57f7(0x168)]('HH:mm:ss')),_0x4c9481(!![]);},parseToMilliseconds(_0x224b13));});}function getCampaignValidMessages(_0x274830){const _0x3e8049=a346_0x48a2c8,_0x20e874=[];return!(0x0,lodash_1[_0x3e8049(0x1cd)])(_0x274830['message1'])&&!(0x0,lodash_1['isNil'])(_0x274830[_0x3e8049(0x1a3)])&&_0x20e874[_0x3e8049(0x1d8)](_0x274830[_0x3e8049(0x1a3)]),!(0x0,lodash_1['isEmpty'])(_0x274830[_0x3e8049(0x1b8)])&&!(0x0,lodash_1['isNil'])(_0x274830[_0x3e8049(0x1b8)])&&_0x20e874[_0x3e8049(0x1d8)](_0x274830[_0x3e8049(0x1b8)]),!(0x0,lodash_1[_0x3e8049(0x1cd)])(_0x274830['message3'])&&!(0x0,lodash_1[_0x3e8049(0x151)])(_0x274830[_0x3e8049(0x152)])&&_0x20e874[_0x3e8049(0x1d8)](_0x274830[_0x3e8049(0x152)]),!(0x0,lodash_1[_0x3e8049(0x1cd)])(_0x274830[_0x3e8049(0x1f4)])&&!(0x0,lodash_1[_0x3e8049(0x151)])(_0x274830[_0x3e8049(0x1f4)])&&_0x20e874['push'](_0x274830['message4']),!(0x0,lodash_1[_0x3e8049(0x1cd)])(_0x274830[_0x3e8049(0x17b)])&&!(0x0,lodash_1[_0x3e8049(0x151)])(_0x274830[_0x3e8049(0x17b)])&&_0x20e874[_0x3e8049(0x1d8)](_0x274830[_0x3e8049(0x17b)]),_0x20e874;}function getCampaignValidConfirmationMessages(_0x580e1c){const _0x1140fe=a346_0x48a2c8,_0x2feaba=[];return!(0x0,lodash_1[_0x1140fe(0x1cd)])(_0x580e1c['confirmationMessage1'])&&!(0x0,lodash_1['isNil'])(_0x580e1c['confirmationMessage1'])&&_0x2feaba[_0x1140fe(0x1d8)](_0x580e1c[_0x1140fe(0x1ec)]),!(0x0,lodash_1[_0x1140fe(0x1cd)])(_0x580e1c[_0x1140fe(0x13f)])&&!(0x0,lodash_1['isNil'])(_0x580e1c['confirmationMessage2'])&&_0x2feaba[_0x1140fe(0x1d8)](_0x580e1c[_0x1140fe(0x13f)]),!(0x0,lodash_1[_0x1140fe(0x1cd)])(_0x580e1c[_0x1140fe(0x160)])&&!(0x0,lodash_1[_0x1140fe(0x151)])(_0x580e1c[_0x1140fe(0x160)])&&_0x2feaba['push'](_0x580e1c[_0x1140fe(0x160)]),!(0x0,lodash_1[_0x1140fe(0x1cd)])(_0x580e1c[_0x1140fe(0x206)])&&!(0x0,lodash_1[_0x1140fe(0x151)])(_0x580e1c[_0x1140fe(0x206)])&&_0x2feaba['push'](_0x580e1c[_0x1140fe(0x206)]),!(0x0,lodash_1[_0x1140fe(0x1cd)])(_0x580e1c['confirmationMessage5'])&&!(0x0,lodash_1['isNil'])(_0x580e1c[_0x1140fe(0x1a4)])&&_0x2feaba[_0x1140fe(0x1d8)](_0x580e1c[_0x1140fe(0x1a4)]),_0x2feaba;}function a346_0x50ce(){const _0x569023=['info','verifyMessage','*/20\x20*\x20*\x20*\x20*\x20*','HH:mm','EM_ANDAMENTO','sendMessage','query','whatsapp','queue','lte','random','*\x20*\x20*\x20*\x20*','completed','process','Sleep\x20de\x20','bull','PrepareContact','logger','confirmationMessage1','-campaign','floor','\x20updated\x20with\x20UserId\x20','*/5\x20*\x20*\x20*\x20*\x20*','mediaName','getMessageOptions','./models/Ticket','message4','email','__createBinding','@g.us','toString','662994jZJwtJ','{email}','6659988roLJQl','./services/TicketServices/FindOrCreateTicketService','verify','timeSendQueue','whatsappId','data','variables','sendScheduledMessages','REDIS_OPT_LIMITER_MAX','./services/ContactServices/ShowContactService','active','confirmationMessage4','message','ProcessCampaign','messageInterval','domingo','contacts','findAll','313143eUcdng','CronJob','forEach','SearchForQueue\x20->\x20VerifyQueue:\x20error','longerIntervalAfter','Disparo\x20agendado\x20para:\x20','YYYY-MM-DD\x20HH:mm:ss','11wWVrkv','all','startQueueProcess','SendSacheduledMessages','enabled','./libs/socket','Ticket\x20ID\x20','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','findByPk','disableBot','isArray','queueMonitor','Verify','./services/WbotServices/wbotMessageListener','keys','join','hasOwnProperty','profile','userMonitor','./utils/logger','create','length','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','replace','count','company','contactTags','VerifyCampaignsDaatabase','ScheduleMonitor','*/1\x20*\x20*\x20*\x20*','groupAsTicket','./models/Schedule','add','verifyMediaMessage','./models/CampaignShipping','PENDENTE','userId','delayed','messageQueue','name','REDIS_OPT_LIMITER_DURATION','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','lodash','confirmationRequestedAt','color','milliseconds','confirmationMessage2','ENVIADA','DispatchCampaign','minutes','sabado','VerifyLoginStatus','nodemailer','./services/WbotServices/SendWhatsAppMessage','14LTExec','addSeconds','ERRO','./models/ContactListItem','reload','@s.whatsapp.net','key','*\x2015\x203\x20*\x20*\x20*','env','isWhatsappValid','isNil','message3','verify-queue','ClosedAllOpenTickets','MessageQueue\x20->\x20SendMessage:\x20error','updatedAt','tempoRoteador','not','FINALIZADA','CampaignQueue','default','Whatsapp\x20não\x20identificado','Iniciando\x20processamento\x20de\x20filas','scheduleMonitor','./models/User','confirmationMessage3','profilePicUrl','SendScheduledMessage\x20->\x20SendMessage:\x20error','getIO','map','Atendimento\x20Perdido:\x20','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','America/Sao_Paulo','format','MessageQueue','set','CONNECTED','2457160UxvYNS','public','wait','{numero}','sendIdQueue','openTicket','false','\x20e\x20termina\x20as\x20','status','path','@sentry/node','SendMessage','./services/TicketServices/UpdateTicketService',';delay=','resume','message5',',\x20hora\x20atual\x20','1825144MfIjPr','./database','./helpers/SendMessage','ClosedAllOpenTickets\x20->\x20Verify:\x20error','./helpers/GetDefaultWhatsApp','findOne','closed','./models/Contact','QueueMonitor','1005660qYLAVJ','update','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','findAndCountAll','./services/WbotServices/SendWhatsAppMedia','captureException','./models/ContactList','contactList','./helpers/GetWhatsappWbot','\x20segundos\x20iniciado:\x20','./models/CampaignSetting','companyId','greaterInterval','statusTicket','getOwnPropertyDescriptor','./models/Campaign','clean','pending','body','day','contact','isGroup','randomValue','2VGRZmj','68844kNqHxh','GetWhatsapp','parseToMilliseconds',';Registro=','error','message1','confirmationMessage5','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','UPDATE\x20\x22Users\x22\x20SET\x20\x22online\x22\x20=\x20false,\x20\x22updatedAt\x22\x20=\x20now()\x20WHERE\x20id\x20IN\x20(','./models/CompaniesSettings','./models/UserQueue','parse','utc','resolve','start','__importStar','deliveredAt','./helpers/GetWhatsapp','confirmation','diff','pause','whatsapps','verify-login','campaignId','stop','get','message2','value','contactId','seconds','REDIS_URI','confirmationMessage',';Contato=','mediaPath','isInteger','endHour','campaignQueue','VerifyQueueStatus','*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','QueryTypes','emit','queueId','scheduledAt','cron','number','includes','findOrCreate','isEmpty','date-fns','sequelize','./services/WbotServices/wbotClosedTickets','9ZvvPcd','__esModule','./models/Company','subtract','Mensagem\x20agendada\x20enviada\x20para:\x20','21yIDjXg','./models/Queue','push','Campanhas\x20encontradas:\x20'];a346_0x50ce=function(){return _0x569023;};return a346_0x50ce();}function getProcessedMessage(_0x1ba344,_0x48e3ec,_0x5ace7f){const _0x221e8c=a346_0x48a2c8;let _0x29c7ca=_0x1ba344;return _0x29c7ca[_0x221e8c(0x1cb)]('{nome}')&&(_0x29c7ca=_0x29c7ca[_0x221e8c(0x22b)](/{nome}/g,_0x5ace7f[_0x221e8c(0x23b)])),_0x29c7ca[_0x221e8c(0x1cb)](_0x221e8c(0x1fa))&&(_0x29c7ca=_0x29c7ca['replace'](/{email}/g,_0x5ace7f['email'])),_0x29c7ca['includes'](_0x221e8c(0x16f))&&(_0x29c7ca=_0x29c7ca['replace'](/{numero}/g,_0x5ace7f[_0x221e8c(0x1ca)])),_0x48e3ec[0x0]?.[_0x221e8c(0x1b9)]!=='[]'&&_0x48e3ec[_0x221e8c(0x20f)](_0xbb238c=>{const _0x332f1c=_0x221e8c;if(_0x29c7ca[_0x332f1c(0x1cb)]('{'+_0xbb238c[_0x332f1c(0x14d)]+'}')){const _0x2ff20d=new RegExp('{'+_0xbb238c[_0x332f1c(0x14d)]+'}','g');_0x29c7ca=_0x29c7ca[_0x332f1c(0x22b)](_0x2ff20d,_0xbb238c[_0x332f1c(0x1b9)]);}}),_0x29c7ca;}const checkerWeek=async()=>{const _0x5abd59=a346_0x48a2c8,_0x434eeb=(0x0,moment_1[_0x5abd59(0x15b)])()[_0x5abd59(0x199)]()===0x6,_0x268985=(0x0,moment_1['default'])()[_0x5abd59(0x199)]()===0x0,_0x4e6df6=await CampaignSetting_1['default'][_0x5abd59(0x182)]({'where':{'key':_0x5abd59(0x143)}}),_0x104e83=await CampaignSetting_1[_0x5abd59(0x15b)][_0x5abd59(0x182)]({'where':{'key':_0x5abd59(0x20a)}});if(_0x4e6df6?.[_0x5abd59(0x1b9)]==='false'&&_0x434eeb)return exports['messageQueue']['pause'](),!![];if(_0x104e83?.[_0x5abd59(0x1b9)]===_0x5abd59(0x172)&&_0x268985)return exports[_0x5abd59(0x23a)][_0x5abd59(0x1b2)](),!![];return exports['messageQueue'][_0x5abd59(0x17a)](),![];},checkTime=async()=>{const _0x3459f3=a346_0x48a2c8,_0x10d684=await CampaignSetting_1[_0x3459f3(0x15b)][_0x3459f3(0x182)]({'where':{'key':'startHour'}}),_0x210b7c=await CampaignSetting_1[_0x3459f3(0x15b)][_0x3459f3(0x182)]({'where':{'key':_0x3459f3(0x1c1)}}),_0x45e366=_0x10d684['value'],_0x3ec873=_0x210b7c[_0x3459f3(0x1b9)],_0x4a5cd=(0x0,moment_1[_0x3459f3(0x15b)])()['format'](_0x3459f3(0x1dd));if(_0x4a5cd<=_0x3ec873&&_0x4a5cd>=_0x45e366)return exports[_0x3459f3(0x23a)][_0x3459f3(0x17a)](),!![];return logger_1[_0x3459f3(0x1eb)][_0x3459f3(0x1da)]('Envio\x20inicia\x20as\x20'+_0x45e366+_0x3459f3(0x173)+_0x3ec873+_0x3459f3(0x17c)+_0x4a5cd+'\x20não\x20está\x20dentro\x20do\x20horário'),exports[_0x3459f3(0x23a)][_0x3459f3(0x196)](0x0,_0x3459f3(0x239)),exports['messageQueue']['clean'](0x0,_0x3459f3(0x16e)),exports[_0x3459f3(0x23a)][_0x3459f3(0x196)](0x0,_0x3459f3(0x205)),exports[_0x3459f3(0x23a)][_0x3459f3(0x196)](0x0,_0x3459f3(0x1e6)),exports[_0x3459f3(0x23a)][_0x3459f3(0x196)](0x0,'failed'),exports['messageQueue'][_0x3459f3(0x1b2)](),![];};function randomValue(_0x391ae6,_0x57f24c){const _0x48ba5b=a346_0x48a2c8;return Math[_0x48ba5b(0x1ee)](Math[_0x48ba5b(0x1e4)]()*_0x57f24c)+_0x391ae6;}exports[a346_0x48a2c8(0x19c)]=randomValue;async function verifyAndFinalizeCampaign(_0x2178c7){const _0x435dad=a346_0x48a2c8,{contacts:_0x4d8495}=_0x2178c7[_0x435dad(0x18d)],_0x3fb122=_0x4d8495['length'],_0x707026=await CampaignShipping_1[_0x435dad(0x15b)][_0x435dad(0x22c)]({'where':{'campaignId':_0x2178c7['id'],'deliveredAt':{[sequelize_1['Op'][_0x435dad(0x158)]]:null}}});_0x3fb122===_0x707026&&await _0x2178c7['update']({'status':_0x435dad(0x159),'completedAt':(0x0,moment_1[_0x435dad(0x15b)])()});const _0x50c196=(0x0,socket_1['getIO'])();_0x50c196[_0x435dad(0x1c6)]('company-'+_0x2178c7['companyId']+_0x435dad(0x1ed),{'action':'update','record':_0x2178c7});}async function handleProcessCampaign(_0x2079a4){const _0x5be32b=a346_0x48a2c8;try{const {id:_0x2809a9}=_0x2079a4[_0x5be32b(0x200)],_0x4ecf32=await getCampaign(_0x2809a9),_0xa12615=await getSettings(_0x4ecf32);if(_0x4ecf32){const {contacts:_0x5033a3}=_0x4ecf32[_0x5be32b(0x18d)];if((0x0,lodash_1[_0x5be32b(0x21e)])(_0x5033a3)){const _0x3a4553=_0x5033a3[_0x5be32b(0x164)](_0x3bf9a1=>({'contactId':_0x3bf9a1['id'],'campaignId':_0x4ecf32['id'],'variables':_0xa12615[_0x5be32b(0x201)],'isGroup':_0x3bf9a1[_0x5be32b(0x19b)]})),_0x4c9b40=parseToMilliseconds(_0xa12615['longerIntervalAfter']),_0x3a5329=parseToMilliseconds(_0xa12615[_0x5be32b(0x192)]),_0x34e028=_0xa12615[_0x5be32b(0x209)];let _0x2d7e6c=_0x4ecf32[_0x5be32b(0x1c8)];const _0x5c588d=[];for(let _0x114d15=0x0;_0x114d15<_0x3a4553['length'];_0x114d15++){_0x2d7e6c=(0x0,date_fns_1[_0x5be32b(0x148)])(_0x2d7e6c,_0x114d15>_0x4c9b40?_0x3a5329:_0x34e028);const {contactId:_0x7271e,campaignId:_0x220bda,variables:_0x7048d2}=_0x3a4553[_0x114d15],_0x3fe1c8=calculateDelay(_0x114d15,_0x2d7e6c,_0x4c9b40,_0x3a5329,_0x34e028),_0x473266=exports[_0x5be32b(0x1c2)][_0x5be32b(0x234)]('PrepareContact',{'contactId':_0x7271e,'campaignId':_0x220bda,'variables':_0x7048d2,'delay':_0x3fe1c8},{'removeOnComplete':!![]});_0x5c588d['push'](_0x473266),logger_1[_0x5be32b(0x1eb)][_0x5be32b(0x1da)](_0x5be32b(0x23d)+_0x4ecf32['id']+_0x5be32b(0x1be)+_0x5033a3[_0x114d15]['name']+_0x5be32b(0x179)+_0x3fe1c8);}await Promise[_0x5be32b(0x215)](_0x5c588d),await _0x4ecf32['update']({'status':_0x5be32b(0x1de)});}}}catch(_0x54193e){Sentry[_0x5be32b(0x18b)](_0x54193e);}}function calculateDelay(_0x26f34a,_0x87d8c5,_0x2930da,_0x207507,_0x43fab3){const _0x55e1a4=(0x0,date_fns_1['differenceInSeconds'])(_0x87d8c5,new Date());return _0x26f34a>_0x2930da?_0x55e1a4*0x3e8+_0x207507:_0x55e1a4*0x3e8+_0x43fab3;}async function handlePrepareContact(_0x3098a7){const _0x3f12fc=a346_0x48a2c8;try{const {contactId:_0x527d69,campaignId:_0x426a8d,delay:_0x99aa0f,variables:_0x5409bf}=_0x3098a7[_0x3f12fc(0x200)],_0x124197=await getCampaign(_0x426a8d),_0x519b2b=await getContact(_0x527d69),_0x2c4a21={};_0x2c4a21[_0x3f12fc(0x1ca)]=_0x519b2b[_0x3f12fc(0x1ca)],_0x2c4a21[_0x3f12fc(0x1ba)]=_0x527d69,_0x2c4a21[_0x3f12fc(0x1b5)]=_0x426a8d;const _0x5107fe=getCampaignValidMessages(_0x124197);if(_0x5107fe[_0x3f12fc(0x229)]){const _0x3ea2cf=randomValue(0x0,_0x5107fe[_0x3f12fc(0x229)]),_0x11a4bc=getProcessedMessage(_0x5107fe[_0x3ea2cf],_0x5409bf,_0x519b2b);_0x2c4a21[_0x3f12fc(0x207)]='‌\x20'+_0x11a4bc;}if(_0x124197[_0x3f12fc(0x1b0)]){const _0x1c305a=getCampaignValidConfirmationMessages(_0x124197);if(_0x1c305a['length']){const _0x3cf3d8=randomValue(0x0,_0x1c305a['length']),_0x33da6f=getProcessedMessage(_0x1c305a[_0x3cf3d8],_0x5409bf,_0x519b2b);_0x2c4a21['confirmationMessage']='‌\x20'+_0x33da6f;}}const [_0x57bc53,_0xd9ad74]=await CampaignShipping_1[_0x3f12fc(0x15b)][_0x3f12fc(0x1cc)]({'where':{'campaignId':_0x2c4a21['campaignId'],'contactId':_0x2c4a21['contactId']},'defaults':_0x2c4a21});!_0xd9ad74&&_0x57bc53[_0x3f12fc(0x1ae)]===null&&_0x57bc53['confirmationRequestedAt']===null&&(_0x57bc53[_0x3f12fc(0x16a)](_0x2c4a21),await _0x57bc53['save']());if(_0x57bc53[_0x3f12fc(0x1ae)]===null&&_0x57bc53[_0x3f12fc(0x23f)]===null){const _0x4cbcbe=await exports[_0x3f12fc(0x1c2)][_0x3f12fc(0x234)]('DispatchCampaign',{'campaignId':_0x124197['id'],'campaignShippingId':_0x57bc53['id'],'contactListItemId':_0x527d69},{'delay':_0x99aa0f});await _0x57bc53[_0x3f12fc(0x187)]({'jobId':_0x4cbcbe['id']});}await verifyAndFinalizeCampaign(_0x124197);}catch(_0x26ead2){Sentry[_0x3f12fc(0x18b)](_0x26ead2),logger_1[_0x3f12fc(0x1eb)][_0x3f12fc(0x1a2)]('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0x26ead2[_0x3f12fc(0x207)]);}}async function handleDispatchCampaign(_0x3e3e46){const _0x3ded29=a346_0x48a2c8;try{const {data:_0x17062e}=_0x3e3e46,{campaignShippingId:_0x56d241,campaignId:_0x2ff15c}=_0x17062e,_0xaaa32c=await getCampaign(_0x2ff15c),_0x4b389d=await(0x0,GetWhatsappWbot_1[_0x3ded29(0x15b)])(_0xaaa32c[_0x3ded29(0x1e1)]);if(!_0x4b389d){logger_1[_0x3ded29(0x1eb)]['error']('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found');return;}if(!_0xaaa32c[_0x3ded29(0x1e1)]){logger_1[_0x3ded29(0x1eb)]['error']('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0x4b389d?.['user']?.['id']){logger_1['logger'][_0x3ded29(0x1a2)](_0x3ded29(0x1a5));return;}logger_1[_0x3ded29(0x1eb)][_0x3ded29(0x1da)](_0x3ded29(0x166)+_0x2ff15c+_0x3ded29(0x1a1)+_0x56d241);const _0x196533=await CampaignShipping_1[_0x3ded29(0x15b)][_0x3ded29(0x21c)](_0x56d241,{'include':[{'model':ContactListItem_1[_0x3ded29(0x15b)],'as':'contact'}]}),_0x219919=_0x196533[_0x3ded29(0x19a)][_0x3ded29(0x19b)]?_0x196533[_0x3ded29(0x1ca)]+_0x3ded29(0x1f7):_0x196533[_0x3ded29(0x1ca)]+_0x3ded29(0x14c);let _0x435f86=_0x196533[_0x3ded29(0x207)];_0xaaa32c[_0x3ded29(0x1b0)]&&_0x196533[_0x3ded29(0x1b0)]===null&&(_0x435f86=_0x196533[_0x3ded29(0x1bd)]);if(_0xaaa32c[_0x3ded29(0x171)]===_0x3ded29(0x218)){const _0x3ec817=await Contact_1[_0x3ded29(0x15b)][_0x3ded29(0x182)]({'where':{'number':_0x196533[_0x3ded29(0x1ca)]}}),_0x5d4e3c=await Whatsapp_1[_0x3ded29(0x15b)][_0x3ded29(0x21c)](_0xaaa32c[_0x3ded29(0x1ff)]),_0x57c15c=await CompaniesSettings_1['default'][_0x3ded29(0x182)]({'where':{'companyId':_0xaaa32c[_0x3ded29(0x191)]}}),{ticket:_0xf38961}=await(0x0,FindOrCreateTicketService_1[_0x3ded29(0x15b)])(_0x3ec817,_0x5d4e3c,0x1,_0xaaa32c['companyId'],_0xaaa32c?.[_0x3ded29(0x1c7)],_0xaaa32c?.[_0x3ded29(0x238)],null,'whatsapp',![],![],_0x57c15c);if(_0xaaa32c['mediaPath']===null){const _0x2577de=await(0x0,SendWhatsAppMessage_1[_0x3ded29(0x15b)])({'body':_0x435f86,'ticket':_0xf38961});await(0x0,wbotMessageListener_1[_0x3ded29(0x1db)])(_0x2577de,_0xf38961,_0xf38961['contact']);}else{const _0x24cfdc=path_1[_0x3ded29(0x15b)]['resolve'](__dirname,'..','public'),_0x473a98=path_1[_0x3ded29(0x15b)][_0x3ded29(0x223)](_0x24cfdc,'company'+_0xaaa32c[_0x3ded29(0x191)],_0xaaa32c[_0x3ded29(0x1bf)]),_0x236012=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0xaaa32c[_0x3ded29(0x1f1)],_0x473a98,_0xaaa32c[_0x3ded29(0x191)][_0x3ded29(0x1f8)](),_0x435f86);if(Object[_0x3ded29(0x222)](_0x236012)['length']){const _0x2b869c=await _0x4b389d[_0x3ded29(0x1df)](_0x219919,{..._0x236012});await(0x0,wbotMessageListener_1[_0x3ded29(0x235)])(_0x2b869c,_0xf38961,_0xf38961[_0x3ded29(0x19a)]);}}_0xaaa32c?.[_0x3ded29(0x193)]===_0x3ded29(0x183)&&await _0xf38961[_0x3ded29(0x187)]({'status':_0x3ded29(0x183)}),await _0x196533['update']({'deliveredAt':(0x0,moment_1[_0x3ded29(0x15b)])()});}else{if(_0xaaa32c[_0x3ded29(0x1bf)]){const _0x5f3ab5=path_1['default'][_0x3ded29(0x1ab)](__dirname,'..',_0x3ded29(0x16d)),_0x548329=path_1[_0x3ded29(0x15b)][_0x3ded29(0x223)](_0x5f3ab5,_0x3ded29(0x22d)+_0xaaa32c[_0x3ded29(0x191)],_0xaaa32c[_0x3ded29(0x1bf)]),_0x577b22=await(0x0,SendWhatsAppMedia_1[_0x3ded29(0x1f2)])(_0xaaa32c[_0x3ded29(0x1f1)],_0x548329,_0xaaa32c[_0x3ded29(0x191)][_0x3ded29(0x1f8)](),_0x435f86);Object[_0x3ded29(0x222)](_0x577b22)[_0x3ded29(0x229)]&&await _0x4b389d['sendMessage'](_0x219919,{..._0x577b22});}else _0xaaa32c['confirmation']&&_0x196533['confirmation']===null?(await _0x4b389d[_0x3ded29(0x1df)](_0x219919,{'text':_0x435f86}),await _0x196533[_0x3ded29(0x187)]({'confirmationRequestedAt':(0x0,moment_1['default'])()})):await _0x4b389d['sendMessage'](_0x219919,{'text':_0x435f86});await _0x196533[_0x3ded29(0x187)]({'deliveredAt':(0x0,moment_1[_0x3ded29(0x15b)])()});}await verifyAndFinalizeCampaign(_0xaaa32c);const _0x3966f4=(0x0,socket_1[_0x3ded29(0x163)])();_0x3966f4[_0x3ded29(0x1c6)]('company-'+_0xaaa32c['companyId']+'-campaign',{'action':_0x3ded29(0x187),'record':_0xaaa32c}),logger_1[_0x3ded29(0x1eb)][_0x3ded29(0x1da)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x2ff15c+_0x3ded29(0x1be)+_0x196533[_0x3ded29(0x19a)][_0x3ded29(0x23b)]);}catch(_0x1359a3){Sentry[_0x3ded29(0x18b)](_0x1359a3),logger_1[_0x3ded29(0x1eb)][_0x3ded29(0x1a2)](_0x1359a3[_0x3ded29(0x207)]),console['log'](_0x1359a3['stack']);}}async function handleLoginStatus(_0x303b48){const _0x5e4e2b=a346_0x48a2c8,_0xd8619e=await database_1[_0x5e4e2b(0x15b)]['query']('select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x273\x20minutes\x27::interval\x20and\x20online\x20=\x20true',{'type':sequelize_1[_0x5e4e2b(0x1c5)]['SELECT']}),_0x5a410d=_0xd8619e[_0x5e4e2b(0x164)](_0x315ccb=>_0x315ccb['id']),_0x137f03=_0x5a410d[_0x5e4e2b(0x223)](',\x20');try{const _0x4233fe=_0x5e4e2b(0x1a6)+_0x137f03+');',_0x3f8d84=await database_1[_0x5e4e2b(0x15b)][_0x5e4e2b(0x1e0)](_0x4233fe,{'type':sequelize_1[_0x5e4e2b(0x1c5)]['UPDATE']});}catch(_0x2dc0fc){Sentry[_0x5e4e2b(0x18b)](_0x2dc0fc);}}async function handleVerifyQueue(_0x29a5de){const _0x36db1a=a346_0x48a2c8;try{const _0x5882a1=await Company_1[_0x36db1a(0x15b)][_0x36db1a(0x20c)]({'attributes':['id',_0x36db1a(0x23b)],'where':{'status':!![]},'include':[{'model':Whatsapp_1[_0x36db1a(0x15b)],'attributes':['id','name',_0x36db1a(0x174),_0x36db1a(0x1fe),_0x36db1a(0x170)]}]});_0x5882a1[_0x36db1a(0x164)](async _0x29ca1c=>{const _0x40663c=_0x36db1a;_0x29ca1c[_0x40663c(0x1b3)][_0x40663c(0x164)](async _0x179826=>{const _0x4305da=_0x40663c;if(_0x179826[_0x4305da(0x174)]===_0x4305da(0x16b)){var _0xd6b573=_0x29ca1c['id'];const _0x33e615=_0x179826[_0x4305da(0x1fe)]?_0x179826[_0x4305da(0x1fe)]:0x0,_0x1a601b=_0x179826[_0x4305da(0x170)],_0x4d760f=_0x33e615,_0x272e47=_0x1a601b,_0x1ed657=_0x4d760f;if(_0x33e615>0x0){if(!isNaN(_0x272e47)&&Number[_0x4305da(0x1c0)](_0x272e47)&&!isNaN(_0x1ed657)&&Number[_0x4305da(0x1c0)](_0x1ed657)){const _0x2b02f9=(0x0,moment_1[_0x4305da(0x15b)])()[_0x4305da(0x1d4)](_0x1ed657,_0x4305da(0x142))[_0x4305da(0x1aa)]()['format'](),{count:_0x163980,rows:_0xeb4f5b}=await Ticket_1[_0x4305da(0x15b)][_0x4305da(0x189)]({'attributes':['id'],'where':{'status':_0x4305da(0x197),'queueId':null,'companyId':_0xd6b573,'whatsappId':_0x179826['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x2b02f9}},'include':[{'model':Contact_1['default'],'as':'contact','attributes':['id','name','number','email',_0x4305da(0x161),'acceptAudioMessage',_0x4305da(0x205),_0x4305da(0x21d),'urlPicture','lgpdAcceptedAt',_0x4305da(0x191)],'include':['extraInfo',_0x4305da(0x22e),'tags']},{'model':Queue_2[_0x4305da(0x15b)],'as':_0x4305da(0x1e2),'attributes':['id',_0x4305da(0x23b),_0x4305da(0x240)]},{'model':Whatsapp_1[_0x4305da(0x15b)],'as':_0x4305da(0x1e1),'attributes':['id','name','expiresTicket',_0x4305da(0x232)]}]});_0x163980>0x0&&_0xeb4f5b[_0x4305da(0x164)](async _0x213ea4=>{const _0x5c8726=_0x4305da;await _0x213ea4[_0x5c8726(0x187)]({'queueId':_0x272e47}),await _0x213ea4[_0x5c8726(0x14b)]();const _0x260d5c=(0x0,socket_1[_0x5c8726(0x163)])();_0x260d5c['to'](_0x213ea4[_0x5c8726(0x174)])['to']('notification')['to'](_0x213ea4['id'][_0x5c8726(0x1f8)]())[_0x5c8726(0x1c6)]('company-'+_0xd6b573+'-ticket',{'action':'update','ticket':_0x213ea4,'ticketId':_0x213ea4['id']}),logger_1[_0x5c8726(0x1eb)][_0x5c8726(0x1da)](_0x5c8726(0x165)+_0x213ea4['id']+'\x20-\x20Empresa:\x20'+_0xd6b573);});}else logger_1[_0x4305da(0x1eb)]['info'](_0x4305da(0x21b)+_0xd6b573);}}});});}catch(_0x487f20){Sentry[_0x36db1a(0x18b)](_0x487f20),logger_1[_0x36db1a(0x1eb)][_0x36db1a(0x1a2)](_0x36db1a(0x210),_0x487f20['message']);throw _0x487f20;}};function a346_0x129c(_0x5efe9a,_0x38156c){const _0x50cea2=a346_0x50ce();return a346_0x129c=function(_0x129c96,_0x3b9948){_0x129c96=_0x129c96-0x13e;let _0x12cd3e=_0x50cea2[_0x129c96];return _0x12cd3e;},a346_0x129c(_0x5efe9a,_0x38156c);}async function handleRandomUser(){const _0x3dfff=a346_0x48a2c8,_0x23015f=new CronJob(_0x3dfff(0x1f0),async()=>{const _0x2823b0=_0x3dfff;try{const {count:_0x24b6bc,rows:_0x2fe63b}=await Ticket_1[_0x2823b0(0x15b)][_0x2823b0(0x189)]({'where':{'status':_0x2823b0(0x197),'queueId':{[sequelize_1['Op']['ne']]:null,[sequelize_1['Op']['ne']]:0x0},'$queue.ativarRoteador$':!![],'$queue.tempoRoteador$':{[sequelize_1['Op']['ne']]:0x0}},'include':[{'model':Queue_1[_0x2823b0(0x15b)],'as':_0x2823b0(0x1e2)}]}),_0x5bcf37=_0x5deba0=>{const _0x3b1bc8=_0x2823b0,_0x38702c=Math[_0x3b1bc8(0x1ee)](Math[_0x3b1bc8(0x1e4)]()*_0x5deba0[_0x3b1bc8(0x229)]);return _0x5deba0[_0x38702c];},_0x5782d8=async _0x5caac3=>{const _0xe5dc47=_0x2823b0;try{const _0xf48ece=await User_1['default']['findOne']({'where':{'id':_0x5caac3}});return _0xf48ece[_0xe5dc47(0x225)]==='user'?_0xf48ece['online']===!![]?_0xf48ece['id']:0x0:0x0;}catch(_0x358514){Sentry[_0xe5dc47(0x18b)](_0x358514),logger_1[_0xe5dc47(0x1eb)][_0xe5dc47(0x1a2)]('SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error',_0x358514[_0xe5dc47(0x207)]);throw _0x358514;}};if(_0x24b6bc>0x0)for(const _0x5a93a1 of _0x2fe63b){const {queue:_0x14af68,queueId:_0x1ea4a8,userId:_0x445ae6}=_0x5a93a1,_0x17873a=_0x14af68[_0x2823b0(0x157)],_0x464377=await UserQueue_1[_0x2823b0(0x15b)][_0x2823b0(0x20c)]({'where':{'queueId':_0x1ea4a8}}),_0x3ec69c=await(0x0,ShowContactService_1['default'])(_0x5a93a1[_0x2823b0(0x1ba)],_0x5a93a1[_0x2823b0(0x191)]),_0x39ff85=_0x464377[_0x2823b0(0x164)](_0x55c4a4=>_0x55c4a4['userId']),_0x23aa92=(0x0,moment_1['default'])()[_0x2823b0(0x1d4)](_0x17873a,_0x2823b0(0x142))[_0x2823b0(0x1aa)]()['toDate'](),_0x583e76=new Date(_0x5a93a1[_0x2823b0(0x156)]);let _0x16b643=await CompaniesSettings_1[_0x2823b0(0x15b)][_0x2823b0(0x182)]({'where':{'companyId':_0x5a93a1[_0x2823b0(0x191)]}});const _0x4f70bd=_0x16b643['sendGreetingMessageOneQueues']==='enabled'||![];if(!_0x445ae6){const _0x2594ad=_0x5bcf37(_0x39ff85);if(await _0x5782d8(_0x2594ad)>0x0){if(_0x4f70bd){const _0x1c404a=await(0x0,ShowTicketService_1[_0x2823b0(0x15b)])(_0x5a93a1['id'],_0x5a93a1[_0x2823b0(0x191)]);await(0x0,SendWhatsAppMessage_1[_0x2823b0(0x15b)])({'body':_0x2823b0(0x1c4),'ticket':_0x1c404a});}await(0x0,UpdateTicketService_1[_0x2823b0(0x15b)])({'ticketData':{'status':_0x2823b0(0x197),'userId':_0x2594ad},'ticketId':_0x5a93a1['id'],'companyId':_0x5a93a1['companyId']}),logger_1['logger'][_0x2823b0(0x1da)](_0x2823b0(0x21a)+_0x5a93a1['id']+_0x2823b0(0x1ef)+_0x2594ad+'\x20-\x20'+_0x5a93a1[_0x2823b0(0x156)]);}else{}}else{if(_0x39ff85['includes'](_0x445ae6)){if(_0x23aa92>_0x583e76){const _0x1e16a5=_0x39ff85['filter'](_0x214aae=>_0x214aae!==_0x445ae6);if(_0x1e16a5[_0x2823b0(0x229)]>0x0){const _0x2248b1=_0x5bcf37(_0x1e16a5);if(await _0x5782d8(_0x2248b1)>0x0){if(_0x4f70bd){const _0x40116c=await(0x0,ShowTicketService_1['default'])(_0x5a93a1['id'],_0x5a93a1[_0x2823b0(0x191)]);await(0x0,SendWhatsAppMessage_1[_0x2823b0(0x15b)])({'body':'*Assistente\x20Virtual*:\x0aAguarde\x20enquanto\x20localizamos\x20um\x20atendente...\x20Você\x20será\x20atendido\x20em\x20breve!','ticket':_0x40116c});};await(0x0,UpdateTicketService_1[_0x2823b0(0x15b)])({'ticketData':{'status':'pending','userId':_0x2248b1},'ticketId':_0x5a93a1['id'],'companyId':_0x5a93a1[_0x2823b0(0x191)]}),await _0x5a93a1[_0x2823b0(0x14b)]();}else{}}else{}}else{}}else{}}}}catch(_0x3f3587){Sentry[_0x2823b0(0x18b)](_0x3f3587),logger_1['logger'][_0x2823b0(0x1a2)]('SearchForUsersRandom\x20->\x20VerifyUsersRandom:\x20error',_0x3f3587[_0x2823b0(0x207)]);throw _0x3f3587;}});_0x23015f['start']();}async function handleCloseTicketsAutomatic(){const _0x25cf81=a346_0x48a2c8,_0x180b38=new CronJob(_0x25cf81(0x231),async()=>{const _0x11da4b=_0x25cf81,_0x275881=await Company_1[_0x11da4b(0x15b)]['findAll']();_0x275881[_0x11da4b(0x164)](async _0x3e547b=>{const _0x3d8651=_0x11da4b;try{const _0x416f99=_0x3e547b['id'];await(0x0,wbotClosedTickets_1[_0x3d8651(0x154)])(_0x416f99);}catch(_0x9c9b5f){Sentry[_0x3d8651(0x18b)](_0x9c9b5f),logger_1[_0x3d8651(0x1eb)][_0x3d8651(0x1a2)](_0x3d8651(0x180),_0x9c9b5f['message']);throw _0x9c9b5f;}});});_0x180b38['start']();}async function handleWhatsapp(){const _0x318c40=a346_0x48a2c8,_0x5cfc0c=new CronJob(_0x318c40(0x14e),async()=>{const _0x478ef5=_0x318c40;(0x0,GetWhatsapp_1[_0x478ef5(0x19f)])(),_0x5cfc0c[_0x478ef5(0x1b6)]();},null,![],_0x318c40(0x167));_0x5cfc0c[_0x318c40(0x1ac)]();}handleWhatsapp(),handleCloseTicketsAutomatic(),handleRandomUser();async function startQueueProcess(){const _0x34f47e=a346_0x48a2c8;logger_1['logger']['info'](_0x34f47e(0x15d)),exports['messageQueue'][_0x34f47e(0x1e7)](_0x34f47e(0x177),handleSendMessage),exports[_0x34f47e(0x15e)][_0x34f47e(0x1e7)](_0x34f47e(0x220),handleVerifySchedules),exports['sendScheduledMessages'][_0x34f47e(0x1e7)](_0x34f47e(0x177),handleSendScheduledMessage),exports[_0x34f47e(0x1c2)][_0x34f47e(0x1e7)]('VerifyCampaignsDaatabase',handleVerifyCampaigns),exports[_0x34f47e(0x1c2)]['process'](_0x34f47e(0x208),handleProcessCampaign),exports[_0x34f47e(0x1c2)][_0x34f47e(0x1e7)](_0x34f47e(0x1ea),handlePrepareContact),exports[_0x34f47e(0x1c2)][_0x34f47e(0x1e7)](_0x34f47e(0x141),handleDispatchCampaign),exports[_0x34f47e(0x226)][_0x34f47e(0x1e7)]('VerifyLoginStatus',handleLoginStatus),exports[_0x34f47e(0x21f)][_0x34f47e(0x1e7)](_0x34f47e(0x1c3),handleVerifyQueue),exports[_0x34f47e(0x15e)][_0x34f47e(0x234)](_0x34f47e(0x220),{},{'repeat':{'cron':_0x34f47e(0x1f0),'key':_0x34f47e(0x1fd)},'removeOnComplete':!![]}),exports[_0x34f47e(0x1c2)][_0x34f47e(0x234)](_0x34f47e(0x22f),{},{'repeat':{'cron':_0x34f47e(0x1dc),'key':'verify-campaing'},'removeOnComplete':!![]}),exports[_0x34f47e(0x226)]['add'](_0x34f47e(0x144),{},{'repeat':{'cron':_0x34f47e(0x1e5),'key':_0x34f47e(0x1b4)},'removeOnComplete':!![]}),exports[_0x34f47e(0x21f)][_0x34f47e(0x234)](_0x34f47e(0x1c3),{},{'repeat':{'cron':_0x34f47e(0x1dc),'key':_0x34f47e(0x153)},'removeOnComplete':!![]});}exports[a346_0x48a2c8(0x216)]=startQueueProcess;