'use strict';const a39_0x4a0f81=a39_0x4ea3;(function(_0x466051,_0x3f355a){const _0xfcafb1=a39_0x4ea3,_0x2c8d55=_0x466051();while(!![]){try{const _0x176cd4=parseInt(_0xfcafb1(0x142))/0x1+-parseInt(_0xfcafb1(0x14e))/0x2+-parseInt(_0xfcafb1(0x144))/0x3+-parseInt(_0xfcafb1(0x15b))/0x4+-parseInt(_0xfcafb1(0x15d))/0x5+-parseInt(_0xfcafb1(0x155))/0x6*(parseInt(_0xfcafb1(0x146))/0x7)+-parseInt(_0xfcafb1(0x16b))/0x8*(-parseInt(_0xfcafb1(0x15c))/0x9);if(_0x176cd4===_0x3f355a)break;else _0x2c8d55['push'](_0x2c8d55['shift']());}catch(_0x42e7e3){_0x2c8d55['push'](_0x2c8d55['shift']());}}}(a39_0x52ac,0xa8c4c));var __importDefault=this&&this[a39_0x4a0f81(0x150)]||function(_0x4feb92){const _0x353d66=a39_0x4a0f81;return _0x4feb92&&_0x4feb92[_0x353d66(0x151)]?_0x4feb92:{'default':_0x4feb92};};Object['defineProperty'](exports,a39_0x4a0f81(0x151),{'value':!![]}),exports[a39_0x4a0f81(0x176)]=exports[a39_0x4a0f81(0x157)]=exports['closedTickets']=exports[a39_0x4a0f81(0x143)]=exports['show']=exports['storeFacebook']=exports[a39_0x4a0f81(0x170)]=exports['index']=void 0x0;function a39_0x4ea3(_0x2fccd1,_0x406a79){const _0x52acfd=a39_0x52ac();return a39_0x4ea3=function(_0x4ea357,_0x224f0f){_0x4ea357=_0x4ea357-0x13d;let _0x43f34d=_0x52acfd[_0x4ea357];return _0x43f34d;},a39_0x4ea3(_0x2fccd1,_0x406a79);}const socket_1=require(a39_0x4a0f81(0x147)),cache_1=__importDefault(require('../libs/cache')),wbot_1=require('../libs/wbot'),Whatsapp_1=__importDefault(require(a39_0x4a0f81(0x153))),AppError_1=__importDefault(require('../errors/AppError')),DeleteBaileysService_1=__importDefault(require(a39_0x4a0f81(0x158))),ShowCompanyService_1=__importDefault(require(a39_0x4a0f81(0x177))),graphAPI_1=require('../services/FacebookServices/graphAPI'),ShowPlanService_1=__importDefault(require(a39_0x4a0f81(0x145))),StartWhatsAppSession_1=require(a39_0x4a0f81(0x16a)),CreateWhatsAppService_1=__importDefault(require(a39_0x4a0f81(0x141))),DeleteWhatsAppService_1=__importDefault(require(a39_0x4a0f81(0x156))),ListWhatsAppsService_1=__importDefault(require(a39_0x4a0f81(0x17b))),ShowWhatsAppService_1=__importDefault(require(a39_0x4a0f81(0x165))),UpdateWhatsAppService_1=__importDefault(require(a39_0x4a0f81(0x175))),ImportWhatsAppMessageService_1=require('../services/WhatsappService/ImportWhatsAppMessageService'),index=async(_0x3f45ae,_0x1affe9)=>{const _0x5723b1=a39_0x4a0f81,{companyId:_0x59056}=_0x3f45ae[_0x5723b1(0x174)],{session:_0x3ba360}=_0x3f45ae['query'],_0x1be37f=await(0x0,ListWhatsAppsService_1[_0x5723b1(0x166)])({'companyId':_0x59056,'session':_0x3ba360});return _0x1affe9[_0x5723b1(0x160)](0xc8)['json'](_0x1be37f);};exports[a39_0x4a0f81(0x178)]=index;const store=async(_0x2bb6ff,_0x277e68)=>{const _0x51b675=a39_0x4a0f81,{name:_0x4e3c1c,status:_0x5d206e,isDefault:_0x1a4f05,greetingMessage:_0x56a58b,complationMessage:_0x3e46ed,outOfHoursMessage:_0x17d75e,queueIds:_0x18982e,token:_0x43fcd6,maxUseBotQueues:_0x290e11,timeUseBotQueues:_0x5d12c7,expiresTicket:_0x406a9e,allowGroup:_0x51f925,timeSendQueue:_0x5d98e3,sendIdQueue:_0x35aeee,timeInactiveMessage:_0x19abc8,inactiveMessage:_0x56d5bf,ratingMessage:_0xfb4278,maxUseBotQueuesNPS:_0x2635c6,expiresTicketNPS:_0x19c579,whenExpiresTicket:_0x5acdf3,expiresInactiveMessage:_0x48c3e7,importOldMessages:_0x544a33,importRecentMessages:_0xb72d52,closedTicketsPostImported:_0x14c123,importOldMessagesGroups:_0xaf6eb5,groupAsTicket:_0x279b24,timeCreateNewTicket:_0x5a327d}=_0x2bb6ff['body'],{companyId:_0xebd705}=_0x2bb6ff[_0x51b675(0x174)],_0x1c50c9=await(0x0,ShowCompanyService_1['default'])(_0xebd705),_0x6e9943=await(0x0,ShowPlanService_1[_0x51b675(0x166)])(_0x1c50c9[_0x51b675(0x16c)]);if(!_0x6e9943[_0x51b675(0x17c)])return _0x277e68[_0x51b675(0x160)](0x190)[_0x51b675(0x14f)]({'error':_0x51b675(0x16f)});const {whatsapp:_0x4421a3,oldDefaultWhatsapp:_0x2bb616}=await(0x0,CreateWhatsAppService_1['default'])({'name':_0x4e3c1c,'status':_0x5d206e,'isDefault':_0x1a4f05,'greetingMessage':_0x56a58b,'complationMessage':_0x3e46ed,'outOfHoursMessage':_0x17d75e,'queueIds':_0x18982e,'companyId':_0xebd705,'token':_0x43fcd6,'maxUseBotQueues':_0x290e11,'timeUseBotQueues':_0x5d12c7,'expiresTicket':_0x406a9e,'allowGroup':_0x51f925,'timeSendQueue':_0x5d98e3,'sendIdQueue':_0x35aeee,'timeInactiveMessage':_0x19abc8,'inactiveMessage':_0x56d5bf,'ratingMessage':_0xfb4278,'maxUseBotQueuesNPS':_0x2635c6,'expiresTicketNPS':_0x19c579,'whenExpiresTicket':_0x5acdf3,'expiresInactiveMessage':_0x48c3e7,'importOldMessages':_0x544a33,'importRecentMessages':_0xb72d52,'closedTicketsPostImported':_0x14c123,'importOldMessagesGroups':_0xaf6eb5,'groupAsTicket':_0x279b24,'timeCreateNewTicket':_0x5a327d});(0x0,StartWhatsAppSession_1[_0x51b675(0x17a)])(_0x4421a3,_0xebd705);const _0x463b34=(0x0,socket_1['getIO'])();return _0x463b34[_0x51b675(0x154)](_0x51b675(0x162)+_0xebd705+_0x51b675(0x15a),{'action':'update','whatsapp':_0x4421a3}),_0x2bb616&&_0x463b34[_0x51b675(0x154)](_0x51b675(0x162)+_0xebd705+_0x51b675(0x15a),{'action':_0x51b675(0x143),'whatsapp':_0x2bb616}),_0x277e68[_0x51b675(0x160)](0xc8)['json'](_0x4421a3);};exports[a39_0x4a0f81(0x170)]=store;const storeFacebook=async(_0x3db31c,_0x816cf3)=>{const _0x299c27=a39_0x4a0f81;try{const {facebookUserId:_0x5f5033,facebookUserToken:_0x5e3c22,addInstagram:_0x55f80d}=_0x3db31c[_0x299c27(0x14b)],{companyId:_0x570cdc}=_0x3db31c[_0x299c27(0x174)],{data:_0x39ee36}=await(0x0,graphAPI_1['getPageProfile'])(_0x5f5033,_0x5e3c22);if(_0x39ee36[_0x299c27(0x148)]===0x0)return _0x816cf3[_0x299c27(0x160)](0x190)[_0x299c27(0x14f)]({'error':_0x299c27(0x163)});const _0x54d136=(0x0,socket_1[_0x299c27(0x168)])(),_0x241cf1=[];for await(const _0xfb5e4b of _0x39ee36){const {name:_0x245c9b,access_token:_0x2375fc,id:_0x3efbf4,instagram_business_account:_0x487800}=_0xfb5e4b,_0x4075e8=await(0x0,graphAPI_1[_0x299c27(0x173)])(_0x2375fc);if(_0x487800&&_0x55f80d){const {id:_0x112c41,username:_0x52b4c4,name:_0x24f728}=_0x487800;_0x241cf1['push']({'companyId':_0x570cdc,'name':'Insta\x20'+(_0x52b4c4||_0x24f728),'facebookUserId':_0x5f5033,'facebookPageUserId':_0x112c41,'facebookUserToken':_0x4075e8,'tokenMeta':_0x5e3c22,'isDefault':![],'channel':_0x299c27(0x149),'status':_0x299c27(0x13d),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),_0x241cf1[_0x299c27(0x159)]({'companyId':_0x570cdc,'name':_0x245c9b,'facebookUserId':_0x5f5033,'facebookPageUserId':_0x3efbf4,'facebookUserToken':_0x4075e8,'tokenMeta':_0x5e3c22,'isDefault':![],'channel':_0x299c27(0x14c),'status':_0x299c27(0x13d),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1['subscribeApp'])(_0x3efbf4,_0x4075e8);}!_0x487800&&(_0x241cf1[_0x299c27(0x159)]({'companyId':_0x570cdc,'name':_0x245c9b,'facebookUserId':_0x5f5033,'facebookPageUserId':_0x3efbf4,'facebookUserToken':_0x4075e8,'tokenMeta':_0x5e3c22,'isDefault':![],'channel':'facebook','status':_0x299c27(0x13d),'greetingMessage':'','farewellMessage':'','queueIds':[],'isMultidevice':![]}),await(0x0,graphAPI_1[_0x299c27(0x172)])(_0xfb5e4b['id'],_0x4075e8));}for await(const _0x43e061 of _0x241cf1){const _0x36c6ed=await Whatsapp_1[_0x299c27(0x166)][_0x299c27(0x14d)]({'where':{'facebookPageUserId':_0x43e061[_0x299c27(0x16d)]}});_0x36c6ed&&await _0x36c6ed['update']({..._0x43e061});if(!_0x36c6ed){const {whatsapp:_0x493cfb}=await(0x0,CreateWhatsAppService_1[_0x299c27(0x166)])(_0x43e061);_0x54d136['emit'](_0x299c27(0x162)+_0x570cdc+_0x299c27(0x15a),{'action':_0x299c27(0x143),'whatsapp':_0x493cfb});}}return _0x816cf3[_0x299c27(0x160)](0xc8);}catch(_0x141eee){return console[_0x299c27(0x179)](_0x141eee),_0x816cf3[_0x299c27(0x160)](0x190)[_0x299c27(0x14f)]({'error':_0x299c27(0x163)});}};exports[a39_0x4a0f81(0x13e)]=storeFacebook;const show=async(_0xcce6a8,_0xa8e727)=>{const _0x2fc184=a39_0x4a0f81,{whatsappId:_0x7532fb}=_0xcce6a8[_0x2fc184(0x161)],{companyId:_0x2f5b19}=_0xcce6a8['user'],{session:_0x4e69ea}=_0xcce6a8['query'],_0x42d626=await(0x0,ShowWhatsAppService_1['default'])(_0x7532fb,_0x2f5b19,_0x4e69ea);return _0xa8e727[_0x2fc184(0x160)](0xc8)[_0x2fc184(0x14f)](_0x42d626);};exports[a39_0x4a0f81(0x152)]=show;const update=async(_0x4db8ae,_0x302026)=>{const _0x50ebcc=a39_0x4a0f81,{whatsappId:_0x93bed}=_0x4db8ae['params'],_0x47b7d9=_0x4db8ae[_0x50ebcc(0x14b)],{companyId:_0x7cbbec}=_0x4db8ae['user'],{whatsapp:_0x1a8d07,oldDefaultWhatsapp:_0x3bfa10}=await(0x0,UpdateWhatsAppService_1['default'])({'whatsappData':_0x47b7d9,'whatsappId':_0x93bed,'companyId':_0x7cbbec}),_0x28545b=(0x0,socket_1['getIO'])();return _0x28545b[_0x50ebcc(0x154)](_0x50ebcc(0x162)+_0x7cbbec+_0x50ebcc(0x15a),{'action':_0x50ebcc(0x143),'whatsapp':_0x1a8d07}),_0x3bfa10&&_0x28545b['emit']('company-'+_0x7cbbec+_0x50ebcc(0x15a),{'action':_0x50ebcc(0x143),'whatsapp':_0x3bfa10}),_0x302026[_0x50ebcc(0x160)](0xc8)[_0x50ebcc(0x14f)](_0x1a8d07);};exports[a39_0x4a0f81(0x143)]=update;const closedTickets=async(_0x1393c5,_0x146263)=>{const _0x53a816=a39_0x4a0f81,{whatsappId:_0x2109fd}=_0x1393c5[_0x53a816(0x161)];return(0x0,ImportWhatsAppMessageService_1['closeTicketsImported'])(_0x2109fd),_0x146263['status'](0xc8)[_0x53a816(0x14f)](_0x53a816(0x169));};exports['closedTickets']=closedTickets;const remove=async(_0x3a3a18,_0x289391)=>{const _0xcd4bfc=a39_0x4a0f81,{whatsappId:_0x2840a7}=_0x3a3a18[_0xcd4bfc(0x161)],{companyId:_0x1048c6,profile:_0x574d52}=_0x3a3a18[_0xcd4bfc(0x174)],_0x1b0d9e=(0x0,socket_1[_0xcd4bfc(0x168)])();if(_0x574d52!==_0xcd4bfc(0x15e))throw new AppError_1['default']('ERR_NO_PERMISSION',0x193);const _0x34e1ad=await(0x0,ShowWhatsAppService_1[_0xcd4bfc(0x166)])(_0x2840a7,_0x1048c6);_0x34e1ad[_0xcd4bfc(0x17d)]===_0xcd4bfc(0x169)&&(await(0x0,DeleteBaileysService_1[_0xcd4bfc(0x166)])(_0x2840a7),await(0x0,DeleteWhatsAppService_1['default'])(_0x2840a7),await cache_1[_0xcd4bfc(0x166)][_0xcd4bfc(0x164)]('sessions:'+_0x2840a7+':*'),(0x0,wbot_1[_0xcd4bfc(0x15f)])(+_0x2840a7),_0x1b0d9e[_0xcd4bfc(0x154)](_0xcd4bfc(0x162)+_0x1048c6+_0xcd4bfc(0x15a),{'action':_0xcd4bfc(0x140),'whatsappId':+_0x2840a7}));if(_0x34e1ad[_0xcd4bfc(0x17d)]==='facebook'||_0x34e1ad[_0xcd4bfc(0x17d)]===_0xcd4bfc(0x149)){const {facebookUserToken:_0xbec513}=_0x34e1ad,_0x227d1b=await Whatsapp_1[_0xcd4bfc(0x166)]['findAll']({'where':{'facebookUserToken':_0xbec513}});await Whatsapp_1['default'][_0xcd4bfc(0x167)]({'where':{'facebookUserToken':_0xbec513}});for await(const _0x619a6b of _0x227d1b){_0x1b0d9e[_0xcd4bfc(0x154)]('company-'+_0x1048c6+'-whatsapp',{'action':_0xcd4bfc(0x140),'whatsappId':_0x619a6b['id']});}}return _0x289391[_0xcd4bfc(0x160)](0xc8)[_0xcd4bfc(0x14f)]({'message':_0xcd4bfc(0x13f)});};function a39_0x52ac(){const _0x3fe48c=['CONNECTED','storeFacebook','Session\x20disconnected.','delete','../services/WhatsappService/CreateWhatsAppService','270961WeViwS','update','981672lhNSnl','../services/PlanService/ShowPlanService','7DxKFUb','../libs/socket','length','instagram','restartWbot','body','facebook','findOne','1267134HGmlkz','json','__importDefault','__esModule','show','../models/Whatsapp','emit','3150762zCnxSH','../services/WhatsappService/DeleteWhatsAppService','remove','../services/BaileysServices/DeleteBaileysService','push','-whatsapp','2499620EuSWTW','2977353jpOMJf','5539245oPsUcc','admin','removeWbot','status','params','company-','Facebook\x20page\x20not\x20found','delFromPattern','../services/WhatsappService/ShowWhatsAppService','default','destroy','getIO','whatsapp','../services/WbotServices/StartWhatsAppSession','88sjqyXb','planId','facebookPageUserId','ERR_NO_PERMISSION','Você\x20não\x20possui\x20permissão\x20para\x20acessar\x20este\x20recurso!','store','Whatsapp\x20restart.','subscribeApp','getAccessTokenFromPage','user','../services/WhatsappService/UpdateWhatsAppService','restart','../services/CompanyService/ShowCompanyService','index','log','StartWhatsAppSession','../services/WhatsappService/ListWhatsAppsService','useWhatsapp','channel'];a39_0x52ac=function(){return _0x3fe48c;};return a39_0x52ac();}exports[a39_0x4a0f81(0x157)]=remove;const restart=async(_0x247fda,_0x346af5)=>{const _0x14afbf=a39_0x4a0f81,{companyId:_0x50b787,profile:_0x114232}=_0x247fda[_0x14afbf(0x174)];if(_0x114232!==_0x14afbf(0x15e))throw new AppError_1[(_0x14afbf(0x166))](_0x14afbf(0x16e),0x193);return await(0x0,wbot_1[_0x14afbf(0x14a)])(_0x50b787),_0x346af5[_0x14afbf(0x160)](0xc8)[_0x14afbf(0x14f)]({'message':_0x14afbf(0x171)});};exports[a39_0x4a0f81(0x176)]=restart;